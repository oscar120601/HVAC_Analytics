# 批次處理特徵映射工作流程

## 新功能概覽

在批次處理完成後，現在會自動顯示 **「🗺️ 特徵映射配置」** 區塊，讓你可以直接用下拉式清單選擇每個欄位對應的特徵類別。

---

## 工作流程步驟

### Step 1: 啟動 UI 並選擇批次處理模式

```bash
streamlit run etl_ui.py
```

1. 左側欄選擇 **「批次處理（整個資料夾）」**
2. 選擇檔案範圍（全部或日期範圍）
3. 點擊 **「🚀 開始批次處理」**

---

### Step 2: 批次處理完成後

處理完成會看到：

```
✅ 成功處理 30 個檔案

總列數: 15,234
總欄位數: 45
時間範圍: 30 days
```

然後會自動顯示 **🗺️ 特徵映射配置** 區塊

---

### Step 3: 特徵映射配置

#### 方式 A: 自動識別（推薦）

```
配置方式: ● 自動識別 (Auto-detect)  ○ 手動對應 (Manual Mapping)

[🤖 執行自動識別]  ← 點擊這個按鈕
```

系統會自動根據欄位名稱識別：
- `CH_0_RT` → 負載
- `CHP_01_VFD_OUT` → 冷凍泵
- `CWP_01_VFD_OUT` → 冷卻泵
- `CT_SYS_OAT` → 環境參數
- `CH_SYS_TOTAL_KW` → 目標

#### 方式 B: 手動對應

```
配置方式: ○ 自動識別 (Auto-detect)  ● 手動對應 (Manual Mapping)

請在下方下拉式選單中，為每個欄位選擇適當的特徵類別

左欄:                        右欄:
🏭 負載 (Load / RT)          🌀 冷卻塔 (CT Fans)
[CH_0_RT    ▼]              [CT_01_VFD_OUT ▼]
[CH_1_RT    ▼]              [CT_02_VFD_OUT ▼]
[CH_2_RT    ▼]              ...

💧 冷凍泵 (CHW Pumps)        🌡️ 溫度 (Temperatures)
[CHP_01_VFD_OUT ▼]          [CH_0_SWT ▼]
[CHP_02_VFD_OUT ▼]          [CH_0_RWT ▼]
...                         ...

🌊 冷卻泵 (CW Pumps)         🌍 環境參數 (Environment)
[CWP_01_VFD_OUT ▼]          [CT_SYS_OAT ☑]
[CWP_02_VFD_OUT ▼]          [CT_SYS_OAH ☑]
...                         [CT_SYS_WBT ☑]

                            🎯 目標變數 (Target)
                            [CH_SYS_TOTAL_KW ▼]

[💾 儲存手動配置]  ← 點擊儲存
```

**操作方式：**
- 每個類別使用 **multiselect** 多選下拉框
- 點擊下拉框會顯示所有未分配的欄位
- 勾選多個欄位後會顯示為 tags
- 可以隨時取消選擇移除

---

### Step 4: 查看與驗證映射

配置完成後會顯示：

```
📋 查看/編輯當前映射

負載  冷凍泵  冷卻泵  冷卻塔  溫度  環境  目標
  4      5       5       5      4     3     1

詳細對應：
左欄:                          右欄:
• 負載: CH_0_RT, CH_1_RT       • 冷卻塔: CT_01_VFD_OUT, ...
• 冷凍泵: CHP_01_VFD_OUT, ...  • 溫度: CH_0_SWT, ...
• 冷卻泵: CWP_01_VFD_OUT, ...  • 環境: CT_SYS_OAT, CT_SYS_OAH, CT_SYS_WBT
                               • 目標: CH_SYS_TOTAL_KW

✅ 所有映射欄位都存在於資料中

[📥 匯出 JSON]
```

---

### Step 5: 資料分析與訓練

確認映射無誤後，繼續使用下方的標籤頁：

```
📋 資料預覽 | 🧹 清洗資料 | 📊 統計資訊 | 📈 時間序列 | 🔗 關聯矩陣 | 🎯 資料品質 | 💾 匯出
```

或在 **「⚡ 最佳化模擬」** 模式中使用此映射訓練模型。

---

## 重要提示

### 映射儲存位置

批次處理配置的映射會自動儲存在 `st.session_state.batch_feature_mapping`，會在：
- 同一個 session 的所有模式中共用
- 訓練模型時自動套用

### 欄位分類規則

| 特徵類別 | 識別模式 | 範例欄位 |
|---------|---------|---------|
| 負載 (RT) | 包含 "RT"，不包含 "KW" | `CH_0_RT`, `CH_1_RT` |
| 冷凍泵 | 包含 "CHP" 和 "VFD" | `CHP_01_VFD_OUT` |
| 冷卻泵 | 包含 "CWP" 和 "VFD" | `CWP_01_VFD_OUT` |
| 冷卻塔 | 包含 "CT_" 和 "VFD" | `CT_01_VFD_OUT` |
| 溫度 | 包含 "SWT"/"RWT"/"TEMP" | `CH_0_SWT`, `CW_SYS_RWT` |
| 環境 | 包含 "OAT"/"OAH"/"WBT" | `CT_SYS_OAT`, `CT_SYS_OAH` |
| 目標 | 包含 "TOTAL" 和 "KW" | `CH_SYS_TOTAL_KW` |

### 欄位未被識別？

如果使用自動識別後有些欄位沒有被分到正確類別：

1. 切換到 **「手動對應」** 模式
2. 在每個類別的下拉框中手動選擇
3. 點擊 **「💾 儲存手動配置」**

---

## 快速檢查清單

- [ ] 批次處理完成，看到 ✅ 成功訊息
- [ ] 展開「🗺️ 特徵映射配置」區塊
- [ ] 點擊「自動識別」或選擇「手動對應」
- [ ] 確認負載欄位 (RT) 正確
- [ ] 確認目標欄位 (KW) 正確
- [ ] 確認環境參數 (OAT/OAH/WBT) 已選取
- [ ] 看到 ✅ 所有映射欄位都存在
- [ ] 繼續資料分析或模型訓練

---

## 常見問題

### Q: 為什麼有些欄位沒有出現在多選框中？
A: 欄位可能已經被分到其他類別，或不符合任何識別模式。使用手動模式可以選擇所有欄位。

### Q: 如何修改已儲存的映射？
A: 展開「📋 查看/編輯當前映射」，然後切換回「自動識別」或「手動對應」重新配置。

### Q: 訓練時會自動使用這個映射嗎？
A: 會！在「⚡ 最佳化模擬」模式訓練時，會優先使用 `batch_feature_mapping`，其次才使用側邊欄的映射設定。

### Q: 如何匯出映射給其他案場使用？
A: 點擊「📥 匯出 JSON」，下載的檔案可以在其他案場的 UI 中使用「上傳 JSON」載入。
