<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_CLEANER_v2.0</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v20-datacleaner-implementation-guide">PRD v2.0: 資料清洗器實作指南 (DataCleaner Implementation Guide)</h1>
<p><strong>文件版本:</strong> v2.0 (Step-by-Step Implementation Detail)<br />
<strong>日期:</strong> 2026-02-12<br />
<strong>負責人:</strong> Oscar Chang<br />
<strong>目標模組:</strong> <a href="file:///d:/12.任務/HVAC-1/src/etl/cleaner.py">src/etl/cleaner.py</a></p>
<hr />
<h2 id="1">1. 執行總綱</h2>
<p>本文件是針對 <code>cleaner.py</code> 重構的<strong>詳細施工藍圖</strong>。我們將分三個階段進行，每個階段都有明確的「檔案操作指令」。</p>
<p><strong>核心策略:</strong> <br />
1. <strong>不破壞現有程式碼</strong>：先建立新模組 (<code>cleaner_v2.py</code>)，舊的 (<code>cleaner.py</code>) 改名保留。<br />
2. <strong>配置先行</strong>：先定義好 Config 模型，再寫邏輯。<br />
3. <strong>單元感知</strong>：物理計算一律先轉 SI 制（公制）。</p>
<hr />
<h2 id="phase-1-pydantic">Phase 1: 基礎配置與 Pydantic 定義</h2>
<h3 id="step-11">Step 1.1: 建立配置模型檔案</h3>
<ul>
<li><strong>動作</strong>: 建立新檔案 <code>src/etl/config_models.py</code></li>
<li><strong>內容要求</strong>:</li>
<li>定義 <code>UnitSystem</code> (Enum): <code>METRIC</code>, <code>IMPERIAL</code></li>
<li>定義 <code>CleaningConfig</code> (BaseModel):<ul>
<li><code>unit_system</code>: 預設 <code>METRIC</code></li>
<li><code>resample_interval</code>: 預設 <code>"5m"</code></li>
<li><code>cp_water_poly_coeffs</code>: 預設 <code>[4.2, -0.0005]</code></li>
<li><code>max_drop_rate</code>: 預設 <code>0.3</code> (熔斷閾值)</li>
<li><code>design_capacity_kw</code>: Optional[float] (額定容量)</li>
</ul>
</li>
</ul>
<h3 id="step-12">Step 1.2: 更新設定檔</h3>
<ul>
<li><strong>動作</strong>: 編輯 <code>config/settings.yaml</code></li>
<li><strong>內容要求</strong>: </li>
<li>新增 <code>cleaning</code> 區塊，填入上述參數的預設值。</li>
<li>例如：<br />
<code>yaml
    cleaning:
      unit_system: "imperial"  # 若現有案場是英制
      resample_interval: "5m"
      max_drop_rate: 0.3</code></li>
</ul>
<h3 id="step-13">Step 1.3: 建立配置載入器</h3>
<ul>
<li><strong>動作</strong>: 建立/編輯 <code>src/utils/config_loader.py</code></li>
<li><strong>內容要求</strong>:</li>
<li>新增函數 <code>load_cleaning_config(path: str) -&gt; CleaningConfig</code>。</li>
<li>使用 <code>yaml.safe_load</code> 讀取並轉換為 Pydantic 物件。</li>
</ul>
<hr />
<h2 id="phase-2">Phase 2: 核心清洗器重構 (物理引擎)</h2>
<h3 id="step-21-cleaner">Step 2.1: 建立新版 Cleaner 骨架</h3>
<ul>
<li><strong>動作</strong>: 建立 <code>src/etl/cleaner_v2.py</code></li>
<li><strong>內容要求</strong>:</li>
<li>class <code>DataCleaner</code>:<ul>
<li><code>__init__(self, config: CleaningConfig)</code></li>
<li>保存 config 為成員變數。</li>
</ul>
</li>
</ul>
<h3 id="step-22-unit-normalizer">Step 2.2: 實作單位標準化層 (Unit Normalizer)</h3>
<ul>
<li><strong>動作</strong>: 在 <code>cleaner_v2.py</code> 中新增 helper 方法 <code>_to_si_units</code></li>
<li><strong>輸入</strong>: 多個 Series (flow, temp_in, temp_out)</li>
<li><strong>邏輯</strong>:</li>
<li>檢查 <code>self.config.unit_system</code>。</li>
<li>若為 <code>IMPERIAL</code>:<ul>
<li>Flow: GPM * 3.78541 -&gt; LPM</li>
<li>Temp: (°F - 32) * 5/9 -&gt; °C</li>
</ul>
</li>
<li>若為 <code>METRIC</code>: 不變。</li>
<li><strong>回傳</strong>: 轉換後的三個 Series (LPM, °C, °C)。</li>
</ul>
<h3 id="step-23">Step 2.3: 實作精確熱平衡驗證</h3>
<ul>
<li><strong>動作</strong>: 在 <code>cleaner_v2.py</code> 中實作 <code>validate_heat_balance</code></li>
<li><strong>邏輯</strong>:<br />
  1. 呼叫 <code>_to_si_units</code> 取得公制數據。<br />
  2. 計算 Delta T = <code>temp_in</code> - <code>temp_out</code>。<br />
  3. 計算平均水溫 <code>t_avg</code> = (<code>temp_in</code> + <code>temp_out</code>) / 2。<br />
  4. 計算 Cp (比熱) = <code>poly_val(t_avg, self.config.cp_water_poly_coeffs)</code>。<br />
  5. 計算理論熱負載 <code>Q_calc (kW)</code> = <code>flow (LPM) * delta_T * Cp * density / 60</code>。<br />
  6. 比較 <code>Q_calc</code> 與儀表讀數 <code>Q_meter</code> (需注意單位轉換)。<br />
  7. 計算誤差率 <code>error_pct</code>。</li>
<li><strong>輸出</strong>: 回傳一個 Boolean Series (True = 通過, False = 失敗)。</li>
</ul>
<h3 id="step-24-generic-resampler">Step 2.4: 實作通用重採樣 (Generic Resampler)</h3>
<ul>
<li><strong>動作</strong>: 在 <code>cleaner_v2.py</code> 中實作 <code>resample_data</code></li>
<li><strong>邏輯</strong>:</li>
<li><strong>不要寫死</strong> <code>endswith("KWH")</code>。</li>
<li>接受一個 <code>agg_map</code> (Dict[str, str]) 參數。</li>
<li>使用 <code>df.group_by_dynamic(..., every=self.config.resample_interval).agg(...)</code>。</li>
<li>若 <code>agg_map</code> 為空，對數值欄位預設 <code>mean()</code>，非數值預設 <code>first()</code>。</li>
</ul>
<hr />
<h2 id="phase-3">Phase 3: 安全防護與品質報告</h2>
<h3 id="step-31-circuit-breaker">Step 3.1: 實作熔斷機制 (Circuit Breaker)</h3>
<ul>
<li><strong>動作</strong>: 在 <code>cleaner_v2.py</code> 的主流程 <code>clean()</code> 方法中</li>
<li><strong>邏輯</strong>:<br />
  1. 執行所有驗證 (Heat Balance, Affinity, etc.) 得到 <code>invalid_mask</code>。<br />
  2. 計算 <code>drop_count = invalid_mask.sum()</code>。<br />
  3. 計算 <code>drop_rate = drop_count / total_rows</code>。<br />
  4. <strong>檢查</strong>: <code>if drop_rate &gt; self.config.max_drop_rate</code>:<ul>
<li>logger.error("Circuit Breaker Triggered!")</li>
<li>拋出 <code>CircuitBreakerException</code> (需在 <code>src/exceptions.py</code> 新增)。</li>
<li>或者：回傳原始 DF 並加上標籤 <code>"DATA_SUSPICIOUS"</code> (依策略而定)。</li>
</ul>
</li>
</ul>
<h3 id="step-32">Step 3.2: 產生品質報告</h3>
<ul>
<li><strong>動作</strong>: 在 <code>src/etl/quality_report.py</code> (新檔案) 或 <code>cleaner_v2.py</code></li>
<li><strong>邏輯</strong>:</li>
<li>收集各步驟的統計數據：<ul>
<li>原始行數</li>
<li>缺失值填充數</li>
<li>熱平衡失敗數</li>
<li>穩定態佔比</li>
</ul>
</li>
<li>回傳 Dict 或 Pydantic 物件。</li>
</ul>
<hr />
<h2 id="phase-4">Phase 4: 文檔與遷移</h2>
<h3 id="step-41-readme">Step 4.1: 更新 README</h3>
<ul>
<li><strong>動作</strong>: 更新 <code>src/etl/README.md</code> (若無則建立)</li>
<li><strong>內容</strong>: 說明如何使用 v2 Cleaner，以及 Config 的設定範例。</li>
</ul>
<h3 id="step-42">Step 4.2: 建立遷移腳本</h3>
<ul>
<li><strong>動作</strong>: 建立 <code>scripts/migrate_v1_to_v2.py</code></li>
<li><strong>邏輯</strong>: 讀取舊的 <code>feature_mapping.py</code>，輔助生成新的 <code>settings.yaml</code> 區塊。</li>
</ul>
<hr />
<h2 id="5-verification">5. 驗證步驟 (Verification)</h2>
<p>每完成一個 Phase，請執行以下檢查：</p>
<ol>
<li>
<p><strong>Phase 1 完成後</strong>:</p>
<ul>
<li>執行 <code>python -c "from src.etl.config_models import CleaningConfig; print(CleaningConfig())"</code> </li>
<li>預期結果：印出預設配置，無報錯。</li>
</ul>
</li>
<li>
<p><strong>Phase 2 完成後</strong>:</p>
<ul>
<li>撰寫單元測試 <code>tests/test_cleaner_v2.py</code>。</li>
<li>Case A: 輸入 <code>[100 GPM, 55F, 45F]</code>，驗證轉換後的 LPM/°C 是否正確。</li>
<li>Case B: 輸入完美熱平衡數據，驗證 <code>validate_heat_balance</code> 回傳 True。</li>
</ul>
</li>
<li>
<p><strong>Phase 3 完成後</strong>:</p>
<ul>
<li>Case C: 輸入 100 筆全是錯的數據，驗證是否拋出 <code>CircuitBreakerException</code>。</li>
</ul>
</li>
</ol>
<hr />
<h2 id="6">6. 下一步指令</h2>
<p>請確認是否準備好開始執行 <strong>Phase 1: 基礎配置</strong>？</p>
</body>
</html>