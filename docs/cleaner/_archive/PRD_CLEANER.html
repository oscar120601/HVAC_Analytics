<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_CLEANER</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-datacleaner-robustness-refactoring">PRD：資料清洗器強健性重構 (DataCleaner Robustness Refactoring)</h1>
<p><strong>文件版本:</strong> v1.0<br />
<strong>日期:</strong> 2026-02-12<br />
<strong>負責人:</strong> Oscar Chang<br />
<strong>目標模組:</strong> <a href="file:///d:/12.任務/HVAC-1/src/etl/cleaner.py">src/etl/cleaner.py</a><br />
<strong>預估工時:</strong> 3 ~ 4 個工程天</p>
<hr />
<h2 id="1">1. 背景與問題陳述</h2>
<p>經過程式碼審查與架構評估，現有的 <code>DataCleaner</code> 模組存在核心架構缺陷，無法滿足多案場部署與高精度物理驗證的需求。主要問題如下：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">編號</th>
<th style="text-align: left;">問題分類</th>
<th style="text-align: center;">嚴重程度</th>
<th style="text-align: left;">影響描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>C1</strong></td>
<td style="text-align: left;"><strong>單位依賴 (Unit Dependency)</strong></td>
<td style="text-align: center;"><strong>Critical</strong></td>
<td style="text-align: left;">熱平衡驗證公式寫死為英制 (<code>GPM</code> / <code>°F</code> / <code>RT</code>)，導致公制案場資料被誤判為異常並遭到錯誤刪除。</td>
</tr>
<tr>
<td style="text-align: center;"><strong>C2</strong></td>
<td style="text-align: left;"><strong>邏輯脆弱 (Fragile Logic)</strong></td>
<td style="text-align: center;"><strong>High</strong></td>
<td style="text-align: left;">重採樣聚合邏輯依賴欄位名稱後綴 (如 <code>_KWH</code>)，若命名不符慣例，計數器資料將被錯誤平均。</td>
</tr>
<tr>
<td style="text-align: center;"><strong>C3</strong></td>
<td style="text-align: left;"><strong>基準線謬誤</strong></td>
<td style="text-align: center;"><strong>High</strong></td>
<td style="text-align: left;">親和律驗證以「當前資料中位數」為基準，若資料集整體異常，驗證機制將會失效（循環論證）。</td>
</tr>
<tr>
<td style="text-align: center;"><strong>C4</strong></td>
<td style="text-align: left;"><strong>職責不清</strong></td>
<td style="text-align: center;"><strong>Medium</strong></td>
<td style="text-align: left;">混雜了「資料清洗」與「特徵工程」（如濕球溫度計算），違反單一職責原則。</td>
</tr>
<tr>
<td style="text-align: center;"><strong>C5</strong></td>
<td style="text-align: left;"><strong>缺乏配置</strong></td>
<td style="text-align: center;"><strong>Medium</strong></td>
<td style="text-align: left;">物理閾值（COP範圍、穩定態判定窗口）皆為硬編碼，無法針對不同案場微調。</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. 重構目標與範圍</h2>
<h3 id="_1">核心目標</h3>
<p>將 <code>DataCleaner</code> 轉型為 <strong>單元感知 (Unit-Aware)</strong>、<strong>配置驅動 (Config-Driven)</strong> 且 <strong>職責單一</strong> 的物理清洗引擎。</p>
<h3 id="in-scope-vs-out-of-scope">範圍界定 (In-Scope vs Out-of-Scope)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">範圍</th>
<th style="text-align: left;">包含項目 (In-Scope)</th>
<th style="text-align: left;">排除項目 (Out-of-Scope)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>職責</strong></td>
<td style="text-align: left;">物理邊界檢查 (Physical Constraints)<br>異常值偵測與過濾<br>資料重採樣 (Resampling)<br>單位標準化 (SI制轉換)</td>
<td style="text-align: left;"><strong>特徵工程</strong> (如：濕球溫度計算、滾動平均、Lag特徵)<br>模型訓練資料生成</td>
</tr>
<tr>
<td style="text-align: left;"><strong>輸入</strong></td>
<td style="text-align: left;">原始 Polars DataFrame<br>全域配置 (Settings)</td>
<td style="text-align: left;">機器學習模型權重</td>
</tr>
<tr>
<td style="text-align: left;"><strong>輸出</strong></td>
<td style="text-align: left;">清洗後的 DataFrame (Clean Data)<br>資料品質報告 (Quality Report)</td>
<td style="text-align: left;">預測結果</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3">3. 系統架構設計</h2>
<h3 id="31">3.1 職責分層</h3>
<pre><code class="language-mermaid">graph LR
    ParsedData[Parsed Data] --&gt; Cleaner[DataCleaner]
    Cleaner --&gt;|1. 單位標準化| Unit[Unit Converter]
    Cleaner --&gt;|2. 物理驗證| Physics[Physics Validator]
    Cleaner --&gt;|3. 品質標記| Quality[Quality Tagger]
    Cleaner --&gt;|4. 重採樣| Agg[Resampler]
    Cleaner --&gt; CleanData[Clean Data]

    subgraph &quot;Feature Engineering (Next Stage)&quot;
        CleanData --&gt; FeatureEng[Feature Engineer]
        FeatureEng --&gt;|計算濕球溫度/焓值| ModelData
    end
</code></pre>
<h3 id="32">3.2 配置整合策略</h3>
<p>不建立獨立的設定檔，而是擴充現有的 <code>config/settings.yaml</code> 與 <code>config/feature_mapping.py</code>。</p>
<ul>
<li><strong><code>settings.yaml</code></strong>: 定義全域物理常數 (如水的比熱) 與預設閾值。</li>
<li><strong><code>feature_mapping.py</code></strong>: 為每個欄位定義「物理意義 (Physical Type)」、「單位 (Unit)」與「聚合方法 (Agg Method)」。</li>
</ul>
<hr />
<h2 id="4">4. 分階段實作計畫</h2>
<h3 id="phase-1-infrastructure">Phase 1: 基礎架構重整 (Infrastructure)</h3>
<h4 id="task-11">Task 1.1 — 定義清洗配置介面</h4>
<ul>
<li><strong>目標</strong>: 解除硬編碼，讓清洗邏輯可配置。</li>
<li><strong>實作</strong>:</li>
<li>在 <code>src/etl/cleaner.py</code> 中定義 <code>CleanerConfig</code> (Pydantic)。</li>
<li>支援從 <code>settings.yaml</code> 載入設定。</li>
<li>支援從 <code>feature_mapping</code> 讀取欄位屬性。</li>
</ul>
<h4 id="task-12-generic-resampler">Task 1.2 — 實作通用重採樣引擎 (Generic Resampler)</h4>
<ul>
<li><strong>目標</strong>: 解決 C2 問題，不再依賴欄位名稱猜測。</li>
<li><strong>邏輯</strong>:</li>
<li>優先讀取 <code>feature_mapping</code> 中的 <code>agg_method</code> (sum/max/mean/last)。</li>
<li>若未定義，則依據 <code>dtype</code> 採用安全預設值 (數值-&gt;mean, 字串-&gt;first)。</li>
<li>移除所有 <code>if col.endswith("KWH")</code> 類型的脆弱邏輯。</li>
</ul>
<h3 id="phase-2-physics-core">Phase 2: 單元感知的物理核心 (Physics Core)</h3>
<h4 id="task-21">Task 2.1 — 實作單位標準化轉換層</h4>
<ul>
<li><strong>目標</strong>: 解決 C1 問題，確保所有計算基於統一的物理基礎。</li>
<li><strong>邏輯</strong>:</li>
<li>在計算前，根據配置將與流量、溫度、壓力相關的欄位暫時轉換為 SI 制 (LPM, °C, kW)。</li>
<li>支援單位：<code>GPM/LPM</code>, <code>C/F</code>, <code>RT/kW/BTU</code>。</li>
</ul>
<h4 id="task-22-heat-balance">Task 2.2 — 重構熱平衡驗證 (Heat Balance)</h4>
<ul>
<li><strong>目標</strong>: 精確的物理驗證。</li>
<li><strong>公式</strong>: $Q (kW) = Flow (LPM) \times \Delta T (°C) \times C_p \times \rho / 60$</li>
<li><strong>輸入</strong>: 支援指定實際欄位名稱 (從 feature mapping 取得)。</li>
<li><strong>輸出</strong>: 產生 <code>heat_balance_error_pct</code> 欄位，而非直接刪除。</li>
</ul>
<h4 id="task-23-affinity-laws">Task 2.3 — 重構親和律驗證 (Affinity Laws)</h4>
<ul>
<li><strong>目標</strong>: 解決 C3 循環論證問題。</li>
<li><strong>改進</strong>:</li>
<li>移除「中位數基準」。</li>
<li>引入「額定規格 (Design Specs)」作為基準 (需在 Config 中加入設備規格)。</li>
<li>驗證公式：$kW_{act} / kW_{design} \approx (Hz_{act} / 60)^3$。</li>
</ul>
<h3 id="phase-3-quality-governance">Phase 3: 資料品質治理 (Quality Governance)</h3>
<h4 id="task-31-non-destructive-tagging">Task 3.1 — 實作無副作用標記 (Non-destructive Tagging)</h4>
<ul>
<li><strong>目標</strong>: 保留原始資料完整性，僅標記異常。</li>
<li><strong>實作</strong>:</li>
<li>新增 <code>quality_flags</code> 欄位 (List[str])。</li>
<li>標記類型：<code>FROZEN</code>, <code>HEAT_IMBALANCE</code>, <code>AFFINITY_VIOLATION</code>, <code>OUTLIBER</code>。</li>
<li>提供 <code>filter_strategy</code> 參數：決定最後輸出時是 <code>DROP</code> (刪除) 還是 <code>KEEP</code> (保留但標記)。</li>
</ul>
<h4 id="task-32">Task 3.2 — 移出特徵工程邏輯</h4>
<ul>
<li><strong>動作</strong>:</li>
<li>將 <code>calculate_wet_bulb_temp</code> 從 <code>cleaner.py</code> 移除。</li>
<li>(註：需同步建立 <code>src/etl/feature_engineer.py</code> 存放此邏輯，或暫存於 utils)。</li>
</ul>
<hr />
<h2 id="5">5. 驗證與測試計畫</h2>
<h3 id="51-unit-tests">5.1 單元測試 (Unit Tests)</h3>
<ul>
<li><strong>Test Metric System</strong>: 餵入公制資料 (LPM, °C)，驗證熱平衡檢查是否通過。</li>
<li><strong>Test Imperial System</strong>: 餵入英制資料 (GPM, °F)，驗證熱平衡檢查是否通過。</li>
<li><strong>Test Resampling</strong>: 驗證累積值欄位 (KWH) 是否正確使用 <code>last</code> 或 <code>max</code> 聚合。</li>
<li><strong>Test Quality Flags</strong>: 驗證異常資料是否正確被標記且未被誤刪 (當策略為 KEEP 時)。</li>
</ul>
<h3 id="52-integration-check">5.2 整合驗證 (Integration Check)</h3>
<ul>
<li>使用 <code>data/CGMH-TY</code> (實際案場資料) 執行清洗流程。</li>
<li>確認產出的資料筆數合理 (不應因錯誤驗證而變成 0 筆)。</li>
<li>確認日誌中包含詳細的品質摘要 (Quality Summary)。</li>
</ul>
<hr />
<h2 id="6">6. 風險評估</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">風險</th>
<th style="text-align: left;">緩解措施</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">現有 feature_mapping 缺少單位資訊</td>
<td style="text-align: left;">在 <code>settings.yaml</code> 提供全域預設單位，Phase 1 後盡快補齊 mapping 資訊。</td>
</tr>
<tr>
<td style="text-align: left;">設備額定規格 (Design Spec) 缺失</td>
<td style="text-align: left;"><code>validate_affinity_laws</code> 若無規格參數，則降級為僅檢查趨勢或跳過此檢查。</td>
</tr>
<tr>
<td style="text-align: left;">既有模型使用舊 logic 訓練</td>
<td style="text-align: left;">提供 <code>LegacyCleaner</code> 模式或版本切換，確保過渡期模型可用。</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7">7. 交付產物</h2>
<ol>
<li><code>src/etl/cleaner.py</code>: 重構後的程式碼。</li>
<li><code>tests/test_cleaner.py</code>: 涵蓋公/英制與邊界條件的測試。</li>
<li><code>config/settings.yaml</code>: 更新後的配置檔範本。</li>
</ol>
</body>
</html>