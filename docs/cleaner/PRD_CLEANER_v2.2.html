<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_CLEANER_v2.2</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v22-contract-aligned-datacleaner-implementation-guide">PRD v2.2-Contract-Aligned: è³‡æ–™æ¸…æ´—å™¨å¯¦ä½œæŒ‡å— (DataCleaner Implementation Guide)</h1>
<h1 id="feature-annotation-v12equipment-validation-sync-interface-contract-v11">å¼·åˆ¶åŸ·è¡Œç‰ˆï¼šæ•´åˆ Feature Annotation v1.2ã€Equipment Validation Sync èˆ‡ Interface Contract v1.1</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v2.2-Contract-Aligned (Interface Contract v1.1 Compliance &amp; Equipment Validation Integration)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-14<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/etl/cleaner.py</code> (v2.2+)<br />
<strong>ä¸Šæ¸¸å¥‘ç´„:</strong> <code>src/etl/parser.py</code> (v2.1+, è¼¸å‡º UTC, Header Standardization)<br />
<strong>ä¸‹æ¸¸å¥‘ç´„:</strong> <code>src/etl/batch_processor.py</code> (v1.3+, æª¢æŸ¥é» #2)<br />
<strong>é—œéµç›¸ä¾:</strong> <br />
- <code>src/features/annotation_manager.py</code> (v1.2+, æä¾› device_role æŸ¥è©¢)<br />
- <code>src/equipment/equipment_validator.py</code> (v1.0+, è¨­å‚™é‚è¼¯é æª¢ï¼Œæ–°å¢)<br />
- <code>src/core/temporal_baseline.py</code> (PipelineContext, æ™‚é–“åŸºæº–)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 7 ~ 8 å€‹å·¥ç¨‹å¤©ï¼ˆå«è¨­å‚™é‚è¼¯é æª¢ã€å¼·åŒ–æ™‚é–“åŒæ­¥ã€CI/CD Gate é…ç½®ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è®Šæ›´æ‘˜è¦</h2>
<h3 id="11-v21-v22-contract-aligned">1.1 ç‰ˆæœ¬è®Šæ›´ç¸½è¦½ (v2.1 â†’ v2.2-Contract-Aligned)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">è®Šæ›´é¡åˆ¥</th>
<th style="text-align: left;">v2.1 ç‹€æ…‹</th>
<th style="text-align: left;">v2.2-Contract-Aligned ä¿®æ­£</th>
<th style="text-align: center;">å½±éŸ¿å±¤ç´š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Interface Contract å°é½Š</strong></td>
<td style="text-align: left;">åŸºç¤å¥‘ç´„æª¢æŸ¥</td>
<td style="text-align: left;"><strong>å®Œå…¨å°é½Š v1.1 æª¢æŸ¥é» #2</strong>ï¼šæ–°å¢è¨­å‚™é‚è¼¯é æª¢ã€æ™‚é–“åŸºæº–å¼·åˆ¶åŒæ­¥</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Equipment Validation Sync</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><strong>æ–°å¢è¨­å‚™é‚è¼¯é æª¢æ©Ÿåˆ¶</strong>ï¼ˆE350ï¼‰ï¼Œèˆ‡ Optimization é™åˆ¶æ¢ä»¶ä¿æŒä¸€è‡´</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Temporal Baseline</strong></td>
<td style="text-align: left;">æåŠä½†æœªå¼·åˆ¶</td>
<td style="text-align: left;"><strong>å¼·åˆ¶ä½¿ç”¨</strong> <code>pipeline_origin_timestamp</code> é€²è¡Œæœªä¾†è³‡æ–™æª¢æŸ¥ï¼ˆE000, E102ï¼‰</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Header Standardization</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><strong>å°æ¥ Parser v2.1</strong>ï¼šæ¥æ”¶å·²æ­£è¦åŒ–æ¨™é ­ï¼Œé©—è­‰èˆ‡ Annotation åŒ¹é…ï¼ˆE409ï¼‰</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è¼¸å‡ºç¨½æ ¸è»Œè·¡</strong></td>
<td style="text-align: left;">åŸºç¤ metadata</td>
<td style="text-align: left;"><strong>æ–°å¢</strong> <code>equipment_validation_audit</code> ä¾› BatchProcessor å¯«å…¥ Manifest</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSOT å¼·åŒ–</strong></td>
<td style="text-align: left;">å¼•ç”¨ flags</td>
<td style="text-align: left;"><strong>æ–°å¢</strong> <code>EQUIPMENT_VALIDATION_CONSTRAINTS</code> å¼•ç”¨ï¼Œç¢ºä¿èˆ‡ Optimization é‚è¼¯ä¸€è‡´</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è·è²¬åˆ†é›¢</strong></td>
<td style="text-align: left;">ä¸‰å±¤é˜²è­·</td>
<td style="text-align: left;"><strong>ç¶­æŒ</strong>ç™½åå–®+Schemaæ·¨åŒ–+CI Gateï¼Œç¢ºä¿ E500 çµ•ä¸ç™¼ç”Ÿ</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
</tbody>
</table>
<h3 id="12-contract-aligned">1.2 æ ¸å¿ƒè¨­è¨ˆåŸå‰‡ï¼ˆContract-Aligned ç‰ˆï¼‰</h3>
<ol>
<li><strong>Gatekeeper (å®ˆé–€å“¡)</strong>: é«’æ•¸æ“šçµ•ä¸é€²å…¥ä¸‹æ¸¸ï¼Œ<strong>è¨­å‚™é‚è¼¯é•è¦æå‰æ¨™è¨˜</strong>ï¼ˆéç­‰åˆ° Optimization æ‰ç™¼ç¾ï¼‰</li>
<li><strong>SSOT åš´æ ¼éµå®ˆ</strong>: æ‰€æœ‰å“è³ªæ¨™è¨˜ã€å–®ä½å®šç¾©ã€<strong>è¨­å‚™é™åˆ¶æ¢ä»¶</strong>å¿…é ˆå¼•ç”¨ <code>config_models.py</code></li>
<li><strong>è·è²¬åˆ†é›¢å¼·åˆ¶åŸ·è¡Œ (Mandatory Separation of Concerns)</strong>:<br />
   - <strong>Cleaner è·è²¬</strong>ï¼šè®€å– <code>device_role</code> é€²è¡Œ<strong>èªæ„æ„ŸçŸ¥æ¸…æ´—</strong>èˆ‡<strong>è¨­å‚™é‚è¼¯é æª¢</strong>ï¼Œä½†<strong>çµ•å°ç¦æ­¢å°‡ <code>device_role</code> å¯«å…¥è¼¸å‡º</strong><br />
   - <strong>å¼·åˆ¶æ©Ÿåˆ¶</strong>ï¼šé€é <code>ALLOWED_METADATA_KEYS</code> ç™½åå–®èˆ‡ <code>FORBIDDEN_COLS</code> è‡ªå‹•æ¸…é™¤ï¼Œå¾æŠ€è¡“å±¤é¢æœçµ•èª¤å¯«å…¥<br />
   - <strong>è¨­å‚™é‚è¼¯é æª¢</strong>ï¼šåœ¨æ¸…æ´—éšæ®µæª¢æŸ¥åŸºç¤è¨­å‚™é‚è¼¯ï¼ˆå¦‚ä¸»æ©Ÿé–‹å•Ÿæ™‚æ°´æ³µä¸å¯å…¨é—œï¼‰ï¼Œæ¨™è¨˜é•è¦è³‡æ–™ä¾›ä¸‹æ¸¸åƒè€ƒ</li>
<li><strong>æ™‚é–“åŸºæº–ä¸€è‡´æ€§</strong>: æ‰€æœ‰æ™‚é–“ç›¸é—œé©—è­‰ï¼ˆæœªä¾†è³‡æ–™æª¢æŸ¥ï¼‰å¿…é ˆä½¿ç”¨ä¸Šæ¸¸å‚³å…¥çš„ <code>pipeline_origin_timestamp</code>ï¼Œ<strong>ç¦æ­¢</strong>ä½¿ç”¨ <code>datetime.now()</code></li>
<li><strong>ç‰©ç†é‚è¼¯ä¸€è‡´æ€§</strong>: èˆ‡ Optimization å…±äº« <code>EQUIPMENT_VALIDATION_CONSTRAINTS</code>ï¼Œç¢ºä¿æ¸…æ´—éšæ®µèˆ‡å„ªåŒ–éšæ®µçš„è¨­å‚™é‚è¼¯ä¸€è‡´</li>
</ol>
<h3 id="13-interface-contract-v11">1.3 èˆ‡ Interface Contract v1.1 çš„å°é½Šé—œä¿‚</h3>
<pre><code class="language-mermaid">graph LR
    A[Parser v2.1&lt;br/&gt;Header Standardization] --&gt;|æ­£è¦åŒ–æ¨™é ­&lt;br/&gt;pipeline_origin_timestamp| B[DataCleaner v2.2]
    B --&gt;|è®€å– device_role| C[èªæ„æ„ŸçŸ¥æ¸…æ´—&lt;br/&gt;èª¿æ•´é–¾å€¼]
    B --&gt;|è®€å–è¨­å‚™ç‹€æ…‹| D[Equipment Validation Precheck&lt;br/&gt;E350]
    D --&gt;|æ¨™è¨˜é•è¦| E[quality_flags&lt;br/&gt;PHYSICAL_IMPOSSIBLE]
    C --&gt;|è¼¸å‡º| F[Clean DataFrame&lt;br/&gt;ä¸å« device_role]
    B --&gt;|ç”¢ç”Ÿ| G[equipment_validation_audit&lt;br/&gt;ä¾› Manifest]
    F --&gt;|å¼·åˆ¶æ·¨åŒ–| H[BatchProcessor v1.3&lt;br/&gt;æª¢æŸ¥é» #2]
    H --&gt;|è®€å–| I[FeatureAnnotationManager&lt;br/&gt;ç›´æ¥æŸ¥è©¢ device_role]

    style B fill:#f9f,stroke:#333,stroke-width:4px
    style D fill:#ff9,stroke:#f00,stroke-width:3px
    style F fill:#bbf,stroke:#f00,stroke-width:3px
</code></pre>
<p><strong>é—œéµç´„æŸï¼ˆå¼·åˆ¶åŸ·è¡Œï¼‰</strong>ï¼š<br />
- ğŸ”´ <strong>Cleaner ä¸å¯«å…¥ device_role</strong>ï¼šè¼¸å‡º DataFrame çš„ schema ä¸­<strong>ä¸å¾—åŒ…å«</strong> <code>device_role</code> æ¬„ä½æˆ– metadata<br />
- ğŸ”´ <strong>æ™‚é–“åŸºæº–å¼·åˆ¶ä½¿ç”¨</strong>ï¼šæœªä¾†è³‡æ–™æª¢æŸ¥å¿…é ˆä½¿ç”¨è¼¸å…¥çš„ <code>pipeline_origin_timestamp</code>ï¼Œé•åè¦–ç‚º E000 éŒ¯èª¤<br />
- ğŸ”´ <strong>è¨­å‚™é‚è¼¯é æª¢</strong>ï¼šè‹¥å•Ÿç”¨ <code>enforce_equipment_validation_sync</code>ï¼Œå¿…é ˆåŸ·è¡ŒåŸºç¤è¨­å‚™é‚è¼¯æª¢æŸ¥ä¸¦è¨˜éŒ„ç¨½æ ¸è»Œè·¡<br />
- ğŸŸ¡ <strong>æ¨™é ­å°æ‡‰é©—è­‰</strong>ï¼šæ¥æ”¶ Parser æ­£è¦åŒ–å¾Œçš„æ¨™é ­ï¼Œé©—è­‰èˆ‡ Annotation ä¸­çš„ <code>column_name</code> åŒ¹é…ï¼ˆE409ï¼‰</p>
<hr />
<h2 id="2-interface-contracts">2. ä»‹é¢å¥‘ç´„è¦ç¯„ (Interface Contracts)</h2>
<h3 id="21-input-contract-from-parser-v21">2.1 è¼¸å…¥å¥‘ç´„ (Input Contract from Parser v2.1)</h3>
<p><strong>å°é½Š Interface Contract v1.1 æª¢æŸ¥é» #1 â†’ #2 éæ¸¡</strong>:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">æª¢æŸ¥é …</th>
<th style="text-align: left;">è¦æ ¼</th>
<th style="text-align: left;">å®¹éŒ¯è™•ç†</th>
<th style="text-align: center;">éŒ¯èª¤ä»£ç¢¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>timestamp</code></td>
<td style="text-align: left;"><code>Datetime(time_unit='ns', time_zone='UTC')</code></td>
<td style="text-align: left;">è‹¥ä¸ç¬¦ï¼Œå˜—è©¦è½‰æ›æˆ–æ‹’çµ•</td>
<td style="text-align: center;">E101</td>
</tr>
<tr>
<td style="text-align: left;"><code>pipeline_origin_timestamp</code></td>
<td style="text-align: left;"><strong>å¿…é ˆå­˜åœ¨æ–¼ metadata</strong> (ISO 8601 UTC)</td>
<td style="text-align: left;">éºå¤±å‰‡æ‹‹å‡º E000</td>
<td style="text-align: center;"><strong>E000</strong></td>
</tr>
<tr>
<td style="text-align: left;"><code>quality_flags</code></td>
<td style="text-align: left;"><code>List(Utf8)</code> (å¯é¸)</td>
<td style="text-align: left;">è‹¥å­˜åœ¨ï¼Œé©—è­‰å€¼ âŠ† <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: center;">E103</td>
</tr>
<tr>
<td style="text-align: left;">æ•¸å€¼æ¬„ä½</td>
<td style="text-align: left;"><code>Float64</code> (SI å–®ä½)</td>
<td style="text-align: left;">å–®ä½è½‰æ› (è‹¥é…ç½® <code>unit_system=IMPERIAL</code>)</td>
<td style="text-align: center;">E104</td>
</tr>
<tr>
<td style="text-align: left;">ç·¨ç¢¼</td>
<td style="text-align: left;">UTF-8ï¼Œç„¡ BOM</td>
<td style="text-align: left;">ç™¼ç¾ BOM â†’ æˆªæ–·ä¸¦è¨˜éŒ„ Warning</td>
<td style="text-align: center;">E105</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ¬„ä½å­˜åœ¨æ€§</strong></td>
<td style="text-align: left;">æ‰€æœ‰æ¬„ä½å¿…é ˆåœ¨ Annotation ä¸­å®šç¾©</td>
<td style="text-align: left;">æœªå®šç¾©æ¬„ä½ä¾ <code>unannotated_column_policy</code> è™•ç†</td>
<td style="text-align: center;"><strong>E402</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ¨™é ­æ­£è¦åŒ–</strong></td>
<td style="text-align: left;">æ¬„ä½åç¨±å¿…é ˆå·²ç‚º snake_case (Parser è™•ç†)</td>
<td style="text-align: left;">è‹¥æ”¶åˆ°éæ­£è¦åŒ–æ¨™é ­ï¼Œè¨˜éŒ„è­¦å‘Š</td>
<td style="text-align: center;"><strong>E105-W</strong></td>
</tr>
</tbody>
</table>
<p><strong>é—œéµæ™‚é–“åŸºæº–æª¢æŸ¥</strong>:<br />
- <strong>E000 (TEMPORAL_BASELINE_MISSING)</strong>: è‹¥è¼¸å…¥ metadata ä¸å« <code>pipeline_origin_timestamp</code>ï¼Œç«‹å³çµ‚æ­¢æµç¨‹<br />
- <strong>æ™‚é–“ä¸€è‡´æ€§</strong>: ä½¿ç”¨å‚³å…¥çš„ <code>pipeline_origin_timestamp</code> é€²è¡Œæ‰€æœ‰æœªä¾†è³‡æ–™æª¢æŸ¥ï¼Œ<strong>ç¦æ­¢</strong>å‘¼å« <code>datetime.now()</code></p>
<h3 id="22-output-contract-to-batchprocessor-v13">2.2 è¼¸å‡ºå¥‘ç´„ (Output Contract to BatchProcessor v1.3)</h3>
<p><strong>å°é½Š Interface Contract v1.1 æª¢æŸ¥é» #2</strong>:</p>
<pre><code class="language-python">class CleanerOutputContract:
    &quot;&quot;&quot;Cleaner v2.2-Contract-Aligned è¼¸å‡ºè³‡æ–™è¦ç¯„ï¼ˆå¼·åˆ¶åŸ·è¡Œç‰ˆï¼‰&quot;&quot;&quot;

    # 1. æ™‚é–“æˆ³è¦ç¯„ (èˆ‡ Parser v2.1 ä¸€è‡´ï¼Œç›´æ¥é€å‚³)
    timestamp: pl.Datetime(time_unit=&quot;ns&quot;, time_zone=&quot;UTC&quot;)

    # 2. æ™‚é–“åŸºæº–å‚³é (æ–°å¢å¼·åˆ¶è¦æ±‚)
    temporal_baseline: Dict = {
        &quot;pipeline_origin_timestamp&quot;: str,  # ISO 8601 UTCï¼Œèˆ‡è¼¸å…¥ç›¸åŒ
        &quot;timezone&quot;: &quot;UTC&quot;,
        &quot;baseline_version&quot;: &quot;1.0&quot;
    }

    # 3. å“è³ªæ¨™è¨˜ (æ ¸å¿ƒè®Šæ›´ï¼šå¿…é ˆå¼•ç”¨ SSOT)
    quality_flags: pl.List(pl.Utf8)  # å€¼å¿…é ˆ âˆˆ VALID_QUALITY_FLAGS
    # å¯èƒ½æ–°å¢ï¼šPHYSICAL_IMPOSSIBLE (è¨­å‚™é‚è¼¯é•è¦), EQUIPMENT_VIOLATION

    # 4. è³‡æ–™æ¬„ä½ (SI å–®ä½ï¼Œç„¡å–®ä½å­—å…ƒ)
    data_columns: pl.Float64  # æ‰€æœ‰æ„Ÿæ¸¬å™¨æ•¸å€¼

    # 5. æ™‚é–“è»¸å®Œæ•´æ€§æ¨™è¨˜
    temporal_continuity: bool  # True=é€£çºŒç„¡ç¼ºæ¼, False=æœ‰ç¼ºæ¼å·²è£œNull

    # 6. Metadata (å‚³éçµ¦ BatchProcessor å¯«å…¥ Manifest)
    # ã€é—œéµã€‘ä¸åŒ…å« device_roleï¼Œåƒ…åŒ…å«ç‰©ç†é¡å‹èˆ‡å–®ä½ï¼Œä¸”ç¶“éç™½åå–®å¼·åˆ¶éæ¿¾
    column_metadata: Dict[str, ColumnMeta]  # åƒ…é™ ALLOWED_METADATA_KEYS ä¸­çš„éµ

    # 7. è¨­å‚™é‚è¼¯ç¨½æ ¸è»Œè·¡ (æ–°å¢ï¼Œå°é½Š Interface Contract v1.1)
    equipment_validation_audit: Dict = {
        &quot;validation_enabled&quot;: bool,
        &quot;constraints_applied&quot;: List[str],  # å¥—ç”¨çš„é™åˆ¶æ¢ä»¶ ID åˆ—è¡¨
        &quot;violations_detected&quot;: int,        # é•è¦ç­†æ•¸
        &quot;violation_details&quot;: List[Dict]    # é•è¦è©³æƒ…ï¼ˆæ™‚é–“é»ã€è¨­å‚™ã€é™åˆ¶é¡å‹ï¼‰
    }
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: left;">é©—è­‰é …ç›®</th>
<th style="text-align: left;">è¦æ ¼</th>
<th style="text-align: center;">å¤±æ•—ä»£ç¢¼</th>
<th style="text-align: center;">åš´é‡åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>æ™‚é–“åŸºæº–å‚³é</strong></td>
<td style="text-align: left;">è¼¸å‡º metadata å¿…é ˆåŒ…å« <code>pipeline_origin_timestamp</code></td>
<td style="text-align: center;"><strong>E000</strong></td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æœªä¾†è³‡æ–™æª¢æŸ¥</strong></td>
<td style="text-align: left;">æ‰€æœ‰æ™‚é–“æˆ³ â‰¤ <code>pipeline_origin_timestamp + 5min</code></td>
<td style="text-align: center;"><strong>E102</strong></td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è¨­å‚™é‚è¼¯é æª¢</strong></td>
<td style="text-align: left;">è‹¥å•Ÿç”¨ï¼Œå¿…é ˆæª¢æŸ¥åŸºç¤è¨­å‚™é‚è¼¯ä¸¦æ¨™è¨˜é•è¦</td>
<td style="text-align: center;"><strong>E350</strong></td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role ä¸å­˜åœ¨</strong></td>
<td style="text-align: left;">DataFrame èˆ‡ metadata çš†ä¸å¯å«æ­¤æ¬„ä½</td>
<td style="text-align: center;"><strong>E500</strong></td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Metadata ç´”æ·¨æ€§</strong></td>
<td style="text-align: left;">åƒ…å…è¨± <code>physical_type</code>, <code>unit</code>, <code>description</code></td>
<td style="text-align: center;"><strong>E500</strong></td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Quality Flags åˆæ³•æ€§</strong></td>
<td style="text-align: left;">æ‰€æœ‰å€¼å¿…é ˆ âˆˆ <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: center;"><strong>E202</strong></td>
<td style="text-align: center;">Critical</td>
</tr>
</tbody>
</table>
<h3 id="23-feature-annotation-equipment-validation">2.3 Feature Annotation èˆ‡ Equipment Validation æ•´åˆå¥‘ç´„</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">é …ç›®</th>
<th style="text-align: left;">ä¾†æº</th>
<th style="text-align: center;">ä½¿ç”¨æ–¹å¼</th>
<th style="text-align: center;">æ˜¯å¦å¯«å…¥è¼¸å‡º</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>physical_type</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">ç‰©ç†é™åˆ¶æª¢æŸ¥ã€å–®ä½é©—è­‰</td>
<td style="text-align: center;">âœ… æ˜¯ï¼ˆç¶“ç™½åå–®éæ¿¾å¾Œå¯«å…¥ metadataï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><code>unit</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">å–®ä½è½‰æ›é©—è­‰</td>
<td style="text-align: center;">âœ… æ˜¯ï¼ˆç¶“ç™½åå–®éæ¿¾å¾Œå¯«å…¥ metadataï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><code>device_role</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;"><strong>èªæ„æ„ŸçŸ¥æ¸…æ´—ç­–ç•¥èª¿æ•´</strong>ã€<strong>è¨­å‚™é‚è¼¯é æª¢æ¢ä»¶åˆ¤æ–·</strong></td>
<td style="text-align: center;">âŒ <strong>å¦</strong>ï¼ˆåƒ… runtime ä½¿ç”¨ï¼Œå¼·åˆ¶ç§»é™¤ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><code>ignore_warnings</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">æ±ºå®šæ˜¯å¦æ¨™è¨˜ç‰¹å®š Warning</td>
<td style="text-align: center;">âŒ <strong>å¦</strong>ï¼ˆåƒ… runtime ä½¿ç”¨ï¼Œå¼·åˆ¶ç§»é™¤ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><code>is_target</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">è·³éç‰¹å®šæ¸…æ´—ï¼ˆå¦‚ target ä¸æ¨™è¨˜ FROZENï¼‰</td>
<td style="text-align: center;">âŒ <strong>å¦</strong>ï¼ˆåƒ… runtime ä½¿ç”¨ï¼Œå¼·åˆ¶ç§»é™¤ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è¨­å‚™ç‹€æ…‹æ¬„ä½</strong></td>
<td style="text-align: left;"><code>physical_type == 'status'</code></td>
<td style="text-align: center;">è¨­å‚™é‚è¼¯é æª¢ï¼ˆå¦‚ chiller_1_statusï¼‰</td>
<td style="text-align: center;">âœ… æ˜¯ï¼ˆä½œç‚ºè³‡æ–™æ¬„ä½ï¼Œé metadataï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è¨­å‚™é™åˆ¶æ¢ä»¶</strong></td>
<td style="text-align: left;"><code>EQUIPMENT_VALIDATION_CONSTRAINTS</code> (SSOT)</td>
<td style="text-align: center;">é æª¢é‚è¼¯åˆ¤æ–·</td>
<td style="text-align: center;">âŒ <strong>å¦</strong>ï¼ˆé‚è¼¯ä½¿ç”¨ï¼Œä¸å¯«å…¥è¼¸å‡ºï¼‰</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-equipment-validation-precheck">3. è¨­å‚™é‚è¼¯é æª¢è¦ç¯„ (Equipment Validation Precheck)</h2>
<h3 id="31">3.1 è¨­è¨ˆç›®æ¨™</h3>
<p>ç‚ºè§£æ±º <strong>Physics Logic Decoupling</strong> é¢¨éšªï¼ˆæ¸…æ´—æ™‚æœªæª¢æ¸¬é•è¦ï¼Œå„ªåŒ–æ™‚æ‰ç™¼ç¾ä¸å¯è¡Œï¼‰ï¼ŒDataCleaner åœ¨æ¸…æ´—éšæ®µåŸ·è¡ŒåŸºç¤è¨­å‚™é‚è¼¯é æª¢ï¼Œæå‰æ¨™è¨˜é•è¦è³‡æ–™ã€‚</p>
<p><strong>é æª¢ç¯„åœ</strong>:<br />
- åƒ…æª¢æŸ¥<strong>åŸºç¤é‚è¼¯</strong>ï¼ˆå¦‚ä¸»æ©Ÿé–‹å•Ÿæ™‚æ°´æ³µä¸å¯å…¨é—œï¼‰<br />
- ä¸æª¢æŸ¥<strong>è¤‡é›œæ™‚åº</strong>ï¼ˆå¦‚æœ€å°é‹è½‰æ™‚é–“ï¼Œç”±å°ˆé–€çš„ EquipmentValidator è™•ç†ï¼‰<br />
- æ¨™è¨˜ç‚º <code>PHYSICAL_IMPOSSIBLE</code> æˆ– <code>EQUIPMENT_VIOLATION</code>ï¼Œä¾› Optimization åƒè€ƒ</p>
<h3 id="32-ssot">3.2 æ•´åˆ SSOT é™åˆ¶æ¢ä»¶</h3>
<pre><code class="language-python"># å¼•ç”¨è‡ª Interface Contract v1.1 / config_models.py
from src.etl.config_models import EQUIPMENT_VALIDATION_CONSTRAINTS

# Cleaner å…§éƒ¨ä½¿ç”¨çš„é æª¢è¦å‰‡ï¼ˆèˆ‡ Optimization å…±äº« SSOTï¼‰
PRECHECK_CONSTRAINTS = {
    &quot;chiller_pump_mutex&quot;: {
        &quot;description&quot;: &quot;ä¸»æ©Ÿé–‹å•Ÿæ™‚å¿…é ˆæœ‰è‡³å°‘ä¸€å°å†·å»æ°´æ³µé‹è½‰&quot;,
        &quot;check_type&quot;: &quot;requires&quot;,
        &quot;trigger_status&quot;: [&quot;chiller_1_status&quot;, &quot;chiller_2_status&quot;],  # ä»»ä¸€ç‚º 1 æ™‚è§¸ç™¼
        &quot;required_status&quot;: [&quot;pump_1_status&quot;, &quot;pump_2_status&quot;],       # è‡³å°‘ä¸€å€‹å¿…é ˆç‚º 1
        &quot;severity&quot;: &quot;critical&quot;,  # æ¨™è¨˜ç‚º PHYSICAL_IMPOSSIBLE
    },
    &quot;chiller_cooling_tower_mutex&quot;: {
        &quot;description&quot;: &quot;ä¸»æ©Ÿé–‹å•Ÿæ™‚å¿…é ˆæœ‰è‡³å°‘ä¸€å°å†·å»æ°´å¡”é‹è½‰&quot;,
        &quot;check_type&quot;: &quot;requires&quot;, 
        &quot;trigger_status&quot;: [&quot;chiller_1_status&quot;, &quot;chiller_2_status&quot;],
        &quot;required_status&quot;: [&quot;ct_1_status&quot;, &quot;ct_2_status&quot;],
        &quot;severity&quot;: &quot;critical&quot;,
    }
}
</code></pre>
<h3 id="33">3.3 é æª¢åŸ·è¡Œæµç¨‹</h3>
<pre><code class="language-python">def _apply_equipment_validation_precheck(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    è¨­å‚™é‚è¼¯é æª¢ï¼ˆå°é½Š Interface Contract v1.1 æª¢æŸ¥é» #2ï¼‰

    åŸ·è¡Œæ™‚æ©Ÿï¼šåœ¨ Semantic-Aware Cleaning ä¹‹å¾Œï¼Œè¼¸å‡ºé©—è­‰ä¹‹å‰
    é‚è¼¯ï¼š
    1. è­˜åˆ¥è¨­å‚™ç‹€æ…‹æ¬„ä½ï¼ˆphysical_type == 'status'ï¼‰
    2. æª¢æŸ¥ PRECHECK_CONSTRAINTS ä¸­çš„æ¢ä»¶
    3. é•åæ™‚æ¨™è¨˜ quality_flagsï¼Œä¸¦è¨˜éŒ„è‡³ equipment_validation_audit
    &quot;&quot;&quot;
    if not self.config.enforce_equipment_validation_sync:
        self._equipment_validation_audit = {
            &quot;validation_enabled&quot;: False,
            &quot;constraints_applied&quot;: [],
            &quot;violations_detected&quot;: 0,
            &quot;violation_details&quot;: []
        }
        return df

    violations = []
    df_with_flags = df

    for constraint_id, constraint in PRECHECK_CONSTRAINTS.items():
        # æª¢æŸ¥è§¸ç™¼æ¢ä»¶ï¼ˆæ˜¯å¦æœ‰ä¸»æ©Ÿé–‹å•Ÿï¼‰
        trigger_cols = [c for c in constraint[&quot;trigger_status&quot;] if c in df.columns]
        if not trigger_cols:
            continue

        # å»ºç«‹è§¸ç™¼é®ç½©ï¼ˆä»»ä¸€è§¸ç™¼æ¬„ä½ç‚º 1ï¼‰
        trigger_mask = pl.col(trigger_cols[0]) == 1
        for col in trigger_cols[1:]:
            trigger_mask = trigger_mask | (pl.col(col) == 1)

        # æª¢æŸ¥éœ€æ±‚æ¢ä»¶ï¼ˆæ˜¯å¦è‡³å°‘ä¸€å°æ°´æ³µé‹è½‰ï¼‰
        required_cols = [c for c in constraint[&quot;required_status&quot;] if c in df.columns]
        if not required_cols:
            continue

        requirement_mask = pl.col(required_cols[0]) == 1
        for col in required_cols[1:]:
            requirement_mask = requirement_mask | (pl.col(col) == 1)

        # é•è¦ï¼šè§¸ç™¼ä½†éœ€æ±‚ä¸æ»¿è¶³
        violation_mask = trigger_mask &amp; ~requirement_mask

        # çµ±è¨ˆé•è¦
        violation_count = df.filter(violation_mask).height
        if violation_count &gt; 0:
            violations.append({
                &quot;constraint_id&quot;: constraint_id,
                &quot;description&quot;: constraint[&quot;description&quot;],
                &quot;count&quot;: violation_count,
                &quot;severity&quot;: constraint[&quot;severity&quot;]
            })

            # æ¨™è¨˜ Quality Flag
            flag = &quot;PHYSICAL_IMPOSSIBLE&quot; if constraint[&quot;severity&quot;] == &quot;critical&quot; else &quot;EQUIPMENT_VIOLATION&quot;
            df_with_flags = df_with_flags.with_columns(
                pl.when(violation_mask).then(
                    pl.col(&quot;quality_flags&quot;).list.concat(pl.lit([flag]))
                ).otherwise(pl.col(&quot;quality_flags&quot;)).alias(&quot;quality_flags&quot;)
            )

    # è¨˜éŒ„ç¨½æ ¸è»Œè·¡ï¼ˆä¾› BatchProcessor å¯«å…¥ Manifestï¼‰
    self._equipment_validation_audit = {
        &quot;validation_enabled&quot;: True,
        &quot;constraints_applied&quot;: list(PRECHECK_CONSTRAINTS.keys()),
        &quot;violations_detected&quot;: sum(v[&quot;count&quot;] for v in violations),
        &quot;violation_details&quot;: violations
    }

    if violations:
        self.logger.warning(
            f&quot;è¨­å‚™é‚è¼¯é æª¢ç™¼ç¾ {len(violations)} é …é•è¦: &quot;
            f&quot;{[v['constraint_id'] for v in violations]}&quot;
        )

    return df_with_flags
</code></pre>
<hr />
<h2 id="4-phase-based-implementation">4. åˆ†éšæ®µå¯¦ä½œè¨ˆç•« (Phase-Based Implementation)</h2>
<h3 id="phase-0-annotation-day-1">Phase 0: Annotation æ•´åˆèˆ‡æ™‚é–“åŸºæº–åŸºç¤å»ºè¨­ (Day 1)</h3>
<h4 id="step-01-temporal-context">Step 0.1: å»ºæ§‹å­èˆ‡ Temporal Context æ³¨å…¥</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/cleaner.py</code> (é ‚éƒ¨èˆ‡ <code>__init__</code>)</p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<pre><code class="language-python">from typing import Final, Dict, List, Optional, Tuple, Set, Any
import polars as pl
import numpy as np
from datetime import datetime, timedelta, timezone
from pydantic import BaseModel, validator

# ã€é—œéµã€‘SSOT åš´æ ¼å¼•ç”¨ï¼ˆå°é½Š Interface Contract v1.1ï¼‰
from src.etl.config_models import (
    VALID_QUALITY_FLAGS,      # SSOT: å“è³ªæ¨™è¨˜
    TIMESTAMP_CONFIG,         # SSOT: æ™‚é–“æˆ³è¦æ ¼ (UTC, ns)
    FEATURE_ANNOTATION_CONSTANTS,  # SSOT: Annotation ç‰ˆæœ¬
    EQUIPMENT_VALIDATION_CONSTRAINTS,  # ã€æ–°å¢ã€‘SSOT: è¨­å‚™é™åˆ¶æ¢ä»¶
    CleanerConfig,
)

# ã€æ–°å¢ã€‘Temporal Baseline æ•´åˆ
from src.core.temporal_baseline import TemporalContext, get_temporal_context

# ã€æ–°å¢ã€‘Feature Annotation èˆ‡ Equipment Validation æ•´åˆ
from src.features.annotation_manager import FeatureAnnotationManager, ColumnAnnotation
from src.equipment.equipment_validator import EquipmentValidator  # ã€æ–°å¢ã€‘

from src.exceptions import (
    ConfigurationError, ContractViolationError, DataValidationError,
    TemporalBaselineError  # ã€æ–°å¢ã€‘
)

class DataCleaner:
    &quot;&quot;&quot;
    DataCleaner v2.2-Contract-Aligned
    - æ•´åˆ Feature Annotation v1.2ï¼ˆèªæ„æ„ŸçŸ¥æ¸…æ´—ï¼‰
    - æ•´åˆ Equipment Validation Syncï¼ˆè¨­å‚™é‚è¼¯é æª¢ï¼‰
    - å¼·åˆ¶åŸ·è¡Œ Temporal Baselineï¼ˆæ™‚é–“åŸºæº–ä¸€è‡´æ€§ï¼‰
    - è·è²¬åˆ†é›¢å¼·åˆ¶åŸ·è¡Œï¼ˆä¸‰å±¤é˜²è­·ï¼‰
    &quot;&quot;&quot;

    # ã€å¼·åˆ¶åŸ·è¡Œã€‘é¡åˆ¥å±¤ç´šå¸¸æ•¸å®šç¾©ï¼ˆç¶­æŒä¸è®Šï¼‰
    ALLOWED_METADATA_KEYS: Final[Set[str]] = frozenset({
        'physical_type', 'unit', 'description', 'column_name'
    })

    FORBIDDEN_COLS: Final[Set[str]] = frozenset({
        'device_role', 'ignore_warnings', 'is_target', 'role', 
        'device_type', 'annotation_role', 'col_role', 'feature_role'
    })

    DEVICE_ROLE_THRESHOLDS: Final[Dict[str, Dict]] = {
        &quot;primary&quot;: {&quot;frozen_multiplier&quot;: 1.0, &quot;zero_ratio_warning&quot;: 0.1},
        &quot;backup&quot;: {&quot;frozen_multiplier&quot;: 3.0, &quot;zero_ratio_warning&quot;: 0.8},
        &quot;seasonal&quot;: {&quot;frozen_multiplier&quot;: 2.0, &quot;zero_ratio_warning&quot;: 0.5}
    }

    def __init__(
        self, 
        config: CleanerConfig,
        annotation_manager: Optional[FeatureAnnotationManager] = None,
        temporal_context: Optional[TemporalContext] = None,  # ã€æ–°å¢ã€‘
        equipment_validator: Optional[EquipmentValidator] = None  # ã€æ–°å¢ã€‘
    ):
        &quot;&quot;&quot;
        Args:
            config: æ¸…æ´—é…ç½®
            annotation_manager: ç‰¹å¾µæ¨™è¨»ç®¡ç†å™¨
            temporal_context: æ™‚é–“åŸºæº–ä¸Šä¸‹æ–‡ï¼ˆå¼·åˆ¶ä½¿ç”¨ï¼Œç¦æ­¢è‡ªè¡Œç”¢ç”Ÿæ™‚é–“æˆ³ï¼‰
            equipment_validator: è¨­å‚™é©—è­‰å™¨ï¼ˆç”¨æ–¼é æª¢ï¼‰
        &quot;&quot;&quot;
        self.config = config
        self.annotation = annotation_manager
        self.equipment_validator = equipment_validator  # ã€æ–°å¢ã€‘
        self.logger = get_logger(&quot;DataCleaner&quot;)

        # ã€æ–°å¢ã€‘æ™‚é–“åŸºæº–å¼·åˆ¶æª¢æŸ¥ï¼ˆå°é½Š Interface Contract v1.1 E000ï¼‰
        if temporal_context is None:
            raise TemporalBaselineError(
                &quot;E000: DataCleaner å¿…é ˆæ¥æ”¶ TemporalContextï¼Œç¦æ­¢è‡ªè¡Œç”¢ç”Ÿæ™‚é–“æˆ³ã€‚ &quot;
                &quot;è«‹ç¢ºä¿ Container æ­£ç¢ºå‚³é pipeline_origin_timestampã€‚&quot;
            )
        self.temporal_context = temporal_context
        self.pipeline_origin_timestamp = temporal_context.get_baseline()

        # é©—è­‰ï¼šè‹¥å•Ÿç”¨è¨­å‚™é‚è¼¯é æª¢ï¼Œå»ºè­°æä¾› EquipmentValidator
        if config.enforce_equipment_validation_sync and equipment_validator is None:
            self.logger.warning(
                &quot;å•Ÿç”¨è¨­å‚™é‚è¼¯é æª¢ä½†æœªæä¾› EquipmentValidatorï¼Œå°‡ä½¿ç”¨å…§å»ºé æª¢é‚è¼¯&quot;
            )

        self.logger.info(
            f&quot;åˆå§‹åŒ– DataCleaner (SSOT Flags: {len(VALID_QUALITY_FLAGS)}, &quot;
            f&quot;Temporal Baseline: {self.pipeline_origin_timestamp.isoformat()}, &quot;
            f&quot;Equipment Validation: {config.enforce_equipment_validation_sync})&quot;
        )
</code></pre>
<h4 id="step-02-e402-e409">Step 0.2: æœªå®šç¾©æ¬„ä½èˆ‡æ¨™é ­é©—è­‰ (E402, E409)</h4>
<pre><code class="language-python">def _validate_columns_annotated(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    é©—è­‰æ‰€æœ‰æ¬„ä½å·²åœ¨ Annotation ä¸­å®šç¾© (E402)
    ä¸¦é©—è­‰æ¨™é ­å·²æ­£è¦åŒ–ï¼ˆå°é½Š Interface Contract v1.1 Header Standardizationï¼‰
    &quot;&quot;&quot;
    if not self.annotation or not self.config.use_device_role_from_annotation:
        return df

    unannotated = []
    non_standardized = []  # ã€æ–°å¢ã€‘æª¢æŸ¥éæ­£è¦åŒ–æ¨™é ­

    for col in df.columns:
        if col == &quot;timestamp&quot;:
            continue

        # E402 æª¢æŸ¥ï¼šæ¬„ä½æ˜¯å¦å·²å®šç¾©æ–¼ Annotation
        if not self.annotation.is_column_annotated(col):
            unannotated.append(col)
        else:
            # ã€æ–°å¢ã€‘E409 æª¢æŸ¥ï¼šé©—è­‰æ¨™é ­ç‚º snake_caseï¼ˆé˜²ç¯„ Parser æœªæ­£ç¢ºæ­£è¦åŒ–ï¼‰
            if not self._is_snake_case(col):
                non_standardized.append(col)

    # è™•ç†æœªå®šç¾©æ¬„ä½
    if unannotated:
        policy = self.config.unannotated_column_policy
        if policy == &quot;error&quot;:
            raise DataValidationError(
                f&quot;E402: ä»¥ä¸‹æ¬„ä½æœªå®šç¾©æ–¼ Feature Annotation: {unannotated}&quot;
            )
        elif policy == &quot;skip&quot;:
            self.logger.warning(f&quot;E402 (Skip): è·³éæœªå®šç¾©æ¬„ä½: {unannotated}&quot;)
            self._skipped_columns = set(unannotated)
        elif policy == &quot;warn&quot;:
            self.logger.warning(f&quot;E402 (Warn): æœªå®šç¾©æ¬„ä½ä½¿ç”¨ä¿å®ˆé è¨­: {unannotated}&quot;)

    # ã€æ–°å¢ã€‘è™•ç†éæ­£è¦åŒ–æ¨™é ­ï¼ˆè­¦å‘Šå±¤ç´šï¼Œä¸é˜»æ“‹æµç¨‹ï¼‰
    if non_standardized:
        self.logger.warning(
            f&quot;E409-Warning: ä»¥ä¸‹æ¬„ä½æœªä½¿ç”¨ snake_caseï¼Œå¯èƒ½æœªç¶“ Parser æ­£è¦åŒ–: {non_standardized}&quot;
        )

    return df

def _is_snake_case(self, s: str) -&gt; bool:
    &quot;&quot;&quot;æª¢æŸ¥å­—ä¸²æ˜¯å¦ç¬¦åˆ snake_case è¦ç¯„&quot;&quot;&quot;
    import re
    return bool(re.match(r'^[a-z][a-z0-9_]*$', s))
</code></pre>
<hr />
<h3 id="phase-1-day-2">Phase 1: æ™‚é–“æ¨™æº–åŒ–èˆ‡åŸºæº–ä¸€è‡´æ€§ (Day 2)</h3>
<h4 id="step-11-temporal-baseline">Step 1.1: æ™‚é–“æˆ³æ¨™æº–åŒ–ï¼ˆå¼·åŒ– Temporal Baselineï¼‰</h4>
<pre><code class="language-python">def _normalize_timestamp(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    Step 1: æ™‚é–“æˆ³æ¨™æº–åŒ– (E101 è™•ç†)

    ã€é—œéµè®Šæ›´ã€‘ï¼šä¸å†å‘¼å« datetime.now()ï¼Œæ‰€æœ‰æ™‚é–“æª¢æŸ¥ä½¿ç”¨ self.pipeline_origin_timestamp
    &quot;&quot;&quot;
    if &quot;timestamp&quot; not in df.columns:
        raise DataValidationError(&quot;è¼¸å…¥è³‡æ–™ç¼ºå°‘å¿…è¦æ¬„ä½ 'timestamp'&quot;)

    ts_col = df[&quot;timestamp&quot;]

    # æª¢æŸ¥é¡å‹
    if not isinstance(ts_col.dtype, pl.Datetime):
        raise DataValidationError(f&quot;timestamp æ¬„ä½é¡å‹éŒ¯èª¤: {ts_col.dtype}&quot;)

    # æ™‚å€è™•ç†ï¼ˆç¶­æŒä¸è®Šï¼‰
    current_tz = ts_col.dtype.time_zone
    if current_tz is None:
        self.logger.warning(&quot;timestamp ç„¡æ™‚å€è³‡è¨Šï¼Œå‡è¨­ç‚º UTC&quot;)
        df = df.with_columns(
            pl.col(&quot;timestamp&quot;).dt.replace_time_zone(&quot;UTC&quot;).alias(&quot;timestamp&quot;)
        )
    elif current_tz != &quot;UTC&quot;:
        self.logger.warning(f&quot;E101: åµæ¸¬åˆ°é UTC æ™‚å€ {current_tz}ï¼Œè‡ªå‹•è½‰æ›&quot;)
        df = df.with_columns(
            pl.col(&quot;timestamp&quot;).dt.convert_time_zone(&quot;UTC&quot;).alias(&quot;timestamp&quot;)
        )

    # ç¢ºä¿ç²¾åº¦ç‚º nanosecond
    if ts_col.dtype.time_unit != &quot;ns&quot;:
        df = df.with_columns(
            pl.col(&quot;timestamp&quot;).cast(pl.Datetime(time_unit=&quot;ns&quot;, time_zone=&quot;UTC&quot;))
        )

    return df
</code></pre>
<h4 id="step-12-temporal-baseline">Step 1.2: æœªä¾†è³‡æ–™æª¢æŸ¥ï¼ˆå¼·åˆ¶ä½¿ç”¨ Temporal Baselineï¼‰</h4>
<pre><code class="language-python">def _check_future_data(self, df: pl.DataFrame) -&gt; None:
    &quot;&quot;&quot;
    Step 2: æœªä¾†è³‡æ–™æª¢æŸ¥ (E102)

    ã€é—œéµè®Šæ›´ã€‘ï¼šä½¿ç”¨ self.pipeline_origin_timestamp è€Œé datetime.now()
    å°é½Š Interface Contract v1.1 è¦æ±‚ï¼Œé˜²æ­¢æ™‚é–“æ¼‚ç§»
    &quot;&quot;&quot;
    # ã€å¼·åˆ¶ã€‘ä½¿ç”¨å‚³å…¥çš„æ™‚é–“åŸºæº–ï¼Œç¦æ­¢å‹•æ…‹å–å¾—æ™‚é–“
    threshold = self.pipeline_origin_timestamp + timedelta(minutes=5)

    future_mask = df[&quot;timestamp&quot;] &gt; threshold
    future_count = future_mask.sum()

    if future_count &gt; 0:
        future_samples = df.filter(future_mask)[&quot;timestamp&quot;].head(3).to_list()
        raise DataValidationError(
            f&quot;E102: åµæ¸¬åˆ° {future_count} ç­†æœªä¾†è³‡æ–™ï¼ˆ&gt;{threshold.isoformat()}ï¼‰ã€‚&quot;
            f&quot;æ¨£æœ¬: {future_samples}ã€‚ &quot;
            f&quot;Pipeline æ™‚é–“åŸºæº–: {self.pipeline_origin_timestamp.isoformat()}ã€‚ &quot;
            f&quot;è«‹æª¢æŸ¥è³‡æ–™ä¾†æºæ™‚é˜æˆ–æ™‚é–“åŸºæº–å‚³éã€‚&quot;
        )

    self.logger.debug(f&quot;æœªä¾†è³‡æ–™æª¢æŸ¥é€šéï¼ˆåŸºæº–: {self.pipeline_origin_timestamp.isoformat()}ï¼‰&quot;)
</code></pre>
<hr />
<h3 id="phase-2-day-3-4">Phase 2: èªæ„æ„ŸçŸ¥æ¸…æ´—èˆ‡è¨­å‚™é‚è¼¯é æª¢ (Day 3-4)</h3>
<h4 id="step-21">Step 2.1: èªæ„æ„ŸçŸ¥æ¸…æ´—ï¼ˆç¶­æŒä¸¦å¼·åŒ–ï¼‰</h4>
<pre><code class="language-python">def _semantic_aware_cleaning(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    èªæ„æ„ŸçŸ¥æ¸…æ´—ä¸»æµç¨‹ï¼ˆè®€å– device_roleï¼Œä½†çµ•ä¸å¯«å…¥è¼¸å‡ºï¼‰

    ç¶­æŒ v2.2 åŸæœ‰é‚è¼¯ï¼š
    - å‡çµè³‡æ–™åµæ¸¬ï¼ˆè§’è‰²æ„ŸçŸ¥é–¾å€¼ï¼‰
    - é›¶å€¼æ¯”ä¾‹æª¢æŸ¥ï¼ˆè§’è‰²æ„ŸçŸ¥è­¦å‘ŠæŠ‘åˆ¶ï¼‰
    - ç‰©ç†é™åˆ¶æª¢æŸ¥
    &quot;&quot;&quot;
    if not self.annotation:
        self.logger.debug(&quot;æœªå•Ÿç”¨ Annotation æ•´åˆï¼Œè·³éèªæ„æ„ŸçŸ¥æ¸…æ´—&quot;)
        return df

    self.logger.info(&quot;å•Ÿå‹•èªæ„æ„ŸçŸ¥æ¸…æ´—ï¼ˆdevice_role æ„ŸçŸ¥ï¼Œè¼¸å‡ºéš”é›¢ï¼‰...&quot;)

    # 1. å‡çµè³‡æ–™åµæ¸¬ï¼ˆè§’è‰²æ„ŸçŸ¥é–¾å€¼ï¼‰
    df = self._detect_frozen_data_semantic(df)

    # 2. é›¶å€¼æ¯”ä¾‹æª¢æŸ¥ï¼ˆè§’è‰²æ„ŸçŸ¥è­¦å‘ŠæŠ‘åˆ¶ï¼‰
    df = self._check_zero_ratio_semantic(df)

    # 3. ç‰©ç†é™åˆ¶æª¢æŸ¥
    df = self._apply_physical_constraints_semantic(df)

    return df
</code></pre>
<h4 id="step-22">Step 2.2: è¨­å‚™é‚è¼¯é æª¢ï¼ˆæ–°å¢æ ¸å¿ƒåŠŸèƒ½ï¼‰</h4>
<pre><code class="language-python">def _apply_equipment_validation_precheck(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    ã€æ–°å¢ã€‘è¨­å‚™é‚è¼¯é æª¢ï¼ˆå°é½Š Interface Contract v1.1 æª¢æŸ¥é» #2ï¼‰

    åœ¨èªæ„æ„ŸçŸ¥æ¸…æ´—å¾ŒåŸ·è¡Œï¼Œæª¢æŸ¥åŸºç¤è¨­å‚™é‚è¼¯é•è¦ï¼š
    - ä¸»æ©Ÿé–‹å•Ÿæ™‚æ°´æ³µä¸å¯å…¨é—œï¼ˆchiller_pump_mutexï¼‰
    - ä¸»æ©Ÿé–‹å•Ÿæ™‚å†·å»æ°´å¡”ä¸å¯å…¨é—œï¼ˆchiller_cooling_tower_mutexï¼‰

    é•è¦è³‡æ–™æ¨™è¨˜ç‚º PHYSICAL_IMPOSSIBLE æˆ– EQUIPMENT_VIOLATION
    &quot;&quot;&quot;
    if not self.config.enforce_equipment_validation_sync:
        self._equipment_validation_audit = {
            &quot;validation_enabled&quot;: False,
            &quot;constraints_applied&quot;: [],
            &quot;violations_detected&quot;: 0,
            &quot;violation_details&quot;: []
        }
        return df

    self.logger.info(&quot;åŸ·è¡Œè¨­å‚™é‚è¼¯é æª¢ï¼ˆEquipment Validation Precheckï¼‰...&quot;)

    violations = []
    df_result = df

    # å¾ SSOT è¼‰å…¥é æª¢è¦å‰‡ï¼ˆèˆ‡ Optimization å…±ç”¨ï¼‰
    from src.etl.config_models import EQUIPMENT_VALIDATION_CONSTRAINTS

    for constraint_id, constraint in EQUIPMENT_VALIDATION_CONSTRAINTS.items():
        # åªè™•ç†é æª¢é¡å‹ï¼ˆprecheckï¼‰
        if constraint.get(&quot;check_phase&quot;) != &quot;precheck&quot;:
            continue

        # æª¢æŸ¥å¿…è¦æ¬„ä½æ˜¯å¦å­˜åœ¨
        trigger_cols = [c for c in constraint.get(&quot;trigger_status&quot;, []) if c in df.columns]
        required_cols = [c for c in constraint.get(&quot;required_status&quot;, []) if c in df.columns]

        if not trigger_cols or not required_cols:
            continue

        # å»ºç«‹é‚è¼¯æ¢ä»¶ï¼ˆPolars è¡¨é”å¼ï¼‰
        trigger_condition = pl.col(trigger_cols[0]) == 1
        for col in trigger_cols[1:]:
            trigger_condition = trigger_condition | (pl.col(col) == 1)

        required_condition = pl.col(required_cols[0]) == 1
        for col in required_cols[1:]:
            required_condition = required_condition | (pl.col(col) == 1)

        # é•è¦æ¢ä»¶ï¼šè§¸ç™¼ä½†éœ€æ±‚ä¸æ»¿è¶³
        violation_condition = trigger_condition &amp; ~required_condition

        # è¨ˆç®—é•è¦æ•¸
        violation_count = df.filter(violation_condition).height

        if violation_count &gt; 0:
            severity = constraint.get(&quot;severity&quot;, &quot;warning&quot;)
            flag = &quot;PHYSICAL_IMPOSSIBLE&quot; if severity == &quot;critical&quot; else &quot;EQUIPMENT_VIOLATION&quot;

            violations.append({
                &quot;constraint_id&quot;: constraint_id,
                &quot;description&quot;: constraint.get(&quot;description&quot;, &quot;&quot;),
                &quot;count&quot;: violation_count,
                &quot;severity&quot;: severity,
                &quot;timestamp&quot;: datetime.now(timezone.utc).isoformat()
            })

            # æ¨™è¨˜ Quality Flag
            df_result = df_result.with_columns(
                pl.when(violation_condition).then(
                    pl.col(&quot;quality_flags&quot;).list.concat(pl.lit([flag]))
                ).otherwise(pl.col(&quot;quality_flags&quot;)).alias(&quot;quality_flags&quot;)
            )

            self.logger.warning(
                f&quot;E350: è¨­å‚™é‚è¼¯é•è¦ '{constraint_id}' ç™¼ç”Ÿ {violation_count} ç­†ï¼Œ&quot;
                f&quot;æ¨™è¨˜ç‚º {flag}&quot;
            )

    # è¨˜éŒ„ç¨½æ ¸è»Œè·¡ï¼ˆä¾› BatchProcessor å¯«å…¥ Manifestï¼‰
    self._equipment_validation_audit = {
        &quot;validation_enabled&quot;: True,
        &quot;constraints_applied&quot;: list(EQUIPMENT_VALIDATION_CONSTRAINTS.keys()),
        &quot;violations_detected&quot;: sum(v[&quot;count&quot;] for v in violations),
        &quot;violation_details&quot;: violations,
        &quot;precheck_timestamp&quot;: datetime.now(timezone.utc).isoformat()
    }

    return df_result
</code></pre>
<hr />
<h3 id="phase-3-day-5">Phase 3: é‡æ¡æ¨£èˆ‡è¼¸å‡ºå¥‘ç´„å¼·åˆ¶åŸ·è¡Œ (Day 5)</h3>
<h4 id="step-31">Step 3.1: é‡æ¡æ¨£ï¼ˆç¶­æŒä¸è®Šï¼‰</h4>
<pre><code class="language-python">def _resample_and_fill(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;Step 3: é‡æ¡æ¨£èˆ‡ç¼ºæ¼è™•ç†ï¼ˆç¶­æŒ v2.2 åŸæœ‰é‚è¼¯ï¼‰&quot;&quot;&quot;
    # ... åŸæœ‰å¯¦ä½œ ...
    return df
</code></pre>
<h4 id="step-32-metadata-equipment-audit">Step 3.2: Metadata å¼·åˆ¶æ·¨åŒ–ï¼ˆæ›´æ–°åŒ…å« Equipment Auditï¼‰</h4>
<pre><code class="language-python">def _build_column_metadata(self, df: pl.DataFrame) -&gt; Tuple[Dict[str, Dict], Dict]:
    &quot;&quot;&quot;
    Step 7: å»ºæ§‹æ¬„ä½å…ƒè³‡æ–™èˆ‡è¨­å‚™ç¨½æ ¸è»Œè·¡

    Returns:
        (column_metadata, equipment_validation_audit)
    &quot;&quot;&quot;
    metadata: Dict[str, Dict[str, Any]] = {}

    for col in df.columns:
        if col == &quot;timestamp&quot;:
            continue

        raw_meta = self._extract_raw_metadata(col)
        sanitized_meta = self._sanitize_metadata_dict(raw_meta, col)
        metadata[col] = sanitized_meta

    # å–å¾—è¨­å‚™é‚è¼¯ç¨½æ ¸è»Œè·¡ï¼ˆç”± Step 2.2 ç”¢ç”Ÿï¼‰
    audit = getattr(self, '_equipment_validation_audit', {
        &quot;validation_enabled&quot;: False,
        &quot;constraints_applied&quot;: [],
        &quot;violations_detected&quot;: 0,
        &quot;violation_details&quot;: []
    })

    return metadata, audit
</code></pre>
<h4 id="step-33-schema">Step 3.3: Schema å¼·åˆ¶æ·¨åŒ–èˆ‡æ™‚é–“åŸºæº–å‚³é</h4>
<pre><code class="language-python">def _validate_output_contract(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    Step 6: æœ€çµ‚è¼¸å‡ºé©—è­‰èˆ‡å¼·åˆ¶æ·¨åŒ– (Interface Contract Enforcement)

    ã€æ›´æ–°ã€‘ï¼š
    1. é©—è­‰æ™‚é–“åŸºæº–å‚³éï¼ˆE000ï¼‰
    2. é©—è­‰æœªä¾†è³‡æ–™é˜²è­·ï¼ˆE102ï¼‰
    3. å¼·åˆ¶åŸ·è¡Œ Schema æ·¨åŒ–ï¼ˆç§»é™¤ FORBIDDEN_COLSï¼‰
    4. é©—è­‰ device_role ä¸å­˜åœ¨ï¼ˆE500ï¼‰
    &quot;&quot;&quot;
    errors = []

    # 1. æ™‚é–“æˆ³æª¢æŸ¥
    if &quot;timestamp&quot; not in df.columns:
        errors.append(&quot;ç¼ºå°‘å¿…è¦æ¬„ä½ 'timestamp'&quot;)

    # 2. ã€é—œéµã€‘æ™‚é–“åŸºæº–å‚³éæª¢æŸ¥
    if not hasattr(self, 'pipeline_origin_timestamp'):
        errors.append(&quot;E000: éºå¤± pipeline_origin_timestampï¼Œç„¡æ³•å‚³éæ™‚é–“åŸºæº–&quot;)

    # 3. quality_flags æª¢æŸ¥
    if &quot;quality_flags&quot; not in df.columns:
        errors.append(&quot;ç¼ºå°‘å¿…è¦æ¬„ä½ 'quality_flags'&quot;)

    # 4. ã€å¼·åˆ¶åŸ·è¡Œã€‘Schema æ·¨åŒ–
    df = self._enforce_schema_sanitization(df)

    # 5. ã€å¼·åˆ¶åŸ·è¡Œã€‘device_role ä¸å­˜åœ¨æª¢æŸ¥ï¼ˆE500ï¼‰
    for forbidden_col in self.FORBIDDEN_COLS:
        if forbidden_col in df.columns:
            errors.append(f&quot;E500: è¼¸å‡ºåŒ…å«ç¦æ­¢æ¬„ä½ '{forbidden_col}'&quot;)

    # 6. æœªä¾†è³‡æ–™äºŒæ¬¡ç¢ºèªï¼ˆä½¿ç”¨ Temporal Baselineï¼‰
    if hasattr(self, 'pipeline_origin_timestamp'):
        threshold = self.pipeline_origin_timestamp + timedelta(minutes=5)
        if (df[&quot;timestamp&quot;] &gt; threshold).any():
            errors.append(&quot;E102: è¼¸å‡ºä»åŒ…å«æœªä¾†è³‡æ–™ï¼ˆæ™‚åºé˜²è­·å¤±æ•ˆï¼‰&quot;)

    if errors:
        raise ContractViolationError(f&quot;Cleaner è¼¸å‡ºå¥‘ç´„é©—è­‰å¤±æ•—: {errors}&quot;)

    return df
</code></pre>
<hr />
<h2 id="5-call-chain-updated">5. å®Œæ•´æ–¹æ³•å‘¼å«éˆ (Call Chain - Updated)</h2>
<pre><code>clean(df: pl.DataFrame, input_metadata: Dict) -&gt; Tuple[pl.DataFrame, Dict, Dict]
  â”œâ”€â”€ _validate_temporal_baseline(input_metadata)      # ã€æ–°å¢ã€‘E000 æª¢æŸ¥
  â”œâ”€â”€ _validate_columns_annotated(df)                  # Step 0: E402, E409 æª¢æŸ¥
  â”œâ”€â”€ _normalize_timestamp(df)                         # Step 1: æ™‚å€æ¨™æº–åŒ– (UTC)
  â”œâ”€â”€ _check_future_data(df)                           # Step 2: æœªä¾†è³‡æ–™æª¢æŸ¥ (E102)
  â”‚   â””â”€â”€ ä½¿ç”¨ self.pipeline_origin_timestampï¼ˆé now()ï¼‰
  â”œâ”€â”€ _semantic_aware_cleaning(df)                     # Step 3: èªæ„æ„ŸçŸ¥æ¸…æ´—
  â”‚   â”œâ”€â”€ _detect_frozen_data_semantic()               # è§’è‰²æ„ŸçŸ¥é–¾å€¼
  â”‚   â”œâ”€â”€ _check_zero_ratio_semantic()                 # æŠ‘åˆ¶è­¦å‘Š
  â”‚   â””â”€â”€ _apply_physical_constraints_semantic()       # ç‰©ç†é™åˆ¶
  â”œâ”€â”€ _apply_equipment_validation_precheck(df)         # ã€æ–°å¢ã€‘Step 3.5: è¨­å‚™é‚è¼¯é æª¢ (E350)
  â”‚   â””â”€â”€ ç”¢ç”Ÿ self._equipment_validation_audit
  â”œâ”€â”€ _resample_and_fill(df)                           # Step 4: é‡æ¡æ¨£
  â”œâ”€â”€ _validate_quality_flags(df)                      # Step 5: Flags åˆæ³•æ€§ (E103)
  â”œâ”€â”€ _validate_output_contract(df)                    # Step 6: å¼·åˆ¶åŸ·è¡Œ Schemaæ·¨åŒ–
  â”‚   â””â”€â”€ _enforce_schema_sanitization()               # ç§»é™¤ FORBIDDEN_COLS
  â”œâ”€â”€ _build_column_metadata(df)                       # Step 7: ç™½åå–®éæ¿¾ + Audit
  â”‚   â”œâ”€â”€ _sanitize_metadata_dict()                    # ç§»é™¤éç™½åå–®éµ
  â”‚   â””â”€â”€ å›å‚³ (metadata, equipment_validation_audit)
  â””â”€â”€ return (clean_df, metadata, equipment_validation_audit)
</code></pre>
<hr />
<h2 id="6-error-codes-updated">6. éŒ¯èª¤ä»£ç¢¼å°ç…§è¡¨ (Error Codes - Updated)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤ä»£ç¢¼</th>
<th style="text-align: left;">åç¨±</th>
<th style="text-align: center;">ç™¼ç”Ÿéšæ®µ</th>
<th style="text-align: left;">èªªæ˜</th>
<th style="text-align: left;">è™•ç†å»ºè­°</th>
<th style="text-align: center;">åš´é‡åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>E000</strong></td>
<td style="text-align: left;"><code>TEMPORAL_BASELINE_MISSING</code></td>
<td style="text-align: center;">Step 0</td>
<td style="text-align: left;">æœªæ¥æ”¶ pipeline_origin_timestamp</td>
<td style="text-align: left;">æª¢æŸ¥ Container å‚³éé‚è¼¯</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E101</strong></td>
<td style="text-align: left;"><code>TIMEZONE_MISMATCH</code></td>
<td style="text-align: center;">Step 1</td>
<td style="text-align: left;">æ™‚å€é UTC</td>
<td style="text-align: left;">ç¢ºèª Parser ç‰ˆæœ¬</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E102</strong></td>
<td style="text-align: left;"><code>FUTURE_DATA_DETECTED</code></td>
<td style="text-align: center;">Step 2</td>
<td style="text-align: left;">è³‡æ–™æ™‚é–“è¶…éåŸºæº–+5åˆ†é˜</td>
<td style="text-align: left;">æª¢æŸ¥è³‡æ–™ä¾†æºæ™‚é˜</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E103</strong></td>
<td style="text-align: left;"><code>UNKNOWN_QUALITY_FLAG</code></td>
<td style="text-align: center;">Step 5</td>
<td style="text-align: left;">éæ³•å“è³ªæ¨™è¨˜</td>
<td style="text-align: left;">åŒæ­¥ SSOT</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E105</strong></td>
<td style="text-align: left;"><code>HEADER_NON_STANDARDIZED</code></td>
<td style="text-align: center;">Step 0</td>
<td style="text-align: left;">æ¨™é ­æœªæ­£è¦åŒ–ï¼ˆè­¦å‘Šï¼‰</td>
<td style="text-align: left;">ç¢ºèª Parser è¨­å®š</td>
<td style="text-align: center;">ğŸŸ¢ Low</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E402</strong></td>
<td style="text-align: left;"><code>UNANNOTATED_COLUMN</code></td>
<td style="text-align: center;">Step 0</td>
<td style="text-align: left;">æ¬„ä½æœªå®šç¾©æ–¼ Annotation</td>
<td style="text-align: left;">åŸ·è¡Œ features wizard</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E409</strong></td>
<td style="text-align: left;"><code>HEADER_ANNOTATION_MISMATCH</code></td>
<td style="text-align: center;">Step 0</td>
<td style="text-align: left;">æ¨™é ­èˆ‡ Annotation ä¸åŒ¹é…</td>
<td style="text-align: left;">æª¢æŸ¥ Excel æ¨™è¨»</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E350</strong></td>
<td style="text-align: left;"><code>EQUIPMENT_LOGIC_PRECHECK_FAILED</code></td>
<td style="text-align: center;">Step 3.5</td>
<td style="text-align: left;">è¨­å‚™é‚è¼¯é æª¢ç™¼ç¾é•è¦</td>
<td style="text-align: left;">æª¢æŸ¥è¨­å‚™ç‹€æ…‹è³‡æ–™</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E500</strong></td>
<td style="text-align: left;"><code>DEVICE_ROLE_LEAKAGE</code></td>
<td style="text-align: center;">Step 6</td>
<td style="text-align: left;">è¼¸å‡ºåŒ…å« device_role</td>
<td style="text-align: left;">æª¢æŸ¥è·è²¬åˆ†é›¢é‚è¼¯</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E501</strong></td>
<td style="text-align: left;"><code>METADATA_WHITELIST_VIOLATION</code></td>
<td style="text-align: center;">Step 7</td>
<td style="text-align: left;">Metadata åŒ…å«ç¦æ­¢éµ</td>
<td style="text-align: left;">æª¢æŸ¥ç™½åå–®æ©Ÿåˆ¶</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-test-plan-updated">7. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Test Plan - Updated)</h2>
<h3 id="71-unit-tests">7.1 å–®å…ƒæ¸¬è©¦ (Unit Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸçµæœ</th>
<th style="text-align: center;">CI/CD å±¬æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">C22-TB-01</td>
<td style="text-align: left;">æ™‚é–“åŸºæº–éºå¤±</td>
<td style="text-align: left;">ç„¡ temporal_context</td>
<td style="text-align: left;">æ‹‹å‡º E000</td>
<td style="text-align: center;">ğŸ”´ Blocker</td>
</tr>
<tr>
<td style="text-align: left;">C22-TB-02</td>
<td style="text-align: left;">æœªä¾†è³‡æ–™æª¢æŸ¥ï¼ˆä½¿ç”¨åŸºæº–ï¼‰</td>
<td style="text-align: left;">è³‡æ–™æ™‚é–“ &gt; åŸºæº–+5min</td>
<td style="text-align: left;">æ‹‹å‡º E102</td>
<td style="text-align: center;">ğŸ”´ Blocker</td>
</tr>
<tr>
<td style="text-align: left;">C22-TB-03</td>
<td style="text-align: left;">é•·æ™‚é–“åŸ·è¡Œæ¼‚ç§»æª¢æ¸¬</td>
<td style="text-align: left;">æ¨¡æ“¬åŸºæº–æ™‚é–“éèˆŠ</td>
<td style="text-align: left;">è¨˜éŒ„è­¦å‘Š</td>
<td style="text-align: center;">ğŸŸ¡ Standard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>C22-EV-01</strong></td>
<td style="text-align: left;">è¨­å‚™é‚è¼¯é æª¢é€šé</td>
<td style="text-align: left;">ä¸»æ©Ÿé–‹+æ°´æ³µé–‹</td>
<td style="text-align: left;">ç„¡é•è¦æ¨™è¨˜</td>
<td style="text-align: center;">ğŸ”´ Blocker</td>
</tr>
<tr>
<td style="text-align: left;"><strong>C22-EV-02</strong></td>
<td style="text-align: left;">è¨­å‚™é‚è¼¯é•è¦æª¢æ¸¬</td>
<td style="text-align: left;">ä¸»æ©Ÿé–‹+æ°´æ³µå…¨é—œ</td>
<td style="text-align: left;">æ¨™è¨˜ PHYSICAL_IMPOSSIBLE</td>
<td style="text-align: center;">ğŸ”´ Blocker</td>
</tr>
<tr>
<td style="text-align: left;"><strong>C22-EV-03</strong></td>
<td style="text-align: left;">è¨­å‚™ç¨½æ ¸è»Œè·¡ç”¢ç”Ÿ</td>
<td style="text-align: left;">å•Ÿç”¨é æª¢</td>
<td style="text-align: left;">Audit çµæ§‹æ­£ç¢º</td>
<td style="text-align: center;">ğŸ”´ Blocker</td>
</tr>
<tr>
<td style="text-align: left;">C22-FA-05</td>
<td style="text-align: left;">è·è²¬åˆ†é›¢ Gate Test</td>
<td style="text-align: left;">è¼¸å‡ºå« device_role</td>
<td style="text-align: left;">æ‹‹å‡º E500</td>
<td style="text-align: center;">ğŸ”´ Blocker</td>
</tr>
<tr>
<td style="text-align: left;">C22-FA-06</td>
<td style="text-align: left;">Metadata Gate Test</td>
<td style="text-align: left;">è¼¸å‡ºå«ç¦æ­¢éµ</td>
<td style="text-align: left;">è‡ªå‹•ç§»é™¤ä¸¦è­¦å‘Š</td>
<td style="text-align: center;">ğŸ”´ Blocker</td>
</tr>
</tbody>
</table>
<h3 id="72-integration-tests">7.2 æ•´åˆæ¸¬è©¦ (Integration Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: center;">ä¸Šæ¸¸</th>
<th style="text-align: center;">ä¸‹æ¸¸</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>INT-C-EV-01</strong></td>
<td style="text-align: left;">è¨­å‚™é‚è¼¯åŒæ­¥æµç¨‹</td>
<td style="text-align: center;">Cleaner (å•Ÿç”¨é æª¢)</td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">Manifest åŒ…å« equipment_validation_audit</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-C-EV-02</strong></td>
<td style="text-align: left;">èˆ‡ Optimization é™åˆ¶ä¸€è‡´æ€§</td>
<td style="text-align: center;">Cleaner é æª¢é‚è¼¯</td>
<td style="text-align: center;">Optimization é™åˆ¶</td>
<td style="text-align: left;">å…©è€…ä½¿ç”¨ç›¸åŒ SSOT é™åˆ¶æ¢ä»¶</td>
</tr>
<tr>
<td style="text-align: left;">INT-C-TB-01</td>
<td style="text-align: left;">æ™‚é–“åŸºæº–å‚³é</td>
<td style="text-align: center;">Parser (å¸¶åŸºæº–)</td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">æ­£ç¢ºæ¥æ”¶ä¸¦å‚³éï¼Œç„¡ now() å‘¼å«</td>
</tr>
<tr>
<td style="text-align: left;">INT-C-TB-02</td>
<td style="text-align: left;">è·¨æ—¥åŸ·è¡Œæ™‚é–“ä¸€è‡´æ€§</td>
<td style="text-align: center;">æ¨¡æ“¬è·¨æ—¥è³‡æ–™</td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">ä½¿ç”¨å›ºå®šåŸºæº–ï¼Œç„¡è·¨æ—¥éŒ¯èª¤</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-risk-assessment-updated">8. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£ (Risk Assessment - Updated)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢¨éšª</th>
<th style="text-align: center;">åš´é‡åº¦</th>
<th style="text-align: center;">å¯èƒ½æ€§</th>
<th style="text-align: left;">ç·©è§£æªæ–½</th>
<th style="text-align: center;">ç‹€æ…‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>æ™‚é–“æ¼‚ç§»</strong> (ä½¿ç”¨ now() è€ŒéåŸºæº–)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">å»ºæ§‹å­å¼·åˆ¶æª¢æŸ¥ temporal_contextï¼Œé•åæ‹‹ E000</td>
<td style="text-align: center;">å·²å¼·åŒ–</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è¨­å‚™é‚è¼¯è„«é‰¤</strong> (æ¸…æ´—èˆ‡å„ªåŒ–ä¸ä¸€è‡´)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">å…±ç”¨ EQUIPMENT_VALIDATION_CONSTRAINTS (SSOT)</td>
<td style="text-align: center;">å·²æ–°å¢</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è·è²¬é‚Šç•Œæ··æ·†</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">ä¸‰å±¤é˜²è­·ï¼šç™½åå–®+Schemaæ·¨åŒ–+CI Gate</td>
<td style="text-align: center;">ç¶­æŒ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ¨™é ­ä¸åŒ¹é…</strong> (Parser-Cleaner-Annotation)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">E409 æª¢æŸ¥ï¼Œé©—è­‰ snake_case èˆ‡ Annotation åŒ¹é…</td>
<td style="text-align: center;">å·²æ–°å¢</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9-deliverables-updated">9. äº¤ä»˜ç‰©æ¸…å–® (Deliverables - Updated)</h2>
<h3 id="91">9.1 ç¨‹å¼ç¢¼æª”æ¡ˆ</h3>
<ol>
<li><code>src/etl/cleaner.py</code> - ä¸»è¦å¯¦ä½œ (v2.2-Contract-Aligned)</li>
<li><code>src/etl/config_models.py</code> - æ“´å……ï¼ˆæ–°å¢ <code>EQUIPMENT_VALIDATION_CONSTRAINTS</code>ï¼‰</li>
<li><code>src/core/temporal_baseline.py</code> - æ™‚é–“åŸºæº–é¡åˆ¥ï¼ˆè‹¥å°šæœªå­˜åœ¨ï¼‰</li>
</ol>
<h3 id="92">9.2 æ¸¬è©¦æª”æ¡ˆ</h3>
<ol start="4">
<li><code>tests/test_cleaner_v22_contract_aligned.py</code> - ä¸»è¦æ¸¬è©¦ï¼ˆå«æ™‚é–“åŸºæº–ã€è¨­å‚™é æª¢ï¼‰</li>
<li><code>tests/test_cleaner_equipment_validation.py</code> - ã€æ–°å¢ã€‘è¨­å‚™é‚è¼¯é æª¢æ¸¬è©¦</li>
<li><code>tests/test_cleaner_temporal_baseline.py</code> - ã€æ–°å¢ã€‘æ™‚é–“åŸºæº–ä¸€è‡´æ€§æ¸¬è©¦</li>
</ol>
<h3 id="93">9.3 æ–‡ä»¶æª”æ¡ˆ</h3>
<ol start="7">
<li><code>docs/cleaner/PRD_CLEANER_v2.2-Contract-Aligned.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/cleaner/MIGRATION_v22_to_Contract_Aligned.md</code> - å‡ç´šæŒ‡å¼•</li>
</ol>
<hr />
<h2 id="10-sign-off-checklist-updated">10. é©—æ”¶ç°½æ ¸ (Sign-off Checklist - Updated)</h2>
<ul>
<li>[ ] <strong>æ™‚é–“åŸºæº–å¼·åˆ¶ä½¿ç”¨ (E000)</strong>ï¼šæœªæ¥æ”¶ temporal_context æ™‚æ­£ç¢ºæ‹‹å‡º E000</li>
<li>[ ] <strong>æœªä¾†è³‡æ–™æª¢æŸ¥ (E102)</strong>ï¼šä½¿ç”¨ pipeline_origin_timestamp è€Œé now()ï¼Œè·¨æ—¥åŸ·è¡Œæ¸¬è©¦é€šé</li>
<li>[ ] <strong>è¨­å‚™é‚è¼¯é æª¢ (E350)</strong>ï¼šæ­£ç¢ºæª¢æ¸¬ä¸»æ©Ÿé–‹å•Ÿæ™‚æ°´æ³µå…¨é—œç­‰é•è¦ï¼Œæ¨™è¨˜ PHYSICAL_IMPOSSIBLE</li>
<li>[ ] <strong>è¨­å‚™ç¨½æ ¸è»Œè·¡</strong>ï¼šè¼¸å‡ºåŒ…å« equipment_validation_audit çµæ§‹ï¼Œä¾› BatchProcessor å¯«å…¥ Manifest</li>
<li>[ ] <strong>SSOT ä¸€è‡´æ€§</strong>ï¼šèˆ‡ Optimization å…±ç”¨ EQUIPMENT_VALIDATION_CONSTRAINTSï¼Œé‚è¼¯ä¸€è‡´</li>
<li>[ ] <strong>è·è²¬åˆ†é›¢ (E500)</strong>ï¼šè¼¸å‡ºçµ•å°ä¸å« device_roleï¼Œä¸‰å±¤é˜²è­·æ©Ÿåˆ¶é‹ä½œæ­£å¸¸</li>
<li>[ ] <strong>æ¨™é ­å°æ‡‰ (E409)</strong>ï¼šé©—è­‰ Parser æ­£è¦åŒ–å¾Œçš„æ¨™é ­èˆ‡ Annotation åŒ¹é…</li>
<li>[ ] <strong>Interface Contract v1.1 å°é½Š</strong>ï¼šæª¢æŸ¥é» #2 æ‰€æœ‰é …ç›®é€šéé©—è­‰</li>
</ul>
<hr />
<p><strong>é‡è¦æé†’</strong>ï¼šæœ¬ç‰ˆæœ¬å·²å°‡ <strong>Temporal Baseline</strong> èˆ‡ <strong>Equipment Validation Sync</strong> æå‡ç‚ºå¼·åˆ¶è¦æ±‚ï¼Œèˆ‡ Interface Contract v1.1 å®Œå…¨å°é½Šã€‚ä»»ä½•æ™‚é–“ç›¸é—œæª¢æŸ¥å¿…é ˆä½¿ç”¨å‚³å…¥çš„æ™‚é–“åŸºæº–ï¼Œç¦æ­¢å‹•æ…‹å–å¾—ç³»çµ±æ™‚é–“ã€‚</p>
<p><strong>æ–‡ä»¶çµæŸ</strong><br />
```</p>
</body>
</html>