
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PRD_CLEANER_v2.2</title>
    
<style>
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
        line-height: 1.6; 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        color: #24292e; 
        background-color: #ffffff;
    }
    h1, h2, h3, h4, h5, h6 { 
        margin-top: 24px; 
        margin-bottom: 16px; 
        font-weight: 600; 
        color: #24292e;
    }
    h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h3 { font-size: 1.25em; }
    p { margin-top: 0; margin-bottom: 16px; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { 
        display: block; 
        width: 100%; 
        overflow: auto; 
        border-spacing: 0; 
        border-collapse: collapse; 
        margin-bottom: 16px; 
    }
    table th, table td { 
        padding: 6px 13px; 
        border: 1px solid #dfe2e5; 
    }
    table th { 
        font-weight: 600; 
        background-color: #f6f8fa; 
    }
    table tr:nth-child(2n) { 
        background-color: #f6f8fa; 
    }
    code { 
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace; 
        background-color: #f6f8fa; 
        padding: 0.2em 0.4em; 
        border-radius: 3px; 
        font-size: 85%; 
    }
    pre { 
        background-color: #f6f8fa; 
        padding: 16px; 
        overflow: auto; 
        border-radius: 3px; 
        line-height: 1.45; 
    }
    pre code { 
        background-color: transparent; 
        padding: 0; 
        border-radius: 0; 
    }
    blockquote { 
        border-left: 0.25em solid #dfe2e5; 
        color: #6a737d; 
        padding: 0 1em; 
        margin: 0 0 16px 0; 
    }
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
    }
    .mermaid {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
</style>

</head>
<body>
    <h1 id="prd-v22-fa-enforce-datacleaner-implementation-guide">PRD v2.2-FA-ENFORCE: è³‡æ–™æ¸…æ´—å™¨å¯¦ä½œæŒ‡å— (DataCleaner Implementation Guide)</h1>
<h1 id="feature-annotation-v12">å¼·åˆ¶åŸ·è¡Œç‰ˆï¼šæ•´åˆ Feature Annotation v1.2 èˆ‡è·è²¬åˆ†é›¢å¼·åˆ¶æ©Ÿåˆ¶</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v2.2-FA-ENFORCE (Interface Contract Alignment &amp; SSOT Enforcement with Mandatory Output Contract Enforcement)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/etl/cleaner.py</code> (v2.2+)<br />
<strong>ä¸Šæ¸¸å¥‘ç´„:</strong> <code>src/etl/parser.py</code> (v2.1+, è¼¸å‡º UTC)<br />
<strong>ä¸‹æ¸¸å¥‘ç´„:</strong> <code>src/etl/batch_processor.py</code> (v1.3+, è¼¸å…¥æª¢æŸ¥é» #2)<br />
<strong>é—œéµç›¸ä¾:</strong> <code>src/features/annotation_manager.py</code> (v1.2+, æä¾› device_role æŸ¥è©¢ï¼Œä½†ä¸å¯«å…¥ metadata)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 5 ~ 6 å€‹å·¥ç¨‹å¤©ï¼ˆå«å¼·åˆ¶åŸ·è¡Œæ©Ÿåˆ¶å¯¦ä½œèˆ‡ CI/CD Gate é…ç½®ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è®Šæ›´æ‘˜è¦</h2>
<h3 id="11-v21-v22-fa-enforce">1.1 ç‰ˆæœ¬è®Šæ›´ç¸½è¦½ (v2.1 â†’ v2.2-FA-ENFORCE)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">è®Šæ›´é¡åˆ¥</th>
<th style="text-align: left;">v2.1 ç‹€æ…‹</th>
<th style="text-align: left;">v2.2-FA-ENFORCE ä¿®æ­£</th>
<th style="text-align: center;">å½±éŸ¿å±¤ç´š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SSOT å¼•ç”¨</strong></td>
<td style="text-align: left;">æåŠ flags ä½†æœªæ˜ç¢ºå¼•ç”¨</td>
<td style="text-align: left;"><strong>å¼·åˆ¶å¼•ç”¨</strong> <code>VALID_QUALITY_FLAGS</code> èˆ‡ <code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ™‚å€è™•ç†</strong></td>
<td style="text-align: left;">è¦æ±‚è¼¸å…¥ UTCï¼Œä½†ç„¡å®¹éŒ¯èªªæ˜</td>
<td style="text-align: left;"><strong>é›™æ¨¡å®¹éŒ¯</strong> (ç›´æ¥é€šé/è‡ªå‹•è½‰æ›)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è¼¸å‡ºé©—è­‰</strong></td>
<td style="text-align: left;">åŸºç¤å¥‘ç´„æª¢æŸ¥</td>
<td style="text-align: left;"><strong>å¼·åˆ¶åŸ·è¡Œå¥‘ç´„é©—è­‰</strong> (<code>_validate_output_contract</code> + <code>_enforce_schema_sanitization</code>)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Flags ç”¢ç”Ÿ</strong></td>
<td style="text-align: left;">é‚è¼¯åˆ†æ•£</td>
<td style="text-align: left;"><strong>é›†ä¸­å¼ Flags ç®¡ç†</strong> (çµ±ä¸€ç”¢ç”Ÿèˆ‡é©—è­‰)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Metadata å‚³é</strong></td>
<td style="text-align: left;">ç„¡æ˜ç¢ºè¦ç¯„</td>
<td style="text-align: left;"><strong>ç™½åå–®å¼·åˆ¶éæ¿¾</strong> <code>ALLOWED_METADATA_KEYS</code>ï¼Œ<strong>ä¸»å‹•æ·¨åŒ–</strong>è€Œéåƒ…æª¢æŸ¥</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Schema æ·¨åŒ–</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><strong>æ–°å¢</strong>ï¼š<code>FORBIDDEN_COLS</code> è‡ªå‹•æ¸…é™¤æ©Ÿåˆ¶ï¼Œé˜²ç¦¦æ€§ç·¨ç¨‹ç¢ºä¿ç¦æ­¢æ¬„ä½çµ•ä¸è¼¸å‡º</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Annotation æ•´åˆ</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><strong>æ–°å¢</strong>ï¼šè®€å– <code>device_role</code> é€²è¡Œèªæ„æ„ŸçŸ¥æ¸…æ´—ï¼Œä½†<strong>ä¸å¯«å…¥ DataFrame</strong></td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è·è²¬åˆ†é›¢</strong></td>
<td style="text-align: left;">å»ºè­°æ€§æè¿°</td>
<td style="text-align: left;"><strong>å¼·åˆ¶åŸ·è¡Œ</strong>ï¼šä¸‰å±¤é˜²è­·æ©Ÿåˆ¶ï¼ˆç™½åå–®+Schemaæ·¨åŒ–+CI Gateï¼‰ç¢ºä¿ E500 çµ•ä¸ç™¼ç”Ÿ</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CI/CD Gate</strong></td>
<td style="text-align: left;">æ¸¬è©¦ç‚ºé©—è­‰é …ç›®</td>
<td style="text-align: left;"><strong>Blocker æ©Ÿåˆ¶</strong>ï¼š<code>test_cleaner_output_no_device_role</code> å¤±æ•—é˜»æ“‹åˆä½µ</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 æ ¸å¿ƒè¨­è¨ˆåŸå‰‡ï¼ˆå¼·åˆ¶åŸ·è¡Œç‰ˆï¼‰</h3>
<ol>
<li><strong>Gatekeeper (å®ˆé–€å“¡)</strong>: é«’æ•¸æ“šçµ•ä¸é€²å…¥ä¸‹æ¸¸ï¼Œç‰©ç†ä¸å¯èƒ½æ•¸æ“šç«‹å³æ¨™è¨˜</li>
<li><strong>SSOT åš´æ ¼éµå®ˆ</strong>: æ‰€æœ‰å“è³ªæ¨™è¨˜ã€å–®ä½å®šç¾©ã€ç‰©ç†é™åˆ¶å¿…é ˆå¼•ç”¨ <code>config_models.py</code></li>
<li><strong>è·è²¬åˆ†é›¢å¼·åˆ¶åŸ·è¡Œ (Mandatory Separation of Concerns)</strong>:</li>
<li><strong>Cleaner è·è²¬</strong>ï¼šè®€å– <code>device_role</code> é€²è¡Œ<strong>èªæ„æ„ŸçŸ¥æ¸…æ´—</strong>ï¼ˆå¦‚å‚™ç”¨è¨­å‚™æ”¾å¯¬å‡çµæª¢æ¸¬ï¼‰ï¼Œä½†<strong>çµ•å°ç¦æ­¢å°‡ <code>device_role</code> å¯«å…¥è¼¸å‡º DataFrame æˆ– metadata</strong></li>
<li><strong>å¼·åˆ¶æ©Ÿåˆ¶</strong>ï¼šé€é <code>ALLOWED_METADATA_KEYS</code> ç™½åå–®èˆ‡ <code>FORBIDDEN_COLS</code> è‡ªå‹•æ¸…é™¤ï¼Œå¾æŠ€è¡“å±¤é¢æœçµ•èª¤å¯«å…¥</li>
<li><strong>ä¸‹æ¸¸è·è²¬</strong>ï¼š<code>FeatureEngineer</code> ç›´æ¥å¾ <code>FeatureAnnotationManager</code> è®€å– <code>device_role</code>ï¼Œä¸ä¾è³´ Cleaner å‚³éçš„ metadata</li>
<li><strong>å†ªç­‰æ€§</strong>: ç›¸åŒè¼¸å…¥åŸ·è¡Œå¤šæ¬¡ï¼Œè¼¸å‡ºå¿…é ˆå®Œå…¨ä¸€è‡´ (æ™‚é–“æˆ³å°é½Šã€Null è™•ç†ä¸€è‡´)</li>
<li><strong>é›¶è¤‡è£½éŠœæ¥</strong>: æ¥æ”¶ Parser v2.1 çš„ UTC è¼¸å‡ºï¼Œç„¡éœ€æ™‚å€è½‰æ›å³å¯å‚³éçµ¦ BatchProcessor</li>
<li><strong>é˜²ç¦¦æ€§ç·¨ç¨‹ (Defensive Programming)</strong>: å³ä½¿é–‹ç™¼è€…èª¤å¯«å…¥ç¦æ­¢æ¬„ä½ï¼Œç³»çµ±è‡ªå‹•æ·¨åŒ–è€Œéåƒ…æ‹‹å‡ºè­¦å‘Š</li>
</ol>
<h3 id="13-feature-annotation">1.3 èˆ‡ Feature Annotation çš„é—œä¿‚</h3>
<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="w"> </span><span class="n">LR</span>
<span class="w">    </span><span class="n">A</span><span class="p">[</span><span class="n">FeatureAnnotationManager</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">æä¾›æŸ¥è©¢</span><span class="o">|</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">DataCleaner</span><span class="w"> </span><span class="n">v2</span><span class="mf">.2</span><span class="p">]</span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">è®€å–</span><span class="w"> </span><span class="n">device_role</span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">èªæ„æ„ŸçŸ¥æ¸…æ´—é‚è¼¯</span><span class="p">]</span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">èª¿æ•´é–¾å€¼</span><span class="o">|</span><span class="w"> </span><span class="n">D</span><span class="p">[</span><span class="n">å‡çµè³‡æ–™æª¢æ¸¬</span><span class="p">]</span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">èª¿æ•´é–¾å€¼</span><span class="o">|</span><span class="w"> </span><span class="n">E</span><span class="p">[</span><span class="n">é›¢ç¾¤å€¼æª¢æ¸¬</span><span class="p">]</span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">è¼¸å‡º</span><span class="o">|</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="n">Clean</span><span class="w"> </span><span class="n">DataFrame</span><span class="p">]</span>
<span class="w">    </span><span class="n">F</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">å¼·åˆ¶æ·¨åŒ–</span><span class="o">:</span><span class="w"> </span><span class="n">ä¸å«</span><span class="w"> </span><span class="n">device_role</span><span class="o">|</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">BatchProcessor</span><span class="w"> </span><span class="n">v1</span><span class="mf">.3</span><span class="p">]</span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">ç›´æ¥è®€å–</span><span class="o">|</span><span class="w"> </span><span class="n">H</span><span class="p">[</span><span class="n">FeatureEngineer</span><span class="w"> </span><span class="n">v1</span><span class="mf">.3</span><span class="p">]</span>

<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">f9f</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mi">333</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">4</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">bbf</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="n">f00</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">3</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">bfb</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mi">333</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
</code></pre></div>

<p><strong>é—œéµç´„æŸï¼ˆå¼·åˆ¶åŸ·è¡Œï¼‰</strong>ï¼š
- ğŸ”´ <strong>Cleaner ä¸å¯«å…¥ device_role</strong>ï¼šè¼¸å‡º DataFrame çš„ schema ä¸­<strong>ä¸å¾—åŒ…å«</strong> <code>device_role</code> æ¬„ä½æˆ– metadataï¼Œä¸”é€éæŠ€è¡“æ©Ÿåˆ¶<strong>å¼·åˆ¶ç§»é™¤</strong>è€Œéåƒ…æª¢æŸ¥
- ğŸŸ¡ <strong>Cleaner è®€å– device_role</strong>ï¼šåƒ…ç”¨æ–¼å…§éƒ¨æ¸…æ´—ç­–ç•¥èª¿æ•´ï¼ˆå¦‚ <code>backup</code> è¨­å‚™å…è¨±è¼ƒé•·æ™‚é–“éœæ­¢å€¼ï¼‰
- ğŸŸ¢ <strong>SSOT å–®ä¸€ä¾†æº</strong>ï¼šæ‰€æœ‰ <code>device_role</code> èˆ‡ <code>physical_type</code> å¿…é ˆä¾†è‡ª <code>FeatureAnnotationManager</code>ï¼Œç¦æ­¢ç¡¬ç·¨ç¢¼é è¨­å€¼</p>
<hr />
<h2 id="2-interface-contracts">2. ä»‹é¢å¥‘ç´„è¦ç¯„ (Interface Contracts)</h2>
<h3 id="21-input-contract-from-parser-v21">2.1 è¼¸å…¥å¥‘ç´„ (Input Contract from Parser v2.1)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æª¢æŸ¥é …</th>
<th style="text-align: left;">è¦ç¯„</th>
<th style="text-align: left;">å®¹éŒ¯è™•ç†</th>
<th style="text-align: center;">éŒ¯èª¤ä»£ç¢¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>timestamp</code></td>
<td style="text-align: left;"><code>Datetime(time_unit='ns', time_zone='UTC')</code></td>
<td style="text-align: left;">è‹¥ç‚ºå…¶ä»–æ™‚å€ â†’ è‡ªå‹•è½‰æ› UTC (Warning)</td>
<td style="text-align: center;">E101</td>
</tr>
<tr>
<td style="text-align: left;"><code>timestamp</code></td>
<td style="text-align: left;">ç„¡æœªä¾†è³‡æ–™ (&gt;<code>now+5min</code>)</td>
<td style="text-align: left;">æ‹‹å‡ºä¾‹å¤– (Data Leakage é˜²è­·)</td>
<td style="text-align: center;">E102</td>
</tr>
<tr>
<td style="text-align: left;"><code>quality_flags</code></td>
<td style="text-align: left;"><code>List(Utf8)</code> (å¯é¸)</td>
<td style="text-align: left;">è‹¥å­˜åœ¨ï¼Œé©—è­‰å€¼ âŠ† <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: center;">E103</td>
</tr>
<tr>
<td style="text-align: left;">æ•¸å€¼æ¬„ä½</td>
<td style="text-align: left;"><code>Float64</code> (SI å–®ä½)</td>
<td style="text-align: left;">å–®ä½è½‰æ› (è‹¥é…ç½® <code>unit_system=IMPERIAL</code>)</td>
<td style="text-align: center;">E104</td>
</tr>
<tr>
<td style="text-align: left;">ç·¨ç¢¼</td>
<td style="text-align: left;">UTF-8ï¼Œç„¡ BOM</td>
<td style="text-align: left;">ç™¼ç¾ BOM â†’ æˆªæ–·ä¸¦è¨˜éŒ„ Warning</td>
<td style="text-align: center;">E105</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ¬„ä½å­˜åœ¨æ€§</strong></td>
<td style="text-align: left;">æ‰€æœ‰æ¬„ä½å¿…é ˆåœ¨ Annotation ä¸­å®šç¾©</td>
<td style="text-align: left;">æœªå®šç¾©æ¬„ä½ä¾ <code>unannotated_column_policy</code> è™•ç†</td>
<td style="text-align: center;"><strong>E402</strong></td>
</tr>
</tbody>
</table>
<h3 id="22-output-contract-to-batchprocessor-v13">2.2 è¼¸å‡ºå¥‘ç´„ (Output Contract to BatchProcessor v1.3)</h3>
<p><strong>é€™æ˜¯èˆ‡ BatchProcessor çš„ç¡¬æ€§å¥‘ç´„ï¼Œå¿…é ˆåš´æ ¼éµå®ˆï¼Œä¸”é€éå¼·åˆ¶åŸ·è¡Œæ©Ÿåˆ¶ç¢ºä¿ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CleanerOutputContract</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cleaner v2.2-FA-ENFORCE è¼¸å‡ºè³‡æ–™è¦ç¯„ï¼ˆå¼·åˆ¶åŸ·è¡Œç‰ˆï¼‰&quot;&quot;&quot;</span>

    <span class="c1"># 1. æ™‚é–“æˆ³è¦ç¯„ (èˆ‡ Parser v2.1 ä¸€è‡´ï¼Œç›´æ¥é€å‚³)</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span><span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>

    <span class="c1"># 2. å“è³ªæ¨™è¨˜ (æ ¸å¿ƒè®Šæ›´ï¼šå¿…é ˆå¼•ç”¨ SSOT)</span>
    <span class="n">quality_flags</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">)</span>  <span class="c1"># å€¼å¿…é ˆ âˆˆ VALID_QUALITY_FLAGS</span>

    <span class="c1"># 3. è³‡æ–™æ¬„ä½ (SI å–®ä½ï¼Œç„¡å–®ä½å­—å…ƒ)</span>
    <span class="n">data_columns</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span>  <span class="c1"># æ‰€æœ‰æ„Ÿæ¸¬å™¨æ•¸å€¼</span>

    <span class="c1"># 4. æ™‚é–“è»¸å®Œæ•´æ€§æ¨™è¨˜</span>
    <span class="n">temporal_continuity</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1"># True=é€£çºŒç„¡ç¼ºæ¼, False=æœ‰ç¼ºæ¼å·²è£œNull</span>

    <span class="c1"># 5. Metadata (å‚³éçµ¦ BatchProcessor å¯«å…¥ Manifest)</span>
    <span class="c1"># ã€é—œéµã€‘ä¸åŒ…å« device_roleï¼Œåƒ…åŒ…å«ç‰©ç†é¡å‹èˆ‡å–®ä½ï¼Œä¸”ç¶“éç™½åå–®å¼·åˆ¶éæ¿¾</span>
    <span class="n">column_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColumnMeta</span><span class="p">]</span>  <span class="c1"># åƒ…é™ ALLOWED_METADATA_KEYS ä¸­çš„éµ</span>
    <span class="c1"># âŒ çµ•å°ç¦æ­¢åŒ…å«ï¼šdevice_role, ignore_warnings, is_target, role, device_type</span>
</code></pre></div>

<h3 id="23-feature-annotation">2.3 Feature Annotation æ•´åˆå¥‘ç´„</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">é …ç›®</th>
<th style="text-align: left;">ä¾†æº</th>
<th style="text-align: center;">ä½¿ç”¨æ–¹å¼</th>
<th style="text-align: center;">æ˜¯å¦å¯«å…¥è¼¸å‡º</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>physical_type</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">ç‰©ç†é™åˆ¶æª¢æŸ¥ã€å–®ä½é©—è­‰</td>
<td style="text-align: center;">âœ… æ˜¯ï¼ˆç¶“ç™½åå–®éæ¿¾å¾Œå¯«å…¥ metadataï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><code>unit</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">å–®ä½è½‰æ›é©—è­‰</td>
<td style="text-align: center;">âœ… æ˜¯ï¼ˆç¶“ç™½åå–®éæ¿¾å¾Œå¯«å…¥ metadataï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><code>device_role</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;"><strong>èªæ„æ„ŸçŸ¥æ¸…æ´—ç­–ç•¥èª¿æ•´</strong></td>
<td style="text-align: center;">âŒ <strong>å¦</strong>ï¼ˆåƒ… runtime ä½¿ç”¨ï¼Œä¸”å¼·åˆ¶ç§»é™¤ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><code>ignore_warnings</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">æ±ºå®šæ˜¯å¦æ¨™è¨˜ç‰¹å®š Warning</td>
<td style="text-align: center;">âŒ <strong>å¦</strong>ï¼ˆåƒ… runtime ä½¿ç”¨ï¼Œä¸”å¼·åˆ¶ç§»é™¤ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><code>is_target</code></td>
<td style="text-align: left;"><code>FeatureAnnotationManager</code></td>
<td style="text-align: center;">è·³éç‰¹å®šæ¸…æ´—ï¼ˆå¦‚ target ä¸æ¨™è¨˜ FROZENï¼‰</td>
<td style="text-align: center;">âŒ <strong>å¦</strong>ï¼ˆåƒ… runtime ä½¿ç”¨ï¼Œä¸”å¼·åˆ¶ç§»é™¤ï¼‰</td>
</tr>
</tbody>
</table>
<h3 id="24-output-contract-enforcement">2.4 è¼¸å‡ºå¥‘ç´„å¼·åˆ¶åŸ·è¡Œæ©Ÿåˆ¶ (Output Contract Enforcement)</h3>
<p>ç‚ºç¢ºä¿ E500 çµ•å°ä¸ç™¼ç”Ÿï¼Œå¯¦ä½œå±¤å¿…é ˆæ¡ç”¨<strong>é˜²ç¦¦æ€§ç¨‹å¼è¨­è¨ˆä¸‰å±¤é˜²è­·æ©Ÿåˆ¶</strong>ï¼š</p>
<h4 id="241-metadata-metadata-whitelist">2.4.1 ç¬¬ä¸€å±¤ï¼šMetadata ç™½åå–®æ©Ÿåˆ¶ (Metadata Whitelist)</h4>
<p><strong>å¼·åˆ¶è¦æ±‚</strong>ï¼šå®šç¾©åš´æ ¼çš„ç™½åå–®ï¼Œä»»ä½•ä¸åœ¨ç™½åå–®çš„éµæ–¼ <code>_build_column_metadata</code> éšæ®µ<strong>è‡ªå‹•åˆªé™¤</strong>ï¼Œè€Œéåƒ…ç™¼å‡ºè­¦å‘Šã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æª”æ¡ˆ: src/etl/cleaner.py</span>
<span class="c1"># é¡åˆ¥å±¤ç´šå¸¸æ•¸å®šç¾©ï¼ˆå¼·åˆ¶åŸ·è¡Œï¼‰</span>
<span class="n">ALLOWED_METADATA_KEYS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span>
    <span class="s1">&#39;physical_type&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;unit&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;description&#39;</span><span class="p">,</span>
    <span class="s1">&#39;column_name&#39;</span>  <span class="c1"># å…§éƒ¨ä½¿ç”¨ï¼Œä½†å…è¨±å‚³é</span>
<span class="p">})</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_sanitize_metadata_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å¼·åˆ¶åŸ·è¡Œï¼šMetadata ç™½åå–®éæ¿¾</span>
<span class="sd">    ç„¡è«–é–‹ç™¼è€…æ„åœ–ç‚ºä½•ï¼Œåƒ…å…è¨± ALLOWED_METADATA_KEYS ä¸­çš„éµé€šé</span>

<span class="sd">    Args:</span>
<span class="sd">        meta: åŸå§‹ metadata dictï¼ˆå¯èƒ½åŒ…å«èª¤å¯«å…¥çš„ device_role ç­‰ï¼‰</span>
<span class="sd">        column_name: æ¬„ä½åç¨±ï¼Œç”¨æ–¼æ—¥èªŒè¨˜éŒ„</span>

<span class="sd">    Returns:</span>
<span class="sd">        æ·¨åŒ–å¾Œçš„ metadata dictï¼Œä¿è­‰åƒ…å«ç™½åå–®éµ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sanitized</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">removed_keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ALLOWED_METADATA_KEYS</span><span class="p">:</span>
            <span class="n">sanitized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">removed_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># å¼·åˆ¶åŸ·è¡Œï¼šç™¼ç¾ç¦æ­¢éµæ™‚è¨˜éŒ„ Warningï¼Œä½†çµ•ä¸æ‹‹å‡ºéŒ¯èª¤ï¼ˆé˜²ç¦¦æ€§ç·¨ç¨‹ï¼‰</span>
    <span class="k">if</span> <span class="n">removed_keys</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[å¼·åˆ¶åŸ·è¡Œ] æ¬„ä½ &#39;</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">&#39; ç™¼ç¾ç¦æ­¢ metadata éµ </span><span class="si">{</span><span class="n">removed_keys</span><span class="si">}</span><span class="s2">ï¼Œ&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;å·²è‡ªå‹•ç§»é™¤ã€‚è«‹æª¢æŸ¥ç¨‹å¼ç¢¼æ˜¯å¦èª¤å¯«å…¥ device_role ç­‰è³‡è¨Šã€‚&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">sanitized</span>
</code></pre></div>

<h4 id="242-schema-schema-sanitization">2.4.2 ç¬¬äºŒå±¤ï¼šSchema å¼·åˆ¶æ·¨åŒ– (Schema Sanitization)</h4>
<p><strong>å¼·åˆ¶è¦æ±‚</strong>ï¼šåœ¨ <code>_validate_output_contract</code> ä¸­ï¼Œä½¿ç”¨ <code>df.select()</code> <strong>ä¸»å‹•æ¸…é™¤</strong>å¯èƒ½çš„ç¦æ­¢æ¬„ä½ï¼ˆå³ä½¿èª¤å¯«å…¥ï¼‰ï¼Œç¢ºä¿è¼¸å‡º schema çµ•å°ç´”æ·¨ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æª”æ¡ˆ: src/etl/cleaner.py</span>
<span class="c1"># ç¦æ­¢æ¬„ä½å®šç¾©ï¼ˆæ“´å……ç‰ˆï¼ŒåŒ…å«å¯èƒ½çš„è®Šé«”ï¼‰</span>
<span class="n">FORBIDDEN_COLS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span>
    <span class="s1">&#39;device_role&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;ignore_warnings&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;is_target&#39;</span><span class="p">,</span>
    <span class="s1">&#39;role&#39;</span><span class="p">,</span>           <span class="c1"># å¯èƒ½çš„ç°¡å¯«</span>
    <span class="s1">&#39;device_type&#39;</span><span class="p">,</span>    <span class="c1"># å¯èƒ½çš„æ··æ·†åç¨±</span>
    <span class="s1">&#39;annotation_role&#39;</span><span class="p">,</span> <span class="c1"># å¯èƒ½çš„å‘½å</span>
    <span class="s1">&#39;col_role&#39;</span><span class="p">,</span>
    <span class="s1">&#39;feature_role&#39;</span>
<span class="p">})</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_enforce_schema_sanitization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å¼·åˆ¶åŸ·è¡Œï¼šSchema æ·¨åŒ–</span>
<span class="sd">    ä½¿ç”¨ Polars é¸æ“‡å™¨å¼·åˆ¶æ’é™¤ç¦æ­¢æ¬„ä½ï¼Œå³ä½¿é€™äº›æ¬„ä½è¢«èª¤å¯«å…¥</span>

<span class="sd">    æ­¤ç‚ºé˜²ç¦¦æ€§ç·¨ç¨‹æœ€å¾Œé˜²ç·šï¼Œç¢ºä¿ç„¡è«–ä¸Šæ¸¸é‚è¼¯å¦‚ä½•ï¼Œè¼¸å‡ºçµ•å°ä¹¾æ·¨</span>

<span class="sd">    Args:</span>
<span class="sd">        df: å¯èƒ½åŒ…å«ç¦æ­¢æ¬„ä½çš„ DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        æ·¨åŒ–å¾Œçš„ DataFrameï¼Œä¿è­‰ä¸å« FORBIDDEN_COLS ä¸­çš„ä»»ä½•æ¬„ä½</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">forbidden_in_df</span> <span class="o">=</span> <span class="n">current_cols</span> <span class="o">&amp;</span> <span class="n">FORBIDDEN_COLS</span>

    <span class="k">if</span> <span class="n">forbidden_in_df</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[å¼·åˆ¶åŸ·è¡Œ] ç™¼ç¾ç¦æ­¢æ¬„ä½ </span><span class="si">{</span><span class="n">forbidden_in_df</span><span class="si">}</span><span class="s2"> æ–¼è¼¸å‡º DataFrameï¼Œ&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;åŸ·è¡Œå¼·åˆ¶ç§»é™¤ã€‚é€™è¡¨ç¤ºä¸Šæ¸¸é‚è¼¯èª¤å¯«å…¥ device_role ç­‰è³‡è¨Šã€‚&quot;</span>
        <span class="p">)</span>

        <span class="c1"># å¼·åˆ¶åŸ·è¡Œï¼šä½¿ç”¨ Polars select ä¸»å‹•æ’é™¤ï¼ˆçµ•ä¸æ‹‹éŒ¯ï¼Œç¢ºä¿æµç¨‹ç¹¼çºŒï¼‰</span>
        <span class="n">clean_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FORBIDDEN_COLS</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">clean_cols</span><span class="p">)</span>

        <span class="c1"># è¨˜éŒ„ç¨½æ ¸è»Œè·¡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[å¼·åˆ¶åŸ·è¡Œ] å·²ç§»é™¤æ¬„ä½: </span><span class="si">{</span><span class="n">forbidden_in_df</span><span class="si">}</span><span class="s2">ï¼Œå‰©é¤˜æ¬„ä½: </span><span class="si">{</span><span class="n">clean_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

<h4 id="243-gate-unit-test-gate">2.4.3 ç¬¬ä¸‰å±¤ï¼šå–®å…ƒæ¸¬è©¦ Gate (Unit Test Gate)</h4>
<p><strong>å¼·åˆ¶è¦æ±‚</strong>ï¼š<code>test_cleaner_output_no_device_role</code> æ¸¬è©¦æ¡ˆä¾‹å¿…é ˆé€šéï¼Œæ‰èƒ½åˆä½µè‡³ main åˆ†æ”¯ã€‚æ­¤æ¸¬è©¦ç‚º<strong>æ¶æ§‹é˜²è­·æ¸¬è©¦ (Architecture Guard Test)</strong>ï¼Œå¤±æ•—å³é˜»æ“‹éƒ¨ç½²ç®¡ç·šã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æª”æ¡ˆ: tests/test_cleaner_output_contract.py</span>
<span class="c1"># æ­¤æ¸¬è©¦ç‚º CI/CD Required Status Checkï¼Œå¤±æ•—é˜»æ“‹åˆä½µ</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestCleanerOutputContractEnforcement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è¼¸å‡ºå¥‘ç´„å¼·åˆ¶åŸ·è¡Œæ¸¬è©¦ï¼ˆCI/CD Blockerï¼‰&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_cleaner_output_no_device_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_annotation_manager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        å¼·åˆ¶åŸ·è¡Œæ¸¬è©¦ï¼šé©—è­‰è¼¸å‡ºçµ•å°ä¸å« device_role æ¬„ä½æˆ– metadata</span>

<span class="sd">        æ­¤æ¸¬è©¦å¤±æ•—è¡¨ç¤ºï¼š</span>
<span class="sd">        1. ç™½åå–®æ©Ÿåˆ¶å¤±æ•ˆï¼Œæˆ–</span>
<span class="sd">        2. Schema æ·¨åŒ–å¤±æ•ˆï¼Œæˆ–  </span>
<span class="sd">        3. é–‹ç™¼è€…ç¹éé˜²è­·æ©Ÿåˆ¶ç›´æ¥å¯«å…¥</span>

<span class="sd">        å¾Œæœï¼šç«‹å³é˜»æ“‹åˆä½µè‡³ main åˆ†æ”¯ï¼ˆP1 å„ªå…ˆç´šï¼‰</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Arrange: å»ºç«‹åŒ…å« device_role çš„ Annotation ç’°å¢ƒ</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">CleanerConfig</span><span class="p">(</span>
            <span class="n">use_device_role_from_annotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unannotated_column_policy</span><span class="o">=</span><span class="s2">&quot;error&quot;</span>
        <span class="p">)</span>
        <span class="n">cleaner</span> <span class="o">=</span> <span class="n">DataCleaner</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">annotation_manager</span><span class="o">=</span><span class="n">sample_annotation_manager</span><span class="p">)</span>

        <span class="c1"># å»ºç«‹æ¸¬è©¦è³‡æ–™ï¼ˆæ¨¡æ“¬å¯èƒ½èª˜ä½¿å¯«å…¥ role çš„å ´æ™¯ï¼‰</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2026</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)],</span>
            <span class="s2">&quot;sensor_A&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">25.0</span><span class="p">],</span>  <span class="c1"># å‡è¨­ç‚º backup è¨­å‚™</span>
        <span class="p">})</span>

        <span class="c1"># Act: åŸ·è¡Œæ¸…æ´—</span>
        <span class="n">result_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="c1"># Assert: çµ•å°ç¦æ­¢æ¬„ä½æª¢æŸ¥ï¼ˆç¡¬æ–·è¨€ï¼Œç„¡å®¹éŒ¯ï¼‰</span>
        <span class="k">assert</span> <span class="s2">&quot;device_role&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> \
            <span class="sa">f</span><span class="s2">&quot;E500 é•è¦ï¼šè¼¸å‡º DataFrame åŒ…å«ç¦æ­¢æ¬„ä½ &#39;device_role&#39;ã€‚Columns: </span><span class="si">{</span><span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">assert</span> <span class="s2">&quot;role&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> \
            <span class="sa">f</span><span class="s2">&quot;E500 é•è¦ï¼šè¼¸å‡º DataFrame åŒ…å«ç¦æ­¢æ¬„ä½ &#39;role&#39;ã€‚Columns: </span><span class="si">{</span><span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Assert: Metadata ç™½åå–®æª¢æŸ¥</span>
        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">forbidden_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="n">FORBIDDEN_COLS</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">forbidden_keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> \
                <span class="sa">f</span><span class="s2">&quot;E500 é•è¦ï¼šæ¬„ä½ &#39;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&#39; çš„ metadata åŒ…å«ç¦æ­¢éµ </span><span class="si">{</span><span class="n">forbidden_keys</span><span class="si">}</span><span class="s2">ã€‚ &quot;</span> \
                <span class="sa">f</span><span class="s2">&quot;Metadata å…§å®¹: </span><span class="si">{</span><span class="n">meta</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># é©—è­‰åƒ…å«ç™½åå–®éµ</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">ALLOWED_METADATA_KEYS</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;E500 é•è¦ï¼šæ¬„ä½ &#39;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&#39; çš„ metadata åŒ…å«éç™½åå–®éµã€‚ &quot;</span> \
                <span class="sa">f</span><span class="s2">&quot;å…è¨±: </span><span class="si">{</span><span class="n">ALLOWED_METADATA_KEYS</span><span class="si">}</span><span class="s2">, å¯¦éš›: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_cleaner_forced_sanitization_effectiveness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        é©—è­‰å¼·åˆ¶æ·¨åŒ–æ©Ÿåˆ¶æœ‰æ•ˆæ€§ï¼šå³ä½¿æ‰‹å‹•æ³¨å…¥ç¦æ­¢æ¬„ä½ï¼Œè¼¸å‡ºä»è¢«æ·¨åŒ–</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cleaner</span> <span class="o">=</span> <span class="n">DataCleaner</span><span class="p">(</span><span class="n">CleanerConfig</span><span class="p">())</span>

        <span class="c1"># æ¨¡æ“¬èª¤å¯«å…¥åœºæ™¯ï¼šæ‰‹å‹•æ§‹é€ å«ç¦æ­¢æ¬„ä½çš„ DataFrame</span>
        <span class="n">contaminated_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2026</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)],</span>
            <span class="s2">&quot;sensor_A&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">25.0</span><span class="p">],</span>
            <span class="s2">&quot;device_role&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;backup&quot;</span><span class="p">],</span>  <span class="c1"># æ¨¡æ“¬èª¤å¯«å…¥</span>
            <span class="s2">&quot;ignore_warnings&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>   <span class="c1"># æ¨¡æ“¬èª¤å¯«å…¥</span>
        <span class="p">})</span>

        <span class="c1"># é€éåå°„å‘¼å«å…§éƒ¨æ·¨åŒ–æ–¹æ³•é©—è­‰</span>
        <span class="n">clean_df</span> <span class="o">=</span> <span class="n">cleaner</span><span class="o">.</span><span class="n">_enforce_schema_sanitization</span><span class="p">(</span><span class="n">contaminated_df</span><span class="p">)</span>

        <span class="k">assert</span> <span class="s2">&quot;device_role&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s2">&quot;ignore_warnings&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s2">&quot;sensor_A&quot;</span> <span class="ow">in</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">columns</span>  <span class="c1"># æ­£å¸¸æ¬„ä½ä¿ç•™</span>
</code></pre></div>

<hr />
<h2 id="3-phase-based-implementation">3. åˆ†éšæ®µå¯¦ä½œè¨ˆç•« (Phase-Based Implementation)</h2>
<h3 id="phase-0-annotation-day-1-2">Phase 0: Annotation æ•´åˆåŸºç¤å»ºè¨­èˆ‡å¼·åˆ¶æ©Ÿåˆ¶ (Day 1-2, é‡å¤§æ›´æ–°)</h3>
<h4 id="step-01-annotationmanager">Step 0.1: å»ºæ§‹å­èˆ‡ AnnotationManager æ³¨å…¥ï¼ˆå«å¼·åˆ¶æª¢æŸ¥ï¼‰</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/cleaner.py</code> (é ‚éƒ¨èˆ‡ <code>__init__</code>)</p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Final</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span>

<span class="c1"># ã€é—œéµã€‘SSOT åš´æ ¼å¼•ç”¨</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.config_models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">VALID_QUALITY_FLAGS</span><span class="p">,</span>      <span class="c1"># SSOT: 6å€‹æ¨™æº–å“è³ªæ¨™è¨˜</span>
    <span class="n">TIMESTAMP_CONFIG</span><span class="p">,</span>         <span class="c1"># SSOT: æ™‚é–“æˆ³è¦ç¯„ (UTC, ns)</span>
    <span class="n">CleanerConfig</span><span class="p">,</span>           <span class="c1"># é…ç½®æ¨¡å‹ï¼ˆå·²ç§»é™¤ default_device_roleï¼‰</span>
<span class="p">)</span>

<span class="c1"># ã€æ–°å¢ã€‘Feature Annotation æ•´åˆ</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.features.annotation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureAnnotationManager</span><span class="p">,</span> <span class="n">ColumnAnnotation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">ContractViolationError</span><span class="p">,</span> <span class="n">DataValidationError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DataCleaner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DataCleaner v2.2-FA-ENFORCE - æ•´åˆ Feature Annotation èˆ‡è·è²¬åˆ†é›¢å¼·åˆ¶åŸ·è¡Œæ©Ÿåˆ¶</span>

<span class="sd">    æ ¸å¿ƒè·è²¬ï¼š</span>
<span class="sd">    1. è³‡æ–™æ¸…æ´—èˆ‡å“è³ªæ¨™è¨˜ï¼ˆSSOT åš´æ ¼å¼•ç”¨ï¼‰</span>
<span class="sd">    2. èªæ„æ„ŸçŸ¥æ¸…æ´—ï¼ˆæ ¹æ“š device_role èª¿æ•´ç­–ç•¥ï¼Œä½†ä¸å¯«å…¥ metadataï¼‰</span>
<span class="sd">    3. **å¼·åˆ¶åŸ·è¡Œè¼¸å‡ºå¥‘ç´„**ï¼ˆä¸‰å±¤é˜²è­·ï¼šç™½åå–®+Schemaæ·¨åŒ–+é©—è­‰ï¼‰</span>

<span class="sd">    å¼·åˆ¶æ©Ÿåˆ¶ä¿è­‰ï¼š</span>
<span class="sd">    - è¼¸å‡ºçµ•å°ä¸å« device_role ç­‰ç¦æ­¢æ¬„ä½ï¼ˆå³ä½¿èª¤å¯«å…¥ä¹Ÿè‡ªå‹•æ¸…é™¤ï¼‰</span>
<span class="sd">    - Metadata åƒ…å«ç™½åå–®éµï¼ˆè‡ªå‹•éæ¿¾ï¼Œä¸æ‹‹éŒ¯ï¼‰</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ã€å¼·åˆ¶åŸ·è¡Œã€‘é¡åˆ¥å±¤ç´šå¸¸æ•¸å®šç¾©</span>
    <span class="n">ALLOWED_METADATA_KEYS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span>
        <span class="s1">&#39;physical_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;column_name&#39;</span>
    <span class="p">})</span>

    <span class="n">FORBIDDEN_COLS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span>
        <span class="s1">&#39;device_role&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore_warnings&#39;</span><span class="p">,</span> <span class="s1">&#39;is_target&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;device_type&#39;</span><span class="p">,</span> <span class="s1">&#39;annotation_role&#39;</span><span class="p">,</span> <span class="s1">&#39;col_role&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_role&#39;</span>
    <span class="p">})</span>

    <span class="n">DEVICE_ROLE_THRESHOLDS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;primary&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;frozen_multiplier&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;zero_ratio_warning&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;backup&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;frozen_multiplier&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
            <span class="s2">&quot;zero_ratio_warning&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;seasonal&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;frozen_multiplier&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="s2">&quot;zero_ratio_warning&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">config</span><span class="p">:</span> <span class="n">CleanerConfig</span><span class="p">,</span>
        <span class="n">annotation_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FeatureAnnotationManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            config: æ¸…æ´—é…ç½®ï¼ˆå·²ç§»é™¤ default_device_roleï¼‰</span>
<span class="sd">            annotation_manager: ç‰¹å¾µæ¨™è¨»ç®¡ç†å™¨ï¼ˆæä¾› device_role æŸ¥è©¢ï¼Œä½†ä¸å¯«å…¥è¼¸å‡ºï¼‰</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConfigurationError: è‹¥å•Ÿç”¨ Annotation æ•´åˆä½†æœªæä¾› Manager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">annotation_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;DataCleaner&quot;</span><span class="p">)</span>

        <span class="c1"># é©—è­‰ï¼šè‹¥å•Ÿç”¨ Annotation æ•´åˆï¼Œå¿…é ˆæä¾› Manager</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_device_role_from_annotation</span> <span class="ow">and</span> <span class="n">annotation_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;E402: å•Ÿç”¨ device_role æ„ŸçŸ¥ä½†æœªæä¾› FeatureAnnotationManager&quot;</span>
            <span class="p">)</span>

        <span class="c1"># é©—è­‰ï¼šæª¢æŸ¥å¸¸æ•¸å®šç¾©å®Œæ•´æ€§ï¼ˆé˜²ç¦¦æ€§æª¢æŸ¥ï¼‰</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALLOWED_METADATA_KEYS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;ALLOWED_METADATA_KEYS ä¸å¯ç‚ºç©º&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;åˆå§‹åŒ– DataCleaner (SSOT Flags: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">VALID_QUALITY_FLAGS</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Annotation Enabled: </span><span class="si">{</span><span class="n">annotation_manager</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;å¼·åˆ¶åŸ·è¡Œæ¨¡å¼: ç™½åå–®+Schemaæ·¨åŒ–)&quot;</span>
        <span class="p">)</span>
</code></pre></div>

<h4 id="step-02-e402">Step 0.2: æœªå®šç¾©æ¬„ä½è™•ç†ç­–ç•¥ (E402)ï¼ˆç¶­æŒä¸è®Šï¼Œè©³ç´°å¯¦ä½œï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_validate_columns_annotated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    é©—è­‰æ‰€æœ‰æ¬„ä½å·²åœ¨ Annotation ä¸­å®šç¾© (E402)</span>

<span class="sd">    ç­–ç•¥ä¾æ“š config.unannotated_column_policy:</span>
<span class="sd">    - &quot;error&quot;: æ‹‹å‡º E402 (strict_mode)</span>
<span class="sd">    - &quot;skip&quot;: è·³éæœªæ¨™è¨»æ¬„ä½ï¼ˆä¸æ¸…æ´—ï¼Œç›´æ¥å‚³éï¼Œä½†ä¸å¯«å…¥ metadataï¼‰</span>
<span class="sd">    - &quot;warn&quot;: è¨˜éŒ„è­¦å‘Šï¼Œä½¿ç”¨ä¿å®ˆé è¨­é€²è¡Œæ¸…æ´—</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_device_role_from_annotation</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">unannotated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_skipped_columns</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># è¨˜éŒ„éœ€è·³éçš„æ¬„ä½</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">is_column_annotated</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
            <span class="n">unannotated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">unannotated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">unannotated_column_policy</span>

    <span class="k">if</span> <span class="n">policy</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataValidationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;E402: ä»¥ä¸‹æ¬„ä½æœªå®šç¾©æ–¼ Feature Annotationï¼Œç„¡æ³•é€²è¡Œèªæ„æ„ŸçŸ¥æ¸…æ´—: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unannotated</span><span class="si">}</span><span class="s2">ã€‚è«‹åŸ·è¡Œ: python main.py features wizard --from-csv &lt;file&gt;&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">policy</span> <span class="o">==</span> <span class="s2">&quot;skip&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E402 (Skip): è·³éæœªå®šç¾©æ¬„ä½: </span><span class="si">{</span><span class="n">unannotated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skipped_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unannotated</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">policy</span> <span class="o">==</span> <span class="s2">&quot;warn&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E402 (Warn): æœªå®šç¾©æ¬„ä½ä½¿ç”¨ä¿å®ˆé è¨­: </span><span class="si">{</span><span class="n">unannotated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warned_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unannotated</span><span class="p">)</span>  <span class="c1"># ä¾›å¾ŒçºŒä½¿ç”¨ä¿å®ˆé‚è¼¯</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

<hr />
<h3 id="phase-1-ssot-day-2">Phase 1: SSOT é…ç½®èˆ‡åŸºç¤å»ºè¨­ (Day 2)</h3>
<h4 id="step-11-ssot">Step 1.1: SSOT å¼•ç”¨èˆ‡ç‰©ç†é™åˆ¶ï¼ˆç¶­æŒä¸è®Šï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç‰©ç†é™åˆ¶å¸¸æ•¸ (SSOTï¼Œä¾›ç‰©ç†é©—è­‰ä½¿ç”¨)</span>
<span class="n">PHYSICAL_LIMITS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">40.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>
    <span class="s2">&quot;flow_rate&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">),</span>
    <span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">),</span>
    <span class="s2">&quot;pressure&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2000.0</span><span class="p">),</span>
    <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">120.0</span><span class="p">),</span>
    <span class="s2">&quot;humidity&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>
    <span class="s2">&quot;chiller_load&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>
    <span class="s2">&quot;cooling_tower_load&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h3 id="phase-2-day-2-3">Phase 2: æ™‚é–“æ¨™æº–åŒ–èˆ‡é‡æ¡æ¨£ (Day 2-3)</h3>
<h4 id="step-21-23">Step 2.1-2.3: æ™‚é–“è™•ç†ï¼ˆè©³ç´°å¯¦ä½œï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_normalize_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Step 1: æ™‚é–“æˆ³æ¨™æº–åŒ– (E101 è™•ç†)</span>

<span class="sd">    é‚è¼¯ï¼š</span>
<span class="sd">    1. æª¢æŸ¥æ˜¯å¦ç‚º Datetime é¡å‹</span>
<span class="sd">    2. è‹¥ç„¡æ™‚å€è³‡è¨Šï¼Œå‡è¨­ç‚º UTCï¼ˆè¨˜éŒ„ Warningï¼‰</span>
<span class="sd">    3. è‹¥ç‚ºå…¶ä»–æ™‚å€ï¼Œè‡ªå‹•è½‰æ›ç‚º UTCï¼ˆè¨˜éŒ„ E101 Warningï¼‰</span>
<span class="sd">    4. çµ±ä¸€ time_unit ç‚º &#39;ns&#39; ä»¥ç¢ºä¿ç²¾åº¦</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataValidationError</span><span class="p">(</span><span class="s2">&quot;è¼¸å…¥è³‡æ–™ç¼ºå°‘å¿…è¦æ¬„ä½ &#39;timestamp&#39;&quot;</span><span class="p">)</span>

    <span class="n">ts_col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>

    <span class="c1"># æª¢æŸ¥é¡å‹</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ts_col</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DataValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;timestamp æ¬„ä½é¡å‹éŒ¯èª¤: </span><span class="si">{</span><span class="n">ts_col</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># æ™‚å€è™•ç†</span>
    <span class="n">current_tz</span> <span class="o">=</span> <span class="n">ts_col</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">time_zone</span>

    <span class="k">if</span> <span class="n">current_tz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;timestamp ç„¡æ™‚å€è³‡è¨Šï¼Œå‡è¨­ç‚º UTC&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">replace_time_zone</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">current_tz</span> <span class="o">!=</span> <span class="s2">&quot;UTC&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E101: åµæ¸¬åˆ°é UTC æ™‚å€ </span><span class="si">{</span><span class="n">current_tz</span><span class="si">}</span><span class="s2">ï¼Œè‡ªå‹•è½‰æ›&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">convert_time_zone</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># ç¢ºä¿ç²¾åº¦ç‚º nanosecond</span>
    <span class="k">if</span> <span class="n">ts_col</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">time_unit</span> <span class="o">!=</span> <span class="s2">&quot;ns&quot;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span><span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_check_future_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Step 2: æœªä¾†è³‡æ–™æª¢æŸ¥ (E102)</span>

<span class="sd">    åµæ¸¬æœªä¾†æ™‚é–“æˆ³ï¼ˆè¶…éç¾åœ¨ 5 åˆ†é˜ï¼‰ï¼Œé˜²æ­¢ Data Leakage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">future_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>
    <span class="n">future_count</span> <span class="o">=</span> <span class="n">future_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">future_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">future_samples</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">future_mask</span><span class="p">)[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">DataValidationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;E102: åµæ¸¬åˆ° </span><span class="si">{</span><span class="n">future_count</span><span class="si">}</span><span class="s2"> ç­†æœªä¾†è³‡æ–™ï¼ˆ&gt;</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">ï¼‰ã€‚&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;æ¨£æœ¬: </span><span class="si">{</span><span class="n">future_samples</span><span class="si">}</span><span class="s2">ã€‚è«‹æª¢æŸ¥ç³»çµ±æ™‚é˜èˆ‡è³‡æ–™ä¾†æºã€‚&quot;</span>
        <span class="p">)</span>
</code></pre></div>

<hr />
<h3 id="phase-3-semantic-aware-cleaning-day-3-4">Phase 3: èªæ„æ„ŸçŸ¥æ¸…æ´— (Semantic-Aware Cleaning) (Day 3-4, æ ¸å¿ƒæ–°å¢)</h3>
<p><strong>é€™æ˜¯ v2.2-FA-ENFORCE çš„æ ¸å¿ƒéšæ®µï¼Œå¯¦ç¾ã€Œè®€å– device_role ä½†ä¸å¯«å…¥ã€çš„è·è²¬åˆ†é›¢ï¼Œä¸¦å¼·åˆ¶åŸ·è¡Œè¼¸å‡ºæ·¨åŒ–</strong></p>
<h4 id="step-31-device-role">Step 3.1: å‡çµè³‡æ–™åµæ¸¬ï¼ˆDevice Role æ„ŸçŸ¥ï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_detect_frozen_data_semantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    èªæ„æ„ŸçŸ¥å‡çµè³‡æ–™åµæ¸¬ï¼ˆåš´æ ¼åŸ·è¡Œè·è²¬åˆ†é›¢ï¼‰</span>

<span class="sd">    é‚è¼¯ï¼š</span>
<span class="sd">    - Primary è¨­å‚™ï¼šé€£çºŒ 3 å€‹å€é–“å€¼ç›¸åŒ â†’ FROZEN</span>
<span class="sd">    - Backup è¨­å‚™ï¼šé€£çºŒ 9 å€‹å€é–“å€¼ç›¸åŒï¼ˆ3Ã—3ï¼‰â†’ FROZENï¼ˆå¯èƒ½æ­£å¸¸åœæ©Ÿï¼‰</span>
<span class="sd">    - Seasonal è¨­å‚™ï¼šé€£çºŒ 6 å€‹å€é–“å€¼ç›¸åŒï¼ˆ3Ã—2ï¼‰â†’ FROZEN</span>

<span class="sd">    **é—œéµ**ï¼šåƒ…è®€å– device_role èª¿æ•´é–¾å€¼ï¼Œçµ•ä¸å¯«å…¥ DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">frozen_data_intervals</span>  <span class="c1"># é è¨­ 3</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;quality_flags&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="c1"># æŸ¥è©¢ device_roleï¼ˆåƒ…ç”¨æ–¼å…§éƒ¨é‚è¼¯ï¼‰</span>
        <span class="n">role</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_column_role</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>  <span class="c1"># è¼”åŠ©æ–¹æ³•è¦‹ä¸‹æ–¹</span>

        <span class="c1"># è·³éæœªå®šç¾©æ¬„ä½ï¼ˆè‹¥ policy=skipï¼‰</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_skipped_columns&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
            <span class="k">continue</span>

        <span class="c1"># å–å¾—è§’è‰²ç‰¹å®šé–¾å€¼</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEVICE_ROLE_THRESHOLDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;frozen_multiplier&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_intervals</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>

        <span class="c1"># æ§‹å»ºå‡çµæª¢æ¸¬è¡¨é”å¼ï¼ˆå‘å¾Œçœ‹ threshold å€‹ï¼‰</span>
        <span class="n">is_frozen</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">is_frozen</span> <span class="o">=</span> <span class="n">is_frozen</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">is_frozen</span> <span class="o">=</span> <span class="n">is_frozen</span> <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span>

        <span class="c1"># ã€SSOT å¼•ç”¨ã€‘æ¨™è¨˜ FROZENï¼ˆä½¿ç”¨å¸¸æ•¸ç´¢å¼•è€Œéç¡¬ç·¨ç¢¼ï¼‰</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">is_frozen</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">([</span><span class="n">VALID_QUALITY_FLAGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>  <span class="c1"># &quot;FROZEN&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># è¨˜éŒ„èªæ„èª¿æ•´ï¼ˆåƒ…æ—¥èªŒï¼Œçµ•ä¸å¯«å…¥è³‡æ–™ï¼‰</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;primary&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[èªæ„æ„ŸçŸ¥] æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> (role=</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">) å‡çµé–¾å€¼èª¿æ•´ç‚º </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(base=</span><span class="si">{</span><span class="n">base_intervals</span><span class="si">}</span><span class="s2"> Ã— multiplier=</span><span class="si">{</span><span class="n">multiplier</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_column_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è¼”åŠ©æ–¹æ³•ï¼šæŸ¥è©¢æ¬„ä½ device_roleï¼ˆå…§éƒ¨ä½¿ç”¨ï¼Œä¸æš´éœ²è‡³è¼¸å‡ºï¼‰</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: device_role å€¼ï¼ˆprimary/backup/seasonal/unknownï¼‰</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">or</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_skipped_columns&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
        <span class="k">return</span> <span class="s2">&quot;primary&quot;</span>  <span class="c1"># ä¿å®ˆé è¨­</span>

    <span class="n">col_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get_column_config</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">col_config</span> <span class="ow">and</span> <span class="n">col_config</span><span class="o">.</span><span class="n">device_role</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">col_config</span><span class="o">.</span><span class="n">device_role</span>

    <span class="k">return</span> <span class="s2">&quot;primary&quot;</span>
</code></pre></div>

<h4 id="step-32-device-role">Step 3.2: é›¶å€¼æ¯”ä¾‹æª¢æŸ¥ï¼ˆDevice Role æ„ŸçŸ¥ï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_check_zero_ratio_semantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    èªæ„æ„ŸçŸ¥é›¶å€¼æª¢æŸ¥ï¼ˆW403 ç›¸é—œï¼‰</span>

<span class="sd">    - Primary è¨­å‚™ï¼š&gt;10% é›¶å€¼æ¨™è¨˜è­¦å‘Šï¼ˆå¯èƒ½ç•°å¸¸ï¼‰</span>
<span class="sd">    - Backup/Seasonal è¨­å‚™ï¼šå…è¨±é«˜é›¶å€¼æ¯”ä¾‹ï¼Œä¸æ¨™è¨˜ W403</span>

<span class="sd">    **æ³¨æ„**ï¼šæ­¤è™•åƒ…è¨˜éŒ„æ—¥èªŒï¼Œå¯¦éš› W403 æ¨™è¨˜æ‡‰åœ¨ä¸‹æ¸¸æ ¹æ“š Annotation ç”¢ç”Ÿ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;quality_flags&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="n">role</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_column_role</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1"># è¨ˆç®—é›¶å€¼æ¯”ä¾‹ï¼ˆPolars é«˜æ•ˆè¨ˆç®—ï¼‰</span>
        <span class="n">zero_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">total_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">zero_ratio</span> <span class="o">=</span> <span class="n">zero_count</span> <span class="o">/</span> <span class="n">total_count</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEVICE_ROLE_THRESHOLDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zero_ratio_warning&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># åƒ… Primary è¨­å‚™è¨˜éŒ„è­¦å‘Šï¼ˆå¯¦éš›æ¨™è¨˜ç”±ä¸‹æ¸¸è™•ç†ï¼‰</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;primary&quot;</span> <span class="ow">and</span> <span class="n">zero_ratio</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;W403: æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> (primary) é›¶å€¼æ¯”ä¾‹ </span><span class="si">{</span><span class="n">zero_ratio</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;è¶…éé–¾å€¼ </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">role</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;backup&quot;</span><span class="p">,</span> <span class="s2">&quot;seasonal&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[èªæ„æ„ŸçŸ¥] æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> (role=</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">) é›¶å€¼æ¯”ä¾‹ </span><span class="si">{</span><span class="n">zero_ratio</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">ï¼Œ&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;å·²æŠ‘åˆ¶ W403 è­¦å‘Šï¼ˆå‚™ç”¨/å­£ç¯€æ€§è¨­å‚™æ­£å¸¸ï¼‰&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

<h4 id="step-33-annotation-valid_range">Step 3.3: ç‰©ç†é™åˆ¶æª¢æŸ¥ï¼ˆä½¿ç”¨ Annotation valid_rangeï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_apply_physical_constraints_semantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    æ‡‰ç”¨ç‰©ç†é™åˆ¶ï¼ˆå¾ Annotation è®€å– valid_rangeï¼Œè€Œéåƒ…ç¡¬ç·¨ç¢¼ï¼‰</span>

<span class="sd">    å„ªå…ˆé †åºï¼š</span>
<span class="sd">    1. Annotation ä¸­çš„ valid_rangeï¼ˆè‹¥å­˜åœ¨ï¼‰</span>
<span class="sd">    2. æœ¬åœ° PHYSICAL_LIMITSï¼ˆæ ¹æ“š physical_type å°æ‡‰ï¼‰</span>
<span class="sd">    3. ä¿å®ˆå…¨åŸŸé è¨­ï¼ˆè‹¥çš†ç„¡ï¼‰</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;quality_flags&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="n">col_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">:</span>
            <span class="n">col_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get_column_config</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1"># å–å¾— valid_range</span>
        <span class="n">valid_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">col_config</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">col_config</span><span class="p">,</span> <span class="s1">&#39;valid_range&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">col_config</span><span class="o">.</span><span class="n">valid_range</span><span class="p">:</span>
            <span class="n">valid_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_config</span><span class="o">.</span><span class="n">valid_range</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">col_config</span><span class="o">.</span><span class="n">valid_range</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ä½¿ç”¨æœ¬åœ°æ˜ å°„</span>
            <span class="n">physical_type</span> <span class="o">=</span> <span class="n">col_config</span><span class="o">.</span><span class="n">physical_type</span> <span class="k">if</span> <span class="n">col_config</span> <span class="k">else</span> <span class="s2">&quot;gauge&quot;</span>
            <span class="n">valid_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PHYSICAL_LIMITS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">physical_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_range</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">valid_range</span>

        <span class="c1"># æª¢æ¸¬è¶…å‡ºç¯„åœå€¼</span>
        <span class="n">is_out_of_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_val</span><span class="p">)</span>
        <span class="n">out_of_range_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_out_of_range</span><span class="p">)</span><span class="o">.</span><span class="n">height</span>

        <span class="k">if</span> <span class="n">out_of_range_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> ç™¼ç¾ </span><span class="si">{</span><span class="n">out_of_range_count</span><span class="si">}</span><span class="s2"> ç­†è¶…å‡ºç‰©ç†é™åˆ¶è³‡æ–™ &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;([</span><span class="si">{</span><span class="n">min_val</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">max_val</span><span class="si">}</span><span class="s2">])&quot;</span>
            <span class="p">)</span>

            <span class="c1"># æ¨™è¨˜ PHYSICAL_IMPOSSIBLEï¼ˆä½¿ç”¨ SSOTï¼‰</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">is_out_of_range</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">([</span><span class="n">VALID_QUALITY_FLAGS</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>  <span class="c1"># å‡è¨­ç´¢å¼• 2 ç‚º PHYSICAL_IMPOSSIBLE</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

<h4 id="step-34">Step 3.4: æ•´åˆèªæ„æ¸…æ´—æµç¨‹</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_semantic_aware_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    èªæ„æ„ŸçŸ¥æ¸…æ´—ä¸»æµç¨‹ï¼ˆè®€å– device_roleï¼Œä½†çµ•ä¸å¯«å…¥è¼¸å‡ºï¼‰</span>

<span class="sd">    æ­¤éšæ®µå¾Œï¼ŒDataFrame ä»æ‡‰ä¿æŒã€Œç´”æ·¨ã€ï¼ˆä¸å« device_role ç­‰æ¬„ä½ï¼‰ï¼Œ</span>
<span class="sd">    å¾ŒçºŒçš„ _enforce_schema_sanitization ä½œç‚ºæœ€å¾Œé˜²ç·š</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;æœªå•Ÿç”¨ Annotation æ•´åˆï¼Œè·³éèªæ„æ„ŸçŸ¥æ¸…æ´—&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;å•Ÿå‹•èªæ„æ„ŸçŸ¥æ¸…æ´—ï¼ˆdevice_role æ„ŸçŸ¥ï¼Œè¼¸å‡ºéš”é›¢ï¼‰...&quot;</span><span class="p">)</span>

    <span class="c1"># 1. å‡çµè³‡æ–™åµæ¸¬ï¼ˆè§’è‰²æ„ŸçŸ¥é–¾å€¼ï¼‰</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_frozen_data_semantic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># 2. é›¶å€¼æ¯”ä¾‹æª¢æŸ¥ï¼ˆè§’è‰²æ„ŸçŸ¥è­¦å‘ŠæŠ‘åˆ¶ï¼‰</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_zero_ratio_semantic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># 3. ç‰©ç†é™åˆ¶æª¢æŸ¥ï¼ˆä½¿ç”¨ Annotation ä¸­çš„ valid_rangeï¼‰</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_physical_constraints_semantic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># **é—œéµ**ï¼šæ­¤æ™‚ df ä»ä¸æ‡‰åŒ…å« device_roleï¼Œä½†ç‚ºé˜²è¬ä¸€ï¼Œ</span>
    <span class="c1"># æœ€çµ‚æ·¨åŒ–æœƒåœ¨ _validate_output_contract ä¸­åŸ·è¡Œ</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

<hr />
<h3 id="phase-4-day-4">Phase 4: é‡æ¡æ¨£èˆ‡ç¼ºæ¼è™•ç† (Day 4)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_resample_and_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Step 4: é‡æ¡æ¨£èˆ‡ç¼ºæ¼æ¨™è¨˜</span>

<span class="sd">    ç¢ºä¿æ™‚é–“è»¸é€£çºŒï¼Œç¼ºæ¼é»æ¨™è¨˜ INSUFFICIENT_DATA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resample</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resample</span><span class="o">.</span><span class="n">interval</span>

    <span class="c1"># å»ºç«‹å®Œæ•´æ™‚é–“è»¸</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># ä½¿ç”¨ Polars é‡æ¡æ¨£</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_sorted</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span>
        <span class="n">time_column</span><span class="o">=</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
        <span class="n">every</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="kc">None</span>  <span class="c1"># å¯ä¾éœ€æ±‚åˆ†çµ„</span>
    <span class="p">)</span>

    <span class="c1"># æ¨™è¨˜åŸæœ¬ç¼ºæ¼çš„é»ï¼ˆupsample ç”¢ç”Ÿçš„ nullï¼‰</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;quality_flags&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="c1"># è‹¥æ•¸å€¼ç‚º null ä¸” quality_flags ä¸å« INSUFFICIENT_DATAï¼Œå‰‡æ·»åŠ </span>
        <span class="n">is_missing</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">is_missing</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">([</span><span class="n">VALID_QUALITY_FLAGS</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>  <span class="c1"># å‡è¨­ INSUFFICIENT_DATA</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># å‰å‘å¡«å……ï¼ˆå¯é¸ï¼Œä¾é…ç½®ï¼‰</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resample</span><span class="o">.</span><span class="n">fill_strategy</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;forward&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

<hr />
<h3 id="phase-5-day-4-5">Phase 5: è¼¸å‡ºå¥‘ç´„å¼·åˆ¶åŸ·è¡Œ (Day 4-5, é—œéµæ›´æ–°)</h3>
<h4 id="step-51-metadata">Step 5.1: Metadata å¼·åˆ¶æ·¨åŒ–ï¼ˆç™½åå–®æ©Ÿåˆ¶ï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_build_column_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Step 7: å»ºæ§‹æ¬„ä½å…ƒè³‡æ–™ï¼ˆåš´æ ¼ç™½åå–®éæ¿¾ï¼‰</span>

<span class="sd">    ã€å¼·åˆ¶åŸ·è¡Œã€‘ä½¿ç”¨ ALLOWED_METADATA_KEYS ç™½åå–®ç¢ºä¿çµ•ä¸è¼¸å‡ºç¦æ­¢æ¬„ä½ã€‚</span>
<span class="sd">    å³ä½¿é–‹ç™¼è€…åœ¨ç¨‹å¼ç¢¼ä¸­èª¤å¯«å…¥ device_roleï¼Œä¹Ÿæœƒè¢« _sanitize_metadata_dict è‡ªå‹•ç§»é™¤ã€‚</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Dict]: åƒ…å«ç™½åå–®éµçš„ metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># å¾ Annotation è®€å–åŸå§‹è³‡è¨Šï¼ˆå¯èƒ½åŒ…å« device_role ç­‰ï¼‰</span>
        <span class="n">raw_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_raw_metadata</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1"># ã€å¼·åˆ¶åŸ·è¡Œã€‘ç™½åå–®éæ¿¾ï¼Œè‡ªå‹•ç§»é™¤ç¦æ­¢éµ</span>
        <span class="n">sanitized_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_metadata_dict</span><span class="p">(</span><span class="n">raw_meta</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

        <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sanitized_meta</span>

        <span class="c1"># é©—è­‰ï¼šç¢ºä¿éæ¿¾å¾Œç¢ºå¯¦ä¹¾æ·¨ï¼ˆé˜²ç¦¦æ€§æª¢æŸ¥ï¼‰</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">sanitized_meta</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALLOWED_METADATA_KEYS</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;å…§éƒ¨éŒ¯èª¤ï¼šæ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> çš„ metadata ä»æœ‰éç™½åå–®éµ&quot;</span>

    <span class="k">return</span> <span class="n">metadata</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_extract_raw_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    æå–åŸå§‹ metadataï¼ˆå¯èƒ½åŒ…å«ç¦æ­¢éµï¼Œéœ€å¾ŒçºŒæ·¨åŒ–ï¼‰</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;column_name&quot;</span><span class="p">:</span> <span class="n">col_name</span><span class="p">,</span>
            <span class="s2">&quot;physical_type&quot;</span><span class="p">:</span> <span class="s2">&quot;gauge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;æœªå®šç¾©æ¬„ä½&quot;</span>
        <span class="p">}</span>

    <span class="n">col_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get_column_config</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">col_config</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;column_name&quot;</span><span class="p">:</span> <span class="n">col_name</span><span class="p">,</span>
            <span class="s2">&quot;physical_type&quot;</span><span class="p">:</span> <span class="n">col_config</span><span class="o">.</span><span class="n">physical_type</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">col_config</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">col_config</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="c1"># å±éšªï¼šè‹¥é–‹ç™¼è€…åœ¨æ­¤åŠ å…¥ device_roleï¼Œæœƒè¢«å¾ŒçºŒæ·¨åŒ–ç§»é™¤</span>
            <span class="c1"># &quot;device_role&quot;: col_config.device_role,  # éŒ¯èª¤ç¤ºç¯„ï¼Œå°‡è¢«ç™½åå–®éæ¿¾</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># æœªå®šç¾©æ¬„ä½ï¼ˆè‹¥ policy=warnï¼‰</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;column_name&quot;</span><span class="p">:</span> <span class="n">col_name</span><span class="p">,</span>
            <span class="s2">&quot;physical_type&quot;</span><span class="p">:</span> <span class="s2">&quot;gauge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;æœªå®šç¾©æ¬„ä½ï¼ˆä¿å®ˆé è¨­ï¼‰&quot;</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div>

<h4 id="step-52-schema">Step 5.2: Schema å¼·åˆ¶æ·¨åŒ–èˆ‡å¥‘ç´„é©—è­‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_validate_output_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Step 6: æœ€çµ‚è¼¸å‡ºé©—è­‰èˆ‡å¼·åˆ¶æ·¨åŒ– (Interface Contract Enforcement)</span>

<span class="sd">    æ­¤ç‚ºä¸‰å±¤é˜²è­·çš„æœ€å¾Œä¸€å±¤ï¼Œç¢ºä¿ç„¡è«–å‰æœŸé‚è¼¯å¦‚ä½•ï¼Œè¼¸å‡ºçµ•å°ç¬¦åˆå¥‘ç´„ã€‚</span>

<span class="sd">    åŸ·è¡Œé …ç›®:</span>
<span class="sd">    1. æ™‚é–“æˆ³æ ¼å¼é©—è­‰ (UTC, ns)</span>
<span class="sd">    2. quality_flags å‹åˆ¥èˆ‡å…§å®¹é©—è­‰</span>
<span class="sd">    3. **å¼·åˆ¶åŸ·è¡Œ**ï¼šSchema æ·¨åŒ–ï¼ˆç§»é™¤ FORBIDDEN_COLSï¼‰</span>
<span class="sd">    4. è³‡æ–™æ¬„ä½å‹åˆ¥æª¢æŸ¥ (Float64)</span>
<span class="sd">    5. ç„¡æœªä¾†è³‡æ–™äºŒæ¬¡ç¢ºèª</span>

<span class="sd">    Returns:</span>
<span class="sd">        æ·¨åŒ–å¾Œçš„ DataFrameï¼ˆä¿è­‰ä¸å«ç¦æ­¢æ¬„ä½ï¼‰</span>

<span class="sd">    Raises:</span>
<span class="sd">        ContractViolationError: åƒ…åœ¨ç„¡æ³•æ·¨åŒ–ï¼ˆå¦‚æ¬„ä½ç‚º Primary Keyï¼‰æ™‚æ‹‹å‡º</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 1. æ™‚é–“æˆ³æª¢æŸ¥</span>
    <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ç¼ºå°‘å¿…è¦æ¬„ä½ &#39;timestamp&#39;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts_dtype</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ts_dtype</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;timestamp é¡å‹éŒ¯èª¤: </span><span class="si">{</span><span class="n">ts_dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ts_dtype</span><span class="o">.</span><span class="n">time_zone</span> <span class="o">!=</span> <span class="s2">&quot;UTC&quot;</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;timestamp æ™‚å€éŒ¯èª¤: </span><span class="si">{</span><span class="n">ts_dtype</span><span class="o">.</span><span class="n">time_zone</span><span class="si">}</span><span class="s2">ï¼ˆæ‡‰ç‚º UTCï¼‰&quot;</span><span class="p">)</span>

    <span class="c1"># 2. quality_flags æª¢æŸ¥</span>
    <span class="k">if</span> <span class="s2">&quot;quality_flags&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ç¼ºå°‘å¿…è¦æ¬„ä½ &#39;quality_flags&#39;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># é©—è­‰æ‰€æœ‰ flags çš†åœ¨ SSOT ä¸­</span>
        <span class="n">all_flags</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">invalid_flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_flags</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">VALID_QUALITY_FLAGS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_flags</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ç™¼ç¾éæ³•å“è³ªæ¨™è¨˜: </span><span class="si">{</span><span class="n">invalid_flags</span><span class="si">}</span><span class="s2">ï¼ˆä¸åœ¨ SSOTï¼‰&quot;</span><span class="p">)</span>

    <span class="c1"># 3. ã€å¼·åˆ¶åŸ·è¡Œã€‘Schema æ·¨åŒ–ï¼ˆæ ¸å¿ƒæ›´æ–°ï¼‰</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_schema_sanitization</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># 4. è³‡æ–™æ¬„ä½å‹åˆ¥æª¢æŸ¥</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;quality_flags&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ¬„ä½ &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; é¡å‹ç‚º </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">ï¼ˆæ‡‰ç‚º Float64ï¼‰&quot;</span><span class="p">)</span>

    <span class="c1"># 5. æœªä¾†è³‡æ–™äºŒæ¬¡ç¢ºèªï¼ˆåš´æ ¼æ¨¡å¼ï¼‰</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;E102: è¼¸å‡ºä»åŒ…å«æœªä¾†è³‡æ–™ï¼ˆæ™‚åºé˜²è­·å¤±æ•ˆï¼‰&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cleaner è¼¸å‡ºå¥‘ç´„é©—è­‰å¤±æ•— (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2"> é …):</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;è¼¸å‡ºå¥‘ç´„é©—è­‰é€šéï¼š</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> æ¬„ä½ï¼Œ&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;å·²åŸ·è¡Œ Schema æ·¨åŒ–ï¼ˆç¦æ­¢æ¬„ä½æª¢æŸ¥ï¼‰&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

<hr />
<h2 id="4-call-chain">4. å®Œæ•´æ–¹æ³•å‘¼å«éˆ (Call Chain)</h2>
<div class="codehilite"><pre><span></span><code><span class="n">clean</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="w"> </span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="w"> </span><span class="n">Dict</span><span class="p">]</span>
<span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_validate_columns_annotated</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">      </span><span class="c1"># Step 0: E402 æª¢æŸ¥</span>
<span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_normalize_timestamp</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">             </span><span class="c1"># Step 1: æ™‚å€æ¨™æº–åŒ– (UTC)</span>
<span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_check_future_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">               </span><span class="c1"># Step 2: æœªä¾†è³‡æ–™æª¢æŸ¥ (E102)</span>
<span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_semantic_aware_cleaning</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">         </span><span class="c1"># Step 3: èªæ„æ„ŸçŸ¥æ¸…æ´—ï¼ˆè®€å– roleï¼‰</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_detect_frozen_data_semantic</span><span class="p">()</span><span class="w">      </span><span class="c1"># èª¿æ•´é–¾å€¼ï¼Œä½†ä¸å¯«å…¥ role</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_check_zero_ratio_semantic</span><span class="p">()</span><span class="w">        </span><span class="c1"># æŠ‘åˆ¶è­¦å‘Šï¼Œä½†ä¸å¯«å…¥ role</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">_apply_physical_constraints_semantic</span><span class="p">()</span>
<span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_resample_and_fill</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">               </span><span class="c1"># Step 4: é‡æ¡æ¨£èˆ‡ç¼ºæ¼æ¨™è¨˜</span>
<span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_validate_quality_flags</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">          </span><span class="c1"># Step 5: Flags åˆæ³•æ€§é©—è­‰ (E103)</span>
<span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_validate_output_contract</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">        </span><span class="c1"># Step 6: **å¼·åˆ¶åŸ·è¡Œ** Schemaæ·¨åŒ–</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">_enforce_schema_sanitization</span><span class="p">()</span><span class="w">      </span><span class="c1"># ç§»é™¤ FORBIDDEN_COLS</span>
<span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">_build_column_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">           </span><span class="c1"># Step 7: **å¼·åˆ¶åŸ·è¡Œ** ç™½åå–®éæ¿¾</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">_sanitize_metadata_dict</span><span class="p">()</span><span class="w">           </span><span class="c1"># ç§»é™¤éç™½åå–®éµ</span>
<span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">clean_df</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w">          </span><span class="c1"># ä¿è­‰çµ•å°ä¸å« device_role</span>
</code></pre></div>

<hr />
<h2 id="5-error-codes-">5. éŒ¯èª¤ä»£ç¢¼å°ç…§è¡¨ (Error Codes) - å¼·åˆ¶åŸ·è¡Œç‰ˆ</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤ä»£ç¢¼</th>
<th style="text-align: left;">åç¨±</th>
<th style="text-align: center;">ç™¼ç”Ÿéšæ®µ</th>
<th style="text-align: left;">èªªæ˜</th>
<th style="text-align: left;">è™•ç†å»ºè­°</th>
<th style="text-align: center;">åš´é‡åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>E101</strong></td>
<td style="text-align: left;"><code>TIMEZONE_MISMATCH</code></td>
<td style="text-align: center;">Step 1</td>
<td style="text-align: left;">è¼¸å…¥æ™‚å€é UTCï¼Œå·²è‡ªå‹•è½‰æ›</td>
<td style="text-align: left;">ç¢ºèª Parser ç‰ˆæœ¬ï¼Œå»ºè­°å‡ç´šè‡³ v2.1</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E102</strong></td>
<td style="text-align: left;"><code>FUTURE_DATA_DETECTED</code></td>
<td style="text-align: center;">Step 2</td>
<td style="text-align: left;">è³‡æ–™æ™‚é–“è¶…éç¾åœ¨æ™‚é–“+5åˆ†é˜</td>
<td style="text-align: left;">æª¢æŸ¥ç³»çµ±æ™‚é˜èˆ‡è³‡æ–™ä¾†æºæ™‚é–“è¨­å®š</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E103</strong></td>
<td style="text-align: left;"><code>UNKNOWN_QUALITY_FLAG</code></td>
<td style="text-align: center;">Step 5</td>
<td style="text-align: left;">ç”¢ç”Ÿéæ³•å“è³ªæ¨™è¨˜ (ä¸åœ¨ SSOT)</td>
<td style="text-align: left;">æª¢æŸ¥ç¨‹å¼ç¢¼ç¡¬ç·¨ç¢¼ï¼Œæ›´æ–° config_models</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E104</strong></td>
<td style="text-align: left;"><code>UNIT_CONVERSION_ERROR</code></td>
<td style="text-align: center;">Phase 3</td>
<td style="text-align: left;">å–®ä½è½‰æ›å¤±æ•—</td>
<td style="text-align: left;">æª¢æŸ¥è¼¸å…¥è³‡æ–™å–®ä½æ¨™è¨»</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E105</strong></td>
<td style="text-align: left;"><code>ENCODING_WARNING</code></td>
<td style="text-align: center;">è¼¸å…¥æª¢æŸ¥</td>
<td style="text-align: left;">ç™¼ç¾ BOM æ®˜ç•™</td>
<td style="text-align: left;">ç¢ºèª Parser ç·¨ç¢¼è™•ç†é‚è¼¯</td>
<td style="text-align: center;">ğŸŸ¢ Low</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E402</strong></td>
<td style="text-align: left;"><code>UNANNOTATED_COLUMN</code></td>
<td style="text-align: center;">Step 0</td>
<td style="text-align: left;">è³‡æ–™æ¬„ä½æœªå®šç¾©æ–¼ Annotation</td>
<td style="text-align: left;">åŸ·è¡Œ <code>features wizard</code> é€²è¡Œæ¨™è¨»</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E407</strong></td>
<td style="text-align: left;"><code>CIRCULAR_INHERITANCE</code></td>
<td style="text-align: center;">(Manager)</td>
<td style="text-align: left;">Annotation ç¹¼æ‰¿å¾ªç’°</td>
<td style="text-align: left;">æª¢æŸ¥ YAML inherit æ¬„ä½</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E500</strong></td>
<td style="text-align: left;"><code>OUTPUT_CONTRACT_VIOLATION</code></td>
<td style="text-align: center;">Step 6</td>
<td style="text-align: left;">è¼¸å‡ºåŒ…å«ç„¡æ³•æ·¨åŒ–çš„ç¦æ­¢æ¬„ä½</td>
<td style="text-align: left;">æª¢æŸ¥æ˜¯å¦æœ‰æ¬„ä½ç‚º Primary Key ä¸”è¢«ç¦æ­¢</td>
<td style="text-align: center;">ğŸ”´ <strong>Critical</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>E501</strong></td>
<td style="text-align: left;"><code>METADATA_WHITELIST_VIOLATION</code></td>
<td style="text-align: center;">Step 7</td>
<td style="text-align: left;">Metadata åŒ…å«ç„¡æ³•ç§»é™¤çš„ç¦æ­¢éµ</td>
<td style="text-align: left;">å…§éƒ¨éŒ¯èª¤ï¼Œæª¢æŸ¥ _sanitize_metadata_dict å¯¦ä½œ</td>
<td style="text-align: center;">ğŸ”´ <strong>Critical</strong></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-test-plan-">6. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Test Plan) - å¼·åˆ¶åŸ·è¡Œç‰ˆ</h2>
<h3 id="61-unit-tests-">6.1 å–®å…ƒæ¸¬è©¦ (Unit Tests) - æ–°å¢å¼·åˆ¶åŸ·è¡Œæ¸¬è©¦</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸè¼¸å‡º</th>
<th style="text-align: center;">å°æ‡‰ Step</th>
<th style="text-align: center;">CI/CD å±¬æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">C22-001</td>
<td style="text-align: left;">æ™‚å€ç›´æ¥é€šé</td>
<td style="text-align: left;">UTC è¼¸å…¥</td>
<td style="text-align: left;">ç„¡è½‰æ›ï¼Œç›´æ¥é€šé</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;">C22-002</td>
<td style="text-align: left;">æ™‚å€è‡ªå‹•è½‰æ›</td>
<td style="text-align: left;">Asia/Taipei è¼¸å…¥</td>
<td style="text-align: left;">æ­£ç¢ºè½‰ UTCï¼Œç™¼ E101</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;">C22-003</td>
<td style="text-align: left;">æœªä¾†è³‡æ–™æ””æˆª</td>
<td style="text-align: left;">æ™‚é–“æˆ³ç‚ºæ˜å¤©</td>
<td style="text-align: left;">æ‹‹å‡º E102</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>C22-FA-01</strong></td>
<td style="text-align: left;">æœªå®šç¾©æ¬„ä½è™•ç† (error)</td>
<td style="text-align: left;">CSV å«æœªæ¨™è¨»æ¬„ä½</td>
<td style="text-align: left;">æ‹‹å‡º E402</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>C22-FA-02</strong></td>
<td style="text-align: left;">æœªå®šç¾©æ¬„ä½è™•ç† (skip)</td>
<td style="text-align: left;">policy=skip</td>
<td style="text-align: left;">è·³éæ¸…æ´—ï¼Œæ¬„ä½ä¿ç•™ä½†ä¸æ¨™è¨˜</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>C22-FA-03</strong></td>
<td style="text-align: left;">å‡çµæª¢æ¸¬ (Primary)</td>
<td style="text-align: left;">é€£çºŒ 3 ç­†ç›¸åŒå€¼ï¼Œrole=primary</td>
<td style="text-align: left;">æ¨™è¨˜ FROZEN</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>C22-FA-04</strong></td>
<td style="text-align: left;">å‡çµæª¢æ¸¬ (Backup)</td>
<td style="text-align: left;">é€£çºŒ 3 ç­†ç›¸åŒå€¼ï¼Œrole=backup</td>
<td style="text-align: left;"><strong>ä¸æ¨™è¨˜</strong> FROZENï¼ˆé–¾å€¼æ”¾å¯¬ï¼‰</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>âš ï¸ C22-FA-05</strong></td>
<td style="text-align: left;"><strong>è·è²¬åˆ†é›¢ Gate Test</strong></td>
<td style="text-align: left;">è¼¸å‡º DataFrame schema</td>
<td style="text-align: left;"><strong>çµ•å°ä¸åŒ…å«</strong> device_role æ¬„ä½</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;"><strong>ğŸ”´ Blocker</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>âš ï¸ C22-FA-06</strong></td>
<td style="text-align: left;"><strong>Metadata Gate Test</strong></td>
<td style="text-align: left;">è¼¸å‡º metadata dict</td>
<td style="text-align: left;">åƒ…å«ç™½åå–®éµ</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;"><strong>ğŸ”´ Blocker</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>C22-FA-07</strong></td>
<td style="text-align: left;"><strong>å¼·åˆ¶æ·¨åŒ–æœ‰æ•ˆæ€§</strong></td>
<td style="text-align: left;">æ‰‹å‹•æ³¨å…¥ç¦æ­¢æ¬„ä½</td>
<td style="text-align: left;">è‡ªå‹•æ¸…é™¤ï¼Œæµç¨‹ä¸ä¸­æ–·</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;"><strong>ğŸ”´ Blocker</strong></td>
</tr>
<tr>
<td style="text-align: left;">C22-008</td>
<td style="text-align: left;">SSOT Flags é©—è­‰</td>
<td style="text-align: left;">ç¡¬ç·¨ç¢¼éæ³• flag</td>
<td style="text-align: left;">æ‹‹å‡º E103</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">Standard</td>
</tr>
</tbody>
</table>
<h3 id="62-integration-tests">6.2 æ•´åˆæ¸¬è©¦ (Integration Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: center;">ä¸Šæ¸¸</th>
<th style="text-align: center;">ä¸‹æ¸¸</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
<th style="text-align: center;">å±¬æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">INT-C01</td>
<td style="text-align: left;">Parser v2.1 â†’ Cleaner v2.2</td>
<td style="text-align: center;">Parser v2.1 (UTC)</td>
<td style="text-align: center;">Cleaner v2.2</td>
<td style="text-align: left;">ç„¡éœ€æ™‚å€è½‰æ›</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-C-FA-01</strong></td>
<td style="text-align: left;"><strong>Annotation æ•´åˆæµç¨‹</strong></td>
<td style="text-align: center;">CSV + Annotation</td>
<td style="text-align: center;">Cleaner v2.2</td>
<td style="text-align: left;">æ­£ç¢ºè®€å– roleï¼Œè¼¸å‡ºä¸å« role</td>
<td style="text-align: center;"><strong>ğŸ”´ Blocker</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-C-FA-02</strong></td>
<td style="text-align: left;"><strong>Backup è¨­å‚™æ¸…æ´—</strong></td>
<td style="text-align: center;">backup è¨­å‚™é•·æœŸ 0 å€¼</td>
<td style="text-align: center;">Cleaner â†’ BP</td>
<td style="text-align: left;">ä¸æ¨™è¨˜ FROZEN/W403</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;">INT-C02</td>
<td style="text-align: left;">Cleaner â†’ BatchProcessor</td>
<td style="text-align: center;">Cleaner v2.2</td>
<td style="text-align: center;">BP v1.3</td>
<td style="text-align: left;">Manifest æ­£ç¢ºæ¥æ”¶ metadata</td>
<td style="text-align: center;">Standard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-C-FA-03</strong></td>
<td style="text-align: left;"><strong>å¼·åˆ¶æ·¨åŒ–ç«¯åˆ°ç«¯</strong></td>
<td style="text-align: center;">æ¨¡æ“¬èª¤å¯«å…¥å ´æ™¯</td>
<td style="text-align: center;">Full Pipeline</td>
<td style="text-align: left;">ç¦æ­¢æ¬„ä½è¢«æ·¨åŒ–ï¼Œä¸å½±éŸ¿ä¸‹æ¸¸</td>
<td style="text-align: center;"><strong>ğŸ”´ Blocker</strong></td>
</tr>
</tbody>
</table>
<h3 id="63-cicd">6.3 CI/CD é…ç½®è¦æ±‚</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/required-checks.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Required Architecture Checks</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cleaner-output-contract</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run Cleaner Output Contract Tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/test_cleaner_output_contract.py::TestCleanerOutputContractEnforcement -v</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Block Merge on Failure</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">failure()</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">echo &quot;::error::C22-FA-05 æˆ– C22-FA-06 æ¸¬è©¦å¤±æ•—ï¼šè·è²¬åˆ†é›¢æ©Ÿåˆ¶è¢«ç ´å£ï¼Œç¦æ­¢åˆä½µ&quot;</span>
<span class="w">          </span><span class="no">exit 1</span>
</code></pre></div>

<hr />
<h2 id="7-risk-assessment-">7. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£ (Risk Assessment) - å¼·åˆ¶åŸ·è¡Œç‰ˆ</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢¨éšª</th>
<th style="text-align: center;">åš´é‡åº¦</th>
<th style="text-align: center;">å¯èƒ½æ€§</th>
<th style="text-align: left;">ç·©è§£æªæ–½</th>
<th style="text-align: center;">ç‹€æ…‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>è·è²¬é‚Šç•Œæ··æ·†</strong> (é–‹ç™¼è€…èª¤å°‡ device_role å¯«å…¥è¼¸å‡º)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;"><strong>ä¸‰å±¤é˜²è­·</strong>ï¼šç™½åå–®è‡ªå‹•éæ¿¾ + Schema è‡ªå‹•æ¸…é™¤ + CI Gate é˜»æ“‹åˆä½µ</td>
<td style="text-align: center;">å·²å¯¦ä½œ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç™½åå–®ç¹éé¢¨éšª</strong> (é–‹ç™¼è€…ç›´æ¥æ“ä½œ dict ç¹é <code>_sanitize_metadata_dict</code>)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;"><strong>Code Review æª¢æŸ¥æ¸…å–®</strong>ï¼šæª¢æŸ¥æ‰€æœ‰ metadata æ“ä½œæ˜¯å¦ç¶“éç™½åå–®å‡½æ•¸</td>
<td style="text-align: center;">æµç¨‹ç®¡æ§</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ•ˆèƒ½å½±éŸ¿</strong> (Schema æ·¨åŒ–å¢åŠ é¡å¤– select æ“ä½œ)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;"><strong>Polars é›¶è¤‡è£½ç‰¹æ€§</strong>ï¼šselect æ“ä½œç‚º O(1) æŒ‡æ¨™æ“ä½œï¼Œç„¡è³‡æ–™è¤‡è£½</td>
<td style="text-align: center;">å·²é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Annotation æœªè¼‰å…¥</strong> (Manager ç‚º None ä½† config å•Ÿç”¨)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;"><strong>å»ºæ§‹å­å¼·åˆ¶æª¢æŸ¥</strong>ï¼šæ‹‹å‡º ConfigurationError (E402)</td>
<td style="text-align: center;">å·²å¯¦ä½œ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ™‚å€è½‰æ›æ•ˆèƒ½</strong> (å¤§æª”æ¡ˆæ™‚å€è½‰æ›è€—æ™‚)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">Parser v2.1 è¼¸å‡º UTCï¼Œæ­£å¸¸ç„¡éœ€è½‰æ›ï¼›èˆŠç‰ˆè³‡æ–™è½‰æ›æ™‚è¨˜éŒ„ Warning</td>
<td style="text-align: center;">å·²å¯¦ä½œ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Backup è¨­å‚™èª¤åˆ¤</strong> (æ­£å¸¸åœæ©Ÿè¢«æ¨™è¨˜ç•°å¸¸)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;">å·²å¯¦ä½œ role æ„ŸçŸ¥é–¾å€¼ï¼›å¯é…ç½® <code>frozen_multiplier</code>ï¼›è¨˜éŒ„èª¿æ•´æ—¥èªŒä¾›ç¨½æ ¸</td>
<td style="text-align: center;">å·²å¯¦ä½œ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSOT ç‰ˆæœ¬ä¸åŒ¹é…</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">CI/CD æª¢æŸ¥ç¢ºä¿æ‰€æœ‰æ¨¡çµ„å¼•ç”¨ç›¸åŒ commit çš„ config_models</td>
<td style="text-align: center;">æµç¨‹ç®¡æ§</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-deliverables">8. äº¤ä»˜ç‰©æ¸…å–® (Deliverables)</h2>
<h3 id="81">8.1 ç¨‹å¼ç¢¼æª”æ¡ˆ</h3>
<ol>
<li><code>src/etl/cleaner.py</code> - ä¸»è¦å¯¦ä½œ (v2.2-FA-ENFORCEï¼Œå«ä¸‰å±¤å¼·åˆ¶åŸ·è¡Œæ©Ÿåˆ¶)</li>
<li><code>src/etl/config_models.py</code> - æ“´å……ï¼ˆç§»é™¤ <code>default_device_role</code>ï¼Œæ–°å¢ <code>unannotated_column_policy</code>ï¼‰</li>
<li><code>src/utils/physics.py</code> - ç†±å¹³è¡¡è¨ˆç®—ç­‰ç‰©ç†å…¬å¼ï¼ˆè‹¥æœ‰æ›´æ–°ï¼‰</li>
</ol>
<h3 id="82">8.2 æ¸¬è©¦æª”æ¡ˆï¼ˆå¼·åˆ¶åŸ·è¡Œç›¸é—œï¼‰</h3>
<ol>
<li><code>tests/test_cleaner_v22_fa.py</code> - v2.2-FA å°ˆå±¬æ¸¬è©¦ï¼ˆå«èªæ„æ„ŸçŸ¥ï¼‰</li>
<li><code>tests/test_cleaner_output_contract.py</code> - <strong>æ–°å¢</strong>ï¼šè¼¸å‡ºå¥‘ç´„å¼·åˆ¶åŸ·è¡Œæ¸¬è©¦ï¼ˆCI/CD Blockerï¼‰</li>
<li><code>tests/test_cleaner_schema_sanitization.py</code> - <strong>æ–°å¢</strong>ï¼šSchema æ·¨åŒ–æ©Ÿåˆ¶å–®å…ƒæ¸¬è©¦</li>
<li><code>tests/test_cleaner_whitelist_enforcement.py</code> - <strong>æ–°å¢</strong>ï¼šMetadata ç™½åå–®å¼·åˆ¶éæ¿¾æ¸¬è©¦</li>
</ol>
<h3 id="83">8.3 æ–‡ä»¶æª”æ¡ˆ</h3>
<ol>
<li><code>docs/cleaner/PRD_CLEANER_v2.2-FA-ENFORCE.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/cleaner/MIGRATION_v21_to_v22_FA_ENFORCE.md</code> - å‡ç´šæŒ‡å¼•ï¼ˆå¼·èª¿å¼·åˆ¶åŸ·è¡Œæ©Ÿåˆ¶èˆ‡ CI/CD é…ç½®ï¼‰</li>
<li><code>docs/cleaner/SEPARATION_OF_CONCERNS_SOP.md</code> - <strong>æ–°å¢</strong>ï¼šè·è²¬åˆ†é›¢æ¨™æº–ä½œæ¥­ç¨‹åºï¼ˆé˜²æ­¢èª¤å¯«å…¥æŒ‡å—ï¼‰</li>
</ol>
<h3 id="84-cicd">8.4 CI/CD é…ç½®</h3>
<ol>
<li><code>.github/workflows/required-checks.yml</code> - <strong>æ–°å¢</strong>ï¼šå¼·åˆ¶åŸ·è¡Œæ¸¬è©¦ Gate é…ç½®</li>
</ol>
<hr />
<h2 id="9-sign-off-checklist-">9. é©—æ”¶ç°½æ ¸ (Sign-off Checklist) - å¼·åˆ¶åŸ·è¡Œç‰ˆ</h2>
<ul>
<li>[ ] <strong>æ™‚å€è™•ç†</strong>: æ¥æ”¶ UTC ç›´æ¥é€šéï¼Œæ¥æ”¶ Asia/Taipei æ­£ç¢ºè½‰æ›ä¸¦ç™¼ Warning (E101)</li>
<li>[ ] <strong>SSOT å¼•ç”¨</strong>: ç„¡ç¡¬ç·¨ç¢¼ flagsï¼Œæ‰€æœ‰æ¨™è¨˜ç”¢ç”Ÿå‡ä½¿ç”¨ <code>VALID_QUALITY_FLAGS</code></li>
<li>[ ] <strong>E402 è™•ç†</strong>: æœªå®šç¾©æ¬„ä½ä¾ <code>unannotated_column_policy</code> æ­£ç¢ºè™•ç†ï¼ˆerror/skip/warnï¼‰</li>
<li>[ ] <strong>è·è²¬åˆ†é›¢å¼·åˆ¶åŸ·è¡Œï¼ˆä¸‰å±¤é˜²è­·ï¼‰</strong>: </li>
<li>[ ] <strong>ç¬¬ä¸€å±¤ï¼ˆç™½åå–®ï¼‰</strong>: <code>ALLOWED_METADATA_KEYS</code> é‹ä½œæ­£å¸¸ï¼Œç¦æ­¢éµè‡ªå‹•ç§»é™¤ä¸”è¨˜éŒ„ Warning</li>
<li>[ ] <strong>ç¬¬äºŒå±¤ï¼ˆSchema æ·¨åŒ–ï¼‰</strong>: <code>FORBIDDEN_COLS</code> è‡ªå‹•æ¸…é™¤ï¼Œå³ä½¿æ‰‹å‹•æ³¨å…¥ç¦æ­¢æ¬„ä½ä¹Ÿæœ‰æ•ˆç§»é™¤</li>
<li>[ ] <strong>ç¬¬ä¸‰å±¤ï¼ˆCI Gateï¼‰</strong>: <code>test_cleaner_output_no_device_role</code> é…ç½®ç‚º Required Status Checkï¼Œå¤±æ•—é˜»æ“‹åˆä½µ</li>
<li>[ ] <strong>èªæ„æ„ŸçŸ¥</strong>: Backup è¨­å‚™çš„é«˜é›¶å€¼/å‡çµè³‡æ–™æ­£ç¢ºæŠ‘åˆ¶ç•°å¸¸æ¨™è¨˜ï¼ˆä¸æ¨™è¨˜ FROZEN/W403ï¼‰</li>
<li>[ ] <strong>ç‰©ç†é©—è­‰</strong>: ç†±å¹³è¡¡ã€å‡çµåµæ¸¬ã€ç‰©ç†é™åˆ¶æª¢æŸ¥æ­£ç¢ºé‹ä½œï¼Œä½¿ç”¨ Annotation ä¸­çš„ valid_range</li>
<li>[ ] <strong>æ™‚é–“è»¸</strong>: é‡æ¡æ¨£å¾Œæ™‚é–“è»¸é€£çºŒï¼Œç¼ºæ¼é»æ¨™è¨˜ <code>INSUFFICIENT_DATA</code></li>
<li>[ ] <strong>è¼¸å‡ºå¥‘ç´„</strong>: é€šé <code>_validate_output_contract</code>ï¼ŒåŒ…å« <code>quality_flags: List[str]</code> èˆ‡å¼·åˆ¶æ·¨åŒ–å¾Œçš„ schema</li>
<li>[ ] <strong>Metadata</strong>: æ­£ç¢ºç”¢ç”Ÿä¸¦å‚³é <code>column_metadata</code> çµ¦ BatchProcessorï¼ˆç¶“ç™½åå–®éæ¿¾ï¼Œåƒ…å« physical_type, unit ç­‰ï¼‰</li>
<li>[ ] <strong>é˜²ç¦¦æ€§é©—è­‰</strong>: æ‰‹å‹•æ¸¬è©¦ã€Œæ•…æ„å¯«å…¥ device_roleã€åœºæ™¯ï¼Œé©—è­‰ç³»çµ±è‡ªå‹•æ·¨åŒ–ä¸”ä¸æ‹‹éŒ¯ï¼ˆåƒ…è¨˜éŒ„ Warningï¼‰</li>
</ul>
<hr />
<p><strong>æ–‡ä»¶çµæŸ</strong></p>
<p><strong>é‡è¦æé†’</strong>ï¼šæœ¬ç‰ˆæœ¬ PRD å·²å°‡ã€Œè·è²¬åˆ†é›¢ã€å¾<strong>å»ºè­°æ€§è¦ç¯„</strong>æå‡ç‚º<strong>æŠ€è¡“å¼·åˆ¶æ©Ÿåˆ¶</strong>ï¼Œé€éç™½åå–®ã€Schema æ·¨åŒ–èˆ‡ CI/CD Gate ä¸‰å±¤é˜²è­·ï¼Œç¢ºä¿ <code>device_role</code> çµ•å°ä¸æœƒæ´©æ¼è‡³ä¸‹æ¸¸æ¨¡çµ„ã€‚ä»»ä½•è©¦åœ–ç¹éé€™äº›æ©Ÿåˆ¶çš„ç¨‹å¼ç¢¼è®Šæ›´ï¼Œçš†æœƒè¢«è‡ªå‹•åŒ–æ¸¬è©¦é˜»æ“‹ã€‚</p>
    
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>

</body>
</html>
