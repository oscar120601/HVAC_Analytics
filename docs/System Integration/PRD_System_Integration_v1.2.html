
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PRD_System_Integration_v1.2</title>
    
<style>
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
        line-height: 1.6; 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        color: #24292e; 
        background-color: #ffffff;
    }
    h1, h2, h3, h4, h5, h6 { 
        margin-top: 24px; 
        margin-bottom: 16px; 
        font-weight: 600; 
        color: #24292e;
    }
    h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h3 { font-size: 1.25em; }
    p { margin-top: 0; margin-bottom: 16px; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { 
        display: block; 
        width: 100%; 
        overflow: auto; 
        border-spacing: 0; 
        border-collapse: collapse; 
        margin-bottom: 16px; 
    }
    table th, table td { 
        padding: 6px 13px; 
        border: 1px solid #dfe2e5; 
    }
    table th { 
        font-weight: 600; 
        background-color: #f6f8fa; 
    }
    table tr:nth-child(2n) { 
        background-color: #f6f8fa; 
    }
    code { 
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace; 
        background-color: #f6f8fa; 
        padding: 0.2em 0.4em; 
        border-radius: 3px; 
        font-size: 85%; 
    }
    pre { 
        background-color: #f6f8fa; 
        padding: 16px; 
        overflow: auto; 
        border-radius: 3px; 
        line-height: 1.45; 
    }
    pre code { 
        background-color: transparent; 
        padding: 0; 
        border-radius: 0; 
    }
    blockquote { 
        border-left: 0.25em solid #dfe2e5; 
        color: #6a737d; 
        padding: 0 1em; 
        margin: 0 0 16px 0; 
    }
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
    }
    .mermaid {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
</style>

</head>
<body>
    <h1 id="prd-v12-system-integration-architecture">PRD v1.2: 系統整合架構 (System Integration Architecture)</h1>
<h1 id="feature-annotation-v12">整合 Feature Annotation v1.2 + 初始化順序控制 + 時間基準同步機制</h1>
<p><strong>文件版本:</strong> v1.2 (Ordered Initialization &amp; Temporal Consistency)<br />
<strong>日期:</strong> 2026-02-13<br />
<strong>負責人:</strong> Oscar Chang<br />
<strong>目標模組:</strong> <code>src/container.py</code>, <code>src/main.py</code>, <code>src/utils/config_loader.py</code>, <code>src/features/annotation_manager.py</code>, <code>src/context.py</code><br />
<strong>相依模組:</strong> 
- Parser v2.1+, Cleaner v2.2+, BatchProcessor v1.3+, Feature Engineer v1.3+
- Feature Annotation v1.2 (Excel-Centric SSOT)
- <strong>Interface Contract v1.1</strong> (錯誤代碼分層與時間基準規範)
<strong>預估工時:</strong> 6 ~ 7 個工程天（含併發控制與順序驗證測試）</p>
<hr />
<h2 id="1">1. 執行總綱與設計哲學</h2>
<h3 id="11">1.1 核心目標</h3>
<p>建立<strong>零間隙對接</strong>且<strong>時空一致</strong>的完整 ETL Pipeline，強化系統穩定性：</p>
<ol>
<li><strong>配置單一真相源 (SSOT)</strong>: </li>
<li>運行時配置：<code>ETLConfig</code> 實例</li>
<li>特徵定義：<strong>Excel 唯一編輯</strong> → YAML SSOT → Pipeline 消費</li>
<li><strong>嚴格初始化順序 (Critical)</strong>: <strong>E406驗證 → Manager初始化 → 其他模組</strong>，防止Race Condition與策略失效</li>
<li><strong>全域時間基準 (Pipeline Timestamp)</strong>: 統一<code>pipeline_timestamp</code>，防止Pipeline執行期間的「未來資料」漂移誤判</li>
<li><strong>併發控制</strong>: YAML檔案讀寫鎖，防止Wizard與Pipeline同時存取SSOT</li>
<li><strong>依賴注入 (DI)</strong>: 透過 <code>Container</code> 管理模組生命周期，包含 <code>FeatureAnnotationManager</code></li>
<li><strong>契約檢查點</strong>: 6 個關鍵檢查點（新增 Annotation 同步檢查 #5, #6）</li>
</ol>
<h3 id="12-v12">1.2 架構概覽（v1.2 更新）</h3>
<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="w"> </span><span class="n">TB</span>
<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;Initialization Phase (Sequential)&quot;</span>
<span class="w">        </span><span class="n">INIT1</span><span class="p">[</span><span class="n">Step</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">產生</span><span class="w"> </span><span class="n">PipelineContext</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">鎖定</span><span class="w"> </span><span class="n">pipeline_timestamp</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">INIT2</span><span class="p">[</span><span class="n">Step</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="n">E406</span><span class="w"> </span><span class="n">同步驗證</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">檔案鎖定防止併發</span><span class="p">]</span>
<span class="w">        </span><span class="n">INIT2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">INIT3</span><span class="p">[</span><span class="n">Step</span><span class="w"> </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">初始化</span><span class="w"> </span><span class="n">FeatureAnnotationManager</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">載入並合併繼承鏈</span><span class="p">]</span>
<span class="w">        </span><span class="n">INIT3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">INIT4</span><span class="p">[</span><span class="n">Step</span><span class="w"> </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="n">初始化其他模組</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">Parser</span><span class="o">/</span><span class="n">Cleaner</span><span class="o">/</span><span class="n">Batch</span><span class="o">/</span><span class="n">FE</span><span class="p">]</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;Feature Annotation Layer (v1.2)&quot;</span>
<span class="w">        </span><span class="n">FA1</span><span class="p">[</span><span class="n">Excel</span><span class="w"> </span><span class="n">Template</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;*</span><span class="p">.</span><span class="n">xlsx</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">編輯</span><span class="o">|</span><span class="w"> </span><span class="n">FA2</span><span class="p">[</span><span class="n">空調技師</span><span class="o">/</span><span class="n">工程師</span><span class="p">]</span>
<span class="w">        </span><span class="n">FA2</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">手動觸發</span><span class="o">|</span><span class="w"> </span><span class="n">FA3</span><span class="p">[</span><span class="n">excel_to_yaml</span><span class="p">.</span><span class="n">py</span><span class="p">]</span>
<span class="w">        </span><span class="n">FA3</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">驗證</span><span class="o">|</span><span class="w"> </span><span class="n">FA4</span><span class="p">{</span><span class="n">檢查點</span><span class="w"> </span><span class="err">#</span><span class="mi">5</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">Annotation</span><span class="w"> </span><span class="n">Valid</span><span class="p">}</span>
<span class="w">        </span><span class="n">FA4</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">生成</span><span class="o">|</span><span class="w"> </span><span class="n">FA5</span><span class="p">[</span><span class="n">config</span><span class="o">/</span><span class="n">features</span><span class="o">/</span><span class="n">sites</span><span class="cm">/*.yaml&lt;br/&gt;SSOT]</span>
<span class="cm">        FA5 --&gt;|Git PR| FA6[Config Server]</span>
<span class="cm">    end</span>

<span class="cm">    subgraph &quot;Configuration Layer&quot;</span>
<span class="cm">        A[settings.yaml] --&gt; B[ConfigLoader]</span>
<span class="cm">        B --&gt; C[ETLConfig SSOT]</span>
<span class="cm">        FA6 --&gt;|載入| C</span>
<span class="cm">    end</span>

<span class="cm">    subgraph &quot;Dependency Injection Container&quot;</span>
<span class="cm">        C --&gt; D[ETLContainer]</span>
<span class="cm">        D --&gt; E[ReportParser v2.1]</span>
<span class="cm">        D --&gt; F[DataCleaner v2.2]</span>
<span class="cm">        D --&gt; G[BatchOrchestrator v1.3]</span>
<span class="cm">        D --&gt; H[FeatureEngineer v1.3]</span>
<span class="cm">        D --&gt; I[FeatureAnnotationManager&lt;br/&gt;v1.2]</span>
<span class="cm">    end</span>

<span class="cm">    subgraph &quot;Pipeline Execution&quot;</span>
<span class="cm">        E --&gt;|Raw DF UTC| F</span>
<span class="cm">        F --&gt;|Clean DF&lt;br/&gt;語意感知清洗| G</span>
<span class="cm">        G --&gt;|Parquet + Manifest&lt;br/&gt;含 annotation_checksum| H</span>
<span class="cm">        H --&gt;|Feature Matrix&lt;br/&gt;套用 device_role &amp; Group Policy| J[Model Training]</span>
<span class="cm">    end</span>

<span class="cm">    subgraph &quot;Contract Checkpoints&quot;</span>
<span class="cm">        CP1{檢查點 #1&lt;br/&gt;Parser Output}</span>
<span class="cm">        CP2{檢查點 #2&lt;br/&gt;Cleaner Output}</span>
<span class="cm">        CP3{檢查點 #3&lt;br/&gt;BatchProcessor Output}</span>
<span class="cm">        CP4{檢查點 #4&lt;br/&gt;FE Input Schema}</span>
<span class="cm">        CP5{檢查點 #5&lt;br/&gt;Excel/YAML Sync}</span>
<span class="cm">        CP6{檢查點 #6&lt;br/&gt;Annotation Version}</span>
<span class="cm">    end</span>

<span class="cm">    E -.-&gt; CP1 -.-&gt; F</span>
<span class="cm">    F -.-&gt; CP2 -.-&gt; G</span>
<span class="cm">    G -.-&gt; CP3 -.-&gt; H</span>
<span class="cm">    H -.-&gt; CP4 -.-&gt; J</span>
<span class="cm">    FA1 -.-&gt; CP5 -.-&gt; FA3</span>
<span class="cm">    FA5 -.-&gt; CP6 -.-&gt; I</span>

<span class="cm">    style C fill:#f9f,stroke:#333,stroke-width:4px</span>
<span class="cm">    style D fill:#bbf,stroke:#333,stroke-width:4px</span>
<span class="cm">    style FA1 fill:#f9f,stroke:#f00,stroke-width:2px</span>
<span class="cm">    style FA5 fill:#bbf,stroke:#00f,stroke-width:2px</span>
<span class="cm">    style INIT1 fill:#ff9,stroke:#f00,stroke-width:3px</span>
<span class="cm">    style INIT2 fill:#ff9,stroke:#f00,stroke-width:3px</span>
<span class="cm">    style INIT3 fill:#ff9,stroke:#f00,stroke-width:3px</span>
</code></pre></div>

<hr />
<h2 id="2-ssot-configuration-system">2. SSOT 配置系統 (Configuration System)</h2>
<h3 id="21-feature-annotation-v12">2.1 統一配置結構（整合 Feature Annotation v1.2）</h3>
<p><strong>檔案</strong>: <code>src/etl/config_models.py</code> (核心 SSOT)</p>
<p><strong>關鍵更新</strong>:
- 新增 <code>FeatureAnnotationConfig</code> 設定 Annotation 路徑與版本檢查
- <code>ETLConfig</code> 新增 <code>feature_annotation</code> 欄位
- <strong>移除 <code>CleanerConfig.default_device_role</code>（審查修正：避免隱性預設值）</strong>
- <strong>新增 <code>CleanerConfig.unannotated_column_policy</code>（審查修正：未定義欄位處理策略）</strong>
- <strong>新增 <code>ETLConfig.concurrency</code> 設定併發控制參數（v1.2）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Final</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># SSOT 1: Quality Flags (6個標準值，全域唯一)</span>
<span class="n">VALID_QUALITY_FLAGS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;FROZEN&quot;</span><span class="p">,</span>           <span class="c1"># 數據凍結（連續3個區間值相同）</span>
    <span class="s2">&quot;HEAT_IMBALANCE&quot;</span><span class="p">,</span>   <span class="c1"># 熱平衡偏差 &gt; 5%</span>
    <span class="s2">&quot;AFFINITY_VIOLATION&quot;</span><span class="p">,</span> <span class="c1"># 違反親和律 &gt; 15%</span>
    <span class="s2">&quot;OUTLIER&quot;</span><span class="p">,</span>          <span class="c1"># 統計離群值（IQR法）</span>
    <span class="s2">&quot;INSUFFICIENT_DATA&quot;</span><span class="p">,</span> <span class="c1"># 時間空缺補全標記</span>
    <span class="s2">&quot;SENSOR_OFFLINE&quot;</span>    <span class="c1"># 感測器離線（新增）</span>
<span class="p">]</span>

<span class="c1"># SSOT 2: 時間戳規範 (所有模組必須遵守)</span>
<span class="n">TIMESTAMP_CONFIG</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;Datetime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;time_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;nanoseconds&quot;</span><span class="p">,</span>  <span class="c1"># ns</span>
    <span class="s2">&quot;time_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC&quot;</span><span class="p">,</span>          <span class="c1"># 強制UTC</span>
    <span class="s2">&quot;parquet_physical_type&quot;</span><span class="p">:</span> <span class="s2">&quot;INT64&quot;</span>  <span class="c1"># 禁止INT96</span>
<span class="p">}</span>

<span class="c1"># SSOT 3: Feature Annotation 相關常數（新增）</span>
<span class="n">FEATURE_ANNOTATION_CONSTANTS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;current_template_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;expected_schema_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;checksum_algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256&quot;</span>
<span class="p">}</span>

<span class="c1"># SSOT 4: 錯誤代碼分層規範（主要定義見 Interface Contract v1.0）</span>
<span class="n">ERROR_CODE_REGISTRY</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># E000: 全域</span>
    <span class="s2">&quot;E000&quot;</span><span class="p">:</span> <span class="s2">&quot;Temporal baseline missing&quot;</span><span class="p">,</span>
    <span class="c1"># E0xx: 系統層</span>
    <span class="s2">&quot;E006&quot;</span><span class="p">:</span> <span class="s2">&quot;Memory limit exceeded&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;E007&quot;</span><span class="p">:</span> <span class="s2">&quot;Config file corrupted&quot;</span><span class="p">,</span>
    <span class="c1"># E1xx: Parser (Critical)</span>
    <span class="s2">&quot;E101&quot;</span><span class="p">:</span> <span class="s2">&quot;Encoding/BOM mismatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E102&quot;</span><span class="p">:</span> <span class="s2">&quot;Timezone violation (Non-UTC)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E103&quot;</span><span class="p">:</span> <span class="s2">&quot;Contract violation (Missing cols/flags)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E104&quot;</span><span class="p">:</span> <span class="s2">&quot;Header not found&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E105&quot;</span><span class="p">:</span> <span class="s2">&quot;Column validation failed&quot;</span><span class="p">,</span>
    <span class="c1"># E1xx: Parser (Warnings)</span>
    <span class="s2">&quot;E111&quot;</span><span class="p">:</span> <span class="s2">&quot;Timezone warning (Auto-converted)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E112&quot;</span><span class="p">:</span> <span class="s2">&quot;Future data detected (Parser)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E113&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown quality flag (Parser)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E114&quot;</span><span class="p">:</span> <span class="s2">&quot;Unit conversion error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E115&quot;</span><span class="p">:</span> <span class="s2">&quot;Encoding warning&quot;</span><span class="p">,</span>
    <span class="c1"># E2xx: Cleaner</span>
    <span class="s2">&quot;E201&quot;</span><span class="p">:</span> <span class="s2">&quot;Input schema mismatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E202&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown quality flag (Batch)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E203&quot;</span><span class="p">:</span> <span class="s2">&quot;Metadata loss&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E205&quot;</span><span class="p">:</span> <span class="s2">&quot;Future data in batch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E206&quot;</span><span class="p">:</span> <span class="s2">&quot;Parquet format violation&quot;</span><span class="p">,</span>
    <span class="c1"># E3xx: BatchProcessor</span>
    <span class="s2">&quot;E301&quot;</span><span class="p">:</span> <span class="s2">&quot;Manifest integrity failed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E302&quot;</span><span class="p">:</span> <span class="s2">&quot;Schema mismatch (Storage)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E303&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown quality flag (Storage)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E304&quot;</span><span class="p">:</span> <span class="s2">&quot;Metadata missing (Manifest)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E305&quot;</span><span class="p">:</span> <span class="s2">&quot;Data leakage detected&quot;</span><span class="p">,</span>
    <span class="c1"># E35x: Equipment Validation</span>
    <span class="s2">&quot;E350&quot;</span><span class="p">:</span> <span class="s2">&quot;Constraint config error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E351&quot;</span><span class="p">:</span> <span class="s2">&quot;Requires violation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E352&quot;</span><span class="p">:</span> <span class="s2">&quot;Mutex violation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E353&quot;</span><span class="p">:</span> <span class="s2">&quot;Sequence violation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E354&quot;</span><span class="p">:</span> <span class="s2">&quot;Min runtime violation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E355&quot;</span><span class="p">:</span> <span class="s2">&quot;Min downtime violation&quot;</span><span class="p">,</span>
    <span class="c1"># E4xx: Feature Annotation</span>
    <span class="s2">&quot;E400&quot;</span><span class="p">:</span> <span class="s2">&quot;Annotation version mismatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E401&quot;</span><span class="p">:</span> <span class="s2">&quot;Orphan column&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E402&quot;</span><span class="p">:</span> <span class="s2">&quot;Unannotated column&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E403&quot;</span><span class="p">:</span> <span class="s2">&quot;Unit incompatible&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E404&quot;</span><span class="p">:</span> <span class="s2">&quot;Lag format invalid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E405&quot;</span><span class="p">:</span> <span class="s2">&quot;Target leakage risk&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E406&quot;</span><span class="p">:</span> <span class="s2">&quot;Excel/YAML out of sync&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E407&quot;</span><span class="p">:</span> <span class="s2">&quot;Circular inheritance&quot;</span><span class="p">,</span>
    <span class="c1"># E5xx: Governance</span>
    <span class="s2">&quot;E500&quot;</span><span class="p">:</span> <span class="s2">&quot;Device role leakage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E501&quot;</span><span class="p">:</span> <span class="s2">&quot;Direct write attempt blocked&quot;</span><span class="p">,</span>
    <span class="c1"># E6xx: Feature Engineer</span>
    <span class="s2">&quot;E601&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature order not recorded&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E602&quot;</span><span class="p">:</span> <span class="s2">&quot;Scaler params missing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E603&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature matrix shape error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E604&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid lag configuration&quot;</span><span class="p">,</span>
    <span class="c1"># E7xx: Model Training</span>
    <span class="s2">&quot;E701&quot;</span><span class="p">:</span> <span class="s2">&quot;Training memory error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E702&quot;</span><span class="p">:</span> <span class="s2">&quot;Validation failure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E703&quot;</span><span class="p">:</span> <span class="s2">&quot;Hyperparameter invalid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E704&quot;</span><span class="p">:</span> <span class="s2">&quot;Checkpoint save failed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E705&quot;</span><span class="p">:</span> <span class="s2">&quot;Cross validation error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E706&quot;</span><span class="p">:</span> <span class="s2">&quot;Model artifact corrupted&quot;</span><span class="p">,</span>
    <span class="c1"># E75x: Hybrid Consistency</span>
    <span class="s2">&quot;E750&quot;</span><span class="p">:</span> <span class="s2">&quot;Golden dataset unavailable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E751&quot;</span><span class="p">:</span> <span class="s2">&quot;Dynamic tolerance exceeded&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E752&quot;</span><span class="p">:</span> <span class="s2">&quot;Systematic bias detected&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E753&quot;</span><span class="p">:</span> <span class="s2">&quot;Trend mismatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E754&quot;</span><span class="p">:</span> <span class="s2">&quot;Outlier violation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E755&quot;</span><span class="p">:</span> <span class="s2">&quot;Insufficient components&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E756&quot;</span><span class="p">:</span> <span class="s2">&quot;Partial components (L2)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E757&quot;</span><span class="p">:</span> <span class="s2">&quot;Light load variance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E758&quot;</span><span class="p">:</span> <span class="s2">&quot;Copula effect detected&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E759&quot;</span><span class="p">:</span> <span class="s2">&quot;Dataset quality warning&quot;</span><span class="p">,</span>
    <span class="c1"># E8xx: Optimization</span>
    <span class="s2">&quot;E801&quot;</span><span class="p">:</span> <span class="s2">&quot;Model load failed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E802&quot;</span><span class="p">:</span> <span class="s2">&quot;Constraint violation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E803&quot;</span><span class="p">:</span> <span class="s2">&quot;Optimization divergence&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E804&quot;</span><span class="p">:</span> <span class="s2">&quot;Bound infeasibility&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E805&quot;</span><span class="p">:</span> <span class="s2">&quot;Forecast horizon mismatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E806&quot;</span><span class="p">:</span> <span class="s2">&quot;System model discrepancy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E807&quot;</span><span class="p">:</span> <span class="s2">&quot;Equipment state invalid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E808&quot;</span><span class="p">:</span> <span class="s2">&quot;Weather data missing&quot;</span><span class="p">,</span>
    <span class="c1"># E9xx: Cross-Stage</span>
    <span class="s2">&quot;E901&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature alignment mismatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E902&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature dimension mismatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E903&quot;</span><span class="p">:</span> <span class="s2">&quot;Scaler mismatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E904&quot;</span><span class="p">:</span> <span class="s2">&quot;Model version incompatible&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E905&quot;</span><span class="p">:</span> <span class="s2">&quot;Pipeline version drift&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># SSOT 5: Feature Metadata Schema（更新：支援 device_role）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FeatureMetadata</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">physical_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;power&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;humidity&quot;</span><span class="p">,</span> <span class="s2">&quot;gauge&quot;</span><span class="p">,</span> <span class="s2">&quot;chiller_load&quot;</span><span class="p">,</span> <span class="s2">&quot;cooling_tower_load&quot;</span>
    <span class="p">]</span>
    <span class="n">unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>           <span class="c1"># &quot;LPM&quot;, &quot;kW&quot;, &quot;°C&quot;, &quot;%&quot;</span>
    <span class="n">device_role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="s2">&quot;backup&quot;</span><span class="p">,</span> <span class="s2">&quot;seasonal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;primary&quot;</span>  <span class="c1"># 新增</span>
    <span class="n">is_target</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>              
    <span class="n">enable_lag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">enable_rolling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">agg_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
    <span class="n">ignore_warnings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># 新增：[&quot;W401&quot;, &quot;W403&quot;]</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;enable_lag&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_target_no_lag</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;E405: Target 變數不可啟用 Lag&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_target&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;E405: is_target=True 時 enable_lag 必須為 False&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="c1"># Parser 配置</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ParserConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>               
    <span class="n">header_scan_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">assumed_timezone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Asia/Taipei&quot;</span>  
    <span class="n">null_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="s2">&quot;OFF&quot;</span><span class="p">,</span> <span class="s2">&quot;OFFLINE&quot;</span><span class="p">,</span> <span class="s2">&quot;#VALUE!&quot;</span>
    <span class="p">])</span>

<span class="c1"># Cleaner 配置（審查修正：移除 default_device_role，避免隱性預設值）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CleanerConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">unit_system</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;METRIC&quot;</span><span class="p">,</span> <span class="s2">&quot;IMPERIAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;METRIC&quot;</span>
    <span class="n">resample_interval</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;15m&quot;</span>       
    <span class="n">heat_balance_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>  
    <span class="n">frozen_data_intervals</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">enforce_output_contract</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># 審查修正：移除 default_device_role，所有 device_role 必須來自 Annotation</span>
    <span class="n">use_device_role_from_annotation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># 審查修正：新增未定義欄位處理策略（strict_mode 下應為 error）</span>
    <span class="n">unannotated_column_policy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="s2">&quot;warn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>

<span class="c1"># BatchProcessor 配置（更新：Annotation 版本寫入 Manifest）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BatchConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">output_base_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data/processed&quot;</span>
    <span class="n">staging_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data/.staging&quot;</span>
    <span class="n">max_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100_000</span>
    <span class="n">compression</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;snappy&quot;</span><span class="p">,</span> <span class="s2">&quot;zstd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span>
    <span class="n">use_pyarrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>            
    <span class="n">future_data_tolerance_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="c1"># 新增：強制檢查 Annotation 同步</span>
    <span class="n">enforce_annotation_sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Feature Engineer 配置（更新：使用 Group Policy）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FeatureEngineeringConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">execution_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;in_memory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;in_memory&quot;</span>
    <span class="n">cutoff_timestamp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  
    <span class="n">group_policies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">physics_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">time_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># 新增：消費 device_role 與 ignore_warnings</span>
    <span class="n">respect_device_role</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>       <span class="c1"># 抑制備用設備統計誤報</span>
    <span class="n">respect_ignore_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>   <span class="c1"># 抑制特定警告</span>

<span class="c1"># Feature Annotation 配置（新增）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FeatureAnnotationConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Feature Annotation v1.2 設定&quot;&quot;&quot;</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">excel_base_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data/features&quot;</span>           <span class="c1"># 使用者編輯區</span>
    <span class="n">yaml_base_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config/features/sites&quot;</span>    <span class="c1"># SSOT 輸出</span>
    <span class="n">template_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tools/features/templates&quot;</span>
    <span class="n">current_template_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.2&quot;</span>
    <span class="c1"># 自動同步檢查</span>
    <span class="n">auto_sync_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># 嚴格模式：Excel/YAML 不同步時阻擋 Pipeline</span>
    <span class="n">strict_sync_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># v1.2 新增：檔案鎖逾時時間（秒）</span>
    <span class="n">file_lock_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="c1"># v1.2 新增：YAML 檔案鎖路徑</span>
    <span class="n">lock_file_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data/.locks&quot;</span>

<span class="c1"># v1.2 新增：併發控制配置</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ConcurrencyConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;併發控制與資源鎖定設定&quot;&quot;&quot;</span>
    <span class="n">enable_file_locking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">lock_timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">lock_retry_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">max_concurrent_pipelines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 單一案場同時間只能執行一個 Pipeline</span>

<span class="c1"># 統一配置根（更新）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ETLConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ETL Pipeline 統一配置 (SSOT 中心)&quot;&quot;&quot;</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>
    <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="n">parser</span><span class="p">:</span> <span class="n">ParserConfig</span> <span class="o">=</span> <span class="n">ParserConfig</span><span class="p">()</span>
    <span class="n">cleaner</span><span class="p">:</span> <span class="n">CleanerConfig</span> <span class="o">=</span> <span class="n">CleanerConfig</span><span class="p">()</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">BatchConfig</span> <span class="o">=</span> <span class="n">BatchConfig</span><span class="p">()</span>
    <span class="n">feature</span><span class="p">:</span> <span class="n">FeatureEngineeringConfig</span> <span class="o">=</span> <span class="n">FeatureEngineeringConfig</span><span class="p">()</span>
    <span class="n">feature_annotation</span><span class="p">:</span> <span class="n">FeatureAnnotationConfig</span> <span class="o">=</span> <span class="n">FeatureAnnotationConfig</span><span class="p">()</span>  <span class="c1"># 新增</span>
    <span class="n">concurrency</span><span class="p">:</span> <span class="n">ConcurrencyConfig</span> <span class="o">=</span> <span class="n">ConcurrencyConfig</span><span class="p">()</span>  <span class="c1"># v1.2 新增</span>

    <span class="c1"># 全域設定</span>
    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="n">strict_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>             

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Config version must be 1.0&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;feature_annotation&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_annotation_paths</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;確保 Annotation 目錄存在&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
        <span class="k">for</span> <span class="n">path_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;excel_base_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;yaml_base_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;lock_file_dir&#39;</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">path_attr</span><span class="p">))</span>
            <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</code></pre></div>

<h3 id="22-configloader-">2.2 配置載入器 (ConfigLoader) - 整合時間基準與併發控制</h3>
<p><strong>檔案</strong>: <code>src/utils/config_loader.py</code></p>
<p><strong>關鍵更新 (v1.2)</strong>:
- 新增 <code>load_feature_annotation()</code> 方法載入 YAML SSOT（注意：僅載入，不處理繼承，繼承邏輯在 Manager 處理）
- 新增 <code>validate_annotation_sync()</code> 檢查 Excel/YAML 同步狀態
- <strong>新增 <code>acquire_yaml_lock()</code> / <code>release_yaml_lock()</code>：檔案鎖機制防止併發寫入（v1.2）</strong>
- <strong>新增 <code>PipelineContext</code> 支援：統一時間基準傳遞（v1.2）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fcntl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.config_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ETLConfig</span><span class="p">,</span> <span class="n">VALID_QUALITY_FLAGS</span><span class="p">,</span> <span class="n">FEATURE_ANNOTATION_CONSTANTS</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ConfigurationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;配置錯誤&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AnnotationSyncError</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E406: Excel 與 YAML 不同步&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FileLockError</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E003/E408: 檔案鎖定失敗&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ConfigLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;統一配置載入，確保所有模組引用相同 SSOT&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;config/settings.yaml&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ETLConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;載入並驗證 ETL 主配置&quot;&quot;&quot;</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;配置文件不存在: </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;YAML 解析錯誤: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 驗證 SSOT 一致性</span>
        <span class="n">code_flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">VALID_QUALITY_FLAGS</span><span class="p">)</span>
        <span class="n">config_flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom_quality_flags&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="k">if</span> <span class="n">config_flags</span> <span class="ow">and</span> <span class="n">config_flags</span> <span class="o">!=</span> <span class="n">code_flags</span><span class="p">:</span>
            <span class="n">missing_base</span> <span class="o">=</span> <span class="n">code_flags</span> <span class="o">-</span> <span class="n">config_flags</span>
            <span class="k">if</span> <span class="n">missing_base</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;settings.yaml 中的 flags 缺少 SSOT 基礎標記: </span><span class="si">{</span><span class="n">missing_base</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;程式碼定義: </span><span class="si">{</span><span class="n">code_flags</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># 驗證目錄存在性或自動建立</span>
        <span class="k">for</span> <span class="n">dir_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;output_base_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;staging_dir&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dir_key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="p">{}):</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">][</span><span class="n">dir_key</span><span class="p">])</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ETLConfig</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;配置驗證失敗: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_feature_annotation</span><span class="p">(</span><span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">yaml_base_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config/features/sites&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        載入特定案場的 Feature Annotation YAML (原始內容，未合併繼承)</span>
<span class="sd">        注意：繼承合併邏輯由 FeatureAnnotationManager 處理</span>

<span class="sd">        檢查項目:</span>
<span class="sd">        1. 檔案存在性</span>
<span class="sd">        2. schema_version 相容性（僅檢查，不合併）</span>
<span class="sd">        3. 檔案鎖狀態（僅檢查，不取得鎖）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yaml_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">yaml_base_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">.yaml&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">yaml_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E402: Feature Annotation 未定義: </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># v1.2: 檢查是否有進程正在寫入（鎖檔案存在）</span>
        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data/.locks/</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">.yaml.lock&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">lock_age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">lock_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
            <span class="k">if</span> <span class="n">lock_age</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>  <span class="c1"># 5分鐘內的鎖視為有效</span>
                <span class="k">raise</span> <span class="n">FileLockError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E408: YAML 檔案正在被其他進程修改 (鎖存在 </span><span class="si">{</span><span class="n">lock_age</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> 秒)&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># 檢查 Schema 版本（檢查點 #6）</span>
        <span class="n">schema_ver</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="n">expected_ver</span> <span class="o">=</span> <span class="n">FEATURE_ANNOTATION_CONSTANTS</span><span class="p">[</span><span class="s1">&#39;expected_schema_version&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">schema_ver</span> <span class="o">!=</span> <span class="n">expected_ver</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;E400: Annotation Schema 版本不符。期望: </span><span class="si">{</span><span class="n">expected_ver</span><span class="si">}</span><span class="s2">, 實際: </span><span class="si">{</span><span class="n">schema_ver</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;請執行 migrate_excel.py 升級&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">annotation</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">acquire_yaml_lock</span><span class="p">(</span><span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lock_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data/.locks&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        v1.2 新增：上下文管理器取得 YAML 檔案鎖</span>

<span class="sd">        使用 fcntl 實作進程間鎖定，防止：</span>
<span class="sd">        1. excel_to_yaml.py 轉換時 Pipeline 讀取（讀髒資料）</span>
<span class="sd">        2. 多個 Pipeline 實例同時執行（資源衝突）</span>

<span class="sd">        Args:</span>
<span class="sd">            site_id: 案場 ID</span>
<span class="sd">            lock_dir: 鎖檔案目錄</span>
<span class="sd">            timeout: 逾時秒數</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileLockError: E003 無法取得鎖</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">lock_dir</span><span class="p">)</span>
        <span class="n">lock_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lock_file</span> <span class="o">=</span> <span class="n">lock_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">.yaml.lock&quot;</span>

        <span class="n">lock_fd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 嘗試取得鎖</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lock_fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lock_file</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
                    <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">lock_fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
                    <span class="c1"># 寫入鎖資訊</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lock_fd</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">lock_fd</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">lock_fd</span><span class="p">)</span>
                        <span class="n">lock_fd</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">FileLockError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E003: 無法取得 YAML 檔案鎖（逾時 </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> 秒）&quot;</span><span class="p">)</span>

                    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">lock_file</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lock_fd</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">lock_fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">lock_fd</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lock_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_annotation_sync</span><span class="p">(</span><span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">excel_base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">yaml_base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        E406: 檢查 Excel 與 YAML 是否同步</span>

<span class="sd">        Returns:</span>
<span class="sd">            {</span>
<span class="sd">                &#39;synced&#39;: bool,</span>
<span class="sd">                &#39;excel_mtime&#39;: float,</span>
<span class="sd">                &#39;yaml_mtime&#39;: float,</span>
<span class="sd">                &#39;excel_checksum&#39;: str,</span>
<span class="sd">                &#39;yaml_checksum&#39;: str,</span>
<span class="sd">                &#39;reason&#39;: str</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">excel_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">excel_base_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">site_id</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>
        <span class="n">yaml_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">yaml_base_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">.yaml&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">excel_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;synced&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Excel 不存在: </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">yaml_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;synced&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;YAML 不存在: </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="c1"># 時間戳比較</span>
        <span class="n">excel_mtime</span> <span class="o">=</span> <span class="n">excel_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">yaml_mtime</span> <span class="o">=</span> <span class="n">yaml_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>

        <span class="k">if</span> <span class="n">excel_mtime</span> <span class="o">&gt;</span> <span class="n">yaml_mtime</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;synced&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;excel_mtime&#39;</span><span class="p">:</span> <span class="n">excel_mtime</span><span class="p">,</span>
                <span class="s1">&#39;yaml_mtime&#39;</span><span class="p">:</span> <span class="n">yaml_mtime</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;E406: Excel (</span><span class="si">{</span><span class="n">excel_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">) 較新，請重新執行 excel_to_yaml.py&#39;</span>
            <span class="p">}</span>

        <span class="c1"># Checksum 比對（若 YAML 中有記錄）</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">yaml_content</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">stored_checksum</span> <span class="o">=</span> <span class="n">yaml_content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;excel_checksum&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stored_checksum</span><span class="p">:</span>
            <span class="n">actual_checksum</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">_compute_file_hash</span><span class="p">(</span><span class="n">excel_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stored_checksum</span> <span class="o">!=</span> <span class="n">actual_checksum</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;synced&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;excel_checksum&#39;</span><span class="p">:</span> <span class="n">actual_checksum</span><span class="p">,</span>
                    <span class="s1">&#39;yaml_checksum&#39;</span><span class="p">:</span> <span class="n">stored_checksum</span><span class="p">,</span>
                    <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;E406: Checksum 不符，Excel 可能已修改但未重新生成 YAML&#39;</span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;synced&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;同步&#39;</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_file_hash</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;計算檔案 SHA256&quot;&quot;&quot;</span>
        <span class="n">sha256_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">byte_block</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">sha256_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byte_block</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;sha256:</span><span class="si">{</span><span class="n">sha256_hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_annotation_metadata</span><span class="p">(</span><span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">yaml_base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得 Annotation 元資料（供 Manifest 寫入）&quot;&quot;&quot;</span>
        <span class="c1"># 注意：此處僅讀取原始檔案的 meta，不觸發繼承合併</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">load_feature_annotation</span><span class="p">(</span><span class="n">site_id</span><span class="p">,</span> <span class="n">yaml_base_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;schema_version&#39;</span><span class="p">:</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">),</span>
            <span class="s1">&#39;template_version&#39;</span><span class="p">:</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;template_version&#39;</span><span class="p">),</span>
            <span class="s1">&#39;last_updated&#39;</span><span class="p">:</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_updated&#39;</span><span class="p">),</span>
            <span class="s1">&#39;editor&#39;</span><span class="p">:</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editor&#39;</span><span class="p">),</span>
            <span class="s1">&#39;yaml_checksum&#39;</span><span class="p">:</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;excel_checksum&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="23-pipelinecontext-v12">2.3 PipelineContext - 全域時間基準與狀態載體（v1.2 新增）</h3>
<p><strong>檔案</strong>: <code>src/context.py</code></p>
<p><strong>設計目的</strong>:
- 解決「未來資料檢查的時間基準不一致」問題（Parser/Cleaner/BatchProcessor 各自呼叫 <code>datetime.now()</code> 導致漂移）
- 攜帶 Pipeline 執行期間的全域狀態（時間戳、案場ID、嚴格模式等）
- 確保所有模組使用相同的「現在」時間點</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PipelineContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pipeline 執行上下文（v1.2 新增）</span>

<span class="sd">    作為 DI Container 初始化時產生的「時間膠囊」，確保：</span>
<span class="sd">    1. 所有未來資料檢查使用相同的 pipeline_timestamp</span>
<span class="sd">    2. 跨模組的時間邏輯一致性（避免 Pipeline 執行期間時間流逝導致誤判）</span>
<span class="sd">    3. 可追溯性（記錄 Pipeline 啟動時間）</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pipeline_timestamp: Pipeline 啟動時的 UTC 時間（所有「未來資料」檢查的基準）</span>
<span class="sd">        site_id: 案場識別碼</span>
<span class="sd">        strict_mode: 是否嚴格模式（影響錯誤處理策略）</span>
<span class="sd">        config_hash: 設定檔雜湊（確保執行期間設定未被修改）</span>
<span class="sd">        metadata: 擴充元資料字典</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pipeline_timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
    <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="n">strict_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">config_hash</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_future_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">tolerance_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        檢查給定時間戳是否為「未來資料」（相對於 pipeline_timestamp）</span>

<span class="sd">        Args:</span>
<span class="sd">            timestamp: 待檢查的時間戳</span>
<span class="sd">            tolerance_minutes: 容忍分鐘數（考慮時鐘誤差與處理延遲）</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True 如果 timestamp 超過 pipeline_timestamp + tolerance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># 假設無時區為 UTC（或根據設定處理）</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">tolerance</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">tolerance_minutes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_timestamp</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_elapsed_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得 Pipeline 已執行秒數&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;序列化為字典（供 Manifest 記錄）&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pipeline_timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;site_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
            <span class="s1">&#39;strict_mode&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_mode</span><span class="p">,</span>
            <span class="s1">&#39;config_hash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_hash</span><span class="p">,</span>
            <span class="s1">&#39;elapsed_seconds_at_save&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elapsed_seconds</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;PipelineContext&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;從字典還原&quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pipeline_timestamp&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">pipeline_timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">site_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;site_id&#39;</span><span class="p">],</span>
            <span class="n">strict_mode</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;strict_mode&#39;</span><span class="p">],</span>
            <span class="n">config_hash</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config_hash&#39;</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="3-di-container-">3. 依賴注入容器 (DI Container) - 嚴格初始化順序控制</h2>
<h3 id="31-etlcontainer-v12">3.1 ETLContainer 實作（v1.2：順序控制與併發防護）</h3>
<p><strong>檔案</strong>: <code>src/container.py</code></p>
<p><strong>關鍵修正 (v1.2)</strong>:
- <strong>嚴格初始化順序</strong>：<code>__init__</code> 方法內部分為 4 個明確階段，防止 Race Condition
- <strong>檔案鎖整合</strong>：初始化時自動取得 YAML 鎖，防止 Wizard 與 Pipeline 衝突
- <strong>PipelineContext 注入</strong>：所有模組統一透過 Context 取得時間基準
- <strong>Cleaner 職責釐清</strong>：僅讀取 device_role 用於策略調整，不寫入 metadata</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.config_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ETLConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReportParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.cleaner</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataCleaner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.batch_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchOrchestrator</span><span class="p">,</span> <span class="n">BatchResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.feature_engineer</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureEngineer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.features.annotation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureAnnotationManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.config_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigLoader</span><span class="p">,</span> <span class="n">AnnotationSyncError</span><span class="p">,</span> <span class="n">FileLockError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">PipelineContext</span>  <span class="c1"># v1.2 新增</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ETLContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    依賴注入容器 (Dependency Injection Container) - v1.2</span>

<span class="sd">    管理所有 ETL 模組的生命周期與配置傳遞，確保:</span>
<span class="sd">    1. 單例模式 (Singleton) </span>
<span class="sd">    2. 配置一致性 </span>
<span class="sd">    3. 嚴格初始化順序（防止 Race Condition）</span>
<span class="sd">    4. Feature Annotation 正確流向各模組（Excel → YAML → Manager → Modules）</span>
<span class="sd">    5. 零間隙銜接 </span>
<span class="sd">    6. 併發控制（檔案鎖）</span>

<span class="sd">    **初始化順序（嚴格執行）**:</span>
<span class="sd">    Step 1: 產生 PipelineContext（鎖定時間基準）</span>
<span class="sd">    Step 2: 驗證 E406 同步並取得檔案鎖</span>
<span class="sd">    Step 3: 初始化 FeatureAnnotationManager（載入並合併繼承）</span>
<span class="sd">    Step 4: 初始化其他模組（Parser/Cleaner/BatchProcessor/FE）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ETLConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;ETLContainer&quot;</span><span class="p">)</span>

        <span class="c1"># v1.2: Step 1 - 初始化 PipelineContext（時間基準）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">PipelineContext</span><span class="p">(</span>
            <span class="n">site_id</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
            <span class="n">strict_mode</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">strict_mode</span><span class="p">,</span>
            <span class="n">config_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_config_hash</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🕐 PipelineContext 初始化完成，時間基準: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pipeline_timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 快取實例 (Singleton)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ReportParser</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleaner</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataCleaner</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_processor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BatchOrchestrator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_engineer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FeatureEngineer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FeatureAnnotationManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># v1.2: 檔案鎖控制</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock_acquired</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># v1.2: 執行嚴格初始化順序</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_in_order</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_config_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ETLConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;計算配置雜湊（防止執行期間設定被修改）&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="n">config_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">config_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_in_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        嚴格初始化順序（v1.2 核心修正）</span>

<span class="sd">        此順序確保：</span>
<span class="sd">        - Annotation 已驗證且鎖定後，其他模組才能讀取</span>
<span class="sd">        - Manager 先於 Cleaner 初始化，確保 unannotated_column_policy 正確傳遞</span>
<span class="sd">        - 時間基準先確立，後續模組的「未來資料」檢查有一致標準</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 2: E406 驗證與檔案鎖取得（Critical）</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_acquire_annotation_lock</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_annotation_sync</span><span class="p">()</span>

            <span class="c1"># Step 3: 初始化 FeatureAnnotationManager（必須在 Cleaner 之前）</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_annotation_manager</span><span class="p">()</span>

            <span class="c1"># Step 4: 初始化其他模組（此時 Context 與 Manager 已就緒）</span>
            <span class="c1"># 注意：實際實例化採用惰性載入（lazy loading），但順序在此確保</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ 依賴注入容器初始化完成（順序驗證通過）&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_lock</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_acquire_annotation_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;v1.2: 取得 Annotation YAML 檔案鎖&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">concurrency</span><span class="o">.</span><span class="n">enable_file_locking</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;🔒 嘗試取得 Annotation 檔案鎖...&quot;</span><span class="p">)</span>
            <span class="c1"># 使用上下文管理器，但手動控制解鎖時機（Pipeline 結束時）</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock_cm</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">acquire_yaml_lock</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">lock_file_dir</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">file_lock_timeout</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_cm</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock_acquired</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔒 檔案鎖已取得: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_lock_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FileLockError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 無法取得檔案鎖: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E003: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_annotation_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;v1.2: 檢查點 #5 - Annotation 同步驗證&quot;&quot;&quot;</span>
        <span class="n">fa_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fa_config</span><span class="o">.</span><span class="n">auto_sync_check</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;🔍 檢查點 #5: 驗證 Excel/YAML 同步狀態...&quot;</span><span class="p">)</span>
        <span class="n">sync_status</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">validate_annotation_sync</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
            <span class="n">fa_config</span><span class="o">.</span><span class="n">excel_base_dir</span><span class="p">,</span>
            <span class="n">fa_config</span><span class="o">.</span><span class="n">yaml_base_dir</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sync_status</span><span class="p">[</span><span class="s1">&#39;synced&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">fa_config</span><span class="o">.</span><span class="n">strict_sync_check</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AnnotationSyncError</span><span class="p">(</span><span class="n">sync_status</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Annotation 同步警告: </span><span class="si">{</span><span class="n">sync_status</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ 檢查點 #5: Excel/YAML 同步 - 通過&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_annotation_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;v1.2: Step 3 - 載入 FeatureAnnotationManager（含繼承合併）&quot;&quot;&quot;</span>
        <span class="n">fa_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span> <span class="o">=</span> <span class="n">FeatureAnnotationManager</span><span class="p">(</span>
                <span class="n">site_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
                <span class="n">yaml_base_dir</span><span class="o">=</span><span class="n">fa_config</span><span class="o">.</span><span class="n">yaml_base_dir</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📋 FeatureAnnotationManager 初始化完成 &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(Schema: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="o">.</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Inheritance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

            <span class="c1"># 檢查點 #6: Schema 版本相容</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="o">.</span><span class="n">schema_version</span> <span class="o">!=</span> <span class="n">fa_config</span><span class="o">.</span><span class="n">current_template_version</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;E400: Schema 版本不符。Manager: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="o">.</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;期望: </span><span class="si">{</span><span class="n">fa_config</span><span class="o">.</span><span class="n">current_template_version</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ FeatureAnnotationManager 初始化失敗: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;v1.2: 清理檔案鎖&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_acquired</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_lock_cm&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lock_cm</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;🔓 檔案鎖已釋放&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock_acquired</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;解構時確保釋放鎖&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_lock</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_annotation_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeatureAnnotationManager</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得 FeatureAnnotationManager（檢查點 #6）&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E901: FeatureAnnotationManager 未初始化，違反初始化順序&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PipelineContext</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;v1.2: 取得 PipelineContext（時間基準與全域狀態）&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E902: PipelineContext 未初始化&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReportParser</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        取得 Parser 實例（v1.2: 注入 Context 時間基準）</span>

<span class="sd">        Parser v2.1+ 會:</span>
<span class="sd">        1. 使用 Context.pipeline_timestamp 作為「未來資料」檢查基準（E102）</span>
<span class="sd">        2. 確保所有時間戳轉換為 UTC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="n">ReportParser</span><span class="p">(</span>
                <span class="n">site_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>  <span class="c1"># v1.2: 注入時間基準</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;初始化 ReportParser (含 PipelineContext)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_cleaner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataCleaner</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        取得 Cleaner 實例（v1.2: 嚴格順序控制）</span>

<span class="sd">        **初始化順序要求**: 必須在 FeatureAnnotationManager 之後初始化</span>

<span class="sd">        Cleaner v2.2+ 會:</span>
<span class="sd">        1. 持有 AnnotationManager 引用，用於查詢 device_role（不寫入 DataFrame）</span>
<span class="sd">        2. 使用 Context.pipeline_timestamp 作為「未來資料」檢查基準（E205）</span>
<span class="sd">        3. 根據 device_role 調整清洗策略（如 backup 設備放寬凍結檢測）</span>
<span class="sd">        4. 對於 unannotated 欄位，依據 unannotated_column_policy 處理（E402）</span>

<span class="sd">        注意：device_role 不會被寫入 Parquet metadata，僅用於 runtime 邏輯判斷</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E901: 違反初始化順序 - Cleaner 要求 AnnotationManager 先初始化&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleaner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleaner</span> <span class="o">=</span> <span class="n">DataCleaner</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cleaner</span><span class="p">,</span>
                <span class="n">annotation_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>  <span class="c1"># v1.2: 注入時間基準</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;初始化 DataCleaner (含 AnnotationManager 引用與 Context，不寫入 metadata)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleaner</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_batch_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchOrchestrator</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        取得 BatchProcessor 實例（v1.2: 注入時間基準）</span>

<span class="sd">        BatchProcessor v1.3+ 會:</span>
<span class="sd">        1. 接收來自 Cleaner 的資料（不含 device_role metadata）</span>
<span class="sd">        2. 使用 Context.pipeline_timestamp 作為「未來資料」檢查基準（E303）</span>
<span class="sd">        3. 將 Annotation Metadata（version, checksum）寫入 Manifest（供稽核）</span>
<span class="sd">        4. 執行 E406 檢查（若 enforce_annotation_sync=True）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_processor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">annotation_meta</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="p">:</span>
                <span class="n">annotation_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_batch_processor</span> <span class="o">=</span> <span class="n">BatchOrchestrator</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parser</span><span class="p">(),</span>
                <span class="n">cleaner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cleaner</span><span class="p">(),</span>
                <span class="n">annotation_metadata</span><span class="o">=</span><span class="n">annotation_meta</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>  <span class="c1"># v1.2: 注入時間基準</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;初始化 BatchOrchestrator (含 Annotation Metadata 與 Context)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_processor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_engineer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeatureEngineer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        取得 FeatureEngineer 實例（v1.2: 注入時間基準）</span>

<span class="sd">        Feature Engineer v1.3+ 會:</span>
<span class="sd">        1. 讀取 Annotation 中的 group_policies（從 Manager，非 DataFrame metadata）</span>
<span class="sd">        2. 根據 device_role 決定是否抑制 W403（備用設備高零值正常）</span>
<span class="sd">        3. 根據 ignore_warnings 過濾統計警告</span>
<span class="sd">        4. 使用 Context.pipeline_timestamp 計算特徵時間偏移</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_engineer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_policies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">column_configs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="p">:</span>
                <span class="n">group_policies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="o">.</span><span class="n">get_group_policies</span><span class="p">()</span>
                <span class="n">column_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_manager</span><span class="o">.</span><span class="n">get_column_configs</span><span class="p">()</span>

            <span class="c1"># 合併配置：Annotation 優先於程式碼配置</span>
            <span class="n">merged_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">merged_config</span><span class="o">.</span><span class="n">group_policies</span> <span class="o">=</span> <span class="n">group_policies</span> <span class="ow">or</span> <span class="n">merged_config</span><span class="o">.</span><span class="n">group_policies</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_feature_engineer</span> <span class="o">=</span> <span class="n">FeatureEngineer</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">merged_config</span><span class="p">,</span>
                <span class="n">annotation_columns</span><span class="o">=</span><span class="n">column_configs</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>  <span class="c1"># v1.2: 注入時間基準</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;初始化 FeatureEngineer (含 Group Policy 與 Context)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_engineer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_full_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        執行完整 ETL 流程（v1.2: 強化順序與併發控制）</span>

<span class="sd">        流程:</span>
<span class="sd">        1. 檢查初始化順序（已於 __init__ 完成）</span>
<span class="sd">        2. BatchProcessor (Parser → Cleaner → Parquet + Manifest)</span>
<span class="sd">        3. Feature Engineer (Manifest → Feature Matrix，套用 device_role)</span>
<span class="sd">        4. 確保釋放檔案鎖</span>

<span class="sd">        錯誤處理:</span>
<span class="sd">        - AnnotationSyncError (E406): 終止流程</span>
<span class="sd">        - ContractViolationError: 終止流程</span>
<span class="sd">        - FutureDataError: 單檔案跳過（使用統一時間基準）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 啟動完整 ETL Pipeline，處理 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> 個檔案&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🕐 時間基準: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pipeline_timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1: Batch Processing</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_processor</span><span class="p">()</span>
            <span class="n">manifests</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">input_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">process_single_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
                        <span class="n">manifests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">manifest_path</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ 處理成功: </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;future_data_rejected&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  未來資料拒絕: </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 處理失敗: </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">ContractViolationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 檢查點 #2/#3 契約違反: </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">strict_mode</span><span class="p">:</span>
                        <span class="k">raise</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">manifests</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DataValidationError</span><span class="p">(</span><span class="s2">&quot;沒有成功處理的檔案，無法繼續特徵工程&quot;</span><span class="p">)</span>

            <span class="c1"># Step 2: Feature Engineering</span>
            <span class="n">fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_engineer</span><span class="p">()</span>
            <span class="n">manifest_path</span> <span class="o">=</span> <span class="n">manifests</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔧 開始特徵工程: </span><span class="si">{</span><span class="n">manifest_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># 讀取 Manifest 與資料</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">load_from_manifest</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">)</span>

            <span class="c1"># 檢查點 #4: FE Input Schema 驗證</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;🔍 檢查點 #4: FE Input Schema - 驗證中&quot;</span><span class="p">)</span>

            <span class="c1"># 轉換（含 device_role 與 ignore_warnings 處理）</span>
            <span class="n">feature_df</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">manifest_metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">cutoff_timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">cutoff_timestamp</span>
            <span class="p">)</span>

            <span class="n">elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get_elapsed_seconds</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ETL Pipeline 完成，輸出維度: </span><span class="si">{</span><span class="n">feature_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">，耗時: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 秒&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">feature_df</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># v1.2: 確保釋放檔案鎖</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_lock</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;重置所有快取實例（保留 Context 與 Lock）&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleaner</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_processor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_engineer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># 注意：不清除 _annotation_manager 與 context，確保順序不變</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;重置所有模組實例（保留 Context 與 AnnotationManager）&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="32-featureannotationmanagerv12">3.2 FeatureAnnotationManager（v1.2：維持不變，確保繼承合併正確性）</h3>
<p><strong>檔案</strong>: <code>src/features/annotation_manager.py</code></p>
<p><strong>說明</strong>: v1.2 維持 v1.1-REVISED 的實作，確保繼承合併邏輯穩定。此模組必須在 Container 初始化順序的 Step 3 完成。</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 內容與 v1.1-REVISED 相同，確保：</span>
<span class="c1"># 1. _load_with_inheritance() 正確處理 inherit: base</span>
<span class="c1"># 2. _deep_merge() 正確覆蓋父設定（非 append）</span>
<span class="c1"># 3. 循環繼承檢測（E407）</span>
<span class="c1"># （為簡潔省略程式碼，實際部署請複製 v1.1-REVISED 完整內容）</span>
</code></pre></div>

<hr />
<h2 id="4-cli-entry-point-">4. CLI 入口點 (Entry Point) - 整合時間基準與併發診斷</h2>
<h3 id="41-hvaccli-v12">4.1 HVACCLI 實作（v1.2 更新）</h3>
<p><strong>檔案</strong>: <code>src/main.py</code></p>
<p><strong>關鍵更新 (v1.2)</strong>:
- <code>run_etl</code> 指令顯示 PipelineContext 時間基準（供除錯）
- 新增 <code>diagnostics</code> 指令檢查初始化順序與時間基準
- 增強 <code>validate-annotation</code> 指令顯示鎖狀態</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fire</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.container</span><span class="w"> </span><span class="kn">import</span> <span class="n">ETLContainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.config_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigLoader</span><span class="p">,</span> <span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">AnnotationSyncError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContractViolationError</span><span class="p">,</span> <span class="n">FutureDataError</span><span class="p">,</span> <span class="n">DataValidationError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HVACCLI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HVAC Analytics CLI 介面 - v1.2</span>

<span class="sd">    提供統一的命令列入口，整合 ETL、建模與 Feature Annotation 管理。</span>
<span class="sd">    強化功能：時間基準可視化、併發診斷、初始化順序驗證。</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config/settings.yaml&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
            <span class="c1"># v1.2: 初始化 Container（會自動檢查 Annotation 同步、時間基準鎖定、繼承）</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">ETLContainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConfigurationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 配置錯誤: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">AnnotationSyncError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ E406 同步錯誤: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;💡 請執行: python main.py features validate-annotation&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;E003&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 併發衝突: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;💡 請確認是否有其他 Pipeline 實例正在執行&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_etl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*.csv&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        執行完整 ETL 流程（v1.2: 顯示時間基準與執行時間統計）</span>

<span class="sd">        Args:</span>
<span class="sd">            input_dir: 輸入 CSV 檔案目錄</span>
<span class="sd">            output_dir: 輸出目錄 (可選)</span>
<span class="sd">            pattern: 檔案匹配模式</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 輸入目錄不存在: </span><span class="si">{</span><span class="n">input_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  未找到匹配檔案: </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># v1.2: 顯示時間基準資訊</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 啟動 ETL Pipeline，處理 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> 個檔案...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🕐 Pipeline 時間基準: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">pipeline_timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2"> UTC&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔒 嚴格模式: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">strict_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 顯示 Annotation 資訊（含繼承鏈）</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">get_annotation_manager</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📋 Feature Annotation: Schema v</span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   繼承鏈: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">run_full_pipeline</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                <span class="n">output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">output_file</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">/</span> <span class="s2">&quot;feature_matrix.parquet&quot;</span>
                <span class="n">result_df</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💾 特徵矩陣已儲存: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_elapsed_seconds</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ETL 完成，輸出維度: </span><span class="si">{</span><span class="n">result_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">，總耗時: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 秒&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">AnnotationSyncError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ E406 Annotation 同步錯誤: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;請先執行: python main.py features validate-annotation&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ContractViolationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 契約違反錯誤: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">FutureDataError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  未來資料錯誤: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💡 提示: 使用時間基準 </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">pipeline_timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2"> 檢測到未來時間戳&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 未預期錯誤: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span>

    <span class="c1"># ==================== Feature Annotation 子命令群組 ====================</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">FeaturesCLI</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Feature Annotation v1.2 管理指令&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">wizard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">from_csv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            啟動互動式標註 Wizard（僅更新 Excel，不直寫 YAML）</span>

<span class="sd">            Usage:</span>
<span class="sd">                python main.py features wizard --site cgmh_ty --from-csv data/raw.csv</span>

<span class="sd">            流程:</span>
<span class="sd">            1. 偵測 CSV 新欄位</span>
<span class="sd">            2. 互動式確認物理類型/單位</span>
<span class="sd">            3. 寫入 Excel（標記 pending_review）</span>
<span class="sd">            4. 提示使用者手動執行 excel_to_yaml.py</span>

<span class="sd">            v1.2: 自動檢查是否有正在執行的 Pipeline（避免併發修改）</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">site</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span>
            <span class="n">csv_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">from_csv</span><span class="p">)</span> <span class="k">if</span> <span class="n">from_csv</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># v1.2: 檢查檔案鎖</span>
            <span class="n">lock_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lock_file_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">.yaml.lock&quot;</span>
            <span class="k">if</span> <span class="n">lock_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  警告: 偵測到 Pipeline 正在執行（鎖檔案存在）&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   建議等待 Pipeline 完成後再修改 Excel，避免 E406 衝突&quot;</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;是否繼續？ [y/N]: &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="k">return</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔧 啟動 Feature Annotation Wizard (v1.2)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📍 Site: </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  注意：Wizard 僅更新 Excel，不直接修改 YAML&quot;</span><span class="p">)</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">src.features.wizard</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureWizard</span>

            <span class="n">wizard</span> <span class="o">=</span> <span class="n">FeatureWizard</span><span class="p">(</span>
                <span class="n">site_id</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
                <span class="n">excel_base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">excel_base_dir</span><span class="p">,</span>
                <span class="n">template_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">current_template_version</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">excel_path</span> <span class="o">=</span> <span class="n">wizard</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">csv_path</span><span class="o">=</span><span class="n">csv_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ Excel 已更新: </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️  重要：請開啟 Excel 確認標註，確認後執行：&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   python tools/features/excel_to_yaml.py --input </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2"> --output config/features/sites/</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   或執行: python main.py features validate-annotation --site </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Wizard 失敗: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">validate_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            驗證 Annotation 並生成 YAML（執行 E400-E406 檢查，含繼承驗證）</span>

<span class="sd">            v1.2: 自動取得檔案鎖防止併發轉換</span>

<span class="sd">            Checks:</span>
<span class="sd">            - E400: Template 版本相容性、循環繼承檢測</span>
<span class="sd">            - E401: 孤兒欄位（標註存在但 CSV 不存在）</span>
<span class="sd">            - E402: 未定義欄位（CSV 存在但標註不存在）</span>
<span class="sd">            - E403: 單位與物理類型不匹配</span>
<span class="sd">            - E404: Lag 格式錯誤</span>
<span class="sd">            - E405: Target Leakage Risk</span>
<span class="sd">            - E406: Excel/YAML 不同步</span>
<span class="sd">            - E408: 檔案鎖衝突（v1.2 新增）</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">site</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span>
            <span class="n">excel_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">excel_base_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">site</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>
            <span class="n">yaml_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">yaml_base_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">.yaml&quot;</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔍 驗證 Feature Annotation: </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Excel: </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   YAML:  </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># v1.2: 嘗試取得檔案鎖</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">acquire_yaml_lock</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lock_file_dir</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔒 已取得獨佔鎖，開始驗證...&quot;</span><span class="p">)</span>

                    <span class="c1"># 檢查 E406 同步狀態</span>
                    <span class="n">sync_status</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">validate_annotation_sync</span><span class="p">(</span>
                        <span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">excel_base_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">yaml_base_dir</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sync_status</span><span class="p">[</span><span class="s1">&#39;synced&#39;</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  </span><span class="si">{</span><span class="n">sync_status</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ E406: Excel/YAML 同步檢查 - 通過&quot;</span><span class="p">)</span>

                    <span class="c1"># 執行轉換與驗證（含繼承合併測試）</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">tools.features.excel_to_yaml</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert_excel_to_yaml</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">convert_excel_to_yaml</span><span class="p">(</span>
                        <span class="n">excel_path</span><span class="o">=</span><span class="n">excel_path</span><span class="p">,</span>
                        <span class="n">output_path</span><span class="o">=</span><span class="n">yaml_path</span><span class="p">,</span>
                        <span class="n">validate_only</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>

                    <span class="c1"># 測試繼承載入</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.features.annotation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureAnnotationManager</span>
                    <span class="n">test_manager</span> <span class="o">=</span> <span class="n">FeatureAnnotationManager</span><span class="p">(</span>
                        <span class="n">site_id</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
                        <span class="n">yaml_base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">yaml_base_dir</span>
                    <span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ 驗證通過，YAML 已生成: </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Schema Version: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   繼承鏈: </span><span class="si">{</span><span class="n">test_manager</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_manager</span><span class="o">.</span><span class="n">get_column_configs</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Warnings: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warnings&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warnings&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ⚠️  </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">FileLockError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ E408: 無法取得檔案鎖: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;💡 請確認是否有其他處理程序正在執行&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 驗證失敗: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sync_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;檢查 Excel 與 YAML 同步狀態（E406 診斷）&quot;&quot;&quot;</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">site</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">validate_annotation_sync</span><span class="p">(</span>
                <span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">excel_base_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">yaml_base_dir</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 同步狀態檢查: </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   同步狀態: </span><span class="si">{</span><span class="s1">&#39;✅ 同步&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;synced&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;❌ 不同步&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   詳情: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;excel_mtime&#39;</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
                <span class="n">excel_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;excel_mtime&#39;</span><span class="p">])</span>
                <span class="n">yaml_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;yaml_mtime&#39;</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Excel 修改時間: </span><span class="si">{</span><span class="n">excel_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   YAML 修改時間:  </span><span class="si">{</span><span class="n">yaml_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># v1.2: 顯示鎖狀態</span>
            <span class="n">lock_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lock_file_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">.yaml.lock&quot;</span>
            <span class="k">if</span> <span class="n">lock_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">lock_age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">lock_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   🔒 檔案鎖狀態: 存在（已持續 </span><span class="si">{</span><span class="n">lock_age</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> 秒）&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   🔓 檔案鎖狀態: 未鎖定&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">migrate_excel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">from_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.1&quot;</span><span class="p">,</span> <span class="n">to_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.2&quot;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            升級 Excel 範本版本（v1.1 → v1.2）</span>

<span class="sd">            處理：</span>
<span class="sd">            - 新增 device_role 欄位（預設 primary）</span>
<span class="sd">            - 新增 ignore_warnings 欄位</span>
<span class="sd">            - 更新 System sheet 版本號</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">excel_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">excel_base_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">site</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔄 升級 Excel 範本: </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   路徑: </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   版本: </span><span class="si">{</span><span class="n">from_version</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">to_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">src.features.migrate_tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExcelMigrator</span>
            <span class="n">migrator</span> <span class="o">=</span> <span class="n">ExcelMigrator</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">migrator</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span>
                    <span class="n">excel_path</span><span class="o">=</span><span class="n">excel_path</span><span class="p">,</span>
                    <span class="n">from_version</span><span class="o">=</span><span class="n">from_version</span><span class="p">,</span>
                    <span class="n">to_version</span><span class="o">=</span><span class="n">to_version</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ 升級完成，請確認後執行 validate-annotation&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 升級失敗: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">show_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;顯示當前 Annotation 摘要（含繼承資訊）&quot;&quot;&quot;</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">site</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span>

            <span class="c1"># 強制重新載入以顯示最新狀態</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.features.annotation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureAnnotationManager</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">FeatureAnnotationManager</span><span class="p">(</span>
                <span class="n">site_id</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
                <span class="n">yaml_base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">yaml_base_dir</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📋 Feature Annotation 摘要: </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Schema Version: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   繼承鏈: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Columns (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">role_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">col</span><span class="o">.</span><span class="n">device_role</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">device_role</span> <span class="o">!=</span> <span class="s2">&quot;primary&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">target_tag</span> <span class="o">=</span> <span class="s2">&quot;[TARGET]&quot;</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">is_target</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">inherit_mark</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - </span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col</span><span class="o">.</span><span class="n">physical_type</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">role_tag</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">target_tag</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">inherit_mark</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">ignore_warnings</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                        忽略警告: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">ignore_warnings</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Feature Annotation 管理指令群組&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FeaturesCLI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># ==================== v1.2 新增：診斷指令 ====================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        系統診斷（v1.2 新增）</span>

<span class="sd">        檢查項目：</span>
<span class="sd">        1. 初始化順序驗證</span>
<span class="sd">        2. PipelineContext 時間基準</span>
<span class="sd">        3. 檔案鎖狀態</span>
<span class="sd">        4. 記憶體使用預估</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔧 HVAC Analytics 系統診斷&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="c1"># 1. 初始化順序驗證</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. 初始化順序驗證:&quot;</span><span class="p">)</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;PipelineContext&quot;</span><span class="p">,</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;檔案鎖狀態&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">_lock_acquired</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;AnnotationManager&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">_annotation_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="s1">&#39;✅&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;❌&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 2. 時間基準資訊</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. 時間基準資訊:&quot;</span><span class="p">)</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Pipeline Timestamp: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">pipeline_timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   已執行時間: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">get_elapsed_seconds</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 秒&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Config Hash: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">config_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 3. 檔案鎖狀態</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. 併發控制狀態:&quot;</span><span class="p">)</span>
        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">lock_file_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span><span class="si">}</span><span class="s2">.yaml.lock&quot;</span>
        <span class="k">if</span> <span class="n">lock_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">lock_age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">lock_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   狀態: 🔒 已鎖定（</span><span class="si">{</span><span class="n">lock_age</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> 秒）&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   狀態: 🔓 未鎖定&quot;</span><span class="p">)</span>

        <span class="c1"># 4. Annotation 摘要</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Annotation 狀態:&quot;</span><span class="p">)</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">get_annotation_manager</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Schema: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   繼承鏈: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   欄位數: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">get_column_configs</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ 診斷完成&quot;</span><span class="p">)</span>

    <span class="c1"># ==================== 原有指令 ====================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;驗證當前配置（含 Feature Annotation 與繼承）&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ 配置載入成功&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Site ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Flags: </span><span class="si">{</span><span class="n">VALID_QUALITY_FLAGS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Strict Mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">strict_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.features.annotation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureAnnotationManager</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">FeatureAnnotationManager</span><span class="p">(</span>
                <span class="n">site_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
                <span class="n">yaml_base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">yaml_base_dir</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📋 Feature Annotation:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Enabled: True&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Schema Version: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   繼承鏈: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Template Version: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">current_template_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Columns Defined: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">get_column_configs</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;顯示版本資訊&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HVAC Analytics Pipeline v1.2 (System Integration)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;核心更新:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - 嚴格初始化順序控制（E406→Manager→Modules）&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - PipelineContext 全域時間基準&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - YAML 檔案鎖併發控制&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;相容模組版本:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Parser: v2.1+ (支援 Context 時間基準)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Cleaner: v2.2+ (device_role 感知，不寫入 metadata)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - BatchProcessor: v1.3+ (Annotation checksum)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - FeatureEngineer: v1.3+ (Group Policy 支援)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - FeatureAnnotation: v1.2 (Excel-Centric + 繼承合併)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - InterfaceContract: v1.1 (錯誤代碼分層)&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entry point&quot;&quot;&quot;</span>
    <span class="n">fire</span><span class="o">.</span><span class="n">Fire</span><span class="p">(</span><span class="n">HVACCLI</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="5-error-handling-v12">5. 錯誤處理與傳播 (Error Handling) - v1.2 更新</h2>
<h3 id="51">5.1 錯誤傳播策略（整合時間基準與併發控制）</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">錯誤類型</th>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">發生模組</th>
<th style="text-align: center;">傳播策略</th>
<th style="text-align: left;">下游影響</th>
<th style="text-align: left;">使用者訊息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>EncodingError</code></td>
<td style="text-align: center;">E001</td>
<td style="text-align: left;">Parser</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">整批失敗</td>
<td style="text-align: left;">"檔案編碼錯誤"</td>
</tr>
<tr>
<td style="text-align: left;"><code>MemoryLimitError</code></td>
<td style="text-align: center;">E002</td>
<td style="text-align: left;">Container</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">系統保護</td>
<td style="text-align: left;">"記憶體超限"</td>
</tr>
<tr>
<td style="text-align: left;"><code>FileLockError</code></td>
<td style="text-align: center;">E003</td>
<td style="text-align: left;">ConfigLoader</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">等待重試</td>
<td style="text-align: left;">"檔案被鎖定，請等待其他處理程序完成"</td>
</tr>
<tr>
<td style="text-align: left;"><code>PipelineContextError</code></td>
<td style="text-align: center;">E004</td>
<td style="text-align: left;">Container</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">系統錯誤</td>
<td style="text-align: left;">"時間基準初始化失敗"</td>
</tr>
<tr>
<td style="text-align: left;"><code>FutureDataError</code></td>
<td style="text-align: center;">E102/E205/E303</td>
<td style="text-align: left;">Parser/Cleaner/BP</td>
<td style="text-align: center;"><strong>單檔跳過</strong></td>
<td style="text-align: left;">該檔案不入庫</td>
<td style="text-align: left;">"檔案含未來資料（相對於Pipeline啟動時間）"</td>
</tr>
<tr>
<td style="text-align: left;"><code>ContractViolationError</code></td>
<td style="text-align: center;">E204</td>
<td style="text-align: left;">Cleaner</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">依 strict_mode</td>
<td style="text-align: left;">"模組間介面契約違反"</td>
</tr>
<tr>
<td style="text-align: left;"><code>TEMPLATE_VERSION_MISMATCH</code></td>
<td style="text-align: center;">E400</td>
<td style="text-align: left;">ConfigLoader/FE</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">需升級 Excel</td>
<td style="text-align: left;">"範本版本過舊"</td>
</tr>
<tr>
<td style="text-align: left;"><code>ORPHAN_COLUMN</code></td>
<td style="text-align: center;">E401</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">記錄日誌</td>
<td style="text-align: left;">"標註欄位不存在於資料"</td>
</tr>
<tr>
<td style="text-align: left;"><code>UNANNOTATED_COLUMN</code></td>
<td style="text-align: center;">E402</td>
<td style="text-align: left;">ConfigLoader/Cleaner</td>
<td style="text-align: center;"><strong>終止/警告</strong></td>
<td style="text-align: left;">依 unannotated_column_policy</td>
<td style="text-align: left;">"資料欄位未定義"</td>
</tr>
<tr>
<td style="text-align: left;"><code>UNIT_INCOMPATIBLE</code></td>
<td style="text-align: center;">E403</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">返回 Excel 修正</td>
<td style="text-align: left;">"單位與物理類型不匹配"</td>
</tr>
<tr>
<td style="text-align: left;"><code>LAG_FORMAT_INVALID</code></td>
<td style="text-align: center;">E404</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">返回修正</td>
<td style="text-align: left;">"Lag 間隔格式錯誤"</td>
</tr>
<tr>
<td style="text-align: left;"><code>TARGET_LEAKAGE_RISK</code></td>
<td style="text-align: center;">E405</td>
<td style="text-align: left;">Pydantic Validation</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">自動攔截</td>
<td style="text-align: left;">"is_target=True 但 enable_lag=True"</td>
</tr>
<tr>
<td style="text-align: left;"><code>EXCEL_YAML_OUT_OF_SYNC</code></td>
<td style="text-align: center;">E406</td>
<td style="text-align: left;">ConfigLoader/Container</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">執行 validate-annotation</td>
<td style="text-align: left;">"Excel 較新，請重新生成 YAML"</td>
</tr>
<tr>
<td style="text-align: left;"><code>CIRCULAR_INHERITANCE</code></td>
<td style="text-align: center;">E407</td>
<td style="text-align: left;">FeatureAnnotationManager</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">修正 inherit 欄位</td>
<td style="text-align: left;">"循環繼承檢測"</td>
</tr>
<tr>
<td style="text-align: left;"><code>YAML_FILE_LOCKED</code></td>
<td style="text-align: center;">E408</td>
<td style="text-align: left;">ConfigLoader</td>
<td style="text-align: center;"><strong>終止/等待</strong></td>
<td style="text-align: left;">等待或重試</td>
<td style="text-align: left;">"YAML 檔案被鎖定"</td>
</tr>
<tr>
<td style="text-align: left;"><code>INIT_ORDER_VIOLATION</code></td>
<td style="text-align: center;">E901</td>
<td style="text-align: left;">Container</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">系統錯誤</td>
<td style="text-align: left;">"模組初始化順序違反"</td>
</tr>
<tr>
<td style="text-align: left;"><code>CONTEXT_NOT_INITIALIZED</code></td>
<td style="text-align: center;">E902</td>
<td style="text-align: left;">Container</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">系統錯誤</td>
<td style="text-align: left;">"PipelineContext 未初始化"</td>
</tr>
<tr>
<td style="text-align: left;"><code>DIRECT_YAML_WRITE_BLOCKED</code></td>
<td style="text-align: center;">E501</td>
<td style="text-align: left;">Wizard (防護)</td>
<td style="text-align: center;"><strong>終止</strong></td>
<td style="text-align: left;">使用正確流程</td>
<td style="text-align: left;">"禁止直接寫入 YAML，請使用 Excel"</td>
</tr>
<tr>
<td style="text-align: left;"><code>MEAN_OUT_OF_RANGE</code></td>
<td style="text-align: center;">W401</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">標記 pending_review</td>
<td style="text-align: left;">"平均值超出預期範圍"</td>
</tr>
<tr>
<td style="text-align: left;"><code>LOW_VARIANCE</code></td>
<td style="text-align: center;">W402</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">檢查凍結資料</td>
<td style="text-align: left;">"標準差接近零"</td>
</tr>
<tr>
<td style="text-align: left;"><code>HIGH_ZERO_RATIO</code></td>
<td style="text-align: center;">W403</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning/忽略</td>
<td style="text-align: left;">備用設備自動抑制</td>
<td style="text-align: left;">"零值比例過高"</td>
</tr>
</tbody>
</table>
<h3 id="52-v12">5.2 全域錯誤處理器（v1.2 更新）</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/exceptions.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HVACError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;基礎錯誤類別&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pipeline_timestamp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_timestamp</span> <span class="o">=</span> <span class="n">pipeline_timestamp</span>  <span class="c1"># v1.2: 記錄當時的時間基準</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ContractViolationError</span><span class="p">(</span><span class="n">HVACError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E204: 違反模組間介面契約&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FutureDataError</span><span class="p">(</span><span class="n">HVACError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    E102/E205/E303: 檢測到未來資料（相對於 Pipeline 時間基準）</span>

<span class="sd">    v1.2: 強制要求提供檢測到的時間戳與時間基準，用於除錯</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">detected_timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">pipeline_timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="s2">&quot;E205&quot;</span><span class="p">,</span> <span class="n">pipeline_timestamp</span><span class="o">=</span><span class="n">pipeline_timestamp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detected_timestamp</span> <span class="o">=</span> <span class="n">detected_timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ConfigurationError</span><span class="p">(</span><span class="n">HVACError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E001/E400-E408: 配置錯誤&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AnnotationSyncError</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E406: Excel 與 YAML 不同步&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FileLockError</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E003/E408: 檔案鎖定失敗&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InheritanceError</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E407: YAML 繼承鏈錯誤（循環或遺失）&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ValidationError</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E403-E405: Feature Annotation 驗證失敗&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InitializationError</span><span class="p">(</span><span class="n">HVACError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E901/E902: 初始化順序或 Context 錯誤&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecurityError</span><span class="p">(</span><span class="n">HVACError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;E501: 安全/職責分離違反&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<hr />
<h2 id="6-version-compatibility-matrix-v12">6. 版本相容性矩陣 (Version Compatibility Matrix) - v1.2 更新</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">System Integration</th>
<th style="text-align: center;">Parser</th>
<th style="text-align: center;">Cleaner</th>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;">Feature Annotation</th>
<th style="text-align: center;">Interface Contract</th>
<th style="text-align: center;">相容性</th>
<th style="text-align: left;">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>v1.2</strong></td>
<td style="text-align: center;">v2.1+</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;"><strong>v1.2</strong></td>
<td style="text-align: center;"><strong>v1.1</strong></td>
<td style="text-align: center;">✅ <strong>完全相容</strong></td>
<td style="text-align: left;">推薦配置，支援時間基準與併發控制</td>
</tr>
<tr>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v2.1+</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">⚠️ <strong>降級相容</strong></td>
<td style="text-align: left;">錯誤代碼分層可能不一致</td>
</tr>
<tr>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v2.0</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">❌ <strong>不相容</strong></td>
<td style="text-align: left;">Parser 必須 v2.1+ 支援 Context</td>
</tr>
<tr>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v2.1+</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">⚠️ <strong>部分相容</strong></td>
<td style="text-align: left;">缺少嚴格初始化順序與時間基準統一</td>
</tr>
<tr>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">❌ <strong>不相容</strong></td>
<td style="text-align: left;">缺少 Annotation 與順序控制</td>
</tr>
</tbody>
</table>
<p><strong>升級路徑 (v1.1 → v1.2)</strong>: 
1. <strong>System Integration</strong>（更新 Container 順序控制、新增 Context、檔案鎖）
2. <strong>Interface Contract</strong>（更新錯誤代碼分層 E0xx-E9xx）
3. <strong>Parser/Cleaner/BatchProcessor</strong>（支援 PipelineContext 時間基準注入）
4. 驗證併發控制（模擬多進程同時存取 YAML）</p>
<hr />
<h2 id="7-integration-test-plan-v12">7. 測試與驗證計畫 (Integration Test Plan) - v1.2 更新</h2>
<h3 id="71">7.1 全鏈路整合測試（新增順序、併發、時間基準測試）</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">測試案例 ID</th>
<th style="text-align: left;">描述</th>
<th style="text-align: left;">輸入</th>
<th style="text-align: left;">預期結果</th>
<th style="text-align: left;">驗證目標</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">INT-SYS-001</td>
<td style="text-align: left;">成功流程</td>
<td style="text-align: left;">標準 CSV + v1.2 Annotation</td>
<td style="text-align: left;">輸出 Feature Matrix，無錯誤</td>
<td style="text-align: left;">全鏈路無縫銜接</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-002</td>
<td style="text-align: left;">編碼自適應</td>
<td style="text-align: left;">Big5 編碼 CSV</td>
<td style="text-align: left;">正確解析</td>
<td style="text-align: left;">Parser v2.1</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-003</td>
<td style="text-align: left;">時區一致性</td>
<td style="text-align: left;">Asia/Taipei 輸入</td>
<td style="text-align: left;">轉換為 UTC</td>
<td style="text-align: left;">時區容錯</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-004</td>
<td style="text-align: left;">未來資料攔截</td>
<td style="text-align: left;">明天時間戳</td>
<td style="text-align: left;">單檔拒絕 (E205)</td>
<td style="text-align: left;">Data Leakage 防護</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-004-T</strong></td>
<td style="text-align: left;"><strong>時間基準一致性</strong></td>
<td style="text-align: left;">Pipeline 執行 10 分鐘後的「未來」資料</td>
<td style="text-align: left;">正確識別（不因時間流逝誤判）</td>
<td style="text-align: left;">Context 時間基準凍結</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-005</td>
<td style="text-align: left;">契約違反</td>
<td style="text-align: left;">缺少 timestamp</td>
<td style="text-align: left;">ContractViolationError</td>
<td style="text-align: left;">檢查點 #1</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-006</td>
<td style="text-align: left;">SSOT 同步</td>
<td style="text-align: left;">SENSOR_OFFLINE flag</td>
<td style="text-align: left;">One-hot 自動包含</td>
<td style="text-align: left;">SSOT 一致性</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-007R</td>
<td style="text-align: left;">繼承合併</td>
<td style="text-align: left;">cgmh_ty 繼承 base</td>
<td style="text-align: left;">正確合併 base 的 physical_types</td>
<td style="text-align: left;">繼承機制驗證</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-008R</td>
<td style="text-align: left;">循環繼承防護</td>
<td style="text-align: left;">A inherit B, B inherit A</td>
<td style="text-align: left;">拋出 E407</td>
<td style="text-align: left;">循環檢測驗證</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-009</td>
<td style="text-align: left;">E406 同步檢查</td>
<td style="text-align: left;">修改 Excel 但未生成 YAML</td>
<td style="text-align: left;">Pipeline 啟動時拒絕 (E406)</td>
<td style="text-align: left;">檢查點 #5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-009-C</strong></td>
<td style="text-align: left;"><strong>併發寫入防護</strong></td>
<td style="text-align: left;">同時執行兩個 Pipeline 實例</td>
<td style="text-align: left;">第二個實例取得 E003</td>
<td style="text-align: left;">檔案鎖機制</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-009-W</strong></td>
<td style="text-align: left;"><strong>Wizard 併發防護</strong></td>
<td style="text-align: left;">Pipeline 執行中執行 Wizard</td>
<td style="text-align: left;">Wizard 顯示警告</td>
<td style="text-align: left;">鎖狀態偵測</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-010R</td>
<td style="text-align: left;">Cleaner 職責分離</td>
<td style="text-align: left;">backup 設備執行清洗</td>
<td style="text-align: left;">Cleaner 讀取 role 但不寫入 metadata</td>
<td style="text-align: left;">職責邊界驗證</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-011</td>
<td style="text-align: left;">device_role 傳遞</td>
<td style="text-align: left;">backup 設備 80% 零值</td>
<td style="text-align: left;">FE 抑制 W403 警告</td>
<td style="text-align: left;">device_role 感知</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-012</td>
<td style="text-align: left;">Group Policy 執行</td>
<td style="text-align: left;">chillers_* 欄位</td>
<td style="text-align: left;">正確套用 Standard_Chiller 模板</td>
<td style="text-align: left;">Group Policy 整合</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-013</td>
<td style="text-align: left;">ignore_warnings 生效</td>
<td style="text-align: left;">標記 W401 忽略</td>
<td style="text-align: left;">該欄位不觸發均值異常警告</td>
<td style="text-align: left;">警告抑制機制</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-014</td>
<td style="text-align: left;">未定義欄位處理</td>
<td style="text-align: left;">CSV 含未標註欄位</td>
<td style="text-align: left;">依 unannotated_column_policy 處理</td>
<td style="text-align: left;">E402 驗證</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-015</td>
<td style="text-align: left;">Template 版本相容</td>
<td style="text-align: left;">v1.1 Excel 執行轉換</td>
<td style="text-align: left;">報錯 E400，提示 migrate</td>
<td style="text-align: left;">版本控制</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-016</strong></td>
<td style="text-align: left;"><strong>初始化順序驗證</strong></td>
<td style="text-align: left;">強制交換 Cleaner 與 Manager 初始化順序</td>
<td style="text-align: left;">拋出 E901</td>
<td style="text-align: left;">順序強制執行</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-deliverables-v12">8. 交付物清單 (Deliverables) - v1.2 更新</h2>
<h3 id="81-v12">8.1 程式碼檔案（v1.2 新增與修改）</h3>
<ol>
<li><code>src/context.py</code> - <strong>v1.2 新增</strong>: PipelineContext 時間基準與狀態載體</li>
<li><code>src/etl/config_models.py</code> - <strong>v1.2 更新</strong>: 新增 ConcurrencyConfig、錯誤代碼分層 E0xx-E9xx</li>
<li><code>src/utils/config_loader.py</code> - <strong>v1.2 更新</strong>: 新增 <code>acquire_yaml_lock()</code> 檔案鎖機制</li>
<li><code>src/container.py</code> - <strong>v1.2 重構</strong>: 嚴格初始化順序控制（Step 1-4）、Context 注入、檔案鎖管理</li>
<li><code>src/main.py</code> - <strong>v1.2 更新</strong>: 新增 <code>diagnostics</code> 指令、時間基準顯示</li>
<li><code>src/features/annotation_manager.py</code> - <strong>維持 v1.1</strong>: 繼承合併邏輯</li>
<li><code>src/exceptions.py</code> - <strong>v1.2 更新</strong>: 新增錯誤代碼 E003, E004, E408, E901, E902</li>
</ol>
<h3 id="82">8.2 配置檔案</h3>
<ol>
<li><code>config/settings.yaml</code> - <strong>v1.2 更新</strong>: 新增 <code>concurrency</code> 與 <code>feature_annotation.lock_file_dir</code></li>
<li><code>config/features/schema.json</code> - <strong>維持</strong>: JSON Schema v1.2</li>
</ol>
<h3 id="83-v12">8.3 測試檔案（v1.2 新增）</h3>
<ol>
<li><code>tests/test_concurrency_control.py</code> - <strong>v1.2 新增</strong>: 檔案鎖、併發存取測試</li>
<li><code>tests/test_initialization_order.py</code> - <strong>v1.2 新增</strong>: 順序違反檢測測試 (E901)</li>
<li><code>tests/test_pipeline_context.py</code> - <strong>v1.2 新增</strong>: 時間基準凍結、未來資料檢查一致性</li>
<li><code>tests/test_integration_full_pipeline.py</code> - <strong>v1.2 更新</strong>: 新增 INT-SYS-004-T, 009-C, 009-W, 016</li>
</ol>
<h3 id="84">8.4 文件檔案</h3>
<ol>
<li><code>docs/integration/PRD_System_Integration_v1.2.md</code> - <strong>本文件</strong></li>
<li><code>docs/integration/TROUBLESHOOTING.md</code> - <strong>v1.2 新增</strong>: 錯誤代碼查詢與解決方案（E003, E406, E901 等）</li>
</ol>
<hr />
<h2 id="9-action-items-v12">9. 執行檢查清單 (Action Items) - v1.2 執行順序</h2>
<h3 id="phase-1-day-1">Phase 1: 基礎設施與時間基準（Day 1）</h3>
<ul>
<li>[ ] 建立 <code>src/context.py</code>：實作 <code>PipelineContext</code> 類別（時間基準凍結、未來資料檢查方法）</li>
<li>[ ] 更新 <code>src/etl/config_models.py</code>：新增 <code>ConcurrencyConfig</code>、更新錯誤代碼分層（E0xx-E9xx）</li>
<li>[ ] 驗證：Context 產生後時間基準不再變動</li>
</ul>
<h3 id="phase-2-day-2">Phase 2: 併發控制（Day 2）</h3>
<ul>
<li>[ ] 更新 <code>src/utils/config_loader.py</code>：實作 <code>acquire_yaml_lock()</code> 使用 <code>fcntl.LOCK_EX</code></li>
<li>[ ] 建立鎖檔案目錄 <code>data/.locks</code> 並確保權限正確</li>
<li>[ ] 驗證：同時執行兩個 Container 實例，第二個應收到 E003 錯誤</li>
</ul>
<h3 id="phase-3-day-3-4">Phase 3: 初始化順序控制（Day 3-4）</h3>
<ul>
<li>[ ] 重構 <code>src/container.py</code>：</li>
<li>[ ] 實作 <code>__init__</code> 四步驟順序（Context → Lock → Manager → Others）</li>
<li>[ ] 實作 <code>_initialize_in_order()</code> 與順序驗證</li>
<li>[ ] 確保 <code>get_cleaner()</code> 檢查 AnnotationManager 已初始化（E901）</li>
<li>[ ] 實作 <code>__del__</code> 確保鎖釋放</li>
<li>[ ] 驗證：交換初始化順序應觸發 E901 錯誤（使用測試案例 INT-SYS-016）</li>
</ul>
<h3 id="phase-4-day-5">Phase 4: 模組整合（Day 5）</h3>
<ul>
<li>[ ] 更新 <code>ReportParser</code>：接受 <code>context</code> 參數，使用 <code>context.is_future_timestamp()</code> 替代 <code>datetime.now()</code></li>
<li>[ ] 更新 <code>DataCleaner</code>：接受 <code>context</code> 參數，統一時間檢查基準</li>
<li>[ ] 更新 <code>BatchOrchestrator</code>：接受 <code>context</code> 參數，寫入 Manifest 時記錄 <code>pipeline_timestamp</code></li>
<li>[ ] 更新 <code>FeatureEngineer</code>：接受 <code>context</code> 參數</li>
<li>[ ] 驗證：長時間執行（模擬 10 分鐘）後，未來資料檢查仍使用初始時間基準</li>
</ul>
<h3 id="phase-5-cli-day-6">Phase 5: CLI 與診斷（Day 6）</h3>
<ul>
<li>[ ] 更新 <code>src/main.py</code>：新增 <code>diagnostics</code> 指令顯示時間基準與鎖狀態</li>
<li>[ ] 更新 <code>run_etl</code>：顯示 PipelineContext 時間基準</li>
<li>[ ] 更新 <code>validate_annotation</code>：整合檔案鎖取得邏輯</li>
<li>[ ] 建立 <code>docs/integration/TROUBLESHOOTING.md</code></li>
</ul>
<h3 id="phase-6-day-7">Phase 6: 整合測試（Day 7）</h3>
<ul>
<li>[ ] 執行 INT-SYS-004-T（時間基準凍結測試）</li>
<li>[ ] 執行 INT-SYS-009-C（併發衝突測試）</li>
<li>[ ] 執行 INT-SYS-009-W（Wizard 併發偵測測試）</li>
<li>[ ] 執行 INT-SYS-016（初始化順序強制執行測試）</li>
<li>[ ] 執行既有測試 INT-SYS-001~015 確保無迴歸</li>
</ul>
<hr />
<h2 id="10-sign-off-checklist-v12">10. 驗收簽核 (Sign-off Checklist) - v1.2</h2>
<h3 id="_1">核心功能驗收</h3>
<ul>
<li>[ ] <strong>初始化順序強制執行</strong>: 違反順序（如先初始化 Cleaner 再初始化 Manager）會拋出 E901</li>
<li>[ ] <strong>時間基準凍結</strong>: Pipeline 執行 10 分鐘後，「未來資料」檢查仍使用啟動時的時間基準</li>
<li>[ ] <strong>檔案鎖機制</strong>: 同時執行兩個 Pipeline 實例，第二個實例正確收到 E003 錯誤並退出</li>
<li>[ ] <strong>Wizard 併發偵測</strong>: Pipeline 執行中執行 Wizard，Wizard 正確偵測鎖檔案並顯示警告</li>
</ul>
<h3 id="ssot-annotation-v11">SSOT 與 Annotation 驗收（維持 v1.1 標準）</h3>
<ul>
<li>[ ] <strong>SSOT 一致性</strong>: Excel 為 Annotation 唯一編輯入口，無全域預設值</li>
<li>[ ] <strong>單向流驗證</strong>: Wizard 無法直接寫入 YAML，必須透過 Excel → excel_to_yaml.py</li>
<li>[ ] <strong>繼承機制</strong>: <code>inherit: base</code> 正確合併父設定，循環繼承正確檢測並拋出 E407</li>
<li>[ ] <strong>Cleaner 職責分離</strong>: Cleaner 讀取 device_role 僅用於調整清洗閾值（不寫入 metadata）</li>
</ul>
<h3 id="_2">錯誤處理與診斷驗收</h3>
<ul>
<li>[ ] <strong>錯誤代碼分層</strong>: 所有錯誤代碼符合 E0xx-E9xx 分層規範</li>
<li>[ ] <strong>診斷指令</strong>: <code>python main.py diagnostics</code> 正確顯示時間基準、初始化順序、鎖狀態</li>
<li>[ ] <strong>錯誤資訊豐富度</strong>: FutureDataError 包含檢測到的時間戳與 Pipeline 時間基準，便於除錯</li>
</ul>
<hr />
<h2 id="v11-v12">附錄：v1.1 → v1.2 變更摘要</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">類別</th>
<th style="text-align: left;">v1.1 狀態</th>
<th style="text-align: left;">v1.2 變更</th>
<th style="text-align: left;">影響風險</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>初始化順序</strong></td>
<td style="text-align: left;">文字描述，無強制執行</td>
<td style="text-align: left;">四步驟嚴格順序，違反拋 E901</td>
<td style="text-align: left;">低（僅防止錯誤使用）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準</strong></td>
<td style="text-align: left;">各模組各自呼叫 <code>now()</code></td>
<td style="text-align: left;"><code>PipelineContext</code> 統一基準</td>
<td style="text-align: left;">中（需更新 Parser/Cleaner/BP/FE）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>併發控制</strong></td>
<td style="text-align: left;">無</td>
<td style="text-align: left;"><code>fcntl</code> 檔案鎖機制</td>
<td style="text-align: left;">低（新增功能）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>錯誤代碼</strong></td>
<td style="text-align: left;">E400-E407, E800 衝突</td>
<td style="text-align: left;">E0xx-E9xx 分層，新增 E003, E004, E408, E901, E902</td>
<td style="text-align: left;">低（文件與 Exception 定義）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Container 生命周期</strong></td>
<td style="text-align: left;">無檔案鎖管理</td>
<td style="text-align: left;"><code>__init__</code> 取得鎖，<code>__del__</code> 釋放鎖</td>
<td style="text-align: left;">中（需確保異常時正確釋放）</td>
</tr>
<tr>
<td style="text-align: left;">```</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
    
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>

</body>
</html>
