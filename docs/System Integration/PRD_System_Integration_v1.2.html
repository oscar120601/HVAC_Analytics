<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_System_Integration_v1.2</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v12-system-integration-architecture">PRD v1.2: ç³»çµ±æ•´åˆæ¶æ§‹ (System Integration Architecture)</h1>
<h1 id="feature-annotation-v12">æ•´åˆ Feature Annotation v1.2 + åˆå§‹åŒ–é †åºæ§åˆ¶ + æ™‚é–“åŸºæº–åŒæ­¥æ©Ÿåˆ¶</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.2 (Ordered Initialization &amp; Temporal Consistency)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/container.py</code>, <code>src/main.py</code>, <code>src/utils/config_loader.py</code>, <code>src/features/annotation_manager.py</code>, <code>src/context.py</code><br />
<strong>ç›¸ä¾æ¨¡çµ„:</strong> <br />
- Parser v2.1+, Cleaner v2.2+, BatchProcessor v1.3+, Feature Engineer v1.3+<br />
- Feature Annotation v1.2 (Excel-Centric SSOT)<br />
- <strong>Interface Contract v1.1</strong> (éŒ¯èª¤ä»£ç¢¼åˆ†å±¤èˆ‡æ™‚é–“åŸºæº–è¦ç¯„)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 6 ~ 7 å€‹å·¥ç¨‹å¤©ï¼ˆå«ä½µç™¼æ§åˆ¶èˆ‡é †åºé©—è­‰æ¸¬è©¦ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆå“²å­¸</h2>
<h3 id="11">1.1 æ ¸å¿ƒç›®æ¨™</h3>
<p>å»ºç«‹<strong>é›¶é–“éš™å°æ¥</strong>ä¸”<strong>æ™‚ç©ºä¸€è‡´</strong>çš„å®Œæ•´ ETL Pipelineï¼Œå¼·åŒ–ç³»çµ±ç©©å®šæ€§ï¼š</p>
<ol>
<li><strong>é…ç½®å–®ä¸€çœŸç›¸æº (SSOT)</strong>: <br />
   - é‹è¡Œæ™‚é…ç½®ï¼š<code>ETLConfig</code> å¯¦ä¾‹<br />
   - ç‰¹å¾µå®šç¾©ï¼š<strong>Excel å”¯ä¸€ç·¨è¼¯</strong> â†’ YAML SSOT â†’ Pipeline æ¶ˆè²»</li>
<li><strong>åš´æ ¼åˆå§‹åŒ–é †åº (Critical)</strong>: <strong>E406é©—è­‰ â†’ Manageråˆå§‹åŒ– â†’ å…¶ä»–æ¨¡çµ„</strong>ï¼Œé˜²æ­¢Race Conditionèˆ‡ç­–ç•¥å¤±æ•ˆ</li>
<li><strong>å…¨åŸŸæ™‚é–“åŸºæº– (Pipeline Timestamp)</strong>: çµ±ä¸€<code>pipeline_timestamp</code>ï¼Œé˜²æ­¢PipelineåŸ·è¡ŒæœŸé–“çš„ã€Œæœªä¾†è³‡æ–™ã€æ¼‚ç§»èª¤åˆ¤</li>
<li><strong>ä½µç™¼æ§åˆ¶</strong>: YAMLæª”æ¡ˆè®€å¯«é–ï¼Œé˜²æ­¢Wizardèˆ‡PipelineåŒæ™‚å­˜å–SSOT</li>
<li><strong>ä¾è³´æ³¨å…¥ (DI)</strong>: é€é <code>Container</code> ç®¡ç†æ¨¡çµ„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…å« <code>FeatureAnnotationManager</code></li>
<li><strong>å¥‘ç´„æª¢æŸ¥é»</strong>: 6 å€‹é—œéµæª¢æŸ¥é»ï¼ˆæ–°å¢ Annotation åŒæ­¥æª¢æŸ¥ #5, #6ï¼‰</li>
</ol>
<h3 id="12-v12">1.2 æ¶æ§‹æ¦‚è¦½ï¼ˆv1.2 æ›´æ–°ï¼‰</h3>
<pre><code class="language-mermaid">graph TB
    subgraph &quot;Initialization Phase (Sequential)&quot;
        INIT1[Step 1: ç”¢ç”Ÿ PipelineContext&lt;br/&gt;é–å®š pipeline_timestamp] --&gt; INIT2[Step 2: E406 åŒæ­¥é©—è­‰&lt;br/&gt;æª”æ¡ˆé–å®šé˜²æ­¢ä½µç™¼]
        INIT2 --&gt; INIT3[Step 3: åˆå§‹åŒ– FeatureAnnotationManager&lt;br/&gt;è¼‰å…¥ä¸¦åˆä½µç¹¼æ‰¿éˆ]
        INIT3 --&gt; INIT4[Step 4: åˆå§‹åŒ–å…¶ä»–æ¨¡çµ„&lt;br/&gt;Parser/Cleaner/Batch/FE]
    end

    subgraph &quot;Feature Annotation Layer (v1.2)&quot;
        FA1[Excel Template&lt;br/&gt;*.xlsx] --&gt;|ç·¨è¼¯| FA2[ç©ºèª¿æŠ€å¸«/å·¥ç¨‹å¸«]
        FA2 --&gt;|æ‰‹å‹•è§¸ç™¼| FA3[excel_to_yaml.py]
        FA3 --&gt;|é©—è­‰| FA4{æª¢æŸ¥é» #5&lt;br/&gt;Annotation Valid}
        FA4 --&gt;|ç”Ÿæˆ| FA5[config/features/sites/*.yaml&lt;br/&gt;SSOT]
        FA5 --&gt;|Git PR| FA6[Config Server]
    end

    subgraph &quot;Configuration Layer&quot;
        A[settings.yaml] --&gt; B[ConfigLoader]
        B --&gt; C[ETLConfig SSOT]
        FA6 --&gt;|è¼‰å…¥| C
    end

    subgraph &quot;Dependency Injection Container&quot;
        C --&gt; D[ETLContainer]
        D --&gt; E[ReportParser v2.1]
        D --&gt; F[DataCleaner v2.2]
        D --&gt; G[BatchOrchestrator v1.3]
        D --&gt; H[FeatureEngineer v1.3]
        D --&gt; I[FeatureAnnotationManager&lt;br/&gt;v1.2]
    end

    subgraph &quot;Pipeline Execution&quot;
        E --&gt;|Raw DF UTC| F
        F --&gt;|Clean DF&lt;br/&gt;èªæ„æ„ŸçŸ¥æ¸…æ´—| G
        G --&gt;|Parquet + Manifest&lt;br/&gt;å« annotation_checksum| H
        H --&gt;|Feature Matrix&lt;br/&gt;å¥—ç”¨ device_role &amp; Group Policy| J[Model Training]
    end

    subgraph &quot;Contract Checkpoints&quot;
        CP1{æª¢æŸ¥é» #1&lt;br/&gt;Parser Output}
        CP2{æª¢æŸ¥é» #2&lt;br/&gt;Cleaner Output}
        CP3{æª¢æŸ¥é» #3&lt;br/&gt;BatchProcessor Output}
        CP4{æª¢æŸ¥é» #4&lt;br/&gt;FE Input Schema}
        CP5{æª¢æŸ¥é» #5&lt;br/&gt;Excel/YAML Sync}
        CP6{æª¢æŸ¥é» #6&lt;br/&gt;Annotation Version}
    end

    E -.-&gt; CP1 -.-&gt; F
    F -.-&gt; CP2 -.-&gt; G
    G -.-&gt; CP3 -.-&gt; H
    H -.-&gt; CP4 -.-&gt; J
    FA1 -.-&gt; CP5 -.-&gt; FA3
    FA5 -.-&gt; CP6 -.-&gt; I

    style C fill:#f9f,stroke:#333,stroke-width:4px
    style D fill:#bbf,stroke:#333,stroke-width:4px
    style FA1 fill:#f9f,stroke:#f00,stroke-width:2px
    style FA5 fill:#bbf,stroke:#00f,stroke-width:2px
    style INIT1 fill:#ff9,stroke:#f00,stroke-width:3px
    style INIT2 fill:#ff9,stroke:#f00,stroke-width:3px
    style INIT3 fill:#ff9,stroke:#f00,stroke-width:3px
</code></pre>
<hr />
<h2 id="2-ssot-configuration-system">2. SSOT é…ç½®ç³»çµ± (Configuration System)</h2>
<h3 id="21-feature-annotation-v12">2.1 çµ±ä¸€é…ç½®çµæ§‹ï¼ˆæ•´åˆ Feature Annotation v1.2ï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/config_models.py</code> (æ ¸å¿ƒ SSOT)</p>
<p><strong>é—œéµæ›´æ–°</strong>:<br />
- æ–°å¢ <code>FeatureAnnotationConfig</code> è¨­å®š Annotation è·¯å¾‘èˆ‡ç‰ˆæœ¬æª¢æŸ¥<br />
- <code>ETLConfig</code> æ–°å¢ <code>feature_annotation</code> æ¬„ä½<br />
- <strong>ç§»é™¤ <code>CleanerConfig.default_device_role</code>ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šé¿å…éš±æ€§é è¨­å€¼ï¼‰</strong><br />
- <strong>æ–°å¢ <code>CleanerConfig.unannotated_column_policy</code>ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šæœªå®šç¾©æ¬„ä½è™•ç†ç­–ç•¥ï¼‰</strong><br />
- <strong>æ–°å¢ <code>ETLConfig.concurrency</code> è¨­å®šä½µç™¼æ§åˆ¶åƒæ•¸ï¼ˆv1.2ï¼‰</strong></p>
<pre><code class="language-python">from typing import Final, List, Dict, Optional, Literal
from pydantic import BaseModel, validator, Field

# SSOT 1: Quality Flags (6å€‹æ¨™æº–å€¼ï¼Œå…¨åŸŸå”¯ä¸€)
VALID_QUALITY_FLAGS: Final[List[str]] = [
    &quot;FROZEN&quot;,           # æ•¸æ“šå‡çµï¼ˆé€£çºŒ3å€‹å€é–“å€¼ç›¸åŒï¼‰
    &quot;HEAT_IMBALANCE&quot;,   # ç†±å¹³è¡¡åå·® &gt; 5%
    &quot;AFFINITY_VIOLATION&quot;, # é•åè¦ªå’Œå¾‹ &gt; 15%
    &quot;OUTLIER&quot;,          # çµ±è¨ˆé›¢ç¾¤å€¼ï¼ˆIQRæ³•ï¼‰
    &quot;INSUFFICIENT_DATA&quot;, # æ™‚é–“ç©ºç¼ºè£œå…¨æ¨™è¨˜
    &quot;SENSOR_OFFLINE&quot;    # æ„Ÿæ¸¬å™¨é›¢ç·šï¼ˆæ–°å¢ï¼‰
]

# SSOT 2: æ™‚é–“æˆ³è¦ç¯„ (æ‰€æœ‰æ¨¡çµ„å¿…é ˆéµå®ˆ)
TIMESTAMP_CONFIG: Final[Dict] = {
    &quot;dtype&quot;: &quot;Datetime&quot;,
    &quot;time_unit&quot;: &quot;nanoseconds&quot;,  # ns
    &quot;time_zone&quot;: &quot;UTC&quot;,          # å¼·åˆ¶UTC
    &quot;parquet_physical_type&quot;: &quot;INT64&quot;  # ç¦æ­¢INT96
}

# SSOT 3: Feature Annotation ç›¸é—œå¸¸æ•¸ï¼ˆæ–°å¢ï¼‰
FEATURE_ANNOTATION_CONSTANTS: Final[Dict] = {
    &quot;current_template_version&quot;: &quot;1.2&quot;,
    &quot;expected_schema_version&quot;: &quot;1.2&quot;,
    &quot;checksum_algorithm&quot;: &quot;sha256&quot;
}

# SSOT 4: éŒ¯èª¤ä»£ç¢¼åˆ†å±¤è¦ç¯„ï¼ˆä¸»è¦å®šç¾©è¦‹ Interface Contract v1.0ï¼‰
ERROR_CODE_REGISTRY: Final[Dict[str, str]] = {
    # E000: å…¨åŸŸ
    &quot;E000&quot;: &quot;Temporal baseline missing&quot;,
    # E0xx: ç³»çµ±å±¤
    &quot;E006&quot;: &quot;Memory limit exceeded&quot;, 
    &quot;E007&quot;: &quot;Config file corrupted&quot;,
    # E1xx: Parser (Critical)
    &quot;E101&quot;: &quot;Encoding/BOM mismatch&quot;,
    &quot;E102&quot;: &quot;Timezone violation (Non-UTC)&quot;,
    &quot;E103&quot;: &quot;Contract violation (Missing cols/flags)&quot;,
    &quot;E104&quot;: &quot;Header not found&quot;,
    &quot;E105&quot;: &quot;Column validation failed&quot;,
    # E1xx: Parser (Warnings)
    &quot;E111&quot;: &quot;Timezone warning (Auto-converted)&quot;,
    &quot;E112&quot;: &quot;Future data detected (Parser)&quot;,
    &quot;E113&quot;: &quot;Unknown quality flag (Parser)&quot;,
    &quot;E114&quot;: &quot;Unit conversion error&quot;,
    &quot;E115&quot;: &quot;Encoding warning&quot;,
    # E2xx: Cleaner
    &quot;E201&quot;: &quot;Input schema mismatch&quot;,
    &quot;E202&quot;: &quot;Unknown quality flag (Batch)&quot;,
    &quot;E203&quot;: &quot;Metadata loss&quot;,
    &quot;E205&quot;: &quot;Future data in batch&quot;,
    &quot;E206&quot;: &quot;Parquet format violation&quot;,
    # E3xx: BatchProcessor
    &quot;E301&quot;: &quot;Manifest integrity failed&quot;,
    &quot;E302&quot;: &quot;Schema mismatch (Storage)&quot;,
    &quot;E303&quot;: &quot;Unknown quality flag (Storage)&quot;,
    &quot;E304&quot;: &quot;Metadata missing (Manifest)&quot;,
    &quot;E305&quot;: &quot;Data leakage detected&quot;,
    # E35x: Equipment Validation
    &quot;E350&quot;: &quot;Constraint config error&quot;,
    &quot;E351&quot;: &quot;Requires violation&quot;,
    &quot;E352&quot;: &quot;Mutex violation&quot;,
    &quot;E353&quot;: &quot;Sequence violation&quot;,
    &quot;E354&quot;: &quot;Min runtime violation&quot;,
    &quot;E355&quot;: &quot;Min downtime violation&quot;,
    # E4xx: Feature Annotation
    &quot;E400&quot;: &quot;Annotation version mismatch&quot;,
    &quot;E401&quot;: &quot;Orphan column&quot;,
    &quot;E402&quot;: &quot;Unannotated column&quot;,
    &quot;E403&quot;: &quot;Unit incompatible&quot;,
    &quot;E404&quot;: &quot;Lag format invalid&quot;,
    &quot;E405&quot;: &quot;Target leakage risk&quot;,
    &quot;E406&quot;: &quot;Excel/YAML out of sync&quot;,
    &quot;E407&quot;: &quot;Circular inheritance&quot;,
    # E5xx: Governance
    &quot;E500&quot;: &quot;Device role leakage&quot;,
    &quot;E501&quot;: &quot;Direct write attempt blocked&quot;,
    # E6xx: Feature Engineer
    &quot;E601&quot;: &quot;Feature order not recorded&quot;,
    &quot;E602&quot;: &quot;Scaler params missing&quot;,
    &quot;E603&quot;: &quot;Feature matrix shape error&quot;,
    &quot;E604&quot;: &quot;Invalid lag configuration&quot;,
    # E7xx: Model Training
    &quot;E701&quot;: &quot;Training memory error&quot;,
    &quot;E702&quot;: &quot;Validation failure&quot;,
    &quot;E703&quot;: &quot;Hyperparameter invalid&quot;,
    &quot;E704&quot;: &quot;Checkpoint save failed&quot;,
    &quot;E705&quot;: &quot;Cross validation error&quot;,
    &quot;E706&quot;: &quot;Model artifact corrupted&quot;,
    # E75x: Hybrid Consistency
    &quot;E750&quot;: &quot;Golden dataset unavailable&quot;,
    &quot;E751&quot;: &quot;Dynamic tolerance exceeded&quot;,
    &quot;E752&quot;: &quot;Systematic bias detected&quot;,
    &quot;E753&quot;: &quot;Trend mismatch&quot;,
    &quot;E754&quot;: &quot;Outlier violation&quot;,
    &quot;E755&quot;: &quot;Insufficient components&quot;,
    &quot;E756&quot;: &quot;Partial components (L2)&quot;,
    &quot;E757&quot;: &quot;Light load variance&quot;,
    &quot;E758&quot;: &quot;Copula effect detected&quot;,
    &quot;E759&quot;: &quot;Dataset quality warning&quot;,
    # E8xx: Optimization
    &quot;E801&quot;: &quot;Model load failed&quot;,
    &quot;E802&quot;: &quot;Constraint violation&quot;,
    &quot;E803&quot;: &quot;Optimization divergence&quot;,
    &quot;E804&quot;: &quot;Bound infeasibility&quot;,
    &quot;E805&quot;: &quot;Forecast horizon mismatch&quot;,
    &quot;E806&quot;: &quot;System model discrepancy&quot;,
    &quot;E807&quot;: &quot;Equipment state invalid&quot;,
    &quot;E808&quot;: &quot;Weather data missing&quot;,
    # E9xx: Cross-Stage
    &quot;E901&quot;: &quot;Feature alignment mismatch&quot;,
    &quot;E902&quot;: &quot;Feature dimension mismatch&quot;,
    &quot;E903&quot;: &quot;Scaler mismatch&quot;,
    &quot;E904&quot;: &quot;Model version incompatible&quot;,
    &quot;E905&quot;: &quot;Pipeline version drift&quot;,
}

# SSOT 5: Feature Metadata Schemaï¼ˆæ›´æ–°ï¼šæ”¯æ´ device_roleï¼‰
class FeatureMetadata(BaseModel):
    column_name: str
    physical_type: Literal[
        &quot;temperature&quot;, &quot;flow_rate&quot;, &quot;power&quot;, &quot;status&quot;, 
        &quot;humidity&quot;, &quot;gauge&quot;, &quot;chiller_load&quot;, &quot;cooling_tower_load&quot;
    ]
    unit: Optional[str] = None           # &quot;LPM&quot;, &quot;kW&quot;, &quot;Â°C&quot;, &quot;%&quot;
    device_role: Literal[&quot;primary&quot;, &quot;backup&quot;, &quot;seasonal&quot;] = &quot;primary&quot;  # æ–°å¢
    is_target: bool = False              
    enable_lag: bool = True
    enable_rolling: bool = True
    agg_method: Literal[&quot;mean&quot;, &quot;sum&quot;, &quot;last&quot;, &quot;first&quot;] = &quot;mean&quot;
    ignore_warnings: List[str] = Field(default_factory=list)  # æ–°å¢ï¼š[&quot;W401&quot;, &quot;W403&quot;]

    @validator('enable_lag')
    def validate_target_no_lag(cls, v, values):
        &quot;&quot;&quot;E405: Target è®Šæ•¸ä¸å¯å•Ÿç”¨ Lag&quot;&quot;&quot;
        if values.get('is_target') and v:
            raise ValueError(&quot;E405: is_target=True æ™‚ enable_lag å¿…é ˆç‚º False&quot;)
        return v

# Parser é…ç½®
class ParserConfig(BaseModel):
    encoding: str = &quot;auto&quot;               
    header_scan_rows: int = 500
    assumed_timezone: str = &quot;Asia/Taipei&quot;  
    null_values: List[str] = Field(default_factory=lambda: [
        &quot;&quot;, &quot;NA&quot;, &quot;null&quot;, &quot;---&quot;, &quot;Error&quot;, &quot;N/A&quot;, &quot;OFF&quot;, &quot;OFFLINE&quot;, &quot;#VALUE!&quot;
    ])

# Cleaner é…ç½®ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šç§»é™¤ default_device_roleï¼Œé¿å…éš±æ€§é è¨­å€¼ï¼‰
class CleanerConfig(BaseModel):
    unit_system: Literal[&quot;METRIC&quot;, &quot;IMPERIAL&quot;] = &quot;METRIC&quot;
    resample_interval: str = &quot;15m&quot;       
    heat_balance_threshold: float = 0.05  
    frozen_data_intervals: int = 3
    enforce_output_contract: bool = True
    # å¯©æŸ¥ä¿®æ­£ï¼šç§»é™¤ default_device_roleï¼Œæ‰€æœ‰ device_role å¿…é ˆä¾†è‡ª Annotation
    use_device_role_from_annotation: bool = True
    # å¯©æŸ¥ä¿®æ­£ï¼šæ–°å¢æœªå®šç¾©æ¬„ä½è™•ç†ç­–ç•¥ï¼ˆstrict_mode ä¸‹æ‡‰ç‚º errorï¼‰
    unannotated_column_policy: Literal[&quot;error&quot;, &quot;skip&quot;, &quot;warn&quot;] = &quot;error&quot;

# BatchProcessor é…ç½®ï¼ˆæ›´æ–°ï¼šAnnotation ç‰ˆæœ¬å¯«å…¥ Manifestï¼‰
class BatchConfig(BaseModel):
    output_base_dir: str = &quot;data/processed&quot;
    staging_dir: str = &quot;data/.staging&quot;
    max_rows_per_file: int = 100_000
    compression: Literal[&quot;snappy&quot;, &quot;zstd&quot;] = &quot;snappy&quot;
    use_pyarrow: bool = False            
    future_data_tolerance_minutes: int = 5
    # æ–°å¢ï¼šå¼·åˆ¶æª¢æŸ¥ Annotation åŒæ­¥
    enforce_annotation_sync: bool = True

# Feature Engineer é…ç½®ï¼ˆæ›´æ–°ï¼šä½¿ç”¨ Group Policyï¼‰
class FeatureEngineeringConfig(BaseModel):
    execution_mode: Literal[&quot;in_memory&quot;] = &quot;in_memory&quot;
    cutoff_timestamp: Optional[str] = None  
    group_policies: List[Dict] = Field(default_factory=list)
    physics_features: bool = True
    time_features: bool = True
    # æ–°å¢ï¼šæ¶ˆè²» device_role èˆ‡ ignore_warnings
    respect_device_role: bool = True       # æŠ‘åˆ¶å‚™ç”¨è¨­å‚™çµ±è¨ˆèª¤å ±
    respect_ignore_warnings: bool = True   # æŠ‘åˆ¶ç‰¹å®šè­¦å‘Š

# Feature Annotation é…ç½®ï¼ˆæ–°å¢ï¼‰
class FeatureAnnotationConfig(BaseModel):
    &quot;&quot;&quot;Feature Annotation v1.2 è¨­å®š&quot;&quot;&quot;
    enabled: bool = True
    excel_base_dir: str = &quot;data/features&quot;           # ä½¿ç”¨è€…ç·¨è¼¯å€
    yaml_base_dir: str = &quot;config/features/sites&quot;    # SSOT è¼¸å‡º
    template_dir: str = &quot;tools/features/templates&quot;
    current_template_version: str = &quot;1.2&quot;
    # è‡ªå‹•åŒæ­¥æª¢æŸ¥
    auto_sync_check: bool = True
    # åš´æ ¼æ¨¡å¼ï¼šExcel/YAML ä¸åŒæ­¥æ™‚é˜»æ“‹ Pipeline
    strict_sync_check: bool = True
    # v1.2 æ–°å¢ï¼šæª”æ¡ˆé–é€¾æ™‚æ™‚é–“ï¼ˆç§’ï¼‰
    file_lock_timeout: int = 30
    # v1.2 æ–°å¢ï¼šYAML æª”æ¡ˆé–è·¯å¾‘
    lock_file_dir: str = &quot;data/.locks&quot;

# v1.2 æ–°å¢ï¼šä½µç™¼æ§åˆ¶é…ç½®
class ConcurrencyConfig(BaseModel):
    &quot;&quot;&quot;ä½µç™¼æ§åˆ¶èˆ‡è³‡æºé–å®šè¨­å®š&quot;&quot;&quot;
    enable_file_locking: bool = True
    lock_timeout_seconds: int = 30
    lock_retry_interval: float = 0.5
    max_concurrent_pipelines: int = 1  # å–®ä¸€æ¡ˆå ´åŒæ™‚é–“åªèƒ½åŸ·è¡Œä¸€å€‹ Pipeline

# çµ±ä¸€é…ç½®æ ¹ï¼ˆæ›´æ–°ï¼‰
class ETLConfig(BaseModel):
    &quot;&quot;&quot;ETL Pipeline çµ±ä¸€é…ç½® (SSOT ä¸­å¿ƒ)&quot;&quot;&quot;
    version: str = &quot;1.0&quot;
    site_id: str = &quot;default&quot;

    parser: ParserConfig = ParserConfig()
    cleaner: CleanerConfig = CleanerConfig()
    batch: BatchConfig = BatchConfig()
    feature: FeatureEngineeringConfig = FeatureEngineeringConfig()
    feature_annotation: FeatureAnnotationConfig = FeatureAnnotationConfig()  # æ–°å¢
    concurrency: ConcurrencyConfig = ConcurrencyConfig()  # v1.2 æ–°å¢

    # å…¨åŸŸè¨­å®š
    log_level: str = &quot;INFO&quot;
    strict_mode: bool = True             

    @validator('version')
    def validate_version(cls, v):
        if v != &quot;1.0&quot;:
            raise ValueError(&quot;Config version must be 1.0&quot;)
        return v

    @validator('feature_annotation')
    def validate_annotation_paths(cls, v):
        &quot;&quot;&quot;ç¢ºä¿ Annotation ç›®éŒ„å­˜åœ¨&quot;&quot;&quot;
        from pathlib import Path
        for path_attr in ['excel_base_dir', 'yaml_base_dir', 'lock_file_dir']:
            path = Path(getattr(v, path_attr))
            path.mkdir(parents=True, exist_ok=True)
        return v
</code></pre>
<h3 id="22-configloader-">2.2 é…ç½®è¼‰å…¥å™¨ (ConfigLoader) - æ•´åˆæ™‚é–“åŸºæº–èˆ‡ä½µç™¼æ§åˆ¶</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/utils/config_loader.py</code></p>
<p><strong>é—œéµæ›´æ–° (v1.2)</strong>:<br />
- æ–°å¢ <code>load_feature_annotation()</code> æ–¹æ³•è¼‰å…¥ YAML SSOTï¼ˆæ³¨æ„ï¼šåƒ…è¼‰å…¥ï¼Œä¸è™•ç†ç¹¼æ‰¿ï¼Œç¹¼æ‰¿é‚è¼¯åœ¨ Manager è™•ç†ï¼‰<br />
- æ–°å¢ <code>validate_annotation_sync()</code> æª¢æŸ¥ Excel/YAML åŒæ­¥ç‹€æ…‹<br />
- <strong>æ–°å¢ <code>acquire_yaml_lock()</code> / <code>release_yaml_lock()</code>ï¼šæª”æ¡ˆé–æ©Ÿåˆ¶é˜²æ­¢ä½µç™¼å¯«å…¥ï¼ˆv1.2ï¼‰</strong><br />
- <strong>æ–°å¢ <code>PipelineContext</code> æ”¯æ´ï¼šçµ±ä¸€æ™‚é–“åŸºæº–å‚³éï¼ˆv1.2ï¼‰</strong></p>
<pre><code class="language-python">import yaml
import hashlib
import fcntl
import os
from pathlib import Path
from typing import Union, Dict, Optional
from datetime import datetime, timezone
from contextlib import contextmanager
from src.etl.config_models import ETLConfig, VALID_QUALITY_FLAGS, FEATURE_ANNOTATION_CONSTANTS

class ConfigurationError(Exception):
    &quot;&quot;&quot;é…ç½®éŒ¯èª¤&quot;&quot;&quot;
    pass

class AnnotationSyncError(ConfigurationError):
    &quot;&quot;&quot;E406: Excel èˆ‡ YAML ä¸åŒæ­¥&quot;&quot;&quot;
    pass

class FileLockError(ConfigurationError):
    &quot;&quot;&quot;E003/E408: æª”æ¡ˆé–å®šå¤±æ•—&quot;&quot;&quot;
    pass

class ConfigLoader:
    &quot;&quot;&quot;çµ±ä¸€é…ç½®è¼‰å…¥ï¼Œç¢ºä¿æ‰€æœ‰æ¨¡çµ„å¼•ç”¨ç›¸åŒ SSOT&quot;&quot;&quot;

    @staticmethod
    def load(config_path: Union[str, Path] = &quot;config/settings.yaml&quot;) -&gt; ETLConfig:
        &quot;&quot;&quot;è¼‰å…¥ä¸¦é©—è­‰ ETL ä¸»é…ç½®&quot;&quot;&quot;
        config_path = Path(config_path)

        if not config_path.exists():
            raise ConfigurationError(f&quot;é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_path}&quot;)

        with open(config_path, 'r', encoding='utf-8') as f:
            try:
                data = yaml.safe_load(f)
            except yaml.YAMLError as e:
                raise ConfigurationError(f&quot;YAML è§£æéŒ¯èª¤: {e}&quot;)

        # é©—è­‰ SSOT ä¸€è‡´æ€§
        code_flags = set(VALID_QUALITY_FLAGS)
        config_flags = set(data.get(&quot;custom_quality_flags&quot;, []))

        if config_flags and config_flags != code_flags:
            missing_base = code_flags - config_flags
            if missing_base:
                raise ConfigurationError(
                    f&quot;settings.yaml ä¸­çš„ flags ç¼ºå°‘ SSOT åŸºç¤æ¨™è¨˜: {missing_base}. &quot;
                    f&quot;ç¨‹å¼ç¢¼å®šç¾©: {code_flags}&quot;
                )

        # é©—è­‰ç›®éŒ„å­˜åœ¨æ€§æˆ–è‡ªå‹•å»ºç«‹
        for dir_key in [&quot;output_base_dir&quot;, &quot;staging_dir&quot;]:
            if dir_key in data.get(&quot;batch&quot;, {}):
                Path(data[&quot;batch&quot;][dir_key]).mkdir(parents=True, exist_ok=True)

        try:
            return ETLConfig(**data)
        except Exception as e:
            raise ConfigurationError(f&quot;é…ç½®é©—è­‰å¤±æ•—: {e}&quot;)

    @staticmethod
    def load_feature_annotation(site_id: str, yaml_base_dir: str = &quot;config/features/sites&quot;) -&gt; Dict:
        &quot;&quot;&quot;
        è¼‰å…¥ç‰¹å®šæ¡ˆå ´çš„ Feature Annotation YAML (åŸå§‹å…§å®¹ï¼Œæœªåˆä½µç¹¼æ‰¿)
        æ³¨æ„ï¼šç¹¼æ‰¿åˆä½µé‚è¼¯ç”± FeatureAnnotationManager è™•ç†

        æª¢æŸ¥é …ç›®:
        1. æª”æ¡ˆå­˜åœ¨æ€§
        2. schema_version ç›¸å®¹æ€§ï¼ˆåƒ…æª¢æŸ¥ï¼Œä¸åˆä½µï¼‰
        3. æª”æ¡ˆé–ç‹€æ…‹ï¼ˆåƒ…æª¢æŸ¥ï¼Œä¸å–å¾—é–ï¼‰
        &quot;&quot;&quot;
        yaml_path = Path(yaml_base_dir) / f&quot;{site_id}.yaml&quot;

        if not yaml_path.exists():
            raise ConfigurationError(f&quot;E402: Feature Annotation æœªå®šç¾©: {yaml_path}&quot;)

        # v1.2: æª¢æŸ¥æ˜¯å¦æœ‰é€²ç¨‹æ­£åœ¨å¯«å…¥ï¼ˆé–æª”æ¡ˆå­˜åœ¨ï¼‰
        lock_path = Path(f&quot;data/.locks/{site_id}.yaml.lock&quot;)
        if lock_path.exists():
            lock_age = datetime.now().timestamp() - lock_path.stat().st_mtime
            if lock_age &lt; 300:  # 5åˆ†é˜å…§çš„é–è¦–ç‚ºæœ‰æ•ˆ
                raise FileLockError(f&quot;E408: YAML æª”æ¡ˆæ­£åœ¨è¢«å…¶ä»–é€²ç¨‹ä¿®æ”¹ (é–å­˜åœ¨ {lock_age:.0f} ç§’)&quot;)

        with open(yaml_path, 'r', encoding='utf-8') as f:
            annotation = yaml.safe_load(f)

        # æª¢æŸ¥ Schema ç‰ˆæœ¬ï¼ˆæª¢æŸ¥é» #6ï¼‰
        schema_ver = annotation.get('schema_version', 'unknown')
        expected_ver = FEATURE_ANNOTATION_CONSTANTS['expected_schema_version']
        if schema_ver != expected_ver:
            raise ConfigurationError(
                f&quot;E400: Annotation Schema ç‰ˆæœ¬ä¸ç¬¦ã€‚æœŸæœ›: {expected_ver}, å¯¦éš›: {schema_ver}. &quot;
                f&quot;è«‹åŸ·è¡Œ migrate_excel.py å‡ç´š&quot;
            )

        return annotation

    @staticmethod
    @contextmanager
    def acquire_yaml_lock(site_id: str, lock_dir: str = &quot;data/.locks&quot;, timeout: int = 30):
        &quot;&quot;&quot;
        v1.2 æ–°å¢ï¼šä¸Šä¸‹æ–‡ç®¡ç†å™¨å–å¾— YAML æª”æ¡ˆé–

        ä½¿ç”¨ fcntl å¯¦ä½œé€²ç¨‹é–“é–å®šï¼Œé˜²æ­¢ï¼š
        1. excel_to_yaml.py è½‰æ›æ™‚ Pipeline è®€å–ï¼ˆè®€é«’è³‡æ–™ï¼‰
        2. å¤šå€‹ Pipeline å¯¦ä¾‹åŒæ™‚åŸ·è¡Œï¼ˆè³‡æºè¡çªï¼‰

        Args:
            site_id: æ¡ˆå ´ ID
            lock_dir: é–æª”æ¡ˆç›®éŒ„
            timeout: é€¾æ™‚ç§’æ•¸

        Raises:
            FileLockError: E003 ç„¡æ³•å–å¾—é–
        &quot;&quot;&quot;
        lock_path = Path(lock_dir)
        lock_path.mkdir(parents=True, exist_ok=True)
        lock_file = lock_path / f&quot;{site_id}.yaml.lock&quot;

        lock_fd = None
        start_time = datetime.now()

        try:
            # å˜—è©¦å–å¾—é–
            while True:
                try:
                    lock_fd = os.open(str(lock_file), os.O_CREAT | os.O_RDWR)
                    fcntl.flock(lock_fd, fcntl.LOCK_EX | fcntl.LOCK_NB)
                    # å¯«å…¥é–è³‡è¨Š
                    os.write(lock_fd, f&quot;{os.getpid()}|{datetime.now().isoformat()}&quot;.encode())
                    break
                except (IOError, OSError):
                    if lock_fd:
                        os.close(lock_fd)
                        lock_fd = None

                    elapsed = (datetime.now() - start_time).total_seconds()
                    if elapsed &gt; timeout:
                        raise FileLockError(f&quot;E003: ç„¡æ³•å–å¾— YAML æª”æ¡ˆé–ï¼ˆé€¾æ™‚ {timeout} ç§’ï¼‰&quot;)

                    import time
                    time.sleep(0.5)

            yield lock_file

        finally:
            if lock_fd:
                fcntl.flock(lock_fd, fcntl.LOCK_UN)
                os.close(lock_fd)
                try:
                    lock_file.unlink()
                except:
                    pass

    @staticmethod
    def validate_annotation_sync(site_id: str, excel_base_dir: str, yaml_base_dir: str) -&gt; dict:
        &quot;&quot;&quot;
        E406: æª¢æŸ¥ Excel èˆ‡ YAML æ˜¯å¦åŒæ­¥

        Returns:
            {
                'synced': bool,
                'excel_mtime': float,
                'yaml_mtime': float,
                'excel_checksum': str,
                'yaml_checksum': str,
                'reason': str
            }
        &quot;&quot;&quot;
        excel_path = Path(excel_base_dir) / site_id / f&quot;{site_id}.xlsx&quot;
        yaml_path = Path(yaml_base_dir) / f&quot;{site_id}.yaml&quot;

        if not excel_path.exists():
            return {'synced': False, 'reason': f'Excel ä¸å­˜åœ¨: {excel_path}'}
        if not yaml_path.exists():
            return {'synced': False, 'reason': f'YAML ä¸å­˜åœ¨: {yaml_path}'}

        # æ™‚é–“æˆ³æ¯”è¼ƒ
        excel_mtime = excel_path.stat().st_mtime
        yaml_mtime = yaml_path.stat().st_mtime

        if excel_mtime &gt; yaml_mtime:
            return {
                'synced': False,
                'excel_mtime': excel_mtime,
                'yaml_mtime': yaml_mtime,
                'reason': f'E406: Excel ({excel_path.name}) è¼ƒæ–°ï¼Œè«‹é‡æ–°åŸ·è¡Œ excel_to_yaml.py'
            }

        # Checksum æ¯”å°ï¼ˆè‹¥ YAML ä¸­æœ‰è¨˜éŒ„ï¼‰
        with open(yaml_path, 'r', encoding='utf-8') as f:
            yaml_content = yaml.safe_load(f)

        stored_checksum = yaml_content.get('meta', {}).get('excel_checksum', '')
        if stored_checksum:
            actual_checksum = ConfigLoader._compute_file_hash(excel_path)
            if stored_checksum != actual_checksum:
                return {
                    'synced': False,
                    'excel_checksum': actual_checksum,
                    'yaml_checksum': stored_checksum,
                    'reason': 'E406: Checksum ä¸ç¬¦ï¼ŒExcel å¯èƒ½å·²ä¿®æ”¹ä½†æœªé‡æ–°ç”Ÿæˆ YAML'
                }

        return {'synced': True, 'reason': 'åŒæ­¥'}

    @staticmethod
    def _compute_file_hash(file_path: Path) -&gt; str:
        &quot;&quot;&quot;è¨ˆç®—æª”æ¡ˆ SHA256&quot;&quot;&quot;
        sha256_hash = hashlib.sha256()
        with open(file_path, &quot;rb&quot;) as f:
            for byte_block in iter(lambda: f.read(4096), b&quot;&quot;):
                sha256_hash.update(byte_block)
        return f&quot;sha256:{sha256_hash.hexdigest()}&quot;

    @staticmethod
    def get_annotation_metadata(site_id: str, yaml_base_dir: str) -&gt; Dict:
        &quot;&quot;&quot;å–å¾— Annotation å…ƒè³‡æ–™ï¼ˆä¾› Manifest å¯«å…¥ï¼‰&quot;&quot;&quot;
        # æ³¨æ„ï¼šæ­¤è™•åƒ…è®€å–åŸå§‹æª”æ¡ˆçš„ metaï¼Œä¸è§¸ç™¼ç¹¼æ‰¿åˆä½µ
        annotation = ConfigLoader.load_feature_annotation(site_id, yaml_base_dir)
        return {
            'schema_version': annotation.get('schema_version'),
            'template_version': annotation.get('meta', {}).get('template_version'),
            'last_updated': annotation.get('meta', {}).get('last_updated'),
            'editor': annotation.get('meta', {}).get('editor'),
            'yaml_checksum': annotation.get('meta', {}).get('excel_checksum', '')
        }
</code></pre>
<h3 id="23-pipelinecontext-v12">2.3 PipelineContext - å…¨åŸŸæ™‚é–“åŸºæº–èˆ‡ç‹€æ…‹è¼‰é«”ï¼ˆv1.2 æ–°å¢ï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/context.py</code></p>
<p><strong>è¨­è¨ˆç›®çš„</strong>:<br />
- è§£æ±ºã€Œæœªä¾†è³‡æ–™æª¢æŸ¥çš„æ™‚é–“åŸºæº–ä¸ä¸€è‡´ã€å•é¡Œï¼ˆParser/Cleaner/BatchProcessor å„è‡ªå‘¼å« <code>datetime.now()</code> å°è‡´æ¼‚ç§»ï¼‰<br />
- æ”œå¸¶ Pipeline åŸ·è¡ŒæœŸé–“çš„å…¨åŸŸç‹€æ…‹ï¼ˆæ™‚é–“æˆ³ã€æ¡ˆå ´IDã€åš´æ ¼æ¨¡å¼ç­‰ï¼‰<br />
- ç¢ºä¿æ‰€æœ‰æ¨¡çµ„ä½¿ç”¨ç›¸åŒçš„ã€Œç¾åœ¨ã€æ™‚é–“é»</p>
<pre><code class="language-python">from datetime import datetime, timezone
from typing import Optional, Dict, Any
from dataclasses import dataclass, field

@dataclass
class PipelineContext:
    &quot;&quot;&quot;
    Pipeline åŸ·è¡Œä¸Šä¸‹æ–‡ï¼ˆv1.2 æ–°å¢ï¼‰

    ä½œç‚º DI Container åˆå§‹åŒ–æ™‚ç”¢ç”Ÿçš„ã€Œæ™‚é–“è† å›Šã€ï¼Œç¢ºä¿ï¼š
    1. æ‰€æœ‰æœªä¾†è³‡æ–™æª¢æŸ¥ä½¿ç”¨ç›¸åŒçš„ pipeline_timestamp
    2. è·¨æ¨¡çµ„çš„æ™‚é–“é‚è¼¯ä¸€è‡´æ€§ï¼ˆé¿å… Pipeline åŸ·è¡ŒæœŸé–“æ™‚é–“æµé€å°è‡´èª¤åˆ¤ï¼‰
    3. å¯è¿½æº¯æ€§ï¼ˆè¨˜éŒ„ Pipeline å•Ÿå‹•æ™‚é–“ï¼‰

    Attributes:
        pipeline_timestamp: Pipeline å•Ÿå‹•æ™‚çš„ UTC æ™‚é–“ï¼ˆæ‰€æœ‰ã€Œæœªä¾†è³‡æ–™ã€æª¢æŸ¥çš„åŸºæº–ï¼‰
        site_id: æ¡ˆå ´è­˜åˆ¥ç¢¼
        strict_mode: æ˜¯å¦åš´æ ¼æ¨¡å¼ï¼ˆå½±éŸ¿éŒ¯èª¤è™•ç†ç­–ç•¥ï¼‰
        config_hash: è¨­å®šæª”é›œæ¹Šï¼ˆç¢ºä¿åŸ·è¡ŒæœŸé–“è¨­å®šæœªè¢«ä¿®æ”¹ï¼‰
        metadata: æ“´å……å…ƒè³‡æ–™å­—å…¸
    &quot;&quot;&quot;
    pipeline_timestamp: datetime = field(default_factory=lambda: datetime.now(timezone.utc))
    site_id: str = &quot;default&quot;
    strict_mode: bool = True
    config_hash: Optional[str] = None
    metadata: Dict[str, Any] = field(default_factory=dict)

    def is_future_timestamp(self, timestamp: datetime, tolerance_minutes: int = 5) -&gt; bool:
        &quot;&quot;&quot;
        æª¢æŸ¥çµ¦å®šæ™‚é–“æˆ³æ˜¯å¦ç‚ºã€Œæœªä¾†è³‡æ–™ã€ï¼ˆç›¸å°æ–¼ pipeline_timestampï¼‰

        Args:
            timestamp: å¾…æª¢æŸ¥çš„æ™‚é–“æˆ³
            tolerance_minutes: å®¹å¿åˆ†é˜æ•¸ï¼ˆè€ƒæ…®æ™‚é˜èª¤å·®èˆ‡è™•ç†å»¶é²ï¼‰

        Returns:
            bool: True å¦‚æœ timestamp è¶…é pipeline_timestamp + tolerance
        &quot;&quot;&quot;
        if timestamp.tzinfo is None:
            # å‡è¨­ç„¡æ™‚å€ç‚º UTCï¼ˆæˆ–æ ¹æ“šè¨­å®šè™•ç†ï¼‰
            from datetime import timezone
            timestamp = timestamp.replace(tzinfo=timezone.utc)

        tolerance = __import__('datetime').timedelta(minutes=tolerance_minutes)
        return timestamp &gt; (self.pipeline_timestamp + tolerance)

    def get_elapsed_seconds(self) -&gt; float:
        &quot;&quot;&quot;å–å¾— Pipeline å·²åŸ·è¡Œç§’æ•¸&quot;&quot;&quot;
        return (datetime.now(timezone.utc) - self.pipeline_timestamp).total_seconds()

    def to_dict(self) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;åºåˆ—åŒ–ç‚ºå­—å…¸ï¼ˆä¾› Manifest è¨˜éŒ„ï¼‰&quot;&quot;&quot;
        return {
            'pipeline_timestamp': self.pipeline_timestamp.isoformat(),
            'site_id': self.site_id,
            'strict_mode': self.strict_mode,
            'config_hash': self.config_hash,
            'elapsed_seconds_at_save': self.get_elapsed_seconds()
        }

    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -&gt; 'PipelineContext':
        &quot;&quot;&quot;å¾å­—å…¸é‚„åŸ&quot;&quot;&quot;
        timestamp = datetime.fromisoformat(data['pipeline_timestamp'])
        return cls(
            pipeline_timestamp=timestamp,
            site_id=data['site_id'],
            strict_mode=data['strict_mode'],
            config_hash=data.get('config_hash')
        )
</code></pre>
<hr />
<h2 id="3-di-container-">3. ä¾è³´æ³¨å…¥å®¹å™¨ (DI Container) - åš´æ ¼åˆå§‹åŒ–é †åºæ§åˆ¶</h2>
<h3 id="31-etlcontainer-v12">3.1 ETLContainer å¯¦ä½œï¼ˆv1.2ï¼šé †åºæ§åˆ¶èˆ‡ä½µç™¼é˜²è­·ï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/container.py</code></p>
<p><strong>é—œéµä¿®æ­£ (v1.2)</strong>:<br />
- <strong>åš´æ ¼åˆå§‹åŒ–é †åº</strong>ï¼š<code>__init__</code> æ–¹æ³•å…§éƒ¨åˆ†ç‚º 4 å€‹æ˜ç¢ºéšæ®µï¼Œé˜²æ­¢ Race Condition<br />
- <strong>æª”æ¡ˆé–æ•´åˆ</strong>ï¼šåˆå§‹åŒ–æ™‚è‡ªå‹•å–å¾— YAML é–ï¼Œé˜²æ­¢ Wizard èˆ‡ Pipeline è¡çª<br />
- <strong>PipelineContext æ³¨å…¥</strong>ï¼šæ‰€æœ‰æ¨¡çµ„çµ±ä¸€é€é Context å–å¾—æ™‚é–“åŸºæº–<br />
- <strong>Cleaner è·è²¬é‡æ¸…</strong>ï¼šåƒ…è®€å– device_role ç”¨æ–¼ç­–ç•¥èª¿æ•´ï¼Œä¸å¯«å…¥ metadata</p>
<pre><code class="language-python">from typing import Optional, List, Dict
from pathlib import Path
import polars as pl

from src.etl.config_models import ETLConfig
from src.etl.parser import ReportParser
from src.etl.cleaner import DataCleaner
from src.etl.batch_processor import BatchOrchestrator, BatchResult
from src.etl.feature_engineer import FeatureEngineer
from src.features.annotation_manager import FeatureAnnotationManager
from src.utils.config_loader import ConfigLoader, AnnotationSyncError, FileLockError
from src.utils.logger import get_logger
from src.context import PipelineContext  # v1.2 æ–°å¢

class ETLContainer:
    &quot;&quot;&quot;
    ä¾è³´æ³¨å…¥å®¹å™¨ (Dependency Injection Container) - v1.2

    ç®¡ç†æ‰€æœ‰ ETL æ¨¡çµ„çš„ç”Ÿå‘½å‘¨æœŸèˆ‡é…ç½®å‚³éï¼Œç¢ºä¿:
    1. å–®ä¾‹æ¨¡å¼ (Singleton) 
    2. é…ç½®ä¸€è‡´æ€§ 
    3. åš´æ ¼åˆå§‹åŒ–é †åºï¼ˆé˜²æ­¢ Race Conditionï¼‰
    4. Feature Annotation æ­£ç¢ºæµå‘å„æ¨¡çµ„ï¼ˆExcel â†’ YAML â†’ Manager â†’ Modulesï¼‰
    5. é›¶é–“éš™éŠœæ¥ 
    6. ä½µç™¼æ§åˆ¶ï¼ˆæª”æ¡ˆé–ï¼‰

    **åˆå§‹åŒ–é †åºï¼ˆåš´æ ¼åŸ·è¡Œï¼‰**:
    Step 1: ç”¢ç”Ÿ PipelineContextï¼ˆé–å®šæ™‚é–“åŸºæº–ï¼‰
    Step 2: é©—è­‰ E406 åŒæ­¥ä¸¦å–å¾—æª”æ¡ˆé–
    Step 3: åˆå§‹åŒ– FeatureAnnotationManagerï¼ˆè¼‰å…¥ä¸¦åˆä½µç¹¼æ‰¿ï¼‰
    Step 4: åˆå§‹åŒ–å…¶ä»–æ¨¡çµ„ï¼ˆParser/Cleaner/BatchProcessor/FEï¼‰
    &quot;&quot;&quot;

    def __init__(self, config: ETLConfig):
        self.config = config
        self.logger = get_logger(&quot;ETLContainer&quot;)

        # v1.2: Step 1 - åˆå§‹åŒ– PipelineContextï¼ˆæ™‚é–“åŸºæº–ï¼‰
        self.context = PipelineContext(
            site_id=config.site_id,
            strict_mode=config.strict_mode,
            config_hash=self._compute_config_hash(config)
        )
        self.logger.info(f&quot;ğŸ• PipelineContext åˆå§‹åŒ–å®Œæˆï¼Œæ™‚é–“åŸºæº–: {self.context.pipeline_timestamp.isoformat()}&quot;)

        # å¿«å–å¯¦ä¾‹ (Singleton)
        self._parser: Optional[ReportParser] = None
        self._cleaner: Optional[DataCleaner] = None
        self._batch_processor: Optional[BatchOrchestrator] = None
        self._feature_engineer: Optional[FeatureEngineer] = None
        self._annotation_manager: Optional[FeatureAnnotationManager] = None

        # v1.2: æª”æ¡ˆé–æ§åˆ¶
        self._lock_acquired = False
        self._lock_file: Optional[Path] = None

        # v1.2: åŸ·è¡Œåš´æ ¼åˆå§‹åŒ–é †åº
        self._initialize_in_order()

    def _compute_config_hash(self, config: ETLConfig) -&gt; str:
        &quot;&quot;&quot;è¨ˆç®—é…ç½®é›œæ¹Šï¼ˆé˜²æ­¢åŸ·è¡ŒæœŸé–“è¨­å®šè¢«ä¿®æ”¹ï¼‰&quot;&quot;&quot;
        import hashlib
        import json
        config_str = json.dumps(config.dict(), sort_keys=True, default=str)
        return hashlib.sha256(config_str.encode()).hexdigest()[:16]

    def _initialize_in_order(self):
        &quot;&quot;&quot;
        åš´æ ¼åˆå§‹åŒ–é †åºï¼ˆv1.2 æ ¸å¿ƒä¿®æ­£ï¼‰

        æ­¤é †åºç¢ºä¿ï¼š
        - Annotation å·²é©—è­‰ä¸”é–å®šå¾Œï¼Œå…¶ä»–æ¨¡çµ„æ‰èƒ½è®€å–
        - Manager å…ˆæ–¼ Cleaner åˆå§‹åŒ–ï¼Œç¢ºä¿ unannotated_column_policy æ­£ç¢ºå‚³é
        - æ™‚é–“åŸºæº–å…ˆç¢ºç«‹ï¼Œå¾ŒçºŒæ¨¡çµ„çš„ã€Œæœªä¾†è³‡æ–™ã€æª¢æŸ¥æœ‰ä¸€è‡´æ¨™æº–
        &quot;&quot;&quot;
        try:
            # Step 2: E406 é©—è­‰èˆ‡æª”æ¡ˆé–å–å¾—ï¼ˆCriticalï¼‰
            if self.config.feature_annotation.enabled:
                self._acquire_annotation_lock()
                self._validate_annotation_sync()

            # Step 3: åˆå§‹åŒ– FeatureAnnotationManagerï¼ˆå¿…é ˆåœ¨ Cleaner ä¹‹å‰ï¼‰
            if self.config.feature_annotation.enabled:
                self._load_annotation_manager()

            # Step 4: åˆå§‹åŒ–å…¶ä»–æ¨¡çµ„ï¼ˆæ­¤æ™‚ Context èˆ‡ Manager å·²å°±ç·’ï¼‰
            # æ³¨æ„ï¼šå¯¦éš›å¯¦ä¾‹åŒ–æ¡ç”¨æƒ°æ€§è¼‰å…¥ï¼ˆlazy loadingï¼‰ï¼Œä½†é †åºåœ¨æ­¤ç¢ºä¿
            self.logger.info(&quot;âœ… ä¾è³´æ³¨å…¥å®¹å™¨åˆå§‹åŒ–å®Œæˆï¼ˆé †åºé©—è­‰é€šéï¼‰&quot;)

        except Exception as e:
            self._cleanup_lock()
            raise

    def _acquire_annotation_lock(self):
        &quot;&quot;&quot;v1.2: å–å¾— Annotation YAML æª”æ¡ˆé–&quot;&quot;&quot;
        if not self.config.concurrency.enable_file_locking:
            return

        try:
            self.logger.debug(&quot;ğŸ”’ å˜—è©¦å–å¾— Annotation æª”æ¡ˆé–...&quot;)
            # ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œä½†æ‰‹å‹•æ§åˆ¶è§£é–æ™‚æ©Ÿï¼ˆPipeline çµæŸæ™‚ï¼‰
            self._lock_cm = ConfigLoader.acquire_yaml_lock(
                self.config.site_id,
                self.config.feature_annotation.lock_file_dir,
                self.config.feature_annotation.file_lock_timeout
            )
            self._lock_file = self._lock_cm.__enter__()
            self._lock_acquired = True
            self.logger.debug(f&quot;ğŸ”’ æª”æ¡ˆé–å·²å–å¾—: {self._lock_file}&quot;)
        except FileLockError as e:
            self.logger.error(f&quot;âŒ ç„¡æ³•å–å¾—æª”æ¡ˆé–: {e}&quot;)
            raise RuntimeError(f&quot;E003: {e}&quot;) from e

    def _validate_annotation_sync(self):
        &quot;&quot;&quot;v1.2: æª¢æŸ¥é» #5 - Annotation åŒæ­¥é©—è­‰&quot;&quot;&quot;
        fa_config = self.config.feature_annotation

        if not fa_config.auto_sync_check:
            return

        self.logger.info(&quot;ğŸ” æª¢æŸ¥é» #5: é©—è­‰ Excel/YAML åŒæ­¥ç‹€æ…‹...&quot;)
        sync_status = ConfigLoader.validate_annotation_sync(
            self.config.site_id,
            fa_config.excel_base_dir,
            fa_config.yaml_base_dir
        )

        if not sync_status['synced']:
            if fa_config.strict_sync_check:
                raise AnnotationSyncError(sync_status['reason'])
            else:
                self.logger.warning(f&quot;âš ï¸ Annotation åŒæ­¥è­¦å‘Š: {sync_status['reason']}&quot;)
        else:
            self.logger.info(&quot;âœ… æª¢æŸ¥é» #5: Excel/YAML åŒæ­¥ - é€šé&quot;)

    def _load_annotation_manager(self):
        &quot;&quot;&quot;v1.2: Step 3 - è¼‰å…¥ FeatureAnnotationManagerï¼ˆå«ç¹¼æ‰¿åˆä½µï¼‰&quot;&quot;&quot;
        fa_config = self.config.feature_annotation

        try:
            self._annotation_manager = FeatureAnnotationManager(
                site_id=self.config.site_id,
                yaml_base_dir=fa_config.yaml_base_dir
            )

            self.logger.info(
                f&quot;ğŸ“‹ FeatureAnnotationManager åˆå§‹åŒ–å®Œæˆ &quot;
                f&quot;(Schema: {self._annotation_manager.schema_version}, &quot;
                f&quot;Columns: {len(self._annotation_manager.columns)}, &quot;
                f&quot;Inheritance: {self._annotation_manager.inheritance_chain})&quot;
            )

            # æª¢æŸ¥é» #6: Schema ç‰ˆæœ¬ç›¸å®¹
            if self._annotation_manager.schema_version != fa_config.current_template_version:
                raise ConfigurationError(
                    f&quot;E400: Schema ç‰ˆæœ¬ä¸ç¬¦ã€‚Manager: {self._annotation_manager.schema_version}, &quot;
                    f&quot;æœŸæœ›: {fa_config.current_template_version}&quot;
                )

        except Exception as e:
            self.logger.error(f&quot;âŒ FeatureAnnotationManager åˆå§‹åŒ–å¤±æ•—: {e}&quot;)
            raise

    def _cleanup_lock(self):
        &quot;&quot;&quot;v1.2: æ¸…ç†æª”æ¡ˆé–&quot;&quot;&quot;
        if self._lock_acquired and hasattr(self, '_lock_cm'):
            try:
                self._lock_cm.__exit__(None, None, None)
                self.logger.debug(&quot;ğŸ”“ æª”æ¡ˆé–å·²é‡‹æ”¾&quot;)
            except:
                pass
            self._lock_acquired = False

    def __del__(self):
        &quot;&quot;&quot;è§£æ§‹æ™‚ç¢ºä¿é‡‹æ”¾é–&quot;&quot;&quot;
        self._cleanup_lock()

    def get_annotation_manager(self) -&gt; FeatureAnnotationManager:
        &quot;&quot;&quot;å–å¾— FeatureAnnotationManagerï¼ˆæª¢æŸ¥é» #6ï¼‰&quot;&quot;&quot;
        if self._annotation_manager is None:
            raise RuntimeError(&quot;E901: FeatureAnnotationManager æœªåˆå§‹åŒ–ï¼Œé•ååˆå§‹åŒ–é †åº&quot;)
        return self._annotation_manager

    def get_context(self) -&gt; PipelineContext:
        &quot;&quot;&quot;v1.2: å–å¾— PipelineContextï¼ˆæ™‚é–“åŸºæº–èˆ‡å…¨åŸŸç‹€æ…‹ï¼‰&quot;&quot;&quot;
        if not hasattr(self, 'context'):
            raise RuntimeError(&quot;E902: PipelineContext æœªåˆå§‹åŒ–&quot;)
        return self.context

    def get_parser(self) -&gt; ReportParser:
        &quot;&quot;&quot;
        å–å¾— Parser å¯¦ä¾‹ï¼ˆv1.2: æ³¨å…¥ Context æ™‚é–“åŸºæº–ï¼‰

        Parser v2.1+ æœƒ:
        1. ä½¿ç”¨ Context.pipeline_timestamp ä½œç‚ºã€Œæœªä¾†è³‡æ–™ã€æª¢æŸ¥åŸºæº–ï¼ˆE102ï¼‰
        2. ç¢ºä¿æ‰€æœ‰æ™‚é–“æˆ³è½‰æ›ç‚º UTC
        &quot;&quot;&quot;
        if self._parser is None:
            self._parser = ReportParser(
                site_id=self.config.site_id,
                config=self.config.parser,
                context=self.get_context()  # v1.2: æ³¨å…¥æ™‚é–“åŸºæº–
            )
            self.logger.debug(&quot;åˆå§‹åŒ– ReportParser (å« PipelineContext)&quot;)
        return self._parser

    def get_cleaner(self) -&gt; DataCleaner:
        &quot;&quot;&quot;
        å–å¾— Cleaner å¯¦ä¾‹ï¼ˆv1.2: åš´æ ¼é †åºæ§åˆ¶ï¼‰

        **åˆå§‹åŒ–é †åºè¦æ±‚**: å¿…é ˆåœ¨ FeatureAnnotationManager ä¹‹å¾Œåˆå§‹åŒ–

        Cleaner v2.2+ æœƒ:
        1. æŒæœ‰ AnnotationManager å¼•ç”¨ï¼Œç”¨æ–¼æŸ¥è©¢ device_roleï¼ˆä¸å¯«å…¥ DataFrameï¼‰
        2. ä½¿ç”¨ Context.pipeline_timestamp ä½œç‚ºã€Œæœªä¾†è³‡æ–™ã€æª¢æŸ¥åŸºæº–ï¼ˆE205ï¼‰
        3. æ ¹æ“š device_role èª¿æ•´æ¸…æ´—ç­–ç•¥ï¼ˆå¦‚ backup è¨­å‚™æ”¾å¯¬å‡çµæª¢æ¸¬ï¼‰
        4. å°æ–¼ unannotated æ¬„ä½ï¼Œä¾æ“š unannotated_column_policy è™•ç†ï¼ˆE402ï¼‰

        æ³¨æ„ï¼šdevice_role ä¸æœƒè¢«å¯«å…¥ Parquet metadataï¼Œåƒ…ç”¨æ–¼ runtime é‚è¼¯åˆ¤æ–·
        &quot;&quot;&quot;
        if self._annotation_manager is None:
            raise RuntimeError(&quot;E901: é•ååˆå§‹åŒ–é †åº - Cleaner è¦æ±‚ AnnotationManager å…ˆåˆå§‹åŒ–&quot;)

        if self._cleaner is None:
            self._cleaner = DataCleaner(
                config=self.config.cleaner,
                annotation_manager=self._annotation_manager,
                context=self.get_context()  # v1.2: æ³¨å…¥æ™‚é–“åŸºæº–
            )
            self.logger.debug(&quot;åˆå§‹åŒ– DataCleaner (å« AnnotationManager å¼•ç”¨èˆ‡ Contextï¼Œä¸å¯«å…¥ metadata)&quot;)
        return self._cleaner

    def get_batch_processor(self) -&gt; BatchOrchestrator:
        &quot;&quot;&quot;
        å–å¾— BatchProcessor å¯¦ä¾‹ï¼ˆv1.2: æ³¨å…¥æ™‚é–“åŸºæº–ï¼‰

        BatchProcessor v1.3+ æœƒ:
        1. æ¥æ”¶ä¾†è‡ª Cleaner çš„è³‡æ–™ï¼ˆä¸å« device_role metadataï¼‰
        2. ä½¿ç”¨ Context.pipeline_timestamp ä½œç‚ºã€Œæœªä¾†è³‡æ–™ã€æª¢æŸ¥åŸºæº–ï¼ˆE303ï¼‰
        3. å°‡ Annotation Metadataï¼ˆversion, checksumï¼‰å¯«å…¥ Manifestï¼ˆä¾›ç¨½æ ¸ï¼‰
        4. åŸ·è¡Œ E406 æª¢æŸ¥ï¼ˆè‹¥ enforce_annotation_sync=Trueï¼‰
        &quot;&quot;&quot;
        if self._batch_processor is None:
            annotation_meta = {}
            if self._annotation_manager:
                annotation_meta = self._annotation_manager.get_metadata()

            self._batch_processor = BatchOrchestrator(
                config=self.config,
                parser=self.get_parser(),
                cleaner=self.get_cleaner(),
                annotation_metadata=annotation_meta,
                context=self.get_context()  # v1.2: æ³¨å…¥æ™‚é–“åŸºæº–
            )
            self.logger.debug(&quot;åˆå§‹åŒ– BatchOrchestrator (å« Annotation Metadata èˆ‡ Context)&quot;)
        return self._batch_processor

    def get_feature_engineer(self) -&gt; FeatureEngineer:
        &quot;&quot;&quot;
        å–å¾— FeatureEngineer å¯¦ä¾‹ï¼ˆv1.2: æ³¨å…¥æ™‚é–“åŸºæº–ï¼‰

        Feature Engineer v1.3+ æœƒ:
        1. è®€å– Annotation ä¸­çš„ group_policiesï¼ˆå¾ Managerï¼Œé DataFrame metadataï¼‰
        2. æ ¹æ“š device_role æ±ºå®šæ˜¯å¦æŠ‘åˆ¶ W403ï¼ˆå‚™ç”¨è¨­å‚™é«˜é›¶å€¼æ­£å¸¸ï¼‰
        3. æ ¹æ“š ignore_warnings éæ¿¾çµ±è¨ˆè­¦å‘Š
        4. ä½¿ç”¨ Context.pipeline_timestamp è¨ˆç®—ç‰¹å¾µæ™‚é–“åç§»
        &quot;&quot;&quot;
        if self._feature_engineer is None:
            group_policies = []
            column_configs = {}

            if self._annotation_manager:
                group_policies = self._annotation_manager.get_group_policies()
                column_configs = self._annotation_manager.get_column_configs()

            # åˆä½µé…ç½®ï¼šAnnotation å„ªå…ˆæ–¼ç¨‹å¼ç¢¼é…ç½®
            merged_config = self.config.feature.copy()
            merged_config.group_policies = group_policies or merged_config.group_policies

            self._feature_engineer = FeatureEngineer(
                config=merged_config,
                annotation_columns=column_configs,
                context=self.get_context()  # v1.2: æ³¨å…¥æ™‚é–“åŸºæº–
            )
            self.logger.debug(&quot;åˆå§‹åŒ– FeatureEngineer (å« Group Policy èˆ‡ Context)&quot;)
        return self._feature_engineer

    def run_full_pipeline(self, input_files: List[Path]) -&gt; pl.DataFrame:
        &quot;&quot;&quot;
        åŸ·è¡Œå®Œæ•´ ETL æµç¨‹ï¼ˆv1.2: å¼·åŒ–é †åºèˆ‡ä½µç™¼æ§åˆ¶ï¼‰

        æµç¨‹:
        1. æª¢æŸ¥åˆå§‹åŒ–é †åºï¼ˆå·²æ–¼ __init__ å®Œæˆï¼‰
        2. BatchProcessor (Parser â†’ Cleaner â†’ Parquet + Manifest)
        3. Feature Engineer (Manifest â†’ Feature Matrixï¼Œå¥—ç”¨ device_role)
        4. ç¢ºä¿é‡‹æ”¾æª”æ¡ˆé–

        éŒ¯èª¤è™•ç†:
        - AnnotationSyncError (E406): çµ‚æ­¢æµç¨‹
        - ContractViolationError: çµ‚æ­¢æµç¨‹
        - FutureDataError: å–®æª”æ¡ˆè·³éï¼ˆä½¿ç”¨çµ±ä¸€æ™‚é–“åŸºæº–ï¼‰
        &quot;&quot;&quot;
        self.logger.info(f&quot;ğŸš€ å•Ÿå‹•å®Œæ•´ ETL Pipelineï¼Œè™•ç† {len(input_files)} å€‹æª”æ¡ˆ&quot;)
        self.logger.info(f&quot;ğŸ• æ™‚é–“åŸºæº–: {self.context.pipeline_timestamp.isoformat()}&quot;)

        try:
            # Step 1: Batch Processing
            bp = self.get_batch_processor()
            manifests = []

            for file_path in input_files:
                try:
                    result = bp.process_single_file(file_path)

                    if result.status == &quot;success&quot;:
                        manifests.append(result.manifest_path)
                        self.logger.info(f&quot;âœ… è™•ç†æˆåŠŸ: {file_path.name}&quot;)
                    elif result.status == &quot;future_data_rejected&quot;:
                        self.logger.warning(f&quot;âš ï¸  æœªä¾†è³‡æ–™æ‹’çµ•: {file_path.name} - {result.error}&quot;)
                    else:
                        self.logger.error(f&quot;âŒ è™•ç†å¤±æ•—: {file_path.name} - {result.error}&quot;)

                except ContractViolationError as e:
                    self.logger.error(f&quot;âŒ æª¢æŸ¥é» #2/#3 å¥‘ç´„é•å: {file_path.name} - {e}&quot;)
                    if self.config.strict_mode:
                        raise

            if not manifests:
                raise DataValidationError(&quot;æ²’æœ‰æˆåŠŸè™•ç†çš„æª”æ¡ˆï¼Œç„¡æ³•ç¹¼çºŒç‰¹å¾µå·¥ç¨‹&quot;)

            # Step 2: Feature Engineering
            fe = self.get_feature_engineer()
            manifest_path = manifests[-1]

            self.logger.info(f&quot;ğŸ”§ é–‹å§‹ç‰¹å¾µå·¥ç¨‹: {manifest_path}&quot;)

            # è®€å– Manifest èˆ‡è³‡æ–™
            df, metadata = fe.load_from_manifest(manifest_path)

            # æª¢æŸ¥é» #4: FE Input Schema é©—è­‰
            self.logger.info(&quot;ğŸ” æª¢æŸ¥é» #4: FE Input Schema - é©—è­‰ä¸­&quot;)

            # è½‰æ›ï¼ˆå« device_role èˆ‡ ignore_warnings è™•ç†ï¼‰
            feature_df = fe.transform(
                df,
                manifest_metadata=metadata,
                cutoff_timestamp=self.config.feature.cutoff_timestamp
            )

            elapsed = self.context.get_elapsed_seconds()
            self.logger.info(f&quot;âœ… ETL Pipeline å®Œæˆï¼Œè¼¸å‡ºç¶­åº¦: {feature_df.shape}ï¼Œè€—æ™‚: {elapsed:.2f} ç§’&quot;)
            return feature_df

        finally:
            # v1.2: ç¢ºä¿é‡‹æ”¾æª”æ¡ˆé–
            self._cleanup_lock()

    def reset(self):
        &quot;&quot;&quot;é‡ç½®æ‰€æœ‰å¿«å–å¯¦ä¾‹ï¼ˆä¿ç•™ Context èˆ‡ Lockï¼‰&quot;&quot;&quot;
        self._parser = None
        self._cleaner = None
        self._batch_processor = None
        self._feature_engineer = None
        # æ³¨æ„ï¼šä¸æ¸…é™¤ _annotation_manager èˆ‡ contextï¼Œç¢ºä¿é †åºä¸è®Š
        self.logger.debug(&quot;é‡ç½®æ‰€æœ‰æ¨¡çµ„å¯¦ä¾‹ï¼ˆä¿ç•™ Context èˆ‡ AnnotationManagerï¼‰&quot;)
</code></pre>
<h3 id="32-featureannotationmanagerv12">3.2 FeatureAnnotationManagerï¼ˆv1.2ï¼šç¶­æŒä¸è®Šï¼Œç¢ºä¿ç¹¼æ‰¿åˆä½µæ­£ç¢ºæ€§ï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/features/annotation_manager.py</code></p>
<p><strong>èªªæ˜</strong>: v1.2 ç¶­æŒ v1.1-REVISED çš„å¯¦ä½œï¼Œç¢ºä¿ç¹¼æ‰¿åˆä½µé‚è¼¯ç©©å®šã€‚æ­¤æ¨¡çµ„å¿…é ˆåœ¨ Container åˆå§‹åŒ–é †åºçš„ Step 3 å®Œæˆã€‚</p>
<pre><code class="language-python"># å…§å®¹èˆ‡ v1.1-REVISED ç›¸åŒï¼Œç¢ºä¿ï¼š
# 1. _load_with_inheritance() æ­£ç¢ºè™•ç† inherit: base
# 2. _deep_merge() æ­£ç¢ºè¦†è“‹çˆ¶è¨­å®šï¼ˆé appendï¼‰
# 3. å¾ªç’°ç¹¼æ‰¿æª¢æ¸¬ï¼ˆE407ï¼‰
# ï¼ˆç‚ºç°¡æ½”çœç•¥ç¨‹å¼ç¢¼ï¼Œå¯¦éš›éƒ¨ç½²è«‹è¤‡è£½ v1.1-REVISED å®Œæ•´å…§å®¹ï¼‰
</code></pre>
<hr />
<h2 id="4-cli-entry-point-">4. CLI å…¥å£é» (Entry Point) - æ•´åˆæ™‚é–“åŸºæº–èˆ‡ä½µç™¼è¨ºæ–·</h2>
<h3 id="41-hvaccli-v12">4.1 HVACCLI å¯¦ä½œï¼ˆv1.2 æ›´æ–°ï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/main.py</code></p>
<p><strong>é—œéµæ›´æ–° (v1.2)</strong>:<br />
- <code>run_etl</code> æŒ‡ä»¤é¡¯ç¤º PipelineContext æ™‚é–“åŸºæº–ï¼ˆä¾›é™¤éŒ¯ï¼‰<br />
- æ–°å¢ <code>diagnostics</code> æŒ‡ä»¤æª¢æŸ¥åˆå§‹åŒ–é †åºèˆ‡æ™‚é–“åŸºæº–<br />
- å¢å¼· <code>validate-annotation</code> æŒ‡ä»¤é¡¯ç¤ºé–ç‹€æ…‹</p>
<pre><code class="language-python">#!/usr/bin/env python3
import sys
from pathlib import Path
from typing import List, Optional
import fire

from src.container import ETLContainer
from src.utils.config_loader import ConfigLoader, ConfigurationError, AnnotationSyncError
from src.etl.exceptions import ContractViolationError, FutureDataError, DataValidationError

class HVACCLI:
    &quot;&quot;&quot;
    HVAC Analytics CLI ä»‹é¢ - v1.2

    æä¾›çµ±ä¸€çš„å‘½ä»¤åˆ—å…¥å£ï¼Œæ•´åˆ ETLã€å»ºæ¨¡èˆ‡ Feature Annotation ç®¡ç†ã€‚
    å¼·åŒ–åŠŸèƒ½ï¼šæ™‚é–“åŸºæº–å¯è¦–åŒ–ã€ä½µç™¼è¨ºæ–·ã€åˆå§‹åŒ–é †åºé©—è­‰ã€‚
    &quot;&quot;&quot;

    def __init__(self, config_path: str = &quot;config/settings.yaml&quot;):
        try:
            self.config = ConfigLoader.load(config_path)
            # v1.2: åˆå§‹åŒ– Containerï¼ˆæœƒè‡ªå‹•æª¢æŸ¥ Annotation åŒæ­¥ã€æ™‚é–“åŸºæº–é–å®šã€ç¹¼æ‰¿ï¼‰
            self.container = ETLContainer(self.config)
        except ConfigurationError as e:
            print(f&quot;âŒ é…ç½®éŒ¯èª¤: {e}&quot;)
            sys.exit(1)
        except AnnotationSyncError as e:
            print(f&quot;âŒ E406 åŒæ­¥éŒ¯èª¤: {e}&quot;)
            print(&quot;ğŸ’¡ è«‹åŸ·è¡Œ: python main.py features validate-annotation&quot;)
            sys.exit(6)
        except RuntimeError as e:
            if &quot;E003&quot; in str(e):
                print(f&quot;âŒ ä½µç™¼è¡çª: {e}&quot;)
                print(&quot;ğŸ’¡ è«‹ç¢ºèªæ˜¯å¦æœ‰å…¶ä»– Pipeline å¯¦ä¾‹æ­£åœ¨åŸ·è¡Œ&quot;)
                sys.exit(3)
            raise

    def run_etl(self, input_dir: str, output_dir: Optional[str] = None, pattern: str = &quot;*.csv&quot;):
        &quot;&quot;&quot;
        åŸ·è¡Œå®Œæ•´ ETL æµç¨‹ï¼ˆv1.2: é¡¯ç¤ºæ™‚é–“åŸºæº–èˆ‡åŸ·è¡Œæ™‚é–“çµ±è¨ˆï¼‰

        Args:
            input_dir: è¼¸å…¥ CSV æª”æ¡ˆç›®éŒ„
            output_dir: è¼¸å‡ºç›®éŒ„ (å¯é¸)
            pattern: æª”æ¡ˆåŒ¹é…æ¨¡å¼
        &quot;&quot;&quot;
        input_path = Path(input_dir)
        if not input_path.exists():
            print(f&quot;âŒ è¼¸å…¥ç›®éŒ„ä¸å­˜åœ¨: {input_dir}&quot;)
            return

        files = list(input_path.glob(pattern))
        if not files:
            print(f&quot;âš ï¸  æœªæ‰¾åˆ°åŒ¹é…æª”æ¡ˆ: {pattern}&quot;)
            return

        # v1.2: é¡¯ç¤ºæ™‚é–“åŸºæº–è³‡è¨Š
        context = self.container.get_context()
        print(f&quot;ğŸš€ å•Ÿå‹• ETL Pipelineï¼Œè™•ç† {len(files)} å€‹æª”æ¡ˆ...&quot;)
        print(f&quot;ğŸ• Pipeline æ™‚é–“åŸºæº–: {context.pipeline_timestamp.isoformat()} UTC&quot;)
        print(f&quot;ğŸ”’ åš´æ ¼æ¨¡å¼: {context.strict_mode}&quot;)

        # é¡¯ç¤º Annotation è³‡è¨Šï¼ˆå«ç¹¼æ‰¿éˆï¼‰
        manager = self.container.get_annotation_manager()
        print(f&quot;ğŸ“‹ Feature Annotation: Schema v{manager.schema_version}&quot;)
        print(f&quot;   ç¹¼æ‰¿éˆ: {manager.inheritance_chain}&quot;)

        try:
            result_df = self.container.run_full_pipeline(files)

            if output_dir:
                output_path = Path(output_dir)
                output_path.mkdir(parents=True, exist_ok=True)
                output_file = output_path / &quot;feature_matrix.parquet&quot;
                result_df.write_parquet(output_file)
                print(f&quot;ğŸ’¾ ç‰¹å¾µçŸ©é™£å·²å„²å­˜: {output_file}&quot;)

            elapsed = context.get_elapsed_seconds()
            print(f&quot;âœ… ETL å®Œæˆï¼Œè¼¸å‡ºç¶­åº¦: {result_df.shape}ï¼Œç¸½è€—æ™‚: {elapsed:.2f} ç§’&quot;)

        except AnnotationSyncError as e:
            print(f&quot;âŒ E406 Annotation åŒæ­¥éŒ¯èª¤: {e}&quot;)
            print(&quot;è«‹å…ˆåŸ·è¡Œ: python main.py features validate-annotation&quot;)
            sys.exit(6)

        except ContractViolationError as e:
            print(f&quot;âŒ å¥‘ç´„é•åéŒ¯èª¤: {e}&quot;)
            sys.exit(2)

        except FutureDataError as e:
            print(f&quot;âš ï¸  æœªä¾†è³‡æ–™éŒ¯èª¤: {e}&quot;)
            print(f&quot;ğŸ’¡ æç¤º: ä½¿ç”¨æ™‚é–“åŸºæº– {context.pipeline_timestamp.isoformat()} æª¢æ¸¬åˆ°æœªä¾†æ™‚é–“æˆ³&quot;)
            sys.exit(3)

        except Exception as e:
            print(f&quot;âŒ æœªé æœŸéŒ¯èª¤: {e}&quot;)
            import traceback
            traceback.print_exc()
            sys.exit(99)

    # ==================== Feature Annotation å­å‘½ä»¤ç¾¤çµ„ ====================

    class FeaturesCLI:
        &quot;&quot;&quot;Feature Annotation v1.2 ç®¡ç†æŒ‡ä»¤&quot;&quot;&quot;

        def __init__(self, parent):
            self.parent = parent
            self.config = parent.config.feature_annotation

        def wizard(self, site: Optional[str] = None, from_csv: Optional[str] = None):
            &quot;&quot;&quot;
            å•Ÿå‹•äº’å‹•å¼æ¨™è¨» Wizardï¼ˆåƒ…æ›´æ–° Excelï¼Œä¸ç›´å¯« YAMLï¼‰

            Usage:
                python main.py features wizard --site cgmh_ty --from-csv data/raw.csv

            æµç¨‹:
            1. åµæ¸¬ CSV æ–°æ¬„ä½
            2. äº’å‹•å¼ç¢ºèªç‰©ç†é¡å‹/å–®ä½
            3. å¯«å…¥ Excelï¼ˆæ¨™è¨˜ pending_reviewï¼‰
            4. æç¤ºä½¿ç”¨è€…æ‰‹å‹•åŸ·è¡Œ excel_to_yaml.py

            v1.2: è‡ªå‹•æª¢æŸ¥æ˜¯å¦æœ‰æ­£åœ¨åŸ·è¡Œçš„ Pipelineï¼ˆé¿å…ä½µç™¼ä¿®æ”¹ï¼‰
            &quot;&quot;&quot;
            site = site or self.parent.config.site_id
            csv_path = Path(from_csv) if from_csv else None

            # v1.2: æª¢æŸ¥æª”æ¡ˆé–
            lock_path = Path(self.config.lock_file_dir) / f&quot;{site}.yaml.lock&quot;
            if lock_path.exists():
                print(f&quot;âš ï¸  è­¦å‘Š: åµæ¸¬åˆ° Pipeline æ­£åœ¨åŸ·è¡Œï¼ˆé–æª”æ¡ˆå­˜åœ¨ï¼‰&quot;)
                print(f&quot;   å»ºè­°ç­‰å¾… Pipeline å®Œæˆå¾Œå†ä¿®æ”¹ Excelï¼Œé¿å… E406 è¡çª&quot;)
                response = input(&quot;æ˜¯å¦ç¹¼çºŒï¼Ÿ [y/N]: &quot;)
                if response.lower() != 'y':
                    return

            print(f&quot;ğŸ”§ å•Ÿå‹• Feature Annotation Wizard (v1.2)&quot;)
            print(f&quot;ğŸ“ Site: {site}&quot;)
            print(f&quot;âš ï¸  æ³¨æ„ï¼šWizard åƒ…æ›´æ–° Excelï¼Œä¸ç›´æ¥ä¿®æ”¹ YAML&quot;)

            from src.features.wizard import FeatureWizard

            wizard = FeatureWizard(
                site_id=site,
                excel_base_dir=self.config.excel_base_dir,
                template_version=self.config.current_template_version
            )

            try:
                excel_path = wizard.run(csv_path=csv_path)
                print(f&quot;\nâœ… Excel å·²æ›´æ–°: {excel_path}&quot;)
                print(&quot;âš ï¸  é‡è¦ï¼šè«‹é–‹å•Ÿ Excel ç¢ºèªæ¨™è¨»ï¼Œç¢ºèªå¾ŒåŸ·è¡Œï¼š&quot;)
                print(f&quot;   python tools/features/excel_to_yaml.py --input {excel_path} --output config/features/sites/{site}.yaml&quot;)
                print(f&quot;\n   æˆ–åŸ·è¡Œ: python main.py features validate-annotation --site {site}&quot;)
            except Exception as e:
                print(f&quot;âŒ Wizard å¤±æ•—: {e}&quot;)
                sys.exit(1)

        def validate_annotation(self, site: Optional[str] = None, strict: bool = False):
            &quot;&quot;&quot;
            é©—è­‰ Annotation ä¸¦ç”Ÿæˆ YAMLï¼ˆåŸ·è¡Œ E400-E406 æª¢æŸ¥ï¼Œå«ç¹¼æ‰¿é©—è­‰ï¼‰

            v1.2: è‡ªå‹•å–å¾—æª”æ¡ˆé–é˜²æ­¢ä½µç™¼è½‰æ›

            Checks:
            - E400: Template ç‰ˆæœ¬ç›¸å®¹æ€§ã€å¾ªç’°ç¹¼æ‰¿æª¢æ¸¬
            - E401: å­¤å…’æ¬„ä½ï¼ˆæ¨™è¨»å­˜åœ¨ä½† CSV ä¸å­˜åœ¨ï¼‰
            - E402: æœªå®šç¾©æ¬„ä½ï¼ˆCSV å­˜åœ¨ä½†æ¨™è¨»ä¸å­˜åœ¨ï¼‰
            - E403: å–®ä½èˆ‡ç‰©ç†é¡å‹ä¸åŒ¹é…
            - E404: Lag æ ¼å¼éŒ¯èª¤
            - E405: Target Leakage Risk
            - E406: Excel/YAML ä¸åŒæ­¥
            - E408: æª”æ¡ˆé–è¡çªï¼ˆv1.2 æ–°å¢ï¼‰
            &quot;&quot;&quot;
            site = site or self.parent.config.site_id
            excel_path = Path(self.config.excel_base_dir) / site / f&quot;{site}.xlsx&quot;
            yaml_path = Path(self.config.yaml_base_dir) / f&quot;{site}.yaml&quot;

            print(f&quot;ğŸ” é©—è­‰ Feature Annotation: {site}&quot;)
            print(f&quot;   Excel: {excel_path}&quot;)
            print(f&quot;   YAML:  {yaml_path}&quot;)

            # v1.2: å˜—è©¦å–å¾—æª”æ¡ˆé–
            try:
                with ConfigLoader.acquire_yaml_lock(site, self.config.lock_file_dir, timeout=5):
                    print(&quot;ğŸ”’ å·²å–å¾—ç¨ä½”é–ï¼Œé–‹å§‹é©—è­‰...&quot;)

                    # æª¢æŸ¥ E406 åŒæ­¥ç‹€æ…‹
                    sync_status = ConfigLoader.validate_annotation_sync(
                        site, self.config.excel_base_dir, self.config.yaml_base_dir
                    )

                    if not sync_status['synced']:
                        print(f&quot;âš ï¸  {sync_status['reason']}&quot;)
                        if strict:
                            sys.exit(6)
                    else:
                        print(&quot;âœ… E406: Excel/YAML åŒæ­¥æª¢æŸ¥ - é€šé&quot;)

                    # åŸ·è¡Œè½‰æ›èˆ‡é©—è­‰ï¼ˆå«ç¹¼æ‰¿åˆä½µæ¸¬è©¦ï¼‰
                    from tools.features.excel_to_yaml import convert_excel_to_yaml
                    result = convert_excel_to_yaml(
                        excel_path=excel_path,
                        output_path=yaml_path,
                        validate_only=False
                    )

                    # æ¸¬è©¦ç¹¼æ‰¿è¼‰å…¥
                    from src.features.annotation_manager import FeatureAnnotationManager
                    test_manager = FeatureAnnotationManager(
                        site_id=site,
                        yaml_base_dir=self.config.yaml_base_dir
                    )

                    print(f&quot;\nâœ… é©—è­‰é€šéï¼ŒYAML å·²ç”Ÿæˆ: {yaml_path}&quot;)
                    print(f&quot;   Schema Version: {result.get('schema_version')}&quot;)
                    print(f&quot;   ç¹¼æ‰¿éˆ: {test_manager.inheritance_chain}&quot;)
                    print(f&quot;   Columns: {len(test_manager.get_column_configs())}&quot;)
                    print(f&quot;   Warnings: {len(result.get('warnings', []))}&quot;)

                    for w in result.get('warnings', []):
                        print(f&quot;   âš ï¸  {w}&quot;)

            except FileLockError as e:
                print(f&quot;âŒ E408: ç„¡æ³•å–å¾—æª”æ¡ˆé–: {e}&quot;)
                print(&quot;ğŸ’¡ è«‹ç¢ºèªæ˜¯å¦æœ‰å…¶ä»–è™•ç†ç¨‹åºæ­£åœ¨åŸ·è¡Œ&quot;)
                sys.exit(1)
            except Exception as e:
                print(f&quot;âŒ é©—è­‰å¤±æ•—: {e}&quot;)
                sys.exit(1)

        def sync_check(self, site: Optional[str] = None):
            &quot;&quot;&quot;æª¢æŸ¥ Excel èˆ‡ YAML åŒæ­¥ç‹€æ…‹ï¼ˆE406 è¨ºæ–·ï¼‰&quot;&quot;&quot;
            site = site or self.parent.config.site_id
            status = ConfigLoader.validate_annotation_sync(
                site, self.config.excel_base_dir, self.config.yaml_base_dir
            )

            print(f&quot;ğŸ“Š åŒæ­¥ç‹€æ…‹æª¢æŸ¥: {site}&quot;)
            print(f&quot;   åŒæ­¥ç‹€æ…‹: {'âœ… åŒæ­¥' if status['synced'] else 'âŒ ä¸åŒæ­¥'}&quot;)
            print(f&quot;   è©³æƒ…: {status['reason']}&quot;)

            if 'excel_mtime' in status:
                from datetime import datetime
                excel_time = datetime.fromtimestamp(status['excel_mtime'])
                yaml_time = datetime.fromtimestamp(status['yaml_mtime'])
                print(f&quot;   Excel ä¿®æ”¹æ™‚é–“: {excel_time}&quot;)
                print(f&quot;   YAML ä¿®æ”¹æ™‚é–“:  {yaml_time}&quot;)

            # v1.2: é¡¯ç¤ºé–ç‹€æ…‹
            lock_path = Path(self.config.lock_file_dir) / f&quot;{site}.yaml.lock&quot;
            if lock_path.exists():
                lock_age = datetime.now().timestamp() - lock_path.stat().st_mtime
                print(f&quot;   ğŸ”’ æª”æ¡ˆé–ç‹€æ…‹: å­˜åœ¨ï¼ˆå·²æŒçºŒ {lock_age:.0f} ç§’ï¼‰&quot;)
            else:
                print(f&quot;   ğŸ”“ æª”æ¡ˆé–ç‹€æ…‹: æœªé–å®š&quot;)

        def migrate_excel(self, site: str, from_version: str = &quot;1.1&quot;, to_version: str = &quot;1.2&quot;):
            &quot;&quot;&quot;
            å‡ç´š Excel ç¯„æœ¬ç‰ˆæœ¬ï¼ˆv1.1 â†’ v1.2ï¼‰

            è™•ç†ï¼š
            - æ–°å¢ device_role æ¬„ä½ï¼ˆé è¨­ primaryï¼‰
            - æ–°å¢ ignore_warnings æ¬„ä½
            - æ›´æ–° System sheet ç‰ˆæœ¬è™Ÿ
            &quot;&quot;&quot;
            excel_path = Path(self.config.excel_base_dir) / site / f&quot;{site}.xlsx&quot;

            print(f&quot;ğŸ”„ å‡ç´š Excel ç¯„æœ¬: {site}&quot;)
            print(f&quot;   è·¯å¾‘: {excel_path}&quot;)
            print(f&quot;   ç‰ˆæœ¬: {from_version} â†’ {to_version}&quot;)

            from src.features.migrate_tool import ExcelMigrator
            migrator = ExcelMigrator()

            try:
                migrator.migrate(
                    excel_path=excel_path,
                    from_version=from_version,
                    to_version=to_version
                )
                print(f&quot;âœ… å‡ç´šå®Œæˆï¼Œè«‹ç¢ºèªå¾ŒåŸ·è¡Œ validate-annotation&quot;)
            except Exception as e:
                print(f&quot;âŒ å‡ç´šå¤±æ•—: {e}&quot;)
                sys.exit(1)

        def show_annotation(self, site: Optional[str] = None):
            &quot;&quot;&quot;é¡¯ç¤ºç•¶å‰ Annotation æ‘˜è¦ï¼ˆå«ç¹¼æ‰¿è³‡è¨Šï¼‰&quot;&quot;&quot;
            site = site or self.parent.config.site_id

            # å¼·åˆ¶é‡æ–°è¼‰å…¥ä»¥é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
            from src.features.annotation_manager import FeatureAnnotationManager
            manager = FeatureAnnotationManager(
                site_id=site,
                yaml_base_dir=self.config.yaml_base_dir
            )

            print(f&quot;ğŸ“‹ Feature Annotation æ‘˜è¦: {site}&quot;)
            print(f&quot;   Schema Version: {manager.schema_version}&quot;)
            print(f&quot;   ç¹¼æ‰¿éˆ: {manager.inheritance_chain}&quot;)
            print(f&quot;\n   Columns ({len(manager._columns)}):&quot;)

            for name, col in manager._columns.items():
                role_tag = f&quot;[{col.device_role.upper()}]&quot; if col.device_role != &quot;primary&quot; else &quot;&quot;
                target_tag = &quot;[TARGET]&quot; if col.is_target else &quot;&quot;
                inherit_mark = &quot;&quot;
                print(f&quot;   - {name:20} {col.physical_type:12} {role_tag} {target_tag} {inherit_mark}&quot;)
                if col.ignore_warnings:
                    print(f&quot;                        å¿½ç•¥è­¦å‘Š: {', '.join(col.ignore_warnings)}&quot;)

    def features(self):
        &quot;&quot;&quot;Feature Annotation ç®¡ç†æŒ‡ä»¤ç¾¤çµ„&quot;&quot;&quot;
        return self.FeaturesCLI(self)

    # ==================== v1.2 æ–°å¢ï¼šè¨ºæ–·æŒ‡ä»¤ ====================

    def diagnostics(self):
        &quot;&quot;&quot;
        ç³»çµ±è¨ºæ–·ï¼ˆv1.2 æ–°å¢ï¼‰

        æª¢æŸ¥é …ç›®ï¼š
        1. åˆå§‹åŒ–é †åºé©—è­‰
        2. PipelineContext æ™‚é–“åŸºæº–
        3. æª”æ¡ˆé–ç‹€æ…‹
        4. è¨˜æ†¶é«”ä½¿ç”¨é ä¼°
        &quot;&quot;&quot;
        print(&quot;ğŸ”§ HVAC Analytics ç³»çµ±è¨ºæ–·&quot;)
        print(&quot;=&quot; * 50)

        # 1. åˆå§‹åŒ–é †åºé©—è­‰
        print(&quot;\n1. åˆå§‹åŒ–é †åºé©—è­‰:&quot;)
        checks = [
            (&quot;PipelineContext&quot;, hasattr(self.container, 'context') and self.container.context is not None),
            (&quot;æª”æ¡ˆé–ç‹€æ…‹&quot;, self.container._lock_acquired),
            (&quot;AnnotationManager&quot;, self.container._annotation_manager is not None),
        ]
        for name, status in checks:
            print(f&quot;   {'âœ…' if status else 'âŒ'} {name}&quot;)

        # 2. æ™‚é–“åŸºæº–è³‡è¨Š
        print(&quot;\n2. æ™‚é–“åŸºæº–è³‡è¨Š:&quot;)
        ctx = self.container.get_context()
        print(f&quot;   Pipeline Timestamp: {ctx.pipeline_timestamp.isoformat()}&quot;)
        print(f&quot;   å·²åŸ·è¡Œæ™‚é–“: {ctx.get_elapsed_seconds():.2f} ç§’&quot;)
        print(f&quot;   Config Hash: {ctx.config_hash}&quot;)

        # 3. æª”æ¡ˆé–ç‹€æ…‹
        print(&quot;\n3. ä½µç™¼æ§åˆ¶ç‹€æ…‹:&quot;)
        lock_path = Path(self.config.feature_annotation.lock_file_dir) / f&quot;{self.config.site_id}.yaml.lock&quot;
        if lock_path.exists():
            lock_age = datetime.now().timestamp() - lock_path.stat().st_mtime
            print(f&quot;   ç‹€æ…‹: ğŸ”’ å·²é–å®šï¼ˆ{lock_age:.0f} ç§’ï¼‰&quot;)
        else:
            print(f&quot;   ç‹€æ…‹: ğŸ”“ æœªé–å®š&quot;)

        # 4. Annotation æ‘˜è¦
        print(&quot;\n4. Annotation ç‹€æ…‹:&quot;)
        manager = self.container.get_annotation_manager()
        print(f&quot;   Schema: {manager.schema_version}&quot;)
        print(f&quot;   ç¹¼æ‰¿éˆ: {manager.inheritance_chain}&quot;)
        print(f&quot;   æ¬„ä½æ•¸: {len(manager.get_column_configs())}&quot;)

        print(&quot;\n&quot; + &quot;=&quot; * 50)
        print(&quot;âœ… è¨ºæ–·å®Œæˆ&quot;)

    # ==================== åŸæœ‰æŒ‡ä»¤ ====================

    def validate_config(self):
        &quot;&quot;&quot;é©—è­‰ç•¶å‰é…ç½®ï¼ˆå« Feature Annotation èˆ‡ç¹¼æ‰¿ï¼‰&quot;&quot;&quot;
        print(&quot;âœ… é…ç½®è¼‰å…¥æˆåŠŸ&quot;)
        print(f&quot;   Site ID: {self.config.site_id}&quot;)
        print(f&quot;   Flags: {VALID_QUALITY_FLAGS}&quot;)
        print(f&quot;   Strict Mode: {self.config.strict_mode}&quot;)

        if self.config.feature_annotation.enabled:
            from src.features.annotation_manager import FeatureAnnotationManager
            manager = FeatureAnnotationManager(
                site_id=self.config.site_id,
                yaml_base_dir=self.config.feature_annotation.yaml_base_dir
            )
            print(f&quot;\nğŸ“‹ Feature Annotation:&quot;)
            print(f&quot;   Enabled: True&quot;)
            print(f&quot;   Schema Version: {manager.schema_version}&quot;)
            print(f&quot;   ç¹¼æ‰¿éˆ: {manager.inheritance_chain}&quot;)
            print(f&quot;   Template Version: {self.config.feature_annotation.current_template_version}&quot;)
            print(f&quot;   Columns Defined: {len(manager.get_column_configs())}&quot;)

    def version(self):
        &quot;&quot;&quot;é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š&quot;&quot;&quot;
        print(&quot;HVAC Analytics Pipeline v1.2 (System Integration)&quot;)
        print(&quot;æ ¸å¿ƒæ›´æ–°:&quot;)
        print(&quot;  - åš´æ ¼åˆå§‹åŒ–é †åºæ§åˆ¶ï¼ˆE406â†’Managerâ†’Modulesï¼‰&quot;)
        print(&quot;  - PipelineContext å…¨åŸŸæ™‚é–“åŸºæº–&quot;)
        print(&quot;  - YAML æª”æ¡ˆé–ä½µç™¼æ§åˆ¶&quot;)
        print(&quot;ç›¸å®¹æ¨¡çµ„ç‰ˆæœ¬:&quot;)
        print(&quot;  - Parser: v2.1+ (æ”¯æ´ Context æ™‚é–“åŸºæº–)&quot;)
        print(&quot;  - Cleaner: v2.2+ (device_role æ„ŸçŸ¥ï¼Œä¸å¯«å…¥ metadata)&quot;)
        print(&quot;  - BatchProcessor: v1.3+ (Annotation checksum)&quot;)
        print(&quot;  - FeatureEngineer: v1.3+ (Group Policy æ”¯æ´)&quot;)
        print(&quot;  - FeatureAnnotation: v1.2 (Excel-Centric + ç¹¼æ‰¿åˆä½µ)&quot;)
        print(&quot;  - InterfaceContract: v1.1 (éŒ¯èª¤ä»£ç¢¼åˆ†å±¤)&quot;)

def main():
    &quot;&quot;&quot;Entry point&quot;&quot;&quot;
    fire.Fire(HVACCLI)

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<hr />
<h2 id="5-error-handling-v12">5. éŒ¯èª¤è™•ç†èˆ‡å‚³æ’­ (Error Handling) - v1.2 æ›´æ–°</h2>
<h3 id="51">5.1 éŒ¯èª¤å‚³æ’­ç­–ç•¥ï¼ˆæ•´åˆæ™‚é–“åŸºæº–èˆ‡ä½µç™¼æ§åˆ¶ï¼‰</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤é¡å‹</th>
<th style="text-align: center;">ä»£ç¢¼</th>
<th style="text-align: left;">ç™¼ç”Ÿæ¨¡çµ„</th>
<th style="text-align: center;">å‚³æ’­ç­–ç•¥</th>
<th style="text-align: left;">ä¸‹æ¸¸å½±éŸ¿</th>
<th style="text-align: left;">ä½¿ç”¨è€…è¨Šæ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>EncodingError</code></td>
<td style="text-align: center;">E001</td>
<td style="text-align: left;">Parser</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">æ•´æ‰¹å¤±æ•—</td>
<td style="text-align: left;">"æª”æ¡ˆç·¨ç¢¼éŒ¯èª¤"</td>
</tr>
<tr>
<td style="text-align: left;"><code>MemoryLimitError</code></td>
<td style="text-align: center;">E002</td>
<td style="text-align: left;">Container</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ç³»çµ±ä¿è­·</td>
<td style="text-align: left;">"è¨˜æ†¶é«”è¶…é™"</td>
</tr>
<tr>
<td style="text-align: left;"><code>FileLockError</code></td>
<td style="text-align: center;">E003</td>
<td style="text-align: left;">ConfigLoader</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ç­‰å¾…é‡è©¦</td>
<td style="text-align: left;">"æª”æ¡ˆè¢«é–å®šï¼Œè«‹ç­‰å¾…å…¶ä»–è™•ç†ç¨‹åºå®Œæˆ"</td>
</tr>
<tr>
<td style="text-align: left;"><code>PipelineContextError</code></td>
<td style="text-align: center;">E004</td>
<td style="text-align: left;">Container</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ç³»çµ±éŒ¯èª¤</td>
<td style="text-align: left;">"æ™‚é–“åŸºæº–åˆå§‹åŒ–å¤±æ•—"</td>
</tr>
<tr>
<td style="text-align: left;"><code>FutureDataError</code></td>
<td style="text-align: center;">E102/E205/E303</td>
<td style="text-align: left;">Parser/Cleaner/BP</td>
<td style="text-align: center;"><strong>å–®æª”è·³é</strong></td>
<td style="text-align: left;">è©²æª”æ¡ˆä¸å…¥åº«</td>
<td style="text-align: left;">"æª”æ¡ˆå«æœªä¾†è³‡æ–™ï¼ˆç›¸å°æ–¼Pipelineå•Ÿå‹•æ™‚é–“ï¼‰"</td>
</tr>
<tr>
<td style="text-align: left;"><code>ContractViolationError</code></td>
<td style="text-align: center;">E204</td>
<td style="text-align: left;">Cleaner</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ä¾ strict_mode</td>
<td style="text-align: left;">"æ¨¡çµ„é–“ä»‹é¢å¥‘ç´„é•å"</td>
</tr>
<tr>
<td style="text-align: left;"><code>TEMPLATE_VERSION_MISMATCH</code></td>
<td style="text-align: center;">E400</td>
<td style="text-align: left;">ConfigLoader/FE</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">éœ€å‡ç´š Excel</td>
<td style="text-align: left;">"ç¯„æœ¬ç‰ˆæœ¬éèˆŠ"</td>
</tr>
<tr>
<td style="text-align: left;"><code>ORPHAN_COLUMN</code></td>
<td style="text-align: center;">E401</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">è¨˜éŒ„æ—¥èªŒ</td>
<td style="text-align: left;">"æ¨™è¨»æ¬„ä½ä¸å­˜åœ¨æ–¼è³‡æ–™"</td>
</tr>
<tr>
<td style="text-align: left;"><code>UNANNOTATED_COLUMN</code></td>
<td style="text-align: center;">E402</td>
<td style="text-align: left;">ConfigLoader/Cleaner</td>
<td style="text-align: center;"><strong>çµ‚æ­¢/è­¦å‘Š</strong></td>
<td style="text-align: left;">ä¾ unannotated_column_policy</td>
<td style="text-align: left;">"è³‡æ–™æ¬„ä½æœªå®šç¾©"</td>
</tr>
<tr>
<td style="text-align: left;"><code>UNIT_INCOMPATIBLE</code></td>
<td style="text-align: center;">E403</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">è¿”å› Excel ä¿®æ­£</td>
<td style="text-align: left;">"å–®ä½èˆ‡ç‰©ç†é¡å‹ä¸åŒ¹é…"</td>
</tr>
<tr>
<td style="text-align: left;"><code>LAG_FORMAT_INVALID</code></td>
<td style="text-align: center;">E404</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">è¿”å›ä¿®æ­£</td>
<td style="text-align: left;">"Lag é–“éš”æ ¼å¼éŒ¯èª¤"</td>
</tr>
<tr>
<td style="text-align: left;"><code>TARGET_LEAKAGE_RISK</code></td>
<td style="text-align: center;">E405</td>
<td style="text-align: left;">Pydantic Validation</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">è‡ªå‹•æ””æˆª</td>
<td style="text-align: left;">"is_target=True ä½† enable_lag=True"</td>
</tr>
<tr>
<td style="text-align: left;"><code>EXCEL_YAML_OUT_OF_SYNC</code></td>
<td style="text-align: center;">E406</td>
<td style="text-align: left;">ConfigLoader/Container</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">åŸ·è¡Œ validate-annotation</td>
<td style="text-align: left;">"Excel è¼ƒæ–°ï¼Œè«‹é‡æ–°ç”Ÿæˆ YAML"</td>
</tr>
<tr>
<td style="text-align: left;"><code>CIRCULAR_INHERITANCE</code></td>
<td style="text-align: center;">E407</td>
<td style="text-align: left;">FeatureAnnotationManager</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ä¿®æ­£ inherit æ¬„ä½</td>
<td style="text-align: left;">"å¾ªç’°ç¹¼æ‰¿æª¢æ¸¬"</td>
</tr>
<tr>
<td style="text-align: left;"><code>YAML_FILE_LOCKED</code></td>
<td style="text-align: center;">E408</td>
<td style="text-align: left;">ConfigLoader</td>
<td style="text-align: center;"><strong>çµ‚æ­¢/ç­‰å¾…</strong></td>
<td style="text-align: left;">ç­‰å¾…æˆ–é‡è©¦</td>
<td style="text-align: left;">"YAML æª”æ¡ˆè¢«é–å®š"</td>
</tr>
<tr>
<td style="text-align: left;"><code>INIT_ORDER_VIOLATION</code></td>
<td style="text-align: center;">E901</td>
<td style="text-align: left;">Container</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ç³»çµ±éŒ¯èª¤</td>
<td style="text-align: left;">"æ¨¡çµ„åˆå§‹åŒ–é †åºé•å"</td>
</tr>
<tr>
<td style="text-align: left;"><code>CONTEXT_NOT_INITIALIZED</code></td>
<td style="text-align: center;">E902</td>
<td style="text-align: left;">Container</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ç³»çµ±éŒ¯èª¤</td>
<td style="text-align: left;">"PipelineContext æœªåˆå§‹åŒ–"</td>
</tr>
<tr>
<td style="text-align: left;"><code>DIRECT_YAML_WRITE_BLOCKED</code></td>
<td style="text-align: center;">E501</td>
<td style="text-align: left;">Wizard (é˜²è­·)</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ä½¿ç”¨æ­£ç¢ºæµç¨‹</td>
<td style="text-align: left;">"ç¦æ­¢ç›´æ¥å¯«å…¥ YAMLï¼Œè«‹ä½¿ç”¨ Excel"</td>
</tr>
<tr>
<td style="text-align: left;"><code>MEAN_OUT_OF_RANGE</code></td>
<td style="text-align: center;">W401</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">æ¨™è¨˜ pending_review</td>
<td style="text-align: left;">"å¹³å‡å€¼è¶…å‡ºé æœŸç¯„åœ"</td>
</tr>
<tr>
<td style="text-align: left;"><code>LOW_VARIANCE</code></td>
<td style="text-align: center;">W402</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">æª¢æŸ¥å‡çµè³‡æ–™</td>
<td style="text-align: left;">"æ¨™æº–å·®æ¥è¿‘é›¶"</td>
</tr>
<tr>
<td style="text-align: left;"><code>HIGH_ZERO_RATIO</code></td>
<td style="text-align: center;">W403</td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning/å¿½ç•¥</td>
<td style="text-align: left;">å‚™ç”¨è¨­å‚™è‡ªå‹•æŠ‘åˆ¶</td>
<td style="text-align: left;">"é›¶å€¼æ¯”ä¾‹éé«˜"</td>
</tr>
</tbody>
</table>
<h3 id="52-v12">5.2 å…¨åŸŸéŒ¯èª¤è™•ç†å™¨ï¼ˆv1.2 æ›´æ–°ï¼‰</h3>
<pre><code class="language-python"># src/exceptions.py

from datetime import datetime, timezone
from typing import Optional

class HVACError(Exception):
    &quot;&quot;&quot;åŸºç¤éŒ¯èª¤é¡åˆ¥&quot;&quot;&quot;
    def __init__(self, message: str, error_code: Optional[str] = None, pipeline_timestamp: Optional[datetime] = None):
        super().__init__(message)
        self.error_code = error_code
        self.timestamp = datetime.now(timezone.utc)
        self.pipeline_timestamp = pipeline_timestamp  # v1.2: è¨˜éŒ„ç•¶æ™‚çš„æ™‚é–“åŸºæº–

class ContractViolationError(HVACError):
    &quot;&quot;&quot;E204: é•åæ¨¡çµ„é–“ä»‹é¢å¥‘ç´„&quot;&quot;&quot;
    pass

class FutureDataError(HVACError):
    &quot;&quot;&quot;
    E102/E205/E303: æª¢æ¸¬åˆ°æœªä¾†è³‡æ–™ï¼ˆç›¸å°æ–¼ Pipeline æ™‚é–“åŸºæº–ï¼‰

    v1.2: å¼·åˆ¶è¦æ±‚æä¾›æª¢æ¸¬åˆ°çš„æ™‚é–“æˆ³èˆ‡æ™‚é–“åŸºæº–ï¼Œç”¨æ–¼é™¤éŒ¯
    &quot;&quot;&quot;
    def __init__(self, message: str, detected_timestamp: datetime, pipeline_timestamp: datetime, file_path: Optional[str] = None):
        super().__init__(message, error_code=&quot;E205&quot;, pipeline_timestamp=pipeline_timestamp)
        self.detected_timestamp = detected_timestamp
        self.file_path = file_path

class ConfigurationError(HVACError):
    &quot;&quot;&quot;E001/E400-E408: é…ç½®éŒ¯èª¤&quot;&quot;&quot;
    pass

class AnnotationSyncError(ConfigurationError):
    &quot;&quot;&quot;E406: Excel èˆ‡ YAML ä¸åŒæ­¥&quot;&quot;&quot;
    pass

class FileLockError(ConfigurationError):
    &quot;&quot;&quot;E003/E408: æª”æ¡ˆé–å®šå¤±æ•—&quot;&quot;&quot;
    pass

class InheritanceError(ConfigurationError):
    &quot;&quot;&quot;E407: YAML ç¹¼æ‰¿éˆéŒ¯èª¤ï¼ˆå¾ªç’°æˆ–éºå¤±ï¼‰&quot;&quot;&quot;
    pass

class ValidationError(ConfigurationError):
    &quot;&quot;&quot;E403-E405: Feature Annotation é©—è­‰å¤±æ•—&quot;&quot;&quot;
    pass

class InitializationError(HVACError):
    &quot;&quot;&quot;E901/E902: åˆå§‹åŒ–é †åºæˆ– Context éŒ¯èª¤&quot;&quot;&quot;
    pass

class SecurityError(HVACError):
    &quot;&quot;&quot;E501: å®‰å…¨/è·è²¬åˆ†é›¢é•å&quot;&quot;&quot;
    pass
</code></pre>
<hr />
<h2 id="6-version-compatibility-matrix-v12">6. ç‰ˆæœ¬ç›¸å®¹æ€§çŸ©é™£ (Version Compatibility Matrix) - v1.2 æ›´æ–°</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">System Integration</th>
<th style="text-align: center;">Parser</th>
<th style="text-align: center;">Cleaner</th>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;">Feature Annotation</th>
<th style="text-align: center;">Interface Contract</th>
<th style="text-align: center;">ç›¸å®¹æ€§</th>
<th style="text-align: left;">èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>v1.2</strong></td>
<td style="text-align: center;">v2.1+</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;"><strong>v1.2</strong></td>
<td style="text-align: center;"><strong>v1.1</strong></td>
<td style="text-align: center;">âœ… <strong>å®Œå…¨ç›¸å®¹</strong></td>
<td style="text-align: left;">æ¨è–¦é…ç½®ï¼Œæ”¯æ´æ™‚é–“åŸºæº–èˆ‡ä½µç™¼æ§åˆ¶</td>
</tr>
<tr>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v2.1+</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">âš ï¸ <strong>é™ç´šç›¸å®¹</strong></td>
<td style="text-align: left;">éŒ¯èª¤ä»£ç¢¼åˆ†å±¤å¯èƒ½ä¸ä¸€è‡´</td>
</tr>
<tr>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v2.0</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">Parser å¿…é ˆ v2.1+ æ”¯æ´ Context</td>
</tr>
<tr>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v2.1+</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">âš ï¸ <strong>éƒ¨åˆ†ç›¸å®¹</strong></td>
<td style="text-align: left;">ç¼ºå°‘åš´æ ¼åˆå§‹åŒ–é †åºèˆ‡æ™‚é–“åŸºæº–çµ±ä¸€</td>
</tr>
<tr>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">ç¼ºå°‘ Annotation èˆ‡é †åºæ§åˆ¶</td>
</tr>
</tbody>
</table>
<p><strong>å‡ç´šè·¯å¾‘ (v1.1 â†’ v1.2)</strong>: <br />
1. <strong>System Integration</strong>ï¼ˆæ›´æ–° Container é †åºæ§åˆ¶ã€æ–°å¢ Contextã€æª”æ¡ˆé–ï¼‰<br />
2. <strong>Interface Contract</strong>ï¼ˆæ›´æ–°éŒ¯èª¤ä»£ç¢¼åˆ†å±¤ E0xx-E9xxï¼‰<br />
3. <strong>Parser/Cleaner/BatchProcessor</strong>ï¼ˆæ”¯æ´ PipelineContext æ™‚é–“åŸºæº–æ³¨å…¥ï¼‰<br />
4. é©—è­‰ä½µç™¼æ§åˆ¶ï¼ˆæ¨¡æ“¬å¤šé€²ç¨‹åŒæ™‚å­˜å– YAMLï¼‰</p>
<hr />
<h2 id="7-integration-test-plan-v12">7. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Integration Test Plan) - v1.2 æ›´æ–°</h2>
<h3 id="71">7.1 å…¨éˆè·¯æ•´åˆæ¸¬è©¦ï¼ˆæ–°å¢é †åºã€ä½µç™¼ã€æ™‚é–“åŸºæº–æ¸¬è©¦ï¼‰</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸçµæœ</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">INT-SYS-001</td>
<td style="text-align: left;">æˆåŠŸæµç¨‹</td>
<td style="text-align: left;">æ¨™æº– CSV + v1.2 Annotation</td>
<td style="text-align: left;">è¼¸å‡º Feature Matrixï¼Œç„¡éŒ¯èª¤</td>
<td style="text-align: left;">å…¨éˆè·¯ç„¡ç¸«éŠœæ¥</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-002</td>
<td style="text-align: left;">ç·¨ç¢¼è‡ªé©æ‡‰</td>
<td style="text-align: left;">Big5 ç·¨ç¢¼ CSV</td>
<td style="text-align: left;">æ­£ç¢ºè§£æ</td>
<td style="text-align: left;">Parser v2.1</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-003</td>
<td style="text-align: left;">æ™‚å€ä¸€è‡´æ€§</td>
<td style="text-align: left;">Asia/Taipei è¼¸å…¥</td>
<td style="text-align: left;">è½‰æ›ç‚º UTC</td>
<td style="text-align: left;">æ™‚å€å®¹éŒ¯</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-004</td>
<td style="text-align: left;">æœªä¾†è³‡æ–™æ””æˆª</td>
<td style="text-align: left;">æ˜å¤©æ™‚é–“æˆ³</td>
<td style="text-align: left;">å–®æª”æ‹’çµ• (E205)</td>
<td style="text-align: left;">Data Leakage é˜²è­·</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-004-T</strong></td>
<td style="text-align: left;"><strong>æ™‚é–“åŸºæº–ä¸€è‡´æ€§</strong></td>
<td style="text-align: left;">Pipeline åŸ·è¡Œ 10 åˆ†é˜å¾Œçš„ã€Œæœªä¾†ã€è³‡æ–™</td>
<td style="text-align: left;">æ­£ç¢ºè­˜åˆ¥ï¼ˆä¸å› æ™‚é–“æµé€èª¤åˆ¤ï¼‰</td>
<td style="text-align: left;">Context æ™‚é–“åŸºæº–å‡çµ</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-005</td>
<td style="text-align: left;">å¥‘ç´„é•å</td>
<td style="text-align: left;">ç¼ºå°‘ timestamp</td>
<td style="text-align: left;">ContractViolationError</td>
<td style="text-align: left;">æª¢æŸ¥é» #1</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-006</td>
<td style="text-align: left;">SSOT åŒæ­¥</td>
<td style="text-align: left;">SENSOR_OFFLINE flag</td>
<td style="text-align: left;">One-hot è‡ªå‹•åŒ…å«</td>
<td style="text-align: left;">SSOT ä¸€è‡´æ€§</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-007R</td>
<td style="text-align: left;">ç¹¼æ‰¿åˆä½µ</td>
<td style="text-align: left;">cgmh_ty ç¹¼æ‰¿ base</td>
<td style="text-align: left;">æ­£ç¢ºåˆä½µ base çš„ physical_types</td>
<td style="text-align: left;">ç¹¼æ‰¿æ©Ÿåˆ¶é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-008R</td>
<td style="text-align: left;">å¾ªç’°ç¹¼æ‰¿é˜²è­·</td>
<td style="text-align: left;">A inherit B, B inherit A</td>
<td style="text-align: left;">æ‹‹å‡º E407</td>
<td style="text-align: left;">å¾ªç’°æª¢æ¸¬é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-009</td>
<td style="text-align: left;">E406 åŒæ­¥æª¢æŸ¥</td>
<td style="text-align: left;">ä¿®æ”¹ Excel ä½†æœªç”Ÿæˆ YAML</td>
<td style="text-align: left;">Pipeline å•Ÿå‹•æ™‚æ‹’çµ• (E406)</td>
<td style="text-align: left;">æª¢æŸ¥é» #5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-009-C</strong></td>
<td style="text-align: left;"><strong>ä½µç™¼å¯«å…¥é˜²è­·</strong></td>
<td style="text-align: left;">åŒæ™‚åŸ·è¡Œå…©å€‹ Pipeline å¯¦ä¾‹</td>
<td style="text-align: left;">ç¬¬äºŒå€‹å¯¦ä¾‹å–å¾— E003</td>
<td style="text-align: left;">æª”æ¡ˆé–æ©Ÿåˆ¶</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-009-W</strong></td>
<td style="text-align: left;"><strong>Wizard ä½µç™¼é˜²è­·</strong></td>
<td style="text-align: left;">Pipeline åŸ·è¡Œä¸­åŸ·è¡Œ Wizard</td>
<td style="text-align: left;">Wizard é¡¯ç¤ºè­¦å‘Š</td>
<td style="text-align: left;">é–ç‹€æ…‹åµæ¸¬</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-010R</td>
<td style="text-align: left;">Cleaner è·è²¬åˆ†é›¢</td>
<td style="text-align: left;">backup è¨­å‚™åŸ·è¡Œæ¸…æ´—</td>
<td style="text-align: left;">Cleaner è®€å– role ä½†ä¸å¯«å…¥ metadata</td>
<td style="text-align: left;">è·è²¬é‚Šç•Œé©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-011</td>
<td style="text-align: left;">device_role å‚³é</td>
<td style="text-align: left;">backup è¨­å‚™ 80% é›¶å€¼</td>
<td style="text-align: left;">FE æŠ‘åˆ¶ W403 è­¦å‘Š</td>
<td style="text-align: left;">device_role æ„ŸçŸ¥</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-012</td>
<td style="text-align: left;">Group Policy åŸ·è¡Œ</td>
<td style="text-align: left;">chillers_* æ¬„ä½</td>
<td style="text-align: left;">æ­£ç¢ºå¥—ç”¨ Standard_Chiller æ¨¡æ¿</td>
<td style="text-align: left;">Group Policy æ•´åˆ</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-013</td>
<td style="text-align: left;">ignore_warnings ç”Ÿæ•ˆ</td>
<td style="text-align: left;">æ¨™è¨˜ W401 å¿½ç•¥</td>
<td style="text-align: left;">è©²æ¬„ä½ä¸è§¸ç™¼å‡å€¼ç•°å¸¸è­¦å‘Š</td>
<td style="text-align: left;">è­¦å‘ŠæŠ‘åˆ¶æ©Ÿåˆ¶</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-014</td>
<td style="text-align: left;">æœªå®šç¾©æ¬„ä½è™•ç†</td>
<td style="text-align: left;">CSV å«æœªæ¨™è¨»æ¬„ä½</td>
<td style="text-align: left;">ä¾ unannotated_column_policy è™•ç†</td>
<td style="text-align: left;">E402 é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-015</td>
<td style="text-align: left;">Template ç‰ˆæœ¬ç›¸å®¹</td>
<td style="text-align: left;">v1.1 Excel åŸ·è¡Œè½‰æ›</td>
<td style="text-align: left;">å ±éŒ¯ E400ï¼Œæç¤º migrate</td>
<td style="text-align: left;">ç‰ˆæœ¬æ§åˆ¶</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-016</strong></td>
<td style="text-align: left;"><strong>åˆå§‹åŒ–é †åºé©—è­‰</strong></td>
<td style="text-align: left;">å¼·åˆ¶äº¤æ› Cleaner èˆ‡ Manager åˆå§‹åŒ–é †åº</td>
<td style="text-align: left;">æ‹‹å‡º E901</td>
<td style="text-align: left;">é †åºå¼·åˆ¶åŸ·è¡Œ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-deliverables-v12">8. äº¤ä»˜ç‰©æ¸…å–® (Deliverables) - v1.2 æ›´æ–°</h2>
<h3 id="81-v12">8.1 ç¨‹å¼ç¢¼æª”æ¡ˆï¼ˆv1.2 æ–°å¢èˆ‡ä¿®æ”¹ï¼‰</h3>
<ol>
<li><code>src/context.py</code> - <strong>v1.2 æ–°å¢</strong>: PipelineContext æ™‚é–“åŸºæº–èˆ‡ç‹€æ…‹è¼‰é«”</li>
<li><code>src/etl/config_models.py</code> - <strong>v1.2 æ›´æ–°</strong>: æ–°å¢ ConcurrencyConfigã€éŒ¯èª¤ä»£ç¢¼åˆ†å±¤ E0xx-E9xx</li>
<li><code>src/utils/config_loader.py</code> - <strong>v1.2 æ›´æ–°</strong>: æ–°å¢ <code>acquire_yaml_lock()</code> æª”æ¡ˆé–æ©Ÿåˆ¶</li>
<li><code>src/container.py</code> - <strong>v1.2 é‡æ§‹</strong>: åš´æ ¼åˆå§‹åŒ–é †åºæ§åˆ¶ï¼ˆStep 1-4ï¼‰ã€Context æ³¨å…¥ã€æª”æ¡ˆé–ç®¡ç†</li>
<li><code>src/main.py</code> - <strong>v1.2 æ›´æ–°</strong>: æ–°å¢ <code>diagnostics</code> æŒ‡ä»¤ã€æ™‚é–“åŸºæº–é¡¯ç¤º</li>
<li><code>src/features/annotation_manager.py</code> - <strong>ç¶­æŒ v1.1</strong>: ç¹¼æ‰¿åˆä½µé‚è¼¯</li>
<li><code>src/exceptions.py</code> - <strong>v1.2 æ›´æ–°</strong>: æ–°å¢éŒ¯èª¤ä»£ç¢¼ E003, E004, E408, E901, E902</li>
</ol>
<h3 id="82">8.2 é…ç½®æª”æ¡ˆ</h3>
<ol start="8">
<li><code>config/settings.yaml</code> - <strong>v1.2 æ›´æ–°</strong>: æ–°å¢ <code>concurrency</code> èˆ‡ <code>feature_annotation.lock_file_dir</code></li>
<li><code>config/features/schema.json</code> - <strong>ç¶­æŒ</strong>: JSON Schema v1.2</li>
</ol>
<h3 id="83-v12">8.3 æ¸¬è©¦æª”æ¡ˆï¼ˆv1.2 æ–°å¢ï¼‰</h3>
<ol start="10">
<li><code>tests/test_concurrency_control.py</code> - <strong>v1.2 æ–°å¢</strong>: æª”æ¡ˆé–ã€ä½µç™¼å­˜å–æ¸¬è©¦</li>
<li><code>tests/test_initialization_order.py</code> - <strong>v1.2 æ–°å¢</strong>: é †åºé•åæª¢æ¸¬æ¸¬è©¦ (E901)</li>
<li><code>tests/test_pipeline_context.py</code> - <strong>v1.2 æ–°å¢</strong>: æ™‚é–“åŸºæº–å‡çµã€æœªä¾†è³‡æ–™æª¢æŸ¥ä¸€è‡´æ€§</li>
<li><code>tests/test_integration_full_pipeline.py</code> - <strong>v1.2 æ›´æ–°</strong>: æ–°å¢ INT-SYS-004-T, 009-C, 009-W, 016</li>
</ol>
<h3 id="84">8.4 æ–‡ä»¶æª”æ¡ˆ</h3>
<ol start="14">
<li><code>docs/integration/PRD_System_Integration_v1.2.md</code> - <strong>æœ¬æ–‡ä»¶</strong></li>
<li><code>docs/integration/TROUBLESHOOTING.md</code> - <strong>v1.2 æ–°å¢</strong>: éŒ¯èª¤ä»£ç¢¼æŸ¥è©¢èˆ‡è§£æ±ºæ–¹æ¡ˆï¼ˆE003, E406, E901 ç­‰ï¼‰</li>
</ol>
<hr />
<h2 id="9-action-items-v12">9. åŸ·è¡Œæª¢æŸ¥æ¸…å–® (Action Items) - v1.2 åŸ·è¡Œé †åº</h2>
<h3 id="phase-1-day-1">Phase 1: åŸºç¤è¨­æ–½èˆ‡æ™‚é–“åŸºæº–ï¼ˆDay 1ï¼‰</h3>
<ul>
<li>[ ] å»ºç«‹ <code>src/context.py</code>ï¼šå¯¦ä½œ <code>PipelineContext</code> é¡åˆ¥ï¼ˆæ™‚é–“åŸºæº–å‡çµã€æœªä¾†è³‡æ–™æª¢æŸ¥æ–¹æ³•ï¼‰</li>
<li>[ ] æ›´æ–° <code>src/etl/config_models.py</code>ï¼šæ–°å¢ <code>ConcurrencyConfig</code>ã€æ›´æ–°éŒ¯èª¤ä»£ç¢¼åˆ†å±¤ï¼ˆE0xx-E9xxï¼‰</li>
<li>[ ] é©—è­‰ï¼šContext ç”¢ç”Ÿå¾Œæ™‚é–“åŸºæº–ä¸å†è®Šå‹•</li>
</ul>
<h3 id="phase-2-day-2">Phase 2: ä½µç™¼æ§åˆ¶ï¼ˆDay 2ï¼‰</h3>
<ul>
<li>[ ] æ›´æ–° <code>src/utils/config_loader.py</code>ï¼šå¯¦ä½œ <code>acquire_yaml_lock()</code> ä½¿ç”¨ <code>fcntl.LOCK_EX</code></li>
<li>[ ] å»ºç«‹é–æª”æ¡ˆç›®éŒ„ <code>data/.locks</code> ä¸¦ç¢ºä¿æ¬Šé™æ­£ç¢º</li>
<li>[ ] é©—è­‰ï¼šåŒæ™‚åŸ·è¡Œå…©å€‹ Container å¯¦ä¾‹ï¼Œç¬¬äºŒå€‹æ‡‰æ”¶åˆ° E003 éŒ¯èª¤</li>
</ul>
<h3 id="phase-3-day-3-4">Phase 3: åˆå§‹åŒ–é †åºæ§åˆ¶ï¼ˆDay 3-4ï¼‰</h3>
<ul>
<li>[ ] é‡æ§‹ <code>src/container.py</code>ï¼š</li>
<li>[ ] å¯¦ä½œ <code>__init__</code> å››æ­¥é©Ÿé †åºï¼ˆContext â†’ Lock â†’ Manager â†’ Othersï¼‰</li>
<li>[ ] å¯¦ä½œ <code>_initialize_in_order()</code> èˆ‡é †åºé©—è­‰</li>
<li>[ ] ç¢ºä¿ <code>get_cleaner()</code> æª¢æŸ¥ AnnotationManager å·²åˆå§‹åŒ–ï¼ˆE901ï¼‰</li>
<li>[ ] å¯¦ä½œ <code>__del__</code> ç¢ºä¿é–é‡‹æ”¾</li>
<li>[ ] é©—è­‰ï¼šäº¤æ›åˆå§‹åŒ–é †åºæ‡‰è§¸ç™¼ E901 éŒ¯èª¤ï¼ˆä½¿ç”¨æ¸¬è©¦æ¡ˆä¾‹ INT-SYS-016ï¼‰</li>
</ul>
<h3 id="phase-4-day-5">Phase 4: æ¨¡çµ„æ•´åˆï¼ˆDay 5ï¼‰</h3>
<ul>
<li>[ ] æ›´æ–° <code>ReportParser</code>ï¼šæ¥å— <code>context</code> åƒæ•¸ï¼Œä½¿ç”¨ <code>context.is_future_timestamp()</code> æ›¿ä»£ <code>datetime.now()</code></li>
<li>[ ] æ›´æ–° <code>DataCleaner</code>ï¼šæ¥å— <code>context</code> åƒæ•¸ï¼Œçµ±ä¸€æ™‚é–“æª¢æŸ¥åŸºæº–</li>
<li>[ ] æ›´æ–° <code>BatchOrchestrator</code>ï¼šæ¥å— <code>context</code> åƒæ•¸ï¼Œå¯«å…¥ Manifest æ™‚è¨˜éŒ„ <code>pipeline_timestamp</code></li>
<li>[ ] æ›´æ–° <code>FeatureEngineer</code>ï¼šæ¥å— <code>context</code> åƒæ•¸</li>
<li>[ ] é©—è­‰ï¼šé•·æ™‚é–“åŸ·è¡Œï¼ˆæ¨¡æ“¬ 10 åˆ†é˜ï¼‰å¾Œï¼Œæœªä¾†è³‡æ–™æª¢æŸ¥ä»ä½¿ç”¨åˆå§‹æ™‚é–“åŸºæº–</li>
</ul>
<h3 id="phase-5-cli-day-6">Phase 5: CLI èˆ‡è¨ºæ–·ï¼ˆDay 6ï¼‰</h3>
<ul>
<li>[ ] æ›´æ–° <code>src/main.py</code>ï¼šæ–°å¢ <code>diagnostics</code> æŒ‡ä»¤é¡¯ç¤ºæ™‚é–“åŸºæº–èˆ‡é–ç‹€æ…‹</li>
<li>[ ] æ›´æ–° <code>run_etl</code>ï¼šé¡¯ç¤º PipelineContext æ™‚é–“åŸºæº–</li>
<li>[ ] æ›´æ–° <code>validate_annotation</code>ï¼šæ•´åˆæª”æ¡ˆé–å–å¾—é‚è¼¯</li>
<li>[ ] å»ºç«‹ <code>docs/integration/TROUBLESHOOTING.md</code></li>
</ul>
<h3 id="phase-6-day-7">Phase 6: æ•´åˆæ¸¬è©¦ï¼ˆDay 7ï¼‰</h3>
<ul>
<li>[ ] åŸ·è¡Œ INT-SYS-004-Tï¼ˆæ™‚é–“åŸºæº–å‡çµæ¸¬è©¦ï¼‰</li>
<li>[ ] åŸ·è¡Œ INT-SYS-009-Cï¼ˆä½µç™¼è¡çªæ¸¬è©¦ï¼‰</li>
<li>[ ] åŸ·è¡Œ INT-SYS-009-Wï¼ˆWizard ä½µç™¼åµæ¸¬æ¸¬è©¦ï¼‰</li>
<li>[ ] åŸ·è¡Œ INT-SYS-016ï¼ˆåˆå§‹åŒ–é †åºå¼·åˆ¶åŸ·è¡Œæ¸¬è©¦ï¼‰</li>
<li>[ ] åŸ·è¡Œæ—¢æœ‰æ¸¬è©¦ INT-SYS-001~015 ç¢ºä¿ç„¡è¿´æ­¸</li>
</ul>
<hr />
<h2 id="10-sign-off-checklist-v12">10. é©—æ”¶ç°½æ ¸ (Sign-off Checklist) - v1.2</h2>
<h3 id="_1">æ ¸å¿ƒåŠŸèƒ½é©—æ”¶</h3>
<ul>
<li>[ ] <strong>åˆå§‹åŒ–é †åºå¼·åˆ¶åŸ·è¡Œ</strong>: é•åé †åºï¼ˆå¦‚å…ˆåˆå§‹åŒ– Cleaner å†åˆå§‹åŒ– Managerï¼‰æœƒæ‹‹å‡º E901</li>
<li>[ ] <strong>æ™‚é–“åŸºæº–å‡çµ</strong>: Pipeline åŸ·è¡Œ 10 åˆ†é˜å¾Œï¼Œã€Œæœªä¾†è³‡æ–™ã€æª¢æŸ¥ä»ä½¿ç”¨å•Ÿå‹•æ™‚çš„æ™‚é–“åŸºæº–</li>
<li>[ ] <strong>æª”æ¡ˆé–æ©Ÿåˆ¶</strong>: åŒæ™‚åŸ·è¡Œå…©å€‹ Pipeline å¯¦ä¾‹ï¼Œç¬¬äºŒå€‹å¯¦ä¾‹æ­£ç¢ºæ”¶åˆ° E003 éŒ¯èª¤ä¸¦é€€å‡º</li>
<li>[ ] <strong>Wizard ä½µç™¼åµæ¸¬</strong>: Pipeline åŸ·è¡Œä¸­åŸ·è¡Œ Wizardï¼ŒWizard æ­£ç¢ºåµæ¸¬é–æª”æ¡ˆä¸¦é¡¯ç¤ºè­¦å‘Š</li>
</ul>
<h3 id="ssot-annotation-v11">SSOT èˆ‡ Annotation é©—æ”¶ï¼ˆç¶­æŒ v1.1 æ¨™æº–ï¼‰</h3>
<ul>
<li>[ ] <strong>SSOT ä¸€è‡´æ€§</strong>: Excel ç‚º Annotation å”¯ä¸€ç·¨è¼¯å…¥å£ï¼Œç„¡å…¨åŸŸé è¨­å€¼</li>
<li>[ ] <strong>å–®å‘æµé©—è­‰</strong>: Wizard ç„¡æ³•ç›´æ¥å¯«å…¥ YAMLï¼Œå¿…é ˆé€é Excel â†’ excel_to_yaml.py</li>
<li>[ ] <strong>ç¹¼æ‰¿æ©Ÿåˆ¶</strong>: <code>inherit: base</code> æ­£ç¢ºåˆä½µçˆ¶è¨­å®šï¼Œå¾ªç’°ç¹¼æ‰¿æ­£ç¢ºæª¢æ¸¬ä¸¦æ‹‹å‡º E407</li>
<li>[ ] <strong>Cleaner è·è²¬åˆ†é›¢</strong>: Cleaner è®€å– device_role åƒ…ç”¨æ–¼èª¿æ•´æ¸…æ´—é–¾å€¼ï¼ˆä¸å¯«å…¥ metadataï¼‰</li>
</ul>
<h3 id="_2">éŒ¯èª¤è™•ç†èˆ‡è¨ºæ–·é©—æ”¶</h3>
<ul>
<li>[ ] <strong>éŒ¯èª¤ä»£ç¢¼åˆ†å±¤</strong>: æ‰€æœ‰éŒ¯èª¤ä»£ç¢¼ç¬¦åˆ E0xx-E9xx åˆ†å±¤è¦ç¯„</li>
<li>[ ] <strong>è¨ºæ–·æŒ‡ä»¤</strong>: <code>python main.py diagnostics</code> æ­£ç¢ºé¡¯ç¤ºæ™‚é–“åŸºæº–ã€åˆå§‹åŒ–é †åºã€é–ç‹€æ…‹</li>
<li>[ ] <strong>éŒ¯èª¤è³‡è¨Šè±å¯Œåº¦</strong>: FutureDataError åŒ…å«æª¢æ¸¬åˆ°çš„æ™‚é–“æˆ³èˆ‡ Pipeline æ™‚é–“åŸºæº–ï¼Œä¾¿æ–¼é™¤éŒ¯</li>
</ul>
<hr />
<h2 id="v11-v12">é™„éŒ„ï¼šv1.1 â†’ v1.2 è®Šæ›´æ‘˜è¦</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¡åˆ¥</th>
<th style="text-align: left;">v1.1 ç‹€æ…‹</th>
<th style="text-align: left;">v1.2 è®Šæ›´</th>
<th style="text-align: left;">å½±éŸ¿é¢¨éšª</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>åˆå§‹åŒ–é †åº</strong></td>
<td style="text-align: left;">æ–‡å­—æè¿°ï¼Œç„¡å¼·åˆ¶åŸ·è¡Œ</td>
<td style="text-align: left;">å››æ­¥é©Ÿåš´æ ¼é †åºï¼Œé•åæ‹‹ E901</td>
<td style="text-align: left;">ä½ï¼ˆåƒ…é˜²æ­¢éŒ¯èª¤ä½¿ç”¨ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ™‚é–“åŸºæº–</strong></td>
<td style="text-align: left;">å„æ¨¡çµ„å„è‡ªå‘¼å« <code>now()</code></td>
<td style="text-align: left;"><code>PipelineContext</code> çµ±ä¸€åŸºæº–</td>
<td style="text-align: left;">ä¸­ï¼ˆéœ€æ›´æ–° Parser/Cleaner/BP/FEï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ä½µç™¼æ§åˆ¶</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><code>fcntl</code> æª”æ¡ˆé–æ©Ÿåˆ¶</td>
<td style="text-align: left;">ä½ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>éŒ¯èª¤ä»£ç¢¼</strong></td>
<td style="text-align: left;">E400-E407, E800 è¡çª</td>
<td style="text-align: left;">E0xx-E9xx åˆ†å±¤ï¼Œæ–°å¢ E003, E004, E408, E901, E902</td>
<td style="text-align: left;">ä½ï¼ˆæ–‡ä»¶èˆ‡ Exception å®šç¾©ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Container ç”Ÿå‘½å‘¨æœŸ</strong></td>
<td style="text-align: left;">ç„¡æª”æ¡ˆé–ç®¡ç†</td>
<td style="text-align: left;"><code>__init__</code> å–å¾—é–ï¼Œ<code>__del__</code> é‡‹æ”¾é–</td>
<td style="text-align: left;">ä¸­ï¼ˆéœ€ç¢ºä¿ç•°å¸¸æ™‚æ­£ç¢ºé‡‹æ”¾ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;">```</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</body>
</html>