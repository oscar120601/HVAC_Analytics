<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_System_Integration_v1.1</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v11-revised-system-integration-architecture">PRD v1.1-REVISED: ç³»çµ±æ•´åˆæ¶æ§‹ (System Integration Architecture)</h1>
<h1 id="feature-annotation-v12">æ•´åˆ Feature Annotation v1.2 è¦ç¯„ï¼ˆå·²æ¡ç´å¯©æŸ¥ä¿®æ­£ï¼‰</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.1-REVISED (Zero-Gap Pipeline with Feature Annotation v1.2)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/container.py</code>, <code>src/main.py</code>, <code>src/utils/config_loader.py</code>, <code>src/features/annotation_manager.py</code><br />
<strong>ç›¸ä¾æ¨¡çµ„:</strong> <br />
- Parser v2.1+, Cleaner v2.2+, BatchProcessor v1.3+, Feature Engineer v1.3+<br />
- <strong>Feature Annotation v1.2</strong> (Excel-Centric SSOT)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 5 ~ 6 å€‹å·¥ç¨‹å¤©ï¼ˆå« Feature Annotation æ•´åˆèˆ‡å…¨éˆè·¯æ¸¬è©¦ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆå“²å­¸</h2>
<h3 id="11">1.1 æ ¸å¿ƒç›®æ¨™</h3>
<p>å»ºç«‹<strong>é›¶é–“éš™å°æ¥</strong>çš„å®Œæ•´ ETL Pipelineï¼Œä¸¦æ•´åˆ Feature Annotation v1.2 çš„<strong>å–®å‘ç·¨è¼¯æµ</strong>ï¼š</p>
<ol>
<li><strong>é…ç½®å–®ä¸€çœŸç›¸æº (SSOT)</strong>: <br />
   - é‹è¡Œæ™‚é…ç½®ï¼š<code>ETLConfig</code> å¯¦ä¾‹<br />
   - ç‰¹å¾µå®šç¾©ï¼š<strong>Excel å”¯ä¸€ç·¨è¼¯</strong> â†’ YAML SSOT â†’ Pipeline æ¶ˆè²»</li>
<li><strong>ä¾è³´æ³¨å…¥ (DI)</strong>: é€é <code>Container</code> ç®¡ç†æ¨¡çµ„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…å« <code>FeatureAnnotationManager</code></li>
<li><strong>å¥‘ç´„æª¢æŸ¥é»</strong>: 6 å€‹é—œéµæª¢æŸ¥é»ï¼ˆæ–°å¢ Annotation åŒæ­¥æª¢æŸ¥ #5, #6ï¼‰</li>
<li><strong>éŒ¯èª¤å‚³æ’­éˆ</strong>: æ˜ç¢ºå®šç¾©éŒ¯èª¤å¦‚ä½•åœ¨æ¨¡çµ„é–“å‚³æ’­ï¼ˆæ–°å¢ E400 ç³»åˆ—éŒ¯èª¤ï¼‰</li>
<li><strong>å–®å‘æµä¿è­‰</strong>: ç¦æ­¢ Pipeline ç›´æ¥å¯«å…¥ YAMLï¼Œç¦æ­¢ Wizard ç¹é Excel</li>
</ol>
<h3 id="12">1.2 æ¶æ§‹æ¦‚è¦½ï¼ˆæ›´æ–°ï¼‰</h3>
<pre><code class="language-mermaid">graph TB
    subgraph &quot;Feature Annotation Layer (v1.2)&quot;
        FA1[Excel Template&lt;br/&gt;*.xlsx] --&gt;|ç·¨è¼¯| FA2[ç©ºèª¿æŠ€å¸«/å·¥ç¨‹å¸«]
        FA2 --&gt;|æ‰‹å‹•è§¸ç™¼| FA3[excel_to_yaml.py]
        FA3 --&gt;|é©—è­‰| FA4{æª¢æŸ¥é» #5&lt;br/&gt;Annotation Valid}
        FA4 --&gt;|ç”Ÿæˆ| FA5[config/features/sites/*.yaml&lt;br/&gt;SSOT]
        FA5 --&gt;|Git PR| FA6[Config Server]
    end

    subgraph &quot;Configuration Layer&quot;
        A[settings.yaml] --&gt; B[ConfigLoader]
        B --&gt; C[ETLConfig SSOT]
        FA6 --&gt;|è¼‰å…¥| C
    end

    subgraph &quot;Dependency Injection Container&quot;
        C --&gt; D[ETLContainer]
        D --&gt; E[ReportParser v2.1]
        D --&gt; F[DataCleaner v2.2]
        D --&gt; G[BatchOrchestrator v1.3]
        D --&gt; H[FeatureEngineer v1.3]
        D --&gt; I[FeatureAnnotationManager&lt;br/&gt;v1.2]
    end

    subgraph &quot;Pipeline Execution&quot;
        E --&gt;|Raw DF UTC| F
        F --&gt;|Clean DF&lt;br/&gt;èªæ„æ„ŸçŸ¥æ¸…æ´—| G
        G --&gt;|Parquet + Manifest&lt;br/&gt;å« annotation_checksum| H
        H --&gt;|Feature Matrix&lt;br/&gt;å¥—ç”¨ device_role &amp; Group Policy| J[Model Training]
    end

    subgraph &quot;Contract Checkpoints&quot;
        CP1{æª¢æŸ¥é» #1&lt;br/&gt;Parser Output}
        CP2{æª¢æŸ¥é» #2&lt;br/&gt;Cleaner Output}
        CP3{æª¢æŸ¥é» #3&lt;br/&gt;BatchProcessor Output}
        CP4{æª¢æŸ¥é» #4&lt;br/&gt;FE Input Schema}
        CP5{æª¢æŸ¥é» #5&lt;br/&gt;Excel/YAML Sync}
        CP6{æª¢æŸ¥é» #6&lt;br/&gt;Annotation Version}
    end

    E -.-&gt; CP1 -.-&gt; F
    F -.-&gt; CP2 -.-&gt; G
    G -.-&gt; CP3 -.-&gt; H
    H -.-&gt; CP4 -.-&gt; J
    FA1 -.-&gt; CP5 -.-&gt; FA3
    FA5 -.-&gt; CP6 -.-&gt; I

    style C fill:#f9f,stroke:#333,stroke-width:4px
    style D fill:#bbf,stroke:#333,stroke-width:4px
    style FA1 fill:#f9f,stroke:#f00,stroke-width:2px
    style FA5 fill:#bbf,stroke:#00f,stroke-width:2px
</code></pre>
<hr />
<h2 id="2-ssot-configuration-system">2. SSOT é…ç½®ç³»çµ± (Configuration System)</h2>
<h3 id="21-feature-annotation">2.1 çµ±ä¸€é…ç½®çµæ§‹ï¼ˆæ•´åˆ Feature Annotationï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/config_models.py</code> (æ ¸å¿ƒ SSOT)</p>
<p><strong>é—œéµæ›´æ–°</strong>:<br />
- æ–°å¢ <code>FeatureAnnotationConfig</code> è¨­å®š Annotation è·¯å¾‘èˆ‡ç‰ˆæœ¬æª¢æŸ¥<br />
- <code>ETLConfig</code> æ–°å¢ <code>feature_annotation</code> æ¬„ä½<br />
- <strong>ç§»é™¤ <code>CleanerConfig.default_device_role</code>ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šé¿å…éš±æ€§é è¨­å€¼ï¼‰</strong><br />
- <strong>æ–°å¢ <code>CleanerConfig.unannotated_column_policy</code>ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šæœªå®šç¾©æ¬„ä½è™•ç†ç­–ç•¥ï¼‰</strong></p>
<pre><code class="language-python">from typing import Final, List, Dict, Optional, Literal
from pydantic import BaseModel, validator, Field

# SSOT 1: Quality Flags (6å€‹æ¨™æº–å€¼ï¼Œå…¨åŸŸå”¯ä¸€)
VALID_QUALITY_FLAGS: Final[List[str]] = [
    &quot;FROZEN&quot;,           # æ•¸æ“šå‡çµï¼ˆé€£çºŒ3å€‹å€é–“å€¼ç›¸åŒï¼‰
    &quot;HEAT_IMBALANCE&quot;,   # ç†±å¹³è¡¡åå·® &gt; 5%
    &quot;AFFINITY_VIOLATION&quot;, # é•åè¦ªå’Œå¾‹ &gt; 15%
    &quot;OUTLIER&quot;,          # çµ±è¨ˆé›¢ç¾¤å€¼ï¼ˆIQRæ³•ï¼‰
    &quot;INSUFFICIENT_DATA&quot;, # æ™‚é–“ç©ºç¼ºè£œå…¨æ¨™è¨˜
    &quot;SENSOR_OFFLINE&quot;    # æ„Ÿæ¸¬å™¨é›¢ç·šï¼ˆæ–°å¢ï¼‰
]

# SSOT 2: æ™‚é–“æˆ³è¦ç¯„ (æ‰€æœ‰æ¨¡çµ„å¿…é ˆéµå®ˆ)
TIMESTAMP_CONFIG: Final[Dict] = {
    &quot;dtype&quot;: &quot;Datetime&quot;,
    &quot;time_unit&quot;: &quot;nanoseconds&quot;,  # ns
    &quot;time_zone&quot;: &quot;UTC&quot;,          # å¼·åˆ¶UTC
    &quot;parquet_physical_type&quot;: &quot;INT64&quot;  # ç¦æ­¢INT96
}

# SSOT 3: Feature Annotation ç›¸é—œå¸¸æ•¸ï¼ˆæ–°å¢ï¼‰
FEATURE_ANNOTATION_CONSTANTS: Final[Dict] = {
    &quot;current_template_version&quot;: &quot;1.2&quot;,
    &quot;expected_schema_version&quot;: &quot;1.2&quot;,
    &quot;checksum_algorithm&quot;: &quot;sha256&quot;
}

# SSOT 4: Feature Metadata Schemaï¼ˆæ›´æ–°ï¼šæ”¯æ´ device_roleï¼‰
class FeatureMetadata(BaseModel):
    column_name: str
    physical_type: Literal[
        &quot;temperature&quot;, &quot;flow_rate&quot;, &quot;power&quot;, &quot;status&quot;, 
        &quot;humidity&quot;, &quot;gauge&quot;, &quot;chiller_load&quot;, &quot;cooling_tower_load&quot;
    ]
    unit: Optional[str] = None           # &quot;LPM&quot;, &quot;kW&quot;, &quot;Â°C&quot;, &quot;%&quot;
    device_role: Literal[&quot;primary&quot;, &quot;backup&quot;, &quot;seasonal&quot;] = &quot;primary&quot;  # æ–°å¢
    is_target: bool = False              
    enable_lag: bool = True
    enable_rolling: bool = True
    agg_method: Literal[&quot;mean&quot;, &quot;sum&quot;, &quot;last&quot;, &quot;first&quot;] = &quot;mean&quot;
    ignore_warnings: List[str] = Field(default_factory=list)  # æ–°å¢ï¼š[&quot;W401&quot;, &quot;W403&quot;]

    @validator('enable_lag')
    def validate_target_no_lag(cls, v, values):
        &quot;&quot;&quot;E405: Target è®Šæ•¸ä¸å¯å•Ÿç”¨ Lag&quot;&quot;&quot;
        if values.get('is_target') and v:
            raise ValueError(&quot;E405: is_target=True æ™‚ enable_lag å¿…é ˆç‚º False&quot;)
        return v

# Parser é…ç½®
class ParserConfig(BaseModel):
    encoding: str = &quot;auto&quot;               
    header_scan_rows: int = 500
    assumed_timezone: str = &quot;Asia/Taipei&quot;  
    null_values: List[str] = Field(default_factory=lambda: [
        &quot;&quot;, &quot;NA&quot;, &quot;null&quot;, &quot;---&quot;, &quot;Error&quot;, &quot;N/A&quot;, &quot;OFF&quot;, &quot;OFFLINE&quot;, &quot;#VALUE!&quot;
    ])

# Cleaner é…ç½®ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šç§»é™¤ default_device_roleï¼Œé¿å…éš±æ€§é è¨­å€¼ï¼‰
class CleanerConfig(BaseModel):
    unit_system: Literal[&quot;METRIC&quot;, &quot;IMPERIAL&quot;] = &quot;METRIC&quot;
    resample_interval: str = &quot;15m&quot;       
    heat_balance_threshold: float = 0.05  
    frozen_data_intervals: int = 3
    enforce_output_contract: bool = True
    # å¯©æŸ¥ä¿®æ­£ï¼šç§»é™¤ default_device_roleï¼Œæ‰€æœ‰ device_role å¿…é ˆä¾†è‡ª Annotation
    use_device_role_from_annotation: bool = True
    # å¯©æŸ¥ä¿®æ­£ï¼šæ–°å¢æœªå®šç¾©æ¬„ä½è™•ç†ç­–ç•¥ï¼ˆstrict_mode ä¸‹æ‡‰ç‚º errorï¼‰
    unannotated_column_policy: Literal[&quot;error&quot;, &quot;skip&quot;, &quot;warn&quot;] = &quot;error&quot;

# BatchProcessor é…ç½®ï¼ˆæ›´æ–°ï¼šAnnotation ç‰ˆæœ¬å¯«å…¥ Manifestï¼‰
class BatchConfig(BaseModel):
    output_base_dir: str = &quot;data/processed&quot;
    staging_dir: str = &quot;data/.staging&quot;
    max_rows_per_file: int = 100_000
    compression: Literal[&quot;snappy&quot;, &quot;zstd&quot;] = &quot;snappy&quot;
    use_pyarrow: bool = False            
    future_data_tolerance_minutes: int = 5
    # æ–°å¢ï¼šå¼·åˆ¶æª¢æŸ¥ Annotation åŒæ­¥
    enforce_annotation_sync: bool = True

# Feature Engineer é…ç½®ï¼ˆæ›´æ–°ï¼šä½¿ç”¨ Group Policyï¼‰
class FeatureEngineeringConfig(BaseModel):
    execution_mode: Literal[&quot;in_memory&quot;] = &quot;in_memory&quot;
    cutoff_timestamp: Optional[str] = None  
    group_policies: List[Dict] = Field(default_factory=list)
    physics_features: bool = True
    time_features: bool = True
    # æ–°å¢ï¼šæ¶ˆè²» device_role èˆ‡ ignore_warnings
    respect_device_role: bool = True       # æŠ‘åˆ¶å‚™ç”¨è¨­å‚™çµ±è¨ˆèª¤å ±
    respect_ignore_warnings: bool = True   # æŠ‘åˆ¶ç‰¹å®šè­¦å‘Š

# Feature Annotation é…ç½®ï¼ˆæ–°å¢ï¼‰
class FeatureAnnotationConfig(BaseModel):
    &quot;&quot;&quot;Feature Annotation v1.2 è¨­å®š&quot;&quot;&quot;
    enabled: bool = True
    excel_base_dir: str = &quot;data/features&quot;           # ä½¿ç”¨è€…ç·¨è¼¯å€
    yaml_base_dir: str = &quot;config/features/sites&quot;    # SSOT è¼¸å‡º
    template_dir: str = &quot;tools/features/templates&quot;
    current_template_version: str = &quot;1.2&quot;
    # è‡ªå‹•åŒæ­¥æª¢æŸ¥
    auto_sync_check: bool = True
    # åš´æ ¼æ¨¡å¼ï¼šExcel/YAML ä¸åŒæ­¥æ™‚é˜»æ“‹ Pipeline
    strict_sync_check: bool = True

# çµ±ä¸€é…ç½®æ ¹ï¼ˆæ›´æ–°ï¼‰
class ETLConfig(BaseModel):
    &quot;&quot;&quot;ETL Pipeline çµ±ä¸€é…ç½® (SSOT ä¸­å¿ƒ)&quot;&quot;&quot;
    version: str = &quot;1.0&quot;
    site_id: str = &quot;default&quot;

    parser: ParserConfig = ParserConfig()
    cleaner: CleanerConfig = CleanerConfig()
    batch: BatchConfig = BatchConfig()
    feature: FeatureEngineeringConfig = FeatureEngineeringConfig()
    feature_annotation: FeatureAnnotationConfig = FeatureAnnotationConfig()  # æ–°å¢

    # å…¨åŸŸè¨­å®š
    log_level: str = &quot;INFO&quot;
    strict_mode: bool = True             

    @validator('version')
    def validate_version(cls, v):
        if v != &quot;1.0&quot;:
            raise ValueError(&quot;Config version must be 1.0&quot;)
        return v

    @validator('feature_annotation')
    def validate_annotation_paths(cls, v):
        &quot;&quot;&quot;ç¢ºä¿ Annotation ç›®éŒ„å­˜åœ¨&quot;&quot;&quot;
        from pathlib import Path
        for path_attr in ['excel_base_dir', 'yaml_base_dir']:
            path = Path(getattr(v, path_attr))
            path.mkdir(parents=True, exist_ok=True)
        return v
</code></pre>
<h3 id="22-configloader-feature-annotation">2.2 é…ç½®è¼‰å…¥å™¨ (ConfigLoader) - æ•´åˆ Feature Annotation</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/utils/config_loader.py</code></p>
<p><strong>é—œéµæ›´æ–°</strong>:<br />
- æ–°å¢ <code>load_feature_annotation()</code> æ–¹æ³•è¼‰å…¥ YAML SSOTï¼ˆæ³¨æ„ï¼šåƒ…è¼‰å…¥ï¼Œä¸è™•ç†ç¹¼æ‰¿ï¼Œç¹¼æ‰¿é‚è¼¯åœ¨ Manager è™•ç†ï¼‰<br />
- æ–°å¢ <code>validate_annotation_sync()</code> æª¢æŸ¥ Excel/YAML åŒæ­¥ç‹€æ…‹</p>
<pre><code class="language-python">import yaml
import hashlib
from pathlib import Path
from typing import Union, Dict, Optional
from src.etl.config_models import ETLConfig, VALID_QUALITY_FLAGS, FEATURE_ANNOTATION_CONSTANTS

class ConfigurationError(Exception):
    &quot;&quot;&quot;é…ç½®éŒ¯èª¤&quot;&quot;&quot;
    pass

class AnnotationSyncError(ConfigurationError):
    &quot;&quot;&quot;E406: Excel èˆ‡ YAML ä¸åŒæ­¥&quot;&quot;&quot;
    pass

class ConfigLoader:
    &quot;&quot;&quot;çµ±ä¸€é…ç½®è¼‰å…¥ï¼Œç¢ºä¿æ‰€æœ‰æ¨¡çµ„å¼•ç”¨ç›¸åŒ SSOT&quot;&quot;&quot;

    @staticmethod
    def load(config_path: Union[str, Path] = &quot;config/settings.yaml&quot;) -&gt; ETLConfig:
        &quot;&quot;&quot;è¼‰å…¥ä¸¦é©—è­‰ ETL ä¸»é…ç½®&quot;&quot;&quot;
        config_path = Path(config_path)

        if not config_path.exists():
            raise ConfigurationError(f&quot;é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_path}&quot;)

        with open(config_path, 'r', encoding='utf-8') as f:
            try:
                data = yaml.safe_load(f)
            except yaml.YAMLError as e:
                raise ConfigurationError(f&quot;YAML è§£æéŒ¯èª¤: {e}&quot;)

        # é©—è­‰ SSOT ä¸€è‡´æ€§
        code_flags = set(VALID_QUALITY_FLAGS)
        config_flags = set(data.get(&quot;custom_quality_flags&quot;, []))

        if config_flags and config_flags != code_flags:
            missing_base = code_flags - config_flags
            if missing_base:
                raise ConfigurationError(
                    f&quot;settings.yaml ä¸­çš„ flags ç¼ºå°‘ SSOT åŸºç¤æ¨™è¨˜: {missing_base}. &quot;
                    f&quot;ç¨‹å¼ç¢¼å®šç¾©: {code_flags}&quot;
                )

        # é©—è­‰ç›®éŒ„å­˜åœ¨æ€§æˆ–è‡ªå‹•å»ºç«‹
        for dir_key in [&quot;output_base_dir&quot;, &quot;staging_dir&quot;]:
            if dir_key in data.get(&quot;batch&quot;, {}):
                Path(data[&quot;batch&quot;][dir_key]).mkdir(parents=True, exist_ok=True)

        try:
            return ETLConfig(**data)
        except Exception as e:
            raise ConfigurationError(f&quot;é…ç½®é©—è­‰å¤±æ•—: {e}&quot;)

    @staticmethod
    def load_feature_annotation(site_id: str, yaml_base_dir: str = &quot;config/features/sites&quot;) -&gt; Dict:
        &quot;&quot;&quot;
        è¼‰å…¥ç‰¹å®šæ¡ˆå ´çš„ Feature Annotation YAML (åŸå§‹å…§å®¹ï¼Œæœªåˆä½µç¹¼æ‰¿)
        æ³¨æ„ï¼šç¹¼æ‰¿åˆä½µé‚è¼¯ç”± FeatureAnnotationManager è™•ç†

        æª¢æŸ¥é …ç›®:
        1. æª”æ¡ˆå­˜åœ¨æ€§
        2. schema_version ç›¸å®¹æ€§ï¼ˆåƒ…æª¢æŸ¥ï¼Œä¸åˆä½µï¼‰
        &quot;&quot;&quot;
        yaml_path = Path(yaml_base_dir) / f&quot;{site_id}.yaml&quot;

        if not yaml_path.exists():
            raise ConfigurationError(f&quot;E402: Feature Annotation æœªå®šç¾©: {yaml_path}&quot;)

        with open(yaml_path, 'r', encoding='utf-8') as f:
            annotation = yaml.safe_load(f)

        # æª¢æŸ¥ Schema ç‰ˆæœ¬ï¼ˆæª¢æŸ¥é» #6ï¼‰
        schema_ver = annotation.get('schema_version', 'unknown')
        expected_ver = FEATURE_ANNOTATION_CONSTANTS['expected_schema_version']
        if schema_ver != expected_ver:
            raise ConfigurationError(
                f&quot;E400: Annotation Schema ç‰ˆæœ¬ä¸ç¬¦ã€‚æœŸæœ›: {expected_ver}, å¯¦éš›: {schema_ver}. &quot;
                f&quot;è«‹åŸ·è¡Œ migrate_excel.py å‡ç´š&quot;
            )

        return annotation

    @staticmethod
    def validate_annotation_sync(site_id: str, excel_base_dir: str, yaml_base_dir: str) -&gt; dict:
        &quot;&quot;&quot;
        E406: æª¢æŸ¥ Excel èˆ‡ YAML æ˜¯å¦åŒæ­¥

        Returns:
            {
                'synced': bool,
                'excel_mtime': float,
                'yaml_mtime': float,
                'excel_checksum': str,
                'yaml_checksum': str,
                'reason': str
            }
        &quot;&quot;&quot;
        excel_path = Path(excel_base_dir) / site_id / f&quot;{site_id}.xlsx&quot;
        yaml_path = Path(yaml_base_dir) / f&quot;{site_id}.yaml&quot;

        if not excel_path.exists():
            return {'synced': False, 'reason': f'Excel ä¸å­˜åœ¨: {excel_path}'}
        if not yaml_path.exists():
            return {'synced': False, 'reason': f'YAML ä¸å­˜åœ¨: {yaml_path}'}

        # æ™‚é–“æˆ³æ¯”è¼ƒ
        excel_mtime = excel_path.stat().st_mtime
        yaml_mtime = yaml_path.stat().st_mtime

        if excel_mtime &gt; yaml_mtime:
            return {
                'synced': False,
                'excel_mtime': excel_mtime,
                'yaml_mtime': yaml_mtime,
                'reason': f'E406: Excel ({excel_path.name}) è¼ƒæ–°ï¼Œè«‹é‡æ–°åŸ·è¡Œ excel_to_yaml.py'
            }

        # Checksum æ¯”å°ï¼ˆè‹¥ YAML ä¸­æœ‰è¨˜éŒ„ï¼‰
        with open(yaml_path, 'r', encoding='utf-8') as f:
            yaml_content = yaml.safe_load(f)

        stored_checksum = yaml_content.get('meta', {}).get('excel_checksum', '')
        if stored_checksum:
            actual_checksum = ConfigLoader._compute_file_hash(excel_path)
            if stored_checksum != actual_checksum:
                return {
                    'synced': False,
                    'excel_checksum': actual_checksum,
                    'yaml_checksum': stored_checksum,
                    'reason': 'E406: Checksum ä¸ç¬¦ï¼ŒExcel å¯èƒ½å·²ä¿®æ”¹ä½†æœªé‡æ–°ç”Ÿæˆ YAML'
                }

        return {'synced': True, 'reason': 'åŒæ­¥'}

    @staticmethod
    def _compute_file_hash(file_path: Path) -&gt; str:
        &quot;&quot;&quot;è¨ˆç®—æª”æ¡ˆ SHA256&quot;&quot;&quot;
        sha256_hash = hashlib.sha256()
        with open(file_path, &quot;rb&quot;) as f:
            for byte_block in iter(lambda: f.read(4096), b&quot;&quot;):
                sha256_hash.update(byte_block)
        return f&quot;sha256:{sha256_hash.hexdigest()}&quot;

    @staticmethod
    def get_annotation_metadata(site_id: str, yaml_base_dir: str) -&gt; Dict:
        &quot;&quot;&quot;å–å¾— Annotation å…ƒè³‡æ–™ï¼ˆä¾› Manifest å¯«å…¥ï¼‰&quot;&quot;&quot;
        # æ³¨æ„ï¼šæ­¤è™•åƒ…è®€å–åŸå§‹æª”æ¡ˆçš„ metaï¼Œä¸è§¸ç™¼ç¹¼æ‰¿åˆä½µ
        annotation = ConfigLoader.load_feature_annotation(site_id, yaml_base_dir)
        return {
            'schema_version': annotation.get('schema_version'),
            'template_version': annotation.get('meta', {}).get('template_version'),
            'last_updated': annotation.get('meta', {}).get('last_updated'),
            'editor': annotation.get('meta', {}).get('editor'),
            'yaml_checksum': annotation.get('meta', {}).get('excel_checksum', '')
        }
</code></pre>
<hr />
<h2 id="3-di-container-featureannotationmanager">3. ä¾è³´æ³¨å…¥å®¹å™¨ (DI Container) - æ•´åˆ FeatureAnnotationManager</h2>
<h3 id="31-etlcontainer-cleaner">3.1 ETLContainer å¯¦ä½œï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šCleaner è·è²¬é‡æ¸…ï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/container.py</code></p>
<p><strong>é—œéµä¿®æ­£</strong>:<br />
- <strong>Cleaner ä¸å¯«å…¥ DataFrame metadata</strong>ï¼šæ”¹ç‚ºå‚³å…¥ <code>FeatureAnnotationManager</code> å¼•ç”¨ï¼Œä¾› Cleaner åœ¨æ¸…æ´—æ™‚æŸ¥è©¢ device_role èª¿æ•´ç­–ç•¥<br />
- <strong>Cleaner åƒ…è®€å– device_role ç”¨æ–¼èªæ„æ„ŸçŸ¥æ¸…æ´—</strong>ï¼šä¾‹å¦‚å‚™ç”¨è¨­å‚™æ”¾å¯¬å‡çµè³‡æ–™æª¢æ¸¬é–¾å€¼ï¼Œä½†ä¸å°‡ device_role å¯«å…¥è¼¸å‡º DataFrame çš„ç‰©ç†å„²å­˜ï¼ˆé¿å…è€¦åˆï¼‰</p>
<pre><code class="language-python">from typing import Optional, List, Dict
from pathlib import Path
import polars as pl

from src.etl.config_models import ETLConfig
from src.etl.parser import ReportParser
from src.etl.cleaner import DataCleaner
from src.etl.batch_processor import BatchOrchestrator, BatchResult
from src.etl.feature_engineer import FeatureEngineer
from src.features.annotation_manager import FeatureAnnotationManager  # æ–°å¢
from src.utils.config_loader import ConfigLoader, AnnotationSyncError
from src.utils.logger import get_logger

class ETLContainer:
    &quot;&quot;&quot;
    ä¾è³´æ³¨å…¥å®¹å™¨ (Dependency Injection Container) - v1.1-REVISED

    ç®¡ç†æ‰€æœ‰ ETL æ¨¡çµ„çš„ç”Ÿå‘½å‘¨æœŸèˆ‡é…ç½®å‚³éï¼Œç¢ºä¿:
    1. å–®ä¾‹æ¨¡å¼ (Singleton) 
    2. é…ç½®ä¸€è‡´æ€§ 
    3. Feature Annotation æ­£ç¢ºæµå‘å„æ¨¡çµ„ï¼ˆExcel â†’ YAML â†’ Manager â†’ Modulesï¼‰
    4. é›¶é–“éš™éŠœæ¥ 
    &quot;&quot;&quot;

    def __init__(self, config: ETLConfig):
        self.config = config
        self.logger = get_logger(&quot;ETLContainer&quot;)

        # å¿«å–å¯¦ä¾‹ (Singleton)
        self._parser: Optional[ReportParser] = None
        self._cleaner: Optional[DataCleaner] = None
        self._batch_processor: Optional[BatchOrchestrator] = None
        self._feature_engineer: Optional[FeatureEngineer] = None
        self._annotation_manager: Optional[FeatureAnnotationManager] = None  # æ–°å¢

        # é å…ˆè¼‰å…¥ Annotationï¼ˆè‹¥å•Ÿç”¨ï¼‰
        if self.config.feature_annotation.enabled:
            self._load_annotation()

    def _load_annotation(self):
        &quot;&quot;&quot;é å…ˆè¼‰å…¥ Feature Annotation ä¸¦é©—è­‰åŒæ­¥ç‹€æ…‹ï¼ˆå«ç¹¼æ‰¿åˆä½µï¼‰&quot;&quot;&quot;
        fa_config = self.config.feature_annotation

        # åš´æ ¼æ¨¡å¼ï¼šæª¢æŸ¥ Excel/YAML åŒæ­¥ï¼ˆæª¢æŸ¥é» #5ï¼‰
        if fa_config.auto_sync_check:
            sync_status = ConfigLoader.validate_annotation_sync(
                self.config.site_id,
                fa_config.excel_base_dir,
                fa_config.yaml_base_dir
            )

            if not sync_status['synced'] and fa_config.strict_sync_check:
                raise AnnotationSyncError(sync_status['reason'])
            elif not sync_status['synced']:
                self.logger.warning(f&quot;âš ï¸ Annotation åŒæ­¥è­¦å‘Š: {sync_status['reason']}&quot;)

        # åˆå§‹åŒ– Managerï¼ˆå…§éƒ¨è™•ç†ç¹¼æ‰¿åˆä½µï¼‰
        self._annotation_manager = FeatureAnnotationManager(
            site_id=self.config.site_id,
            yaml_base_dir=fa_config.yaml_base_dir
        )

        self.logger.info(
            f&quot;ğŸ“‹ Feature Annotation è¼‰å…¥æˆåŠŸ &quot;
            f&quot;(Schema: {self._annotation_manager.schema_version}, &quot;
            f&quot;Columns: {len(self._annotation_manager.columns)}, &quot;
            f&quot;Inherited: {self._annotation_manager.inheritance_chain})&quot;
        )

    def get_annotation_manager(self) -&gt; FeatureAnnotationManager:
        &quot;&quot;&quot;å–å¾— FeatureAnnotationManagerï¼ˆæª¢æŸ¥é» #6ï¼‰&quot;&quot;&quot;
        if self._annotation_manager is None:
            raise RuntimeError(&quot;FeatureAnnotationManager æœªåˆå§‹åŒ–ï¼Œè«‹ç¢ºèªé…ç½® enabled=True&quot;)
        return self._annotation_manager

    def get_parser(self) -&gt; ReportParser:
        &quot;&quot;&quot;å–å¾— Parser å¯¦ä¾‹&quot;&quot;&quot;
        if self._parser is None:
            self._parser = ReportParser(
                site_id=self.config.site_id,
                config=self.config.parser
            )
        return self._parser

    def get_cleaner(self) -&gt; DataCleaner:
        &quot;&quot;&quot;
        å–å¾— Cleaner å¯¦ä¾‹ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šæ³¨å…¥ Manager å¼•ç”¨ï¼Œä¸å¯«å…¥ metadataï¼‰

        Cleaner v2.2+ æœƒ:
        1. æŒæœ‰ AnnotationManager å¼•ç”¨ï¼Œç”¨æ–¼æŸ¥è©¢ device_roleï¼ˆä¸å¯«å…¥ DataFrameï¼‰
        2. æ ¹æ“š device_role èª¿æ•´æ¸…æ´—ç­–ç•¥ï¼ˆå¦‚ backup è¨­å‚™æ”¾å¯¬å‡çµæª¢æ¸¬ï¼‰
        3. å°æ–¼ unannotated æ¬„ä½ï¼Œä¾æ“š unannotated_column_policy è™•ç†ï¼ˆE402ï¼‰

        æ³¨æ„ï¼šdevice_role ä¸æœƒè¢«å¯«å…¥ Parquet metadataï¼Œåƒ…ç”¨æ–¼ runtime é‚è¼¯åˆ¤æ–·
        &quot;&quot;&quot;
        if self._cleaner is None:
            # å¯©æŸ¥ä¿®æ­£ï¼šå‚³å…¥ Manager å¼•ç”¨ï¼Œè€Œéåƒ…å‚³å…¥ columns dict
            # ä½¿ Cleaner å¯å‹•æ…‹æŸ¥è©¢ï¼Œä½†ä¸æ‰¿æ“” metadata å¯«å…¥è·è²¬
            self._cleaner = DataCleaner(
                config=self.config.cleaner,
                annotation_manager=self._annotation_manager if self.config.cleaner.use_device_role_from_annotation else None
            )
            self.logger.debug(&quot;åˆå§‹åŒ– DataCleaner (å« AnnotationManager å¼•ç”¨ï¼Œä¸å¯«å…¥ metadata)&quot;)
        return self._cleaner

    def get_batch_processor(self) -&gt; BatchOrchestrator:
        &quot;&quot;&quot;
        å–å¾— BatchProcessor å¯¦ä¾‹ï¼ˆæ›´æ–°ï¼šæ³¨å…¥ Annotation Metadataï¼‰

        BatchProcessor v1.3+ æœƒ:
        1. æ¥æ”¶ä¾†è‡ª Cleaner çš„è³‡æ–™ï¼ˆä¸å« device_role metadataï¼‰
        2. å°‡ Annotation Metadataï¼ˆversion, checksumï¼‰å¯«å…¥ Manifestï¼ˆä¾›ç¨½æ ¸ï¼‰
        3. åŸ·è¡Œ E406 æª¢æŸ¥ï¼ˆè‹¥ enforce_annotation_sync=Trueï¼‰
        &quot;&quot;&quot;
        if self._batch_processor is None:
            annotation_meta = {}
            if self._annotation_manager:
                annotation_meta = self._annotation_manager.get_metadata()

            self._batch_processor = BatchOrchestrator(
                config=self.config,
                parser=self.get_parser(),
                cleaner=self.get_cleaner(),
                annotation_metadata=annotation_meta  # æ³¨å…¥
            )
            self.logger.debug(&quot;åˆå§‹åŒ– BatchOrchestrator (å« Annotation Metadata)&quot;)
        return self._batch_processor

    def get_feature_engineer(self) -&gt; FeatureEngineer:
        &quot;&quot;&quot;
        å–å¾— FeatureEngineer å¯¦ä¾‹ï¼ˆæ›´æ–°ï¼šæ³¨å…¥ Group Policy èˆ‡ device_roleï¼‰

        Feature Engineer v1.3+ æœƒ:
        1. è®€å– Annotation ä¸­çš„ group_policies
        2. æ ¹æ“š device_role æ±ºå®šæ˜¯å¦æŠ‘åˆ¶ W403ï¼ˆå‚™ç”¨è¨­å‚™é«˜é›¶å€¼æ­£å¸¸ï¼‰
        3. æ ¹æ“š ignore_warnings éæ¿¾çµ±è¨ˆè­¦å‘Š
        &quot;&quot;&quot;
        if self._feature_engineer is None:
            group_policies = []
            column_configs = {}

            if self._annotation_manager:
                group_policies = self._annotation_manager.get_group_policies()
                column_configs = self._annotation_manager.get_column_configs()

            # åˆä½µé…ç½®ï¼šAnnotation å„ªå…ˆæ–¼ç¨‹å¼ç¢¼é…ç½®
            merged_config = self.config.feature.copy()
            merged_config.group_policies = group_policies or merged_config.group_policies

            self._feature_engineer = FeatureEngineer(
                config=merged_config,
                annotation_columns=column_configs  # æ³¨å…¥
            )
            self.logger.debug(&quot;åˆå§‹åŒ– FeatureEngineer (å« Group Policy)&quot;)
        return self._feature_engineer

    def run_full_pipeline(self, input_files: List[Path]) -&gt; pl.DataFrame:
        &quot;&quot;&quot;
        åŸ·è¡Œå®Œæ•´ ETL æµç¨‹ï¼ˆæ›´æ–°ï¼šå« Annotation æª¢æŸ¥é»ï¼‰

        æµç¨‹:
        1. æª¢æŸ¥ Annotation åŒæ­¥ç‹€æ…‹ï¼ˆæª¢æŸ¥é» #5ï¼‰
        2. BatchProcessor (Parser â†’ Cleaner â†’ Parquet + Manifest)
        3. Feature Engineer (Manifest â†’ Feature Matrixï¼Œå¥—ç”¨ device_role)

        éŒ¯èª¤è™•ç†:
        - AnnotationSyncError (E406): çµ‚æ­¢æµç¨‹
        - ContractViolationError: çµ‚æ­¢æµç¨‹
        - FutureDataError: å–®æª”æ¡ˆè·³é
        &quot;&quot;&quot;
        self.logger.info(f&quot;ğŸš€ å•Ÿå‹•å®Œæ•´ ETL Pipelineï¼Œè™•ç† {len(input_files)} å€‹æª”æ¡ˆ&quot;)

        # æª¢æŸ¥é» #5: Annotation åŒæ­¥
        if self.config.feature_annotation.enabled:
            self.logger.info(&quot;ğŸ” æª¢æŸ¥é» #5: Feature Annotation åŒæ­¥ç‹€æ…‹ - é€šé&quot;)

        # Step 1: Batch Processing
        bp = self.get_batch_processor()
        manifests = []

        for file_path in input_files:
            try:
                result = bp.process_single_file(file_path)

                if result.status == &quot;success&quot;:
                    manifests.append(result.manifest_path)
                    self.logger.info(f&quot;âœ… è™•ç†æˆåŠŸ: {file_path.name}&quot;)
                elif result.status == &quot;future_data_rejected&quot;:
                    self.logger.warning(f&quot;âš ï¸  æœªä¾†è³‡æ–™æ‹’çµ•: {file_path.name} - {result.error}&quot;)
                else:
                    self.logger.error(f&quot;âŒ è™•ç†å¤±æ•—: {file_path.name} - {result.error}&quot;)

            except ContractViolationError as e:
                self.logger.error(f&quot;âŒ æª¢æŸ¥é» #2/#3 å¥‘ç´„é•å: {file_path.name} - {e}&quot;)
                if self.config.strict_mode:
                    raise

        if not manifests:
            raise DataValidationError(&quot;æ²’æœ‰æˆåŠŸè™•ç†çš„æª”æ¡ˆï¼Œç„¡æ³•ç¹¼çºŒç‰¹å¾µå·¥ç¨‹&quot;)

        # Step 2: Feature Engineering
        fe = self.get_feature_engineer()
        manifest_path = manifests[-1]

        self.logger.info(f&quot;ğŸ”§ é–‹å§‹ç‰¹å¾µå·¥ç¨‹: {manifest_path}&quot;)

        # æª¢æŸ¥é» #6: Annotation Schema ç‰ˆæœ¬ç›¸å®¹
        self.logger.info(&quot;ğŸ” æª¢æŸ¥é» #6: Annotation Schema ç‰ˆæœ¬ - é€šé&quot;)

        # è®€å– Manifest èˆ‡è³‡æ–™
        df, metadata = fe.load_from_manifest(manifest_path)

        # æª¢æŸ¥é» #4: FE Input Schema é©—è­‰
        self.logger.info(&quot;ğŸ” æª¢æŸ¥é» #4: FE Input Schema - é©—è­‰ä¸­&quot;)

        # è½‰æ›ï¼ˆå« device_role èˆ‡ ignore_warnings è™•ç†ï¼‰
        feature_df = fe.transform(
            df,
            manifest_metadata=metadata,
            cutoff_timestamp=self.config.feature.cutoff_timestamp
        )

        self.logger.info(f&quot;âœ… ETL Pipeline å®Œæˆï¼Œè¼¸å‡ºç¶­åº¦: {feature_df.shape}&quot;)
        return feature_df

    def reset(self):
        &quot;&quot;&quot;é‡ç½®æ‰€æœ‰å¿«å–å¯¦ä¾‹&quot;&quot;&quot;
        self._parser = None
        self._cleaner = None
        self._batch_processor = None
        self._feature_engineer = None
        self._annotation_manager = None
        self.logger.debug(&quot;é‡ç½®æ‰€æœ‰æ¨¡çµ„å¯¦ä¾‹&quot;)
</code></pre>
<h3 id="32-featureannotationmanager-yaml">3.2 FeatureAnnotationManagerï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šæ–°å¢ YAML ç¹¼æ‰¿åˆä½µï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/features/annotation_manager.py</code></p>
<p><strong>å¯©æŸ¥ä¿®æ­£é‡é»</strong>:<br />
- <strong>å¯¦ä½œ <code>_load_with_inheritance()</code></strong>ï¼šæ”¯æ´ <code>inherit: base</code> çš„éè¿´è¼‰å…¥èˆ‡åˆä½µ<br />
- <strong>å¯¦ä½œ <code>_deep_merge()</code></strong>ï¼šæ·±åº¦åˆä½µå­—å…¸ï¼Œå­è¨­å®šè¦†è“‹çˆ¶è¨­å®š<br />
- <strong>å¾ªç’°ç¹¼æ‰¿æª¢æ¸¬</strong>ï¼šé˜²æ­¢ <code>inherit</code> å¾ªç’°å¼•ç”¨<br />
- <strong>ç¹¼æ‰¿éˆè¿½è¹¤</strong>ï¼šè¨˜éŒ„ç¹¼æ‰¿è·¯å¾‘ä¾›é™¤éŒ¯</p>
<pre><code class="language-python">from pathlib import Path
from typing import Dict, List, Optional, Any, Set
import yaml
from dataclasses import dataclass

@dataclass
class ColumnAnnotation:
    &quot;&quot;&quot;Column æ¨™è¨»è³‡æ–™çµæ§‹&quot;&quot;&quot;
    column_name: str
    physical_type: str
    unit: Optional[str]
    device_role: str = &quot;primary&quot;
    is_target: bool = False
    enable_lag: bool = True
    enable_rolling: bool = True
    lag_intervals: List[int] = None
    ignore_warnings: List[str] = None
    status: str = &quot;confirmed&quot;

    def __post_init__(self):
        if self.lag_intervals is None:
            self.lag_intervals = []
        if self.ignore_warnings is None:
            self.ignore_warnings = []

class FeatureAnnotationManager:
    &quot;&quot;&quot;
    Feature Annotation v1.2 ç®¡ç†å™¨ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šæ”¯æ´ç¹¼æ‰¿åˆä½µï¼‰

    è² è²¬:
    1. éè¿´è¼‰å…¥èˆ‡åˆä½µ YAML SSOTï¼ˆæ”¯æ´ inherit æ¬„ä½ï¼‰
    2. æä¾› column æŸ¥è©¢ï¼ˆå« device_role, ignore_warningsï¼‰
    3. æä¾› Group Policy æŸ¥è©¢ï¼ˆå·²åˆä½µçˆ¶è¨­å®šï¼‰
    4. æä¾› Metadataï¼ˆä¾› Manifest å¯«å…¥ï¼‰
    &quot;&quot;&quot;

    def __init__(self, site_id: str, yaml_base_dir: str):
        self.site_id = site_id
        self.yaml_base_dir = Path(yaml_base_dir)
        self.yaml_path = self.yaml_base_dir / f&quot;{site_id}.yaml&quot;
        self._data: Dict = None
        self._columns: Dict[str, ColumnAnnotation] = {}
        self._inheritance_chain: List[str] = []  # è¨˜éŒ„ç¹¼æ‰¿éˆ
        self._load()

    def _load(self):
        &quot;&quot;&quot;è¼‰å…¥ YAML ä¸¦è™•ç†ç¹¼æ‰¿åˆä½µï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šæ ¸å¿ƒé‚è¼¯ï¼‰&quot;&quot;&quot;
        self._data = self._load_with_inheritance(
            self.yaml_path, 
            visited=set()  # é˜²æ­¢å¾ªç’°ç¹¼æ‰¿
        )

        # è§£æåˆä½µå¾Œçš„ columns
        for col_name, col_data in self._data.get('columns', {}).items():
            self._columns[col_name] = ColumnAnnotation(
                column_name=col_name,
                physical_type=col_data.get('physical_type'),
                unit=col_data.get('unit'),
                device_role=col_data.get('device_role', 'primary'),
                is_target=col_data.get('is_target', False),
                enable_lag=col_data.get('enable_lag', True),
                enable_rolling=col_data.get('enable_rolling', True),
                lag_intervals=col_data.get('lag_intervals', []),
                ignore_warnings=col_data.get('ignore_warnings', []),
                status=col_data.get('status', 'confirmed')
            )

    def _load_with_inheritance(self, yaml_path: Path, visited: Set[Path]) -&gt; Dict:
        &quot;&quot;&quot;
        éè¿´è¼‰å…¥ YAML ä¸¦åˆä½µç¹¼æ‰¿ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šæ”¯æ´ inherit: baseï¼‰

        Args:
            yaml_path: ç•¶å‰ YAML æª”æ¡ˆè·¯å¾‘
            visited: å·²è¨ªå•è·¯å¾‘é›†åˆï¼ˆé˜²æ­¢å¾ªç’°ç¹¼æ‰¿ï¼‰

        Returns:
            åˆä½µå¾Œçš„å­—å…¸ï¼ˆå­è¨­å®šè¦†è“‹çˆ¶è¨­å®šï¼‰

        Raises:
            ConfigurationError: å¾ªç’°ç¹¼æ‰¿æˆ–çˆ¶æª”æ¡ˆä¸å­˜åœ¨
        &quot;&quot;&quot;
        yaml_path = Path(yaml_path)

        # å¾ªç’°ç¹¼æ‰¿æª¢æ¸¬
        if yaml_path in visited:
            chain = &quot; -&gt; &quot;.join([p.name for p in visited] + [yaml_path.name])
            raise ConfigurationError(f&quot;E400: å¾ªç’°ç¹¼æ‰¿æª¢æ¸¬: {chain}&quot;)

        if not yaml_path.exists():
            raise ConfigurationError(f&quot;E402: Annotation æª”æ¡ˆä¸å­˜åœ¨: {yaml_path}&quot;)

        visited.add(yaml_path)

        # è®€å–ç•¶å‰ YAML
        with open(yaml_path, 'r', encoding='utf-8') as f:
            current = yaml.safe_load(f) or {}

        # è¨˜éŒ„ç¹¼æ‰¿éˆï¼ˆåƒ…è¨˜éŒ„ site åç¨±ï¼‰
        self._inheritance_chain.append(yaml_path.stem)

        # è™•ç†ç¹¼æ‰¿
        parent_name = current.get('inherit')
        if parent_name and parent_name != &quot;none&quot;:
            # æ”¯æ´ç›¸å°è·¯å¾‘æˆ–çµ•å°è·¯å¾‘ï¼ˆé è¨­åŒç›®éŒ„ï¼‰
            parent_path = self.yaml_base_dir / f&quot;{parent_name}.yaml&quot;

            if not parent_path.exists():
                raise ConfigurationError(
                    f&quot;E402: ç¹¼æ‰¿çš„çˆ¶æª”æ¡ˆä¸å­˜åœ¨: {parent_name} &quot;
                    f&quot;(åƒè€ƒè‡ª: {yaml_path.name})&quot;
                )

            # éè¿´è¼‰å…¥çˆ¶è¨­å®š
            parent = self._load_with_inheritance(parent_path, visited.copy())

            # æ·±åº¦åˆä½µï¼šå­è¨­å®šè¦†è“‹çˆ¶è¨­å®š
            current = self._deep_merge(parent, current)

        return current

    def _deep_merge(self, base: Dict, override: Dict) -&gt; Dict:
        &quot;&quot;&quot;
        æ·±åº¦åˆä½µå­—å…¸ï¼ˆå¯©æŸ¥ä¿®æ­£ï¼šéè¿´åˆä½µé‚è¼¯ï¼‰

        è¦å‰‡:
        - override å„ªå…ˆæ–¼ base
        - è‹¥åŒç‚º dictï¼Œéè¿´åˆä½µ
        - è‹¥ç‚º listï¼ˆå¦‚ group_policiesï¼‰ï¼Œoverride å®Œå…¨æ›¿æ›ï¼ˆä¸ appendï¼‰
        - inherit æ¬„ä½ä¸å‚³éï¼ˆåƒ…ç”¨æ–¼ç•¶å‰æª”æ¡ˆï¼‰

        Args:
            base: çˆ¶è¨­å®š
            override: å­è¨­å®šï¼ˆå„ªå…ˆï¼‰

        Returns:
            åˆä½µå¾Œçš„å­—å…¸
        &quot;&quot;&quot;
        result = base.copy()

        for key, value in override.items():
            # inherit æ¬„ä½ä¸å‚³éåˆ°åˆä½µçµæœï¼ˆé¿å…å­«æª”æ¡ˆç¹¼æ‰¿éŒ¯èª¤çš„çˆ¶éŠï¼‰
            if key == 'inherit':
                continue

            if key in result and isinstance(result[key], dict) and isinstance(value, dict):
                # éè¿´åˆä½µï¼ˆå¦‚ columns, physical_typesï¼‰
                result[key] = self._deep_merge(result[key], value)
            else:
                # ç›´æ¥è¦†è“‹ï¼ˆåŒ…å« list, scalarï¼‰
                result[key] = value

        return result

    @property
    def schema_version(self) -&gt; str:
        return self._data.get('schema_version', 'unknown')

    @property
    def inheritance_chain(self) -&gt; str:
        &quot;&quot;&quot;è¿”å›ç¹¼æ‰¿éˆæè¿°ï¼ˆå¦‚ 'base -&gt; cgmh_ty'ï¼‰&quot;&quot;&quot;
        return &quot; -&gt; &quot;.join(self._inheritance_chain)

    def get_column_configs(self) -&gt; Dict[str, ColumnAnnotation]:
        &quot;&quot;&quot;å–å¾—æ‰€æœ‰ column è¨­å®šï¼ˆå·²åˆä½µç¹¼æ‰¿ï¼‰&quot;&quot;&quot;
        return self._columns

    def get_column_config(self, column_name: str) -&gt; Optional[ColumnAnnotation]:
        &quot;&quot;&quot;å–å¾—ç‰¹å®š column è¨­å®š&quot;&quot;&quot;
        return self._columns.get(column_name)

    def get_group_policies(self) -&gt; List[Dict]:
        &quot;&quot;&quot;å–å¾— Group Policiesï¼ˆå·²åˆä½µç¹¼æ‰¿ï¼‰&quot;&quot;&quot;
        return self._data.get('group_policies', {})

    def get_physical_types(self) -&gt; Dict:
        &quot;&quot;&quot;å–å¾— Physical Types å®šç¾©ï¼ˆå·²åˆä½µç¹¼æ‰¿ï¼‰&quot;&quot;&quot;
        return self._data.get('physical_types', {})

    def get_metadata(self) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;å–å¾— Metadataï¼ˆä¾› BatchProcessor å¯«å…¥ Manifestï¼‰&quot;&quot;&quot;
        return {
            'schema_version': self.schema_version,
            'template_version': self._data.get('meta', {}).get('template_version'),
            'last_updated': self._data.get('meta', {}).get('last_updated'),
            'editor': self._data.get('meta', {}).get('editor'),
            'yaml_checksum': self._data.get('meta', {}).get('excel_checksum', ''),
            'inheritance_chain': self.inheritance_chain  # æ–°å¢ï¼šè¨˜éŒ„ç¹¼æ‰¿éˆ
        }

    def should_ignore_warning(self, column_name: str, warning_code: str) -&gt; bool:
        &quot;&quot;&quot;æª¢æŸ¥ç‰¹å®šæ¬„ä½æ˜¯å¦æ‡‰å¿½ç•¥ç‰¹å®šè­¦å‘Šï¼ˆdevice_role æ„ŸçŸ¥ï¼‰&quot;&quot;&quot;
        col = self._columns.get(column_name)
        if not col:
            return False

        # æª¢æŸ¥æ˜ç¢ºæ¨™è¨˜çš„å¿½ç•¥
        if warning_code in (col.ignore_warnings or []):
            return True

        # è¨­å‚™è§’è‰²é è¨­è¡Œç‚ºï¼ˆå¯©æŸ¥ç¢ºèªï¼šbackup/seasonal å…è¨±é«˜é›¶å€¼ï¼‰
        if warning_code == 'W403' and col.device_role in ['backup', 'seasonal']:
            return True

        return False

    def is_column_annotated(self, column_name: str) -&gt; bool:
        &quot;&quot;&quot;æª¢æŸ¥æ¬„ä½æ˜¯å¦å·²å®šç¾©ï¼ˆç”¨æ–¼ Cleaner çš„ E402 æª¢æŸ¥ï¼‰&quot;&quot;&quot;
        return column_name in self._columns
</code></pre>
<hr />
<h2 id="4-cli-entry-point-feature-annotation">4. CLI å…¥å£é» (Entry Point) - æ•´åˆ Feature Annotation æŒ‡ä»¤</h2>
<h3 id="41-hvaccli">4.1 HVACCLI å¯¦ä½œï¼ˆæ›´æ–°ï¼‰</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/main.py</code></p>
<p><strong>é—œéµæ›´æ–°</strong>:<br />
- æ–°å¢ <code>features</code> å­å‘½ä»¤ç¾¤çµ„<br />
- æ–°å¢ <code>wizard</code> æŒ‡ä»¤ï¼ˆåƒ…æ›´æ–° Excelï¼Œä¸ç›´å¯« YAMLï¼‰<br />
- æ–°å¢ <code>validate-annotation</code> æŒ‡ä»¤ï¼ˆåŸ·è¡Œ E400-E406 æª¢æŸ¥ï¼Œå«ç¹¼æ‰¿é©—è­‰ï¼‰<br />
- æ–°å¢ <code>sync-check</code> æŒ‡ä»¤ï¼ˆæª¢æŸ¥ Excel/YAML åŒæ­¥ï¼‰<br />
- æ–°å¢ <code>migrate-excel</code> æŒ‡ä»¤ï¼ˆv1.1â†’v1.2 å‡ç´šï¼‰<br />
- <code>run_etl</code> æŒ‡ä»¤è‡ªå‹•æª¢æŸ¥ Annotation åŒæ­¥ï¼ˆE406ï¼‰</p>
<pre><code class="language-python">#!/usr/bin/env python3
import sys
from pathlib import Path
from typing import List, Optional
import fire

from src.container import ETLContainer
from src.utils.config_loader import ConfigLoader, ConfigurationError, AnnotationSyncError
from src.etl.exceptions import ContractViolationError, FutureDataError, DataValidationError

class HVACCLI:
    &quot;&quot;&quot;
    HVAC Analytics CLI ä»‹é¢ - v1.1-REVISED

    æä¾›çµ±ä¸€çš„å‘½ä»¤åˆ—å…¥å£ï¼Œæ•´åˆ ETLã€å»ºæ¨¡èˆ‡ Feature Annotation ç®¡ç†ã€‚
    &quot;&quot;&quot;

    def __init__(self, config_path: str = &quot;config/settings.yaml&quot;):
        try:
            self.config = ConfigLoader.load(config_path)
            # åˆå§‹åŒ– Containerï¼ˆæœƒè‡ªå‹•æª¢æŸ¥ Annotation åŒæ­¥èˆ‡ç¹¼æ‰¿ï¼‰
            self.container = ETLContainer(self.config)
        except ConfigurationError as e:
            print(f&quot;âŒ é…ç½®éŒ¯èª¤: {e}&quot;)
            sys.exit(1)
        except AnnotationSyncError as e:
            print(f&quot;âŒ E406 åŒæ­¥éŒ¯èª¤: {e}&quot;)
            print(&quot;ğŸ’¡ è«‹åŸ·è¡Œ: python main.py features validate-annotation&quot;)
            sys.exit(6)

    def run_etl(self, input_dir: str, output_dir: Optional[str] = None, pattern: str = &quot;*.csv&quot;):
        &quot;&quot;&quot;
        åŸ·è¡Œå®Œæ•´ ETL æµç¨‹ï¼ˆå« Annotation åŒæ­¥èˆ‡ç¹¼æ‰¿è‡ªå‹•æª¢æŸ¥ï¼‰

        Args:
            input_dir: è¼¸å…¥ CSV æª”æ¡ˆç›®éŒ„
            output_dir: è¼¸å‡ºç›®éŒ„ (å¯é¸)
            pattern: æª”æ¡ˆåŒ¹é…æ¨¡å¼
        &quot;&quot;&quot;
        input_path = Path(input_dir)
        if not input_path.exists():
            print(f&quot;âŒ è¼¸å…¥ç›®éŒ„ä¸å­˜åœ¨: {input_dir}&quot;)
            return

        files = list(input_path.glob(pattern))
        if not files:
            print(f&quot;âš ï¸  æœªæ‰¾åˆ°åŒ¹é…æª”æ¡ˆ: {pattern}&quot;)
            return

        print(f&quot;ğŸš€ å•Ÿå‹• ETL Pipelineï¼Œè™•ç† {len(files)} å€‹æª”æ¡ˆ...&quot;)

        # é¡¯ç¤º Annotation è³‡è¨Šï¼ˆå«ç¹¼æ‰¿éˆï¼‰
        manager = self.container.get_annotation_manager()
        print(f&quot;ğŸ“‹ Feature Annotation: Schema v{manager.schema_version}&quot;)
        print(f&quot;   ç¹¼æ‰¿éˆ: {manager.inheritance_chain}&quot;)

        try:
            result_df = self.container.run_full_pipeline(files)

            if output_dir:
                output_path = Path(output_dir)
                output_path.mkdir(parents=True, exist_ok=True)
                output_file = output_path / &quot;feature_matrix.parquet&quot;
                result_df.write_parquet(output_file)
                print(f&quot;ğŸ’¾ ç‰¹å¾µçŸ©é™£å·²å„²å­˜: {output_file}&quot;)

            print(f&quot;âœ… ETL å®Œæˆï¼Œè¼¸å‡ºç¶­åº¦: {result_df.shape}&quot;)

        except AnnotationSyncError as e:
            print(f&quot;âŒ E406 Annotation åŒæ­¥éŒ¯èª¤: {e}&quot;)
            print(&quot;è«‹å…ˆåŸ·è¡Œ: python main.py features validate-annotation&quot;)
            sys.exit(6)

        except ContractViolationError as e:
            print(f&quot;âŒ å¥‘ç´„é•åéŒ¯èª¤: {e}&quot;)
            sys.exit(2)

        except FutureDataError as e:
            print(f&quot;âš ï¸  æœªä¾†è³‡æ–™éŒ¯èª¤: {e}&quot;)
            sys.exit(3)

        except Exception as e:
            print(f&quot;âŒ æœªé æœŸéŒ¯èª¤: {e}&quot;)
            import traceback
            traceback.print_exc()
            sys.exit(99)

    # ==================== Feature Annotation å­å‘½ä»¤ç¾¤çµ„ ====================

    class FeaturesCLI:
        &quot;&quot;&quot;Feature Annotation v1.2 ç®¡ç†æŒ‡ä»¤&quot;&quot;&quot;

        def __init__(self, parent):
            self.parent = parent
            self.config = parent.config.feature_annotation

        def wizard(self, site: Optional[str] = None, from_csv: Optional[str] = None):
            &quot;&quot;&quot;
            å•Ÿå‹•äº’å‹•å¼æ¨™è¨» Wizardï¼ˆåƒ…æ›´æ–° Excelï¼Œä¸ç›´å¯« YAMLï¼‰

            Usage:
                python main.py features wizard --site cgmh_ty --from-csv data/raw.csv

            æµç¨‹:
            1. åµæ¸¬ CSV æ–°æ¬„ä½
            2. äº’å‹•å¼ç¢ºèªç‰©ç†é¡å‹/å–®ä½
            3. å¯«å…¥ Excelï¼ˆæ¨™è¨˜ pending_reviewï¼‰
            4. æç¤ºä½¿ç”¨è€…æ‰‹å‹•åŸ·è¡Œ excel_to_yaml.py
            &quot;&quot;&quot;
            site = site or self.parent.config.site_id
            csv_path = Path(from_csv) if from_csv else None

            print(f&quot;ğŸ”§ å•Ÿå‹• Feature Annotation Wizard (v1.2)&quot;)
            print(f&quot;ğŸ“ Site: {site}&quot;)
            print(f&quot;âš ï¸  æ³¨æ„ï¼šWizard åƒ…æ›´æ–° Excelï¼Œä¸ç›´æ¥ä¿®æ”¹ YAML&quot;)

            from src.features.wizard import FeatureWizard

            wizard = FeatureWizard(
                site_id=site,
                excel_base_dir=self.config.excel_base_dir,
                template_version=self.config.current_template_version
            )

            try:
                excel_path = wizard.run(csv_path=csv_path)
                print(f&quot;\nâœ… Excel å·²æ›´æ–°: {excel_path}&quot;)
                print(&quot;âš ï¸  é‡è¦ï¼šè«‹é–‹å•Ÿ Excel ç¢ºèªæ¨™è¨»ï¼Œç¢ºèªå¾ŒåŸ·è¡Œï¼š&quot;)
                print(f&quot;   python tools/features/excel_to_yaml.py --input {excel_path} --output config/features/sites/{site}.yaml&quot;)
                print(f&quot;\n   æˆ–åŸ·è¡Œ: python main.py features validate-annotation --site {site}&quot;)
            except Exception as e:
                print(f&quot;âŒ Wizard å¤±æ•—: {e}&quot;)
                sys.exit(1)

        def validate_annotation(self, site: Optional[str] = None, strict: bool = False):
            &quot;&quot;&quot;
            é©—è­‰ Annotation ä¸¦ç”Ÿæˆ YAMLï¼ˆåŸ·è¡Œ E400-E406 æª¢æŸ¥ï¼Œå«ç¹¼æ‰¿é©—è­‰ï¼‰

            Checks:
            - E400: Template ç‰ˆæœ¬ç›¸å®¹æ€§ã€å¾ªç’°ç¹¼æ‰¿æª¢æ¸¬
            - E401: å­¤å…’æ¬„ä½ï¼ˆæ¨™è¨»å­˜åœ¨ä½† CSV ä¸å­˜åœ¨ï¼‰
            - E402: æœªå®šç¾©æ¬„ä½ï¼ˆCSV å­˜åœ¨ä½†æ¨™è¨»ä¸å­˜åœ¨ï¼‰
            - E403: å–®ä½èˆ‡ç‰©ç†é¡å‹ä¸åŒ¹é…
            - E404: Lag æ ¼å¼éŒ¯èª¤
            - E405: Target Leakage Risk
            - E406: Excel/YAML ä¸åŒæ­¥
            &quot;&quot;&quot;
            site = site or self.parent.config.site_id
            excel_path = Path(self.config.excel_base_dir) / site / f&quot;{site}.xlsx&quot;
            yaml_path = Path(self.config.yaml_base_dir) / f&quot;{site}.yaml&quot;

            print(f&quot;ğŸ” é©—è­‰ Feature Annotation: {site}&quot;)
            print(f&quot;   Excel: {excel_path}&quot;)
            print(f&quot;   YAML:  {yaml_path}&quot;)

            # æª¢æŸ¥ E406 åŒæ­¥ç‹€æ…‹
            sync_status = ConfigLoader.validate_annotation_sync(
                site, self.config.excel_base_dir, self.config.yaml_base_dir
            )

            if not sync_status['synced']:
                print(f&quot;âš ï¸  {sync_status['reason']}&quot;)
                if strict:
                    sys.exit(6)
            else:
                print(&quot;âœ… E406: Excel/YAML åŒæ­¥æª¢æŸ¥ - é€šé&quot;)

            # åŸ·è¡Œè½‰æ›èˆ‡é©—è­‰ï¼ˆå«ç¹¼æ‰¿åˆä½µæ¸¬è©¦ï¼‰
            try:
                from tools.features.excel_to_yaml import convert_excel_to_yaml
                result = convert_excel_to_yaml(
                    excel_path=excel_path,
                    output_path=yaml_path,
                    validate_only=False
                )

                # æ¸¬è©¦ç¹¼æ‰¿è¼‰å…¥
                from src.features.annotation_manager import FeatureAnnotationManager
                test_manager = FeatureAnnotationManager(
                    site_id=site,
                    yaml_base_dir=self.config.yaml_base_dir
                )

                print(f&quot;\nâœ… é©—è­‰é€šéï¼ŒYAML å·²ç”Ÿæˆ: {yaml_path}&quot;)
                print(f&quot;   Schema Version: {result.get('schema_version')}&quot;)
                print(f&quot;   ç¹¼æ‰¿éˆ: {test_manager.inheritance_chain}&quot;)
                print(f&quot;   Columns: {len(test_manager.get_column_configs())}&quot;)
                print(f&quot;   Warnings: {len(result.get('warnings', []))}&quot;)

                for w in result.get('warnings', []):
                    print(f&quot;   âš ï¸  {w}&quot;)

            except Exception as e:
                print(f&quot;âŒ é©—è­‰å¤±æ•—: {e}&quot;)
                sys.exit(1)

        def sync_check(self, site: Optional[str] = None):
            &quot;&quot;&quot;æª¢æŸ¥ Excel èˆ‡ YAML åŒæ­¥ç‹€æ…‹ï¼ˆE406 è¨ºæ–·ï¼‰&quot;&quot;&quot;
            site = site or self.parent.config.site_id
            status = ConfigLoader.validate_annotation_sync(
                site, self.config.excel_base_dir, self.config.yaml_base_dir
            )

            print(f&quot;ğŸ“Š åŒæ­¥ç‹€æ…‹æª¢æŸ¥: {site}&quot;)
            print(f&quot;   åŒæ­¥ç‹€æ…‹: {'âœ… åŒæ­¥' if status['synced'] else 'âŒ ä¸åŒæ­¥'}&quot;)
            print(f&quot;   è©³æƒ…: {status['reason']}&quot;)

            if 'excel_mtime' in status:
                from datetime import datetime
                excel_time = datetime.fromtimestamp(status['excel_mtime'])
                yaml_time = datetime.fromtimestamp(status['yaml_mtime'])
                print(f&quot;   Excel ä¿®æ”¹æ™‚é–“: {excel_time}&quot;)
                print(f&quot;   YAML ä¿®æ”¹æ™‚é–“:  {yaml_time}&quot;)

        def migrate_excel(self, site: str, from_version: str = &quot;1.1&quot;, to_version: str = &quot;1.2&quot;):
            &quot;&quot;&quot;
            å‡ç´š Excel ç¯„æœ¬ç‰ˆæœ¬ï¼ˆv1.1 â†’ v1.2ï¼‰

            è™•ç†ï¼š
            - æ–°å¢ device_role æ¬„ä½ï¼ˆé è¨­ primaryï¼‰
            - æ–°å¢ ignore_warnings æ¬„ä½
            - æ›´æ–° System sheet ç‰ˆæœ¬è™Ÿ
            &quot;&quot;&quot;
            excel_path = Path(self.config.excel_base_dir) / site / f&quot;{site}.xlsx&quot;

            print(f&quot;ğŸ”„ å‡ç´š Excel ç¯„æœ¬: {site}&quot;)
            print(f&quot;   è·¯å¾‘: {excel_path}&quot;)
            print(f&quot;   ç‰ˆæœ¬: {from_version} â†’ {to_version}&quot;)

            from src.features.migrate_tool import ExcelMigrator
            migrator = ExcelMigrator()

            try:
                migrator.migrate(
                    excel_path=excel_path,
                    from_version=from_version,
                    to_version=to_version
                )
                print(f&quot;âœ… å‡ç´šå®Œæˆï¼Œè«‹ç¢ºèªå¾ŒåŸ·è¡Œ validate-annotation&quot;)
            except Exception as e:
                print(f&quot;âŒ å‡ç´šå¤±æ•—: {e}&quot;)
                sys.exit(1)

        def show_annotation(self, site: Optional[str] = None):
            &quot;&quot;&quot;é¡¯ç¤ºç•¶å‰ Annotation æ‘˜è¦ï¼ˆå«ç¹¼æ‰¿è³‡è¨Šï¼‰&quot;&quot;&quot;
            site = site or self.parent.config.site_id

            # å¼·åˆ¶é‡æ–°è¼‰å…¥ä»¥é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
            from src.features.annotation_manager import FeatureAnnotationManager
            manager = FeatureAnnotationManager(
                site_id=site,
                yaml_base_dir=self.config.yaml_base_dir
            )

            print(f&quot;ğŸ“‹ Feature Annotation æ‘˜è¦: {site}&quot;)
            print(f&quot;   Schema Version: {manager.schema_version}&quot;)
            print(f&quot;   ç¹¼æ‰¿éˆ: {manager.inheritance_chain}&quot;)
            print(f&quot;\n   Columns ({len(manager._columns)}):&quot;)

            for name, col in manager._columns.items():
                role_tag = f&quot;[{col.device_role.upper()}]&quot; if col.device_role != &quot;primary&quot; else &quot;&quot;
                target_tag = &quot;[TARGET]&quot; if col.is_target else &quot;&quot;
                inherit_mark = &quot;&quot;
                print(f&quot;   - {name:20} {col.physical_type:12} {role_tag} {target_tag} {inherit_mark}&quot;)
                if col.ignore_warnings:
                    print(f&quot;                        å¿½ç•¥è­¦å‘Š: {', '.join(col.ignore_warnings)}&quot;)

    def features(self):
        &quot;&quot;&quot;Feature Annotation ç®¡ç†æŒ‡ä»¤ç¾¤çµ„&quot;&quot;&quot;
        return self.FeaturesCLI(self)

    # ==================== åŸæœ‰æŒ‡ä»¤ ====================

    def validate_config(self):
        &quot;&quot;&quot;é©—è­‰ç•¶å‰é…ç½®ï¼ˆå« Feature Annotation èˆ‡ç¹¼æ‰¿ï¼‰&quot;&quot;&quot;
        print(&quot;âœ… é…ç½®è¼‰å…¥æˆåŠŸ&quot;)
        print(f&quot;   Site ID: {self.config.site_id}&quot;)
        print(f&quot;   Flags: {VALID_QUALITY_FLAGS}&quot;)
        print(f&quot;   Strict Mode: {self.config.strict_mode}&quot;)

        if self.config.feature_annotation.enabled:
            from src.features.annotation_manager import FeatureAnnotationManager
            manager = FeatureAnnotationManager(
                site_id=self.config.site_id,
                yaml_base_dir=self.config.feature_annotation.yaml_base_dir
            )
            print(f&quot;\nğŸ“‹ Feature Annotation:&quot;)
            print(f&quot;   Enabled: True&quot;)
            print(f&quot;   Schema Version: {manager.schema_version}&quot;)
            print(f&quot;   ç¹¼æ‰¿éˆ: {manager.inheritance_chain}&quot;)
            print(f&quot;   Template Version: {self.config.feature_annotation.current_template_version}&quot;)
            print(f&quot;   Columns Defined: {len(manager.get_column_configs())}&quot;)

    def version(self):
        &quot;&quot;&quot;é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š&quot;&quot;&quot;
        print(&quot;HVAC Analytics Pipeline v1.1-REVISED&quot;)
        print(&quot;ç›¸å®¹æ¨¡çµ„ç‰ˆæœ¬:&quot;)
        print(&quot;  - Parser: v2.1+&quot;)
        print(&quot;  - Cleaner: v2.2+ (device_role æ„ŸçŸ¥ï¼Œä¸å¯«å…¥ metadata)&quot;)
        print(&quot;  - BatchProcessor: v1.3+ (Annotation checksum)&quot;)
        print(&quot;  - FeatureEngineer: v1.3+ (Group Policy æ”¯æ´)&quot;)
        print(&quot;  - FeatureAnnotation: v1.2 (Excel-Centric + ç¹¼æ‰¿åˆä½µ)&quot;)

def main():
    &quot;&quot;&quot;Entry point&quot;&quot;&quot;
    fire.Fire(HVACCLI)

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<hr />
<h2 id="5-error-handling-">5. éŒ¯èª¤è™•ç†èˆ‡å‚³æ’­ (Error Handling) - æ›´æ–°</h2>
<h3 id="51-feature-annotation-v12">5.1 éŒ¯èª¤å‚³æ’­ç­–ç•¥ï¼ˆæ•´åˆ Feature Annotation v1.2ï¼‰</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤é¡å‹</th>
<th style="text-align: center;">ä»£ç¢¼</th>
<th style="text-align: left;">ç™¼ç”Ÿæ¨¡çµ„</th>
<th style="text-align: center;">å‚³æ’­ç­–ç•¥</th>
<th style="text-align: left;">ä¸‹æ¸¸å½±éŸ¿</th>
<th style="text-align: left;">ä½¿ç”¨è€…è¨Šæ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>EncodingError</code></td>
<td style="text-align: center;">E001</td>
<td style="text-align: left;">Parser</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">æ•´æ‰¹å¤±æ•—</td>
<td style="text-align: left;">"æª”æ¡ˆç·¨ç¢¼éŒ¯èª¤"</td>
</tr>
<tr>
<td style="text-align: left;"><code>ContractViolationError</code></td>
<td style="text-align: center;">E002-E003</td>
<td style="text-align: left;">Parser/Cleaner/BP/FE</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ä¾ strict_mode</td>
<td style="text-align: left;">"æ¨¡çµ„é–“ä»‹é¢å¥‘ç´„é•å"</td>
</tr>
<tr>
<td style="text-align: left;"><code>FutureDataError</code></td>
<td style="text-align: center;">E005</td>
<td style="text-align: left;">BatchProcessor</td>
<td style="text-align: center;"><strong>å–®æª”è·³é</strong></td>
<td style="text-align: left;">è©²æª”æ¡ˆä¸å…¥åº«</td>
<td style="text-align: left;">"æª”æ¡ˆå«æœªä¾†è³‡æ–™"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TEMPLATE_VERSION_MISMATCH</strong></td>
<td style="text-align: center;"><strong>E400</strong></td>
<td style="text-align: left;">ConfigLoader/FE</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">éœ€å‡ç´š Excel</td>
<td style="text-align: left;">"ç¯„æœ¬ç‰ˆæœ¬éèˆŠï¼Œè«‹åŸ·è¡Œ migrate_excel.py"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ORPHAN_COLUMN</strong></td>
<td style="text-align: center;"><strong>E401</strong></td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">è¨˜éŒ„æ—¥èªŒ</td>
<td style="text-align: left;">"æ¨™è¨»æ¬„ä½ä¸å­˜åœ¨æ–¼è³‡æ–™"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UNANNOTATED_COLUMN</strong></td>
<td style="text-align: center;"><strong>E402</strong></td>
<td style="text-align: left;">ConfigLoader/Cleaner</td>
<td style="text-align: center;"><strong>çµ‚æ­¢/è­¦å‘Š</strong></td>
<td style="text-align: left;">ä¾ unannotated_column_policy</td>
<td style="text-align: left;">"è³‡æ–™æ¬„ä½æœªå®šç¾©ï¼Œè«‹åŸ·è¡Œ features wizard"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UNIT_INCOMPATIBLE</strong></td>
<td style="text-align: center;"><strong>E403</strong></td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">è¿”å› Excel ä¿®æ­£</td>
<td style="text-align: left;">"å–®ä½èˆ‡ç‰©ç†é¡å‹ä¸åŒ¹é…"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>LAG_FORMAT_INVALID</strong></td>
<td style="text-align: center;"><strong>E404</strong></td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">è¿”å›ä¿®æ­£</td>
<td style="text-align: left;">"Lag é–“éš”æ ¼å¼éŒ¯èª¤"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TARGET_LEAKAGE_RISK</strong></td>
<td style="text-align: center;"><strong>E405</strong></td>
<td style="text-align: left;">Pydantic Validation</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">è‡ªå‹•æ””æˆª</td>
<td style="text-align: left;">"is_target=True ä½† enable_lag=True"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>EXCEL_YAML_OUT_OF_SYNC</strong></td>
<td style="text-align: center;"><strong>E406</strong></td>
<td style="text-align: left;">ConfigLoader/Container</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">åŸ·è¡Œ validate-annotation</td>
<td style="text-align: left;">"Excel è¼ƒæ–°ï¼Œè«‹é‡æ–°ç”Ÿæˆ YAML"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CIRCULAR_INHERITANCE</strong></td>
<td style="text-align: center;"><strong>E407</strong></td>
<td style="text-align: left;">FeatureAnnotationManager</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">ä¿®æ­£ inherit æ¬„ä½</td>
<td style="text-align: left;">"å¾ªç’°ç¹¼æ‰¿æª¢æ¸¬"</td>
</tr>
<tr>
<td style="text-align: left;"><code>MetadataLossWarning</code></td>
<td style="text-align: center;">E203/E304</td>
<td style="text-align: left;">BatchProcessor/FE</td>
<td style="text-align: center;"><strong>Warning</strong></td>
<td style="text-align: left;">ä½¿ç”¨ä¿å®ˆé è¨­</td>
<td style="text-align: left;">"ç¼ºå°‘ metadata"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MEAN_OUT_OF_RANGE</strong></td>
<td style="text-align: center;"><strong>W401</strong></td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">æ¨™è¨˜ pending_review</td>
<td style="text-align: left;">"å¹³å‡å€¼è¶…å‡ºé æœŸç¯„åœ"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>LOW_VARIANCE</strong></td>
<td style="text-align: center;"><strong>W402</strong></td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">æª¢æŸ¥å‡çµè³‡æ–™</td>
<td style="text-align: left;">"æ¨™æº–å·®æ¥è¿‘é›¶"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>HIGH_ZERO_RATIO</strong></td>
<td style="text-align: center;"><strong>W403</strong></td>
<td style="text-align: left;">excel_to_yaml</td>
<td style="text-align: center;">Warning/å¿½ç•¥</td>
<td style="text-align: left;">å‚™ç”¨è¨­å‚™è‡ªå‹•æŠ‘åˆ¶</td>
<td style="text-align: left;">"é›¶å€¼æ¯”ä¾‹éé«˜"</td>
</tr>
</tbody>
</table>
<h3 id="52">5.2 å…¨åŸŸéŒ¯èª¤è™•ç†å™¨ï¼ˆæ›´æ–°ï¼‰</h3>
<pre><code class="language-python"># src/exceptions.py

class HVACError(Exception):
    &quot;&quot;&quot;åŸºç¤éŒ¯èª¤é¡åˆ¥&quot;&quot;&quot;
    def __init__(self, message: str, error_code: Optional[str] = None):
        super().__init__(message)
        self.error_code = error_code
        self.timestamp = datetime.now(timezone.utc)

class ContractViolationError(HVACError):
    &quot;&quot;&quot;E002/E003: é•åæ¨¡çµ„é–“ä»‹é¢å¥‘ç´„&quot;&quot;&quot;
    pass

class FutureDataError(HVACError):
    &quot;&quot;&quot;E005: æª¢æ¸¬åˆ°æœªä¾†è³‡æ–™&quot;&quot;&quot;
    pass

class ConfigurationError(HVACError):
    &quot;&quot;&quot;E001/E400-E407: é…ç½®éŒ¯èª¤&quot;&quot;&quot;
    pass

class AnnotationSyncError(ConfigurationError):
    &quot;&quot;&quot;E406: Excel èˆ‡ YAML ä¸åŒæ­¥&quot;&quot;&quot;
    pass

class InheritanceError(ConfigurationError):
    &quot;&quot;&quot;E407: YAML ç¹¼æ‰¿éˆéŒ¯èª¤ï¼ˆå¾ªç’°æˆ–éºå¤±ï¼‰&quot;&quot;&quot;
    pass

class ValidationError(ConfigurationError):
    &quot;&quot;&quot;E403-E405: Feature Annotation é©—è­‰å¤±æ•—&quot;&quot;&quot;
    pass
</code></pre>
<hr />
<h2 id="6-version-compatibility-matrix-">6. ç‰ˆæœ¬ç›¸å®¹æ€§çŸ©é™£ (Version Compatibility Matrix) - æ›´æ–°</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">Parser</th>
<th style="text-align: center;">Cleaner</th>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;"><strong>Feature Annotation</strong></th>
<th style="text-align: center;">ç›¸å®¹æ€§</th>
<th style="text-align: left;">èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;"><strong>v1.2</strong></td>
<td style="text-align: center;">âœ… <strong>å®Œå…¨ç›¸å®¹</strong></td>
<td style="text-align: left;">æ¨è–¦é…ç½®ï¼Œæ”¯æ´ç¹¼æ‰¿èˆ‡ device_role</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;"><strong>v1.1</strong></td>
<td style="text-align: center;">âš ï¸ <strong>é™ç´šç›¸å®¹</strong></td>
<td style="text-align: left;">ç¼ºå°‘ç¹¼æ‰¿èˆ‡ device_roleï¼Œå‚™ç”¨è¨­å‚™å¯èƒ½èª¤å ± W403</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âš ï¸ <strong>éƒ¨åˆ†ç›¸å®¹</strong></td>
<td style="text-align: left;">Cleaner ç„¡æ³•è®€å– device_roleï¼ˆå› ç§»é™¤é è¨­å€¼ï¼‰ï¼Œå¯èƒ½æ‹‹ E402</td>
</tr>
<tr>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">FE v1.2 ç„¡æ³•è™•ç† device_roleï¼Œå¯èƒ½å¿½ç•¥å‚™ç”¨è¨­å‚™æ¨™è¨˜</td>
</tr>
<tr>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;"><strong>v1.0</strong></td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">ç¼ºå°‘ schema_version èˆ‡ç¹¼æ‰¿æ”¯æ´</td>
</tr>
</tbody>
</table>
<p><strong>å‡ç´šè·¯å¾‘</strong>: <br />
1. System Integrationï¼ˆå»ºç«‹ Annotation SSOT åŸºç¤è¨­æ–½èˆ‡ç¹¼æ‰¿æ©Ÿåˆ¶ï¼‰<br />
2. Cleanerï¼ˆè®€å– device_roleï¼Œä¸å¯«å…¥ metadataï¼Œç§»é™¤é è¨­å€¼ï¼‰<br />
3. BatchProcessorï¼ˆå¯«å…¥ Annotation checksum è‡³ Manifestï¼‰<br />
4. Feature Engineerï¼ˆæ¶ˆè²» device_role èˆ‡ ignore_warningsï¼‰</p>
<hr />
<h2 id="7-integration-test-plan-">7. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Integration Test Plan) - æ›´æ–°</h2>
<h3 id="71">7.1 å…¨éˆè·¯æ•´åˆæ¸¬è©¦ï¼ˆæ–°å¢ç¹¼æ‰¿èˆ‡è·è²¬åˆ†é›¢æ¸¬è©¦ï¼‰</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸçµæœ</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">INT-SYS-001</td>
<td style="text-align: left;">æˆåŠŸæµç¨‹</td>
<td style="text-align: left;">æ¨™æº– CSV + v1.2 Annotation</td>
<td style="text-align: left;">è¼¸å‡º Feature Matrixï¼Œç„¡éŒ¯èª¤</td>
<td style="text-align: left;">å…¨éˆè·¯ç„¡ç¸«éŠœæ¥</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-002</td>
<td style="text-align: left;">ç·¨ç¢¼è‡ªé©æ‡‰</td>
<td style="text-align: left;">Big5 ç·¨ç¢¼ CSV</td>
<td style="text-align: left;">æ­£ç¢ºè§£æ</td>
<td style="text-align: left;">Parser v2.1</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-003</td>
<td style="text-align: left;">æ™‚å€ä¸€è‡´æ€§</td>
<td style="text-align: left;">Asia/Taipei è¼¸å…¥</td>
<td style="text-align: left;">è½‰æ›ç‚º UTC</td>
<td style="text-align: left;">æ™‚å€å®¹éŒ¯</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-004</td>
<td style="text-align: left;">æœªä¾†è³‡æ–™æ””æˆª</td>
<td style="text-align: left;">æ˜å¤©æ™‚é–“æˆ³</td>
<td style="text-align: left;">å–®æª”æ‹’çµ• (E205)</td>
<td style="text-align: left;">Data Leakage é˜²è­·</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-005</td>
<td style="text-align: left;">å¥‘ç´„é•å</td>
<td style="text-align: left;">ç¼ºå°‘ timestamp</td>
<td style="text-align: left;">ContractViolationError</td>
<td style="text-align: left;">æª¢æŸ¥é» #1</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-006</td>
<td style="text-align: left;">SSOT åŒæ­¥</td>
<td style="text-align: left;">SENSOR_OFFLINE flag</td>
<td style="text-align: left;">One-hot è‡ªå‹•åŒ…å«</td>
<td style="text-align: left;">SSOT ä¸€è‡´æ€§</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-007R</strong></td>
<td style="text-align: left;"><strong>ç¹¼æ‰¿åˆä½µ</strong></td>
<td style="text-align: left;">cgmh_ty ç¹¼æ‰¿ base</td>
<td style="text-align: left;">æ­£ç¢ºåˆä½µ base çš„ physical_types</td>
<td style="text-align: left;">ç¹¼æ‰¿æ©Ÿåˆ¶é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-008R</strong></td>
<td style="text-align: left;"><strong>å¾ªç’°ç¹¼æ‰¿é˜²è­·</strong></td>
<td style="text-align: left;">A inherit B, B inherit A</td>
<td style="text-align: left;">æ‹‹å‡º E407</td>
<td style="text-align: left;">å¾ªç’°æª¢æ¸¬é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-009</strong></td>
<td style="text-align: left;"><strong>E406 åŒæ­¥æª¢æŸ¥</strong></td>
<td style="text-align: left;">ä¿®æ”¹ Excel ä½†æœªç”Ÿæˆ YAML</td>
<td style="text-align: left;">Pipeline å•Ÿå‹•æ™‚æ‹’çµ• (E406)</td>
<td style="text-align: left;">æª¢æŸ¥é» #5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-010R</strong></td>
<td style="text-align: left;"><strong>Cleaner è·è²¬åˆ†é›¢</strong></td>
<td style="text-align: left;">backup è¨­å‚™åŸ·è¡Œæ¸…æ´—</td>
<td style="text-align: left;">Cleaner è®€å– role ä½†ä¸å¯«å…¥ metadata</td>
<td style="text-align: left;">è·è²¬é‚Šç•Œé©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-011</strong></td>
<td style="text-align: left;"><strong>device_role å‚³é</strong></td>
<td style="text-align: left;">backup è¨­å‚™ 80% é›¶å€¼</td>
<td style="text-align: left;">FE æŠ‘åˆ¶ W403 è­¦å‘Š</td>
<td style="text-align: left;">device_role æ„ŸçŸ¥</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-012</strong></td>
<td style="text-align: left;"><strong>Group Policy åŸ·è¡Œ</strong></td>
<td style="text-align: left;">chillers_* æ¬„ä½</td>
<td style="text-align: left;">æ­£ç¢ºå¥—ç”¨ Standard_Chiller æ¨¡æ¿</td>
<td style="text-align: left;">Group Policy æ•´åˆ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-013</strong></td>
<td style="text-align: left;"><strong>ignore_warnings ç”Ÿæ•ˆ</strong></td>
<td style="text-align: left;">æ¨™è¨˜ W401 å¿½ç•¥</td>
<td style="text-align: left;">è©²æ¬„ä½ä¸è§¸ç™¼å‡å€¼ç•°å¸¸è­¦å‘Š</td>
<td style="text-align: left;">è­¦å‘ŠæŠ‘åˆ¶æ©Ÿåˆ¶</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-014</strong></td>
<td style="text-align: left;"><strong>æœªå®šç¾©æ¬„ä½è™•ç†</strong></td>
<td style="text-align: left;">CSV å«æœªæ¨™è¨»æ¬„ä½</td>
<td style="text-align: left;">ä¾ unannotated_column_policy è™•ç†</td>
<td style="text-align: left;">E402 é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-SYS-015</strong></td>
<td style="text-align: left;"><strong>Template ç‰ˆæœ¬ç›¸å®¹</strong></td>
<td style="text-align: left;">v1.1 Excel åŸ·è¡Œè½‰æ›</td>
<td style="text-align: left;">å ±éŒ¯ E400ï¼Œæç¤º migrate</td>
<td style="text-align: left;">ç‰ˆæœ¬æ§åˆ¶</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-deliverables-">8. äº¤ä»˜ç‰©æ¸…å–® (Deliverables) - æ›´æ–°</h2>
<h3 id="81">8.1 ç¨‹å¼ç¢¼æª”æ¡ˆï¼ˆæ›´æ–°ï¼‰</h3>
<ol>
<li><code>src/etl/config_models.py</code> - <strong>å¯©æŸ¥ä¿®æ­£</strong>ï¼šç§»é™¤ <code>default_device_role</code>ï¼Œæ–°å¢ <code>unannotated_column_policy</code></li>
<li><code>src/utils/config_loader.py</code> - æ›´æ–°ï¼šç¹¼æ‰¿ç›¸é—œé‚è¼¯ç§»è‡³ Manager</li>
<li><code>src/container.py</code> - <strong>å¯©æŸ¥ä¿®æ­£</strong>ï¼šCleaner æ³¨å…¥ Manager å¼•ç”¨ï¼Œä¸å¯«å…¥ metadata</li>
<li><code>src/main.py</code> - æ›´æ–°ï¼šæ–°å¢ç¹¼æ‰¿éˆé¡¯ç¤º</li>
<li><code>src/features/annotation_manager.py</code> - <strong>å¯©æŸ¥ä¿®æ­£</strong>ï¼šæ–°å¢ <code>_load_with_inheritance()</code> èˆ‡ <code>_deep_merge()</code></li>
<li><code>src/features/wizard.py</code> - <strong>æ–°å¢</strong>ï¼šäº’å‹•å¼æ¨™è¨» Wizardï¼ˆåƒ…å¯« Excelï¼‰</li>
<li><code>src/features/migrate_tool.py</code> - <strong>æ–°å¢</strong>ï¼šExcel v1.1â†’v1.2 å‡ç´šå·¥å…·</li>
<li><code>src/exceptions.py</code> - æ›´æ–°ï¼šæ–°å¢ <code>InheritanceError</code> (E407)</li>
</ol>
<h3 id="82">8.2 é…ç½®æª”æ¡ˆï¼ˆæ›´æ–°ï¼‰</h3>
<ol start="9">
<li><code>config/settings.yaml</code> - æ›´æ–°ï¼šæ–°å¢ feature_annotation å€æ®µ</li>
<li><code>config/features/schema.json</code> - <strong>æ–°å¢</strong>ï¼šJSON Schema v1.2ï¼ˆæ”¯æ´ inheritï¼‰</li>
<li><code>config/features/base.yaml</code> - <strong>æ–°å¢</strong>ï¼šåŸºç¤ç¹¼æ‰¿ç¯„æœ¬</li>
<li><code>config/features/physical_types.yaml</code> - <strong>æ–°å¢</strong>ï¼šç‰©ç†é¡å‹å®šç¾©</li>
</ol>
<h3 id="83">8.3 æ¸¬è©¦æª”æ¡ˆï¼ˆæ›´æ–°ï¼‰</h3>
<ol start="13">
<li><code>tests/test_integration_full_pipeline.py</code> - æ›´æ–°ï¼šæ–°å¢ INT-SYS-007R~015</li>
<li><code>tests/test_annotation_inheritance.py</code> - <strong>æ–°å¢</strong>ï¼šç¹¼æ‰¿åˆä½µèˆ‡å¾ªç’°æª¢æ¸¬æ¸¬è©¦</li>
<li><code>tests/test_cleaner_annotation.py</code> - <strong>æ–°å¢</strong>ï¼šCleaner è·è²¬åˆ†é›¢æ¸¬è©¦ï¼ˆé©—è­‰ä¸å¯«å…¥ metadataï¼‰</li>
</ol>
<h3 id="84">8.4 æ–‡ä»¶æª”æ¡ˆï¼ˆæ›´æ–°ï¼‰</h3>
<ol start="16">
<li><code>docs/integration/PRD_SYSTEM_INTEGRATION_v1.1-REVISED.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/integration/INHERITANCE_GUIDE.md</code> - <strong>æ–°å¢</strong>ï¼šYAML ç¹¼æ‰¿ä½¿ç”¨èªªæ˜</li>
<li><code>README.md</code> - æ›´æ–°ï¼šæ–°å¢ Feature Annotation å·¥ä½œæµç¨‹èˆ‡ç¹¼æ‰¿ç¯„ä¾‹</li>
</ol>
<hr />
<h2 id="9-action-items-">9. åŸ·è¡Œæª¢æŸ¥æ¸…å–® (Action Items) - ä¾å¯©æŸ¥ä¿®æ­£å¾Œé †åº</h2>
<h3 id="phase-1-ssot-day-1">Phase 1: SSOT åŸºç¤è¨­æ–½èˆ‡ç¹¼æ‰¿ï¼ˆDay 1ï¼‰</h3>
<ul>
<li>[ ] <strong>å¯©æŸ¥ä¿®æ­£</strong>ï¼šæ›´æ–° <code>src/etl/config_models.py</code>ï¼šç§»é™¤ <code>default_device_role</code>ï¼Œæ–°å¢ <code>unannotated_column_policy</code></li>
<li>[ ] <strong>å¯©æŸ¥ä¿®æ­£</strong>ï¼šå¯¦ä½œ <code>FeatureAnnotationManager._load_with_inheritance()</code> èˆ‡ <code>_deep_merge()</code></li>
<li>[ ] å»ºç«‹ <code>config/features/base.yaml</code> ä½œç‚ºç¹¼æ‰¿åŸºç¤ç¯„æœ¬</li>
<li>[ ] é©—è­‰ï¼šå¾ªç’°ç¹¼æ‰¿æ­£ç¢ºæ‹‹å‡º E407ï¼Œæ·±åº¦åˆä½µæ­£ç¢ºè¦†è“‹çˆ¶è¨­å®š</li>
</ul>
<h3 id="phase-2-cleaner-day-2">Phase 2: Cleaner è·è²¬é‡æ¸…ï¼ˆDay 2ï¼‰</h3>
<ul>
<li>[ ] <strong>å¯©æŸ¥ä¿®æ­£</strong>ï¼šæ›´æ–° <code>DataCleaner</code>ï¼šæ¥æ”¶ <code>annotation_manager</code> å¼•ç”¨ï¼ˆé dictï¼‰</li>
<li>[ ] <strong>å¯©æŸ¥ä¿®æ­£</strong>ï¼šå¯¦ä½œã€Œè®€å– device_role èª¿æ•´æ¸…æ´—ç­–ç•¥ï¼ˆbackup æ”¾å¯¬å‡çµæª¢æ¸¬ï¼‰ï¼Œä½†ä¸å¯«å…¥ DataFrame metadataã€</li>
<li>[ ] å¯¦ä½œ <code>unannotated_column_policy</code> é‚è¼¯ï¼ˆE402 è™•ç†ï¼‰</li>
<li>[ ] é©—è­‰ï¼šè¼¸å‡º Parquet ä¸å« device_role æ¬„ä½ metadata</li>
</ul>
<h3 id="phase-3-batchprocessor-day-3">Phase 3: BatchProcessor æ•´åˆï¼ˆDay 3ï¼‰</h3>
<ul>
<li>[ ] æ›´æ–° <code>BatchOrchestrator</code>ï¼šæ¥æ”¶ <code>annotation_metadata</code>ï¼ˆå«ç¹¼æ‰¿éˆï¼‰ï¼Œå¯«å…¥ Manifest</li>
<li>[ ] Manifest æ–°å¢æ¬„ä½ï¼š<code>annotation_schema_version</code>, <code>annotation_checksum</code>, <code>inheritance_chain</code></li>
<li>[ ] é©—è­‰ï¼šManifest æ­£ç¢ºè¨˜éŒ„ç¹¼æ‰¿éˆè³‡è¨Š</li>
</ul>
<h3 id="phase-4-feature-engineer-day-4">Phase 4: Feature Engineer æ•´åˆï¼ˆDay 4ï¼‰</h3>
<ul>
<li>[ ] æ›´æ–° <code>FeatureEngineer</code>ï¼šå¾ Annotation è®€å– device_roleï¼ˆå›  Cleaner æœªå¯«å…¥ï¼‰</li>
<li>[ ] å¯¦ä½œ <code>ignore_warnings</code> éæ¿¾èˆ‡ device_role æ„ŸçŸ¥è­¦å‘ŠæŠ‘åˆ¶</li>
<li>[ ] é©—è­‰ï¼šGroup Policy æ­£ç¢ºåŸ·è¡Œï¼Œbackup è¨­å‚™ä¸è§¸ç™¼ W403</li>
</ul>
<h3 id="phase-5-cli-day-5">Phase 5: CLI èˆ‡å·¥å…·éˆï¼ˆDay 5ï¼‰</h3>
<ul>
<li>[ ] å¯¦ä½œ <code>FeatureWizard</code>ï¼š<strong>åƒ…å¯«å…¥ Excel</strong>ï¼Œä¸ç›´å¯« YAML</li>
<li>[ ] å¯¦ä½œ <code>ExcelMigrator</code>ï¼šv1.1â†’v1.2 å‡ç´šï¼ˆæ–°å¢ device_role/ignore_warnings æ¬„ä½ï¼‰</li>
<li>[ ] æ›´æ–° <code>HVACCLI</code>ï¼šé¡¯ç¤ºç¹¼æ‰¿éˆè³‡è¨Š</li>
<li>[ ] é©—è­‰ï¼šWizard æµç¨‹ç¬¦åˆå–®å‘æµ</li>
</ul>
<h3 id="phase-6-day-6">Phase 6: æ•´åˆæ¸¬è©¦ï¼ˆDay 6ï¼‰</h3>
<ul>
<li>[ ] åŸ·è¡Œ INT-SYS-007Rï¼ˆç¹¼æ‰¿åˆä½µï¼‰ã€008Rï¼ˆå¾ªç’°æª¢æ¸¬ï¼‰</li>
<li>[ ] åŸ·è¡Œ INT-SYS-010Rï¼ˆCleaner è·è²¬åˆ†é›¢é©—è­‰ï¼‰</li>
<li>[ ] åŸ·è¡Œ INT-SYS-014ï¼ˆæœªå®šç¾©æ¬„ä½è™•ç†ï¼‰</li>
<li>[ ] åŸ·è¡Œæ—¢æœ‰æ¸¬è©¦ INT-SYS-001~006, 009, 011~013, 015</li>
</ul>
<hr />
<h2 id="10-sign-off-checklist-">10. é©—æ”¶ç°½æ ¸ (Sign-off Checklist) - å¯©æŸ¥ä¿®æ­£å¾Œ</h2>
<ul>
<li>[ ] <strong>SSOT ä¸€è‡´æ€§</strong>: Excel ç‚º Annotation å”¯ä¸€ç·¨è¼¯å…¥å£ï¼Œç„¡å…¨åŸŸé è¨­å€¼</li>
<li>[ ] <strong>å–®å‘æµé©—è­‰</strong>: Wizard ç„¡æ³•ç›´æ¥å¯«å…¥ YAMLï¼Œå¿…é ˆé€é Excel â†’ excel_to_yaml.py</li>
<li>[ ] <strong>ç¹¼æ‰¿æ©Ÿåˆ¶</strong>: </li>
<li>[ ] <code>inherit: base</code> æ­£ç¢ºåˆä½µçˆ¶è¨­å®šï¼ˆæ·±åº¦åˆä½µï¼‰</li>
<li>[ ] å¾ªç’°ç¹¼æ‰¿æ­£ç¢ºæª¢æ¸¬ä¸¦æ‹‹å‡º E407</li>
<li>[ ] å­è¨­å®šæ­£ç¢ºè¦†è“‹çˆ¶è¨­å®šï¼ˆé appendï¼‰</li>
<li>[ ] <strong>Cleaner è·è²¬åˆ†é›¢</strong>:</li>
<li>[ ] <strong>å¯©æŸ¥é …ç›®</strong>ï¼šCleaner è®€å– device_role åƒ…ç”¨æ–¼èª¿æ•´æ¸…æ´—é–¾å€¼ï¼ˆä¸å¯«å…¥ metadataï¼‰</li>
<li>[ ] <strong>å¯©æŸ¥é …ç›®</strong>ï¼šè¼¸å‡º DataFrame/Parquet ä¸å« device_role ç‰©ç†æ¬„ä½</li>
<li>[ ] ç§»é™¤ <code>default_device_role</code>ï¼Œæœªå®šç¾©æ¬„ä½ä¾ <code>unannotated_column_policy</code> è™•ç†ï¼ˆE402ï¼‰</li>
<li>[ ] <strong>åŒæ­¥æª¢æŸ¥ (E406)</strong>: Excel ä¿®æ”¹æ™‚é–“æ™šæ–¼ YAML æ™‚ï¼ŒPipeline æ­£ç¢ºé˜»æ“‹</li>
<li>[ ] <strong>device_role å‚³é</strong>: </li>
<li>[ ] FE æ­£ç¢ºå¾ Annotationï¼ˆé Cleaner metadataï¼‰è®€å– device_role</li>
<li>[ ] backup/seasonal è¨­å‚™æ­£ç¢ºæŠ‘åˆ¶ W403 è­¦å‘Š</li>
<li>[ ] <strong>Group Policy åŸ·è¡Œ</strong>: åˆä½µå¾Œçš„ Group Policies æ­£ç¢ºåŸ·è¡Œï¼ˆå«ç¹¼æ‰¿è‡ª base çš„è¦å‰‡ï¼‰</li>
<li>[ ] <strong>CLI åŠŸèƒ½</strong>: </li>
<li>[ ] <code>python main.py features wizard</code> åƒ…å¯«å…¥ Excel</li>
<li>[ ] <code>python main.py features validate-annotation</code> é¡¯ç¤ºç¹¼æ‰¿éˆ</li>
<li>[ ] <code>python main.py features migrate-excel</code> æˆåŠŸå‡ç´š v1.1â†’v1.2</li>
</ul>
<hr />
</body>
</html>