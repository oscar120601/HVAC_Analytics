<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_System_Integration_v1.0</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v10-system-integration-architecture">PRD v1.0: ç³»çµ±æ•´åˆæ¶æ§‹ (System Integration Architecture)</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.0 (Zero-Gap Pipeline Integration)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/container.py</code>, <code>src/main.py</code>, <code>src/utils/config_loader.py</code><br />
<strong>ç›¸ä¾æ¨¡çµ„:</strong> æ‰€æœ‰ ETL æ¨¡çµ„ (Parser v2.1+, Cleaner v2.2+, BatchProcessor v1.3+, Feature Engineer v1.3+)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 3 ~ 4 å€‹å·¥ç¨‹å¤©ï¼ˆå«å…¨éˆè·¯æ•´åˆæ¸¬è©¦ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆå“²å­¸</h2>
<h3 id="11">1.1 æ ¸å¿ƒç›®æ¨™</h3>
<p>å»ºç«‹<strong>é›¶é–“éš™å°æ¥</strong>çš„å®Œæ•´ ETL Pipelineï¼Œç¢ºä¿ï¼š<br />
1. <strong>é…ç½®å–®ä¸€çœŸç›¸æº (SSOT)</strong>: æ‰€æœ‰æ¨¡çµ„å¼•ç”¨åŒä¸€å€‹ <code>ETLConfig</code> å¯¦ä¾‹<br />
2. <strong>ä¾è³´æ³¨å…¥ (DI)</strong>: é€é <code>Container</code> ç®¡ç†æ¨¡çµ„ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…å¯¦ä¾‹åŒ–ä¸ä¸€è‡´<br />
3. <strong>å¥‘ç´„æª¢æŸ¥é»</strong>: 4 å€‹é—œéµæª¢æŸ¥é»è‡ªå‹•é©—è­‰ (Interface Contract v1.0)<br />
4. <strong>éŒ¯èª¤å‚³æ’­éˆ</strong>: æ˜ç¢ºå®šç¾©éŒ¯èª¤å¦‚ä½•åœ¨æ¨¡çµ„é–“å‚³æ’­ï¼ˆçµ‚æ­¢ vs è·³éï¼‰</p>
<h3 id="12">1.2 æ¶æ§‹æ¦‚è¦½</h3>
<pre><code class="language-mermaid">graph TB
    subgraph &quot;Configuration Layer&quot;
        A[settings.yaml] --&gt; B[ConfigLoader]
        B --&gt; C[ETLConfig SSOT]
    end

    subgraph &quot;Dependency Injection Container&quot;
        C --&gt; D[ETLContainer]
        D --&gt; E[ReportParser v2.1]
        D --&gt; F[DataCleaner v2.2]
        D --&gt; G[BatchOrchestrator v1.3]
        D --&gt; H[FeatureEngineer v1.3]
    end

    subgraph &quot;Pipeline Execution&quot;
        E --&gt;|Raw DF UTC| F
        F --&gt;|Clean DF + Metadata| G
        G --&gt;|Parquet + Manifest| H
        H --&gt;|Feature Matrix| I[Model Training]
    end

    subgraph &quot;Contract Checkpoints&quot;
        CP1{æª¢æŸ¥é» #1&lt;br/&gt;Parser Output}
        CP2{æª¢æŸ¥é» #2&lt;br/&gt;Cleaner Output}
        CP3{æª¢æŸ¥é» #3&lt;br/&gt;BatchProcessor Output}
    end

    E -.-&gt; CP1 -.-&gt; F
    F -.-&gt; CP2 -.-&gt; G
    G -.-&gt; CP3 -.-&gt; H

    style C fill:#f9f,stroke:#333,stroke-width:4px
    style D fill:#bbf,stroke:#333,stroke-width:4px
</code></pre>
<hr />
<h2 id="2-ssot-configuration-system">2. SSOT é…ç½®ç³»çµ± (Configuration System)</h2>
<h3 id="21">2.1 çµ±ä¸€é…ç½®çµæ§‹</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/config_models.py</code> (æ ¸å¿ƒ SSOT)</p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<pre><code class="language-python">from typing import Final, List, Dict, Optional, Literal
from pydantic import BaseModel, validator, Field

# SSOT 1: Quality Flags (6å€‹æ¨™æº–å€¼ï¼Œå…¨åŸŸå”¯ä¸€)
VALID_QUALITY_FLAGS: Final[List[str]] = [
    &quot;FROZEN&quot;,           # æ•¸æ“šå‡çµï¼ˆé€£çºŒ3å€‹å€é–“å€¼ç›¸åŒï¼‰
    &quot;HEAT_IMBALANCE&quot;,   # ç†±å¹³è¡¡åå·® &gt; 5%
    &quot;AFFINITY_VIOLATION&quot;, # é•åè¦ªå’Œå¾‹ &gt; 15%
    &quot;OUTLIER&quot;,          # çµ±è¨ˆé›¢ç¾¤å€¼ï¼ˆIQRæ³•ï¼‰
    &quot;INSUFFICIENT_DATA&quot;, # æ™‚é–“ç©ºç¼ºè£œå…¨æ¨™è¨˜
    &quot;SENSOR_OFFLINE&quot;    # æ„Ÿæ¸¬å™¨é›¢ç·šï¼ˆæ–°å¢ï¼‰
]

# SSOT 2: æ™‚é–“æˆ³è¦ç¯„ (æ‰€æœ‰æ¨¡çµ„å¿…é ˆéµå®ˆ)
TIMESTAMP_CONFIG: Final[Dict] = {
    &quot;dtype&quot;: &quot;Datetime&quot;,
    &quot;time_unit&quot;: &quot;nanoseconds&quot;,  # ns
    &quot;time_zone&quot;: &quot;UTC&quot;,          # å¼·åˆ¶UTC
    &quot;parquet_physical_type&quot;: &quot;INT64&quot;  # ç¦æ­¢INT96
}

# SSOT 3: Feature Metadata Schema
class FeatureMetadata(BaseModel):
    column_name: str
    physical_type: Literal[
        &quot;temperature&quot;, &quot;flow_rate&quot;, &quot;power&quot;, &quot;status&quot;, 
        &quot;humidity&quot;, &quot;gauge&quot;, &quot;chiller_load&quot;, &quot;cooling_tower_load&quot;
    ]
    unit: Optional[str] = None           # &quot;LPM&quot;, &quot;kW&quot;, &quot;Â°C&quot;, &quot;%&quot;
    is_target: bool = False              # æ˜¯å¦ç‚ºç›®æ¨™è®Šæ•¸ï¼ˆä¸æ‡‰ç”ŸæˆLagï¼‰
    enable_lag: bool = True
    enable_rolling: bool = True
    agg_method: Literal[&quot;mean&quot;, &quot;sum&quot;, &quot;last&quot;, &quot;first&quot;] = &quot;mean&quot;

# Parser é…ç½®
class ParserConfig(BaseModel):
    encoding: str = &quot;auto&quot;               # auto | utf-8 | cp950 | utf-16
    header_scan_rows: int = 500
    assumed_timezone: str = &quot;Asia/Taipei&quot;  # åƒ…ç”¨æ–¼ naive datetime
    null_values: List[str] = Field(default_factory=lambda: [
        &quot;&quot;, &quot;NA&quot;, &quot;null&quot;, &quot;---&quot;, &quot;Error&quot;, &quot;N/A&quot;, &quot;OFF&quot;, &quot;OFFLINE&quot;, &quot;#VALUE!&quot;
    ])

# Cleaner é…ç½®
class CleanerConfig(BaseModel):
    unit_system: Literal[&quot;METRIC&quot;, &quot;IMPERIAL&quot;] = &quot;METRIC&quot;
    resample_interval: str = &quot;15m&quot;       # Polars interval syntax
    heat_balance_threshold: float = 0.05  # 5%
    frozen_data_intervals: int = 3
    enforce_output_contract: bool = True

# BatchProcessor é…ç½®
class BatchConfig(BaseModel):
    output_base_dir: str = &quot;data/processed&quot;
    staging_dir: str = &quot;data/.staging&quot;
    max_rows_per_file: int = 100_000
    compression: Literal[&quot;snappy&quot;, &quot;zstd&quot;] = &quot;snappy&quot;
    use_pyarrow: bool = False            # å¿…é ˆ False ä»¥é¿å… INT96
    future_data_tolerance_minutes: int = 5

# Feature Engineer é…ç½®
class FeatureEngineeringConfig(BaseModel):
    execution_mode: Literal[&quot;in_memory&quot;] = &quot;in_memory&quot;
    cutoff_timestamp: Optional[str] = None  # ISO 8601 format
    group_policies: List[Dict] = Field(default_factory=list)
    physics_features: bool = True
    time_features: bool = True

# çµ±ä¸€é…ç½®æ ¹
class ETLConfig(BaseModel):
    &quot;&quot;&quot;ETL Pipeline çµ±ä¸€é…ç½® (SSOT ä¸­å¿ƒ)&quot;&quot;&quot;
    version: str = &quot;1.0&quot;
    site_id: str = &quot;default&quot;

    parser: ParserConfig = ParserConfig()
    cleaner: CleanerConfig = CleanerConfig()
    batch: BatchConfig = BatchConfig()
    feature: FeatureEngineeringConfig = FeatureEngineeringConfig()

    # å…¨åŸŸè¨­å®š
    log_level: str = &quot;INFO&quot;
    strict_mode: bool = True             # åš´æ ¼å¥‘ç´„æª¢æŸ¥

    @validator('version')
    def validate_version(cls, v):
        if v != &quot;1.0&quot;:
            raise ValueError(&quot;Config version must be 1.0&quot;)
        return v
</code></pre>
<h3 id="22-configloader">2.2 é…ç½®è¼‰å…¥å™¨ (ConfigLoader)</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/utils/config_loader.py</code></p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<pre><code class="language-python">import yaml
from pathlib import Path
from typing import Union
from src.etl.config_models import ETLConfig, VALID_QUALITY_FLAGS

class ConfigurationError(Exception):
    &quot;&quot;&quot;é…ç½®éŒ¯èª¤&quot;&quot;&quot;
    pass

class ConfigLoader:
    &quot;&quot;&quot;çµ±ä¸€é…ç½®è¼‰å…¥ï¼Œç¢ºä¿æ‰€æœ‰æ¨¡çµ„å¼•ç”¨ç›¸åŒ SSOT&quot;&quot;&quot;

    @staticmethod
    def load(config_path: Union[str, Path] = &quot;config/settings.yaml&quot;) -&gt; ETLConfig:
        &quot;&quot;&quot;
        è¼‰å…¥ä¸¦é©—è­‰é…ç½®

        é©—è­‰é …ç›®:
        1. YAML æ ¼å¼æ­£ç¢ºæ€§
        2. SSOT ä¸€è‡´æ€§ (flags å®šç¾©å¿…é ˆåŒ¹é…ç¨‹å¼ç¢¼)
        3. è·¯å¾‘å­˜åœ¨æ€§ (output_base_dir, staging_dir)
        &quot;&quot;&quot;
        config_path = Path(config_path)

        if not config_path.exists():
            raise ConfigurationError(f&quot;é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_path}&quot;)

        with open(config_path, 'r', encoding='utf-8') as f:
            try:
                data = yaml.safe_load(f)
            except yaml.YAMLError as e:
                raise ConfigurationError(f&quot;YAML è§£æéŒ¯èª¤: {e}&quot;)

        # é©—è­‰ SSOT ä¸€è‡´æ€§ (é—œéµæª¢æŸ¥)
        code_flags = set(VALID_QUALITY_FLAGS)
        config_flags = set(data.get(&quot;custom_quality_flags&quot;, []))

        if config_flags and config_flags != code_flags:
            # å…è¨±æ“´å……ï¼Œä½†å¿…é ˆåŒ…å«æ‰€æœ‰åŸºç¤ flags
            missing_base = code_flags - config_flags
            if missing_base:
                raise ConfigurationError(
                    f&quot;settings.yaml ä¸­çš„ flags ç¼ºå°‘ SSOT åŸºç¤æ¨™è¨˜: {missing_base}. &quot;
                    f&quot;ç¨‹å¼ç¢¼å®šç¾©: {code_flags}&quot;
                )

        # é©—è­‰ç›®éŒ„å­˜åœ¨æ€§æˆ–è‡ªå‹•å»ºç«‹
        for dir_key in [&quot;output_base_dir&quot;, &quot;staging_dir&quot;]:
            if dir_key in data.get(&quot;batch&quot;, {}):
                Path(data[&quot;batch&quot;][dir_key]).mkdir(parents=True, exist_ok=True)

        try:
            return ETLConfig(**data)
        except Exception as e:
            raise ConfigurationError(f&quot;é…ç½®é©—è­‰å¤±æ•—: {e}&quot;)

    @staticmethod
    def validate_ssot_compatibility() -&gt; bool:
        &quot;&quot;&quot;é©—è­‰ç¨‹å¼ç¢¼ SSOT èˆ‡é‹è¡Œæ™‚ä¸€è‡´æ€§&quot;&quot;&quot;
        # å¯åœ¨ CI/CD ä¸­å‘¼å«
        return True
</code></pre>
<hr />
<h2 id="3-di-container">3. ä¾è³´æ³¨å…¥å®¹å™¨ (DI Container)</h2>
<h3 id="31-etlcontainer">3.1 ETLContainer å¯¦ä½œ</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/container.py</code></p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<pre><code class="language-python">from typing import Optional, List
from pathlib import Path
import polars as pl

from src.etl.config_models import ETLConfig
from src.etl.parser import ReportParser
from src.etl.cleaner import DataCleaner
from src.etl.batch_processor import BatchOrchestrator, BatchResult
from src.etl.feature_engineer import FeatureEngineer
from src.utils.logger import get_logger

class ETLContainer:
    &quot;&quot;&quot;
    ä¾è³´æ³¨å…¥å®¹å™¨ (Dependency Injection Container)

    ç®¡ç†æ‰€æœ‰ ETL æ¨¡çµ„çš„ç”Ÿå‘½å‘¨æœŸèˆ‡é…ç½®å‚³éï¼Œç¢ºä¿:
    1. å–®ä¾‹æ¨¡å¼ (Singleton) - æ¯å€‹æ¨¡çµ„åªåˆå§‹åŒ–ä¸€æ¬¡
    2. é…ç½®ä¸€è‡´æ€§ - æ‰€æœ‰æ¨¡çµ„å¼•ç”¨ç›¸åŒ ETLConfig
    3. é›¶é–“éš™éŠœæ¥ - è‡ªå‹•è™•ç†æ¨¡çµ„é–“çš„è³‡æ–™å‚³é
    &quot;&quot;&quot;

    def __init__(self, config: ETLConfig):
        self.config = config
        self.logger = get_logger(&quot;ETLContainer&quot;)

        # å¿«å–å¯¦ä¾‹ (Singleton)
        self._parser: Optional[ReportParser] = None
        self._cleaner: Optional[DataCleaner] = None
        self._batch_processor: Optional[BatchOrchestrator] = None
        self._feature_engineer: Optional[FeatureEngineer] = None

    def get_parser(self) -&gt; ReportParser:
        &quot;&quot;&quot;å–å¾— Parser å¯¦ä¾‹ (v2.1+)&quot;&quot;&quot;
        if self._parser is None:
            self._parser = ReportParser(
                site_id=self.config.site_id,
                config=self.config.parser
            )
            self.logger.debug(f&quot;åˆå§‹åŒ– ReportParser (site: {self.config.site_id})&quot;)
        return self._parser

    def get_cleaner(self) -&gt; DataCleaner:
        &quot;&quot;&quot;å–å¾— Cleaner å¯¦ä¾‹ (v2.2+)&quot;&quot;&quot;
        if self._cleaner is None:
            self._cleaner = DataCleaner(config=self.config.cleaner)
            self.logger.debug(&quot;åˆå§‹åŒ– DataCleaner&quot;)
        return self._cleaner

    def get_batch_processor(self) -&gt; BatchOrchestrator:
        &quot;&quot;&quot;å–å¾— BatchProcessor å¯¦ä¾‹ (v1.3+)&quot;&quot;&quot;
        if self._batch_processor is None:
            self._batch_processor = BatchOrchestrator(
                config=self.config,
                parser=self.get_parser(),
                cleaner=self.get_cleaner()
            )
            self.logger.debug(&quot;åˆå§‹åŒ– BatchOrchestrator&quot;)
        return self._batch_processor

    def get_feature_engineer(self) -&gt; FeatureEngineer:
        &quot;&quot;&quot;å–å¾— FeatureEngineer å¯¦ä¾‹ (v1.3+)&quot;&quot;&quot;
        if self._feature_engineer is None:
            self._feature_engineer = FeatureEngineer(
                config=self.config.feature
            )
            self.logger.debug(&quot;åˆå§‹åŒ– FeatureEngineer&quot;)
        return self._feature_engineer

    def run_full_pipeline(self, input_files: List[Path]) -&gt; pl.DataFrame:
        &quot;&quot;&quot;
        åŸ·è¡Œå®Œæ•´ ETL æµç¨‹ (ç«¯åˆ°ç«¯)

        æµç¨‹:
        1. BatchProcessor (Parser â†’ Cleaner â†’ Parquet + Manifest)
        2. Feature Engineer (Manifest â†’ Feature Matrix)

        éŒ¯èª¤è™•ç†:
        - ContractViolationError: çµ‚æ­¢æµç¨‹ï¼Œå›å ±è©³ç´°éŒ¯èª¤
        - FutureDataError: å–®æª”æ¡ˆè·³éï¼Œå…¶ä»–ç¹¼çºŒè™•ç†
        &quot;&quot;&quot;
        self.logger.info(f&quot;ğŸš€ å•Ÿå‹•å®Œæ•´ ETL Pipelineï¼Œè™•ç† {len(input_files)} å€‹æª”æ¡ˆ&quot;)

        # Step 1: Batch Processing
        bp = self.get_batch_processor()
        manifests = []

        for file_path in input_files:
            try:
                result = bp.process_single_file(file_path)

                if result.status == &quot;success&quot;:
                    manifests.append(result.manifest_path)
                    self.logger.info(f&quot;âœ… è™•ç†æˆåŠŸ: {file_path.name}&quot;)
                elif result.status == &quot;future_data_rejected&quot;:
                    self.logger.warning(f&quot;âš ï¸  æœªä¾†è³‡æ–™æ‹’çµ•: {file_path.name} - {result.error}&quot;)
                else:
                    self.logger.error(f&quot;âŒ è™•ç†å¤±æ•—: {file_path.name} - {result.error}&quot;)

            except ContractViolationError as e:
                self.logger.error(f&quot;âŒ å¥‘ç´„é•å: {file_path.name} - {e}&quot;)
                if self.config.strict_mode:
                    raise  # åš´æ ¼æ¨¡å¼ä¸‹çµ‚æ­¢æ•´æ‰¹è™•ç†

        if not manifests:
            raise DataValidationError(&quot;æ²’æœ‰æˆåŠŸè™•ç†çš„æª”æ¡ˆï¼Œç„¡æ³•ç¹¼çºŒç‰¹å¾µå·¥ç¨‹&quot;)

        # Step 2: Feature Engineering (ä½¿ç”¨æœ€å¾Œä¸€å€‹ manifest ç‚ºä»£è¡¨)
        # å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²åˆä½µæ‰€æœ‰ manifests
        fe = self.get_feature_engineer()
        manifest_path = manifests[-1]

        self.logger.info(f&quot;ğŸ”§ é–‹å§‹ç‰¹å¾µå·¥ç¨‹: {manifest_path}&quot;)

        # è®€å– Manifest èˆ‡è³‡æ–™
        df, metadata = fe.load_from_manifest(manifest_path)

        # è½‰æ›
        feature_df = fe.transform(
            df,
            manifest_metadata=metadata,
            cutoff_timestamp=self.config.feature.cutoff_timestamp
        )

        self.logger.info(f&quot;âœ… ETL Pipeline å®Œæˆï¼Œè¼¸å‡ºç¶­åº¦: {feature_df.shape}&quot;)
        return feature_df

    def reset(self):
        &quot;&quot;&quot;é‡ç½®æ‰€æœ‰å¿«å–å¯¦ä¾‹ (ç”¨æ–¼æ¸¬è©¦)&quot;&quot;&quot;
        self._parser = None
        self._cleaner = None
        self._batch_processor = None
        self._feature_engineer = None
        self.logger.debug(&quot;é‡ç½®æ‰€æœ‰æ¨¡çµ„å¯¦ä¾‹&quot;)
</code></pre>
<hr />
<h2 id="4-cli-entry-point">4. CLI å…¥å£é» (Entry Point)</h2>
<h3 id="41-hvaccli">4.1 HVACCLI å¯¦ä½œ</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/main.py</code></p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<pre><code class="language-python">#!/usr/bin/env python3
import sys
from pathlib import Path
from typing import List, Optional
import fire

from src.container import ETLContainer
from src.utils.config_loader import ConfigLoader, ConfigurationError
from src.etl.exceptions import ContractViolationError, FutureDataError, DataValidationError

class HVACCLI:
    &quot;&quot;&quot;
    HVAC Analytics CLI ä»‹é¢

    æä¾›çµ±ä¸€çš„å‘½ä»¤åˆ—å…¥å£ï¼Œæ•´åˆæ‰€æœ‰ ETL èˆ‡å»ºæ¨¡åŠŸèƒ½ã€‚
    &quot;&quot;&quot;

    def __init__(self, config_path: str = &quot;config/settings.yaml&quot;):
        try:
            self.config = ConfigLoader.load(config_path)
            self.container = ETLContainer(self.config)
        except ConfigurationError as e:
            print(f&quot;âŒ é…ç½®éŒ¯èª¤: {e}&quot;)
            sys.exit(1)

    def run_etl(
        self, 
        input_dir: str, 
        output_dir: Optional[str] = None,
        pattern: str = &quot;*.csv&quot;
    ):
        &quot;&quot;&quot;
        åŸ·è¡Œå®Œæ•´ ETL æµç¨‹

        Args:
            input_dir: è¼¸å…¥ CSV æª”æ¡ˆç›®éŒ„
            output_dir: è¼¸å‡ºç›®éŒ„ (å¯é¸ï¼Œè¦†è“‹é…ç½®)
            pattern: æª”æ¡ˆåŒ¹é…æ¨¡å¼ï¼Œé è¨­ *.csv
        &quot;&quot;&quot;
        input_path = Path(input_dir)
        if not input_path.exists():
            print(f&quot;âŒ è¼¸å…¥ç›®éŒ„ä¸å­˜åœ¨: {input_dir}&quot;)
            return

        files = list(input_path.glob(pattern))
        if not files:
            print(f&quot;âš ï¸  æœªæ‰¾åˆ°åŒ¹é…æª”æ¡ˆ: {pattern}&quot;)
            return

        print(f&quot;ğŸš€ å•Ÿå‹• ETL Pipelineï¼Œè™•ç† {len(files)} å€‹æª”æ¡ˆ...&quot;)

        try:
            result_df = self.container.run_full_pipeline(files)

            # å¯é¸: å„²å­˜æœ€çµ‚ç‰¹å¾µçŸ©é™£
            if output_dir:
                output_path = Path(output_dir)
                output_path.mkdir(parents=True, exist_ok=True)
                output_file = output_path / &quot;feature_matrix.parquet&quot;
                result_df.write_parquet(output_file)
                print(f&quot;ğŸ’¾ ç‰¹å¾µçŸ©é™£å·²å„²å­˜: {output_file}&quot;)

            print(f&quot;âœ… ETL å®Œæˆï¼Œè¼¸å‡ºç¶­åº¦: {result_df.shape}&quot;)

        except ContractViolationError as e:
            print(f&quot;âŒ å¥‘ç´„é•åéŒ¯èª¤: {e}&quot;)
            print(&quot;è«‹æª¢æŸ¥å„æ¨¡çµ„ç‰ˆæœ¬ç›¸å®¹æ€§:&quot;)
            print(&quot;  - Parser &gt;= v2.1&quot;)
            print(&quot;  - Cleaner &gt;= v2.2&quot;)
            print(&quot;  - BatchProcessor &gt;= v1.3&quot;)
            print(&quot;  - FeatureEngineer &gt;= v1.3&quot;)
            sys.exit(2)

        except FutureDataError as e:
            print(f&quot;âš ï¸  æœªä¾†è³‡æ–™éŒ¯èª¤: {e}&quot;)
            print(&quot;è«‹æª¢æŸ¥è³‡æ–™ä¾†æºç³»çµ±æ™‚é–“è¨­å®š&quot;)
            sys.exit(3)

        except Exception as e:
            print(f&quot;âŒ æœªé æœŸéŒ¯èª¤: {e}&quot;)
            import traceback
            traceback.print_exc()
            sys.exit(99)

    def validate_config(self):
        &quot;&quot;&quot;é©—è­‰ç•¶å‰é…ç½®&quot;&quot;&quot;
        print(&quot;âœ… é…ç½®è¼‰å…¥æˆåŠŸ&quot;)
        print(f&quot;   Site ID: {self.config.site_id}&quot;)
        print(f&quot;   Flags: {VALID_QUALITY_FLAGS}&quot;)
        print(f&quot;   Strict Mode: {self.config.strict_mode}&quot;)

    def version(self):
        &quot;&quot;&quot;é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š&quot;&quot;&quot;
        print(&quot;HVAC Analytics Pipeline v1.0&quot;)
        print(&quot;ç›¸å®¹æ¨¡çµ„ç‰ˆæœ¬:&quot;)
        print(&quot;  - Parser: v2.1+&quot;)
        print(&quot;  - Cleaner: v2.2+&quot;)
        print(&quot;  - BatchProcessor: v1.3+&quot;)
        print(&quot;  - FeatureEngineer: v1.3+&quot;)

def main():
    &quot;&quot;&quot;Entry point&quot;&quot;&quot;
    fire.Fire(HVACCLI)

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<hr />
<h2 id="5-error-handling">5. éŒ¯èª¤è™•ç†èˆ‡å‚³æ’­ (Error Handling)</h2>
<h3 id="51">5.1 éŒ¯èª¤å‚³æ’­ç­–ç•¥</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤é¡å‹</th>
<th style="text-align: left;">ç™¼ç”Ÿæ¨¡çµ„</th>
<th style="text-align: center;">å‚³æ’­ç­–ç•¥</th>
<th style="text-align: left;">ä¸‹æ¸¸å½±éŸ¿</th>
<th style="text-align: left;">ä½¿ç”¨è€…è¨Šæ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>EncodingError</code> (E001)</td>
<td style="text-align: left;">Parser</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">æ•´æ‰¹å¤±æ•—</td>
<td style="text-align: left;">"æª”æ¡ˆç·¨ç¢¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªç‚º UTF-8/Big5/UTF-16"</td>
</tr>
<tr>
<td style="text-align: left;"><code>ContractViolationError</code> (E002/E003/E202/E206)</td>
<td style="text-align: left;">Parser/Cleaner/BatchProcessor/FE</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong> (strict_mode) / <strong>å–®æª”è·³é</strong></td>
<td style="text-align: left;">ä¾ strict_mode æ±ºå®š</td>
<td style="text-align: left;">"æ¨¡çµ„é–“ä»‹é¢å¥‘ç´„é•åï¼Œè«‹æª¢æŸ¥ç‰ˆæœ¬ç›¸å®¹æ€§"</td>
</tr>
<tr>
<td style="text-align: left;"><code>FutureDataError</code> (E005/E205)</td>
<td style="text-align: left;">BatchProcessor</td>
<td style="text-align: center;"><strong>å–®æª”è·³é</strong></td>
<td style="text-align: left;">è©²æª”æ¡ˆä¸å…¥åº«ï¼Œå…¶ä»–ç¹¼çºŒ</td>
<td style="text-align: left;">"æª”æ¡ˆå«æœªä¾†è³‡æ–™ï¼Œå·²æ‹’çµ•è™•ç†"</td>
</tr>
<tr>
<td style="text-align: left;"><code>UnknownFlagError</code> (E003/E202)</td>
<td style="text-align: left;">Cleaner/BatchProcessor</td>
<td style="text-align: center;"><strong>çµ‚æ­¢</strong></td>
<td style="text-align: left;">éœ€æ›´æ–° SSOT</td>
<td style="text-align: left;">"æœªå®šç¾©å“è³ªæ¨™è¨˜ï¼Œè«‹æ›´æ–° config_models.py"</td>
</tr>
<tr>
<td style="text-align: left;"><code>DataValidationError</code></td>
<td style="text-align: left;">Parser/Cleaner</td>
<td style="text-align: center;"><strong>å¯é…ç½®</strong></td>
<td style="text-align: left;">å–®æª”å¤±æ•—</td>
<td style="text-align: left;">"è³‡æ–™é©—è­‰å¤±æ•—"</td>
</tr>
<tr>
<td style="text-align: left;"><code>MetadataLossWarning</code> (E203/E304)</td>
<td style="text-align: left;">BatchProcessor/FE</td>
<td style="text-align: center;"><strong>Warning</strong></td>
<td style="text-align: left;">ä½¿ç”¨ä¿å®ˆé è¨­</td>
<td style="text-align: left;">"ç¼ºå°‘ metadataï¼Œä½¿ç”¨ä¿å®ˆé è¨­"</td>
</tr>
</tbody>
</table>
<h3 id="52">5.2 å…¨åŸŸéŒ¯èª¤è™•ç†å™¨</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>src/exceptions.py</code> (æ“´å……)</p>
<pre><code class="language-python">class HVACError(Exception):
    &quot;&quot;&quot;åŸºç¤éŒ¯èª¤é¡åˆ¥&quot;&quot;&quot;
    def __init__(self, message: str, error_code: Optional[str] = None):
        super().__init__(message)
        self.error_code = error_code
        self.timestamp = datetime.now(timezone.utc)

class ContractViolationError(HVACError):
    &quot;&quot;&quot;é•åæ¨¡çµ„é–“ä»‹é¢å¥‘ç´„&quot;&quot;&quot;
    pass

class FutureDataError(HVACError):
    &quot;&quot;&quot;æª¢æ¸¬åˆ°æœªä¾†è³‡æ–™&quot;&quot;&quot;
    pass

class ConfigurationError(HVACError):
    &quot;&quot;&quot;é…ç½®éŒ¯èª¤&quot;&quot;&quot;
    pass
</code></pre>
<hr />
<h2 id="6-version-compatibility-matrix">6. ç‰ˆæœ¬ç›¸å®¹æ€§çŸ©é™£ (Version Compatibility Matrix)</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">Parser</th>
<th style="text-align: center;">Cleaner</th>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;">ç›¸å®¹æ€§</th>
<th style="text-align: left;">èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">âœ… <strong>å®Œå…¨ç›¸å®¹</strong></td>
<td style="text-align: left;">æ¨è–¦é…ç½®ï¼Œé›¶é–“éš™å°æ¥</td>
</tr>
<tr>
<td style="text-align: center;">v2.0 (Asia/Taipei)</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">âš ï¸ <strong>é™ç´šç›¸å®¹</strong></td>
<td style="text-align: left;">Cleaner éœ€å•Ÿç”¨æ™‚å€å®¹éŒ¯ (E101 Warning)</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">âš ï¸ <strong>éƒ¨åˆ†ç›¸å®¹</strong></td>
<td style="text-align: left;">BatchProcessor ç¼ºå°‘ metadata (E203)ï¼ŒFE ä½¿ç”¨ä¿å®ˆé è¨­</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2 (ç¡¬ç·¨ç¢¼ flags)</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">FE v1.2 ç„¡æ³•è™•ç†æ–° flags (å¦‚ SENSOR_OFFLINE)ï¼Œç‰¹å¾µç¶­åº¦éŒ¯èª¤</td>
</tr>
<tr>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">BatchProcessor v1.2 ç„¡æ³•å‚³é feature_metadata (GAP #3 æœªè§£æ±º)</td>
</tr>
</tbody>
</table>
<p><strong>å‡ç´šè·¯å¾‘</strong>: å¿…é ˆæŒ‰é †åºå‡ç´šï¼šParser â†’ Cleaner â†’ BatchProcessor â†’ Feature Engineer</p>
<hr />
<h2 id="7-integration-test-plan">7. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Integration Test Plan)</h2>
<h3 id="71">7.1 å…¨éˆè·¯æ•´åˆæ¸¬è©¦</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸçµæœ</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">INT-SYS-001</td>
<td style="text-align: left;">æˆåŠŸæµç¨‹</td>
<td style="text-align: left;">æ¨™æº– CSV æª”æ¡ˆ</td>
<td style="text-align: left;">è¼¸å‡º Feature Matrixï¼Œç„¡éŒ¯èª¤</td>
<td style="text-align: left;">å…¨éˆè·¯ç„¡ç¸«éŠœæ¥</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-002</td>
<td style="text-align: left;">ç·¨ç¢¼è‡ªé©æ‡‰</td>
<td style="text-align: left;">Big5 ç·¨ç¢¼ CSV</td>
<td style="text-align: left;">æ­£ç¢ºè§£æï¼Œè¼¸å‡º UTF-8/UTC</td>
<td style="text-align: left;">Parser v2.1 ç·¨ç¢¼è™•ç†</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-003</td>
<td style="text-align: left;">æ™‚å€ä¸€è‡´æ€§</td>
<td style="text-align: left;">Parser è¼¸å…¥ Asia/Taipei (æ¨¡æ“¬èˆŠç‰ˆ)</td>
<td style="text-align: left;">Cleaner è½‰æ›ç‚º UTCï¼Œç™¼ E101</td>
<td style="text-align: left;">æ™‚å€å®¹éŒ¯æ©Ÿåˆ¶</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-004</td>
<td style="text-align: left;">æœªä¾†è³‡æ–™æ””æˆª</td>
<td style="text-align: left;">æ™‚é–“æˆ³ç‚ºæ˜å¤©çš„æª”æ¡ˆ</td>
<td style="text-align: left;">å–®æª”æ‹’çµ• (E205)ï¼Œå…¶ä»–ç¹¼çºŒ</td>
<td style="text-align: left;">Data Leakage é˜²è­·</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-005</td>
<td style="text-align: left;">å¥‘ç´„é•å</td>
<td style="text-align: left;">ç¼ºå°‘ timestamp æ¬„ä½</td>
<td style="text-align: left;">æ‹‹å‡º ContractViolationError</td>
<td style="text-align: left;">æª¢æŸ¥é» #1 é‹ä½œ</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-006</td>
<td style="text-align: left;">SSOT åŒæ­¥</td>
<td style="text-align: left;">ä½¿ç”¨æ–°å¢ SENSOR_OFFLINE flag</td>
<td style="text-align: left;">One-hot ç‰¹å¾µè‡ªå‹•åŒ…å«æ–° flag</td>
<td style="text-align: left;">SSOT ä¸€è‡´æ€§</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-007</td>
<td style="text-align: left;">Metadata å‚³é</td>
<td style="text-align: left;">Multi-asset è³‡æ–™ (3å°å†°æ©Ÿ)</td>
<td style="text-align: left;">Group Policy æ­£ç¢ºå¥—ç”¨è‡³æ‰€æœ‰å†°æ©Ÿ</td>
<td style="text-align: left;">GAP #3 è§£æ±ºé©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;">INT-SYS-008</td>
<td style="text-align: left;">å†ªç­‰æ€§</td>
<td style="text-align: left;">é‡è¤‡åŸ·è¡Œç›¸åŒè¼¸å…¥</td>
<td style="text-align: left;">è¼¸å‡º Bit-wise ä¸€è‡´</td>
<td style="text-align: left;">å®¹å™¨çš„ Singleton ä¿è­‰</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-deliverables">8. äº¤ä»˜ç‰©æ¸…å–® (Deliverables)</h2>
<h3 id="81">8.1 ç¨‹å¼ç¢¼æª”æ¡ˆ</h3>
<ol>
<li><code>src/etl/config_models.py</code> - SSOT é…ç½®å®šç¾© (VALID_QUALITY_FLAGS, ETLConfig)</li>
<li><code>src/utils/config_loader.py</code> - é…ç½®è¼‰å…¥å™¨ (å« SSOT é©—è­‰)</li>
<li><code>src/container.py</code> - DI å®¹å™¨ (ETLContainer)</li>
<li><code>src/main.py</code> - CLI å…¥å£é» (HVACCLI)</li>
<li><code>src/exceptions.py</code> - å…¨åŸŸä¾‹å¤–å®šç¾©</li>
</ol>
<h3 id="82">8.2 é…ç½®æª”æ¡ˆ</h3>
<ol start="6">
<li><code>config/settings.yaml</code> - é è¨­é…ç½®ç¯„æœ¬</li>
<li><code>config/site_templates.yaml</code> - æ¡ˆå ´ç‰¹å®šé…ç½® (ç¹¼æ‰¿è‡ª settings.yaml)</li>
</ol>
<h3 id="83">8.3 æ¸¬è©¦æª”æ¡ˆ</h3>
<ol start="8">
<li><code>tests/test_integration_full_pipeline.py</code> - å…¨éˆè·¯æ•´åˆæ¸¬è©¦ (INT-SYS-001~008)</li>
<li><code>tests/test_container.py</code> - DI å®¹å™¨å–®å…ƒæ¸¬è©¦</li>
</ol>
<h3 id="84">8.4 æ–‡ä»¶æª”æ¡ˆ</h3>
<ol start="10">
<li><code>docs/integration/PRD_SYSTEM_INTEGRATION_v1.0.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/integration/UPGRADE_GUIDE_v1.0.md</code> - ç‰ˆæœ¬å‡ç´šæŒ‡å¼•</li>
<li><code>README.md</code> (æ›´æ–°) - å¿«é€Ÿé–‹å§‹èˆ‡ CLI ä½¿ç”¨èªªæ˜</li>
</ol>
<hr />
<h2 id="9-action-items">9. åŸ·è¡Œæª¢æŸ¥æ¸…å–® (Action Items)</h2>
<h3 id="phase-1-ssot-day-1">Phase 1: SSOT å»ºç«‹ (Day 1)</h3>
<ul>
<li>[ ] å»ºç«‹ <code>src/etl/config_models.py</code>ï¼Œå®šç¾© <code>VALID_QUALITY_FLAGS</code> (6é …)</li>
<li>[ ] å®šç¾© <code>ETLConfig</code> Pydantic æ¨¡å‹ï¼ŒåŒ…å«æ‰€æœ‰å­æ¨¡çµ„é…ç½®</li>
<li>[ ] å¯¦ä½œ <code>ConfigLoader</code> èˆ‡ SSOT ä¸€è‡´æ€§é©—è­‰</li>
</ul>
<h3 id="phase-2-di-day-2">Phase 2: DI å®¹å™¨ (Day 2)</h3>
<ul>
<li>[ ] å¯¦ä½œ <code>ETLContainer</code> (Singleton æ¨¡å¼)</li>
<li>[ ] å¯¦ä½œ <code>run_full_pipeline()</code> æ–¹æ³•</li>
<li>[ ] æ•´åˆéŒ¯èª¤è™•ç†èˆ‡å‚³æ’­é‚è¼¯</li>
</ul>
<h3 id="phase-3-cli-day-3">Phase 3: CLI èˆ‡å…¥å£ (Day 3)</h3>
<ul>
<li>[ ] å¯¦ä½œ <code>HVACCLI</code> (Fire æ¡†æ¶)</li>
<li>[ ] å¯¦ä½œ <code>run_etl</code> å‘½ä»¤</li>
<li>[ ] å…¨åŸŸéŒ¯èª¤è™•ç†èˆ‡ä½¿ç”¨è€…è¨Šæ¯</li>
</ul>
<h3 id="phase-4-day-4">Phase 4: æ•´åˆæ¸¬è©¦ (Day 4)</h3>
<ul>
<li>[ ] åŸ·è¡Œ INT-SYS-001~008 å…¨éˆè·¯æ¸¬è©¦</li>
<li>[ ] é©—è­‰ç‰ˆæœ¬ç›¸å®¹æ€§çŸ©é™£</li>
<li>[ ] æ•ˆèƒ½æ¸¬è©¦ (å¤§æª”æ¡ˆè™•ç†)</li>
</ul>
<hr />
<h2 id="10-sign-off-checklist">10. é©—æ”¶ç°½æ ¸ (Sign-off Checklist)</h2>
<ul>
<li>[ ] <strong>SSOT ä¸€è‡´æ€§</strong>: <code>VALID_QUALITY_FLAGS</code> å–®ä¸€å®šç¾©ï¼Œæ‰€æœ‰æ¨¡çµ„å¼•ç”¨</li>
<li>[ ] <strong>é…ç½®è¼‰å…¥</strong>: <code>ConfigLoader</code> æ­£ç¢ºé©—è­‰ SSOTï¼Œé˜»æ“‹ä¸ä¸€è‡´é…ç½®</li>
<li>[ ] <strong>DI å®¹å™¨</strong>: <code>ETLContainer</code> æ­£ç¢ºç®¡ç†æ¨¡çµ„ç”Ÿå‘½å‘¨æœŸï¼ŒSingleton ç”Ÿæ•ˆ</li>
<li>[ ] <strong>å…¨éˆè·¯åŸ·è¡Œ</strong>: <code>run_full_pipeline()</code> æˆåŠŸåŸ·è¡Œ Parser â†’ Cleaner â†’ BP â†’ FE</li>
<li>[ ] <strong>éŒ¯èª¤å‚³æ’­</strong>: <code>ContractViolationError</code> æ­£ç¢ºçµ‚æ­¢æµç¨‹ä¸¦æä¾›æ˜ç¢ºè¨Šæ¯</li>
<li>[ ] <strong>æ™‚å€ä¸€è‡´æ€§</strong>: å…¨éˆè·¯æ™‚é–“æˆ³ç‚º UTC (ns)ï¼Œç„¡ Asia/Taipei æ®˜ç•™</li>
<li>[ ] <strong>Metadata å‚³é</strong>: <code>feature_metadata</code> æ­£ç¢ºå¾ Cleaner å‚³éè‡³ FE (GAP #3)</li>
<li>[ ] <strong>CLI åŠŸèƒ½</strong>: <code>python main.py run_etl</code> æˆåŠŸåŸ·è¡Œä¸¦è¼¸å‡º Feature Matrix</li>
<li>[ ] <strong>ç‰ˆæœ¬ç›¸å®¹</strong>: ç›¸å®¹æ€§çŸ©é™£æ¸¬è©¦é€šéï¼ŒèˆŠç‰ˆæ¨¡çµ„æ­£ç¢ºæ‹’çµ•æˆ–é™ç´š</li>
</ul>
<hr />
</body>
</html>