
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PRD_BATCH_PROCESSOR_v1.3</title>
    
<style>
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
        line-height: 1.6; 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        color: #24292e; 
        background-color: #ffffff;
    }
    h1, h2, h3, h4, h5, h6 { 
        margin-top: 24px; 
        margin-bottom: 16px; 
        font-weight: 600; 
        color: #24292e;
    }
    h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h3 { font-size: 1.25em; }
    p { margin-top: 0; margin-bottom: 16px; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { 
        display: block; 
        width: 100%; 
        overflow: auto; 
        border-spacing: 0; 
        border-collapse: collapse; 
        margin-bottom: 16px; 
    }
    table th, table td { 
        padding: 6px 13px; 
        border: 1px solid #dfe2e5; 
    }
    table th { 
        font-weight: 600; 
        background-color: #f6f8fa; 
    }
    table tr:nth-child(2n) { 
        background-color: #f6f8fa; 
    }
    code { 
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace; 
        background-color: #f6f8fa; 
        padding: 0.2em 0.4em; 
        border-radius: 3px; 
        font-size: 85%; 
    }
    pre { 
        background-color: #f6f8fa; 
        padding: 16px; 
        overflow: auto; 
        border-radius: 3px; 
        line-height: 1.45; 
    }
    pre code { 
        background-color: transparent; 
        padding: 0; 
        border-radius: 0; 
    }
    blockquote { 
        border-left: 0.25em solid #dfe2e5; 
        color: #6a737d; 
        padding: 0 1em; 
        margin: 0 0 16px 0; 
    }
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
    }
    .mermaid {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
</style>

</head>
<body>
    <h1 id="prd-v13-batchprocessor-implementation-guide">PRD v1.3: æ‰¹æ¬¡è™•ç†å™¨å¼·å¥æ€§é‡æ§‹æŒ‡å— (BatchProcessor Implementation Guide)</h1>
<h1 id="feature-annotation-v12metadata">æ•´åˆ Feature Annotation v1.2ï¼šMetadata å‚³éèˆ‡ç¨½æ ¸è»Œè·¡</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.3-FA (Feature Annotation Alignment &amp; Audit Trail Preservation)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/etl/batch_processor.py</code> (v1.3+)<br />
<strong>ä¸Šæ¸¸å¥‘ç´„:</strong> <code>src/etl/cleaner.py</code> (v2.2+, æª¢æŸ¥é» #2)<br />
<strong>ä¸‹æ¸¸å¥‘ç´„:</strong> <code>src/etl/feature_engineer.py</code> (v1.3+, æª¢æŸ¥é» #3)<br />
<strong>é—œéµç›¸ä¾:</strong> <code>src/features/annotation_manager.py</code> (v1.2+, æä¾›ç¹¼æ‰¿éˆèˆ‡ç‰ˆæœ¬è³‡è¨Š)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 5 ~ 6 å€‹å·¥ç¨‹å¤©ï¼ˆå« Annotation ç¨½æ ¸è»Œè·¡èˆ‡æ•´åˆæ¸¬è©¦ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆå“²å­¸</h2>
<h3 id="11-v12-v13-fa">1.1 ç‰ˆæœ¬è®Šæ›´ç¸½è¦½ (v1.2 â†’ v1.3-FA)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">è®Šæ›´é¡åˆ¥</th>
<th style="text-align: left;">v1.2 ç‹€æ…‹</th>
<th style="text-align: left;">v1.3-FA ä¿®æ­£</th>
<th style="text-align: center;">å½±éŸ¿å±¤ç´š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Metadata å‚³é</strong></td>
<td style="text-align: left;">Manifest ç„¡ <code>feature_metadata</code></td>
<td style="text-align: left;"><strong>å¼·åˆ¶åŒ…å«</strong> <code>feature_metadata</code> (ä¸å« device_roleï¼Œåƒ…ç‰©ç†å±¬æ€§)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Annotation ç¨½æ ¸è»Œè·¡</strong></td>
<td style="text-align: left;">ç„¡ç‰ˆæœ¬è¨˜éŒ„</td>
<td style="text-align: left;"><strong>æ–°å¢</strong> <code>annotation_audit_trail</code> (schema_version, checksum, inheritance_chain)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E406 æª¢æŸ¥é»</strong></td>
<td style="text-align: left;">ç„¡åŒæ­¥æª¢æŸ¥</td>
<td style="text-align: left;"><strong>æ–°å¢</strong> Excel/YAML åŒæ­¥é©—è­‰ (æª¢æŸ¥é» #5 å»¶ä¼¸)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Leakage é˜²è­·</strong></td>
<td style="text-align: left;">ç„¡æœªä¾†è³‡æ–™æª¢æŸ¥</td>
<td style="text-align: left;"><strong>ä¿ç•™</strong> <code>_check_future_data()</code> (E205)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Parquet Schema é©—è­‰</strong></td>
<td style="text-align: left;">åƒ…å¯«å…¥æ™‚æª¢æŸ¥</td>
<td style="text-align: left;"><strong>å¯«å…¥å¾Œå¼·åˆ¶é©—è­‰</strong> INT64/UTC (E206)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è·è²¬åˆ†é›¢</strong></td>
<td style="text-align: left;">ç„¡æ˜ç¢ºè¦ç¯„</td>
<td style="text-align: left;"><strong>æ˜ç¢º</strong>ï¼šBatchProcessor ä¸è™•ç† device_role é‚è¼¯ï¼Œåƒ…è¨˜éŒ„ Annotation ç‰ˆæœ¬è³‡è¨Š</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 æ ¸å¿ƒè¨­è¨ˆåŸå‰‡</h3>
<ol>
<li><strong>Metadata é›¶éºå¤±ï¼Œè·è²¬æ¸…æ™°</strong>ï¼šæ¥æ”¶ Cleaner å‚³éçš„ <code>column_metadata</code>ï¼ˆåƒ…å« physical_type/unitï¼Œä¸å« device_roleï¼‰ï¼Œå®Œæ•´å¯«å…¥ Manifestï¼Œä¾›ä¸‹æ¸¸ Feature Engineer å°ç…§ Annotation SSOT</li>
<li><strong>ç¨½æ ¸è»Œè·¡å®Œæ•´æ€§</strong>ï¼šManifest å¿…é ˆè¨˜éŒ„ Feature Annotation çš„ schema_versionã€excel_checksumã€inheritance_chainï¼Œç¢ºä¿è³‡æ–™è™•ç†éç¨‹å¯å›æº¯</li>
<li><strong>SSOT ç‰ˆæœ¬é–å®š</strong>ï¼šå¯«å…¥ Manifest æ™‚è¨˜éŒ„ç•¶å‰ä½¿ç”¨çš„ <code>VALID_QUALITY_FLAGS</code> èˆ‡ Annotation schema å¿«ç…§ï¼Œé˜²æ­¢ç‰ˆæœ¬æ¼‚ç§»</li>
<li><strong>E406 å‰ç½®é˜²è­·</strong>ï¼šåœ¨ Pipeline å•Ÿå‹•æ™‚æª¢æŸ¥ Excel/YAML åŒæ­¥ç‹€æ…‹ï¼ˆè‹¥ <code>enforce_annotation_sync=True</code>ï¼‰</li>
<li><strong>é›¶è¤‡è£½éŠœæ¥</strong>ï¼šCleaner v2.2 è¼¸å‡ºçš„ DataFrame ä¸å« device_roleï¼ŒBatchProcessor ä¸æ‡‰æ·»åŠ ä»»ä½• Annotation é‚è¼¯æ¬„ä½ï¼Œåƒ…å‚³éç‰ˆæœ¬è³‡è¨Šè‡³ Manifest</li>
</ol>
<hr />
<h2 id="2-interface-contracts">2. ä»‹é¢å¥‘ç´„è¦ç¯„ (Interface Contracts)</h2>
<h3 id="21-input-contract-from-cleaner-v22">2.1 è¼¸å…¥å¥‘ç´„ (Input Contract from Cleaner v2.2)</h3>
<p><strong>æª¢æŸ¥é» #2: Cleaner â†’ BatchProcessor</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">æª¢æŸ¥é …</th>
<th style="text-align: left;">è¦ç¯„</th>
<th style="text-align: left;">å®¹éŒ¯è™•ç†</th>
<th style="text-align: center;">éŒ¯èª¤ä»£ç¢¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>timestamp</code></td>
<td style="text-align: left;"><code>Datetime(UTC, ns)</code></td>
<td style="text-align: left;">è‹¥ä¸ç¬¦ï¼Œå˜—è©¦è½‰æ›æˆ–æ‹’çµ•</td>
<td style="text-align: center;">E201</td>
</tr>
<tr>
<td style="text-align: left;"><code>quality_flags</code></td>
<td style="text-align: left;"><code>List[str]</code>ï¼Œå€¼ âŠ† <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: left;">æ‹’çµ•å¯«å…¥ï¼Œæç¤ºæ›´æ–° SSOT</td>
<td style="text-align: center;">E202</td>
</tr>
<tr>
<td style="text-align: left;"><code>column_metadata</code></td>
<td style="text-align: left;"><code>Dict[str, ColumnMeta]</code> (ç‰©ç†å±¬æ€§)</td>
<td style="text-align: left;">è‹¥ç¼ºå¤±ï¼Œä½¿ç”¨ä¿å®ˆé è¨­</td>
<td style="text-align: center;">E203 (Warning)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role æ¬„ä½</strong></td>
<td style="text-align: left;"><strong>ç¦æ­¢å­˜åœ¨æ–¼ DataFrame</strong></td>
<td style="text-align: left;">è‹¥ç™¼ç¾ï¼Œæ‹‹å‡º E500 (å¥‘ç´„é•å)</td>
<td style="text-align: center;"><strong>E500</strong></td>
</tr>
<tr>
<td style="text-align: left;">æ™‚é–“é€£çºŒæ€§</td>
<td style="text-align: left;"><code>temporal_continuity</code> æ¨™è¨˜</td>
<td style="text-align: left;">è¨˜éŒ„æ–¼ Manifestï¼Œä¸é˜»æ–·è™•ç†</td>
<td style="text-align: center;">-</td>
</tr>
</tbody>
</table>
<p><strong>é—œéµç´„æŸ</strong>ï¼š
- ğŸ”´ <strong>è¼¸å…¥ DataFrame ä¸å¾—åŒ…å« device_role</strong>ï¼šCleaner v2.2 å·²ç¢ºä¿è¼¸å‡ºä¸å« device_roleï¼ŒBatchProcessor éœ€é©—è­‰æ­¤å¥‘ç´„
- ğŸŸ¡ <strong>column_metadata åƒ…å«ç‰©ç†å±¬æ€§</strong>ï¼š<code>physical_type</code>, <code>unit</code>, <code>description</code>ï¼Œ<strong>ä¸å¾—</strong>åŒ…å« <code>device_role</code>, <code>ignore_warnings</code></p>
<h3 id="22-output-contract-to-feature-engineer-v13">2.2 è¼¸å‡ºå¥‘ç´„ (Output Contract to Feature Engineer v1.3)</h3>
<p><strong>æª¢æŸ¥é» #3: BatchProcessor â†’ Feature Engineer</strong></p>
<p><strong>Manifest çµæ§‹ (v1.3-FA é—œéµæ“´å……)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Manifest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;BatchProcessor v1.3-FA Manifest çµæ§‹ (Interface Contract v1.0 #3)&quot;&quot;&quot;</span>

    <span class="c1"># åŸºç¤è³‡è¨Š</span>
    <span class="n">manifest_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.3-FA&quot;</span>
    <span class="n">batch_id</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># UUID v4</span>
    <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span>                     <span class="c1"># æ¡ˆå ´è­˜åˆ¥ (å¦‚ &quot;cgmh_ty&quot;)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>             <span class="c1"># ISO 8601 UTC</span>

    <span class="c1"># ã€é—œéµã€‘Feature Metadata å‚³é (ä¾†è‡ª Cleanerï¼Œä¸å« device_role)</span>
    <span class="n">feature_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureMetadata</span><span class="p">]</span>
    <span class="c1"># ç¯„ä¾‹: {&quot;chiller_1_load&quot;: {&quot;physical_type&quot;: &quot;chiller_load&quot;, &quot;unit&quot;: &quot;RT&quot;}}</span>
    <span class="c1"># âŒ ç¦æ­¢åŒ…å«: device_role, ignore_warnings (é€™äº›ç”± FE ç›´æ¥è®€å– Annotation)</span>

    <span class="c1"># ã€æ–°å¢ã€‘Annotation ç¨½æ ¸è»Œè·¡ (ä¾›å›æº¯èˆ‡ç‰ˆæœ¬é©—è­‰)</span>
    <span class="n">annotation_audit_trail</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;template_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yaml_checksum&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:abc123...&quot;</span><span class="p">,</span>      <span class="c1"># Excel ä¾†æºæª”æ¡ˆé›œæ¹Š</span>
        <span class="s2">&quot;inheritance_chain&quot;</span><span class="p">:</span> <span class="s2">&quot;base -&gt; cgmh_ty&quot;</span><span class="p">,</span>   <span class="c1"># ç¹¼æ‰¿éˆè³‡è¨Š</span>
        <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2026-02-13T10:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;editor&quot;</span><span class="p">:</span> <span class="s2">&quot;ç‹å·¥ç¨‹å¸«&quot;</span>
    <span class="p">}</span>

    <span class="c1"># SSOT å¿«ç…§ (ç‰ˆæœ¬ç›¸å®¹æ€§æª¢æŸ¥)</span>
    <span class="n">quality_flags_schema</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>  <span class="c1"># ç•¶å‰ä½¿ç”¨çš„ VALID_QUALITY_FLAGS å¿«ç…§</span>
    <span class="n">timestamp_schema</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>        <span class="c1"># æ™‚é–“æˆ³è¦ç¯„å¿«ç…§</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;INT64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;nanoseconds&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC&quot;</span>
    <span class="p">}</span>

    <span class="c1"># è¼¸å‡ºæª”æ¡ˆè³‡è¨Š</span>
    <span class="n">output_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>          <span class="c1"># ç›¸å°è·¯å¾‘åˆ—è¡¨</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;parquet&quot;</span>
    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span>

    <span class="c1"># è³‡æ–™çµ±è¨ˆ</span>
    <span class="n">statistics</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_rows&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;total_cols&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;time_range&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
        <span class="s2">&quot;null_percent&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;files_count&quot;</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">}</span>

    <span class="c1"># è³‡æ–™å®Œæ•´æ€§é©—è­‰</span>
    <span class="n">checksum</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># Manifest æœ¬èº« checksum (SHA256)</span>
    <span class="n">file_checksums</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>   <span class="c1"># filename â†’ SHA256</span>
</code></pre></div>

<p><strong>Parquet è¼¸å‡ºè¦ç¯„</strong>:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¬„ä½</th>
<th style="text-align: left;">ç‰©ç†å‹åˆ¥</th>
<th style="text-align: left;">é‚è¼¯å‹åˆ¥</th>
<th style="text-align: left;">é™åˆ¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>timestamp</code></td>
<td style="text-align: left;"><code>INT64</code></td>
<td style="text-align: left;"><code>Timestamp(nanoseconds, UTC)</code></td>
<td style="text-align: left;">ç¦æ­¢ INT96</td>
</tr>
<tr>
<td style="text-align: left;"><code>quality_flags</code></td>
<td style="text-align: left;"><code>BYTE_ARRAY</code> (JSON)</td>
<td style="text-align: left;"><code>List(Utf8)</code></td>
<td style="text-align: left;">ä»¥ JSON string å­˜å„²ï¼ŒPolars è®€å–æ™‚è§£æ</td>
</tr>
<tr>
<td style="text-align: left;">æ•¸å€¼æ¬„ä½</td>
<td style="text-align: left;"><code>DOUBLE</code></td>
<td style="text-align: left;"><code>Float64</code></td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role</strong></td>
<td style="text-align: left;"><strong>ç¦æ­¢å­˜åœ¨</strong></td>
<td style="text-align: left;">-</td>
<td style="text-align: left;"><strong>ä¸å¾—å¯«å…¥ Parquet metadata æˆ– DataFrame</strong></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-phase-based-implementation">3. åˆ†éšæ®µå¯¦ä½œè¨ˆç•« (Phase-Based Implementation)</h2>
<h3 id="phase-0-annotation-day-1">Phase 0: Annotation ç¨½æ ¸è»Œè·¡åŸºç¤å»ºè¨­ (Day 1, æ–°å¢)</h3>
<h4 id="step-01-ssot-annotationmetadata">Step 0.1: SSOT åš´æ ¼å¼•ç”¨èˆ‡ AnnotationMetadata æ³¨å…¥</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/batch_processor.py</code> (é ‚éƒ¨)</p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Final</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span>

<span class="c1"># ã€é—œéµã€‘SSOT åš´æ ¼å¼•ç”¨</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.config_models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">VALID_QUALITY_FLAGS</span><span class="p">,</span>      <span class="c1"># SSOT: 6å€‹æ¨™æº–å“è³ªæ¨™è¨˜</span>
    <span class="n">TIMESTAMP_CONFIG</span><span class="p">,</span>         <span class="c1"># SSOT: UTC, ns, INT64</span>
    <span class="n">FeatureMetadata</span><span class="p">,</span>          <span class="c1"># SSOT: æ¬„ä½å…ƒè³‡æ–™çµæ§‹ (å·²ç§»é™¤ device_role)</span>
    <span class="n">BatchConfig</span><span class="p">,</span>             
    <span class="n">ETLConfig</span><span class="p">,</span>
    <span class="n">FEATURE_ANNOTATION_CONSTANTS</span>  <span class="c1"># ã€æ–°å¢ã€‘Annotation å¸¸æ•¸</span>
<span class="p">)</span>

<span class="c1"># ã€æ–°å¢ã€‘Annotation ç¨½æ ¸è»Œè·¡</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.features.annotation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureAnnotationManager</span>

<span class="c1"># éŒ¯èª¤ä»£ç¢¼å¸¸æ•¸ (Interface Contract v1.0)</span>
<span class="n">ERROR_CODES</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;E201&quot;</span><span class="p">:</span> <span class="s2">&quot;SCHEMA_MISMATCH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E202&quot;</span><span class="p">:</span> <span class="s2">&quot;UNKNOWN_QUALITY_FLAG&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;E203&quot;</span><span class="p">:</span> <span class="s2">&quot;METADATA_LOSS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E205&quot;</span><span class="p">:</span> <span class="s2">&quot;FUTURE_DATA_DETECTED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E206&quot;</span><span class="p">:</span> <span class="s2">&quot;PARQUET_FORMAT_VIOLATION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E406&quot;</span><span class="p">:</span> <span class="s2">&quot;EXCEL_YAML_OUT_OF_SYNC&quot;</span><span class="p">,</span>  <span class="c1"># ã€æ–°å¢ã€‘åŒæ­¥éŒ¯èª¤</span>
    <span class="s2">&quot;E500&quot;</span><span class="p">:</span> <span class="s2">&quot;DEVICE_ROLE_LEAKAGE&quot;</span>      <span class="c1"># ã€æ–°å¢ã€‘è·è²¬é•å</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="step-02-annotationmetadata">Step 0.2: å»ºæ§‹å­èˆ‡ AnnotationMetadata æ³¨å…¥</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/batch_processor.py</code> (<code>BatchOrchestrator.__init__</code>)</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BatchOrchestrator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    BatchProcessor v1.3-FA - æ•´åˆ Feature Annotation ç¨½æ ¸è»Œè·¡</span>

<span class="sd">    æ ¸å¿ƒè·è²¬ï¼š</span>
<span class="sd">    1. æ¥æ”¶ Cleaner è¼¸å‡ºï¼ˆä¸å« device_role çš„ DataFrame + column_metadataï¼‰</span>
<span class="sd">    2. å°‡ Annotation ç¨½æ ¸è³‡è¨Šï¼ˆç‰ˆæœ¬ã€checksumã€ç¹¼æ‰¿éˆï¼‰å¯«å…¥ Manifest</span>
<span class="sd">    3. åŸ·è¡Œ E406 åŒæ­¥æª¢æŸ¥ï¼ˆè‹¥å•Ÿç”¨ï¼‰</span>
<span class="sd">    4. ç¢ºä¿è¼¸å‡º Parquet ä¸å« device_role æ¬„ä½æˆ– metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">ETLConfig</span><span class="p">,</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">ReportParser</span><span class="p">,</span>
        <span class="n">cleaner</span><span class="p">:</span> <span class="n">DataCleaner</span><span class="p">,</span>
        <span class="n">annotation_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ã€æ–°å¢ã€‘ä¾†è‡ª Container çš„ Annotation è³‡è¨Š</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaner</span> <span class="o">=</span> <span class="n">cleaner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_metadata</span> <span class="o">=</span> <span class="n">annotation_metadata</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># ç¨½æ ¸è»Œè·¡è³‡è¨Š</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;BatchOrchestrator&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">site_id</span>

        <span class="c1"># ã€æ–°å¢ã€‘E406 æª¢æŸ¥ï¼šè‹¥å•Ÿç”¨åš´æ ¼åŒæ­¥ï¼Œæª¢æŸ¥ Excel/YAML ç‹€æ…‹</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">enforce_annotation_sync</span> <span class="ow">and</span> <span class="n">annotation_metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_annotation_sync</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_annotation_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        E406 æª¢æŸ¥ï¼šç¢ºä¿ä½¿ç”¨çš„ YAML èˆ‡ Excel åŒæ­¥</span>
<span class="sd">        æ­¤æª¢æŸ¥åœ¨ Container åˆå§‹åŒ–æ™‚å·²åŸ·è¡Œï¼Œæ­¤è™•ç‚ºäºŒæ¬¡ç¢ºèª</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.config_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigLoader</span>

        <span class="n">fa_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span>
        <span class="n">sync_status</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">validate_annotation_sync</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
            <span class="n">fa_config</span><span class="o">.</span><span class="n">excel_base_dir</span><span class="p">,</span>
            <span class="n">fa_config</span><span class="o">.</span><span class="n">yaml_base_dir</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sync_status</span><span class="p">[</span><span class="s1">&#39;synced&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">AnnotationSyncError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;E406: </span><span class="si">{</span><span class="n">sync_status</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;è«‹åŸ·è¡Œ: python main.py features validate-annotation --site </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… E406: Excel/YAML åŒæ­¥æª¢æŸ¥é€šé&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h3 id="phase-1-day-1">Phase 1: è¼¸å…¥å¥‘ç´„é©—è­‰èˆ‡è·è²¬åˆ†é›¢æª¢æŸ¥ (Day 1, æ›´æ–°)</h3>
<h4 id="step-11-device_role">Step 1.1: è¼¸å…¥å¥‘ç´„é©—è­‰ï¼ˆå« device_role æ´©æ¼æª¢æŸ¥ï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_validate_input_contract(df: pl.DataFrame) -&gt; None</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_validate_input_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    é©—è­‰ Cleaner v2.2 è¼¸å…¥å¥‘ç´„ (Interface Contract #2)</span>

<span class="sd">    é©—è­‰é …ç›®:</span>
<span class="sd">    1. quality_flags å‹åˆ¥èˆ‡å€¼åŸŸ</span>
<span class="sd">    2. timestamp åŸºç¤æª¢æŸ¥</span>
<span class="sd">    3. ã€é—œéµã€‘ç¦æ­¢ device_role æ¬„ä½å­˜åœ¨ (E500)</span>
<span class="sd">    4. æœªä¾†è³‡æ–™æª¢æŸ¥ (E205)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 1. quality_flags é©—è­‰ (E202)</span>
    <span class="k">if</span> <span class="s2">&quot;quality_flags&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">qf_dtype</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qf_dtype</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;quality_flags å¿…é ˆç‚º List å‹åˆ¥ï¼Œå¾—åˆ° </span><span class="si">{</span><span class="n">qf_dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">actual_flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">flags</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">flags</span><span class="p">:</span>
                    <span class="n">actual_flags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

            <span class="n">invalid_flags</span> <span class="o">=</span> <span class="n">actual_flags</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">VALID_QUALITY_FLAGS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invalid_flags</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;E202: è¼¸å…¥åŒ…å«æœªå®šç¾©çš„å“è³ªæ¨™è¨˜: </span><span class="si">{</span><span class="n">invalid_flags</span><span class="si">}</span><span class="s2">ã€‚&quot;</span>
                <span class="p">)</span>

    <span class="c1"># 2. ã€é—œéµã€‘è·è²¬åˆ†é›¢æª¢æŸ¥ï¼šç¦æ­¢ device_role æ¬„ä½ (E500)</span>
    <span class="n">forbidden_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;device_role&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore_warnings&quot;</span><span class="p">,</span> <span class="s2">&quot;is_target&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">forbidden_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;E500: ç™¼ç¾ç¦æ­¢æ¬„ä½ &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;ã€‚Cleaner v2.2 ä¸æ‡‰å°‡ Annotation å…ƒè³‡æ–™&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;å¯«å…¥ DataFrameï¼Œé€™äº›è³‡è¨Šæ‡‰ç”± Feature Engineer ç›´æ¥è®€å– YAML SSOTã€‚&quot;</span>
            <span class="p">)</span>

    <span class="c1"># 3. æœªä¾†è³‡æ–™æª¢æŸ¥ (E205)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_check_future_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è¼¸å…¥å¥‘ç´„é©—è­‰å¤±æ•—: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;è¼¸å…¥å¥‘ç´„é©—è­‰é€šéï¼šæœªç™¼ç¾ device_role ç­‰ç¦æ­¢æ¬„ä½&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h3 id="phase-2-parquet-day-2-3">Phase 2: äº‹å‹™æ€§è¼¸å‡ºèˆ‡ Parquet å¯«å…¥ (Day 2-3)</h3>
<h4 id="step-21-23-prd-schema">Step 2.1-2.3: ï¼ˆèˆ‡åŸ PRD åŸºæœ¬ä¸€è‡´ï¼Œä½†å¼·åŒ– Schema é©—è­‰ï¼‰</h4>
<p><strong>é—œéµæ›´æ–°</strong>ï¼šåœ¨ <code>_verify_parquet_schema</code> ä¸­æ–°å¢å° <strong>device_role æ¬„ä½</strong>çš„æª¢æŸ¥</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_verify_parquet_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    é©—è­‰ Parquet æª”æ¡ˆç¬¦åˆ INT64/UTC è¦ç¯„ï¼Œä¸”ä¸å« device_role (E206/E500)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">ParquetFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">schema</span>

    <span class="c1"># 1. é©—è­‰ timestamp æ¬„ä½ (INT64/UTC/NANOS)</span>
    <span class="n">ts_field</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">field_by_name</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ts_field</span><span class="o">.</span><span class="n">physical_type</span> <span class="o">==</span> <span class="s2">&quot;INT96&quot;</span><span class="p">:</span>
        <span class="n">file_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E206: Parquet ä½¿ç”¨å·²æ£„ç”¨çš„ INT96 æ ¼å¼&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ts_field</span><span class="o">.</span><span class="n">physical_type</span> <span class="o">!=</span> <span class="s2">&quot;INT64&quot;</span><span class="p">:</span>
        <span class="n">file_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E206: æ™‚é–“æˆ³ç‰©ç†å‹åˆ¥å¿…é ˆç‚º INT64&quot;</span><span class="p">)</span>

    <span class="n">lt</span> <span class="o">=</span> <span class="n">ts_field</span><span class="o">.</span><span class="n">logical_type</span>
    <span class="k">if</span> <span class="n">lt</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;TIMESTAMP&quot;</span> <span class="ow">or</span> <span class="n">lt</span><span class="o">.</span><span class="n">unit</span> <span class="o">!=</span> <span class="s2">&quot;NANOS&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lt</span><span class="o">.</span><span class="n">is_adjusted_to_utc</span><span class="p">:</span>
        <span class="n">file_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E206: æ™‚é–“æˆ³å¿…é ˆç‚º UTC Nanoseconds&quot;</span><span class="p">)</span>

    <span class="c1"># 2. ã€æ–°å¢ã€‘é©—è­‰ç„¡ device_role æ¬„ä½ (E500)</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">num_columns</span><span class="p">)]</span>
    <span class="k">if</span> <span class="s2">&quot;device_role&quot;</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
        <span class="n">file_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;E500: Parquet æª”æ¡ˆåŒ…å«ç¦æ­¢æ¬„ä½ &#39;device_role&#39;ã€‚ &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;BatchProcessor ä¸æ‡‰å°‡ device_role å¯«å…¥è¼¸å‡ºæª”æ¡ˆã€‚&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Schema é©—è­‰é€šé: INT64/UTC/NANOSï¼Œç„¡ device_role&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h3 id="phase-3-manifest-annotation-day-3-4">Phase 3: Manifest ç”Ÿæˆèˆ‡ Annotation ç¨½æ ¸è»Œè·¡ (Day 3-4, é—œéµæ›´æ–°)</h3>
<h4 id="step-31-manifest-annotation-audit-trail">Step 3.1: Manifest ç”Ÿæˆï¼ˆå« Annotation Audit Trailï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_generate_manifest(df: pl.DataFrame, column_metadata: Dict, output_files: List[str]) -&gt; Manifest</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_generate_manifest</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
    <span class="n">column_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureMetadata</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Manifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ç”Ÿæˆ Manifest (Interface Contract #3)</span>

<span class="sd">    ã€é—œéµã€‘æ•´åˆ Annotation ç¨½æ ¸è»Œè·¡ï¼Œä½† feature_metadata ä¸å« device_role</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># è‹¥ä¸Šæ¸¸æœªæä¾› metadataï¼Œä½¿ç”¨ä¿å®ˆé è¨­ (E203 Warning)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">column_metadata</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;E203: æœªæ¥æ”¶åˆ° column_metadataï¼Œä½¿ç”¨ä¿å®ˆé è¨­ (physical_type=&#39;gauge&#39;)ã€‚ &quot;</span>
            <span class="s2">&quot;å»ºè­°å‡ç´šè‡³ Cleaner v2.2+ ä»¥å‚³éå®Œæ•´ metadataã€‚&quot;</span>
        <span class="p">)</span>
        <span class="n">column_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_metadata_conservative</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># ã€é—œéµã€‘ç¢ºä¿ column_metadata ä¸å« device_roleï¼ˆäºŒæ¬¡é˜²è­·ï¼‰</span>
    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">column_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;device_role&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;device_role&#39;</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;E500: column_metadata åŒ…å« device_roleã€‚ &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Cleaner ä¸æ‡‰å‚³é device_role è‡³ BatchProcessorã€‚&quot;</span>
            <span class="p">)</span>

    <span class="c1"># è¨ˆç®—çµ±è¨ˆè³‡è¨Š</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_rows&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
        <span class="s2">&quot;total_cols&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
        <span class="s2">&quot;time_range&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="s2">&quot;null_percent&quot;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">null_count</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span>
        <span class="s2">&quot;files_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_files</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># ã€æ–°å¢ã€‘å»ºæ§‹ Annotation ç¨½æ ¸è»Œè·¡</span>
    <span class="n">audit_trail</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_metadata</span><span class="p">:</span>
        <span class="n">audit_trail</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s2">&quot;template_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;template_version&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s2">&quot;yaml_checksum&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;yaml_checksum&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s2">&quot;inheritance_chain&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inheritance_chain&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">),</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_updated&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s2">&quot;editor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;æœªæä¾› Annotation Metadataï¼ŒManifest å°‡ç¼ºå°‘ç¨½æ ¸è»Œè·¡&quot;</span><span class="p">)</span>

    <span class="c1"># å»ºç«‹ Manifest</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="n">Manifest</span><span class="p">(</span>
        <span class="n">batch_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_id</span><span class="p">,</span>
        <span class="n">site_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">feature_metadata</span><span class="o">=</span><span class="n">column_metadata</span><span class="p">,</span>  <span class="c1"># ã€é—œéµã€‘åƒ…å«ç‰©ç†å±¬æ€§ï¼Œä¸å« device_role</span>
        <span class="n">annotation_audit_trail</span><span class="o">=</span><span class="n">audit_trail</span><span class="p">,</span>  <span class="c1"># ã€æ–°å¢ã€‘ç¨½æ ¸è»Œè·¡</span>
        <span class="n">quality_flags_schema</span><span class="o">=</span><span class="n">VALID_QUALITY_FLAGS</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># SSOT å¿«ç…§</span>
        <span class="n">timestamp_schema</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;INT64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;nanoseconds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC&quot;</span>
        <span class="p">},</span>
        <span class="n">output_files</span><span class="o">=</span><span class="n">output_files</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">statistics</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span>
        <span class="n">file_checksums</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_file_checksums</span><span class="p">(</span><span class="n">output_files</span> <span class="ow">or</span> <span class="p">[])</span>
    <span class="p">)</span>

    <span class="c1"># è¨ˆç®— Manifest è‡ªèº« checksum</span>
    <span class="n">manifest</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">compute_checksum</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Manifest ç”Ÿæˆå®Œæˆ: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Annotation: </span><span class="si">{</span><span class="n">audit_trail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;ç¹¼æ‰¿éˆ: </span><span class="si">{</span><span class="n">audit_trail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inheritance_chain&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">manifest</span>
</code></pre></div>

<h4 id="step-32-feature-engineer">Step 3.2: ä¸‹æ¸¸éŠœæ¥è¦ç¯„ï¼ˆFeature Engineer è®€å–æ–¹å¼ï¼‰</h4>
<p><strong>æ–‡ä»¶è¦ç¯„</strong>: Feature Engineer å¿…é ˆé€é Manifest è®€å–ï¼Œä¸¦ç›´æ¥æŸ¥è©¢ Annotation SSOT å–å¾— device_role</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Feature Engineer v1.3 çš„æ¨™æº–è®€å–æ–¹å¼</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_from_batch_processor</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å¾ BatchProcessor v1.3-FA è¼¸å‡ºè®€å–è³‡æ–™ã€Metadata èˆ‡ç¨½æ ¸è»Œè·¡</span>

<span class="sd">    Returns:</span>
<span class="sd">        df: LazyFrame (Parquet è³‡æ–™ï¼Œä¸å« device_role)</span>
<span class="sd">        feature_metadata: Dict (ç‰©ç†å±¬æ€§)</span>
<span class="sd">        annotation_audit_trail: Dict (ç‰ˆæœ¬èˆ‡ç¹¼æ‰¿è³‡è¨Š)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">)</span>

    <span class="c1"># 1. é©—è­‰ Manifest å®Œæ•´æ€§</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">manifest</span><span class="o">.</span><span class="n">validate_checksum</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">DataValidationError</span><span class="p">(</span><span class="s2">&quot;Manifest ææ¯€æˆ–é­ç¯¡æ”¹&quot;</span><span class="p">)</span>

    <span class="c1"># 2. ã€é—œéµã€‘é©—è­‰ SSOT ç‰ˆæœ¬ç›¸å®¹æ€§</span>
    <span class="k">if</span> <span class="n">manifest</span><span class="o">.</span><span class="n">quality_flags_schema</span> <span class="o">!=</span> <span class="n">VALID_QUALITY_FLAGS</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Manifest ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ flags: </span><span class="si">{</span><span class="n">manifest</span><span class="o">.</span><span class="n">quality_flags_schema</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># 3. ã€æ–°å¢ã€‘é©—è­‰ Annotation ç‰ˆæœ¬</span>
    <span class="n">audit</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">annotation_audit_trail</span>
    <span class="k">if</span> <span class="n">audit</span><span class="p">:</span>
        <span class="n">expected_ver</span> <span class="o">=</span> <span class="n">FEATURE_ANNOTATION_CONSTANTS</span><span class="p">[</span><span class="s1">&#39;expected_schema_version&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">audit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_ver</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;E400: Manifest çš„ Annotation ç‰ˆæœ¬éèˆŠ &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">audit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">expected_ver</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

    <span class="c1"># 4. è®€å–è³‡æ–™</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">manifest_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">output_files</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="c1"># 5. ã€é—œéµã€‘Feature Engineer ç›´æ¥è®€å– Annotation YAML å–å¾— device_role</span>
    <span class="c1"># è€Œéå¾ manifest.feature_metadataï¼ˆè©²è™•ä¸å« device_roleï¼‰</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">src.features.annotation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureAnnotationManager</span>
    <span class="n">annotation_manager</span> <span class="o">=</span> <span class="n">FeatureAnnotationManager</span><span class="p">(</span>
        <span class="n">site_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
        <span class="n">yaml_base_dir</span><span class="o">=</span><span class="s2">&quot;config/features/sites&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">manifest</span><span class="o">.</span><span class="n">feature_metadata</span><span class="p">,</span> <span class="n">audit</span><span class="p">,</span> <span class="n">annotation_manager</span>
</code></pre></div>

<hr />
<h3 id="phase-4-day-5">Phase 4: æ‰¹æ¬¡è™•ç†æµç¨‹æ•´åˆ (Day 5)</h3>
<h4 id="step-41">Step 4.1: ä¸»è™•ç†æµç¨‹ï¼ˆæ›´æ–°ç‰ˆï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>process_single_file(file_path: Path) -&gt; BatchResult</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BatchResult</span><span class="p">:</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &quot;success&quot;, &quot;failed&quot;, &quot;future_data_rejected&quot;, &quot;schema_invalid&quot;, &quot;sync_error&quot;</span>
    <span class="n">file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">manifest_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">annotation_audit_trail</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ã€æ–°å¢ã€‘å›å‚³ç¨½æ ¸è³‡è¨Š</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_single_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è™•ç†å–®ä¸€æª”æ¡ˆçš„å®Œæ•´æµç¨‹ (å« Annotation ç¨½æ ¸è»Œè·¡)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 1. è§£æ (Parser v2.1)</span>
        <span class="n">raw_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

        <span class="c1"># 2. æ¸…æ´— (Cleaner v2.2) - å›å‚³ä¸å« device_role çš„ metadata</span>
        <span class="n">clean_df</span><span class="p">,</span> <span class="n">column_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">raw_df</span><span class="p">)</span>

        <span class="c1"># 3. è¼¸å…¥å¥‘ç´„é©—è­‰ï¼ˆæª¢æŸ¥é» #2ï¼Œå« E500 device_role æª¢æŸ¥ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input_contract</span><span class="p">(</span><span class="n">clean_df</span><span class="p">)</span>

        <span class="c1"># 4. Data Leakage æª¢æŸ¥ (E205)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_future_data</span><span class="p">(</span><span class="n">clean_df</span><span class="p">)</span>

        <span class="c1"># 5. è¨­å®š Staging</span>
        <span class="n">staging_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_staging</span><span class="p">()</span>

        <span class="c1"># 6. å¯«å…¥ Parquet (å¼·åˆ¶ INT64/UTCï¼Œç„¡ device_role)</span>
        <span class="n">parquet_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_parquet_atomic</span><span class="p">(</span><span class="n">clean_df</span><span class="p">,</span> <span class="n">staging_path</span><span class="p">)</span>

        <span class="c1"># 7. ç”Ÿæˆ Manifestï¼ˆå« annotation_audit_trailï¼‰</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_manifest</span><span class="p">(</span>
            <span class="n">clean_df</span><span class="p">,</span> 
            <span class="n">column_metadata</span><span class="o">=</span><span class="n">column_metadata</span><span class="p">,</span>
            <span class="n">output_files</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data.parquet&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># 8. å¯«å…¥ Manifest</span>
        <span class="n">manifest_path</span> <span class="o">=</span> <span class="n">staging_path</span> <span class="o">/</span> <span class="s2">&quot;manifest.json&quot;</span>
        <span class="n">manifest_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1"># 9. è¨ˆç®—æª”æ¡ˆ checksums</span>
        <span class="n">manifest</span><span class="o">.</span><span class="n">file_checksums</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data.parquet&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_file_hash</span><span class="p">(</span><span class="n">parquet_file</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">manifest_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1"># 10. åŸå­ç§»å‹•è‡³è¼¸å‡ºç›®éŒ„</span>
        <span class="n">final_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomic_move_to_output</span><span class="p">(</span><span class="n">staging_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">BatchResult</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
            <span class="n">manifest_path</span><span class="o">=</span><span class="n">final_path</span> <span class="o">/</span> <span class="s2">&quot;manifest.json&quot;</span><span class="p">,</span>
            <span class="n">annotation_audit_trail</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">annotation_audit_trail</span>  <span class="c1"># ã€æ–°å¢ã€‘</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="n">AnnotationSyncError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># ã€æ–°å¢ã€‘E406</span>
        <span class="k">return</span> <span class="n">BatchResult</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;sync_error&quot;</span><span class="p">,</span>
            <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="n">FutureDataError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BatchResult</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;future_data_rejected&quot;</span><span class="p">,</span>
            <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="n">ContractViolationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># E202, E206, E500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;å¥‘ç´„é•å </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_staging</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">BatchResult</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;schema_invalid&quot;</span><span class="p">,</span>
            <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è™•ç†å¤±æ•— </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_staging</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">BatchResult</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
            <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-error-codes">4. éŒ¯èª¤ä»£ç¢¼å°ç…§è¡¨ (Error Codes)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤ä»£ç¢¼</th>
<th style="text-align: left;">åç¨±</th>
<th style="text-align: center;">ç™¼ç”Ÿéšæ®µ</th>
<th style="text-align: left;">èªªæ˜</th>
<th style="text-align: left;">è™•ç†å»ºè­°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>E201</strong></td>
<td style="text-align: left;"><code>INPUT_SCHEMA_MISMATCH</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">è¼¸å…¥ DataFrame Schema ä¸ç¬¦</td>
<td style="text-align: left;">æª¢æŸ¥ Cleaner è¼¸å‡ºè¨­å®š</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E202</strong></td>
<td style="text-align: left;"><code>UNKNOWN_QUALITY_FLAG</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">è¼¸å…¥å«æœªå®šç¾©çš„ quality_flags</td>
<td style="text-align: left;">åŒæ­¥æ›´æ–° SSOT</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E203</strong></td>
<td style="text-align: left;"><code>METADATA_LOSS</code></td>
<td style="text-align: center;">Step 3.1</td>
<td style="text-align: left;">æœªæ¥æ”¶åˆ° column_metadata</td>
<td style="text-align: left;">å‡ç´šè‡³ Cleaner v2.2+</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E205</strong></td>
<td style="text-align: left;"><code>FUTURE_DATA_DETECTED</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">è³‡æ–™æ™‚é–“è¶…éç¾åœ¨+5åˆ†é˜</td>
<td style="text-align: left;">æª¢æŸ¥è³‡æ–™ä¾†æºæ™‚é˜</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E206</strong></td>
<td style="text-align: left;"><code>PARQUET_FORMAT_VIOLATION</code></td>
<td style="text-align: center;">Step 2.1</td>
<td style="text-align: left;">Parquet æ ¼å¼é INT64/UTC</td>
<td style="text-align: left;">æª¢æŸ¥ use_pyarrow=False</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E406</strong></td>
<td style="text-align: left;"><code>EXCEL_YAML_OUT_OF_SYNC</code></td>
<td style="text-align: center;">Step 0.2</td>
<td style="text-align: left;">Excel èˆ‡ YAML ä¸åŒæ­¥</td>
<td style="text-align: left;">åŸ·è¡Œ validate-annotation</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E500</strong></td>
<td style="text-align: left;"><code>DEVICE_ROLE_LEAKAGE</code></td>
<td style="text-align: center;">Step 1.1/2.1</td>
<td style="text-align: left;">DataFrame æˆ– Metadata å« device_role</td>
<td style="text-align: left;">æª¢æŸ¥ Cleaner é‚è¼¯ï¼Œç¢ºä¿è·è²¬åˆ†é›¢</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-test-plan">5. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Test Plan)</h2>
<h3 id="51-unit-tests">5.1 å–®å…ƒæ¸¬è©¦ (Unit Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸçµæœ</th>
<th style="text-align: center;">å°æ‡‰ Step</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">BP13-FA-01</td>
<td style="text-align: left;">E406 åŒæ­¥æª¢æŸ¥</td>
<td style="text-align: left;">Excel è¼ƒæ–°</td>
<td style="text-align: left;">æ‹‹å‡º AnnotationSyncError</td>
<td style="text-align: center;">0.2</td>
</tr>
<tr>
<td style="text-align: left;">BP13-FA-02</td>
<td style="text-align: left;">device_role æ””æˆª</td>
<td style="text-align: left;">DataFrame å« device_role æ¬„ä½</td>
<td style="text-align: left;">æ‹‹å‡º E500</td>
<td style="text-align: center;">1.1</td>
</tr>
<tr>
<td style="text-align: left;">BP13-FA-03</td>
<td style="text-align: left;">Metadata ä¸å« device_role</td>
<td style="text-align: left;">column_metadata å« device_role</td>
<td style="text-align: left;">æ‹‹å‡º E500</td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;">BP13-FA-04</td>
<td style="text-align: left;">ç¨½æ ¸è»Œè·¡å®Œæ•´æ€§</td>
<td style="text-align: left;">æ­£å¸¸è™•ç†</td>
<td style="text-align: left;">Manifest å« inheritance_chain</td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;">BP13-FA-05</td>
<td style="text-align: left;">Parquet ç„¡ device_role</td>
<td style="text-align: left;">æ­£å¸¸å¯«å…¥å¾Œ</td>
<td style="text-align: left;">Schema é©—è­‰é€šéï¼Œç„¡ç¦æ­¢æ¬„ä½</td>
<td style="text-align: center;">2.1</td>
</tr>
<tr>
<td style="text-align: left;">BP13-001</td>
<td style="text-align: left;">INT64 å¼·åˆ¶é©—è­‰</td>
<td style="text-align: left;">æ¨¡æ“¬ INT96 å¯«å…¥</td>
<td style="text-align: left;">æ””æˆªä¸¦æ‹‹å‡º E206</td>
<td style="text-align: center;">2.1</td>
</tr>
<tr>
<td style="text-align: left;">BP13-002</td>
<td style="text-align: left;">æœªä¾†è³‡æ–™æ””æˆª</td>
<td style="text-align: left;">æ™‚é–“æˆ³ç‚ºæ˜å¤©</td>
<td style="text-align: left;">æ‹‹å‡º E205</td>
<td style="text-align: center;">1.1</td>
</tr>
</tbody>
</table>
<h3 id="52-integration-tests">5.2 æ•´åˆæ¸¬è©¦ (Integration Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: center;">ä¸Šæ¸¸</th>
<th style="text-align: center;">ä¸‹æ¸¸</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>INT-BP-FA-01</strong></td>
<td style="text-align: left;">E406 æª¢æŸ¥é»</td>
<td style="text-align: center;">Excel ä¿®æ”¹æœªç”Ÿæˆ YAML</td>
<td style="text-align: center;">BP v1.3</td>
<td style="text-align: left;">æ­£ç¢ºæ‹‹å‡º E406ï¼Œé˜»æ“‹è™•ç†</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-BP-FA-02</strong></td>
<td style="text-align: left;">Cleaner è·è²¬åˆ†é›¢</td>
<td style="text-align: center;">Cleaner v2.2 (ç„¡ device_role)</td>
<td style="text-align: center;">BP v1.3</td>
<td style="text-align: left;">æ­£ç¢ºæ¥æ”¶ï¼ŒManifest ç„¡ device_role</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-BP-FA-03</strong></td>
<td style="text-align: left;">ç¨½æ ¸è»Œè·¡å‚³é</td>
<td style="text-align: center;">BP v1.3 (å« inheritance_chain)</td>
<td style="text-align: center;">FE v1.3</td>
<td style="text-align: left;">FE æ­£ç¢ºè®€å–ç‰ˆæœ¬èˆ‡ç¹¼æ‰¿è³‡è¨Š</td>
</tr>
<tr>
<td style="text-align: left;">INT-B01</td>
<td style="text-align: left;">Cleaner v2.2 â†’ BP v1.3</td>
<td style="text-align: center;">Cleaner v2.2 (UTC, metadata)</td>
<td style="text-align: center;">BP v1.3</td>
<td style="text-align: left;">æ­£ç¢ºæ¥æ”¶ metadataï¼Œç„¡ E203</td>
</tr>
<tr>
<td style="text-align: left;">INT-B02</td>
<td style="text-align: left;">BP v1.3 â†’ Feature Engineer v1.3</td>
<td style="text-align: center;">BP v1.3 (Manifest)</td>
<td style="text-align: center;">FE v1.3</td>
<td style="text-align: left;">FE æ­£ç¢ºè®€å– audit_trail</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-risk-assessment">6. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£ (Risk Assessment)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢¨éšª</th>
<th style="text-align: center;">åš´é‡åº¦</th>
<th style="text-align: center;">å¯èƒ½æ€§</th>
<th style="text-align: left;">ç·©è§£æªæ–½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>device_role æ´©æ¼</strong> (Cleaner èª¤å¯«å…¥)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">E500 æª¢æŸ¥æ””æˆªï¼ŒCI/CD æ¸¬è©¦ BP13-FA-02/03</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Annotation ä¸åŒæ­¥</strong> (E406)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">å•Ÿå‹•æ™‚å¼·åˆ¶æª¢æŸ¥ï¼Œæ˜ç¢ºéŒ¯èª¤è¨Šæ¯æŒ‡å¼•</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç¹¼æ‰¿éˆéºå¤±</strong></td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;">Manifest å¼·åˆ¶è¨˜éŒ„ inheritance_chainï¼Œé©—è­‰æ¸¬è©¦</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT96 å›é€€</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">å¯«å…¥å¾Œ Schema é©—è­‰ (E206)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Metadata éºå¤±</strong></td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">High</td>
<td style="text-align: left;">Fallback ä¿å®ˆé è¨­ (E203 Warning)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-version-compatibility">7. ç‰ˆæœ¬ç›¸å®¹æ€§çŸ©é™£ (Version Compatibility)</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">Cleaner</th>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;">Feature Annotation</th>
<th style="text-align: center;">ç›¸å®¹æ€§</th>
<th style="text-align: left;">èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v2.2 (ç„¡ device_role)</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âœ… <strong>å®Œå…¨ç›¸å®¹</strong></td>
<td style="text-align: left;">æ¨è–¦é…ç½®ï¼Œç¨½æ ¸è»Œè·¡å®Œæ•´</td>
</tr>
<tr>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âš ï¸ <strong>éƒ¨åˆ†ç›¸å®¹</strong></td>
<td style="text-align: left;">FE v1.2 ç„¡æ³•è®€å– audit_trailï¼Œä½†åŠŸèƒ½æ­£å¸¸</td>
</tr>
<tr>
<td style="text-align: center;">v2.1 (æœ‰ device_role)</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">è§¸ç™¼ E500ï¼Œéœ€å‡ç´š Cleaner</td>
</tr>
<tr>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">v1.2 ç„¡æ³•è¨˜éŒ„ Annotation ç¨½æ ¸è»Œè·¡</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-deliverables">8. äº¤ä»˜ç‰©æ¸…å–® (Deliverables)</h2>
<h3 id="81">8.1 ç¨‹å¼ç¢¼æª”æ¡ˆ</h3>
<ol>
<li><code>src/etl/batch_processor.py</code> - ä¸»è¦å¯¦ä½œ (v1.3-FAï¼Œå« E406/E500 æª¢æŸ¥èˆ‡ç¨½æ ¸è»Œè·¡)</li>
<li><code>src/etl/manifest.py</code> - Manifest æ¨¡å‹æ›´æ–° (æ–°å¢ annotation_audit_trail)</li>
<li><code>src/etl/contract_validator.py</code> - å¥‘ç´„é©—è­‰é‚è¼¯ (å¯è¤‡ç”¨æ¨¡çµ„)</li>
</ol>
<h3 id="82">8.2 æ¸¬è©¦æª”æ¡ˆ</h3>
<ol>
<li><code>tests/test_batch_processor_v13_fa.py</code> - v1.3-FA å°ˆå±¬æ¸¬è©¦ï¼ˆå« E406/E500 é©—è­‰ï¼‰</li>
<li><code>tests/test_manifest_audit_trail.py</code> - ç¨½æ ¸è»Œè·¡å®Œæ•´æ€§æ¸¬è©¦</li>
<li><code>tests/test_integration_annotation_sync.py</code> - E406 åŒæ­¥æª¢æŸ¥æ•´åˆæ¸¬è©¦</li>
</ol>
<h3 id="83">8.3 æ–‡ä»¶æª”æ¡ˆ</h3>
<ol>
<li><code>docs/batch_processor/PRD_BATCH_PROCESSOR_v1.3-FA.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/batch_processor/MANIFEST_SPEC_v1.3-FA.md</code> - Manifest JSON Schema è¦ç¯„ (ä¾› Feature Engineer åƒè€ƒ)</li>
</ol>
<hr />
<h2 id="9-sign-off-checklist">9. é©—æ”¶ç°½æ ¸ (Sign-off Checklist)</h2>
<ul>
<li>[ ] <strong>E406 æª¢æŸ¥</strong>ï¼šExcel ä¿®æ”¹æ™‚é–“æ™šæ–¼ YAML æ™‚ï¼Œæ­£ç¢ºæ‹‹å‡º E406 ä¸¦æŒ‡å¼•åŸ·è¡Œ validate-annotation</li>
<li>[ ] <strong>è·è²¬åˆ†é›¢ (E500)</strong>ï¼šè¼¸å…¥ DataFrame å« device_role æ¬„ä½æ™‚ï¼Œæ­£ç¢ºæ‹‹å‡º E500</li>
<li>[ ] <strong>Metadata ç´”æ·¨</strong>ï¼šcolumn_metadata å‚³ééç¨‹ä¸­ä¸å« device_roleï¼Œé€šé Step 3.1 é©—è­‰</li>
<li>[ ] <strong>Parquet ç´”æ·¨</strong>ï¼šè¼¸å‡º Parquet Schema ä¸å« device_role æ¬„ä½ï¼ˆE500 æª¢æŸ¥ï¼‰</li>
<li>[ ] <strong>ç¨½æ ¸è»Œè·¡</strong>ï¼šManifest æ­£ç¢ºè¨˜éŒ„ <code>annotation_audit_trail</code>ï¼ˆå« schema_version, inheritance_chain, yaml_checksumï¼‰</li>
<li>[ ] <strong>INT64/UTC</strong>ï¼šå¯«å…¥å¾Œé©—è­‰ <code>physical_type == "INT64"</code> ä¸” <code>is_adjusted_to_utc == True</code></li>
<li>[ ] <strong>SSOT å¿«ç…§</strong>ï¼šManifest åŒ…å« <code>quality_flags_schema</code> èˆ‡ç•¶å‰ SSOT ä¸€è‡´</li>
<li>[ ] <strong>ä¸‹æ¸¸éŠœæ¥</strong>ï¼šFeature Engineer v1.3 å¯æ­£ç¢ºè®€å– <code>annotation_audit_trail</code> ä¸¦ç›´æ¥æŸ¥è©¢ Annotation SSOT</li>
</ul>
<hr />
<p><strong>é—œéµè¨­è¨ˆç¢ºèª</strong>ï¼š
1. BatchProcessor <strong>ä¸è™•ç†</strong> device_role é‚è¼¯ï¼ˆåƒ…å‚³éç‰ˆæœ¬è³‡è¨Šï¼‰
2. Manifest çš„ <code>feature_metadata</code> <strong>åƒ…å«</strong> physical_type/unitï¼ˆä¾†è‡ª Cleanerï¼‰
3. Manifest çš„ <code>annotation_audit_trail</code> <strong>åƒ…ä¾›ç¨½æ ¸</strong>ï¼ˆç‰ˆæœ¬ã€checksumã€ç¹¼æ‰¿éˆï¼‰
4. Feature Engineer <strong>ç›´æ¥è®€å–</strong> YAML SSOT å–å¾— device_roleï¼ˆè€Œéä¾è³´ Manifestï¼‰</p>
    
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>

</body>
</html>
