<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BATCH_PROCESSOR_EVALUATION</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="batchprocessor">BatchProcessor æŠ€è¡“è©•ä¼°èˆ‡é¢¨éšªå ±å‘Š</h1>
<p><strong>è©•ä¼°å°è±¡:</strong> <code>src/etl/batch_processor.py</code><br />
<strong>è©•ä¼°æ—¥æœŸ:</strong> 2026-02-12<br />
<strong>è©•ä¼°äººå“¡:</strong> Antigravity (AI Architect)<br />
<strong>åš´é‡æ€§ç­‰ç´š:</strong> ğŸ”´ Critical (éœ€ç«‹å³ä¿®æ­£)</p>
<hr />
<h2 id="1-executive-summary">1. åŸ·è¡Œæ‘˜è¦ (Executive Summary)</h2>
<p>ç›®å‰çš„ <code>batch_processor.py</code> æ˜¯ä¸€å€‹<strong>ã€ŒåŸå‹ç­‰ç´š (Prototype-level)ã€</strong>çš„å¯¦ä½œï¼Œå®Œå…¨ç„¡æ³•æ”¯æ’ã€Œé‡å¤§èƒ½æºåˆ†æå°ˆæ¡ˆã€çš„ç”Ÿç”¢ç’°å¢ƒéœ€æ±‚ã€‚</p>
<p>æœ€è‡´å‘½çš„é¢¨éšªåœ¨æ–¼<strong>è¨˜æ†¶é«”ç®¡ç† (OOM Risk)</strong> èˆ‡ <strong>ä»‹é¢å¥‘ç´„è¡çª (Contract Violation)</strong>ã€‚å¦‚æœä¸é€²è¡Œé‡æ§‹ï¼Œç›´æ¥å¥—ç”¨æ–°çš„ <code>DataCleaner v2.1</code>ï¼Œç¨‹å¼å°‡æœƒå´©æ½°æˆ–åˆªé™¤é—œéµçš„å“è³ªæ¨™è¨˜æ•¸æ“šã€‚</p>
<hr />
<h2 id="2-critical-risks">2. é—œéµé¢¨éšªåˆ†æ (Critical Risks)</h2>
<h3 id="1-the-memory-bomb">ğŸ”´ é¢¨éšª 1: è¨˜æ†¶é«”ç‚¸å½ˆ (The Memory Bomb)</h3>
<ul>
<li><strong>ç¨‹å¼ç¢¼ä½ç½®:</strong> L62 <code>parsed_dfs = []</code>, L74 <code>parsed_dfs.append(df)</code>, L153 <code>pl.concat(parsed_dfs)</code></li>
<li><strong>å•é¡Œæè¿°:</strong> ç¨‹å¼å°‡æ‰€æœ‰ CSV æª”æ¡ˆè™•ç†å¾Œçš„ DataFrame å…¨éƒ¨æš«å­˜åœ¨ RAM ä¸­çš„ <code>parsed_dfs</code> åˆ—è¡¨ï¼Œç›´åˆ°æœ€å¾Œæ‰ä¸€æ¬¡æ€§åˆä½µã€‚</li>
<li><strong>å¾Œæœ:</strong> </li>
<li>è‹¥æœ‰ 1000 å€‹ 50MB çš„ CSVï¼Œè¨˜æ†¶é«”éœ€æ±‚å°‡è¶…é 50GBã€‚</li>
<li>å°æ–¼èƒ½æºé•·æœŸåˆ†æå°ˆæ¡ˆï¼ˆé€šå¸¸æ•¸å¹´æ•¸æ“šï¼‰ï¼Œæ­¤é‚è¼¯ 100% æœƒå°è‡´ <strong>Out of Memory (OOM)</strong> å´©æ½°ã€‚</li>
<li><strong>æ”¹é€²å»ºè­°:</strong> å¿…é ˆæ”¹ç”¨ <strong>Incremental Processing (å¢é‡è™•ç†)</strong> æ¨¡å¼ã€‚</li>
<li>è™•ç†å®Œä¸€å€‹æª”æ¡ˆï¼Œç«‹å³å¯«å…¥ç£ç¢Ÿ (å¦‚ Parquet) æˆ–è³‡æ–™åº«ã€‚</li>
<li>æˆ–è€…ä½¿ç”¨ <code>pl.LazyFrame</code> æ­é… <code>sink_parquet</code> é€²è¡Œä¸²æµå¯«å…¥ã€‚</li>
</ul>
<h3 id="2-contract-violation-cleaner-v21">ğŸ”´ é¢¨éšª 2: æ‘§æ¯€ä»‹é¢å¥‘ç´„ (Contract Violation - Cleaner v2.1)</h3>
<ul>
<li><strong>ç¨‹å¼ç¢¼ä½ç½®:</strong> L170-181 (å¼·åˆ¶è½‰å‹é‚è¼¯)</li>
</ul>
<pre><code class="language-python">logger.info(&quot;Enforcing numeric types on all non-timestamp columns...&quot;)
# ...
merged_df = merged_df.with_columns(pl.col(col).cast(pl.Float64, strict=False))
</code></pre>
<ul>
<li><strong>å•é¡Œæè¿°:</strong> ç¨‹å¼å‡è¨­ã€Œæ‰€æœ‰éæ™‚é–“æ¬„ä½éƒ½æ˜¯æ•¸å­—ã€ã€‚ä½†åœ¨ <code>PRD_CLEANER_v2.1</code> ä¸­ï¼Œæˆ‘å€‘å¼•å…¥äº† <code>quality_flags</code>ï¼Œå…¶å‹åˆ¥ç‚º <code>List[str]</code>ã€‚</li>
<li><strong>å¾Œæœ:</strong> </li>
<li>é€™æ®µç¨‹å¼ç¢¼æœƒå¼·åˆ¶å°‡ <code>quality_flags</code> è½‰ç‚º <code>Float64</code>ã€‚</li>
<li>çµæœæ˜¯ <code>quality_flags</code> å…¨éƒ¨è®Šæˆ <code>null</code>ï¼Œ<strong>æ¸…æ´—å™¨è¾›è‹¦æ¨™è¨˜çš„éŒ¯èª¤è³‡è¨Šå°‡è¢«å…¨æ•¸æŠ¹é™¤</strong>ã€‚</li>
<li><strong>æ”¹é€²å»ºè­°:</strong> å¿…é ˆç§»é™¤å…¨åŸŸå¼·åˆ¶è½‰å‹ï¼Œæ”¹ç”¨ Config å®šç¾©çš„ Schema é©—è­‰ï¼Œæˆ–æ ¹æ“š <code>DataCleaner</code> çš„ Output Contract å‹•æ…‹èª¿æ•´ã€‚</li>
</ul>
<h3 id="3-schema-inefficient-schema-normalization">ğŸŸ  é¢¨éšª 3: ä½æ•ˆçš„ Schema æ­£è¦åŒ– (Inefficient Schema Normalization)</h3>
<ul>
<li><strong>ç¨‹å¼ç¢¼ä½ç½®:</strong> L86-142</li>
<li><strong>å•é¡Œæè¿°:</strong> ç‚ºäº†è™•ç†ä¸åŒ CSV å¯èƒ½ç¼ºæ¼æ¬„ä½çš„æƒ…æ³ï¼Œç¨‹å¼éæ­·äº†æ‰€æœ‰ DataFrame å…©æ¬¡ä¾†è£œé½Šæ¬„ä½ã€‚</li>
<li><strong>å¾Œæœ:</strong> ç•¶è³‡æ–™é‡å¤§æ™‚ï¼Œé€™è£¡æœƒæˆç‚º CPU èˆ‡ RAM çš„é›™é‡ç“¶é ¸ã€‚</li>
<li><strong>æ”¹é€²å»ºè­°:</strong> ä½¿ç”¨ <code>pl.concat(..., how="diagonal")</code> å…¶å¯¦å·²ç¶“èƒ½è™•ç†æ¬„ä½ä¸é½Šçš„å•é¡Œï¼ˆPolars åŸç”ŸåŠŸèƒ½ï¼‰ï¼ŒL86-142 çš„æ‰‹å‹•æ­£è¦åŒ–å¤§éƒ¨åˆ†æ˜¯å¤šé¤˜ä¸”ä½æ•ˆçš„ã€‚</li>
</ul>
<h3 id="4-configuration-hardcoding">ğŸŸ  é¢¨éšª 4: é…ç½®ç¡¬ç·¨ç¢¼ (Configuration Hardcoding)</h3>
<ul>
<li><strong>ç¨‹å¼ç¢¼ä½ç½®:</strong> L44 <code>__init__(self, resample_interval: str = "5m")</code></li>
<li><strong>å•é¡Œæè¿°:</strong> åƒæ•¸è¢«å¯«æ­»æˆ–åƒ…é€é <code>__init__</code> å‚³éï¼Œæœªæ•´åˆå°ˆæ¡ˆæ•´é«”çš„ <code>settings.yaml</code>ã€‚</li>
<li><strong>å¾Œæœ:</strong> æœªä¾†è‹¥è¦èª¿æ•´æ¡æ¨£é »ç‡æˆ–ç‰©ç†åƒæ•¸ï¼Œéœ€ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œé•å Open-Closed Principleã€‚</li>
</ul>
<hr />
<h2 id="3-current-vs-ideal">3. æ¨¡çµ„å”ä½œæµç¨‹èªªæ˜ (Current vs. Ideal)</h2>
<p>æ‚¨è©¢å•é€™æ”¯ç¨‹åºå¦‚ä½•èˆ‡ clean/parser å·¥ä½œï¼Œç›®å‰çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<h3 id="current-code-flow">ç•¶å‰æµç¨‹ (Current Code Flow):</h3>
<pre><code class="language-mermaid">graph LR
    A[BatchProcessor] --&gt;|1. å‘¼å«| B(ReportParser)
    B --&gt;|2. å›å‚³ Raw DF| A
    A --&gt;|3. å‘¼å«| C(DataCleaner)
    C --&gt;|4. å›å‚³ Clean DF| A
    A --&gt;|5. æš«å­˜è¨˜æ†¶é«”| D{List[DF]}
    D --&gt;|6. è¿´åœˆçµæŸå¾Œåˆä½µ| E[Final DataFrame]
</code></pre>
<h3 id="to-be-architecture">ç†æƒ³çš„ç”Ÿç”¢ç´šæµç¨‹ (To-Be Architecture):</h3>
<p>ç‚ºäº†ç¬¦åˆ PRD è¦æ±‚ï¼Œæ¶æ§‹æ‡‰æ”¹ç‚º <strong>Pipeline æ¨¡å¼</strong>ï¼š</p>
<pre><code class="language-mermaid">graph TD
    Config[Configuration Loader] --&gt; BP[BatchProcessor]
    BP --&gt;|Stream| P(Parser)
    P --&gt;|Raw Record| C(Cleaner v2.1)
    C --&gt;|Output Contract| V[Validator]
    V --&gt;|Valid Frame| W[Parquet Writer]
    W --&gt;|Accumulate| DB[(Data Storage)]

    subgraph &quot;Per File Execution&quot;
    P
    C
    V
    W
    end
</code></pre>
<p><strong>å”ä½œç´°ç¯€:</strong><br />
1.  <strong>Parser</strong>: è² è²¬å°‡åŸå§‹ CSV çš„é›œäº‚æ ¼å¼ï¼ˆMetadata/Header åˆ†é›¢ï¼‰è½‰ç‚ºæ¨™æº– Polars DataFrameã€‚<br />
2.  <strong>Cleaner</strong>: æ¥æ”¶ Raw DataFrameï¼ŒåŸ·è¡Œç‰©ç†æª¢æŸ¥ã€é‡æ¡æ¨£ï¼Œä¸¦é™„åŠ ä¸Š <code>quality_flags</code>ã€‚<br />
3.  <strong>BatchProcessor</strong>: <br />
    - <strong>ä¸æ‡‰è©²åšè³‡æ–™è™•ç†</strong>ï¼ˆä¸ç®¡æ˜¯ Schema æ­£è¦åŒ–é‚„æ˜¯å‹åˆ¥å¼·åˆ¶ï¼‰ã€‚<br />
    - å®ƒçš„è·è²¬æ‡‰è©²åªæ˜¯ <strong>Orchestrator (æŒ‡æ®å®˜)</strong>ï¼šç”±å®ƒè®€å–æª”æ¡ˆåˆ—è¡¨ï¼Œä¾åºå‘¼å« Parser -&gt; Cleanerï¼Œç„¶å¾Œå°‡çµæœ<strong>è½åœ°</strong>ã€‚</p>
<h2 id="4">4. å…·é«”å»ºè­°è¡Œå‹•</h2>
<ol>
<li><strong>é‡å¯« BatchProcessor</strong>ï¼šå»¢æ£„ç›®å‰çš„å¯¦ä½œï¼Œå»ºç«‹ç¬¦åˆ Pipeline æ¨¡å¼çš„æ–°ç‰ˆæœ¬ã€‚</li>
<li><strong>æ•´åˆ Config System</strong>ï¼šè®€å– <code>settings.yaml</code> ä¾†åˆå§‹åŒ– Parser èˆ‡ Cleanerã€‚</li>
<li><strong>å°æ¥ Feature Engineer</strong>ï¼šBatchProcessor çš„è¼¸å‡ºï¼ˆå¦‚ Parquet æª”æ¡ˆï¼‰å°‡æˆç‚º Feature Engineer çš„è¼¸å…¥ä¾†æºã€‚</li>
</ol>
<hr />
<p><strong>çµè«–</strong>: é€™æ”¯ç¨‹å¼ç›®å‰æ˜¯å°ˆæ¡ˆä¸­çš„ã€ŒçŸ­æ¿ (Singleton Point of Failure)ã€ã€‚è‹¥ä¸é‡å¯«ï¼Œæ‚¨çš„ Cleaner v2.1 åŠŸèƒ½å°‡å®Œå…¨ç„¡æ³•ç™¼æ®ã€‚</p>
</body>
</html>