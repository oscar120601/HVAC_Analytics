
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Processor Implementation Guide v1.2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1, h2, h3 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h2 { margin-top: 2em; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #dfe2e5;
            padding: 12px;
            text-align: left;
        }
        th { background-color: #f6f8fa; font-weight: bold; }
        tr:nth-child(even) { background-color: #fdfdfd; }
        code {
            background-color: #f3f3f3;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 85%;
        }
        pre {
            background-color: #f6f8fa;
            padding: 16px;
            overflow: auto;
            border-radius: 6px;
        }
        blockquote {
            margin: 0;
            padding: 0 1em;
            color: #6a737d;
            border-left: 0.25em solid #dfe2e5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="prd-v12-batchprocessor-implementation-guide">PRD v1.2: æ‰¹æ¬¡å¤„ç†å™¨å¼ºå¥æ€§é‡æ„æŒ‡å— (BatchProcessor Implementation Guide)</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.2 (å« Single Source of Truth ä¸ CI/CD æ²»ç†)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-12<br />
<strong>è´Ÿè´£äºº:</strong> Oscar Chang<br />
<strong>ç›®æ ‡æ¨¡ç»„:</strong> <code>src/etl/batch_processor_v2.py</code><br />
<strong>ç›¸ä¾æ¨¡ç»„:</strong> <code>src/etl/cleaner_v2.py</code> (v2.1+), <code>src/etl/config_models.py</code> (SSOT)<br />
<strong>é¢„ä¼°å·¥æ—¶:</strong> 4 ~ 5 ä¸ªå·¥ç¨‹å¤©ï¼ˆå«æ•´åˆæµ‹è¯•ä¸ CI/CD è®¾ç½®ï¼‰</p>
<hr />
<h2 id="1">1. æ‰§è¡Œæ€»çº²ä¸è®¾è®¡å“²å­¦</h2>
<p>ç›®å‰çš„ <code>batch_processor.py</code> å­˜åœ¨<strong>å†…å­˜å †ç§¯</strong>ã€<strong>å¥‘çº¦ç ´å</strong>ä¸<strong>é…ç½®ä¸ä¸€è‡´</strong>çš„è‡´å‘½ä¼¤ã€‚æœ¬ PRD å®šä¹‰ <strong>V2.0 Pipeline æ¶æ„</strong>ï¼Œå¹¶é€è¿‡ <strong>Single Source of Truth (SSOT)</strong> ç¡®ä¿ä¸ Cleanerã€Feature Engineer çš„å“è´¨æ ‡è®°å®Œå…¨å¯¹é½ã€‚</p>
<p><strong>æ ¸å¿ƒè®¾è®¡åŸåˆ™:</strong>
1.  <strong>Single Source of Truth (SSOT)</strong>ï¼š<code>quality_flags</code> ä¸ <code>Parquet æ ¼å¼è§„èŒƒ</code> ç»Ÿä¸€å®šä¹‰äº <code>config_models.py</code>ï¼Œä¸‰æ¨¡ç»„å…±ç”¨ï¼Œç¦æ­¢ç¡¬ç¼–ç ã€‚
2.  <strong>INT64 æ—¶é—´æˆ³å¼ºåˆ¶è§„èŒƒ</strong>ï¼šæ˜ç¡®ç¦æ­¢ INT96ï¼Œå¼ºåˆ¶ä½¿ç”¨ nanoseconds + UTCï¼Œç¡®ä¿ Polars åŸç”Ÿå…¼å®¹æ€§ã€‚
3.  <strong>CI/CD æ²»ç†ä¿æŠ¤</strong>ï¼šå»ºç«‹è‡ªåŠ¨æ£€æŸ¥è„šæœ¬ï¼Œé˜²æ­¢ã€Œåªæ”¹å®šä¹‰ä¸æ”¹æµ‹è¯•ã€çš„è¦†ç›–ç¼ºå£ã€‚
4.  <strong>ä¸²æµä¼˜å…ˆ (Streaming First)</strong>ï¼šä¸¥ç¦å°†å¤šæ¡£æ¡ˆ DataFrame åŒæ—¶è½½å…¥å†…å­˜ã€‚
5.  <strong>äº‹åŠ¡æ€§è¾“å‡º (Transactional)</strong>ï¼šStaging + Atomic Moveï¼Œæ”¯æŒå¹‚ç­‰é‡è·‘ã€‚</p>
<hr />
<h2 id="2-single-source-of-truth-ssot">2. ç»Ÿä¸€é…ç½®ä¸ Single Source of Truth (SSOT)</h2>
<h3 id="21-config_modelspy">2.1 å…¨åŸŸå¸¸æ•°å®šä¹‰ï¼ˆconfig_models.pyï¼‰</h3>
<p><strong>æ‰€æœ‰å“è´¨æ ‡è®°ä¸ Parquet æ ¼å¼çš„å”¯ä¸€çœŸç›¸æ¥æºï¼š</strong></p>
<pre><code class="language-python"># src/etl/config_models.py
from typing import Final, List, Literal
from pydantic import BaseModel, validator

# ã€SSOTã€‘Quality Flags ç»Ÿä¸€å®šä¹‰ - ä¸‰æ¨¡ç»„å…±ç”¨
VALID_QUALITY_FLAGS: Final[List[str]] = [
    &quot;FROZEN&quot;, 
    &quot;HEAT_IMBALANCE&quot;, 
    &quot;AFFINITY_VIOLATION&quot;, 
    &quot;OUTLIER&quot;, 
    &quot;INSUFFICIENT_DATA&quot;,
    &quot;SENSOR_OFFLINE&quot;  # æœªæ¥æ–°å¢åªéœ€åœ¨æ­¤å¤„æ‰©å……
]

class QualityFlagConfig(BaseModel):
    &quot;&quot;&quot;å“è´¨æ ‡è®°é…ç½®ï¼ˆä¾› Cleanerã€BatchProcessorã€Feature Engineer å…±ç”¨ï¼‰&quot;&quot;&quot;
    enabled: bool = True
    valid_flags: List[str] = VALID_QUALITY_FLAGS  # å¼•ç”¨ SSOT

    @validator('valid_flags')
    def validate_flags(cls, v):
        &quot;&quot;&quot;ç¡®ä¿é…ç½®ä¸­çš„ flags çš†ä¸ºåˆæ³•å®šä¹‰&quot;&quot;&quot;
        invalid = set(v) - set(VALID_QUALITY_FLAGS)
        if invalid:
            raise ValueError(f&quot;Invalid flags: {invalid}. Must be subset of {VALID_QUALITY_FLAGS}&quot;)
        return v

class ParquetOutputConfig(BaseModel):
    &quot;&quot;&quot;
    ã€å¼ºåˆ¶è§„èŒƒã€‘Parquet è¾“å‡ºæ ¼å¼ - ç¦æ­¢ INT96
    &quot;&quot;&quot;
    timestamp_format: Literal[&quot;INT64&quot;] = &quot;INT64&quot;
    timestamp_unit: Literal[&quot;nanoseconds&quot;] = &quot;nanoseconds&quot;
    timestamp_timezone: Literal[&quot;UTC&quot;] = &quot;UTC&quot;
    compression: Literal[&quot;snappy&quot;, &quot;zstd&quot;] = &quot;snappy&quot;
    writer_engine: Literal[&quot;polars_native&quot;] = &quot;polars_native&quot;  # é¿å… PyArrow è‡ªåŠ¨è½¬æ¢

    @validator('timestamp_format')
    def no_deprecated_int96(cls, v):
        if v == &quot;INT96&quot;:
            raise ValueError(&quot;INT96 is deprecated and incompatible with Polars. Use INT64.&quot;)
        return v

class BatchConfig(BaseModel):
    input_pattern: str = &quot;*.csv&quot;
    output_base_dir: str = &quot;data/processed/&quot;
    staging_dir: str = &quot;data/.staging/&quot;
    max_rows_per_file: int = 100_000
    max_time_span_per_file: str = &quot;1d&quot;

    # ã€SSOTã€‘å¼•ç”¨ç»Ÿä¸€é…ç½®
    quality_flags: QualityFlagConfig = QualityFlagConfig()
    parquet: ParquetOutputConfig = ParquetOutputConfig()

    memory_limit_mb: int = 4096
    stop_on_error: bool = False

class ETLConfig(BaseModel):
    &quot;&quot;&quot;ç»Ÿä¸€é…ç½®æ ¹ç‰©ä»¶&quot;&quot;&quot;
    cleaner: CleaningConfig      # åŒæ ·å¼•ç”¨ QualityFlagConfig
    batch: BatchConfig
</code></pre>
<hr />
<h2 id="3">3. ç³»ç»Ÿæ¶æ„ä¸èµ„æ–™æµ</h2>
<h3 id="31-pipeline-ssot">3.1 Pipeline æµç¨‹ï¼ˆå« SSOT éªŒè¯ï¼‰</h3>
<pre><code class="language-mermaid">graph TD
    A[Source CSVs] --&gt;|Iterate| B(Parser)
    B --&gt;|Raw DF| C[Cleaner v2.1]
    C --&gt;|Clean DF| D{Contract Validator&lt;br/&gt;æ£€æŸ¥ Flags &amp; INT64/UTC}
    D --&gt;|Pass| E[Buffer Accumulator]
    D --&gt;|Fail| F[Error Log]
    E --&gt;|è¾¾é˜ˆå€¼| G[Staging Writer&lt;br/&gt;å¼ºåˆ¶ INT64/UTC]
    G --&gt;|æ‰¹æ¬¡å®Œæˆ| H{Atomic Move}
    H --&gt;|æˆåŠŸ| I[Final Parquet&lt;br/&gt;year=2026/month=02/]
    H --&gt;|æˆåŠŸ| J[manifest.json]
    H --&gt;|å¤±è´¥| K[Rollback]
    I --&gt;|è¯»å–| L[Feature Engineer&lt;br/&gt;é€šè¿‡ manifest + SSOT éªŒè¯]

    style G fill:#f9f,stroke:#333,stroke-width:2px
    style D fill:#ff9,stroke:#333,stroke-width:2px
</code></pre>
<hr />
<h2 id="4">4. åˆ†é˜¶æ®µå®ä½œè®¡åˆ’</h2>
<h3 id="phase-1-ssot-1">Phase 1: SSOT é…ç½®ä¸åŸºç¡€æ¶æ„ (é¢„ä¼° 1 å¤©)</h3>
<h4 id="step-11-ssot">Step 1.1: å»ºç«‹ç»Ÿä¸€é…ç½®æ¨¡å‹ï¼ˆå·²å« SSOTï¼‰</h4>
<p><strong>æ¡£æ¡ˆ</strong>: <code>src/etl/config_models.py</code></p>
<ul>
<li>å®šä¹‰ <code>VALID_QUALITY_FLAGS</code>ï¼ˆListï¼Œå…¨å±€å”¯ä¸€ï¼‰</li>
<li>å®šä¹‰ <code>QualityFlagConfig</code>ï¼ˆPydanticï¼Œå¼•ç”¨ VALID_QUALITY_FLAGSï¼‰</li>
<li>å®šä¹‰ <code>ParquetOutputConfig</code>ï¼ˆå¼ºåˆ¶ INT64/UTCï¼Œç¦æ­¢ INT96ï¼‰</li>
</ul>
<h4 id="step-12-orchestrator">Step 1.2: Orchestrator éª¨æ¶ï¼ˆåŠ¨æ€è¯»å–é…ç½®ï¼‰</h4>
<p><strong>æ¡£æ¡ˆ</strong>: <code>src/etl/batch_processor_v2.py</code></p>
<pre><code class="language-python">class BatchOrchestrator:
    def __init__(self, config: ETLConfig):
        self.config = config
        self.parser = ReportParser()
        self.cleaner = DataCleaner(config.cleaner)

        # ã€SSOTã€‘ä»é…ç½®è¯»å–å…è®¸çš„ flagsï¼Œéç¡¬ç¼–ç 
        self.allowed_flags = set(config.batch.quality_flags.valid_flags)
        self.parquet_config = config.batch.parquet

    def _validate_quality_flags(self, df: pl.DataFrame) -&gt; None:
        &quot;&quot;&quot;
        ã€SSOT éªŒè¯ã€‘æ£€æŸ¥ DataFrame ä¸­çš„ flags æ˜¯å¦çš†åœ¨åˆæ³•æ¸…å•å†…
        &quot;&quot;&quot;
        if &quot;quality_flags&quot; not in df.columns:
            return

        actual_flags = set()
        for flags in df[&quot;quality_flags&quot;]:
            if flags:
                actual_flags.update(flags)

        unknown = actual_flags - self.allowed_flags
        if unknown:
            raise ContractViolationError(
                f&quot;Unknown quality flags detected: {unknown}. &quot;
                f&quot;These flags are not defined in config_models.VALID_QUALITY_FLAGS. &quot;
                f&quot;Please update the SSOT or check Cleaner configuration.&quot;
            )
</code></pre>
<h3 id="phase-2-schema-2">Phase 2: æ ¸å¿ƒç®¡çº¿ä¸ Schema éªŒè¯ (é¢„ä¼° 2 å¤©)</h3>
<h4 id="step-21-ssot-int64">Step 2.1: å¥‘çº¦éªŒè¯å™¨ï¼ˆSSOT ä¸ INT64 æ£€æŸ¥ï¼‰</h4>
<p><strong>æ¡£æ¡ˆ</strong>: <code>src/etl/contract_validator.py</code></p>
<pre><code class="language-python">class OutputContractValidator:
    def __init__(self, config: ETLConfig):
        self.config = config

    def validate(self, df: pl.DataFrame) -&gt; None:
        &quot;&quot;&quot;å®Œæ•´éªŒè¯è¾“å‡ºå¥‘çº¦&quot;&quot;&quot;
        self._validate_quality_flags_values(df)  # SSOT æ£€æŸ¥
        self._validate_timestamp_format(df)      # INT64/UTC æ£€æŸ¥

    def _validate_quality_flags_values(self, df: pl.DataFrame) -&gt; None:
        &quot;&quot;&quot;ã€SSOTã€‘éªŒè¯ flags å€¼æ˜¯å¦åˆæ³•&quot;&quot;&quot;
        if &quot;quality_flags&quot; not in df.columns:
            return

        allowed = set(self.config.batch.quality_flags.valid_flags)

        for i, flags in enumerate(df[&quot;quality_flags&quot;]):
            if not flags:
                continue
            invalid = set(flags) - allowed
            if invalid:
                raise ContractViolationError(
                    f&quot;Row {i}: Invalid flags {invalid}. Allowed: {allowed}&quot;
                )

    def _validate_timestamp_format(self, df: pl.DataFrame) -&gt; None:
        &quot;&quot;&quot;éªŒè¯æ—¶é—´æˆ³å‹åˆ«ä¸æ—¶åŒº&quot;&quot;&quot;
        ts_col = df[&quot;timestamp&quot;]

        if not isinstance(ts_col.dtype, pl.Datetime):
            raise TypeError(f&quot;timestamp must be Datetime, got {ts_col.dtype}&quot;)

        if ts_col.dtype.time_zone != &quot;UTC&quot;:
            raise ValueError(f&quot;timestamp must be UTC, got {ts_col.dtype.time_zone}&quot;)
</code></pre>
<h4 id="step-22-parquet-int64utc">Step 2.2: Parquet å†™å…¥ï¼ˆå¼ºåˆ¶ INT64/UTCï¼‰</h4>
<pre><code class="language-python">def _flush_buffer_to_staging(self):
    &quot;&quot;&quot;å†™å…¥ Parquetï¼Œå¼ºåˆ¶éµå®ˆ INT64/UTC è§„èŒƒ&quot;&quot;&quot;
    combined = pl.concat(self.buffer)

    # ã€å¼ºåˆ¶ã€‘ç¡®ä¿æ—¶é—´æˆ³ä¸º UTC
    if str(combined[&quot;timestamp&quot;].dtype.time_zone) != &quot;UTC&quot;:
        combined = combined.with_columns(
            pl.col(&quot;timestamp&quot;).dt.replace_time_zone(&quot;UTC&quot;)
        )

    # ä½¿ç”¨ Polars åŸç”Ÿå†™å…¥ï¼Œç¡®ä¿ INT64 nanoseconds
    file_path = self._get_staging_path()
    combined.write_parquet(
        file_path,
        compression=self.parquet_config.compression,
        use_pyarrow=False  # å…³é”®ï¼šä½¿ç”¨ Arrow2 åŸç”Ÿï¼Œé¿å… PyArrow è½¬ä¸º INT96
    )

    # ã€éªŒè¯ã€‘å†™å…¥åæ£€æŸ¥ Schema
    self._verify_parquet_schema(file_path)

def _verify_parquet_schema(self, file_path: Path):
    &quot;&quot;&quot;éªŒè¯è¾“å‡º Parquet ç¬¦åˆ INT64/UTC è§„èŒƒ&quot;&quot;&quot;
    import pyarrow.parquet as pq

    pf = pq.ParquetFile(file_path)
    schema = pf.schema
    ts_field = schema.field_by_name(&quot;timestamp&quot;)

    # ã€å…³é”®éªŒè¯ã€‘ç¦æ­¢ INT96
    if ts_field.physical_type == &quot;INT96&quot;:
        file_path.unlink()
        raise TypeError(
            f&quot;CRITICAL: Parquet file {file_path} was written with INT96 timestamp. &quot;
            f&quot;Expected INT64 (nanoseconds). Check writer configuration.&quot;
        )

    self.logger.info(f&quot;Schema verification passed: INT64/UTC confirmed&quot;)
</code></pre>
<h3 id="phase-3-manifest-15">Phase 3: Manifest ä¸ä¸‹æ¸¸è¡”æ¥ (é¢„ä¼° 1.5 å¤©)</h3>
<h4 id="step-31-manifest-ssot">Step 3.1: Manifest æ¨¡å‹ï¼ˆå« SSOT ä¿¡æ¯ï¼‰</h4>
<pre><code class="language-python">class Manifest(BaseModel):
    manifest_version: str = &quot;1.2&quot;
    batch_id: str
    site_id: str
    created_at: datetime

    # ã€SSOTã€‘è®°å½•ä½¿ç”¨çš„ flags å®šä¹‰ç‰ˆæœ¬
    quality_flags_schema: List[str]
    parquet_schema: Dict

    output_files: List[str]
    statistics: Dict
</code></pre>
<hr />
<h2 id="5-ssot-int64">5. éªŒè¯ä¸æµ‹è¯•è®¡åˆ’ï¼ˆSSOT ä¸ INT64 ä¸“é¡¹ï¼‰</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">æµ‹è¯•æ¡ˆä¾‹</th>
<th style="text-align: left;">éªŒè¯å†…å®¹</th>
<th style="text-align: center;">é€šè¿‡æ ‡å‡†</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Case S1 (SSOT Sync)</strong></td>
<td style="text-align: left;">Cleaner æ–°å¢ <code>"SENSOR_OFFLINE"</code>ï¼ŒBatchProcessor è‡ªåŠ¨æ¥å—</td>
<td style="text-align: center;">ä¸æŠ›å‡º <code>ContractViolationError</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case S2 (SSOT Mismatch)</strong></td>
<td style="text-align: left;">Cleaner è¾“å‡ºæœªå®šä¹‰ flag <code>"UNKNOWN"</code></td>
<td style="text-align: center;">æŠ›å‡ºæ˜ç¡®é”™è¯¯ï¼šæç¤ºæ›´æ–° <code>config_models.py</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case T1 (INT64 Enforcement)</strong></td>
<td style="text-align: left;">è¾“å‡º Parquet æ—¶é—´æˆ³æ ¼å¼</td>
<td style="text-align: center;"><code>physical_type == "INT64"</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case T2 (UTC Timezone)</strong></td>
<td style="text-align: left;">è¾“å…¥é UTC èµ„æ–™</td>
<td style="text-align: center;">è‡ªåŠ¨è½¬æ¢ä¸º UTC</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case T3 (No INT96)</strong></td>
<td style="text-align: left;">æ¨¡æ‹Ÿæ—§ç‰ˆ PyArrow è¡Œä¸º</td>
<td style="text-align: center;">éªŒè¯é€»è¾‘æ‹¦æˆªå¹¶æŠ›å‡º <code>TypeError</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6">6. é£é™©è¯„ä¼°ï¼ˆæ›´æ–°ï¼‰</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é£é™©</th>
<th style="text-align: center;">ä¸¥é‡åº¦</th>
<th style="text-align: left;">ç¼“è§£æªæ–½ï¼ˆv1.2 SSOT è®¾è®¡ï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Flags å®šä¹‰ä¸ä¸€è‡´</strong></td>
<td style="text-align: center;">ğŸ”´ Critical</td>
<td style="text-align: left;"><strong>SSOT</strong>: <code>config_models.VALID_QUALITY_FLAGS</code>ï¼Œä¸‰æ¨¡ç»„å…±ç”¨</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT96 æ—¶é—´æˆ³</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: left;"><strong>å¼ºåˆ¶ INT64</strong>: <code>use_pyarrow=False</code> + å†™å…¥å Schema éªŒè¯</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æµ‹è¯•è¦†ç›–ç¼ºå£</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: left;"><strong>CI/CD è‡ªåŠ¨æ£€æŸ¥</strong>: <code>scripts/ci_verify_ssot.py</code> é˜»æŒ¡æœªåŒæ­¥æµ‹è¯•çš„ PR</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ—¶åŒºé”™è¯¯</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: left;"><strong>å¼ºåˆ¶ UTC</strong>: <code>dt.replace_time_zone("UTC")</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>å°æ–‡ä»¶çˆ†ç‚¸</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: left;"><strong>æ—¶é—´åˆ†åŒºåˆå¹¶</strong>: <code>max_rows_per_file</code> é˜ˆå€¼æ§åˆ¶</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-ssot">7. ä¸ä¸Šä¸‹æ¸¸åä½œæ£€æŸ¥æ¸…å•ï¼ˆSSOT ä¸“é¡¹ï¼‰</h2>
<h3 id="cleaner-v21-ssot">ä¸ Cleaner v2.1 å›¢é˜Ÿï¼ˆSSOT å¯¹é½ï¼‰ï¼š</h3>
<ul>
<li>[ ] <code>config_models.py</code> ä¸­çš„ <code>VALID_QUALITY_FLAGS</code> æ˜¯å¦åŒ…å«æ‰€æœ‰ Cleaner ä¼šäº§å‡ºçš„æ ‡è®°ï¼Ÿ</li>
<li>[ ] Cleaner çš„ <code>CleaningConfig</code> æ˜¯å¦åŒæ ·å¼•ç”¨ <code>QualityFlagConfig</code>ï¼Ÿ</li>
<li>[ ] è‹¥éœ€æ–°å¢æ ‡è®°ï¼Œæ˜¯å¦ä¸‰æ–¹åŒæ„æ”¹åŠ¨ <code>config_models.py</code> ååŒæ­¥æ›´æ–°ï¼Ÿ</li>
</ul>
<h3 id="feature-engineer-int64ssot">ä¸ Feature Engineer å›¢é˜Ÿï¼ˆINT64/SSOTï¼‰ï¼š</h3>
<ul>
<li>[ ] æ˜¯å¦ç¡®è®¤è¯»å– Parquet æ—¶ä½¿ç”¨ <code>scan_parquet</code>ï¼ˆåŸç”Ÿæ”¯æŒ INT64ï¼‰ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æ¥å—é€šè¿‡ <code>manifest.json</code> è¯»å–ï¼Œå¹¶éªŒè¯ <code>quality_flags_schema</code> å­—æ®µï¼Ÿ</li>
</ul>
<hr />
<h2 id="8">8. äº¤ä»˜äº§ç‰©æ¸…å•</h2>
<ol>
<li><code>src/etl/config_models.py</code>: <strong>SSOT å®šä¹‰</strong>ï¼ˆ<code>VALID_QUALITY_FLAGS</code>, <code>ParquetOutputConfig</code>ï¼‰</li>
<li><code>src/etl/batch_processor_v2.py</code>: å®ä½œï¼ˆåŠ¨æ€è¯»å– flagsã€INT64 å¼ºåˆ¶å†™å…¥ï¼‰</li>
<li><code>src/etl/contract_validator.py</code>: æ›´æ–°ï¼ˆSSOT éªŒè¯ã€INT64/UTC æ£€æŸ¥ï¼‰</li>
<li><code>tests/test_ssot_integration.py</code>: <strong>SSOT ä¸“é¡¹æµ‹è¯•</strong></li>
<li><code>tests/test_int64_timestamp.py</code>: <strong>INT64 ä¸“é¡¹æµ‹è¯•</strong></li>
<li><code>docs/ssot_guide.md</code>: è¯´æ˜æ–‡ä»¶ï¼ˆå¦‚ä½•æ–°å¢ Quality Flagã€ä¸‰æ¨¡ç»„åŒæ­¥æµç¨‹ï¼‰</li>
</ol>
<hr />
<h2 id="9-cicd-ssot">9. CI/CD ä¸å·¥ç¨‹æ²»ç†ï¼ˆSSOT ä¿æŠ¤æœºåˆ¶ï¼‰</h2>
<h3 id="91">9.1 è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬</h3>
<p>ä¸ºé˜²æ­¢ã€Œåªæ”¹ä»£ç ä¸æ”¹æµ‹è¯•ã€çš„é£é™©ï¼Œå»ºç«‹ä»¥ä¸‹æ£€æŸ¥ï¼š</p>
<p><strong>æ¡£æ¡ˆ</strong>: <code>scripts/ci_verify_ssot.py</code></p>
<pre><code class="language-python">#!/usr/bin/env python3
&quot;&quot;&quot;
SSOT å®Œæ•´æ€§æ£€æŸ¥è„šæœ¬
ç¡®ä¿ config_models.py å˜æ›´æ—¶ï¼Œç›¸å…³æµ‹è¯•å·²åŒæ­¥æ›´æ–°
&quot;&quot;&quot;
import ast
import sys
from pathlib import Path

def extract_valid_flags() -&gt; set:
    &quot;&quot;&quot;ä» config_models.py è§£æ VALID_QUALITY_FLAGS&quot;&quot;&quot;
    tree = ast.parse(Path(&quot;src/etl/config_models.py&quot;).read_text())
    for node in ast.walk(tree):
        if isinstance(node, ast.Assign):
            for target in node.targets:
                if isinstance(target, ast.Name) and target.id == &quot;VALID_QUALITY_FLAGS&quot;:
                    return set(ast.literal_eval(node.value))
    return set()

def main():
    defined_flags = extract_valid_flags()
    print(f&quot;ğŸ“‹ Defined flags: {defined_flags}&quot;)

    # æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡...
    # è¯¦ç»†å®ä½œè§é™„å½•

    return 0

if __name__ == &quot;__main__&quot;:
    sys.exit(main())
</code></pre>
<h3 id="92-github-actions">9.2 GitHub Actions å·¥ä½œæµç¨‹</h3>
<p><strong>æ¡£æ¡ˆ</strong>: <code>.github/workflows/ssot-check.yml</code></p>
<pre><code class="language-yaml">name: SSOT Integrity Check

on:
  push:
    paths:
      - 'src/etl/config_models.py'
      - 'tests/**'

jobs:
  verify-ssot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run SSOT Verification
        run: python scripts/ci_verify_ssot.py

      - name: Run Flag-related Tests
        run: pytest tests/ -k &quot;quality_flag or ssot&quot; -v

      - name: Check Hardcoded Flags
        run: |
          if grep -r &quot;FROZEN\|HEAT_IMBALANCE&quot; --include=&quot;*.py&quot; src/ | grep -v &quot;config_models.py&quot; | grep -v &quot;from.*import&quot;; then
            echo &quot;âŒ Found hardcoded flags outside config_models.py&quot;
            exit 1
          fi
</code></pre>
<h3 id="93-pr-checklist">9.3 PR Checklistï¼ˆæ¨¡æ¿ï¼‰</h3>
<p>å»ºç«‹ Pull Request æ¨¡æ¿ï¼Œå¼ºåˆ¶å‹¾é€‰ï¼š
- [ ] è‹¥ä¿®æ”¹ <code>VALID_QUALITY_FLAGS</code>ï¼Œå·²åŒæ­¥æ›´æ–° <code>tests/test_cleaner.py</code>
- [ ] è‹¥ä¿®æ”¹ <code>VALID_QUALITY_FLAGS</code>ï¼Œå·²åŒæ­¥æ›´æ–° <code>tests/test_batch_processor.py</code><br />
- [ ] è‹¥ä¿®æ”¹ <code>VALID_QUALITY_FLAGS</code>ï¼Œå·²åŒæ­¥æ›´æ–° <code>tests/test_feature_engineer.py</code>
- [ ] å·²æ‰§è¡Œ <code>python scripts/ci_verify_ssot.py</code> ä¸”é€šè¿‡</p>
<hr />
<p><strong>å…³é”®ä¿®æ­£æ€»ç»“</strong>ï¼š
1. <strong>SSOT</strong>: <code>VALID_QUALITY_FLAGS</code> ç»Ÿä¸€äº <code>config_models.py</code>ï¼Œä¸‰æ¨¡ç»„å…±ç”¨ã€‚
2. <strong>INT64 å¼ºåˆ¶</strong>: æ˜ç¡®ç¦æ­¢ INT96ï¼Œä½¿ç”¨ Polars åŸç”Ÿå†™å…¥å™¨ï¼Œå†™å…¥åéªŒè¯ Schemaã€‚
3. <strong>CI/CD ä¿æŠ¤</strong>: å»ºç«‹è‡ªåŠ¨æ£€æŸ¥è„šæœ¬ï¼Œé˜²æ­¢ SSOT å˜æ›´æ—¶æµ‹è¯•è¦†ç›–ç¼ºå£ã€‚
```</p>
    </div>
</body>
</html>
