
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PRD_Interface_Contract_v1.0</title>
    
<style>
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
        line-height: 1.6; 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        color: #24292e; 
        background-color: #ffffff;
    }
    h1, h2, h3, h4, h5, h6 { 
        margin-top: 24px; 
        margin-bottom: 16px; 
        font-weight: 600; 
        color: #24292e;
    }
    h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h3 { font-size: 1.25em; }
    p { margin-top: 0; margin-bottom: 16px; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { 
        display: block; 
        width: 100%; 
        overflow: auto; 
        border-spacing: 0; 
        border-collapse: collapse; 
        margin-bottom: 16px; 
    }
    table th, table td { 
        padding: 6px 13px; 
        border: 1px solid #dfe2e5; 
    }
    table th { 
        font-weight: 600; 
        background-color: #f6f8fa; 
    }
    table tr:nth-child(2n) { 
        background-color: #f6f8fa; 
    }
    code { 
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace; 
        background-color: #f6f8fa; 
        padding: 0.2em 0.4em; 
        border-radius: 3px; 
        font-size: 85%; 
    }
    pre { 
        background-color: #f6f8fa; 
        padding: 16px; 
        overflow: auto; 
        border-radius: 3px; 
        line-height: 1.45; 
    }
    pre code { 
        background-color: transparent; 
        padding: 0; 
        border-radius: 0; 
    }
    blockquote { 
        border-left: 0.25em solid #dfe2e5; 
        color: #6a737d; 
        padding: 0 1em; 
        margin: 0 0 16px 0; 
    }
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
    }
    .mermaid {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
</style>

</head>
<body>
    <p>我將為您提供修正後的完整版 PRD_Interface_Contract_v1.0.md。此版本解決了錯誤代碼分層衝突、建立時間基準傳遞機制，並詳細定義 Training-Optimization 之間的特徵對齊契約。</p>
<div class="codehilite"><pre><span></span><code><span class="gh"># PRD v1.0: 模組介面契約總綱 (Interface Contract Specification)</span>

<span class="gs">**文件版本:**</span> v1.0-Revised (Zero-Gap Contract Definition)  
<span class="gs">**日期:**</span> 2026-02-13  
<span class="gs">**負責人:**</span> Oscar Chang  
<span class="gs">**範圍:**</span> 全 ETL Pipeline + Model Training + Optimization 模組間介面規範  
<span class="gs">**相依文件:**</span> 
<span class="k">-</span><span class="w"> </span>Parser v2.1+, Cleaner v2.2+, BatchProcessor v1.3+, FeatureEngineer v1.3+
<span class="k">-</span><span class="w"> </span>Feature Annotation v1.2+, Model Training v1.2+, Optimization v1.1+

---

<span class="gu">## 1. 設計哲學與核心原則</span>

<span class="gu">### 1.1 契約優先 (Contract-First)</span>
所有模組間的資料交換必須通過**靜態型別檢查**與**執行期驗證**雙重確認。契約一經定義，上游模組有義務確保輸出符合，下游模組有權利假設輸入符合，任何違反視為系統錯誤。

<span class="gu">### 1.2 防禦性驗證 (Defensive Validation)</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**上游驗證**</span>: 模組輸出前必須自我驗證（Self-Check），確保不傳遞「已知錯誤」
<span class="k">-</span><span class="w"> </span><span class="gs">**下游驗證**</span>: 模組輸入時必須嚴格驗證（Strict Validation），拒絕任何不符合契約的輸入
<span class="k">-</span><span class="w"> </span><span class="gs">**容錯策略**</span>: 寧可**終止流程**（Fail Fast），也不傳遞可疑資料

<span class="gu">### 1.3 單一真相源 (SSOT) 引用</span>
所有驗證邏輯必須引用 <span class="sb">`src/etl/config_models.py`</span> 中定義的常數：
<span class="k">-</span><span class="w"> </span><span class="sb">`VALID_QUALITY_FLAGS`</span>: 品質標記唯一清單
<span class="k">-</span><span class="w"> </span><span class="sb">`TIMESTAMP_CONFIG`</span>: 時間戳規格（UTC, nanoseconds, INT64）
<span class="k">-</span><span class="w"> </span><span class="sb">`FEATURE_ANNOTATION_CONSTANTS`</span>: Feature Annotation 版本與 schema 定義
<span class="k">-</span><span class="w"> </span><span class="sb">`PIPELINE_TEMPORAL_BASELINE`</span>: 時間基準傳遞規格（見第8章）

<span class="gu">### 1.4 全域時間基準 (Global Temporal Baseline)</span>
所有「未來資料檢查」與「時間相關驗證」必須使用 Pipeline 啟動時產生的**統一時間戳**（`pipeline_origin_timestamp`），而非模組執行時的動態 <span class="sb">`datetime.now()`</span>，以防止長時間執行流程中的時間漂移（見第8章）。

---

<span class="gu">## 2. 檢查點規格 (Checkpoint Specifications)</span>

<span class="gu">### 2.1 檢查點 #1: Parser → Cleaner (Raw Data Contract)</span>

<span class="gs">**位置**</span>: <span class="sb">`src/etl/parser.py`</span> 輸出驗證 (<span class="sb">`_validate_output_contract`</span>)

| 驗證項目 | 規格 | 失敗代碼 | 嚴重度 |
|:---|:---|:---:|:---:|
| <span class="gs">**必要欄位**</span> | 必須包含 <span class="sb">`timestamp`</span> | E003 | Critical |
| <span class="gs">**時間戳型別**</span> | <span class="sb">`pl.Datetime(time_unit=&#39;ns&#39;, time_zone=&#39;UTC&#39;)`</span> | E002 | Critical |
| <span class="gs">**時間戳物理型別**</span> | Parquet 層級必須為 <span class="sb">`INT64`</span> (非 INT96) | E002 | Critical |
| <span class="gs">**時間戳時區**</span> | <span class="sb">`time_zone`</span> 屬性必須等於 <span class="sb">`&quot;UTC&quot;`</span> | E002 | Critical |
| <span class="gs">**編碼正確性**</span> | 無 UTF-8 BOM (<span class="sb">`\ufeff`</span>) 殘留 | E001 | Critical |
| <span class="gs">**Null Byte 檢查**</span> | 字串欄位不可包含 <span class="sb">`\x00`</span> | E001 | Critical |
| <span class="gs">**Quality Flags**</span> | 若存在，值必須 ⊆ <span class="sb">`VALID_QUALITY_FLAGS`</span> | E003 | High |
| <span class="gs">**數值欄位型別**</span> | 感測器數據必須為 <span class="sb">`pl.Float64`</span> | E003 | High |
| <span class="gs">**換行符號**</span> | 統一為 <span class="sb">`\n`</span> (LF)，不可有 <span class="sb">`\r`</span> (CR) | E001 | Medium |
| <span class="gs">**時間基準繼承**</span> | 必須接收並傳遞 <span class="sb">`pipeline_origin_timestamp`</span> | E000 | Critical |

<span class="gs">**容錯處理**</span>:
<span class="k">-</span><span class="w"> </span>時區非 UTC: 嘗試自動轉換並發出 <span class="gs">**E101 Warning**</span>（僅限 Parser v2.1 相容模式，v2.2+ 視為錯誤）
<span class="k">-</span><span class="w"> </span>編碼非 UTF-8: 嘗試轉換，失敗則拋出 <span class="gs">**E001 Error**</span>

---

<span class="gu">### 2.2 檢查點 #2: Cleaner → BatchProcessor (Clean Data Contract)</span>

<span class="gs">**位置**</span>: <span class="sb">`src/etl/cleaner.py`</span> 輸出驗證 (<span class="sb">`_validate_output_contract`</span>) 與 BatchProcessor 輸入驗證 (<span class="sb">`_validate_input_contract`</span>)

| 驗證項目 | 規格 | 失敗代碼 | 嚴重度 |
|:---|:---|:---:|:---:|
| <span class="gs">**時間戳連續性**</span> | <span class="sb">`timestamp`</span> 必須為連續時間軸（無缺口）或明確標記 <span class="sb">`INSUFFICIENT_DATA`</span> | - | Info |
| <span class="gs">**Quality Flags 型別**</span> | <span class="sb">`pl.List(pl.Utf8)`</span> | E201 | Critical |
| <span class="gs">**Quality Flags 值域**</span> | 所有值必須 ∈ <span class="sb">`VALID_QUALITY_FLAGS`</span> | E202 | Critical |
| <span class="gs">**Metadata 傳遞**</span> | 必須提供 <span class="sb">`column_metadata: Dict[str, FeatureMetadata]`</span> | E203 | Warning |
| <span class="gs">**禁止欄位檢查**</span> | <span class="gs">**不可包含**</span> <span class="sb">`device_role`</span>, <span class="sb">`ignore_warnings`</span>, <span class="sb">`is_target`</span> | <span class="gs">**E500**</span> | <span class="gs">**Critical**</span> |
| <span class="gs">**未來資料檢查**</span> | 時間戳不可超過 <span class="sb">`pipeline_origin_timestamp + 5 minutes`</span> | E102 | High |
| <span class="gs">**時區一致性**</span> | 必須為 UTC (ns)，與檢查點 <span class="ni">#1</span> 相同 | E201 | Critical |
| <span class="gs">**時間基準一致性**</span> | 輸出 metadata 必須包含與輸入相同的 <span class="sb">`pipeline_origin_timestamp`</span> | E000 | Critical |

<span class="gs">**關鍵約束**</span>:
<span class="k">-</span><span class="w"> </span><span class="gs">**E500 (Device Role Leakage)**</span>: Cleaner v2.2 絕對禁止將 <span class="sb">`device_role`</span> 寫入 DataFrame 或 metadata。此檢查為**零容錯**（Zero Tolerance），一旦發現立即終止流程。
<span class="k">-</span><span class="w"> </span><span class="gs">**Metadata 純淨性**</span>: <span class="sb">`column_metadata`</span> 僅可包含 <span class="sb">`physical_type`</span>, <span class="sb">`unit`</span>, <span class="sb">`description`</span>，禁止包含 <span class="sb">`device_role`</span>（即使從 AnnotationManager 讀取也不得寫入）。

---

<span class="gu">### 2.3 檢查點 #3: BatchProcessor → FeatureEngineer (Storage Contract)</span>

<span class="gs">**位置**</span>: <span class="sb">`src/etl/batch_processor.py`</span> 輸出驗證 (<span class="sb">`_verify_parquet_schema`</span>) 與 FeatureEngineer 輸入驗證 (<span class="sb">`load_from_manifest`</span>)

<span class="gs">**Manifest 契約**</span>:
```python
class Manifest(BaseModel):
    manifest_version: str = &quot;1.3-FA&quot;
    batch_id: str                      # UUID v4
    site_id: str
    created_at: datetime               # ISO 8601 UTC

    # 核心資料傳遞
    feature_metadata: Dict[str, FeatureMetadata]  # 不含 device_role
    annotation_audit_trail: Dict       # 必須包含 schema_version, inheritance_chain

    # SSOT 快照
    quality_flags_schema: List[str]    # 當下使用的 VALID_QUALITY_FLAGS 副本
    timestamp_schema: Dict             # {format: &quot;INT64&quot;, unit: &quot;nanoseconds&quot;, timezone: &quot;UTC&quot;}

    # 時間基準傳遞 (新增)
    temporal_baseline: Dict            # {pipeline_origin_timestamp: str, timezone: &quot;UTC&quot;}

    # 輸出檔案
    output_files: List[str]            # 相對路徑
    output_format: str = &quot;parquet&quot;

    # 完整性驗證
    checksum: str                      # Manifest SHA256
    file_checksums: Dict[str, str]     # filename → SHA256
</code></pre></div>

<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Manifest 完整性</strong></td>
<td style="text-align: left;"><code>checksum</code> 驗證通過</td>
<td style="text-align: center;">E301</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Parquet Schema</strong></td>
<td style="text-align: left;"><code>timestamp</code> 物理型別必須為 <code>INT64</code></td>
<td style="text-align: center;">E206</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Parquet 時區</strong></td>
<td style="text-align: left;"><code>timestamp</code> 邏輯型別必須為 <code>UTC</code></td>
<td style="text-align: center;">E206</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Annotation 稽核</strong></td>
<td style="text-align: left;">必須包含 <code>annotation_audit_trail</code></td>
<td style="text-align: center;">E304</td>
<td style="text-align: center;">Warning</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSOT 一致性</strong></td>
<td style="text-align: left;"><code>quality_flags_schema</code> 必須與當前 SSOT 相容</td>
<td style="text-align: center;">E303</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>未來資料防護</strong></td>
<td style="text-align: left;">批次時間範圍不可超過 <code>temporal_baseline.pipeline_origin_timestamp + 5min</code></td>
<td style="text-align: center;">E205</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role 不存在</strong></td>
<td style="text-align: left;">Parquet Schema 與 DataFrame 皆不可含此欄位</td>
<td style="text-align: center;">E500</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準存在性</strong></td>
<td style="text-align: left;">必須包含 <code>temporal_baseline</code> 欄位</td>
<td style="text-align: center;">E000</td>
<td style="text-align: center;">Critical</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="24-4-featureengineer-model-training-feature-matrix-contract">2.4 檢查點 #4: FeatureEngineer → Model Training (Feature Matrix Contract)</h3>
<p><strong>位置</strong>: <code>src/etl/feature_engineer.py</code> 輸出驗證 與 <code>src/training/data_validator.py</code> 輸入驗證</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Data Leakage 檢查</strong></td>
<td style="text-align: left;">特徵欄位不可包含目標變數的未來資訊</td>
<td style="text-align: center;">E305</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Temporal Cutoff</strong></td>
<td style="text-align: left;">若設定 <code>cutoff_timestamp</code>，所有資料時間戳必須 ≤ cutoff</td>
<td style="text-align: center;">E305</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Lag 特徵正確性</strong></td>
<td style="text-align: left;"><code>shift(n)</code> 必須正確實作（T-1 時刻特徵對應 T-1 資料）</td>
<td style="text-align: center;">E305</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Quality Flag One-Hot</strong></td>
<td style="text-align: left;">若啟用 one-hot，必須包含所有 <code>VALID_QUALITY_FLAGS</code> 對應欄位</td>
<td style="text-align: center;">E303</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Metadata 傳遞</strong></td>
<td style="text-align: left;">必須輸出 <code>annotation_context</code> 供模型訓練記錄</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Info</td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵順序保證</strong></td>
<td style="text-align: left;">輸出 <code>feature_order_manifest</code> 記錄欄位順序</td>
<td style="text-align: center;">E601</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵縮放參數</strong></td>
<td style="text-align: left;">若執行縮放，必須輸出 <code>scaler_params</code> (JSON格式，含 mean, scale)</td>
<td style="text-align: center;">E602</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準傳遞</strong></td>
<td style="text-align: left;">必須將 <code>pipeline_origin_timestamp</code> 寫入特徵矩詮 metadata</td>
<td style="text-align: center;">E000</td>
<td style="text-align: center;">Critical</td>
</tr>
</tbody>
</table>
<p><strong>特徵順序保證機制</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># FeatureEngineer 輸出範例</span>
<span class="n">feature_output</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;X_train&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="c1"># 形狀 (n_samples, n_features)</span>
    <span class="s2">&quot;y_train&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="s2">&quot;feature_order_manifest&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;chiller_1_load&quot;</span><span class="p">,</span> <span class="s2">&quot;chiller_2_load&quot;</span><span class="p">,</span> <span class="s2">&quot;wb_temp&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>  <span class="c1"># 明確順序列表</span>
        <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:abc123...&quot;</span><span class="p">,</span>  <span class="c1"># 特徵列表的雜湊</span>
        <span class="s2">&quot;pipeline_origin_timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2026-02-13T10:00:00Z&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;scaler_params&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;StandardScaler&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mean_&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">12.5</span><span class="p">,</span> <span class="mf">13.2</span><span class="p">,</span> <span class="mf">25.1</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="s2">&quot;scale_&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="s2">&quot;feature_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;chiller_1_load&quot;</span><span class="p">,</span> <span class="s2">&quot;chiller_2_load&quot;</span><span class="p">,</span> <span class="s2">&quot;wb_temp&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># 對應 mean_/scale_</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h3 id="25-5-excel-yaml-annotation-sync-contract">2.5 檢查點 #5: Excel ↔ YAML 同步檢查 (Annotation Sync Contract)</h3>
<p><strong>位置</strong>: <code>src/utils/config_loader.py</code> (<code>validate_annotation_sync</code>)</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>檔案存在性</strong></td>
<td style="text-align: left;">Excel 與 YAML 必須同時存在</td>
<td style="text-align: center;">E406</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間戳同步</strong></td>
<td style="text-align: left;"><code>mtime(excel) ≤ mtime(yaml)</code></td>
<td style="text-align: center;">E406</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Checksum 一致性</strong></td>
<td style="text-align: left;">YAML 中記錄的 <code>excel_checksum</code> 必須與實際 Excel 檔案相符</td>
<td style="text-align: center;">E406</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>範本版本</strong></td>
<td style="text-align: left;">Excel 的 <code>template_version</code> 必須等於 <code>EXPECTED_TEMPLATE_VERSION</code></td>
<td style="text-align: center;">E400</td>
<td style="text-align: center;">Critical</td>
</tr>
</tbody>
</table>
<p><strong>執行時機</strong>:
- <strong>嚴格模式</strong> (<code>strict_sync_check=True</code>): Container 初始化時執行，失敗則拋出 <code>AnnotationSyncError</code> 終止流程
- <strong>寬鬆模式</strong>: 僅記錄 Warning，允許繼續執行（僅限開發環境）</p>
<hr />
<h3 id="26-6-annotation-schema-schema-compatibility-contract">2.6 檢查點 #6: Annotation Schema 版本相容 (Schema Compatibility Contract)</h3>
<p><strong>位置</strong>: <code>src/features/annotation_manager.py</code> 初始化與 FeatureEngineer 載入時</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Schema 版本</strong></td>
<td style="text-align: left;"><code>schema_version</code> 必須等於 <code>FEATURE_ANNOTATION_CONSTANTS['expected_schema_version']</code></td>
<td style="text-align: center;">E400</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>繼承鏈合法性</strong></td>
<td style="text-align: left;"><code>inherit</code> 指向的父檔案必須存在，且不可造成循環繼承</td>
<td style="text-align: center;">E407</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>繼承合併結果</strong></td>
<td style="text-align: left;">合併後的 YAML 必須通過 Pydantic 模型驗證</td>
<td style="text-align: center;">E400</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Checksum 格式</strong></td>
<td style="text-align: left;"><code>yaml_checksum</code> 必須符合 <code>sha256:[hex]</code> 格式</td>
<td style="text-align: center;">E400</td>
<td style="text-align: center;">Medium</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="27-7-model-training-optimization-model-artifact-feature-alignment-contract">2.7 檢查點 #7: Model Training → Optimization (Model Artifact &amp; Feature Alignment Contract)</h3>
<p><strong>位置</strong>: <code>src/training/output_validator.py</code> 與 <code>src/optimization/input_validator.py</code></p>
<p><strong>此檢查點為跨階段關鍵介面，確保訓練與推論的特徵一致性</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>模型格式</strong></td>
<td style="text-align: left;">必須為 <code>.joblib</code> 或 <code>.onnx</code>，且包含 <code>feature_order_manifest</code></td>
<td style="text-align: center;">E701</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵順序比對</strong></td>
<td style="text-align: left;">Optimization 輸入特徵順序必須與 Training <code>feature_order_manifest</code> 完全一致</td>
<td style="text-align: center;"><strong>E901</strong></td>
<td style="text-align: center;"><strong>Critical</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵數量一致性</strong></td>
<td style="text-align: left;">輸入特徵維度必須等於模型訓練時的維度</td>
<td style="text-align: center;">E902</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>縮放參數存在性</strong></td>
<td style="text-align: left;">若模型使用 StandardScaler，必須存在 <code>scaler_params</code></td>
<td style="text-align: center;">E903</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>縮放參數對齊</strong></td>
<td style="text-align: left;"><code>scaler_params.feature_names</code> 順序必須與 <code>feature_order_manifest.features</code> 一致</td>
<td style="text-align: center;">E903</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵雜湊驗證</strong></td>
<td style="text-align: left;">可選：計算輸入特徵列表的雜湊，比對 <code>feature_order_manifest.hash</code></td>
<td style="text-align: center;">E901</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準隔離</strong></td>
<td style="text-align: left;">Optimization 必須產生新的 <code>pipeline_origin_timestamp</code>，不可沿用 Training 的時間戳</td>
<td style="text-align: center;">E000</td>
<td style="text-align: center;">Warning</td>
</tr>
</tbody>
</table>
<p><strong>特徵對齊驗證詳細流程</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 在 Optimization 初始化時執行</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_feature_alignment</span><span class="p">(</span><span class="n">model_artifact</span><span class="p">,</span> <span class="n">input_features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    嚴格比對訓練與推論的特徵一致性</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. 載入訓練時的特徵清單</span>
    <span class="n">training_features</span> <span class="o">=</span> <span class="n">model_artifact</span><span class="p">[</span><span class="s1">&#39;feature_order_manifest&#39;</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>

    <span class="c1"># 2. 比對長度</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_features</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">FeatureAlignmentError</span><span class="p">(</span><span class="n">E902</span><span class="p">,</span> 
            <span class="sa">f</span><span class="s2">&quot;特徵維度不匹配: 訓練時 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">training_features</span><span class="p">)</span><span class="si">}</span><span class="s2"> 維，輸入 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span><span class="si">}</span><span class="s2"> 維&quot;</span><span class="p">)</span>

    <span class="c1"># 3. 比對順序與名稱（逐個比對）</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">train_feat</span><span class="p">,</span> <span class="n">input_feat</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">training_features</span><span class="p">,</span> <span class="n">input_features</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">train_feat</span> <span class="o">!=</span> <span class="n">input_feat</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FeatureAlignmentError</span><span class="p">(</span><span class="n">E901</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;特徵錯位於索引 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: 訓練時為 &#39;</span><span class="si">{</span><span class="n">train_feat</span><span class="si">}</span><span class="s2">&#39;，輸入為 &#39;</span><span class="si">{</span><span class="n">input_feat</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># 4. 驗證縮放參數（若存在）</span>
    <span class="k">if</span> <span class="s1">&#39;scaler_params&#39;</span> <span class="ow">in</span> <span class="n">model_artifact</span><span class="p">:</span>
        <span class="n">scaler_features</span> <span class="o">=</span> <span class="n">model_artifact</span><span class="p">[</span><span class="s1">&#39;scaler_params&#39;</span><span class="p">][</span><span class="s1">&#39;feature_names&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scaler_features</span> <span class="o">!=</span> <span class="n">training_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FeatureAlignmentError</span><span class="p">(</span><span class="n">E903</span><span class="p">,</span>
                <span class="s2">&quot;縮放參數特徵順序與訓練特徵順序不一致，可能導致縮放錯位&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<hr />
<h2 id="3-error-code-hierarchy-specification">3. 錯誤代碼分層規範 (Error Code Hierarchy Specification)</h2>
<h3 id="30">3.0 分層架構總覽</h3>
<p>為確保全系統錯誤代碼的唯一性與可追蹤性，定義以下分層架構：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼範圍</th>
<th style="text-align: center;">層級</th>
<th style="text-align: left;">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E000</strong></td>
<td style="text-align: center;">全域</td>
<td style="text-align: left;">Pipeline 時間基準相關錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E001-E099</strong></td>
<td style="text-align: center;">系統層級</td>
<td style="text-align: left;">編碼、記憶體、檔案系統、配置檔錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E100-E199</strong></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">CSV/原始資料解析錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E200-E299</strong></td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">資料清洗與驗證錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E300-E349</strong></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">批次處理與 Parquet 儲存錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E350-E399</strong></td>
<td style="text-align: center;">Equipment Validation</td>
<td style="text-align: left;">設備相依性與物理邏輯驗證錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E400-E499</strong></td>
<td style="text-align: center;">Feature Annotation</td>
<td style="text-align: left;">特徵標註與設定檔錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E500-E599</strong></td>
<td style="text-align: center;">Governance</td>
<td style="text-align: left;">架構違規、職責分離與安全性錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E600-E699</strong></td>
<td style="text-align: center;">Feature Engineer</td>
<td style="text-align: left;">特徵工程與矩陣建構錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E700-E749</strong></td>
<td style="text-align: center;">Model Training</td>
<td style="text-align: left;">模型訓練與驗證錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E750-E799</strong></td>
<td style="text-align: center;">Hybrid Consistency</td>
<td style="text-align: left;">混合模型一致性驗證錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E800-E899</strong></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">最佳化與推論錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E900-E999</strong></td>
<td style="text-align: center;">跨階段整合</td>
<td style="text-align: left;">特徵對齊、版本相容性錯誤</td>
</tr>
</tbody>
</table>
<p><strong>遷移對照表</strong>（舊代碼 → 新代碼）：
- <code>E305</code> (Data Leakage) 保持不變（仍在 E3xx 範圍，但邏輯上屬於 Feature Engineer 階段）
- <code>E601-E602</code> (Feature Engineer 新增) 歸類於 E6xx
- <code>E701+</code> (Model Training) 歸類於 E7xx
- <code>E801+</code> (Optimization) 歸類於 E8xx（與舊 Training E801 區隔）
- <code>E901+</code> (跨階段對齊) 歸類於 E9xx</p>
<hr />
<h3 id="31-e000">3.1 全域時間基準錯誤 (E000)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E000</strong></td>
<td style="text-align: left;"><code>TEMPORAL_BASELINE_MISSING</code></td>
<td style="text-align: center;">Container/任意</td>
<td style="text-align: left;">pipeline_origin_timestamp 未傳遞或遺失</td>
<td style="text-align: left;">"時間基準遺失: 無法執行時間相關驗證"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="32-e001-e099">3.2 系統層級錯誤 (E001-E099)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E001</strong></td>
<td style="text-align: left;"><code>ENCODING_MISMATCH</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">檔案編碼無法偵測或輸出含非法字元 (BOM)</td>
<td style="text-align: left;">"檔案編碼錯誤: 無法識別編碼或包含 BOM 殘留"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E000</strong></td>
<td style="text-align: left;"><code>TEMPORAL_BASELINE_MISSING</code></td>
<td style="text-align: center;">PipelineContext</td>
<td style="text-align: left;">全域時間基準未初始化</td>
<td style="text-align: left;">"系統錯誤: 時間基準遺失"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E006</strong></td>
<td style="text-align: left;"><code>MEMORY_LIMIT_EXCEEDED</code></td>
<td style="text-align: center;">任意</td>
<td style="text-align: left;">記憶體使用超過配置上限</td>
<td style="text-align: left;">"記憶體不足: 已超過 {limit}GB 上限"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E007</strong></td>
<td style="text-align: left;"><code>CONFIG_FILE_CORRUPTED</code></td>
<td style="text-align: center;">ConfigLoader</td>
<td style="text-align: left;">YAML/JSON 設定檔解析失敗</td>
<td style="text-align: left;">"設定檔損毀: {filepath}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="33-etl-e100-e399">3.3 ETL 處理錯誤 (E100-E399)</h3>
<h3 id="33-etl-parser-e100-e199">3.3 ETL Parser 錯誤 (E100-E199)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: center;">Dtype</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E101</strong></td>
<td style="text-align: left;"><code>ENCODING_MISMATCH</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">無法偵測檔案編碼或含BOM</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E102</strong></td>
<td style="text-align: left;"><code>TIMEZONE_VIOLATION</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">時區非 UTC 或精度錯誤</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E103</strong></td>
<td style="text-align: left;"><code>CONTRACT_VIOLATION</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">缺少必要欄位或 Quality Flags 未定義</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E104</strong></td>
<td style="text-align: left;"><code>HEADER_NOT_FOUND</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">無法定位標頭行 (掃描 &gt; 500行)</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E105</strong></td>
<td style="text-align: left;"><code>COLUMN_VALIDATION</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">欄位正規化失敗或數值轉型失敗</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E111</strong></td>
<td style="text-align: left;"><code>TIMEZONE_WARNING</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">時區轉換警告 (非致命)</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E112</strong></td>
<td style="text-align: left;"><code>FUTURE_DATA_DETECTED</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">發現未來資料 (相對於 pipeline_timestamp)</td>
<td style="text-align: center;">Datetime</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<p><strong>Cleaner/BatchProcessor 階段 (E200-E299)</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E201</strong></td>
<td style="text-align: left;"><code>INPUT_SCHEMA_MISMATCH</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">輸入 DataFrame Schema 不符</td>
<td style="text-align: left;">"輸入資料格式不符: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E202</strong></td>
<td style="text-align: left;"><code>UNKNOWN_QUALITY_FLAG</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">輸入含未定義的品質標記</td>
<td style="text-align: left;">"品質標記未定義於 SSOT: {flags}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E203</strong></td>
<td style="text-align: left;"><code>METADATA_LOSS</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">未接收到 column_metadata</td>
<td style="text-align: left;">"缺少欄位元資料，使用保守預設"</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E205</strong></td>
<td style="text-align: left;"><code>FUTURE_DATA_IN_BATCH</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">批次資料包含超過 <code>pipeline_origin_timestamp + 5min</code> 的時間戳</td>
<td style="text-align: left;">"批次含未來資料，已拒絕"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E206</strong></td>
<td style="text-align: left;"><code>PARQUET_FORMAT_VIOLATION</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">Parquet 格式非 INT64/UTC</td>
<td style="text-align: left;">"Parquet 格式錯誤: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<p><strong>BatchProcessor 儲存階段 (E300-E399)</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E301</strong></td>
<td style="text-align: left;"><code>MANIFEST_INTEGRITY_FAILED</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">Manifest checksum 驗證失敗</td>
<td style="text-align: left;">"Manifest 檔案損毀或遭篡改"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E302</strong></td>
<td style="text-align: left;"><code>SCHEMA_MISMATCH</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">Parquet Schema 非 INT64/UTC</td>
<td style="text-align: left;">"輸入 Parquet 格式不符"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E303</strong></td>
<td style="text-align: left;"><code>UNKNOWN_QUALITY_FLAG</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">Manifest 的 flags 與 SSOT 不符</td>
<td style="text-align: left;">"Flags 版本不符: {detail}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E304</strong></td>
<td style="text-align: left;"><code>METADATA_MISSING</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">Manifest 無 feature_metadata</td>
<td style="text-align: left;">"缺少特徵元資料"</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E305</strong></td>
<td style="text-align: left;"><code>DATA_LEAKAGE_DETECTED</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">包含未來資料或目標變數洩漏</td>
<td style="text-align: left;">"資料洩漏風險: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<p><strong>Equipment Validation 階段 (E350-E399)</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E350</strong></td>
<td style="text-align: left;"><code>CONSTRAINT_CONFIG_ERROR</code></td>
<td style="text-align: center;">ValidationManager</td>
<td style="text-align: left;">依賴約束設定檔解析失敗</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E351</strong></td>
<td style="text-align: left;"><code>REQUIRES_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反「必須同時開啟」約束</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E352</strong></td>
<td style="text-align: left;"><code>MUTEX_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反「互斥」約束</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E353</strong></td>
<td style="text-align: left;"><code>SEQUENCE_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反開關機順序約束</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E354</strong></td>
<td style="text-align: left;"><code>MIN_RUNTIME_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反最小運轉時間限制</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E355</strong></td>
<td style="text-align: left;"><code>MIN_DOWNTIME_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反最小停機時間限制</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="34-feature-annotation-e400-e499">3.4 Feature Annotation 錯誤 (E400-E499)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E400</strong></td>
<td style="text-align: left;"><code>ANNOTATION_VERSION_MISMATCH</code></td>
<td style="text-align: center;">ConfigLoader/FE</td>
<td style="text-align: left;">Schema 版本不符或範本過舊</td>
<td style="text-align: left;">"Feature Annotation 版本過舊: 請執行 migrate-excel"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E401</strong></td>
<td style="text-align: left;"><code>ORPHAN_COLUMN</code></td>
<td style="text-align: center;">excel_to_yaml</td>
<td style="text-align: left;">標註欄位不存在於資料</td>
<td style="text-align: left;">"標註欄位 {col} 不存在於 CSV"</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E402</strong></td>
<td style="text-align: left;"><code>UNANNOTATED_COLUMN</code></td>
<td style="text-align: center;">ConfigLoader/Cleaner</td>
<td style="text-align: left;">資料欄位未定義於 Annotation</td>
<td style="text-align: left;">"未定義欄位: {col}，請執行 features wizard"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E403</strong></td>
<td style="text-align: left;"><code>UNIT_INCOMPATIBLE</code></td>
<td style="text-align: center;">excel_to_yaml</td>
<td style="text-align: left;">單位與物理類型不匹配</td>
<td style="text-align: left;">"單位錯誤: {unit} 不適用於 {physical_type}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E404</strong></td>
<td style="text-align: left;"><code>LAG_FORMAT_INVALID</code></td>
<td style="text-align: center;">excel_to_yaml</td>
<td style="text-align: left;">Lag 間隔格式錯誤</td>
<td style="text-align: left;">"Lag 格式錯誤: 必須為逗號分隔整數"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E405</strong></td>
<td style="text-align: left;"><code>TARGET_LEAKAGE_RISK</code></td>
<td style="text-align: center;">Pydantic Validation</td>
<td style="text-align: left;">is_target=True 但 enable_lag=True</td>
<td style="text-align: left;">"目標變數不可啟用 Lag"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E406</strong></td>
<td style="text-align: left;"><code>EXCEL_YAML_OUT_OF_SYNC</code></td>
<td style="text-align: center;">ConfigLoader</td>
<td style="text-align: left;">Excel 與 YAML 不同步</td>
<td style="text-align: left;">"設定不同步: 請執行 validate-annotation"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E407</strong></td>
<td style="text-align: left;"><code>CIRCULAR_INHERITANCE</code></td>
<td style="text-align: center;">AnnotationManager</td>
<td style="text-align: left;">YAML 繼承循環</td>
<td style="text-align: left;">"繼承循環偵測: {chain}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="35-governance-architecture-violations-e500-e599">3.5 Governance &amp; Architecture Violations (E500-E599)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E500</strong></td>
<td style="text-align: left;"><code>DEVICE_ROLE_LEAKAGE</code></td>
<td style="text-align: center;">Cleaner/BatchProcessor/FE</td>
<td style="text-align: left;">DataFrame 或 Metadata 含 device_role</td>
<td style="text-align: left;">"職責違反: device_role 不應出現在 DataFrame"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E501</strong></td>
<td style="text-align: left;"><code>DIRECT_WRITE_ATTEMPT</code></td>
<td style="text-align: center;">Wizard</td>
<td style="text-align: left;">試圖直接修改 YAML 檔案</td>
<td style="text-align: left;">"安全性違反: 禁止直接寫入 YAML，請使用 Excel"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="36-feature-engineer-e600-e699">3.6 Feature Engineer 錯誤 (E600-E699)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E601</strong></td>
<td style="text-align: left;"><code>FEATURE_ORDER_NOT_RECORDED</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">未輸出 feature_order_manifest</td>
<td style="text-align: left;">"特徵順序未記錄: 無法保證推論一致性"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E602</strong></td>
<td style="text-align: left;"><code>SCALER_PARAMS_MISSING</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">執行縮放但未輸出縮放參數</td>
<td style="text-align: left;">"縮放參數遺失: 推論階段將無法一致縮放"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E603</strong></td>
<td style="text-align: left;"><code>FEATURE_MATRIX_SHAPE_ERROR</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">特徵矩陣維度異常（如樣本數=0）</td>
<td style="text-align: left;">"特徵矩陣形狀錯誤: {shape}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E604</strong></td>
<td style="text-align: left;"><code>INVALID_LAG_CONFIGURATION</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">Lag 設定導致資料長度不足</td>
<td style="text-align: left;">"Lag 設定錯誤: 資料長度 {n} 小於最大 Lag {lag}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="37-model-training-e700-e749">3.7 Model Training 錯誤 (E700-E749)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E701</strong></td>
<td style="text-align: left;"><code>TRAINING_MEMORY_ERROR</code></td>
<td style="text-align: center;">ModelTrainer</td>
<td style="text-align: left;">GPU/CPU 記憶體不足</td>
<td style="text-align: left;">"訓練記憶體不足: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E702</strong></td>
<td style="text-align: left;"><code>VALIDATION_FAILURE</code></td>
<td style="text-align: center;">ModelValidator</td>
<td style="text-align: left;">驗證集性能低於門檻</td>
<td style="text-align: left;">"模型驗證失敗: MAPE {mape}% &gt; 門檻 {threshold}%"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E703</strong></td>
<td style="text-align: left;"><code>HYPERPARAMETER_INVALID</code></td>
<td style="text-align: center;">ModelTrainer</td>
<td style="text-align: left;">超參數組合無效</td>
<td style="text-align: left;">"無效超參數: {param}={value}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E704</strong></td>
<td style="text-align: left;"><code>CHECKPOINT_SAVE_FAILED</code></td>
<td style="text-align: center;">ModelTrainer</td>
<td style="text-align: left;">模型檢查點儲存失敗</td>
<td style="text-align: left;">"模型儲存失敗: {filepath}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E705</strong></td>
<td style="text-align: left;"><code>CROSS_VALIDATION_ERROR</code></td>
<td style="text-align: center;">ModelValidator</td>
<td style="text-align: left;">交叉驗證執行失敗</td>
<td style="text-align: left;">"交叉驗證錯誤: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E706</strong></td>
<td style="text-align: left;"><code>MODEL_ARTIFACT_CORRUPTED</code></td>
<td style="text-align: center;">ModelValidator</td>
<td style="text-align: left;">輸出模型檔案損毀或不完整</td>
<td style="text-align: left;">"模型產物損毀"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="38-hybrid-model-consistency-e750-e799">3.8 Hybrid Model Consistency (E750-E799)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E750</strong></td>
<td style="text-align: left;"><code>GOLDEN_DATASET_UNAVAILABLE</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">無可用的測試集或驗證集</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E751</strong></td>
<td style="text-align: left;"><code>DYNAMIC_TOLERANCE_EXCEEDED</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">預測誤差超過動態容許值</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E752</strong></td>
<td style="text-align: left;"><code>SYSTEMATIC_BIAS_DETECTED</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">偵測到系統性偏差 (Bias &gt; 5%)</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E753</strong></td>
<td style="text-align: left;"><code>TREND_MISMATCH</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">趨勢方向與物理邏輯不符 (Corr &lt; 0.95)</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E754</strong></td>
<td style="text-align: left;"><code>OUTLIER_VIOLATION</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">存在極端異常值 (&gt; 50kW)</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E755</strong></td>
<td style="text-align: left;"><code>INSUFFICIENT_COMPONENTS</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">L1等級（僅單一Component）無法驗證</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E756</strong></td>
<td style="text-align: left;"><code>PARTIAL_COMPONENTS_L2</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">僅使用L2等級（部分Components）驗證</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E757</strong></td>
<td style="text-align: left;"><code>LIGHT_LOAD_HIGH_VARIANCE</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">輕載區間誤差較高（正常現象）</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E758</strong></td>
<td style="text-align: left;"><code>COPULA_EFFECT_DETECTED</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">偵測到顯著耦合效應</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E759</strong></td>
<td style="text-align: left;"><code>DATASET_QUALITY_WARNING</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">使用驗證集或合併資料集</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="39-optimization-e800-e899">3.9 Optimization 錯誤 (E800-E899)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E801</strong></td>
<td style="text-align: left;"><code>MODEL_LOAD_FAILED</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">無法載入模型檔案</td>
<td style="text-align: left;">"模型載入失敗: {model_path}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E802</strong></td>
<td style="text-align: left;"><code>CONSTRAINT_VIOLATION</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">設備邏輯約束無法滿足</td>
<td style="text-align: left;">"約束違反: {constraint_detail}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E803</strong></td>
<td style="text-align: left;"><code>OPTIMIZATION_DIVERGENCE</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">求解器無法收斂</td>
<td style="text-align: left;">"最佳化發散: {solver_status}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E804</strong></td>
<td style="text-align: left;"><code>BOUND_INFEASIBILITY</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">變數邊界設定導致無解</td>
<td style="text-align: left;">"邊界不可行: {variable}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E805</strong></td>
<td style="text-align: left;"><code>FORECAST_HORIZON_MISMATCH</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">預測時程與最佳化時程不匹配</td>
<td style="text-align: left;">"預測時程錯誤: 需 {required} 步，得 {actual} 步"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E806</strong></td>
<td style="text-align: left;"><code>SYSTEM_MODEL_DISCREPANCY</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">System Model 與 Component Models 加總差異 &gt; 5%</td>
<td style="text-align: left;">"模型不一致: 系統級與元件級預測差異 {diff}%"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E807</strong></td>
<td style="text-align: left;"><code>EQUIPMENT_STATE_INVALID</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">設備狀態違反物理邏輯（如主機開但水泵關）</td>
<td style="text-align: left;">"設備狀態無效: {equipment_logic}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E808</strong></td>
<td style="text-align: left;"><code>WEATHER_DATA_MISSING</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">缺少未來天氣預測資料</td>
<td style="text-align: left;">"天氣資料缺失: 無法執行未來 {hours} 小時最佳化"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="310-e900-e999">3.10 跨階段整合錯誤 (E900-E999)</h3>
<p><strong>Training-Optimization 特徵對齊錯誤</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E901</strong></td>
<td style="text-align: left;"><code>FEATURE_ALIGNMENT_MISMATCH</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">推論特徵順序/名稱與訓練時不一致</td>
<td style="text-align: left;">"特徵對齊錯誤: 索引 {index} 預期 '{expected}'，實際 '{actual}'"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E902</strong></td>
<td style="text-align: left;"><code>FEATURE_DIMENSION_MISMATCH</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">推論特徵維度與訓練時不同</td>
<td style="text-align: left;">"特徵維度錯誤: 訓練 {train_dim} 維，輸入 {input_dim} 維"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E903</strong></td>
<td style="text-align: left;"><code>SCALER_MISMATCH</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">縮放參數與特徵不匹配或缺失</td>
<td style="text-align: left;">"縮放參數錯誤: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E904</strong></td>
<td style="text-align: left;"><code>MODEL_VERSION_INCOMPATIBLE</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">模型版本與 Optimization 引擎不相容</td>
<td style="text-align: left;">"模型版本不相容: 模型 v{model_ver}，引擎需 &gt;= {engine_ver}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E905</strong></td>
<td style="text-align: left;"><code>PIPELINE_VERSION_DRIFT</code></td>
<td style="text-align: center;">Container</td>
<td style="text-align: left;">跨模組版本組合未通過相容性矩陣驗證</td>
<td style="text-align: left;">"版本漂移: {module_a} v{ver_a} 與 {module_b} v{ver_b} 不相容"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-dataframe-dataframe-interface-standard">4. DataFrame 介面標準 (DataFrame Interface Standard)</h2>
<h3 id="41">4.1 欄位命名與型別規範</h3>
<p><strong>標準時間戳欄位</strong>:
- <strong>名稱</strong>: <code>timestamp</code>（強制小寫，不可使用 <code>time</code>, <code>date</code>, <code>datetime</code>）
- <strong>Polars 型別</strong>: <code>pl.Datetime(time_unit='ns', time_zone='UTC')</code>
- <strong>Parquet 物理型別</strong>: <code>INT64</code> (nanoseconds since epoch, UTC)
- <strong>禁止</strong>: <code>INT96</code>, <code>microseconds</code>, <code>milliseconds</code>, 無時區 (naive)</p>
<p><strong>品質標記欄位</strong>:
- <strong>名稱</strong>: <code>quality_flags</code>
- <strong>Polars 型別</strong>: <code>pl.List(pl.Utf8)</code>
- <strong>值域</strong>: 必須是 <code>VALID_QUALITY_FLAGS</code> 的子集
- <strong>Parquet 儲存</strong>: 以 JSON string 儲存，<code>BYTE_ARRAY</code> 邏輯型別</p>
<p><strong>數值欄位（感測器資料）</strong>:
- <strong>Polars 型別</strong>: <code>pl.Float64</code>（統一使用 Float64，即使原始資料為整數）
- <strong>單位</strong>: 必須為 SI 單位（如 <code>kW</code>, <code>°C</code>, <code>LPM</code>），<strong>禁止</strong>在欄位名稱中編碼單位（如 <code>temp_c</code>, <code>power_kw</code>）
- <strong>Null 值</strong>: 使用 Polars <code>null</code>（非 <code>NaN</code> 或 magic number）
- <strong>精度保留</strong>: 單位轉換後必須保留至少 <strong>6 位有效數字</strong>（避免 0.1°C 精度損失影響 HVAC 決策）</p>
<p><strong>禁止欄位（絕對禁止出現在 DataFrame 中）</strong>:
- <code>device_role</code>: 必須由 FeatureAnnotationManager 動態查詢，不得寫入資料
- <code>ignore_warnings</code>: 同上
- <code>is_target</code>: 同上
- <code>__index_level_0__</code>: Pandas 殘留索引，必須移除</p>
<h3 id="42-metadata-column_metadata">4.2 Metadata 字典規範 (column_metadata)</h3>
<p><strong>允許的鍵值</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="s2">&quot;column_name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>           <span class="c1"># 欄位名稱（與 DataFrame 欄位一致）</span>
    <span class="s2">&quot;physical_type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>         <span class="c1"># 必須是 PHYSICAL_TYPES 的 key</span>
    <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>        <span class="c1"># 單位符號</span>
    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>  <span class="c1"># 人類可讀描述</span>
    <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>             <span class="c1"># 有效數字位數（預設 6）</span>
    <span class="s2">&quot;temporal_baseline&quot;</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># ISO 8601 格式時間戳（傳遞用）</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>禁止的鍵值</strong>:
- <code>device_role</code>
- <code>ignore_warnings</code>
- <code>is_target</code>
- <code>valid_range</code>（應從 Annotation 查詢，非 metadata）</p>
<hr />
<h2 id="5-version-compatibility-matrix">5. 版本相容性判定標準 (Version Compatibility Matrix)</h2>
<h3 id="51">5.1 相容性等級定義</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">等級</th>
<th style="text-align: left;">定義</th>
<th style="text-align: left;">行為</th>
<th style="text-align: center;">標示</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>完全相容</strong> (Full Compatible)</td>
<td style="text-align: left;">上下游模組版本組合通過所有檢查點，無需轉換或降級</td>
<td style="text-align: left;">正常執行，無警告</td>
<td style="text-align: center;">🟢</td>
</tr>
<tr>
<td style="text-align: center;"><strong>部分相容</strong> (Partial Compatible)</td>
<td style="text-align: left;">上游輸出可被下游讀取，但部分功能降級（如缺少 audit_trail）</td>
<td style="text-align: left;">執行，但記錄 Warning</td>
<td style="text-align: center;">🟡</td>
</tr>
<tr>
<td style="text-align: center;"><strong>不相容</strong> (Incompatible)</td>
<td style="text-align: left;">上游輸出無法通過下游檢查點，或資料語意不一致</td>
<td style="text-align: left;">拒絕執行，拋出錯誤</td>
<td style="text-align: center;">🔴</td>
</tr>
</tbody>
</table>
<h3 id="52">5.2 模組版本相容性矩陣</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">Parser</th>
<th style="text-align: center;">Cleaner</th>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;">Model Training</th>
<th style="text-align: center;">Optimization</th>
<th style="text-align: center;">相容性</th>
<th style="text-align: left;">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">🟢 <strong>完全相容</strong></td>
<td style="text-align: left;">推薦配置，支援特徵對齊驗證 E901-E903</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">🔴 <strong>不相容</strong></td>
<td style="text-align: left;">Optimization v1.0 缺少特徵對齊檢查點 #7</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">🟡 <strong>部分相容</strong></td>
<td style="text-align: left;">FE v1.2 無法輸出 feature_order_manifest，觸發 E601</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">🟡 <strong>部分相容</strong></td>
<td style="text-align: left;">Training v1.1 未輸出 scaler_params，Optimization 使用預設值</td>
</tr>
<tr>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">🔴 <strong>不相容</strong></td>
<td style="text-align: left;">若 Model 未包含 feature_order_manifest，觸發 E901</td>
</tr>
</tbody>
</table>
<h3 id="53">5.3 強制升級路徑</h3>
<p><strong>不允許的組合</strong>（系統必須拒絕啟動）：
1. Parser/Cleaner v2.0 + 任意下游（時區/職責分離衝突）
2. Feature Engineer v1.2 + Optimization v1.1（缺少特徵對齊機制，E901 無法通過）
3. Model Training v1.1 + Optimization v1.1（缺少標準化 scaler_params，E903 風險）</p>
<p><strong>建議升級順序</strong>：</p>
<div class="codehilite"><pre><span></span><code>Feature Annotation v1.2 (基礎設施)
    ↓
Parser v2.1 (上游輸出標準化)
    ↓
Cleaner v2.2 (職責分離實作)
    ↓
BatchProcessor v1.3 (時間基準傳遞)
    ↓
FeatureEngineer v1.3 (特徵順序保證 E601)
    ↓
Model Training v1.2 (縮放參數輸出 E602)
    ↓
Optimization v1.1 (特徵對齊驗證 E901-E903)
</code></pre></div>

<hr />
<h2 id="6-implementation-checklist">6. 實作檢查清單 (Implementation Checklist)</h2>
<h3 id="61">6.1 開發前必須確認</h3>
<ul>
<li>[ ] 所有模組 PRD 引用本文件作為「檢查點」與「錯誤代碼」的 SSOT</li>
<li>[ ] <code>src/etl/config_models.py</code> 已定義 <code>VALID_QUALITY_FLAGS</code>, <code>TIMESTAMP_CONFIG</code>, <code>FEATURE_ANNOTATION_CONSTANTS</code></li>
<li>[ ] <strong>新增</strong>: <code>src/core/temporal_baseline.py</code> 已實作 <code>PipelineTemporalBaseline</code> 類別（見第8章）</li>
<li>[ ] <strong>新增</strong>: <code>src/optimization/feature_alignment.py</code> 已實作對齊驗證邏輯（E901-E903）</li>
<li>[ ] 各模組的 <code>ERROR_CODES</code> 字典必須與本文件第 3 節完全一致（含新分層 E600-E999）</li>
</ul>
<h3 id="62">6.2 開發中驗證</h3>
<ul>
<li>[ ] 每個檢查點必須有對應的單元測試（故意注入錯誤，驗證錯誤代碼正確）</li>
<li>[ ] E500 檢查必須使用 Property-Based Testing（隨機生成 device_role 值，驗證絕對不會出現在輸出）</li>
<li>[ ] <strong>新增</strong>: E901-E903 檢查必須使用「錯誤順序特徵」測試（故意打亂特徵順序，驗證系統正確拒絕）</li>
<li>[ ] <strong>新增</strong>: 時間基準測試（模擬長時間執行，驗證未來資料檢查使用固定基準而非動態時間）</li>
<li>[ ] 版本相容性矩陣必須有整合測試覆蓋（使用不同版本組合的 fixture）</li>
</ul>
<h3 id="63">6.3 上線前驗收</h3>
<ul>
<li>[ ] 執行端到端契約測試：Parser → Cleaner → BatchProcessor → FeatureEngineer → Model Training → Optimization，驗證檢查點 1-7 全部通過</li>
<li>[ ] 執行 Annotation 流程測試：Excel → Wizard → excel_to_yaml → Container，驗證檢查點 5-6 全部通過</li>
<li>[ ] <strong>新增</strong>: 執行特徵對齊壓力測試：訓練後故意修改特徵順序，驗證 Optimization 階段正確拋出 E901</li>
<li>[ ] 驗證錯誤訊息：所有錯誤代碼必須輸出本文件定義的「使用者訊息範本」</li>
</ul>
<hr />
<h2 id="7">7. 附錄：術語對照表</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">術語</th>
<th style="text-align: left;">定義</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SSOT</strong> (Single Source of Truth)</td>
<td style="text-align: left;">單一真相源，指 <code>config_models.py</code> 中定義的常數與型別</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Checkpoint</strong></td>
<td style="text-align: left;">模組間的介面驗證點，資料通過時必須符合的規格</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Device Role</strong></td>
<td style="text-align: left;">設備角色（primary/backup/seasonal），定義於 Feature Annotation，<strong>不得</strong>寫入 DataFrame</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Audit Trail</strong></td>
<td style="text-align: left;">稽核軌跡，記錄資料處理過程中的版本、繼承鏈、checksum 等資訊</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Manifest</strong></td>
<td style="text-align: left;">BatchProcessor 輸出的 JSON 檔案，記錄批次處理的元資料與檔案清單</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Leakage</strong> (E500)</td>
<td style="text-align: left;">職責違反，指 device_role 等 Annotation 元資料意外寫入 DataFrame</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Feature Order Manifest</strong></td>
<td style="text-align: left;">記錄特徵欄位順序與雜湊的結構，確保 Training 與 Optimization 階段特徵順序一致</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Temporal Baseline</strong></td>
<td style="text-align: left;">Pipeline 啟動時的統一時間戳，所有未來資料檢查的基準</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-pipeline-temporal-baseline-propagation">8. Pipeline 時間基準傳遞規範 (Temporal Baseline Propagation)</h2>
<h3 id="81">8.1 核心機制</h3>
<p>為解決「Pipeline 執行期間時間漂移導致未來資料誤判」問題（原 E102/E205 風險），建立以下機制：</p>
<p><strong>時間基準產生</strong>：
- <strong>時機</strong>: <code>Container.__init__</code> 初始化時（第一個動作，早於任何模組初始化）
- <strong>格式</strong>: ISO 8601 UTC (e.g., <code>2026-02-13T10:00:00.000000000Z</code>)
- <strong>儲存</strong>: <code>TemporalContext</code> 物件（Thread-safe Singleton）</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TemporalContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    全域時間基準容器（單例模式）</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_instance</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">origin_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得 Pipeline 啟動時間戳&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_timestamp</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">tolerance_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        判斷時間戳是否為「未來資料」</span>
<span class="sd">        標準：timestamp &gt; origin_timestamp + tolerance_minutes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_timestamp</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">tolerance_minutes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</code></pre></div>

<p><strong>傳遞機制</strong>：
1. <strong>Container → 各模組</strong>: 通過建構子注入 <code>temporal_context: TemporalContext</code>
2. <strong>模組間傳遞</strong>: 通過 DataFrame metadata 或 Manifest 欄位 <code>temporal_baseline</code>
3. <strong>檢查點驗證</strong>: 每個檢查點驗證輸入資料的 <code>temporal_baseline</code> 與當前 Context 一致（防止跨 Pipeline 混用）</p>
<h3 id="82">8.2 各模組實作規範</h3>
<p><strong>Parser</strong>:
- 接收 <code>TemporalContext</code>，在輸出 metadata 中記錄 <code>pipeline_origin_timestamp</code>
- 驗證邏輯：若輸入資料時間 &gt; <code>context.get_baseline() + 5min</code>，拋出 E102</p>
<p><strong>Cleaner</strong>:
- 從輸入 metadata 讀取 <code>pipeline_origin_timestamp</code>，傳遞至輸出
- 驗證邏輯：清洗後資料時間不可超過基準+5分鐘（E102）</p>
<p><strong>BatchProcessor</strong>:
- 將 <code>temporal_baseline</code> 寫入 Manifest（見 2.3 節 Manifest 契約）
- 批次驗證：整個批次時間範圍不可超過基準+5分鐘（E205）</p>
<p><strong>FeatureEngineer → Model Training</strong>:
- 特徵矩陣 metadata 必須包含 <code>pipeline_origin_timestamp</code>（用於追溯）
- <strong>注意</strong>: Training 階段不直接使用此時間戳進行「未來檢查」，但必須傳遞至模型產物</p>
<p><strong>Optimization</strong>:
- <strong>產生新基準</strong>: Optimization 階段必須產生新的 <code>pipeline_origin_timestamp</code>（推論當下時間）
- <strong>不可沿用 Training 時間</strong>: 防止「訓練時的未來資料」在推論時變成「過去資料」的邏輯錯誤</p>
<h3 id="83">8.3 錯誤處理</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">場景</th>
<th style="text-align: center;">錯誤代碼</th>
<th style="text-align: left;">處理方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Container 未初始化 TemporalContext</td>
<td style="text-align: center;">E000</td>
<td style="text-align: left;">立即終止，記錄「時間基準未建立」</td>
</tr>
<tr>
<td style="text-align: left;">模組接收不到 temporal_baseline</td>
<td style="text-align: center;">E000</td>
<td style="text-align: left;">終止流程，要求檢查上游輸出</td>
</tr>
<tr>
<td style="text-align: left;">時間戳格式非 ISO 8601 UTC</td>
<td style="text-align: center;">E002</td>
<td style="text-align: left;">視為時區違反</td>
</tr>
<tr>
<td style="text-align: left;">基準時間與系統時間差距過大（&gt;1小時）</td>
<td style="text-align: center;">E000-Warning</td>
<td style="text-align: left;">警告「Pipeline 執行時間過長或系統時間異常」</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9-feature-alignment-scaling-contract">9. 特徵對齊與縮放參數傳遞規範 (Feature Alignment &amp; Scaling Contract)</h2>
<h3 id="91">9.1 問題定義</h3>
<p>為解決「Training 與 Optimization 特徵向量不一致導致 Silent Failure」風險（原第3點建議），建立以下嚴格契約：</p>
<p><strong>風險場景</strong>：
- Training: 特徵順序 <code>[chiller_1_load, chiller_2_load, wb_temp, ...]</code>
- Optimization: 特徵順序 <code>[wb_temp, chiller_1_load, chiller_2_load, ...]</code>
- 結果：模型將 <code>wb_temp</code> 誤認為 <code>chiller_2_load</code>，導致預測完全錯誤但無警告</p>
<h3 id="92-feature-manifest">9.2 Feature Manifest 規格</h3>
<p><strong>輸出位置</strong>: <code>ModelTrainer</code> 輸出目錄中的 <code>feature_manifest.json</code></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;manifest_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0-ALIGN&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-02-13T10:30:00Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;pipeline_origin_timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-02-13T10:00:00Z&quot;</span><span class="p">,</span>

<span class="w">  </span><span class="nt">&quot;feature_specification&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;feature_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;chiller_1_load&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;chiller_2_load&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wb_temp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;chwst_temp&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;feature_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;feature_hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256:a1b2c3d4...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;hash_algorithm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SHA256&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;hash_computation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256(&#39;,&#39;.join(feature_names).encode())&quot;</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="nt">&quot;scaling_specification&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;scaler_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;StandardScaler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;scaler_params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;mean_&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">450.5</span><span class="p">,</span><span class="w"> </span><span class="mf">420.3</span><span class="p">,</span><span class="w"> </span><span class="mf">28.5</span><span class="p">,</span><span class="w"> </span><span class="mf">7.2</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;scale_&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">120.2</span><span class="p">,</span><span class="w"> </span><span class="mf">115.8</span><span class="p">,</span><span class="w"> </span><span class="mf">2.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;var_&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">14448.04</span><span class="p">,</span><span class="w"> </span><span class="mf">13401.64</span><span class="p">,</span><span class="w"> </span><span class="mf">4.41</span><span class="p">,</span><span class="w"> </span><span class="mf">0.25</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;scaler_feature_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;chiller_1_load&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;chiller_2_load&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wb_temp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;chwst_temp&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;scaler_hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256:e5f6g7h8...&quot;</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="nt">&quot;validation_rules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;allow_subset&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;allow_superset&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;strict_order&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;case_sensitive&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="93-optimization">9.3 對齊驗證流程 (Optimization 階段)</h3>
<p><strong>Step 1: 完整性檢查</strong> (E901)</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;feature_manifest.json&#39;</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">E901</span><span class="p">(</span><span class="s2">&quot;缺少 feature_manifest，無法驗證特徵對齊&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Step 2: 特徵清單比對</strong> (E901)</p>
<div class="codehilite"><pre><span></span><code><span class="n">expected_features</span> <span class="o">=</span> <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;feature_specification&#39;</span><span class="p">][</span><span class="s1">&#39;feature_names&#39;</span><span class="p">]</span>
<span class="n">input_features</span> <span class="o">=</span> <span class="n">get_input_feature_names</span><span class="p">()</span>  <span class="c1"># 從 Optimization 輸入取得</span>

<span class="k">if</span> <span class="n">expected_features</span> <span class="o">!=</span> <span class="n">input_features</span><span class="p">:</span>
    <span class="c1"># 詳細差異分析</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dictdiffer</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">expected_features</span><span class="p">,</span> <span class="n">input_features</span><span class="p">))</span>
    <span class="k">raise</span> <span class="n">E901</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;特徵順序不匹配: </span><span class="si">{</span><span class="n">diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Step 3: 雜湊驗證</strong> (E901-optional)</p>
<div class="codehilite"><pre><span></span><code><span class="n">computed_hash</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="k">if</span> <span class="n">computed_hash</span> <span class="o">!=</span> <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;feature_specification&#39;</span><span class="p">][</span><span class="s1">&#39;feature_hash&#39;</span><span class="p">]:</span>
    <span class="k">raise</span> <span class="n">E901</span><span class="p">(</span><span class="s2">&quot;特徵雜湊驗證失敗：特徵名稱或順序被修改&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Step 4: 縮放參數應用</strong> (E903)</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;scaling_specification&#39;</span><span class="p">][</span><span class="s1">&#39;scaler_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;StandardScaler&#39;</span><span class="p">:</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">mean_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;scaling_specification&#39;</span><span class="p">][</span><span class="s1">&#39;scaler_params&#39;</span><span class="p">][</span><span class="s1">&#39;mean_&#39;</span><span class="p">])</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">scale_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;scaling_specification&#39;</span><span class="p">][</span><span class="s1">&#39;scaler_params&#39;</span><span class="p">][</span><span class="s1">&#39;scale_&#39;</span><span class="p">])</span>

    <span class="c1"># 驗證縮放參數長度</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">mean_</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_features</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">E902</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;縮放參數長度 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">mean_</span><span class="p">)</span><span class="si">}</span><span class="s2"> 與特徵數 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span><span class="si">}</span><span class="s2"> 不匹配&quot;</span><span class="p">)</span>

    <span class="c1"># 驗證縮放參數順序（通過 feature_names 比對）</span>
    <span class="k">if</span> <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;scaling_specification&#39;</span><span class="p">][</span><span class="s1">&#39;scaler_feature_names&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">input_features</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">E903</span><span class="p">(</span><span class="s2">&quot;縮放參數特徵順序與輸入特徵順序不一致&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="94">9.4 容錯與恢復策略</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">錯誤情境</th>
<th style="text-align: left;">自動恢復策略</th>
<th style="text-align: left;">人工介入</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">E901: 特徵順序錯誤</td>
<td style="text-align: left;"><strong>禁止自動恢復</strong></td>
<td style="text-align: left;">必須檢查 ETL 流程，確認特徵產生邏輯</td>
</tr>
<tr>
<td style="text-align: left;">E902: 維度不匹配</td>
<td style="text-align: left;">檢查是否缺少常數特徵（如 bias），若可補零則補零並警告</td>
<td style="text-align: left;">確認特徵工程邏輯變更</td>
</tr>
<tr>
<td style="text-align: left;">E903: 縮放參數缺失</td>
<td style="text-align: left;">使用線上統計即時計算 mean/std，標記為「非確定性縮放」</td>
<td style="text-align: left;">建議重新訓練模型以固定縮放參數</td>
</tr>
</tbody>
</table>
<h3 id="95">9.5 與現有檢查點的整合</h3>
<ul>
<li><strong>檢查點 #4</strong> (FeatureEngineer → Model Training): 驗證 Feature Manifest 正確產生（E601, E602）</li>
<li><strong>檢查點 #7</strong> (Model Training → Optimization): 驗證 Feature Manifest 正確載入與比對（E901, E902, E903）</li>
</ul>
<hr />
<p><strong>簽核欄</strong>：
- [ ] 架構師確認：檢查點定義涵蓋所有模組間介面（含 Training-Optimization）
- [ ] 技術負責人確認：錯誤代碼分層 E000-E999 無衝突，E901-E903 已正確定義
- [ ] HVAC 領域專家確認：時間基準機制與特徵對齊機制符合領域需求（精度、延遲容忍度）
- [ ] 維運負責人確認：版本相容性矩陣可指導部署決策
```</p>
<p>此修正版已完整納入您的三項要求：</p>
<ol>
<li>
<p><strong>錯誤代碼分層規範</strong>：建立 E000-E999 的完整分層架構，解決原本 E800 衝突問題（Training 與 Optimization 現在有各自獨立的 E7xx 與 E8xx 區段），並提供遷移對照表。</p>
</li>
<li>
<p><strong>時間基準傳遞規範</strong>：新增第8章詳細定義 <code>pipeline_origin_timestamp</code> 機制，從 Container 初始化、跨模組傳遞、到未來資料檢查的統一基準，解決時間漂移問題。</p>
</li>
<li>
<p><strong>特徵對齊驗證</strong>：新增第9章與檢查點 #7，定義 Feature Manifest 規格、雜湊驗證、縮放參數傳遞機制，並新增 E901-E903 錯誤代碼專門處理 Training-Optimization 特徵錯位風險。</p>
</li>
</ol>
    
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>

</body>
</html>
