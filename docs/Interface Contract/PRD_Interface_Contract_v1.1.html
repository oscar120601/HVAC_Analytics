<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_Interface_Contract_v1.1</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v11-interface-contract-specification">PRD v1.1: 模組介面契約總綱 (Interface Contract Specification)</h1>
<p><strong>文件版本:</strong> v1.1-Revised (Project Execution Evaluation Alignment)<br />
<strong>日期:</strong> 2026-02-14<br />
<strong>負責人:</strong> Oscar Chang<br />
<strong>範圍:</strong> 全 ETL Pipeline + Model Training + Optimization 模組間介面規範<br />
<strong>相依文件:</strong> <br />
- Parser v2.1+, Cleaner v2.2+, BatchProcessor v1.3+, FeatureEngineer v1.3+<br />
- Feature Annotation v1.2+, Model Training v1.2+, Optimization v1.1+<br />
- Equipment Dependency Validation v1.0+</p>
<p><strong>修正重點 (v1.0 → v1.1):</strong><br />
- 新增 Header Standardization 具體 Regex 規則（回應評估報告建議）<br />
- 強化 PipelineContext 時間一致性防護（解決 Spatio-Temporal Inconsistency 風險）<br />
- 建立 Equipment Validation 與 Cleaner 的反向同步機制（解決 Physics Logic Decoupling）<br />
- 強化 Feature Annotation SSOT 引用檢查（預防 Dependency Deadlock）</p>
<hr />
<h2 id="1">1. 設計哲學與核心原則</h2>
<h3 id="11-contract-first">1.1 契約優先 (Contract-First)</h3>
<p>所有模組間的資料交換必須通過<strong>靜態型別檢查</strong>與<strong>執行期驗證</strong>雙重確認。契約一經定義，上游模組有義務確保輸出符合，下游模組有權利假設輸入符合，任何違反視為系統錯誤。</p>
<h3 id="12-defensive-validation">1.2 防禦性驗證 (Defensive Validation)</h3>
<ul>
<li><strong>上游驗證</strong>: 模組輸出前必須自我驗證（Self-Check），確保不傳遞「已知錯誤」</li>
<li><strong>下游驗證</strong>: 模組輸入時必須嚴格驗證（Strict Validation），拒絕任何不符合契約的輸入</li>
<li><strong>容錯策略</strong>: 寧可<strong>終止流程</strong>（Fail Fast），也不傳遞可疑資料</li>
</ul>
<h3 id="13-ssot">1.3 單一真相源 (SSOT) 強制引用</h3>
<p>所有驗證邏輯必須引用 <code>src/etl/config_models.py</code> 中定義的常數：<br />
- <code>VALID_QUALITY_FLAGS</code>: 品質標記唯一清單<br />
- <code>TIMESTAMP_CONFIG</code>: 時間戳規格（UTC, nanoseconds, INT64）<br />
- <code>FEATURE_ANNOTATION_CONSTANTS</code>: Feature Annotation 版本與 schema 定義<br />
- <code>PIPELINE_TEMPORAL_BASELINE</code>: 時間基準傳遞規格（見第8章）<br />
- <code>HEADER_STANDARDIZATION_RULES</code>: CSV 標頭正規化規則（見第10章，新增）<br />
- <code>EQUIPMENT_VALIDATION_CONSTRAINTS</code>: 設備邏輯限制（見第11章，新增）</p>
<h3 id="14-global-temporal-baseline">1.4 全域時間基準 (Global Temporal Baseline)</h3>
<p>所有「未來資料檢查」與「時間相關驗證」必須使用 Pipeline 啟動時產生的<strong>統一時間戳</strong>（<code>pipeline_origin_timestamp</code>），而非模組執行時的動態 <code>datetime.now()</code>，以防止長時間執行流程中的時間漂移（見第8章）。</p>
<h3 id="15-physics-logic-consistency">1.5 物理邏輯一致性 (Physics Logic Consistency)</h3>
<p>DataCleaner 的資料清洗邏輯必須與 Optimization 的設備限制條件保持一致，防止「清洗時未檢測違規，優化時卻發現不可行」的邏輯脫鉤（見第11章）。</p>
<hr />
<h2 id="2-checkpoint-specifications">2. 檢查點規格 (Checkpoint Specifications)</h2>
<h3 id="21-1-parser-cleaner-raw-data-contract">2.1 檢查點 #1: Parser → Cleaner (Raw Data Contract)</h3>
<p><strong>位置</strong>: <code>src/etl/parser.py</code> 輸出驗證 (<code>_validate_output_contract</code>)</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>必要欄位</strong></td>
<td style="text-align: left;">必須包含 <code>timestamp</code></td>
<td style="text-align: center;">E003</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間戳型別</strong></td>
<td style="text-align: left;"><code>pl.Datetime(time_unit='ns', time_zone='UTC')</code></td>
<td style="text-align: center;">E002</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間戳物理型別</strong></td>
<td style="text-align: left;">Parquet 層級必須為 <code>INT64</code> (非 INT96)</td>
<td style="text-align: center;">E002</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間戳時區</strong></td>
<td style="text-align: left;"><code>time_zone</code> 屬性必須等於 <code>"UTC"</code></td>
<td style="text-align: center;">E002</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>編碼正確性</strong></td>
<td style="text-align: left;">無 UTF-8 BOM (<code>\ufeff</code>) 殘留</td>
<td style="text-align: center;">E001</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Null Byte 檢查</strong></td>
<td style="text-align: left;">字串欄位不可包含 <code>\x00</code></td>
<td style="text-align: center;">E001</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Quality Flags</strong></td>
<td style="text-align: left;">若存在，值必須 ⊆ <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: center;">E003</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>數值欄位型別</strong></td>
<td style="text-align: left;">感測器數據必須為 <code>pl.Float64</code></td>
<td style="text-align: center;">E003</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>換行符號</strong></td>
<td style="text-align: left;">統一為 <code>\n</code> (LF)，不可有 <code>\r</code> (CR)</td>
<td style="text-align: center;">E001</td>
<td style="text-align: center;">Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準繼承</strong></td>
<td style="text-align: left;">必須接收並傳遞 <code>pipeline_origin_timestamp</code></td>
<td style="text-align: center;">E000</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>標頭正規化</strong></td>
<td style="text-align: left;">欄位名稱必須符合 Header Standardization 規則（見第10章）</td>
<td style="text-align: center;"><strong>E105</strong></td>
<td style="text-align: center;">High</td>
</tr>
</tbody>
</table>
<p><strong>容錯處理</strong>:<br />
- 時區非 UTC: 嘗試自動轉換並發出 <strong>E101 Warning</strong>（僅限 Parser v2.1 相容模式，v2.2+ 視為錯誤）<br />
- 編碼非 UTF-8: 嘗試轉換，失敗則拋出 <strong>E001 Error</strong><br />
- 標頭不符合命名規範: 嘗試自動正規化（見第10章），記錄 <strong>E105 Warning</strong></p>
<hr />
<h3 id="22-2-cleaner-batchprocessor-clean-data-contract">2.2 檢查點 #2: Cleaner → BatchProcessor (Clean Data Contract)</h3>
<p><strong>位置</strong>: <code>src/etl/cleaner.py</code> 輸出驗證 (<code>_validate_output_contract</code>) 與 BatchProcessor 輸入驗證 (<code>_validate_input_contract</code>)</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>時間戳連續性</strong></td>
<td style="text-align: left;"><code>timestamp</code> 必須為連續時間軸（無缺口）或明確標記 <code>INSUFFICIENT_DATA</code></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Info</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Quality Flags 型別</strong></td>
<td style="text-align: left;"><code>pl.List(pl.Utf8)</code></td>
<td style="text-align: center;">E201</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Quality Flags 值域</strong></td>
<td style="text-align: left;">所有值必須 ∈ <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: center;">E202</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Metadata 傳遞</strong></td>
<td style="text-align: left;">必須提供 <code>column_metadata: Dict[str, FeatureMetadata]</code></td>
<td style="text-align: center;">E203</td>
<td style="text-align: center;">Warning</td>
</tr>
<tr>
<td style="text-align: left;"><strong>禁止欄位檢查</strong></td>
<td style="text-align: left;"><strong>不可包含</strong> <code>device_role</code>, <code>ignore_warnings</code>, <code>is_target</code></td>
<td style="text-align: center;"><strong>E500</strong></td>
<td style="text-align: center;"><strong>Critical</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>未來資料檢查</strong></td>
<td style="text-align: left;">時間戳不可超過 <code>pipeline_origin_timestamp + 5 minutes</code></td>
<td style="text-align: center;">E102</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時區一致性</strong></td>
<td style="text-align: left;">必須為 UTC (ns)，與檢查點 #1 相同</td>
<td style="text-align: center;">E201</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準一致性</strong></td>
<td style="text-align: left;">輸出 metadata 必須包含與輸入相同的 <code>pipeline_origin_timestamp</code></td>
<td style="text-align: center;">E000</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>物理邏輯預檢</strong></td>
<td style="text-align: left;">若啟用 <code>equipment_validation_sync</code>，必須通過基礎設備邏輯檢查（見第11章）</td>
<td style="text-align: center;"><strong>E350</strong></td>
<td style="text-align: center;">High</td>
</tr>
</tbody>
</table>
<p><strong>關鍵約束</strong>:<br />
- <strong>E500 (Device Role Leakage)</strong>: Cleaner v2.2 絕對禁止將 <code>device_role</code> 寫入 DataFrame 或 metadata。此檢查為<strong>零容錯</strong>（Zero Tolerance），一旦發現立即終止流程。<br />
- <strong>Metadata 純淨性</strong>: <code>column_metadata</code> 僅可包含 <code>physical_type</code>, <code>unit</code>, <code>description</code>，禁止包含 <code>device_role</code>（即使從 AnnotationManager 讀取也不得寫入）。<br />
- <strong>物理邏輯同步</strong> (新增): 若 config 啟用 <code>enforce_equipment_validation_sync</code>，Cleaner 必須檢查基礎設備邏輯（如主機開啟時冷卻水塔不可全關），提前標記違規資料。</p>
<hr />
<h3 id="23-3-batchprocessor-featureengineer-storage-contract">2.3 檢查點 #3: BatchProcessor → FeatureEngineer (Storage Contract)</h3>
<p><strong>位置</strong>: <code>src/etl/batch_processor.py</code> 輸出驗證 (<code>_verify_parquet_schema</code>) 與 FeatureEngineer 輸入驗證 (<code>load_from_manifest</code>)</p>
<p><strong>Manifest 契約</strong>:</p>
<pre><code class="language-python">class Manifest(BaseModel):
    manifest_version: str = &quot;1.3-FA&quot;
    batch_id: str                      # UUID v4
    site_id: str
    created_at: datetime               # ISO 8601 UTC

    # 核心資料傳遞
    feature_metadata: Dict[str, FeatureMetadata]  # 不含 device_role
    annotation_audit_trail: Dict       # 必須包含 schema_version, inheritance_chain

    # SSOT 快照
    quality_flags_schema: List[str]    # 當下使用的 VALID_QUALITY_FLAGS 副本
    timestamp_schema: Dict             # {format: &quot;INT64&quot;, unit: &quot;nanoseconds&quot;, timezone: &quot;UTC&quot;}

    # 時間基準傳遞 (新增強化)
    temporal_baseline: Dict            # {pipeline_origin_timestamp: str, timezone: &quot;UTC&quot;, baseline_version: &quot;1.0&quot;}

    # 物理邏輯稽核軌跡 (新增)
    equipment_validation_audit: Dict   # {validation_enabled: bool, constraints_applied: List[str], violations_detected: int}

    # 輸出檔案
    output_files: List[str]            # 相對路徑
    output_format: str = &quot;parquet&quot;

    # 完整性驗證
    checksum: str                      # Manifest SHA256
    file_checksums: Dict[str, str]     # filename → SHA256
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Manifest 完整性</strong></td>
<td style="text-align: left;"><code>checksum</code> 驗證通過</td>
<td style="text-align: center;">E301</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Parquet Schema</strong></td>
<td style="text-align: left;"><code>timestamp</code> 物理型別必須為 <code>INT64</code></td>
<td style="text-align: center;">E206</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Parquet 時區</strong></td>
<td style="text-align: left;"><code>timestamp</code> 邏輯型別必須為 <code>UTC</code></td>
<td style="text-align: center;">E206</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Annotation 稽核</strong></td>
<td style="text-align: left;">必須包含 <code>annotation_audit_trail</code></td>
<td style="text-align: center;">E304</td>
<td style="text-align: center;">Warning</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSOT 一致性</strong></td>
<td style="text-align: left;"><code>quality_flags_schema</code> 必須與當前 SSOT 相容</td>
<td style="text-align: center;">E303</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>未來資料防護</strong></td>
<td style="text-align: left;">批次時間範圍不可超過 <code>temporal_baseline.pipeline_origin_timestamp + 5min</code></td>
<td style="text-align: center;">E205</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role 不存在</strong></td>
<td style="text-align: left;">Parquet Schema 與 DataFrame 皆不可含此欄位</td>
<td style="text-align: center;">E500</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準存在性</strong></td>
<td style="text-align: left;">必須包含 <code>temporal_baseline</code> 欄位</td>
<td style="text-align: center;">E000</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>物理邏輯稽核</strong></td>
<td style="text-align: left;">若啟用，必須包含 <code>equipment_validation_audit</code></td>
<td style="text-align: center;">E351</td>
<td style="text-align: center;">Warning</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="24-4-featureengineer-model-training-feature-matrix-contract">2.4 檢查點 #4: FeatureEngineer → Model Training (Feature Matrix Contract)</h3>
<p><strong>位置</strong>: <code>src/etl/feature_engineer.py</code> 輸出驗證 與 <code>src/training/data_validator.py</code> 輸入驗證</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Data Leakage 檢查</strong></td>
<td style="text-align: left;">特徵欄位不可包含目標變數的未來資訊</td>
<td style="text-align: center;">E305</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Temporal Cutoff</strong></td>
<td style="text-align: left;">若設定 <code>cutoff_timestamp</code>，所有資料時間戳必須 ≤ cutoff</td>
<td style="text-align: center;">E305</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Lag 特徵正確性</strong></td>
<td style="text-align: left;"><code>shift(n)</code> 必須正確實作（T-1 時刻特徵對應 T-1 資料）</td>
<td style="text-align: center;">E305</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Quality Flag One-Hot</strong></td>
<td style="text-align: left;">若啟用 one-hot，必須包含所有 <code>VALID_QUALITY_FLAGS</code> 對應欄位</td>
<td style="text-align: center;">E303</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Metadata 傳遞</strong></td>
<td style="text-align: left;">必須輸出 <code>annotation_context</code> 供模型訓練記錄</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Info</td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵順序保證</strong></td>
<td style="text-align: left;">輸出 <code>feature_order_manifest</code> 記錄欄位順序</td>
<td style="text-align: center;">E601</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵縮放參數</strong></td>
<td style="text-align: left;">若執行縮放，必須輸出 <code>scaler_params</code> (JSON格式，含 mean, scale)</td>
<td style="text-align: center;">E602</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準傳遞</strong></td>
<td style="text-align: left;">必須將 <code>pipeline_origin_timestamp</code> 寫入特徵矩詮 metadata</td>
<td style="text-align: center;">E000</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>設備邏輯特徵一致性</strong></td>
<td style="text-align: left;">若啟用設備狀態特徵，必須與 Equipment Validation 邏輯一致（見第11章）</td>
<td style="text-align: center;"><strong>E352</strong></td>
<td style="text-align: center;">High</td>
</tr>
</tbody>
</table>
<p><strong>特徵順序保證機制</strong>:</p>
<pre><code class="language-python"># FeatureEngineer 輸出範例
feature_output = {
    &quot;X_train&quot;: np.ndarray,  # 形狀 (n_samples, n_features)
    &quot;y_train&quot;: np.ndarray,
    &quot;feature_order_manifest&quot;: {
        &quot;version&quot;: &quot;1.0&quot;,
        &quot;features&quot;: [&quot;chiller_1_load&quot;, &quot;chiller_2_load&quot;, &quot;wb_temp&quot;, ...],  # 明確順序列表
        &quot;hash&quot;: &quot;sha256:abc123...&quot;,  # 特徵列表的雜湊
        &quot;pipeline_origin_timestamp&quot;: &quot;2026-02-13T10:00:00Z&quot;,
        &quot;equipment_constraints_applied&quot;: [&quot;chiller_pump_mutex&quot;, &quot;min_runtime_15min&quot;]  # 新增：套用的設備限制
    },
    &quot;scaler_params&quot;: {
        &quot;type&quot;: &quot;StandardScaler&quot;,
        &quot;mean_&quot;: [12.5, 13.2, 25.1, ...],
        &quot;scale_&quot;: [2.1, 2.3, 1.5, ...],
        &quot;feature_names&quot;: [&quot;chiller_1_load&quot;, &quot;chiller_2_load&quot;, &quot;wb_temp&quot;, ...]  # 對應 mean_/scale_
    }
}
</code></pre>
<hr />
<h3 id="25-5-excel-yaml-annotation-sync-contract">2.5 檢查點 #5: Excel ↔ YAML 同步檢查 (Annotation Sync Contract)</h3>
<p><strong>位置</strong>: <code>src/utils/config_loader.py</code> (<code>validate_annotation_sync</code>)</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>檔案存在性</strong></td>
<td style="text-align: left;">Excel 與 YAML 必須同時存在</td>
<td style="text-align: center;">E406</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間戳同步</strong></td>
<td style="text-align: left;"><code>mtime(excel) ≤ mtime(yaml)</code></td>
<td style="text-align: center;">E406</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Checksum 一致性</strong></td>
<td style="text-align: left;">YAML 中記錄的 <code>excel_checksum</code> 必須與實際 Excel 檔案相符</td>
<td style="text-align: center;">E406</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>範本版本</strong></td>
<td style="text-align: left;">Excel 的 <code>template_version</code> 必須等於 <code>EXPECTED_TEMPLATE_VERSION</code></td>
<td style="text-align: center;">E400</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSOT 常數同步</strong></td>
<td style="text-align: left;">YAML 中的 <code>quality_flags_reference</code> 必須與 <code>VALID_QUALITY_FLAGS</code> 一致</td>
<td style="text-align: center;"><strong>E408</strong></td>
<td style="text-align: center;">Critical</td>
</tr>
</tbody>
</table>
<p><strong>執行時機</strong>:<br />
- <strong>嚴格模式</strong> (<code>strict_sync_check=True</code>): Container 初始化時執行，失敗則拋出 <code>AnnotationSyncError</code> 終止流程<br />
- <strong>寬鬆模式</strong>: 僅記錄 Warning，允許繼續執行（僅限開發環境）</p>
<hr />
<h3 id="26-6-annotation-schema-schema-compatibility-contract">2.6 檢查點 #6: Annotation Schema 版本相容 (Schema Compatibility Contract)</h3>
<p><strong>位置</strong>: <code>src/features/annotation_manager.py</code> 初始化與 FeatureEngineer 載入時</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Schema 版本</strong></td>
<td style="text-align: left;"><code>schema_version</code> 必須等於 <code>FEATURE_ANNOTATION_CONSTANTS['expected_schema_version']</code></td>
<td style="text-align: center;">E400</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>繼承鏈合法性</strong></td>
<td style="text-align: left;"><code>inherit</code> 指向的父檔案必須存在，且不可造成循環繼承</td>
<td style="text-align: center;">E407</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>繼承合併結果</strong></td>
<td style="text-align: left;">合併後的 YAML 必須通過 Pydantic 模型驗證</td>
<td style="text-align: center;">E400</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Checksum 格式</strong></td>
<td style="text-align: left;"><code>yaml_checksum</code> 必須符合 <code>sha256:[hex]</code> 格式</td>
<td style="text-align: center;">E400</td>
<td style="text-align: center;">Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Header 對應檢查</strong></td>
<td style="text-align: left;">YAML 中的 <code>column_name</code> 必須與實際 CSV 標頭（經正規化後）匹配</td>
<td style="text-align: center;"><strong>E409</strong></td>
<td style="text-align: center;">High</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="27-7-model-training-optimization-model-artifact-feature-alignment-contract">2.7 檢查點 #7: Model Training → Optimization (Model Artifact &amp; Feature Alignment Contract)</h3>
<p><strong>位置</strong>: <code>src/training/output_validator.py</code> 與 <code>src/optimization/input_validator.py</code></p>
<p><strong>此檢查點為跨階段關鍵介面，確保訓練與推論的特徵一致性</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驗證項目</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">失敗代碼</th>
<th style="text-align: center;">嚴重度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>模型格式</strong></td>
<td style="text-align: left;">必須為 <code>.joblib</code> 或 <code>.onnx</code>，且包含 <code>feature_order_manifest</code></td>
<td style="text-align: center;">E701</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵順序比對</strong></td>
<td style="text-align: left;">Optimization 輸入特徵順序必須與 Training <code>feature_order_manifest</code> 完全一致</td>
<td style="text-align: center;"><strong>E901</strong></td>
<td style="text-align: center;"><strong>Critical</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵數量一致性</strong></td>
<td style="text-align: left;">輸入特徵維度必須等於模型訓練時的維度</td>
<td style="text-align: center;">E902</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>縮放參數存在性</strong></td>
<td style="text-align: left;">若模型使用 StandardScaler，必須存在 <code>scaler_params</code></td>
<td style="text-align: center;">E903</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>縮放參數對齊</strong></td>
<td style="text-align: left;"><code>scaler_params.feature_names</code> 順序必須與 <code>feature_order_manifest.features</code> 一致</td>
<td style="text-align: center;">E903</td>
<td style="text-align: center;">Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>特徵雜湊驗證</strong></td>
<td style="text-align: left;">可選：計算輸入特徵列表的雜湊，比對 <code>feature_order_manifest.hash</code></td>
<td style="text-align: center;">E901</td>
<td style="text-align: center;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間基準隔離</strong></td>
<td style="text-align: left;">Optimization 必須產生新的 <code>pipeline_origin_timestamp</code>，不可沿用 Training 的時間戳</td>
<td style="text-align: center;">E000</td>
<td style="text-align: center;">Warning</td>
</tr>
<tr>
<td style="text-align: left;"><strong>設備限制一致性</strong></td>
<td style="text-align: left;">Optimization 使用的設備限制必須與 Training 時記錄的 <code>equipment_constraints_applied</code> 相容</td>
<td style="text-align: center;"><strong>E904</strong></td>
<td style="text-align: center;">High</td>
</tr>
</tbody>
</table>
<p><strong>特徵對齊驗證詳細流程</strong>:</p>
<pre><code class="language-python"># 在 Optimization 初始化時執行
def validate_feature_alignment(model_artifact, input_features):
    &quot;&quot;&quot;
    嚴格比對訓練與推論的特徵一致性
    &quot;&quot;&quot;
    # 1. 載入訓練時的特徵清單
    training_features = model_artifact['feature_order_manifest']['features']

    # 2. 比對長度
    if len(input_features) != len(training_features):
        raise FeatureAlignmentError(E902, 
            f&quot;特徵維度不匹配: 訓練時 {len(training_features)} 維，輸入 {len(input_features)} 維&quot;)

    # 3. 比對順序與名稱（逐個比對）
    for i, (train_feat, input_feat) in enumerate(zip(training_features, input_features)):
        if train_feat != input_feat:
            raise FeatureAlignmentError(E901,
                f&quot;特徵錯位於索引 {i}: 訓練時為 '{train_feat}'，輸入為 '{input_feat}'&quot;)

    # 4. 驗證縮放參數（若存在）
    if 'scaler_params' in model_artifact:
        scaler_features = model_artifact['scaler_params']['feature_names']
        if scaler_features != training_features:
            raise FeatureAlignmentError(E903,
                &quot;縮放參數特徵順序與訓練特徵順序不一致，可能導致縮放錯位&quot;)

    # 5. 驗證設備限制一致性（新增）
    if 'equipment_constraints_applied' in model_artifact['feature_order_manifest']:
        train_constraints = set(model_artifact['feature_order_manifest']['equipment_constraints_applied'])
        current_constraints = set(get_current_equipment_constraints())  # 從當前 Optimization config 取得
        if train_constraints != current_constraints:
            raise FeatureAlignmentError(E904,
                f&quot;設備限制不一致: 訓練時使用 {train_constraints}，當前使用 {current_constraints}&quot;)

    return True
</code></pre>
<hr />
<h2 id="3-error-code-hierarchy-specification">3. 錯誤代碼分層規範 (Error Code Hierarchy Specification)</h2>
<h3 id="30">3.0 分層架構總覽</h3>
<p>為確保全系統錯誤代碼的唯一性與可追蹤性，定義以下分層架構：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼範圍</th>
<th style="text-align: center;">層級</th>
<th style="text-align: left;">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E000</strong></td>
<td style="text-align: center;">全域</td>
<td style="text-align: left;">Pipeline 時間基準相關錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E001-E099</strong></td>
<td style="text-align: center;">系統層級</td>
<td style="text-align: left;">編碼、記憶體、檔案系統、配置檔錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E100-E199</strong></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">CSV/原始資料解析錯誤（含 Header Standardization）</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E200-E299</strong></td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">資料清洗與驗證錯誤（含設備邏輯預檢）</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E300-E349</strong></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">批次處理與 Parquet 儲存錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E350-E399</strong></td>
<td style="text-align: center;">Equipment Validation</td>
<td style="text-align: left;">設備相依性與物理邏輯驗證錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E400-E499</strong></td>
<td style="text-align: center;">Feature Annotation</td>
<td style="text-align: left;">特徵標註與設定檔錯誤（含 SSOT 同步）</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E500-E599</strong></td>
<td style="text-align: center;">Governance</td>
<td style="text-align: left;">架構違規、職責分離與安全性錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E600-E699</strong></td>
<td style="text-align: center;">Feature Engineer</td>
<td style="text-align: left;">特徵工程與矩陣建構錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E700-E749</strong></td>
<td style="text-align: center;">Model Training</td>
<td style="text-align: left;">模型訓練與驗證錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E750-E799</strong></td>
<td style="text-align: center;">Hybrid Consistency</td>
<td style="text-align: left;">混合模型一致性驗證錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E800-E899</strong></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">最佳化與推論錯誤</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E900-E999</strong></td>
<td style="text-align: center;">跨階段整合</td>
<td style="text-align: left;">特徵對齊、版本相容性、設備限制一致性錯誤</td>
</tr>
</tbody>
</table>
<p><strong>遷移對照表</strong>（舊代碼 → 新代碼）：<br />
- <code>E305</code> (Data Leakage) 保持不變（仍在 E3xx 範圍，但邏輯上屬於 Feature Engineer 階段）<br />
- <code>E601-E602</code> (Feature Engineer 新增) 歸類於 E6xx<br />
- <code>E701+</code> (Model Training) 歸類於 E7xx<br />
- <code>E801+</code> (Optimization) 歸類於 E8xx（與舊 Training E801 區隔）<br />
- <code>E901+</code> (跨階段對齊) 歸類於 E9xx<br />
- <strong>新增</strong>: <code>E105</code> (Header Standardization), <code>E350-E352</code> (Equipment Validation Sync), <code>E408-E409</code> (SSOT Sync), <code>E904</code> (Equipment Constraint Consistency)</p>
<hr />
<h3 id="31-e000">3.1 全域時間基準錯誤 (E000)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E000</strong></td>
<td style="text-align: left;"><code>TEMPORAL_BASELINE_MISSING</code></td>
<td style="text-align: center;">Container/任意</td>
<td style="text-align: left;">pipeline_origin_timestamp 未傳遞或遺失</td>
<td style="text-align: left;">"時間基準遺失: 無法執行時間相關驗證"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E000-W</strong></td>
<td style="text-align: left;"><code>TEMPORAL_DRIFT_WARNING</code></td>
<td style="text-align: center;">PipelineContext</td>
<td style="text-align: left;">流程執行時間超過 1 小時，懷疑時間漂移</td>
<td style="text-align: left;">"警告: Pipeline 執行時間過長，請檢查時間基準"</td>
<td style="text-align: center;">✅ 是</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="32-e001-e099">3.2 系統層級錯誤 (E001-E099)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E001</strong></td>
<td style="text-align: left;"><code>ENCODING_MISMATCH</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">檔案編碼無法偵測或輸出含非法字元 (BOM)</td>
<td style="text-align: left;">"檔案編碼錯誤: 無法識別編碼或包含 BOM 殘留"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E006</strong></td>
<td style="text-align: left;"><code>MEMORY_LIMIT_EXCEEDED</code></td>
<td style="text-align: center;">任意</td>
<td style="text-align: left;">記憶體使用超過配置上限</td>
<td style="text-align: left;">"記憶體不足: 已超過 {limit}GB 上限"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E007</strong></td>
<td style="text-align: left;"><code>CONFIG_FILE_CORRUPTED</code></td>
<td style="text-align: center;">ConfigLoader</td>
<td style="text-align: left;">YAML/JSON 設定檔解析失敗</td>
<td style="text-align: left;">"設定檔損毀: {filepath}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="33-etl-e100-e399">3.3 ETL 處理錯誤 (E100-E399)</h3>
<h3 id="331-parser-e100-e199">3.3.1 Parser 錯誤 (E100-E199)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E101</strong></td>
<td style="text-align: left;"><code>ENCODING_MISMATCH</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">無法偵測檔案編碼或含BOM</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E102</strong></td>
<td style="text-align: left;"><code>TIMEZONE_VIOLATION</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">時區非 UTC 或精度錯誤</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E103</strong></td>
<td style="text-align: left;"><code>CONTRACT_VIOLATION</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">缺少必要欄位或 Quality Flags 未定義</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E104</strong></td>
<td style="text-align: left;"><code>HEADER_NOT_FOUND</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">無法定位標頭行 (掃描 &gt; 500行)</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E105</strong></td>
<td style="text-align: left;"><code>HEADER_STANDARDIZATION_FAILED</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">標頭正規化失敗（不符合命名規則或 Regex 匹配失敗）</td>
<td style="text-align: center;">⚠️ 部分（可嘗試自動轉換）</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E111</strong></td>
<td style="text-align: left;"><code>TIMEZONE_WARNING</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">時區轉換警告 (非致命)</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E112</strong></td>
<td style="text-align: left;"><code>FUTURE_DATA_DETECTED</code></td>
<td style="text-align: center;">Parser</td>
<td style="text-align: left;">發現未來資料 (相對於 pipeline_timestamp)</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<p><strong>E105 詳細規則</strong>:<br />
- 觸發條件：CSV 標頭包含空格、特殊字元、大小寫混亂（如 <code>Chiller 1 Temp</code>、<code>&lt;invalid&gt;</code>、<code>power(kW)</code>）<br />
- 自動轉換：嘗試套用 <code>HEADER_STANDARDIZATION_RULES</code>（見第10章）進行 snake_case 轉換<br />
- 失敗處理：若自動轉換後仍不符合規則，拋出 E105 並終止流程</p>
<hr />
<h3 id="332-cleanerbatchprocessor-e200-e299">3.3.2 Cleaner/BatchProcessor 階段 (E200-E299)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E201</strong></td>
<td style="text-align: left;"><code>INPUT_SCHEMA_MISMATCH</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">輸入 DataFrame Schema 不符</td>
<td style="text-align: left;">"輸入資料格式不符: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E202</strong></td>
<td style="text-align: left;"><code>UNKNOWN_QUALITY_FLAG</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">輸入含未定義的品質標記</td>
<td style="text-align: left;">"品質標記未定義於 SSOT: {flags}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E203</strong></td>
<td style="text-align: left;"><code>METADATA_LOSS</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">未接收到 column_metadata</td>
<td style="text-align: left;">"缺少欄位元資料，使用保守預設"</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E205</strong></td>
<td style="text-align: left;"><code>FUTURE_DATA_IN_BATCH</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">批次資料包含超過 <code>pipeline_origin_timestamp + 5min</code> 的時間戳</td>
<td style="text-align: left;">"批次含未來資料，已拒絕"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E206</strong></td>
<td style="text-align: left;"><code>PARQUET_FORMAT_VIOLATION</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">Parquet 格式非 INT64/UTC</td>
<td style="text-align: left;">"Parquet 格式錯誤: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<p><strong>Cleaner 階段 (E210-E299)</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E210</strong></td>
<td style="text-align: left;"><code>PHYSICAL_CONSTRAINT_VIOLATION</code></td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">資料違反物理限制（如溫度 &gt; 100°C）</td>
<td style="text-align: center;">⚠️ 部分（標記 Quality Flag）</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E211</strong></td>
<td style="text-align: left;"><code>FROZEN_DATA_DETECTED</code></td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">連續多筆相同值（設備可能卡死）</td>
<td style="text-align: center;">✅ 是（標記 FROZEN）</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E212</strong></td>
<td style="text-align: left;"><code>ZERO_RATIO_EXCEEDED</code></td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">零值比例過高（主設備異常）</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E213</strong></td>
<td style="text-align: left;"><code>INSUFFICIENT_DATA_GAP</code></td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">時間軸缺漏過大（&gt; 1小時）</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="34-equipment-validation-e350-e399">3.4 Equipment Validation 錯誤 (E350-E399)（新增分層）</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E350</strong></td>
<td style="text-align: left;"><code>EQUIPMENT_LOGIC_PRECHECK_FAILED</code></td>
<td style="text-align: center;">Cleaner</td>
<td style="text-align: left;">基礎設備邏輯預檢失敗（如主機開但水泵關）</td>
<td style="text-align: center;">⚠️ 部分（標記異常）</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E351</strong></td>
<td style="text-align: left;"><code>EQUIPMENT_VALIDATION_AUDIT_MISSING</code></td>
<td style="text-align: center;">BatchProcessor</td>
<td style="text-align: left;">啟用同步但未記錄稽核軌跡</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E352</strong></td>
<td style="text-align: left;"><code>EQUIPMENT_CONSTRAINT_MISMATCH</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">特徵工程與設備限制邏輯不一致</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E353</strong></td>
<td style="text-align: left;"><code>REQUIRES_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反「必須同時開啟」約束</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E354</strong></td>
<td style="text-align: left;"><code>MUTEX_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反「互斥」約束</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E355</strong></td>
<td style="text-align: left;"><code>SEQUENCE_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反開關機順序約束</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E356</strong></td>
<td style="text-align: left;"><code>MIN_RUNTIME_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反最小運轉時間限制</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E357</strong></td>
<td style="text-align: left;"><code>MIN_DOWNTIME_VIOLATION</code></td>
<td style="text-align: center;">EquipmentValidator</td>
<td style="text-align: left;">違反最小停機時間限制</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="35-feature-annotation-e400-e499">3.5 Feature Annotation 錯誤 (E400-E499)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E400</strong></td>
<td style="text-align: left;"><code>ANNOTATION_VERSION_MISMATCH</code></td>
<td style="text-align: center;">ConfigLoader/FE</td>
<td style="text-align: left;">Schema 版本不符或範本過舊</td>
<td style="text-align: left;">"Feature Annotation 版本過舊: 請執行 migrate-excel"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E401</strong></td>
<td style="text-align: left;"><code>ORPHAN_COLUMN</code></td>
<td style="text-align: center;">excel_to_yaml</td>
<td style="text-align: left;">標註欄位不存在於資料</td>
<td style="text-align: left;">"標註欄位 {col} 不存在於 CSV"</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E402</strong></td>
<td style="text-align: left;"><code>UNANNOTATED_COLUMN</code></td>
<td style="text-align: center;">ConfigLoader/Cleaner</td>
<td style="text-align: left;">資料欄位未定義於 Annotation</td>
<td style="text-align: left;">"未定義欄位: {col}，請執行 features wizard"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E403</strong></td>
<td style="text-align: left;"><code>UNIT_INCOMPATIBLE</code></td>
<td style="text-align: center;">excel_to_yaml</td>
<td style="text-align: left;">單位與物理類型不匹配</td>
<td style="text-align: left;">"單位錯誤: {unit} 不適用於 {physical_type}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E404</strong></td>
<td style="text-align: left;"><code>LAG_FORMAT_INVALID</code></td>
<td style="text-align: center;">excel_to_yaml</td>
<td style="text-align: left;">Lag 間隔格式錯誤</td>
<td style="text-align: left;">"Lag 格式錯誤: 必須為逗號分隔整數"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E405</strong></td>
<td style="text-align: left;"><code>TARGET_LEAKAGE_RISK</code></td>
<td style="text-align: center;">Pydantic Validation</td>
<td style="text-align: left;">is_target=True 但 enable_lag=True</td>
<td style="text-align: left;">"目標變數不可啟用 Lag"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E406</strong></td>
<td style="text-align: left;"><code>EXCEL_YAML_OUT_OF_SYNC</code></td>
<td style="text-align: center;">ConfigLoader</td>
<td style="text-align: left;">Excel 與 YAML 不同步</td>
<td style="text-align: left;">"設定不同步: 請執行 validate-annotation"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E407</strong></td>
<td style="text-align: left;"><code>CIRCULAR_INHERITANCE</code></td>
<td style="text-align: center;">AnnotationManager</td>
<td style="text-align: left;">YAML 繼承循環</td>
<td style="text-align: left;">"繼承循環偵測: {chain}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E408</strong></td>
<td style="text-align: left;"><code>SSOT_QUALITY_FLAGS_MISMATCH</code></td>
<td style="text-align: center;">Container</td>
<td style="text-align: left;">YAML 中的 flags 與 <code>VALID_QUALITY_FLAGS</code> 不一致</td>
<td style="text-align: left;">"SSOT 品質標記不匹配: 請同步 config_models.py"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E409</strong></td>
<td style="text-align: left;"><code>HEADER_ANNOTATION_MISMATCH</code></td>
<td style="text-align: center;">Parser/AnnotationManager</td>
<td style="text-align: left;">CSV 標頭（正規化後）與 Annotation 欄位名稱不匹配</td>
<td style="text-align: left;">"CSV 標頭 {header} 無法對應至 Annotation"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="36-governance-architecture-violations-e500-e599">3.6 Governance &amp; Architecture Violations (E500-E599)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E500</strong></td>
<td style="text-align: left;"><code>DEVICE_ROLE_LEAKAGE</code></td>
<td style="text-align: center;">Cleaner/BatchProcessor/FE</td>
<td style="text-align: left;">DataFrame 或 Metadata 含 device_role</td>
<td style="text-align: left;">"職責違反: device_role 不應出現在 DataFrame"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E501</strong></td>
<td style="text-align: left;"><code>DIRECT_WRITE_ATTEMPT</code></td>
<td style="text-align: center;">Wizard</td>
<td style="text-align: left;">試圖直接修改 YAML 檔案</td>
<td style="text-align: left;">"安全性違反: 禁止直接寫入 YAML，請使用 Excel"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="37-feature-engineer-e600-e699">3.7 Feature Engineer 錯誤 (E600-E699)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E601</strong></td>
<td style="text-align: left;"><code>FEATURE_ORDER_NOT_RECORDED</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">未輸出 feature_order_manifest</td>
<td style="text-align: left;">"特徵順序未記錄: 無法保證推論一致性"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E602</strong></td>
<td style="text-align: left;"><code>SCALER_PARAMS_MISSING</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">執行縮放但未輸出縮放參數</td>
<td style="text-align: left;">"縮放參數遺失: 推論階段將無法一致縮放"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E603</strong></td>
<td style="text-align: left;"><code>FEATURE_MATRIX_SHAPE_ERROR</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">特徵矩陣維度異常（如樣本數=0）</td>
<td style="text-align: left;">"特徵矩陣形狀錯誤: {shape}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E604</strong></td>
<td style="text-align: left;"><code>INVALID_LAG_CONFIGURATION</code></td>
<td style="text-align: center;">FeatureEngineer</td>
<td style="text-align: left;">Lag 設定導致資料長度不足</td>
<td style="text-align: left;">"Lag 設定錯誤: 資料長度 {n} 小於最大 Lag {lag}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="38-model-training-e700-e749">3.8 Model Training 錯誤 (E700-E749)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E701</strong></td>
<td style="text-align: left;"><code>TRAINING_MEMORY_ERROR</code></td>
<td style="text-align: center;">ModelTrainer</td>
<td style="text-align: left;">GPU/CPU 記憶體不足</td>
<td style="text-align: left;">"訓練記憶體不足: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E702</strong></td>
<td style="text-align: left;"><code>VALIDATION_FAILURE</code></td>
<td style="text-align: center;">ModelValidator</td>
<td style="text-align: left;">驗證集性能低於門檻</td>
<td style="text-align: left;">"模型驗證失敗: MAPE {mape}% &gt; 門檻 {threshold}%"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E703</strong></td>
<td style="text-align: left;"><code>HYPERPARAMETER_INVALID</code></td>
<td style="text-align: center;">ModelTrainer</td>
<td style="text-align: left;">超參數組合無效</td>
<td style="text-align: left;">"無效超參數: {param}={value}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E704</strong></td>
<td style="text-align: left;"><code>CHECKPOINT_SAVE_FAILED</code></td>
<td style="text-align: center;">ModelTrainer</td>
<td style="text-align: left;">模型檢查點儲存失敗</td>
<td style="text-align: left;">"模型儲存失敗: {filepath}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E705</strong></td>
<td style="text-align: left;"><code>CROSS_VALIDATION_ERROR</code></td>
<td style="text-align: center;">ModelValidator</td>
<td style="text-align: left;">交叉驗證執行失敗</td>
<td style="text-align: left;">"交叉驗證錯誤: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E706</strong></td>
<td style="text-align: left;"><code>MODEL_ARTIFACT_CORRUPTED</code></td>
<td style="text-align: center;">ModelValidator</td>
<td style="text-align: left;">輸出模型檔案損毀或不完整</td>
<td style="text-align: left;">"模型產物損毀"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="39-hybrid-model-consistency-e750-e799">3.9 Hybrid Model Consistency (E750-E799)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E750</strong></td>
<td style="text-align: left;"><code>GOLDEN_DATASET_UNAVAILABLE</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">無可用的測試集或驗證集</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E751</strong></td>
<td style="text-align: left;"><code>DYNAMIC_TOLERANCE_EXCEEDED</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">預測誤差超過動態容許值</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E752</strong></td>
<td style="text-align: left;"><code>SYSTEMATIC_BIAS_DETECTED</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">偵測到系統性偏差 (Bias &gt; 5%)</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E753</strong></td>
<td style="text-align: left;"><code>TREND_MISMATCH</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">趨勢方向與物理邏輯不符 (Corr &lt; 0.95)</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E754</strong></td>
<td style="text-align: left;"><code>OUTLIER_VIOLATION</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">存在極端異常值 (&gt; 50kW)</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E755</strong></td>
<td style="text-align: left;"><code>INSUFFICIENT_COMPONENTS</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">L1等級（僅單一Component）無法驗證</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E756</strong></td>
<td style="text-align: left;"><code>PARTIAL_COMPONENTS_L2</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">僅使用L2等級（部分Components）驗證</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E757</strong></td>
<td style="text-align: left;"><code>LIGHT_LOAD_HIGH_VARIANCE</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">輕載區間誤差較高（正常現象）</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E758</strong></td>
<td style="text-align: left;"><code>COPULA_EFFECT_DETECTED</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">偵測到顯著耦合效應</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E759</strong></td>
<td style="text-align: left;"><code>DATASET_QUALITY_WARNING</code></td>
<td style="text-align: center;">ConsistentValidator</td>
<td style="text-align: left;">使用驗證集或合併資料集</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="310-optimization-e800-e899">3.10 Optimization 錯誤 (E800-E899)</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E801</strong></td>
<td style="text-align: left;"><code>MODEL_LOAD_FAILED</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">無法載入模型檔案</td>
<td style="text-align: left;">"模型載入失敗: {model_path}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E802</strong></td>
<td style="text-align: left;"><code>CONSTRAINT_VIOLATION</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">設備邏輯約束無法滿足</td>
<td style="text-align: left;">"約束違反: {constraint_detail}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E803</strong></td>
<td style="text-align: left;"><code>OPTIMIZATION_DIVERGENCE</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">求解器無法收斂</td>
<td style="text-align: left;">"最佳化發散: {solver_status}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E804</strong></td>
<td style="text-align: left;"><code>BOUND_INFEASIBILITY</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">變數邊界設定導致無解</td>
<td style="text-align: left;">"邊界不可行: {variable}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E805</strong></td>
<td style="text-align: left;"><code>FORECAST_HORIZON_MISMATCH</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">預測時程與最佳化時程不匹配</td>
<td style="text-align: left;">"預測時程錯誤: 需 {required} 步，得 {actual} 步"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E806</strong></td>
<td style="text-align: left;"><code>SYSTEM_MODEL_DISCREPANCY</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">System Model 與 Component Models 加總差異 &gt; 5%</td>
<td style="text-align: left;">"模型不一致: 系統級與元件級預測差異 {diff}%"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E807</strong></td>
<td style="text-align: left;"><code>EQUIPMENT_STATE_INVALID</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">設備狀態違反物理邏輯（如主機開但水泵關）</td>
<td style="text-align: left;">"設備狀態無效: {equipment_logic}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E808</strong></td>
<td style="text-align: left;"><code>WEATHER_DATA_MISSING</code></td>
<td style="text-align: center;">OptimizationEngine</td>
<td style="text-align: left;">缺少未來天氣預測資料</td>
<td style="text-align: left;">"天氣資料缺失: 無法執行未來 {hours} 小時最佳化"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="311-e900-e999">3.11 跨階段整合錯誤 (E900-E999)</h3>
<p><strong>Training-Optimization 特徵對齊與一致性錯誤</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">來源模組</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">使用者訊息範本</th>
<th style="text-align: center;">可恢復性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E901</strong></td>
<td style="text-align: left;"><code>FEATURE_ALIGNMENT_MISMATCH</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">推論特徵順序/名稱與訓練時不一致</td>
<td style="text-align: left;">"特徵對齊錯誤: 索引 {index} 預期 '{expected}'，實際 '{actual}'"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E902</strong></td>
<td style="text-align: left;"><code>FEATURE_DIMENSION_MISMATCH</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">推論特徵維度與訓練時不同</td>
<td style="text-align: left;">"特徵維度錯誤: 訓練 {train_dim} 維，輸入 {input_dim} 維"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E903</strong></td>
<td style="text-align: left;"><code>SCALER_MISMATCH</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">縮放參數與特徵不匹配或缺失</td>
<td style="text-align: left;">"縮放參數錯誤: {detail}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E904</strong></td>
<td style="text-align: left;"><code>EQUIPMENT_CONSTRAINT_INCONSISTENT</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">當前設備限制與訓練時不一致</td>
<td style="text-align: left;">"設備限制不一致: 訓練使用 {train_constraints}，當前使用 {current_constraints}"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E905</strong></td>
<td style="text-align: left;"><code>MODEL_VERSION_INCOMPATIBLE</code></td>
<td style="text-align: center;">Optimization</td>
<td style="text-align: left;">模型版本與 Optimization 引擎不相容</td>
<td style="text-align: left;">"模型版本不相容: 模型 v{model_ver}，引擎需 &gt;= {engine_ver}"</td>
<td style="text-align: center;">❌ 否</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E906</strong></td>
<td style="text-align: left;"><code>PIPELINE_VERSION_DRIFT</code></td>
<td style="text-align: center;">Container</td>
<td style="text-align: left;">跨模組版本組合未通過相容性矩陣驗證</td>
<td style="text-align: left;">"版本漂移: {module_a} v{ver_a} 與 {module_b} v{ver_b} 不相容"</td>
<td style="text-align: center;">⚠️ 部分</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-dataframe-dataframe-interface-standard">4. DataFrame 介面標準 (DataFrame Interface Standard)</h2>
<h3 id="41">4.1 欄位命名與型別規範</h3>
<p><strong>標準時間戳欄位</strong>:<br />
- <strong>名稱</strong>: <code>timestamp</code>（強制小寫，不可使用 <code>time</code>, <code>date</code>, <code>datetime</code>）<br />
- <strong>Polars 型別</strong>: <code>pl.Datetime(time_unit='ns', time_zone='UTC')</code><br />
- <strong>Parquet 物理型別</strong>: <code>INT64</code> (nanoseconds since epoch, UTC)<br />
- <strong>禁止</strong>: <code>INT96</code>, <code>microseconds</code>, <code>milliseconds</code>, 無時區 (naive)</p>
<p><strong>品質標記欄位</strong>:<br />
- <strong>名稱</strong>: <code>quality_flags</code><br />
- <strong>Polars 型別</strong>: <code>pl.List(pl.Utf8)</code><br />
- <strong>值域</strong>: 必須是 <code>VALID_QUALITY_FLAGS</code> 的子集<br />
- <strong>Parquet 儲存</strong>: 以 JSON string 儲存，<code>BYTE_ARRAY</code> 邏輯型別</p>
<p><strong>數值欄位（感測器資料）</strong>:<br />
- <strong>Polars 型別</strong>: <code>pl.Float64</code>（統一使用 Float64，即使原始資料為整數）<br />
- <strong>單位</strong>: 必須為 SI 單位（如 <code>kW</code>, <code>°C</code>, <code>LPM</code>），<strong>禁止</strong>在欄位名稱中編碼單位（如 <code>temp_c</code>, <code>power_kw</code>）<br />
- <strong>Null 值</strong>: 使用 Polars <code>null</code>（非 <code>NaN</code> 或 magic number）<br />
- <strong>精度保留</strong>: 單位轉換後必須保留至少 <strong>6 位有效數字</strong>（避免 0.1°C 精度損失影響 HVAC 決策）</p>
<p><strong>禁止欄位（絕對禁止出現在 DataFrame 中）</strong>:<br />
- <code>device_role</code>: 必須由 FeatureAnnotationManager 動態查詢，不得寫入資料<br />
- <code>ignore_warnings</code>: 同上<br />
- <code>is_target</code>: 同上<br />
- <code>__index_level_0__</code>: Pandas 殘留索引，必須移除</p>
<h3 id="42-metadata-column_metadata">4.2 Metadata 字典規範 (column_metadata)</h3>
<p><strong>允許的鍵值</strong>:</p>
<pre><code class="language-python">{
    &quot;column_name&quot;: str,           # 欄位名稱（與 DataFrame 欄位一致）
    &quot;physical_type&quot;: str,         # 必須是 PHYSICAL_TYPES 的 key
    &quot;unit&quot;: Optional[str],        # 單位符號
    &quot;description&quot;: Optional[str],  # 人類可讀描述
    &quot;precision&quot;: int,             # 有效數字位數（預設 6）
    &quot;temporal_baseline&quot;: str      # ISO 8601 格式時間戳（傳遞用）
}
</code></pre>
<p><strong>禁止的鍵值</strong>:<br />
- <code>device_role</code><br />
- <code>ignore_warnings</code><br />
- <code>is_target</code><br />
- <code>valid_range</code>（應從 Annotation 查詢，非 metadata）</p>
<hr />
<h2 id="5-version-compatibility-matrix">5. 版本相容性判定標準 (Version Compatibility Matrix)</h2>
<h3 id="51">5.1 相容性等級定義</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">等級</th>
<th style="text-align: left;">定義</th>
<th style="text-align: left;">行為</th>
<th style="text-align: center;">標示</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>完全相容</strong> (Full Compatible)</td>
<td style="text-align: left;">上下游模組版本組合通過所有檢查點，無需轉換或降級</td>
<td style="text-align: left;">正常執行，無警告</td>
<td style="text-align: center;">🟢</td>
</tr>
<tr>
<td style="text-align: center;"><strong>部分相容</strong> (Partial Compatible)</td>
<td style="text-align: left;">上游輸出可被下游讀取，但部分功能降級（如缺少 audit_trail）</td>
<td style="text-align: left;">執行，但記錄 Warning</td>
<td style="text-align: center;">🟡</td>
</tr>
<tr>
<td style="text-align: center;"><strong>不相容</strong> (Incompatible)</td>
<td style="text-align: left;">上游輸出無法通過下游檢查點，或資料語意不一致</td>
<td style="text-align: left;">拒絕執行，拋出錯誤</td>
<td style="text-align: center;">🔴</td>
</tr>
</tbody>
</table>
<h3 id="52">5.2 模組版本相容性矩陣</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">Parser</th>
<th style="text-align: center;">Cleaner</th>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;">Model Training</th>
<th style="text-align: center;">Optimization</th>
<th style="text-align: center;">Equipment Validation</th>
<th style="text-align: center;">相容性</th>
<th style="text-align: left;">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">🟢 <strong>完全相容</strong></td>
<td style="text-align: left;">推薦配置，支援特徵對齊驗證 E901-E903，設備邏輯同步</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">🔴 <strong>不相容</strong></td>
<td style="text-align: left;">Optimization v1.0 缺少特徵對齊檢查點 #7</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">🟡 <strong>部分相容</strong></td>
<td style="text-align: left;">FE v1.2 無法輸出 feature_order_manifest，觸發 E601</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">🟡 <strong>部分相容</strong></td>
<td style="text-align: left;">Training v1.1 未輸出 scaler_params，Optimization 使用預設值</td>
</tr>
<tr>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">任意</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">🔴 <strong>不相容</strong></td>
<td style="text-align: left;">若 Model 未包含 feature_order_manifest，觸發 E901</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">🔴 <strong>不相容</strong></td>
<td style="text-align: left;">Cleaner v2.1 可能輸出 device_role，觸發 E500</td>
</tr>
</tbody>
</table>
<h3 id="53">5.3 強制升級路徑</h3>
<p><strong>不允許的組合</strong>（系統必須拒絕啟動）：<br />
1. Parser/Cleaner v2.0 + 任意下游（時區/職責分離衝突）<br />
2. Feature Engineer v1.2 + Optimization v1.1（缺少特徵對齊機制，E901 無法通過）<br />
3. Model Training v1.1 + Optimization v1.1（缺少標準化 scaler_params，E903 風險）<br />
4. Cleaner v2.1 + Equipment Validation v1.0（缺少設備邏輯預檢，E350 風險）</p>
<p><strong>建議升級順序</strong>：</p>
<pre><code>Feature Annotation v1.2 (基礎設施)
    ↓
Parser v2.1 (上游輸出標準化 + Header Standardization)
    ↓
Cleaner v2.2 (職責分離實作 + Equipment Validation Sync)
    ↓
BatchProcessor v1.3 (時間基準傳遞 + Audit Trail)
    ↓
FeatureEngineer v1.3 (特徵順序保證 E601 + Equipment Constraint Alignment)
    ↓
Model Training v1.2 (縮放參數輸出 E602)
    ↓
Optimization v1.1 (特徵對齊驗證 E901-E903 + Equipment Constraint Consistency)
</code></pre>
<hr />
<h2 id="6-implementation-checklist">6. 實作檢查清單 (Implementation Checklist)</h2>
<h3 id="61">6.1 開發前必須確認</h3>
<ul>
<li>[ ] 所有模組 PRD 引用本文件作為「檢查點」與「錯誤代碼」的 SSOT</li>
<li>[ ] <code>src/etl/config_models.py</code> 已定義 <code>VALID_QUALITY_FLAGS</code>, <code>TIMESTAMP_CONFIG</code>, <code>FEATURE_ANNOTATION_CONSTANTS</code></li>
<li>[ ] <strong>新增</strong>: <code>src/etl/config_models.py</code> 已定義 <code>HEADER_STANDARDIZATION_RULES</code>（見第10章）</li>
<li>[ ] <strong>新增</strong>: <code>src/etl/config_models.py</code> 已定義 <code>EQUIPMENT_VALIDATION_CONSTRAINTS</code>（見第11章）</li>
<li>[ ] <strong>新增</strong>: <code>src/core/temporal_baseline.py</code> 已實作 <code>PipelineTemporalBaseline</code> 類別（見第8章）</li>
<li>[ ] <strong>新增</strong>: <code>src/optimization/feature_alignment.py</code> 已實作對齊驗證邏輯（E901-E903）</li>
<li>[ ] <strong>新增</strong>: <code>src/equipment/equipment_validator.py</code> 已實作並與 Cleaner 整合（見第11章）</li>
<li>[ ] 各模組的 <code>ERROR_CODES</code> 字典必須與本文件第 3 節完全一致（含新分層 E600-E999）</li>
</ul>
<h3 id="62">6.2 開發中驗證</h3>
<ul>
<li>[ ] 每個檢查點必須有對應的單元測試（故意注入錯誤，驗證錯誤代碼正確）</li>
<li>[ ] E500 檢查必須使用 Property-Based Testing（隨機生成 device_role 值，驗證絕對不會出現在輸出）</li>
<li>[ ] <strong>新增</strong>: E901-E903 檢查必須使用「錯誤順序特徵」測試（故意打亂特徵順序，驗證系統正確拒絕）</li>
<li>[ ] <strong>新增</strong>: 時間基準測試（模擬長時間執行，驗證未來資料檢查使用固定基準而非動態時間）</li>
<li>[ ] <strong>新增</strong>: Header Standardization 測試（使用各種非標準標頭，驗證正規化邏輯）</li>
<li>[ ] <strong>新增</strong>: Equipment Validation Sync 測試（驗證 Cleaner 與 Optimization 的設備邏輯一致性）</li>
<li>[ ] 版本相容性矩陣必須有整合測試覆蓋（使用不同版本組合的 fixture）</li>
</ul>
<h3 id="63">6.3 上線前驗收</h3>
<ul>
<li>[ ] 執行端到端契約測試：Parser → Cleaner → BatchProcessor → FeatureEngineer → Model Training → Optimization，驗證檢查點 1-7 全部通過</li>
<li>[ ] 執行 Annotation 流程測試：Excel → Wizard → excel_to_yaml → Container，驗證檢查點 5-6 全部通過</li>
<li>[ ] <strong>新增</strong>: 執行特徵對齊壓力測試：訓練後故意修改特徵順序，驗證 Optimization 階段正確拋出 E901</li>
<li>[ ] <strong>新增</strong>: 執行 Header Standardization 壓力測試：使用包含空格、特殊字元、大小寫混亂的 CSV 標頭，驗證正確轉換或拋出 E105</li>
<li>[ ] <strong>新增</strong>: 執行 Equipment Validation Sync 測試：在 Cleaner 中注入設備邏輯違規資料，驗證正確標記並傳遞至 Optimization</li>
<li>[ ] 驗證錯誤訊息：所有錯誤代碼必須輸出本文件定義的「使用者訊息範本」</li>
</ul>
<hr />
<h2 id="7">7. 附錄：術語對照表</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">術語</th>
<th style="text-align: left;">定義</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SSOT</strong> (Single Source of Truth)</td>
<td style="text-align: left;">單一真相源，指 <code>config_models.py</code> 中定義的常數與型別</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Checkpoint</strong></td>
<td style="text-align: left;">模組間的介面驗證點，資料通過時必須符合的規格</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Device Role</strong></td>
<td style="text-align: left;">設備角色（primary/backup/seasonal），定義於 Feature Annotation，<strong>不得</strong>寫入 DataFrame</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Audit Trail</strong></td>
<td style="text-align: left;">稽核軌跡，記錄資料處理過程中的版本、繼承鏈、checksum 等資訊</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Manifest</strong></td>
<td style="text-align: left;">BatchProcessor 輸出的 JSON 檔案，記錄批次處理的元資料與檔案清單</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Leakage</strong> (E500)</td>
<td style="text-align: left;">職責違反，指 device_role 等 Annotation 元資料意外寫入 DataFrame</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Feature Order Manifest</strong></td>
<td style="text-align: left;">記錄特徵欄位順序與雜湊的結構，確保 Training 與 Optimization 階段特徵順序一致</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Temporal Baseline</strong></td>
<td style="text-align: left;">Pipeline 啟動時的統一時間戳，所有未來資料檢查的基準</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Header Standardization</strong></td>
<td style="text-align: left;">CSV 標頭正規化規則，確保欄位名稱符合 snake_case 命名規範</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Equipment Validation Sync</strong></td>
<td style="text-align: left;">Cleaner 與 Optimization 之間的設備邏輯一致性檢查機制</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-pipeline-temporal-baseline-propagation">8. Pipeline 時間基準傳遞規範 (Temporal Baseline Propagation)</h2>
<h3 id="81">8.1 核心機制</h3>
<p>為解決「Pipeline 執行期間時間漂移導致未來資料誤判」問題（原 E102/E205 風險），建立以下機制：</p>
<p><strong>時間基準產生</strong>：<br />
- <strong>時機</strong>: <code>Container.__init__</code> 初始化時（第一個動作，早於任何模組初始化）<br />
- <strong>格式</strong>: ISO 8601 UTC (e.g., <code>2026-02-13T10:00:00.000000000Z</code>)<br />
- <strong>儲存</strong>: <code>TemporalContext</code> 物件（Thread-safe Singleton）</p>
<pre><code class="language-python">class TemporalContext:
    &quot;&quot;&quot;
    全域時間基準容器（單例模式）
    &quot;&quot;&quot;
    _instance = None
    _lock = threading.Lock()

    def __new__(cls):
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    cls._instance = super().__new__(cls)
                    cls._instance.origin_timestamp = datetime.now(UTC)
                    cls._instance.baseline_version = &quot;1.0&quot;
        return cls._instance

    def get_baseline(self) -&gt; datetime:
        &quot;&quot;&quot;取得 Pipeline 啟動時間戳&quot;&quot;&quot;
        return self.origin_timestamp

    def is_future(self, timestamp: datetime, tolerance_minutes: int = 5) -&gt; bool:
        &quot;&quot;&quot;
        判斷時間戳是否為「未來資料」
        標準：timestamp &gt; origin_timestamp + tolerance_minutes
        &quot;&quot;&quot;
        threshold = self.origin_timestamp + timedelta(minutes=tolerance_minutes)
        return timestamp &gt; threshold

    def get_elapsed_minutes(self) -&gt; float:
        &quot;&quot;&quot;取得 Pipeline 已執行時間（用於漂移檢測）&quot;&quot;&quot;
        return (datetime.now(UTC) - self.origin_timestamp).total_seconds() / 60
</code></pre>
<p><strong>傳遞機制</strong>：<br />
1. <strong>Container → 各模組</strong>: 通過建構子注入 <code>temporal_context: TemporalContext</code><br />
2. <strong>模組間傳遞</strong>: 通過 DataFrame metadata 或 Manifest 欄位 <code>temporal_baseline</code><br />
3. <strong>檢查點驗證</strong>: 每個檢查點驗證輸入資料的 <code>temporal_baseline</code> 與當前 Context 一致（防止跨 Pipeline 混用）</p>
<h3 id="82">8.2 各模組實作規範</h3>
<p><strong>Parser</strong>:<br />
- 接收 <code>TemporalContext</code>，在輸出 metadata 中記錄 <code>pipeline_origin_timestamp</code><br />
- 驗證邏輯：若輸入資料時間 &gt; <code>context.get_baseline() + 5min</code>，拋出 E102<br />
- <strong>強化</strong>: 若 <code>context.get_elapsed_minutes() &gt; 60</code>，記錄 E000-W 警告（長時間執行檢測）</p>
<p><strong>Cleaner</strong>:<br />
- 從輸入 metadata 讀取 <code>pipeline_origin_timestamp</code>，傳遞至輸出<br />
- 驗證邏輯：清洗後資料時間不可超過基準+5分鐘（E102）<br />
- <strong>強化</strong>: 若啟用 <code>enforce_equipment_validation_sync</code>，在時間檢查後執行設備邏輯預檢</p>
<p><strong>BatchProcessor</strong>:<br />
- 將 <code>temporal_baseline</code> 寫入 Manifest（見 2.3 節 Manifest 契約）<br />
- 批次驗證：整個批次時間範圍不可超過基準+5分鐘（E205）<br />
- <strong>強化</strong>: 記錄 <code>baseline_version</code> 至 Manifest，供下游相容性檢查</p>
<p><strong>FeatureEngineer → Model Training</strong>:<br />
- 特徵矩陣 metadata 必須包含 <code>pipeline_origin_timestamp</code>（用於追溯）<br />
- <strong>注意</strong>: Training 階段不直接使用此時間戳進行「未來檢查」，但必須傳遞至模型產物<br />
- <strong>強化</strong>: 記錄特徵工程執行時間與基準時間的差異（用於效能分析）</p>
<p><strong>Optimization</strong>:<br />
- <strong>產生新基準</strong>: Optimization 階段必須產生新的 <code>pipeline_origin_timestamp</code>（推論當下時間）<br />
- <strong>不可沿用 Training 時間</strong>: 防止「訓練時的未來資料」在推論時變成「過去資料」的邏輯錯誤<br />
- <strong>強化</strong>: 驗證輸入資料時間範圍與新基準的合理性（防止使用過舊的訓練模型）</p>
<h3 id="83">8.3 錯誤處理</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">場景</th>
<th style="text-align: center;">錯誤代碼</th>
<th style="text-align: left;">處理方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Container 未初始化 TemporalContext</td>
<td style="text-align: center;">E000</td>
<td style="text-align: left;">立即終止，記錄「時間基準未建立」</td>
</tr>
<tr>
<td style="text-align: left;">模組接收不到 temporal_baseline</td>
<td style="text-align: center;">E000</td>
<td style="text-align: left;">終止流程，要求檢查上游輸出</td>
</tr>
<tr>
<td style="text-align: left;">時間戳格式非 ISO 8601 UTC</td>
<td style="text-align: center;">E002</td>
<td style="text-align: left;">視為時區違反</td>
</tr>
<tr>
<td style="text-align: left;">基準時間與系統時間差距過大（&gt;1小時）</td>
<td style="text-align: center;">E000-W</td>
<td style="text-align: left;">警告「Pipeline 執行時間過長或系統時間異常」</td>
</tr>
<tr>
<td style="text-align: left;">跨日執行時（00:00 前後）時間計算錯誤</td>
<td style="text-align: center;">E000</td>
<td style="text-align: left;">終止流程，檢查時間基準一致性</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9-feature-alignment-scaling-contract">9. 特徵對齊與縮放參數傳遞規範 (Feature Alignment &amp; Scaling Contract)</h2>
<h3 id="91">9.1 問題定義</h3>
<p>為解決「Training 與 Optimization 特徵向量不一致導致 Silent Failure」風險（原第3點建議），建立以下嚴格契約：</p>
<p><strong>風險場景</strong>：<br />
- Training: 特徵順序 <code>[chiller_1_load, chiller_2_load, wb_temp, ...]</code><br />
- Optimization: 特徵順序 <code>[wb_temp, chiller_1_load, chiller_2_load, ...]</code><br />
- 結果：模型將 <code>wb_temp</code> 誤認為 <code>chiller_2_load</code>，導致預測完全錯誤但無警告</p>
<h3 id="92-feature-manifest">9.2 Feature Manifest 規格</h3>
<p><strong>輸出位置</strong>: <code>ModelTrainer</code> 輸出目錄中的 <code>feature_manifest.json</code></p>
<pre><code class="language-json">{
  &quot;manifest_version&quot;: &quot;2.0-ALIGN&quot;,
  &quot;created_at&quot;: &quot;2026-02-13T10:30:00Z&quot;,
  &quot;pipeline_origin_timestamp&quot;: &quot;2026-02-13T10:00:00Z&quot;,

  &quot;feature_specification&quot;: {
    &quot;feature_names&quot;: [&quot;chiller_1_load&quot;, &quot;chiller_2_load&quot;, &quot;wb_temp&quot;, &quot;chwst_temp&quot;],
    &quot;feature_count&quot;: 4,
    &quot;feature_hash&quot;: &quot;sha256:a1b2c3d4...&quot;,
    &quot;hash_algorithm&quot;: &quot;SHA256&quot;,
    &quot;hash_computation&quot;: &quot;sha256(','.join(feature_names).encode())&quot;
  },

  &quot;scaling_specification&quot;: {
    &quot;scaler_type&quot;: &quot;StandardScaler&quot;,
    &quot;scaler_params&quot;: {
      &quot;mean_&quot;: [450.5, 420.3, 28.5, 7.2],
      &quot;scale_&quot;: [120.2, 115.8, 2.1, 0.5],
      &quot;var_&quot;: [14448.04, 13401.64, 4.41, 0.25]
    },
    &quot;scaler_feature_names&quot;: [&quot;chiller_1_load&quot;, &quot;chiller_2_load&quot;, &quot;wb_temp&quot;, &quot;chwst_temp&quot;],
    &quot;scaler_hash&quot;: &quot;sha256:e5f6g7h8...&quot;
  },

  &quot;equipment_constraints&quot;: {
    &quot;constraints_applied&quot;: [&quot;chiller_pump_mutex&quot;, &quot;min_runtime_15min&quot;],
    &quot;validation_enabled&quot;: true,
    &quot;constraint_hash&quot;: &quot;sha256:i9j0k1l2...&quot;
  },

  &quot;validation_rules&quot;: {
    &quot;allow_subset&quot;: false,
    &quot;allow_superset&quot;: false,
    &quot;strict_order&quot;: true,
    &quot;case_sensitive&quot;: true,
    &quot;validate_equipment_constraints&quot;: true
  }
}
</code></pre>
<h3 id="93-optimization">9.3 對齊驗證流程 (Optimization 階段)</h3>
<p><strong>Step 1: 完整性檢查</strong> (E901)</p>
<pre><code class="language-python">if not os.exists('feature_manifest.json'):
    raise E901(&quot;缺少 feature_manifest，無法驗證特徵對齊&quot;)
</code></pre>
<p><strong>Step 2: 特徵清單比對</strong> (E901)</p>
<pre><code class="language-python">expected_features = manifest['feature_specification']['feature_names']
input_features = get_input_feature_names()  # 從 Optimization 輸入取得

if expected_features != input_features:
    # 詳細差異分析
    diff = list(dictdiffer.diff(expected_features, input_features))
    raise E901(f&quot;特徵順序不匹配: {diff}&quot;)
</code></pre>
<p><strong>Step 3: 雜湊驗證</strong> (E901-optional)</p>
<pre><code class="language-python">computed_hash = sha256(','.join(input_features).encode()).hexdigest()
if computed_hash != manifest['feature_specification']['feature_hash']:
    raise E901(&quot;特徵雜湊驗證失敗：特徵名稱或順序被修改&quot;)
</code></pre>
<p><strong>Step 4: 縮放參數應用</strong> (E903)</p>
<pre><code class="language-python">if manifest['scaling_specification']['scaler_type'] == 'StandardScaler':
    scaler = StandardScaler()
    scaler.mean_ = np.array(manifest['scaling_specification']['scaler_params']['mean_'])
    scaler.scale_ = np.array(manifest['scaling_specification']['scaler_params']['scale_'])

    # 驗證縮放參數長度
    if len(scaler.mean_) != len(input_features):
        raise E902(f&quot;縮放參數長度 {len(scaler.mean_)} 與特徵數 {len(input_features)} 不匹配&quot;)

    # 驗證縮放參數順序（通過 feature_names 比對）
    if manifest['scaling_specification']['scaler_feature_names'] != input_features:
        raise E903(&quot;縮放參數特徵順序與輸入特徵順序不一致&quot;)
</code></pre>
<p><strong>Step 5: 設備限制一致性驗證</strong> (E904，新增)</p>
<pre><code class="language-python">if manifest['validation_rules'].get('validate_equipment_constraints', False):
    train_constraints = set(manifest['equipment_constraints']['constraints_applied'])
    current_constraints = set(get_current_equipment_constraints())

    if train_constraints != current_constraints:
        raise E904(f&quot;設備限制不一致: 訓練使用 {train_constraints}，當前使用 {current_constraints}&quot;)
</code></pre>
<h3 id="94">9.4 容錯與恢復策略</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">錯誤情境</th>
<th style="text-align: left;">自動恢復策略</th>
<th style="text-align: left;">人工介入</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">E901: 特徵順序錯誤</td>
<td style="text-align: left;"><strong>禁止自動恢復</strong></td>
<td style="text-align: left;">必須檢查 ETL 流程，確認特徵產生邏輯</td>
</tr>
<tr>
<td style="text-align: left;">E902: 維度不匹配</td>
<td style="text-align: left;">檢查是否缺少常數特徵（如 bias），若可補零則補零並警告</td>
<td style="text-align: left;">確認特徵工程邏輯變更</td>
</tr>
<tr>
<td style="text-align: left;">E903: 縮放參數缺失</td>
<td style="text-align: left;">使用線上統計即時計算 mean/std，標記為「非確定性縮放」</td>
<td style="text-align: left;">建議重新訓練模型以固定縮放參數</td>
</tr>
<tr>
<td style="text-align: left;">E904: 設備限制不一致</td>
<td style="text-align: left;">嘗試使用訓練時的限制設定，記錄警告</td>
<td style="text-align: left;">檢查設備配置變更是否影響模型有效性</td>
</tr>
</tbody>
</table>
<h3 id="95">9.5 與現有檢查點的整合</h3>
<ul>
<li><strong>檢查點 #4</strong> (FeatureEngineer → Model Training): 驗證 Feature Manifest 正確產生（E601, E602）</li>
<li><strong>檢查點 #7</strong> (Model Training → Optimization): 驗證 Feature Manifest 正確載入與比對（E901, E902, E903, E904）</li>
</ul>
<hr />
<h2 id="10-header-standardization-csv">10. Header Standardization 規範 (CSV 標頭正規化)</h2>
<h3 id="101">10.1 問題定義</h3>
<p>CSV 檔案的標頭（欄位名稱）常包含不一致的命名（如 <code>Chiller 1 Temp</code>、<code>power(kW)</code>、<code>sensor-A</code>），導致與 Feature Annotation 中定義的 <code>column_name</code> 無法匹配。為解決此問題，建立自動正規化機制。</p>
<h3 id="102-regex-based">10.2 正規化規則 (Regex-based)</h3>
<p><strong>標準命名規範</strong>: <code>snake_case</code>，僅允許小寫英文字母、數字、底線。</p>
<p><strong>正規化流程</strong>:</p>
<pre><code class="language-python">HEADER_STANDARDIZATION_RULES = [
    # 步驟 1: 移除前後空白
    (r'^\s+|\s+$', ''),

    # 步驟 2: 將 camelCase/PascalCase 轉換為 snake_case
    # 插入底線在大寫字母前，然後轉小寫
    (r'(?&lt;=[a-z0-9])(?=[A-Z])', '_'),  # 在小寫/數字後的大寫前插入底線
    (r'(?&lt;=[A-Z])(?=[A-Z][a-z])', '_'),  # 在連續大寫中的第二個大寫前插入底線（如 HTTPRequest → HTTP_Request）

    # 步驟 3: 替換非法字元為底線
    (r'[^a-zA-Z0-9_]', '_'),  # 非字母數字底線的字元替換為底線

    # 步驟 4: 合併連續底線
    (r'_+', '_'),

    # 步驟 5: 移除開頭數字（Python 變數限制）
    (r'^[0-9]+', 'col_'),

    # 步驟 6: 轉換為小寫
    (r'[A-Z]', lambda m: m.group(0).lower()),
]

def standardize_header(header: str) -&gt; str:
    &quot;&quot;&quot;
    將 CSV 標頭正規化為 snake_case

    Args:
        header: 原始標頭字串

    Returns:
        正規化後的標頭

    Raises:
        HeaderStandardizationError: 若正規化後仍不符合規則（如空字串、僅含底線）
    &quot;&quot;&quot;
    import re

    result = header
    for pattern, replacement in HEADER_STANDARDIZATION_RULES:
        if callable(replacement):
            result = re.sub(pattern, replacement, result)
        else:
            result = re.sub(pattern, replacement, result)

    # 驗證結果
    if not result or result == '_' or not re.match(r'^[a-z][a-z0-9_]*$', result):
        raise HeaderStandardizationError(
            f&quot;E105: 標頭 '{header}' 無法正規化為有效識別符，結果: '{result}'&quot;
        )

    return result
</code></pre>
<h3 id="103">10.3 常見標頭轉換範例</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">原始標頭</th>
<th style="text-align: left;">正規化結果</th>
<th style="text-align: left;">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>Chiller 1 Temp</code></td>
<td style="text-align: left;"><code>chiller_1_temp</code></td>
<td style="text-align: left;">空格轉底線，大寫轉小寫</td>
</tr>
<tr>
<td style="text-align: left;"><code>power(kW)</code></td>
<td style="text-align: left;"><code>power_kw</code></td>
<td style="text-align: left;">移除括號，保留字母數字</td>
</tr>
<tr>
<td style="text-align: left;"><code>sensor-A</code></td>
<td style="text-align: left;"><code>sensor_a</code></td>
<td style="text-align: left;">連字號轉底線</td>
</tr>
<tr>
<td style="text-align: left;"><code>HTTPRequest</code></td>
<td style="text-align: left;"><code>http_request</code></td>
<td style="text-align: left;">PascalCase 轉 snake_case</td>
</tr>
<tr>
<td style="text-align: left;"><code>Total_Power</code></td>
<td style="text-align: left;"><code>total_power</code></td>
<td style="text-align: left;">大寫轉小寫</td>
</tr>
<tr>
<td style="text-align: left;"><code>123_sensor</code></td>
<td style="text-align: left;"><code>col_123_sensor</code></td>
<td style="text-align: left;">開頭數字前綴 <code>col_</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>Temp..Value</code></td>
<td style="text-align: left;"><code>temp_value</code></td>
<td style="text-align: left;">合併連續底線</td>
</tr>
</tbody>
</table>
<h3 id="104-parser">10.4 Parser 整合規範</h3>
<p><strong>執行時機</strong>: Parser 讀取 CSV 後、建立 DataFrame 前。</p>
<pre><code class="language-python">class ReportParser:
    def _standardize_headers(self, headers: List[str]) -&gt; List[str]:
        &quot;&quot;&quot;
        正規化 CSV 標頭，並記錄映射關係供除錯
        &quot;&quot;&quot;
        standardized = []
        mapping = {}

        for original in headers:
            try:
                normalized = standardize_header(original)
                standardized.append(normalized)
                mapping[original] = normalized

                if original != normalized:
                    self.logger.warning(f&quot;E105: 標頭正規化: '{original}' → '{normalized}'&quot;)

            except HeaderStandardizationError as e:
                self.logger.error(str(e))
                raise E105(f&quot;無法正規化標頭: {original}&quot;)

        # 檢查重複（正規化後可能產生衝突）
        if len(standardized) != len(set(standardized)):
            duplicates = [h for h in standardized if standardized.count(h) &gt; 1]
            raise E105(f&quot;正規化後產生重複標頭: {set(duplicates)}&quot;)

        return standardized
</code></pre>
<h3 id="105-feature-annotation">10.5 與 Feature Annotation 的對接</h3>
<p>正規化後的標頭必須與 Annotation YAML 中的 <code>column_name</code> 完全匹配：</p>
<pre><code class="language-python">def validate_header_annotation_match(standardized_headers: List[str], annotation_manager) -&gt; None:
    &quot;&quot;&quot;
    驗證正規化後的標頭與 Annotation 定義匹配（檢查點 #6 延伸）
    &quot;&quot;&quot;
    unannotated = []
    for header in standardized_headers:
        if not annotation_manager.is_column_annotated(header):
            unannotated.append(header)

    if unannotated:
        raise E409(
            f&quot;CSV 標頭（正規化後）無法對應至 Annotation: {unannotated}。 &quot;
            f&quot;請確認 Excel 標註中的 column_name 是否與正規化結果一致，&quot;
            f&quot;或執行 features wizard 進行標註。&quot;
        )
</code></pre>
<hr />
<h2 id="11-equipment-validation-sync">11. Equipment Validation Sync 規範 (設備邏輯同步)</h2>
<h3 id="111">11.1 問題定義</h3>
<p>為解決「DataCleaner 清洗時未檢測設備邏輯違規，導致模型學習錯誤物理規律，Optimization 階段卻發現限制條件不可行」的 Physics Logic Decoupling 風險，建立 Cleaner 與 Optimization 之間的設備邏輯同步機制。</p>
<h3 id="112-ssot">11.2 設備邏輯限制定義 (SSOT)</h3>
<pre><code class="language-python"># src/etl/config_models.py
EQUIPMENT_VALIDATION_CONSTRAINTS = {
    &quot;chiller_pump_mutex&quot;: {
        &quot;description&quot;: &quot;主機開啟時必須有至少一台冷卻水泵運轉&quot;,
        &quot;check_type&quot;: &quot;requires&quot;,
        &quot;trigger&quot;: &quot;chiller_1_status == 1 OR chiller_2_status == 1&quot;,
        &quot;requirement&quot;: &quot;pump_1_status == 1 OR pump_2_status == 1&quot;,
        &quot;severity&quot;: &quot;critical&quot;,  # 違反時標記為 PHYSICAL_IMPOSSIBLE
    },
    &quot;min_runtime_15min&quot;: {
        &quot;description&quot;: &quot;主機開啟後至少運轉 15 分鐘才能關閉&quot;,
        &quot;check_type&quot;: &quot;sequence&quot;,
        &quot;min_duration_minutes&quot;: 15,
        &quot;applies_to&quot;: [&quot;chiller_1_status&quot;, &quot;chiller_2_status&quot;],
        &quot;severity&quot;: &quot;warning&quot;,  # 違反時標記為 EQUIPMENT_VIOLATION
    },
    &quot;min_downtime_10min&quot;: {
        &quot;description&quot;: &quot;主機關閉後至少停機 10 分鐘才能開啟&quot;,
        &quot;check_type&quot;: &quot;sequence&quot;,
        &quot;min_duration_minutes&quot;: 10,
        &quot;applies_to&quot;: [&quot;chiller_1_status&quot;, &quot;chiller_2_status&quot;],
        &quot;severity&quot;: &quot;warning&quot;,
    },
    &quot;chiller_mutual_exclusion&quot;: {
        &quot;description&quot;: &quot;備用主機與主主機不可同時開啟（視情況而定）&quot;,
        &quot;check_type&quot;: &quot;mutex&quot;,
        &quot;mutex_pairs&quot;: [[&quot;chiller_1_status&quot;, &quot;chiller_2_status&quot;]],
        &quot;condition&quot;: &quot;device_role == 'backup'&quot;,  # 僅當角色為 backup 時檢查
        &quot;severity&quot;: &quot;warning&quot;,
    }
}
</code></pre>
<h3 id="113-cleaner-e350">11.3 Cleaner 整合規範 (E350)</h3>
<p>DataCleaner 在清洗階段執行基礎設備邏輯預檢：</p>
<pre><code class="language-python">class DataCleaner:
    def __init__(self, config, annotation_manager, equipment_validator=None):
        # ...
        self.equipment_validator = equipment_validator
        self.enable_equipment_sync = config.get('enforce_equipment_validation_sync', False)

    def _apply_equipment_validation_precheck(self, df: pl.DataFrame) -&gt; pl.DataFrame:
        &quot;&quot;&quot;
        設備邏輯預檢（檢查點 #2 延伸）

        邏輯：
        1. 讀取設備狀態欄位（依據 Annotation 中的 physical_type == 'status'）
        2. 檢查 EQUIPMENT_VALIDATION_CONSTRAINTS 中的條件
        3. 違反時標記 quality_flags，並記錄至 metadata
        &quot;&quot;&quot;
        if not self.enable_equipment_sync or not self.equipment_validator:
            return df

        violations = []

        for constraint_id, constraint in EQUIPMENT_VALIDATION_CONSTRAINTS.items():
            # 執行檢查邏輯（簡化範例）
            if constraint['check_type'] == 'requires':
                violated = self._check_requires_constraint(df, constraint)
            elif constraint['check_type'] == 'mutex':
                violated = self._check_mutex_constraint(df, constraint)
            elif constraint['check_type'] == 'sequence':
                violated = self._check_sequence_constraint(df, constraint)

            if violated:
                violations.append(constraint_id)

                # 根據嚴重程度標記
                if constraint['severity'] == 'critical':
                    flag = 'PHYSICAL_IMPOSSIBLE'
                else:
                    flag = 'EQUIPMENT_VIOLATION'

                # 標記違規時間點
                df = self._mark_violation_flags(df, violated, flag)

        # 記錄至 metadata（供 BatchProcessor 寫入 Manifest）
        self._equipment_validation_audit = {
            'validation_enabled': True,
            'constraints_applied': list(EQUIPMENT_VALIDATION_CONSTRAINTS.keys()),
            'violations_detected': len(violations),
            'violation_details': violations
        }

        return df
</code></pre>
<h3 id="114-batchprocessor">11.4 BatchProcessor 稽核軌跡</h3>
<p>BatchProcessor 將設備邏輯預檢結果寫入 Manifest：</p>
<pre><code class="language-python">def _generate_manifest(self, df, column_metadata, output_files):
    # ...
    manifest = Manifest(
        # ... 其他欄位
        equipment_validation_audit=getattr(
            self.cleaner, '_equipment_validation_audit', 
            {'validation_enabled': False}
        )
    )
    return manifest
</code></pre>
<h3 id="115-optimization-e904">11.5 Optimization 一致性驗證 (E904)</h3>
<p>Optimization 階段驗證使用的設備限制與 Training 時一致：</p>
<pre><code class="language-python">class OptimizationEngine:
    def _validate_equipment_constraint_consistency(self, model_artifact):
        &quot;&quot;&quot;
        驗證設備限制一致性（檢查點 #7 延伸）
        &quot;&quot;&quot;
        train_audit = model_artifact.get('equipment_constraints', {})
        current_constraints = set(EQUIPMENT_VALIDATION_CONSTRAINTS.keys())

        if train_audit.get('validation_enabled'):
            train_constraints = set(train_audit.get('constraints_applied', []))

            if train_constraints != current_constraints:
                raise E904(
                    f&quot;設備限制不一致: 訓練時啟用 {train_constraints}，&quot;
                    f&quot;當前系統啟用 {current_constraints}。 &quot;
                    f&quot;這可能導致優化結果與模型訓練時的物理假設衝突。&quot;
                )
</code></pre>
<h3 id="116">11.6 與現有檢查點的整合</h3>
<ul>
<li><strong>檢查點 #2</strong> (Cleaner → BatchProcessor): 新增 E350 設備邏輯預檢失敗錯誤</li>
<li><strong>檢查點 #3</strong> (BatchProcessor → Feature Engineer): Manifest 包含 <code>equipment_validation_audit</code></li>
<li><strong>檢查點 #4</strong> (Feature Engineer → Model Training): 特徵工程考慮設備狀態邏輯一致性</li>
<li><strong>檢查點 #7</strong> (Model Training → Optimization): 新增 E904 設備限制不一致錯誤</li>
</ul>
<hr />
<h2 id="12">12. 版本歷史與變更記錄</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">版本</th>
<th style="text-align: center;">日期</th>
<th style="text-align: left;">變更內容</th>
<th style="text-align: center;">負責人</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">2026-02-13</td>
<td style="text-align: left;">初始版本，建立基礎檢查點與錯誤代碼分層</td>
<td style="text-align: center;">Oscar Chang</td>
</tr>
<tr>
<td style="text-align: center;"><strong>v1.1</strong></td>
<td style="text-align: center;"><strong>2026-02-14</strong></td>
<td style="text-align: left;"><strong>重大更新：依據 Project Execution Evaluation Report 建議強化</strong></td>
<td style="text-align: center;"><strong>Oscar Chang</strong></td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;">1. 新增第10章：Header Standardization 規範（Regex 正規化規則）</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;">2. 新增第11章：Equipment Validation Sync 規範（設備邏輯同步）</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;">3. 強化第8章：Temporal Baseline 時間一致性防護（新增漂移檢測）</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;">4. 擴展錯誤代碼：新增 E105, E350-E352, E408-E409, E904</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;">5. 更新檢查點 #2, #3, #4, #7：加入設備邏輯與 SSOT 同步檢查</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;">6. 新增版本相容性矩陣：強制升級路徑與不相容組合說明</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<hr />
<p><strong>簽核欄</strong>：<br />
- [ ] 架構師確認：檢查點定義涵蓋所有模組間介面（含 Training-Optimization 與 Equipment Validation Sync）<br />
- [ ] 技術負責人確認：錯誤代碼分層 E000-E999 無衝突，新增代碼已正確定義<br />
- [ ] HVAC 領域專家確認：Header Standardization 規則符合業界命名慣例，Equipment Validation 邏輯符合物理實務<br />
- [ ] 維運負責人確認：版本相容性矩陣可指導部署決策，時間一致性機制可防止跨日執行錯誤<br />
- [ ] Product Manager 確認：回應 Project Execution Evaluation Report 所有建議事項（Header Standardization, Temporal Consistency, Physics Logic Coupling）</p>
<hr />
<p><strong>文件結束</strong><br />
```</p>
<p>此修正版 PRD_Interface_Contract_v1.1 已完整回應評估報告的所有建議：</p>
<ol>
<li><strong>Header Standardization</strong>（第10章）：建立具體的 Regex 正規化規則，解決 CSV 標頭命名不一致問題</li>
<li><strong>時間一致性防護</strong>（第8章強化）：新增時間漂移檢測與跨日執行防護，解決 Spatio-Temporal Inconsistency 風險</li>
<li><strong>設備邏輯同步</strong>（第11章）：建立 Cleaner 與 Optimization 之間的 Equipment Validation Sync 機制，解決 Physics Logic Decoupling 風險</li>
<li><strong>SSOT 強化</strong>：新增 E408、E409 錯誤代碼，強化 Feature Annotation 與程式碼的同步檢查，預防 Dependency Deadlock</li>
</ol>
<p>所有新增內容均包含詳細實作規格、錯誤處理流程、與現有檢查點的整合機制，以及完整的驗證檢查清單。</p>
</body>
</html>