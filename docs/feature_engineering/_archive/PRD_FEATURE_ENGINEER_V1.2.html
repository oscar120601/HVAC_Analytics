<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_FEATURE_ENGINEER_V1.2</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v12-feature-engineering-implementation-guide">PRD v1.2: ç‰¹å¾µå·¥ç¨‹å¼·å¥æ€§å¯¦ä½œæŒ‡å— (Feature Engineering Implementation Guide)</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.2<br />
<strong>æ—¥æœŸ:</strong> 2026-02-12<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/etl/feature_engineer.py</code><br />
<strong>ç›¸ä¾æ¨¡çµ„:</strong> <code>src/etl/cleaner.py</code> (v2.0+), <code>src/utils/physics.py</code><br />
<strong>é ä¼°å·¥æ™‚:</strong> 3 ~ 4 å€‹å·¥ç¨‹å¤©ï¼ˆå«æ•´åˆæ¸¬è©¦ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆåŸå‰‡</h2>
<h3 id="11">1.1 æ ¸å¿ƒè·è²¬</h3>
<p>æœ¬æ¨¡çµ„å°ˆæ³¨æ–¼ <strong>ã€ŒåŠ æ³•èˆ‡å‰µé€ ã€</strong>ï¼Œåš´æ ¼ç¦æ­¢åŸ·è¡Œè³‡æ–™æ¸…æ´—æˆ–éæ¿¾ã€‚æ‰€æœ‰è¼¸å…¥è³‡æ–™å¿…é ˆå…ˆç¶“é <code>DataCleaner</code> è™•ç†ã€‚</p>
<p><strong>è¨­è¨ˆåŸå‰‡ï¼š</strong><br />
1. <strong>é˜²ç¦¦å¼è¨­è¨ˆ</strong>ï¼šå³ä½¿ Cleaner è¼¸å‡ºç•°å¸¸ï¼ˆå« Nullã€ç©ºç¼ºï¼‰ï¼Œä»ä¸æ‹‹å‡ºè‡´å‘½éŒ¯èª¤<br />
2. <strong>å†ªç­‰æ€§ (Idempotency)</strong>ï¼šç›¸åŒè¼¸å…¥åŸ·è¡Œå¤šæ¬¡ï¼Œè¼¸å‡ºå¿…é ˆå®Œå…¨ä¸€è‡´<br />
3. <strong>è¨˜æ†¶é«”å®‰å…¨</strong>ï¼šV1.0 æ˜ç¢ºé–å®š <strong>In-Memory æ‰¹æ¬¡è™•ç†</strong>ï¼ˆä½†ä»‹é¢é ç•™ LazyFrame å½ˆæ€§ï¼‰<br />
4. <strong>é˜² Data Leakage</strong>ï¼šæ‰€æœ‰ Rolling/Lag ç‰¹å¾µåš´æ ¼æ’é™¤ã€Œç•¶å‰æ™‚é–“é»ã€</p>
<h3 id="12-inputoutput-contract">1.2 è¼¸å…¥è¼¸å‡ºå¥‘ç´„ï¼ˆInput/Output Contractï¼‰</h3>
<pre><code class="language-python">class FeatureEngineerInputContract:
    required_columns: List[str] = [&quot;timestamp&quot;]
    expected_frequency: str = &quot;15min&quot;
    timestamp_tz: str = &quot;UTC&quot;
    quality_flags_handling: Literal[&quot;drop&quot;, &quot;onehot&quot;, &quot;ignore&quot;] = &quot;onehot&quot;

    # ã€æ–°å¢ã€‘è³‡æ–™æ´©æ¼é˜²è­·æª¢æŸ¥
    strict_temporal_integrity: bool = True  # è‹¥ Trueï¼Œç™¼ç¾æœªä¾†è³‡æ–™æ™‚æ‹‹å‡ºä¾‹å¤–

class FeatureEngineerOutputContract:
    feature_naming_convention: str = &quot;{original_col}_{transformation}_{parameters}&quot;
    null_strategy: str = &quot;propagate_with_flag&quot;

    # ã€æ–°å¢ã€‘æ™‚åºæ­£ç¢ºæ€§ä¿è­‰
    temporal_consistency: str = &quot;æ‰€æœ‰ Lag/Rolling ç‰¹å¾µåƒ…ä½¿ç”¨éå»è³‡æ–™ï¼ˆä¸åŒ…å«ç•¶å‰é»ï¼‰&quot;
</code></pre>
<h3 id="13">1.3 åŠŸèƒ½ç¯„åœ</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">ç¯„åœ</th>
<th style="text-align: left;">åŒ…å«é …ç›® (In-Scope)</th>
<th style="text-align: left;">æ’é™¤é …ç›® (Out-of-Scope)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>è™•ç†æ¨¡å¼</strong></td>
<td style="text-align: left;"><strong>V1.0 åƒ…æ”¯æ´ In-Memory</strong>ï¼ˆpl.DataFrameï¼‰<br>ä»‹é¢é ç•™ pl.LazyFrame ç›¸å®¹æ€§</td>
<td style="text-align: left;">V1.0 ä¸æ”¯æ´ Streaming Mode<br>ï¼ˆè¨˜æ†¶é«”ä¸è¶³æ™‚æ‡‰æ”¹ç”¨åˆ†æ‰¹è®€å–ï¼Œé LazyFrameï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>P1 ç‰©ç†ç‰¹å¾µ</strong></td>
<td style="text-align: left;">æ¿•çƒæº«åº¦ã€ç„“å€¼</td>
<td style="text-align: left;">å–®ä½è½‰æ›ï¼ˆç”± Cleaner è™•ç†ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>P2 çµ±è¨ˆç‰¹å¾µ</strong></td>
<td style="text-align: left;">Lagï¼ˆå»¶é²ï¼‰ã€Rollingï¼ˆæ»¾å‹•çµ±è¨ˆï¼‰<br>ã€å¼·åˆ¶ã€‘æ’é™¤ç•¶å‰é»ï¼ˆclosed='left'ï¼‰</td>
<td style="text-align: left;">è¤‡é›œçµ±è¨ˆï¼ˆEWMï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>P3 äº’å‹•ç‰¹å¾µ</strong></td>
<td style="text-align: left;">Out-of-Scope</td>
<td style="text-align: left;">éç·šæ€§äº¤äº’é …</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. ç³»çµ±æ¶æ§‹èˆ‡é…ç½®</h2>
<h3 id="21-multi-asset">2.1 ã€ä¿®æ­£ã€‘çµ±ä¸€é…ç½®æª”çµæ§‹ï¼ˆæ”¯æ´ Multi-Assetï¼‰</h3>
<pre><code class="language-yaml"># config/settings.yaml
etl_pipeline:
  feature_engineer:
    schema_version: &quot;1.2&quot;

    # ã€æ–°å¢ã€‘è™•ç†æ¨¡å¼è²æ˜
    execution_mode: &quot;in_memory&quot;  # v1.2 åƒ…æ”¯æ´ in_memoryï¼Œä¿ç•™æ¬„ä½ä¾› v2.0 æ“´å……

    input_contract:
      quality_flags_handling: &quot;onehot&quot;
      strict_temporal_integrity: true

    # ã€å„ªåŒ–ã€‘Multi-Asset ç¾¤çµ„ç­–ç•¥ï¼ˆå–ä»£é€ä¸€åˆ—èˆ‰ï¼‰
    stats_features:
      enabled: true

      # æ–¹æ¡ˆï¼šä»¥ physical_type è‡ªå‹•åŒ¹é…ï¼Œç„¡éœ€åˆ—èˆ‰æ¬„ä½åç¨±
      group_policies:
        - apply_to_types: [&quot;chiller_load&quot;, &quot;cooling_tower_load&quot;]
          rules:
            lag_intervals: [1, 4]      # 15min, 1hr
            rolling_windows: [4, 96]    # 1hr, 24hrï¼ˆä»¥å€é–“æ•¸è¨ˆï¼Œéçµ•å°æ™‚é–“ï¼‰
            aggregations: [&quot;mean&quot;, &quot;std&quot;]
            max_window_points: 1000     # å®‰å…¨é™åˆ¶

        - apply_to_types: [&quot;power_usage&quot;]
          rules:
            lag_intervals: [1]
            rolling_windows: [4]
            aggregations: [&quot;mean&quot;, &quot;max&quot;]

      # ä¾‹å¤–è™•ç†ï¼šç‰¹å®šæ¬„ä½è¦†å¯«ï¼ˆå¯é¸ï¼‰
      column_overrides:
        chiller_1_load:  # è‹¥æŸå°å†°æ©Ÿéœ€è¦ç‰¹æ®Šè™•ç†
          lag_intervals: [1, 2, 4]

    physics_features:
      enabled: true
      library: &quot;psychrolib&quot;
      apply_to_types: [&quot;dry_bulb_temp&quot;, &quot;relative_humidity&quot;]  # è‡ªå‹•é…å°è¨ˆç®—æ¿•çƒæº«åº¦

    time_features:
      enabled: true
      cyclical_encoding: true
      components: [&quot;hour&quot;, &quot;day_of_week&quot;, &quot;month&quot;, &quot;is_weekend&quot;]
</code></pre>
<h3 id="22-group-policy">2.2 ã€æ–°å¢ã€‘Group Policy è§£æé‚è¼¯</h3>
<pre><code class="language-python"># src/etl/feature_engineer.py
def _resolve_group_policies(self, df: pl.DataFrame) -&gt; Dict[str, StatsRule]:
    &quot;&quot;&quot;
    å°‡ group_policies è§£æç‚ºå…·é«”æ¬„ä½é…ç½®
    é¿å…é€ä¸€åˆ—èˆ‰å°è‡´çš„ config è†¨è„¹
    &quot;&quot;&quot;
    resolved = {}
    for policy in self.config.stats_features.group_policies:
        target_cols = [
            col for col in df.columns 
            if get_feature_meta(col).physical_type in policy.apply_to_types
            and not get_feature_meta(col).is_target  # æ’é™¤ç›®æ¨™è®Šæ•¸
        ]
        for col in target_cols:
            resolved[col] = policy.rules
    return resolved
</code></pre>
<hr />
<h2 id="3">3. åˆ†éšæ®µå¯¦ä½œè¨ˆç•«</h2>
<h3 id="phase-1-lazyframe">Phase 1: åŸºç¤æ¶æ§‹ï¼ˆå« LazyFrame ä»‹é¢é ç•™ï¼‰</h3>
<h4 id="step-11-group-policy">Step 1.1: é…ç½®æ¨¡å‹ï¼ˆå« Group Policyï¼‰</h4>
<pre><code class="language-python">from pydantic import BaseModel, validator
from typing import Union

class StatsRule(BaseModel):
    lag_intervals: List[int]
    rolling_windows: List[int]
    aggregations: List[str]
    max_window_points: int = 1000

    @validator('rolling_windows')
    def check_window_size(cls, v, values):
        max_points = values.get('max_window_points', 1000)
        if any(x &gt; max_points for x in v):
            raise ValueError(f&quot;Rolling window exceeds limit of {max_points}&quot;)
        return v

class GroupPolicy(BaseModel):
    apply_to_types: List[str]  # åŒ¹é… physical_type
    rules: StatsRule

class FeatureEngineeringConfig(BaseModel):
    schema_version: Literal[&quot;1.2&quot;] = &quot;1.2&quot;
    execution_mode: Literal[&quot;in_memory&quot;] = &quot;in_memory&quot;  # V1.2 é–å®š
    input_contract: FeatureEngineerInputContract
    stats_features: dict  # åŒ…å« group_policies èˆ‡ column_overrides
    physics_features: PhysicsConfig
    time_features: TimeConfig
</code></pre>
<h4 id="step-12-union">Step 1.2: æ¨¡çµ„éª¨æ¶ï¼ˆã€ä¿®æ­£ã€‘ä»‹é¢æ”¯æ´ Union é¡å‹ï¼‰</h4>
<pre><code class="language-python">import polars as pl
from typing import Union, Optional

class FeatureEngineer:
    def __init__(self, config: FeatureEngineeringConfig):
        self.config = config

    def transform(
        self, 
        df: Union[pl.DataFrame, pl.LazyFrame],  # ã€ä¿®æ­£ã€‘é ç•™ LazyFrame å½ˆæ€§
        cutoff_timestamp: Optional[datetime] = None
    ) -&gt; Union[pl.DataFrame, pl.LazyFrame]:
        &quot;&quot;&quot;
        ä¸»å…¥å£æ–¹æ³•

        V1.2 å¯¦ä½œé™åˆ¶ï¼š
        - è‹¥è¼¸å…¥ç‚º LazyFrameï¼Œåƒ…æ”¯æ´ã€Œè®€å–ã€æ“ä½œï¼Œå¯¦éš›é‹ç®—ä»ç‚º Eagerï¼ˆcollectï¼‰
        - V2.0 å¯æ“´å……ç‚ºå®Œæ•´ Streaming æ”¯æ´
        &quot;&quot;&quot;
        # è‹¥ç‚º LazyFrameï¼Œå…ˆ collectï¼ˆV1.2 é™åˆ¶ï¼‰
        # V2.0 æ™‚å¯ç§»é™¤æ­¤é™åˆ¶ï¼Œç›´æ¥å›å‚³ LazyFrame
        if isinstance(df, pl.LazyFrame):
            df = df.collect()

        # 1. è¼¸å…¥é©—è­‰ï¼ˆå«æ™‚é–“é€£çºŒæ€§æª¢æŸ¥ï¼‰
        df = self._validate_input(df)

        # 2. é˜² Data Leakage æª¢æŸ¥
        if cutoff_timestamp and df[&quot;timestamp&quot;].max() &gt; cutoff_timestamp:
            raise DataLeakageError(f&quot;Input contains future data after {cutoff_timestamp}&quot;)

        # 3. ä¾åºç”¢ç”Ÿç‰¹å¾µ
        df = self._generate_physics_features(df)
        df = self._generate_time_features(df)
        df = self._generate_stats_features(df)  # ã€é—œéµã€‘ä½¿ç”¨ shift(1) é˜² Data Leak

        return df
</code></pre>
<h3 id="phase-2">Phase 2: ç‰©ç†ç‰¹å¾µå¼•æ“</h3>
<h4 id="step-21">Step 2.1: ç‰©ç†å…¬å¼åº«ï¼ˆå¼·åŒ–é‚Šç•Œæª¢æŸ¥ï¼‰</h4>
<pre><code class="language-python"># src/utils/physics.py
def calculate_wet_bulb_temp(
    t_db: pl.Series,
    rh: pl.Series,
    pressure: pl.Series,
    temp_range: Tuple[float, float] = (-40, 60),
    rh_range: Tuple[float, float] = (0, 100)
) -&gt; pl.Series:
    &quot;&quot;&quot;è¨ˆç®—æ¿•çƒæº«åº¦ï¼Œç„¡æ•ˆå€¼å›å‚³ Null è€Œéæ‹‹å‡º&quot;&quot;&quot;
    valid_mask = (
        t_db.is_between(temp_range[0], temp_range[1]) &amp; 
        rh.is_between(rh_range[0], rh_range[1])
    )
    result = _ashrae_wet_bulb_formula(t_db, rh, pressure)
    return pl.when(valid_mask).then(result).otherwise(None)
</code></pre>
<h4 id="step-22-multi-asset">Step 2.2: è‡ªå‹•é…å° Multi-Asset æ¬„ä½</h4>
<pre><code class="language-python">def _generate_physics_features(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;è‡ªå‹•è­˜åˆ¥æº«åº¦/æ¿•åº¦æ¬„ä½é…å°ï¼Œæ”¯æ´å¤šå°è¨­å‚™&quot;&quot;&quot;
    # é€é feature_mapping è­˜åˆ¥æ‰€æœ‰ physical_type=temperature/humidity çš„æ¬„ä½
    temp_cols = [c for c in df.columns if get_meta(c).physical_type == &quot;temperature&quot;]
    rh_cols = [c for c in df.columns if get_meta(c).physical_type == &quot;humidity&quot;]

    # è‡ªå‹•é…å°ï¼ˆå‡è¨­å‘½åæ…£ä¾‹ï¼š{location}_temp / {location}_rhï¼‰
    for temp_col in temp_cols:
        location = temp_col.replace(&quot;_temp&quot;, &quot;&quot;)
        rh_col = f&quot;{location}_rh&quot;
        if rh_col in df.columns:
            df = df.with_columns([
                calculate_wet_bulb_temp(
                    pl.col(temp_col), 
                    pl.col(rh_col),
                    pl.lit(1013.25)  # é è¨­æ°£å£“
                ).alias(f&quot;{location}_wet_bulb_physics&quot;)
            ])
    return df
</code></pre>
<h3 id="phase-3-data-leakage">Phase 3: æ™‚é–“èˆ‡çµ±è¨ˆç‰¹å¾µï¼ˆã€é—œéµä¿®æ­£ã€‘é˜² Data Leakageï¼‰</h3>
<h4 id="step-31">Step 3.1: æ™‚é–“ç‰¹å¾µï¼ˆç¶­æŒä¸è®Šï¼‰</h4>
<pre><code class="language-python">def _generate_time_features(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    df = df.with_columns([
        pl.col(&quot;timestamp&quot;).dt.hour().alias(&quot;hour_time&quot;),
        pl.col(&quot;timestamp&quot;).dt.weekday().alias(&quot;day_of_week_time&quot;),
        (pl.col(&quot;timestamp&quot;).dt.weekday() &gt;= 5).alias(&quot;is_weekend_time&quot;),
        (2 * np.pi * pl.col(&quot;timestamp&quot;).dt.hour() / 24).sin().alias(&quot;hour_sin_time&quot;),
        (2 * np.pi * pl.col(&quot;timestamp&quot;).dt.hour() / 24).cos().alias(&quot;hour_cos_time&quot;),
    ])
    return df
</code></pre>
<h4 id="step-32-lag-rolling">Step 3.2: ã€ä¿®æ­£ã€‘Lag èˆ‡ Rollingï¼ˆå¼·åˆ¶æ’é™¤ç•¶å‰é»ï¼‰</h4>
<pre><code class="language-python">def _generate_stats_features(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    ã€é—œéµä¿®æ­£ã€‘æ‰€æœ‰ Rolling ç‰¹å¾µå¿…é ˆæ’é™¤ã€Œç•¶å‰æ™‚é–“é»ã€
    å¯¦ä½œæ–¹å¼ï¼šå…ˆ shift(1) å† rollingï¼Œç¢ºä¿åƒ…ä½¿ç”¨ã€Œéå»ã€è³‡æ–™
    &quot;&quot;&quot;
    # é€é Group Policy è§£æç›®æ¨™æ¬„ä½ï¼ˆæ”¯æ´ Multi-Assetï¼‰
    column_rules = self._resolve_group_policies(df)

    expressions = []

    for col, rules in column_rules.items():
        # Lag ç‰¹å¾µï¼ˆå»¶é²ï¼‰- æœ¬èº«å³ç‚ºéå»è³‡æ–™ï¼Œç„¡éœ€é¡å¤–é˜²è­·
        for lag in rules.lag_intervals:
            expressions.append(
                pl.col(col).shift(lag).alias(f&quot;{col}_lag_{lag}&quot;)
            )

        # ã€ä¿®æ­£ã€‘Rolling ç‰¹å¾µï¼šshift(1) ç¢ºä¿çª—å£å¾ã€Œä¸Šä¸€å€‹æ™‚é–“é»ã€é–‹å§‹
        for window in rules.rolling_windows:
            # å®‰å…¨æª¢æŸ¥ï¼šè¦–çª—ä¸å¾—è¶…éè³‡æ–™é•·åº¦ 50%
            if window &gt; len(df) * 0.5:
                logger.warning(f&quot;Skip rolling {window} for {col}: exceeds 50% data length&quot;)
                continue

            for agg in rules.aggregations:
                # ã€é—œéµã€‘å…ˆ shift(1) æ’é™¤ç•¶å‰é»ï¼Œå†åš rolling
                # é€™ç¢ºä¿ã€Œéå» 24 å°æ™‚ã€çœŸçš„ä¸åŒ…å«ã€Œç¾åœ¨ã€
                expr = (
                    pl.col(col)
                    .shift(1)  # ã€å¼·åˆ¶ã€‘å…ˆåç§»ï¼Œæ’é™¤ç•¶å‰é»
                    .rolling_mean(window) if agg == &quot;mean&quot; else
                    pl.col(col).shift(1).rolling_std(window) if agg == &quot;std&quot; else
                    pl.col(col).shift(1).rolling_min(window) if agg == &quot;min&quot; else
                    pl.col(col).shift(1).rolling_max(window)  # max
                )
                expressions.append(
                    expr.alias(f&quot;{col}_roll{agg}_{window}&quot;)
                )

    return df.with_columns(expressions)
</code></pre>
<h3 id="phase-4-quality-flags">Phase 4: Quality Flags è™•ç†ï¼ˆç¶­æŒä¸è®Šï¼‰</h3>
<pre><code class="language-python">def _handle_quality_flags(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    strategy = self.config.input_contract.quality_flags_handling

    if strategy == &quot;drop&quot;:
        has_flags = pl.col(&quot;quality_flags&quot;).list.len() &gt; 0
        return df.filter(~has_flags)
    elif strategy == &quot;onehot&quot;:
        all_flags = [&quot;FROZEN&quot;, &quot;HEAT_IMBALANCE&quot;, &quot;AFFINITY_VIOLATION&quot;, &quot;OUTLIER&quot;]
        for flag in all_flags:
            df = df.with_columns(
                pl.col(&quot;quality_flags&quot;).list.contains(flag).alias(f&quot;is_{flag.lower()}_flag&quot;)
            )
        return df
    else:  # ignore
        return df
</code></pre>
<hr />
<h2 id="4-data-leakage">4. é©—è­‰èˆ‡æ¸¬è©¦è¨ˆç•«ï¼ˆã€æ–°å¢ã€‘Data Leakage æ¸¬è©¦ï¼‰</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹</th>
<th style="text-align: left;">é©—è­‰å…§å®¹</th>
<th style="text-align: center;">é€šéæ¨™æº–</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Case A (Physics)</strong></td>
<td style="text-align: left;">æ¿•çƒæº«åº¦è¨ˆç®—æº–ç¢ºæ€§</td>
<td style="text-align: center;">èª¤å·® &lt; 0.1Â°C</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case B (Cyclical)</strong></td>
<td style="text-align: left;">æ™‚é–“é€±æœŸç·¨ç¢¼æ­£ç¢ºæ€§</td>
<td style="text-align: center;">23:00 èˆ‡ 01:00 å‘é‡è·é›¢ &lt; 0.5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case C (Temporal Leakage)</strong></td>
<td style="text-align: left;">Lag ä¸åŒ…å«æœªä¾†</td>
<td style="text-align: center;"><code>cutoff_timestamp</code> å¾Œè³‡æ–™è¢«æ’é™¤</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case D (Memory)</strong></td>
<td style="text-align: left;">å¤§è³‡æ–™é‡è™•ç†</td>
<td style="text-align: center;">è¨˜æ†¶é«” &lt; åŸå§‹è³‡æ–™ 150%</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case E (Idempotency)</strong></td>
<td style="text-align: left;">é‡è¤‡åŸ·è¡Œä¸€è‡´æ€§</td>
<td style="text-align: center;">Bit-wise ä¸€è‡´</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case F (Data Leakage - Rolling)</strong>ã€æ–°å¢ã€‘</td>
<td style="text-align: left;">Rolling ä¸åŒ…å«ç•¶å‰é»</td>
<td style="text-align: center;">å°æ–¼æ™‚é–“ Tï¼Œç‰¹å¾µå€¼åƒ…ä½¿ç”¨ T-1, T-2... è³‡æ–™</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case G (Multi-Asset)</strong>ã€æ–°å¢ã€‘</td>
<td style="text-align: left;">Group Policy è§£æ</td>
<td style="text-align: center;">3 å°å†°æ©Ÿè‡ªå‹•å¥—ç”¨ç›¸åŒè¦å‰‡ï¼Œconfig ç„¡éœ€é‡è¤‡</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case H (LazyFrame)</strong>ã€æ–°å¢ã€‘</td>
<td style="text-align: left;">ä»‹é¢ç›¸å®¹æ€§</td>
<td style="text-align: center;">è¼¸å…¥ LazyFrame ä¸æ‹‹å‡º TypeErrorï¼ˆé›–ç„¶æœƒ collectï¼‰</td>
</tr>
</tbody>
</table>
<h3 id="data-leakage">ã€æ–°å¢ã€‘Data Leakage æ¸¬è©¦ç¯„ä¾‹</h3>
<pre><code class="language-python">def test_rolling_no_data_leakage():
    &quot;&quot;&quot;é©—è­‰ Rolling ç‰¹å¾µä¸åŒ…å«ç•¶å‰æ™‚é–“é»&quot;&quot;&quot;
    # å»ºç«‹æ¸¬è©¦è³‡æ–™ï¼šæ™‚é–“åºåˆ— 1, 2, 3, 4, 5...
    df = pl.DataFrame({
        &quot;timestamp&quot;: pl.date_range(datetime(2024,1,1), datetime(2024,1,2), interval=&quot;1h&quot;),
        &quot;value&quot;: range(25)  # 0, 1, 2, ..., 24
    })

    config = FeatureEngineeringConfig(
        stats_features={
            &quot;group_policies&quot;: [{
                &quot;apply_to_types&quot;: [&quot;gauge&quot;],
                &quot;rules&quot;: {&quot;lag_intervals&quot;: [], &quot;rolling_windows&quot;: [3], &quot;aggregations&quot;: [&quot;mean&quot;]}
            }]
        }
    )

    engineer = FeatureEngineer(config)
    result = engineer.transform(df)

    # é©—è­‰ï¼šç¬¬ 3 å€‹æ™‚é–“é»ï¼ˆindex=2, value=2ï¼‰çš„ rolling_mean_3
    # è‹¥æ­£ç¢ºï¼ˆä¸å«ç•¶å‰é»ï¼‰ï¼šæ‡‰ç‚º (0 + 1) / 2 = 0.5ï¼ˆå› ç‚º shift(1) å¾Œçª—å£ç‚º [Null, 0, 1]ï¼‰
    # è‹¥éŒ¯èª¤ï¼ˆå«ç•¶å‰é»ï¼‰ï¼šæœƒæ˜¯ (0 + 1 + 2) / 3 = 1.0
    row_3 = result.filter(pl.col(&quot;timestamp&quot;) == datetime(2024,1,1,2,0)).to_dict()
    assert row_3[&quot;value_rollmean_3&quot;][0] == 0.5, &quot;Data Leakage detected! Rolling includes current point.&quot;
</code></pre>
<hr />
<h2 id="5">5. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£ï¼ˆæ›´æ–°ï¼‰</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢¨éšª</th>
<th style="text-align: center;">åš´é‡åº¦</th>
<th style="text-align: left;">ç·©è§£æªæ–½ï¼ˆV1.2 è¨­è¨ˆï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>ç¶­åº¦çˆ†ç‚¸</strong></td>
<td style="text-align: center;">ğŸ”´ Critical</td>
<td style="text-align: left;"><code>max_window_points: 1000</code> + Group Policy é›†ä¸­ç®¡ç†</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Temporal Leakage</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: left;"><strong>å¼·åˆ¶ <code>shift(1)</code> é‚è¼¯</strong>ï¼Œæ¸¬è©¦ Case F é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Streaming Mode æœªå®šç¾©</strong></td>
<td style="text-align: center;">ğŸŸ  Medium</td>
<td style="text-align: left;"><strong>æ˜ç¢ºè²æ˜ V1.2 åƒ…æ”¯æ´ In-Memory</strong>ï¼Œä»‹é¢é ç•™ LazyFrame</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Multi-Asset Config è†¨è„¹</strong></td>
<td style="text-align: center;">ğŸŸ  Medium</td>
<td style="text-align: left;"><strong>Group Policy</strong> ä»¥ <code>apply_to_types</code> å–ä»£é€ä¸€åˆ—èˆ‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Input Contract é•å</strong></td>
<td style="text-align: center;">ğŸŸ  Medium</td>
<td style="text-align: left;"><code>_validate_input()</code> åš´æ ¼æª¢æŸ¥</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç‰©ç†è¨ˆç®—é‚Šç•ŒéŒ¯èª¤</strong></td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: left;">ç„¡æ•ˆå€¼å›å‚³ Null</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-cleaner-prd">6. èˆ‡ Cleaner PRD çš„å”ä½œæª¢æŸ¥æ¸…å–®ï¼ˆæ›´æ–°ï¼‰</h2>
<p>åœ¨é–‹å§‹é–‹ç™¼å‰ï¼Œè«‹èˆ‡ Cleaner è² è²¬äººç¢ºèªï¼š</p>
<ul>
<li>[ ] Cleaner v2.0 è¼¸å‡ºæ˜¯å¦åŒ…å« <code>physical_type</code> ä¸­ç¹¼è³‡æ–™ï¼ˆä¾› Group Policy åŒ¹é…ï¼‰ï¼Ÿ</li>
<li>[ ] <code>quality_flags</code> æ ¼å¼æ˜¯å¦ç‚º <code>List[str]</code>ï¼Ÿ</li>
<li>[ ] å…©è€…çš„ <code>timestamp</code> æ˜¯å¦çš†ç‚º UTC ä¸”å°é½Šæ–¹å¼ä¸€è‡´ï¼ˆ<code>alignment: "left"</code>ï¼‰ï¼Ÿ</li>
<li>[ ] <strong>ã€æ–°å¢ã€‘</strong> Cleaner æ˜¯å¦ä¿è­‰è¼¸å‡ºã€Œç„¡æœªä¾†è³‡æ–™ã€ï¼Ÿï¼ˆFeature Engineer æœƒåšäºŒæ¬¡æª¢æŸ¥ï¼‰</li>
<li>[ ] <strong>ã€æ–°å¢ã€‘</strong> è‹¥æ¡ˆå ´æœ‰ 3 å°å†°æ©Ÿï¼Œæ¬„ä½å‘½åæ˜¯å¦éµå¾ª <code>{location}_{type}</code> æ…£ä¾‹ï¼ˆå¦‚ <code>chiller_1_load</code>ï¼‰ï¼Ÿ</li>
</ul>
<hr />
<h2 id="7">7. äº¤ä»˜ç”¢ç‰©æ¸…å–®</h2>
<ol>
<li><code>src/etl/feature_engineer.py</code>: æ ¸å¿ƒç¨‹å¼ç¢¼ï¼ˆå« <code>shift(1)</code> é˜²è­·èˆ‡ Group Policyï¼‰</li>
<li><code>src/etl/config_models.py</code>: æ›´æ–°é…ç½®æ¨¡å‹ï¼ˆ<code>GroupPolicy</code>, <code>StatsRule</code>ï¼‰</li>
<li><code>src/utils/physics.py</code>: ç‰©ç†å…¬å¼åº«ï¼ˆå«é‚Šç•Œæª¢æŸ¥ï¼‰</li>
<li><code>tests/test_feature_engineer.py</code>: å« Case F (Data Leakage) èˆ‡ Case G (Multi-Asset)</li>
<li><code>tests/test_data_leakage.py</code>: ã€æ–°å¢ã€‘å°ˆé–€é©—è­‰æ™‚åºæ­£ç¢ºæ€§çš„æ¸¬è©¦æª”æ¡ˆ</li>
<li><code>config/settings.yaml</code>: æ›´æ–°ç¯„æœ¬ï¼ˆç¤ºç¯„ Group Policy å¯«æ³•ï¼‰</li>
<li><code>docs/feature_engineering_guide.md</code>: æ›´æ–°èªªæ˜ï¼ˆå¼·èª¿ã€Œéå»è³‡æ–™-onlyã€åŸå‰‡ï¼‰</li>
</ol>
</body>
</html>