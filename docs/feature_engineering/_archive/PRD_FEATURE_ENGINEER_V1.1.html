
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Engineering PRD v1.1</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1, h2, h3 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h2 { margin-top: 2em; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #dfe2e5;
            padding: 12px;
            text-align: left;
        }
        th { background-color: #f6f8fa; font-weight: bold; }
        tr:nth-child(even) { background-color: #fdfdfd; }
        code {
            background-color: #f3f3f3;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 85%;
        }
        pre {
            background-color: #f6f8fa;
            padding: 16px;
            overflow: auto;
            border-radius: 6px;
        }
        blockquote {
            margin: 0;
            padding: 0 1em;
            color: #6a737d;
            border-left: 0.25em solid #dfe2e5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="prd-v11-feature-engineering-implementation-guide">PRD v1.1: ç‰¹å¾µå·¥ç¨‹å¼·å¥æ€§å¯¦ä½œæŒ‡å— (Feature Engineering Implementation Guide)</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.1<br />
<strong>æ—¥æœŸ:</strong> 2026-02-12<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/etl/feature_engineer.py</code> (New Module)<br />
<strong>ç›¸ä¾æ¨¡çµ„:</strong> <code>src/etl/cleaner.py</code> (v2.0+), <code>src/utils/physics.py</code><br />
<strong>é ä¼°å·¥æ™‚:</strong> 3 ~ 4 å€‹å·¥ç¨‹å¤©ï¼ˆå«æ•´åˆæ¸¬è©¦ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆåŸå‰‡</h2>
<h3 id="11">1.1 æ ¸å¿ƒè·è²¬</h3>
<p>æœ¬æ¨¡çµ„å°ˆæ³¨æ–¼ <strong>ã€ŒåŠ æ³•èˆ‡å‰µé€ ã€</strong>ï¼Œåš´æ ¼ç¦æ­¢åŸ·è¡Œè³‡æ–™æ¸…æ´—æˆ–éæ¿¾ã€‚æ‰€æœ‰è¼¸å…¥è³‡æ–™å¿…é ˆå…ˆç¶“é <code>DataCleaner</code> è™•ç†ã€‚</p>
<p><strong>è¨­è¨ˆåŸå‰‡ï¼š</strong>
1. <strong>é˜²ç¦¦å¼è¨­è¨ˆ</strong>ï¼šå³ä½¿ Cleaner è¼¸å‡ºç•°å¸¸ï¼ˆå« Nullã€ç©ºç¼ºï¼‰ï¼Œä»ä¸æ‹‹å‡ºè‡´å‘½éŒ¯èª¤
2. <strong>å†ªç­‰æ€§ (Idempotency)</strong>ï¼šç›¸åŒè¼¸å…¥åŸ·è¡Œå¤šæ¬¡ï¼Œè¼¸å‡ºå¿…é ˆå®Œå…¨ä¸€è‡´
3. <strong>è¨˜æ†¶é«”å®‰å…¨</strong>ï¼šç¦æ­¢ç”¢ç”Ÿç¶­åº¦çˆ†ç‚¸ç‰¹å¾µï¼Œå¼·åˆ¶é™åˆ¶ Rolling Window å¤§å°</p>
<h3 id="12-inputoutput-contract">1.2 è¼¸å…¥è¼¸å‡ºå¥‘ç´„ï¼ˆInput/Output Contractï¼‰</h3>
<pre><code class="language-python">class FeatureEngineerInputContract:
    &quot;&quot;&quot;
    Feature Engineer å°è¼¸å…¥è³‡æ–™çš„åš´æ ¼è¦æ±‚
    ç”± DataCleaner ä¿è­‰ï¼Œæˆ–ç”±æœ¬æ¨¡çµ„åœ¨ transform() é–‹é ­é©—è­‰
    &quot;&quot;&quot;
    required_columns: List[str] = [&quot;timestamp&quot;]  # å¿…é ˆåŒ…å«æ™‚é–“æˆ³æ¬„ä½
    expected_frequency: str = &quot;15min&quot;            # è³‡æ–™é »ç‡ï¼Œç”¨æ–¼é©—è­‰æ™‚é–“é€£çºŒæ€§
    timestamp_tz: str = &quot;UTC&quot;                    # å¼·åˆ¶ UTCï¼Œç¦æ­¢æ™‚å€è½‰æ›

    # èˆ‡ Cleaner çš„éŠœæ¥ç­–ç•¥
    quality_flags_handling: Literal[&quot;drop&quot;, &quot;onehot&quot;, &quot;ignore&quot;] = &quot;onehot&quot;
    # drop: åˆªé™¤æœ‰æ¨™è¨˜çš„åˆ—ï¼ˆä¿å®ˆï¼Œæå¤±è³‡æ–™ï¼‰
    # onehot: å°‡æ¨™è¨˜æ‹†è§£ç‚ºç‰¹å¾µï¼ˆæ¨è–¦ï¼Œä¿ç•™è³‡è¨Šï¼‰
    # ignore: å¿½ç•¥æ¨™è¨˜ï¼ˆå¿«é€Ÿï¼Œä½†å¯èƒ½å¼•å…¥é›œè¨Šï¼‰

class FeatureEngineerOutputContract:
    &quot;&quot;&quot;
    è¼¸å‡ºè³‡æ–™è¦æ ¼ä¿è­‰
    &quot;&quot;&quot;
    feature_naming_convention: str = &quot;{original_col}_{transformation}_{parameters}&quot;
    # ä¾‹ï¼šchiller_load_rollmean_96 (15åˆ†é˜è³‡æ–™ï¼Œ96é»=24å°æ™‚)
    null_strategy: str = &quot;propagate_with_flag&quot;   # Null å‚³æ’­ä½†æ¨™è¨˜ï¼Œä¸éš±è—
</code></pre>
<h3 id="13-in-scope-vs-out-of-scope">1.3 åŠŸèƒ½ç¯„åœ (In-Scope vs Out-of-Scope)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">ç¯„åœ</th>
<th style="text-align: left;">åŒ…å«é …ç›® (In-Scope)</th>
<th style="text-align: left;">æ’é™¤é …ç›® (Out-of-Scope)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>P1 ç‰©ç†ç‰¹å¾µ</strong></td>
<td style="text-align: left;">æ¿•çƒæº«åº¦ (Wet Bulb)ã€ç„“å€¼ (Enthalpy)<br>ï¼ˆå¾ Cleaner é·ç§»è‡³æ­¤ï¼‰</td>
<td style="text-align: left;">å–®ä½è½‰æ›ï¼ˆç”± Cleaner è™•ç†å¾Œè¼¸å…¥ SI åˆ¶ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>P1 æ™‚é–“ç‰¹å¾µ</strong></td>
<td style="text-align: left;">å°æ™‚ã€æ˜ŸæœŸã€å¹³å‡æ—¥<br>é€±æœŸæ€§ç·¨ç¢¼ (sin/cos)</td>
<td style="text-align: left;">ç¯€å‡æ—¥åˆ¤æ–·ï¼ˆéœ€å¤–éƒ¨æ—¥æ›† APIï¼Œè¶…å‡ºç¯„åœï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>P2 çµ±è¨ˆç‰¹å¾µ</strong></td>
<td style="text-align: left;">Lag ç‰¹å¾µ (å»¶é²)<br>Rolling çµ±è¨ˆï¼ˆå¹³å‡ã€æ¨™æº–å·®ã€æœ€å¤§/æœ€å°ï¼‰</td>
<td style="text-align: left;">è¤‡é›œçµ±è¨ˆï¼ˆå¦‚æŒ‡æ•¸åŠ æ¬Šç§»å‹•å¹³å‡ EWMï¼ŒP3 è€ƒæ…®ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>P3 äº’å‹•ç‰¹å¾µ</strong></td>
<td style="text-align: left;"><strong>Out-of-Scope for v1.1</strong><br>ï¼ˆä¿ç•™é…ç½®ä»‹é¢ä½†æ¨™è¨˜ç‚ºæœªå¯¦ä½œï¼‰</td>
<td style="text-align: left;">éç·šæ€§äº¤äº’é …ï¼ˆå¦‚ <code>Load^2</code>ã€<code>Load Ã— Temp</code>ï¼‰</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. ç³»çµ±æ¶æ§‹èˆ‡é…ç½®</h2>
<h3 id="21-cleaner-prd">2.1 èˆ‡ Cleaner PRD çš„æ•´åˆé…ç½®</h3>
<p>çµ±ä¸€é…ç½®æª”çµæ§‹ï¼ˆèˆ‡ Cleaner PRD å…±ç”¨ <code>etl_pipeline</code> å€å¡Šï¼‰ï¼š</p>
<pre><code class="language-yaml"># config/settings.yaml
etl_pipeline:
  cleaner:
    schema_version: &quot;2.0&quot;
    # ... Cleaner è¨­å®šï¼ˆè¦‹ Cleaner PRDï¼‰

  feature_engineer:
    schema_version: &quot;1.1&quot;

    # è¼¸å…¥å¥‘ç´„é©—è­‰
    input_contract:
      quality_flags_handling: &quot;onehot&quot;  # drop | onehot | ignore
      null_handling: &quot;propagate&quot;        # propagate | fail_fast

    # ç‰©ç†ç‰¹å¾µ
    physics_features:
      enabled: true
      library: &quot;psychrolib&quot;             # æˆ–è‡ªç ” ASHRAE å…¬å¼
      input_validation:
        temp_range: [-40, 60]           # Â°Cï¼Œè¶…å‡ºç¯„åœå›å‚³ Null
        rh_range: [0, 100]              # %ï¼Œè¶…å‡ºç¯„åœå›å‚³ Null
        pressure_default: 1013.25       # hPaï¼Œè‹¥è¼¸å…¥ç¼ºæ¼ä½¿ç”¨é è¨­å€¼

    # æ™‚é–“ç‰¹å¾µ
    time_features:
      enabled: true
      cyclical_encoding: true           # ç”¢ç”Ÿ sin/cos
      components: [&quot;hour&quot;, &quot;day_of_week&quot;, &quot;month&quot;, &quot;is_weekend&quot;]

    # çµ±è¨ˆç‰¹å¾µï¼ˆé—œéµï¼šé˜²ç¶­åº¦çˆ†ç‚¸ï¼‰
    stats_features:
      enabled: true
      lag_intervals: [1, 4]             # 1å€‹å€é–“, 4å€‹å€é–“ï¼ˆéçµ•å°æ™‚é–“ï¼‰
      rolling_windows: [4, 96]          # 4å€é–“(1h), 96å€é–“(24h) - ä»¥è³‡æ–™é»è¨ˆ
      max_rolling_window_points: 1000   # ã€å®‰å…¨é™åˆ¶ã€‘ç¦æ­¢è¶…é 1000 é»çš„è¦–çª—
      aggregations: [&quot;mean&quot;, &quot;std&quot;, &quot;min&quot;, &quot;max&quot;]

    # è¼¸å‡ºæ§åˆ¶
    output:
      drop_original_flags: false        # æ˜¯å¦åˆªé™¤è¼¸å…¥çš„ quality_flags æ¬„ä½
      add_feature_metadata: true        # æ˜¯å¦åŠ å…¥ feature_source ä¸­ç¹¼æ¬„ä½
</code></pre>
<h3 id="22-feature-mapping">2.2 Feature Mapping æ•´åˆ</h3>
<p><code>feature_mapping.py</code> éœ€æ“´å……ä»¥æ”¯æ´ç‰¹å¾µå·¥ç¨‹ï¼š</p>
<pre><code class="language-python">class FeatureMeta(BaseModel):
    # ç¹¼æ‰¿è‡ª Cleaner PRD çš„ ColumnMeta
    is_target: bool = False            # æ˜¯å¦ç‚ºç›®æ¨™è®Šæ•¸ï¼ˆä¸æ‡‰ç”¢ç”Ÿ Lagï¼‰
    enable_lag: bool = True            # æ˜¯å¦å…è¨±ç”¢ç”Ÿ Lag ç‰¹å¾µ
    enable_rolling: bool = True        # æ˜¯å¦å…è¨±ç”¢ç”Ÿ Rolling ç‰¹å¾µ

def get_features_for_engineering(site_config: dict) -&gt; List[FeatureMeta]:
    &quot;&quot;&quot;å›å‚³å…è¨±é€²è¡Œç‰¹å¾µå·¥ç¨‹çš„æ¬„ä½åˆ—è¡¨ï¼ˆæ’é™¤ IDã€ç‹€æ…‹ç¢¼ç­‰ï¼‰&quot;&quot;&quot;
    ...
</code></pre>
<hr />
<h2 id="3">3. åˆ†éšæ®µå¯¦ä½œè¨ˆç•«</h2>
<h3 id="phase-1-1">Phase 1: åŸºç¤æ¶æ§‹èˆ‡å®‰å…¨æ©Ÿåˆ¶ (é ä¼° 1 å¤©)</h3>
<h4 id="step-11">Step 1.1: å»ºç«‹é…ç½®æ¨¡å‹èˆ‡è¼¸å…¥é©—è­‰</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/config_models.py</code>ï¼ˆæ“´å……ï¼‰</p>
<pre><code class="language-python">from pydantic import BaseModel, validator

class StatsConfig(BaseModel):
    lag_intervals: List[int]
    rolling_windows: List[int]
    max_rolling_window_points: int = 1000

    @validator('rolling_windows')
    def check_window_size(cls, v):
        if any(x &gt; 1000 for x in v):
            raise ValueError(f&quot;Rolling window exceeds safety limit of 1000 points&quot;)
        return v

class FeatureEngineeringConfig(BaseModel):
    schema_version: Literal[&quot;1.1&quot;] = &quot;1.1&quot;
    input_contract: FeatureEngineerInputContract
    physics_features: PhysicsConfig
    time_features: TimeConfig
    stats_features: StatsConfig
</code></pre>
<h4 id="step-12">Step 1.2: å»ºç«‹æ¨¡çµ„éª¨æ¶èˆ‡é˜²ç¦¦æ©Ÿåˆ¶</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/feature_engineer.py</code></p>
<pre><code class="language-python">class FeatureEngineer:
    def __init__(self, config: FeatureEngineeringConfig):
        self.config = config
        self._validation_passed = False

    def _validate_input(self, df: pl.DataFrame) -&gt; pl.DataFrame:
        &quot;&quot;&quot;
        è¼¸å…¥é©—è­‰èˆ‡é è™•ç†ï¼š
        1. æª¢æŸ¥ required_columns å­˜åœ¨
        2. é©—è­‰æ™‚é–“æˆ³é€£çºŒæ€§ï¼ˆç„¡è·³èºæˆ–é‡è¤‡ï¼‰
        3. è™•ç† quality_flagsï¼ˆä¾ç­–ç•¥ drop/onehot/ignoreï¼‰
        4. è¨˜æ†¶é«”é æª¢ï¼ˆä¼°ç®—ç”¢ç”Ÿç‰¹å¾µå¾Œçš„è¨˜æ†¶é«”ä½¿ç”¨ï¼‰
        &quot;&quot;&quot;
        # æ™‚é–“é€£çºŒæ€§æª¢æŸ¥ï¼ˆé˜²æ­¢ Temporal Leakageï¼‰
        if self.config.input_contract.expected_frequency:
            # é©—è­‰é–“éš”æ˜¯å¦æ†å®š
            pass

    def transform(self, df: pl.DataFrame, cutoff_timestamp: Optional[datetime] = None) -&gt; pl.DataFrame:
        &quot;&quot;&quot;
        ä¸»å…¥å£æ–¹æ³•

        Args:
            cutoff_timestamp: ã€é˜²è³‡æ–™æ´©æ¼ã€‘ç¢ºä¿æ‰€æœ‰ç‰¹å¾µè¨ˆç®—ä¸ä½¿ç”¨æ­¤æ™‚é–“é»ä¹‹å¾Œçš„è³‡æ–™
                              ç”¨æ–¼è¨“ç·´/æ¨è«–åˆ†é›¢å ´æ™¯
        &quot;&quot;&quot;
        # 1. è¼¸å…¥é©—è­‰
        df = self._validate_input(df)

        # 2. é˜²è³‡æ–™æ´©æ¼æª¢æŸ¥
        if cutoff_timestamp and df[&quot;timestamp&quot;].max() &gt; cutoff_timestamp:
            raise DataLeakageError(f&quot;Input contains data after cutoff {cutoff_timestamp}&quot;)

        # 3. ä¾åºç”¢ç”Ÿç‰¹å¾µï¼ˆé †åºå¾ˆé‡è¦ï¼‰
        df = self._generate_physics_features(df)
        df = self._generate_time_features(df)
        df = self._generate_stats_features(df)  # å¿…é ˆåœ¨æœ€å¾Œï¼Œå› ç‚ºä¾è³´å‰é¢ç”¢ç”Ÿçš„ç‰¹å¾µ

        return df
</code></pre>
<h3 id="phase-2-1">Phase 2: ç‰©ç†ç‰¹å¾µå¼•æ“ (é ä¼° 1 å¤©)</h3>
<h4 id="step-21">Step 2.1: å»ºç«‹ç¨ç«‹ç‰©ç†å…¬å¼åº«</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/utils/physics.py</code>ï¼ˆå¾ Cleaner é·ç§»ä¸¦å¼·åŒ–ï¼‰</p>
<pre><code class="language-python">import polars as pl

def calculate_wet_bulb_temp(
    t_db: pl.Series,      # ä¹¾çƒæº«åº¦ (Â°C)
    rh: pl.Series,        # ç›¸å°æ¿•åº¦ (%)
    pressure: pl.Series,  # å¤§æ°£å£“ (hPa)
    temp_range: Tuple[float, float] = (-40, 60),
    rh_range: Tuple[float, float] = (0, 100)
+) -&gt; pl.Series:
    &quot;&quot;&quot;
    è¨ˆç®—æ¿•çƒæº«åº¦ (Wet Bulb Temperature)

    é‚Šç•Œè™•ç†ï¼š
    - è¼¸å…¥è¶…å‡ºç‰©ç†ç¯„åœæ™‚å›å‚³ Nullï¼ˆéæ‹‹å‡ºä¾‹å¤–ï¼‰
    - ä½¿ç”¨ ASHRAE æ¨™æº–å…¬å¼æˆ– psychrolib
    &quot;&quot;&quot;
    # é‚Šç•Œæª¢æŸ¥
    valid_mask = (
        t_db.is_between(temp_range[0], temp_range[1]) &amp; 
        rh.is_between(rh_range[0], rh_range[1])
    )

    # è¨ˆç®—ï¼ˆå‘é‡åŒ–ï¼‰
    result = _ashrae_wet_bulb_formula(t_db, rh, pressure)

    # ç„¡æ•ˆå€¼ä¿è­·
    return pl.when(valid_mask).then(result).otherwise(None)

def calculate_enthalpy(t_db: pl.Series, w: pl.Series) -&gt; pl.Series:
    &quot;&quot;&quot;è¨ˆç®—ç„“å€¼ (kJ/kg)ï¼Œè¼¸å…¥ï¼šæº«åº¦(Â°C)ã€å«æ¿•é‡(kg/kg)&quot;&quot;&quot;
    ...
</code></pre>
<h4 id="step-22">Step 2.2: å¯¦ä½œç‰©ç†ç‰¹å¾µè½‰æ›å±¤</h4>
<p><strong>é‚è¼¯</strong>:
- å¾ <code>feature_mapping</code> è­˜åˆ¥ <code>physical_type</code> ç‚º <code>temperature</code> èˆ‡ <code>humidity</code> çš„æ¬„ä½å°
- è‡ªå‹•é…å°è¨ˆç®—ï¼ˆå¦‚ <code>dry_bulb_temp_ch1</code> + <code>relative_humidity_ch1</code> â†’ <code>wet_bulb_temp_ch1</code>ï¼‰
- <strong>å‘½åè¦ç¯„</strong>: <code>{location}_wet_bulb_temp_physics</code>, <code>{location}_enthalpy_physics</code></p>
<h3 id="phase-3-15">Phase 3: æ™‚é–“èˆ‡çµ±è¨ˆç‰¹å¾µ (é ä¼° 1.5 å¤©)</h3>
<h4 id="step-31">Step 3.1: æ™‚é–“ç‰¹å¾µèˆ‡é€±æœŸæ€§ç·¨ç¢¼</h4>
<pre><code class="language-python">def _generate_time_features(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;ç”¢ç”Ÿæ™‚é–“ç‰¹å¾µèˆ‡é€±æœŸæ€§ç·¨ç¢¼&quot;&quot;&quot;
    # åŸºç¤æ™‚é–“å…ƒä»¶
    df = df.with_columns([
        pl.col(&quot;timestamp&quot;).dt.hour().alias(&quot;hour_time&quot;),
        pl.col(&quot;timestamp&quot;).dt.weekday().alias(&quot;day_of_week_time&quot;),
        pl.col(&quot;timestamp&quot;).dt.month().alias(&quot;month_time&quot;),
        (pl.col(&quot;timestamp&quot;).dt.weekday() &gt;= 5).alias(&quot;is_weekend_time&quot;)
    ])

    # é€±æœŸæ€§ç·¨ç¢¼ï¼ˆè§£æ±º 23:00 èˆ‡ 00:00 è·é›¢å•é¡Œï¼‰
    if self.config.time_features.cyclical_encoding:
        df = df.with_columns([
            (2 * np.pi * pl.col(&quot;hour_time&quot;) / 24).sin().alias(&quot;hour_sin_time&quot;),
            (2 * np.pi * pl.col(&quot;hour_time&quot;) / 24).cos().alias(&quot;hour_cos_time&quot;),
            (2 * np.pi * pl.col(&quot;day_of_week_time&quot;) / 7).sin().alias(&quot;dow_sin_time&quot;),
            (2 * np.pi * pl.col(&quot;day_of_week_time&quot;) / 7).cos().alias(&quot;dow_cos_time&quot;)
        ])

    return df
</code></pre>
<h4 id="step-32-lag-rolling">Step 3.2: Lag èˆ‡ Rolling ç‰¹å¾µï¼ˆå«å®‰å…¨æ©Ÿåˆ¶ï¼‰</h4>
<pre><code class="language-python">def _generate_stats_features(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    ç”¢ç”Ÿçµ±è¨ˆç‰¹å¾µï¼Œåš´æ ¼éµå®ˆè¨˜æ†¶é«”å®‰å…¨é™åˆ¶
    &quot;&quot;&quot;
    # å–å¾—å¯é€²è¡Œçµ±è¨ˆé‹ç®—çš„æ•¸å€¼æ¬„ä½ï¼ˆæ’é™¤ timestamp, quality_flags ç­‰ï¼‰
    numeric_cols = [
        c for c in df.columns 
        if get_feature_meta(c).enable_lag or get_feature_meta(c).enable_rolling
    ]

    expressions = []

    # Lag ç‰¹å¾µï¼ˆå»¶é²ï¼‰
    for col in numeric_cols:
        for lag in self.config.stats_features.lag_intervals:
            expressions.append(
                pl.col(col).shift(lag).alias(f&quot;{col}_lag_{lag}&quot;)
            )

    # Rolling ç‰¹å¾µï¼ˆæ»¾å‹•çµ±è¨ˆï¼‰
    for col in numeric_cols:
        for window in self.config.stats_features.rolling_windows:
            # å®‰å…¨æª¢æŸ¥ï¼šè¦–çª—å¤§å°ä¸å¾—è¶…éè³‡æ–™é•·åº¦çš„ 50%
            if window &gt; len(df) * 0.5:
                logger.warning(f&quot;Skipping rolling window {window} for {col}: exceeds 50% of data length&quot;)
                continue

            for agg in self.config.stats_features.aggregations:
                expr = getattr(pl.col(col).rolling_mean(window), agg)()
                expressions.append(
                    expr.alias(f&quot;{col}_roll{agg}_{window}&quot;)
                )

    return df.with_columns(expressions)
</code></pre>
<h3 id="phase-4-quality-flags">Phase 4: Quality Flags è™•ç†ç­–ç•¥</h3>
<p>ä¾æ“š <code>input_contract.quality_flags_handling</code> åŸ·è¡Œï¼š</p>
<pre><code class="language-python">def _handle_quality_flags(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    strategy = self.config.input_contract.quality_flags_handling

    if strategy == &quot;drop&quot;:
        # åˆªé™¤ä»»ä½•æœ‰æ¨™è¨˜çš„åˆ—ï¼ˆä¿å®ˆç­–ç•¥ï¼‰
        has_flags = pl.col(&quot;quality_flags&quot;).list.len() &gt; 0
        return df.filter(~has_flags)

    elif strategy == &quot;onehot&quot;:
        # å°‡æ¨™è¨˜æ‹†è§£ç‚º One-Hot ç‰¹å¾µï¼ˆæ¨è–¦ï¼Œä¿ç•™è³‡è¨Šä¾›æ¨¡å‹å­¸ç¿’ï¼‰
        all_flags = [&quot;FROZEN&quot;, &quot;HEAT_IMBALANCE&quot;, &quot;AFFINITY_VIOLATION&quot;, &quot;OUTLIER&quot;]
        for flag in all_flags:
            df = df.with_columns(
                pl.col(&quot;quality_flags&quot;).list.contains(flag).alias(f&quot;is_{flag.lower()}_flag&quot;)
            )
        return df

    elif strategy == &quot;ignore&quot;:
        # å¿½ç•¥ï¼Œä¸è™•ç†ï¼ˆå¿«é€Ÿä½†ä¸å»ºè­°ï¼‰
        return df
</code></pre>
<hr />
<h2 id="4">4. é©—è­‰èˆ‡æ¸¬è©¦è¨ˆç•«</h2>
<h3 id="41">4.1 å–®å…ƒæ¸¬è©¦ï¼ˆå¼·åŒ–ç‰ˆï¼‰</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹</th>
<th style="text-align: left;">é©—è­‰å…§å®¹</th>
<th style="text-align: center;">é€šéæ¨™æº–</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Case A (Physics Accuracy)</strong></td>
<td style="text-align: left;">è¼¸å…¥ 30Â°C / 50% RHï¼Œé©—è­‰æ¿•çƒæº«åº¦è¨ˆç®—</td>
<td style="text-align: center;">èª¤å·® &lt; 0.1Â°Cï¼ˆèˆ‡ ASHRAE è¡¨æ ¼æ¯”å°ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case B (Cyclical Encoding)</strong></td>
<td style="text-align: left;">é©—è­‰ 23:00 çš„ <code>hour_sin/cos</code> èˆ‡ 01:00 æ˜¯å¦é„°è¿‘</td>
<td style="text-align: center;">å‘é‡è·é›¢ &lt; 0.5ï¼ˆcos/sin å¹³é¢è·é›¢ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case C (Temporal Leakage)</strong></td>
<td style="text-align: left;">é©—è­‰ Lag ç‰¹å¾µæœªåƒç…§æœªä¾†è³‡æ–™</td>
<td style="text-align: center;"><code>cutoff_timestamp</code> å¾Œçš„è³‡æ–™è¢«æ­£ç¢ºæ’é™¤</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case D (Memory Safety)</strong></td>
<td style="text-align: left;">æ¸¬è©¦ 100 è¬ç­†è³‡æ–™ + å¤§è¦–çª— Rolling</td>
<td style="text-align: center;">è¨˜æ†¶é«”å³°å€¼ &lt; åŸå§‹ DataFrame çš„ 150%</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case E (Temporal Integrity)</strong></td>
<td style="text-align: left;">æ¸¬è©¦æ™‚é–“åºåˆ—æœ‰ç¼ºå¤±æ™‚ Lag è¡Œç‚º</td>
<td style="text-align: center;">ç©ºç¼ºè™•æ­£ç¢ºæ¨™è¨˜ç‚º Nullï¼Œç„¡éŒ¯èª¤å°é½Š</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case F (Idempotency)</strong></td>
<td style="text-align: left;">åŒä¸€æ‰¹è³‡æ–™åŸ·è¡Œå…©æ¬¡ <code>transform()</code></td>
<td style="text-align: center;">çµæœ Bit-wise å®Œå…¨ä¸€è‡´</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case G (Null Propagation)</strong></td>
<td style="text-align: left;">è¼¸å…¥å« Nullï¼Œé©—è­‰ç‰¹å¾µè¨ˆç®—è¡Œç‚º</td>
<td style="text-align: center;">Null ä¸å‚³æ’­ï¼ˆé™¤ä¾è³´ Null çš„ç‰¹å¾µå¤–ï¼‰ï¼Œä¸”ä¸æ‹‹å‡ºä¾‹å¤–</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Case H (Quality Flags One-Hot)</strong></td>
<td style="text-align: left;">é©—è­‰ quality_flags æ‹†è§£æ­£ç¢º</td>
<td style="text-align: center;"><code>is_frozen_flag</code> ç­‰æ¬„ä½æ­£ç¢ºæ¨™è¨˜ 0/1</td>
</tr>
</tbody>
</table>
<h3 id="42">4.2 æ•´åˆé©—è­‰</h3>
<ul>
<li><strong>èˆ‡ Cleaner v2.0 æ•´åˆ</strong>ï¼šä½¿ç”¨ Cleaner è¼¸å‡ºï¼ˆå« <code>quality_flags</code>ï¼‰ä½œç‚ºè¼¸å…¥ï¼Œé©—è­‰æ•´æ¢ Pipeline è¨˜æ†¶é«”ä½¿ç”¨ &lt; 8GBï¼ˆCleaner 4GB + Feature Engineer 4GBï¼‰</li>
<li><strong>èˆ‡ Model éŠœæ¥</strong>ï¼šé©—è­‰ç”¢ç”Ÿçš„ç‰¹å¾µçŸ©é™£å¯è¢« XGBoost ç›´æ¥è®€å–ï¼ˆç„¡ Nullã€ç„¡ç„¡é™å€¼ã€ç„¡å­—ä¸²æ¬„ä½æ®˜ç•™ï¼‰</li>
</ul>
<hr />
<h2 id="5">5. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢¨éšª</th>
<th style="text-align: center;">åš´é‡åº¦</th>
<th style="text-align: left;">ç·©è§£æªæ–½ï¼ˆå·²æ•´åˆè‡³è¨­è¨ˆï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>ç¶­åº¦çˆ†ç‚¸ (Feature Explosion)</strong></td>
<td style="text-align: center;">ğŸ”´ Critical</td>
<td style="text-align: left;"><code>max_rolling_window_points: 1000</code> å¼·åˆ¶é™åˆ¶ï¼Œè¶…éæ‹‹å‡º <code>ConfigurationError</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Temporal Leakage</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: left;">æ™‚é–“é€£çºŒæ€§é©—è­‰ + <code>cutoff_timestamp</code> é˜²è­·æ©Ÿåˆ¶</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è¨˜æ†¶é«” OOM</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: left;">è¨˜æ†¶é«”é æª¢ï¼ˆPre-flight checkï¼‰ï¼Œä¼°ç®—è¶…é 150% åŸå§‹è³‡æ–™æ™‚æ”¹ç”¨ Streaming Mode</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Input Contract é•å</strong></td>
<td style="text-align: center;">ğŸŸ  High</td>
<td style="text-align: left;"><code>_validate_input()</code> åš´æ ¼æª¢æŸ¥ï¼Œé•åæ™‚æ‹‹å‡ºæ˜ç¢ºéŒ¯èª¤è¨Šæ¯ï¼ˆè€Œéç¥ç§˜å´©æ½°ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç‰©ç†è¨ˆç®—é‚Šç•ŒéŒ¯èª¤</strong></td>
<td style="text-align: center;">ğŸŸ  Medium</td>
<td style="text-align: left;">ç„¡æ•ˆå€¼å›å‚³ Nullï¼ˆéæ‹‹å‡ºä¾‹å¤–ï¼‰ï¼Œé¿å…æ•´æ‰¹å¤±æ•—</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç‰¹å¾µå‘½åè¡çª</strong></td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: left;">åš´æ ¼å‘½åè¦ç¯„ <code>{col}_{transform}_{param}</code>ï¼Œè‹¥æ¬„ä½å·²å­˜åœ¨å‰‡æ‹‹å‡º <code>DuplicateFeatureError</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6">6. äº¤ä»˜ç”¢ç‰©æ¸…å–®</h2>
<ol>
<li><code>src/etl/feature_engineer.py</code>: æ ¸å¿ƒç¨‹å¼ç¢¼ï¼ˆå«é˜²ç¦¦æ©Ÿåˆ¶èˆ‡é©—è­‰ï¼‰</li>
<li><code>src/etl/config_models.py</code>: æ“´å……çš„ Pydantic é…ç½®æ¨¡å‹ï¼ˆèˆ‡ Cleaner PRD å…±ç”¨ï¼‰</li>
<li><code>src/utils/physics.py</code>: ç¨ç«‹ç‰©ç†å…¬å¼åº«ï¼ˆå¾ Cleaner é·ç§»ï¼Œå«é‚Šç•Œæª¢æŸ¥ï¼‰</li>
<li><code>tests/test_feature_engineer.py</code>: æ¶µè“‹ Case A~H çš„å®Œæ•´æ¸¬è©¦</li>
<li><code>tests/test_physics_utils.py</code>: ç‰©ç†å…¬å¼æº–ç¢ºæ€§æ¸¬è©¦ï¼ˆèˆ‡ ASHRAE æ¨™æº–å€¼æ¯”å°ï¼‰</li>
<li><code>config/settings.yaml</code>: æ›´æ–°ç¯„æœ¬ï¼ˆå« <code>etl_pipeline.feature_engineer</code> å€å¡Šï¼‰</li>
<li><code>docs/feature_engineering_guide.md</code>: çµ¦ Data Scientist çš„ä½¿ç”¨æŒ‡å—ï¼ˆå¦‚ä½•é…ç½® Lag/Rollingï¼‰</li>
</ol>
<hr />
<h2 id="7-cleaner-prd">7. èˆ‡ Cleaner PRD çš„å”ä½œæª¢æŸ¥æ¸…å–®</h2>
<p>åœ¨é–‹å§‹ Phase 2ï¼ˆç‰©ç†ç‰¹å¾µï¼‰å‰ï¼Œè«‹èˆ‡ Cleaner è² è²¬äººç¢ºèªï¼š</p>
<ul>
<li>[ ] Cleaner v2.0 è¼¸å‡ºæ˜¯å¦ä¿è­‰ <code>timestamp</code> æ¬„ä½å­˜åœ¨ä¸”ç‚º UTCï¼Ÿ</li>
<li>[ ] <code>quality_flags</code> æ¬„ä½æ ¼å¼æ˜¯å¦ç‚º <code>List[str]</code>ï¼ˆPolars <code>pl.List(pl.Utf8)</code>ï¼‰ï¼Ÿ</li>
<li>[ ] Cleaner çš„ <code>fill_strategy</code> æ˜¯å¦æœƒç”¢ç”Ÿæ™‚é–“ç©ºç¼ºï¼Ÿè‹¥æœ‰ï¼ŒFeature Engineer æ‡‰å¦‚ä½•è™•ç†ï¼ˆ<code>upsample</code> æˆ–ä¿ç•™ Nullï¼‰ï¼Ÿ</li>
<li>[ ] å…©è€…çš„ <code>settings.yaml</code> é…ç½®è·¯å¾‘æ˜¯å¦ä¸€è‡´ï¼ˆ<code>etl_pipeline.cleaner</code> + <code>etl_pipeline.feature_engineer</code>ï¼‰ï¼Ÿ</li>
<li>[ ] è¨˜æ†¶é«”é ç®—å¦‚ä½•åˆ†é…ï¼Ÿå»ºè­° Cleaner:Feature Engineer = 4GB:4GBï¼Œç¸½è¨ˆ 8GB ä¸Šé™</li>
</ul>
<hr />
<p><strong>å¯©é–±é‡é»</strong>ï¼šè«‹ç‰¹åˆ¥ç¢ºèª <strong>Step 3.2 çš„ Rolling Window å®‰å…¨é™åˆ¶</strong> èˆ‡ <strong>Quality Flags è™•ç†ç­–ç•¥</strong> æ˜¯å¦ç¬¦åˆä¸‹æ¸¸ XGBoost æ¨¡å‹çš„æœŸæœ›ï¼ˆæ˜¯å¦éœ€è¦ <code>is_frozen</code> ä½œç‚ºç‰¹å¾µï¼Œé‚„æ˜¯ç›´æ¥ä¸Ÿæ£„ç•°å¸¸è³‡æ–™ï¼‰ã€‚</p>
    </div>
</body>
</html>
