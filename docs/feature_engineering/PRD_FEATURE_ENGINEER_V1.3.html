<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_FEATURE_ENGINEER_V1.3</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v13-feature-engineering-implementation-guide">PRD v1.3: ç‰¹å¾µå·¥ç¨‹å¼·å¥æ€§å¯¦ä½œæŒ‡å— (Feature Engineering Implementation Guide)</h1>
<h1 id="feature-annotation-v12metadata-group-policy">æ•´åˆ Feature Annotation v1.2ï¼šMetadata æ¶ˆè²»èˆ‡ Group Policy é‡æ§‹</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.3-FA (Feature Annotation Consumption &amp; Device Role Awareness)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/etl/feature_engineer.py</code> (v1.3+)<br />
<strong>ä¸Šæ¸¸å¥‘ç´„:</strong> <code>src/etl/batch_processor.py</code> (v1.3-FA+, æª¢æŸ¥é» #3)<br />
<strong>ä¸‹æ¸¸å¥‘ç´„:</strong> <code>src/modeling/training_pipeline.py</code> (v1.0+, è¼¸å‡ºæª¢æŸ¥é»)<br />
<strong>é—œéµç›¸ä¾:</strong> <code>src/features/annotation_manager.py</code> (v1.2+, æä¾› device_role èˆ‡ ignore_warnings æŸ¥è©¢)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 5 ~ 6 å€‹å·¥ç¨‹å¤©ï¼ˆå« Annotation æ•´åˆèˆ‡ Group Policy é‡æ§‹ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆå“²å­¸</h2>
<h3 id="11-v12-v13-fa">1.1 ç‰ˆæœ¬è®Šæ›´ç¸½è¦½ (v1.2 â†’ v1.3-FA)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">è®Šæ›´é¡åˆ¥</th>
<th style="text-align: left;">v1.2 ç‹€æ…‹</th>
<th style="text-align: left;">v1.3-FA ä¿®æ­£</th>
<th style="text-align: center;">å½±éŸ¿å±¤ç´š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Metadata ä¾†æº</strong></td>
<td style="text-align: left;">ä¾è³´ <code>get_feature_meta()</code> (é‡æ–°æ¢æ¸¬)</td>
<td style="text-align: left;"><strong>å¾ Manifest æ¥æ”¶</strong> <code>feature_metadata</code> (ç‰©ç†å±¬æ€§) + <strong>ç›´æ¥æŸ¥è©¢</strong> Annotation (device_role)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role æ¶ˆè²»</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><strong>ç›´æ¥è®€å–</strong> FeatureAnnotationManager (Cleaner ä¸å‚³éï¼Œè·è²¬åˆ†é›¢)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Group Policy æ›´æ–°</strong></td>
<td style="text-align: left;">ä½¿ç”¨æ¨æ–·çš„ physical_type</td>
<td style="text-align: left;"><strong>ä½¿ç”¨ Annotation SSOT</strong> çš„ physical_type èˆ‡ device_role</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ignore_warnings</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><strong>æŸ¥è©¢ Annotation</strong> æ±ºå®šæ˜¯å¦æŠ‘åˆ¶ç‰¹å®šè­¦å‘Š (W403)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Flags ç¡¬ç·¨ç¢¼</strong></td>
<td style="text-align: left;">Step 3.2 ç¡¬ç·¨ç¢¼ flags</td>
<td style="text-align: left;"><strong>å¼·åˆ¶å¼•ç”¨</strong> <code>VALID_QUALITY_FLAGS</code> (SSOT)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç¨½æ ¸è»Œè·¡</strong></td>
<td style="text-align: left;">ç„¡ç‰ˆæœ¬è¨˜éŒ„</td>
<td style="text-align: left;"><strong>é©—è­‰</strong> <code>annotation_audit_trail</code> (schema_version, inheritance_chain)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Leakage</strong></td>
<td style="text-align: left;"><code>shift(1)</code> é˜²è­·</td>
<td style="text-align: left;"><strong>ä¿ç•™</strong> <code>shift(1)</code> + <code>cutoff_timestamp</code> åš´æ ¼æª¢æŸ¥</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 æ ¸å¿ƒè¨­è¨ˆåŸå‰‡</h3>
<ol>
<li><strong>SSOT åš´æ ¼éµå®ˆ</strong>: æ‰€æœ‰ quality flags æ“ä½œå¼•ç”¨ <code>VALID_QUALITY_FLAGS</code>ï¼›æ‰€æœ‰ physical_type èˆ‡ device_role æ±ºç­–å¼•ç”¨ FeatureAnnotationManager</li>
<li><strong>Metadata åˆ†å±¤æ¶ˆè²»</strong>:<br />
   - <strong>ç‰©ç†å±¬æ€§</strong> (physical_type, unit)ï¼šå¾ BatchProcessor Manifest çš„ <code>feature_metadata</code> è®€å–<br />
   - <strong>è¨­å‚™è§’è‰²</strong> (device_role, ignore_warnings)ï¼šç›´æ¥æŸ¥è©¢ FeatureAnnotationManager (YAML SSOT)</li>
<li><strong>è·è²¬åˆ†é›¢å°Šé‡</strong>: ä¸æœŸå¾… Cleaner/BatchProcessor å‚³é device_roleï¼Œä¸»å‹•å¾ Annotation å±¤æŸ¥è©¢</li>
<li><strong>Group Policy èªæ„æ„ŸçŸ¥</strong>: æ ¹æ“š device_role (primary/backup/seasonal) èª¿æ•´çµ±è¨ˆç‰¹å¾µç”Ÿæˆç­–ç•¥ï¼ˆå¦‚å‚™ç”¨è¨­å‚™ä½¿ç”¨ä¸åŒçª—å£ï¼‰</li>
<li><strong>ç¹¼æ‰¿éˆç›¸å®¹</strong>: æ­£ç¢ºè™•ç† <code>inheritance_chain</code>ï¼Œæ”¯æ´ base â†’ site çš„è¨­å®šè¦†è“‹</li>
</ol>
<hr />
<h2 id="2-interface-contracts">2. ä»‹é¢å¥‘ç´„è¦ç¯„ (Interface Contracts)</h2>
<h3 id="21-input-contract-from-batchprocessor-v13-fa">2.1 è¼¸å…¥å¥‘ç´„ (Input Contract from BatchProcessor v1.3-FA)</h3>
<p><strong>æª¢æŸ¥é» #3: BatchProcessor â†’ Feature Engineer</strong></p>
<pre><code class="language-python"># æ¨™æº–è®€å–ç¯„ä¾‹ (å¿…é ˆå¯¦ä½œ)
def load_from_batch_processor(manifest_path: Path) -&gt; Tuple[pl.LazyFrame, Dict, Dict]:
    &quot;&quot;&quot;
    Returns:
        df: LazyFrame (Parquet è³‡æ–™ï¼ŒINT64/UTC é©—è­‰é€šéï¼Œä¸å« device_role)
        feature_metadata: Dict (column_name -&gt; physical_type/unitï¼Œä¸å« device_role)
        annotation_audit_trail: Dict (schema_version, inheritance_chain, yaml_checksum)
    &quot;&quot;&quot;
    manifest = Manifest.parse_file(manifest_path)

    # 1. é©—è­‰ Manifest å®Œæ•´æ€§ (E301)
    if not manifest.validate_checksum():
        raise ContractViolationError(&quot;E301: Manifest ææ¯€&quot;)

    # 2. ã€æ–°å¢ã€‘é©—è­‰ Annotation ç¨½æ ¸è»Œè·¡ (E400)
    audit = manifest.annotation_audit_trail
    if audit:
        expected_ver = FEATURE_ANNOTATION_CONSTANTS['expected_schema_version']
        if audit.get('schema_version') != expected_ver:
            raise ConfigurationError(
                f&quot;E400: Manifest çš„ Annotation ç‰ˆæœ¬éèˆŠ &quot;
                f&quot;({audit.get('schema_version')} vs {expected_ver})&quot;
            )

    # 3. è®€å–è³‡æ–™èˆ‡ Metadata
    files = [manifest_path.parent / f for f in manifest.output_files]
    df = pl.scan_parquet(files)

    return (
        df, 
        manifest.feature_metadata,  # åƒ…å«ç‰©ç†å±¬æ€§
        audit  # ç¨½æ ¸è³‡è¨Š
    )
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: left;">æª¢æŸ¥é …</th>
<th style="text-align: left;">è¦ç¯„</th>
<th style="text-align: center;">éŒ¯èª¤ä»£ç¢¼</th>
<th style="text-align: left;">è™•ç†</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Manifest å®Œæ•´æ€§</td>
<td style="text-align: left;"><code>checksum</code> é©—è­‰é€šé</td>
<td style="text-align: center;">E301</td>
<td style="text-align: left;">æ‹’çµ•è®€å–</td>
</tr>
<tr>
<td style="text-align: left;">Annotation ç‰ˆæœ¬</td>
<td style="text-align: left;"><code>schema_version</code> ç¬¦åˆ SSOT</td>
<td style="text-align: center;">E400</td>
<td style="text-align: left;">çµ‚æ­¢æµç¨‹</td>
</tr>
<tr>
<td style="text-align: left;">timestamp æ ¼å¼</td>
<td style="text-align: left;"><code>INT64</code>, <code>nanoseconds</code>, <code>UTC</code></td>
<td style="text-align: center;">E302</td>
<td style="text-align: left;">æ‹’çµ•è®€å–</td>
</tr>
<tr>
<td style="text-align: left;">quality_flags å€¼</td>
<td style="text-align: left;">âŠ† <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: center;">E303</td>
<td style="text-align: left;">æ‹’çµ•è®€å–</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role æ¬„ä½</strong></td>
<td style="text-align: left;"><strong>ç¦æ­¢å­˜åœ¨æ–¼ DataFrame</strong></td>
<td style="text-align: center;">E500</td>
<td style="text-align: left;">çµ‚æ­¢æµç¨‹</td>
</tr>
<tr>
<td style="text-align: left;">feature_metadata</td>
<td style="text-align: left;">éç©º (å»ºè­°)</td>
<td style="text-align: center;">E304 (Warning)</td>
<td style="text-align: left;">ä½¿ç”¨ä¿å®ˆé è¨­</td>
</tr>
</tbody>
</table>
<h3 id="22-annotation">2.2 Annotation ç›´æ¥æŸ¥è©¢å¥‘ç´„</h3>
<p><strong>Feature Engineer ç›´æ¥å¯¦ä¾‹åŒ– FeatureAnnotationManager</strong>:</p>
<pre><code class="language-python"># åœ¨ FeatureEngineer.__init__ æˆ– transform ä¸­
self.annotation_manager = FeatureAnnotationManager(
    site_id=site_id,
    yaml_base_dir=config.feature_annotation.yaml_base_dir
)

# æŸ¥è©¢ device_role (å›  Cleaner æœªå‚³é)
device_role = self.annotation_manager.get_column_config(col).device_role

# æŸ¥è©¢æ˜¯å¦æŠ‘åˆ¶è­¦å‘Š
should_ignore = self.annotation_manager.should_ignore_warning(col, &quot;W403&quot;)
</code></pre>
<h3 id="23-output-contract-to-model-training">2.3 è¼¸å‡ºå¥‘ç´„ (Output Contract to Model Training)</h3>
<p><strong>å¡«è£œ GAP #5: Feature Engineer â†’ Model Training</strong></p>
<pre><code class="language-python">class FeatureEngineerOutputContract:
    &quot;&quot;&quot;Feature Engineer v1.3-FA è¼¸å‡ºè¦ç¯„&quot;&quot;&quot;

    # 1. ç‰¹å¾µçŸ©é™£ (Parquet æ ¼å¼)
    feature_matrix: pl.DataFrame

    # 2. ç›®æ¨™è®Šæ•¸è³‡è¨Š
    target_variable: Optional[str]
    target_metadata: Optional[FeatureMetadata]

    # 3. Quality Flag ç‰¹å¾µ (SSOT åŒæ­¥)
    quality_flag_features: List[str]

    # 4. ã€æ–°å¢ã€‘Annotation ç¨½æ ¸è³‡è¨Š (ä¾› Training Pipeline è¨˜éŒ„)
    annotation_context: Dict = {
        &quot;schema_version&quot;: &quot;1.2&quot;,
        &quot;inheritance_chain&quot;: &quot;base -&gt; cgmh_ty&quot;,
        &quot;yaml_checksum&quot;: &quot;sha256:...&quot;,
        &quot;group_policies_applied&quot;: [&quot;chillers&quot;, &quot;towers&quot;]
    }

    # 5. é˜² Data Leakage è³‡è¨Š
    train_test_split_info: Dict = {
        &quot;temporal_cutoff&quot;: datetime,
        &quot;strict_past_only&quot;: True,
        &quot;excluded_future_rows&quot;: int
    }

    # 6. ç‰¹å¾µå…ƒè³‡æ–™ (ä¾› Model è§£é‡‹æ€§ä½¿ç”¨)
    feature_metadata: Dict[str, FeatureMetadata]

    # 7. ç‰ˆæœ¬è¿½è¹¤
    feature_engineer_version: str = &quot;1.3-FA&quot;
    upstream_manifest_id: str
</code></pre>
<hr />
<h2 id="3-phase-based-implementation">3. åˆ†éšæ®µå¯¦ä½œè¨ˆç•« (Phase-Based Implementation)</h2>
<h3 id="phase-0-annotation-manager-day-1">Phase 0: Annotation Manager æ•´åˆåŸºç¤å»ºè¨­ (Day 1, æ–°å¢)</h3>
<h4 id="step-01-ssot-manager">Step 0.1: SSOT åš´æ ¼å¼•ç”¨èˆ‡ Manager æ³¨å…¥</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/feature_engineer.py</code> (é ‚éƒ¨)</p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<pre><code class="language-python">from typing import Dict, List, Optional, Union, Final, Tuple
from datetime import datetime
from pathlib import Path
import polars as pl
import numpy as np
from pydantic import BaseModel

# ã€é—œéµã€‘SSOT åš´æ ¼å¼•ç”¨
from src.etl.config_models import (
    VALID_QUALITY_FLAGS,      # SSOT: 6å€‹æ¨™æº–å“è³ªæ¨™è¨˜
    TIMESTAMP_CONFIG,         # SSOT: UTC, ns
    FeatureMetadata,          # SSOT: æ¬„ä½å…ƒè³‡æ–™ (ç‰©ç†å±¬æ€§)
    FeatureEngineeringConfig,
    FEATURE_ANNOTATION_CONSTANTS
)

# ã€æ–°å¢ã€‘ç›´æ¥æŸ¥è©¢ Annotation SSOT
from src.features.annotation_manager import FeatureAnnotationManager, ColumnAnnotation

# éŒ¯èª¤ä»£ç¢¼ (Interface Contract v1.0)
ERROR_CODES: Final[Dict[str, str]] = {
    &quot;E301&quot;: &quot;MANIFEST_INTEGRITY_FAILED&quot;,
    &quot;E302&quot;: &quot;SCHEMA_MISMATCH&quot;,
    &quot;E303&quot;: &quot;UNKNOWN_QUALITY_FLAG&quot;,
    &quot;E304&quot;: &quot;METADATA_MISSING&quot;,
    &quot;E305&quot;: &quot;DATA_LEAKAGE_DETECTED&quot;,
    &quot;E400&quot;: &quot;ANNOTATION_VERSION_MISMATCH&quot;,  # ã€æ–°å¢ã€‘
    &quot;E402&quot;: &quot;ANNOTATION_NOT_FOUND&quot;,         # ã€æ–°å¢ã€‘
    &quot;E500&quot;: &quot;DEVICE_ROLE_LEAKAGE&quot;           # ã€æ–°å¢ã€‘
}
</code></pre>
<h4 id="step-02-annotationmanager">Step 0.2: å»ºæ§‹å­èˆ‡ AnnotationManager åˆå§‹åŒ–</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/feature_engineer.py</code> (<code>FeatureEngineer.__init__</code>)</p>
<pre><code class="language-python">class FeatureEngineer:
    &quot;&quot;&quot;
    Feature Engineer v1.3-FA - æ•´åˆ Feature Annotation æ¶ˆè²»

    æ ¸å¿ƒè·è²¬ï¼š
    1. å¾ Manifest è®€å–ç‰©ç†å±¬æ€§ (physical_type, unit)
    2. ã€æ–°å¢ã€‘ç›´æ¥æŸ¥è©¢ Annotation SSOT å–å¾— device_role èˆ‡ ignore_warnings
    3. æ‡‰ç”¨èªæ„æ„ŸçŸ¥çš„ Group Policy (æ ¹æ“š device_role èª¿æ•´ç­–ç•¥)
    4. ç¢ºä¿ä¸ç”¢ç”Ÿ Data Leakage
    &quot;&quot;&quot;

    def __init__(
        self, 
        config: FeatureEngineeringConfig,
        site_id: str,
        yaml_base_dir: str = &quot;config/features/sites&quot;  # ã€æ–°å¢ã€‘Annotation è·¯å¾‘
    ):
        self.config = config
        self.site_id = site_id
        self.logger = get_logger(&quot;FeatureEngineer&quot;)

        # ã€é—œéµã€‘ç›´æ¥åˆå§‹åŒ– AnnotationManager (è·è²¬åˆ†é›¢ï¼šä¸ä¾èµ– Cleaner å‚³é)
        self.annotation_manager = FeatureAnnotationManager(
            site_id=site_id,
            yaml_base_dir=yaml_base_dir
        )

        self.logger.info(
            f&quot;åˆå§‹åŒ– FeatureEngineer (Schema: {self.annotation_manager.schema_version}, &quot;
            f&quot;ç¹¼æ‰¿éˆ: {self.annotation_manager.inheritance_chain})&quot;
        )

    def validate_annotation_compatibility(self, audit_trail: Dict):
        &quot;&quot;&quot;
        é©—è­‰ Annotation ç‰ˆæœ¬ç›¸å®¹æ€§ (E400)
        &quot;&quot;&quot;
        if not audit_trail:
            self.logger.warning(&quot;Manifest ç¼ºå°‘ annotation_audit_trail&quot;)
            return

        schema_ver = audit_trail.get('schema_version')
        expected = FEATURE_ANNOTATION_CONSTANTS['expected_schema_version']

        if schema_ver != expected:
            raise ConfigurationError(
                f&quot;E400: Annotation Schema ç‰ˆæœ¬ä¸ç¬¦ã€‚æœŸæœ›: {expected}, å¯¦éš›: {schema_ver}&quot;
            )

        # é©—è­‰ç¹¼æ‰¿éˆä¸€è‡´æ€§ (å¯é¸ï¼Œç”¨æ–¼é™¤éŒ¯)
        manifest_chain = audit_trail.get('inheritance_chain', '')
        manager_chain = self.annotation_manager.inheritance_chain
        if manifest_chain != manager_chain:
            self.logger.warning(
                f&quot;ç¹¼æ‰¿éˆä¸ä¸€è‡´: Manifest={manifest_chain}, Manager={manager_chain}&quot;
            )
</code></pre>
<hr />
<h3 id="phase-1-manifest-day-1-2">Phase 1: è¼¸å…¥é©—è­‰èˆ‡ Manifest è®€å– (Day 1-2)</h3>
<h4 id="step-11">Step 1.1: è®€å–èˆ‡é©—è­‰ï¼ˆæ›´æ–°ç‰ˆï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>load_from_manifest(manifest_path: Path) -&gt; Tuple[...]</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<pre><code class="language-python">def load_from_manifest(
    self, 
    manifest_path: Path
) -&gt; Tuple[pl.LazyFrame, Dict[str, FeatureMetadata], Dict]:
    &quot;&quot;&quot;
    å¾ BatchProcessor v1.3-FA Manifest è®€å–è³‡æ–™èˆ‡ Metadata

    ã€é—œéµã€‘å›å‚³ annotation_audit_trail ä¾›å¾ŒçºŒé©—è­‰
    &quot;&quot;&quot;
    from src.etl.manifest import Manifest

    manifest = Manifest.parse_file(manifest_path)

    # 1. é©—è­‰ Manifest å®Œæ•´æ€§ (E301)
    if not manifest.validate_checksum():
        raise ContractViolationError(f&quot;E301: Manifest å®Œæ•´æ€§é©—è­‰å¤±æ•—: {manifest_path}&quot;)

    # 2. é©—è­‰ Annotation ç¨½æ ¸è»Œè·¡ (E400)
    audit_trail = getattr(manifest, 'annotation_audit_trail', {})
    if audit_trail:
        self.validate_annotation_compatibility(audit_trail)
    else:
        self.logger.warning(&quot;Manifest ç¼ºå°‘ annotation_audit_trailï¼Œè·³éç‰ˆæœ¬æª¢æŸ¥&quot;)

    # 3. é©—è­‰ SSOT ç‰ˆæœ¬ç›¸å®¹æ€§ (quality_flags)
    if set(manifest.quality_flags_schema) != set(VALID_QUALITY_FLAGS):
        self.logger.warning(
            f&quot;Manifest flags ç‰ˆæœ¬èˆ‡ SSOT ä¸åŒ: &quot;
            f&quot;Manifest={manifest.quality_flags_schema}, SSOT={VALID_QUALITY_FLAGS}&quot;
        )

    # 4. é©—è­‰ timestamp Schema (E302)
    ts_schema = manifest.timestamp_schema
    if ts_schema.get(&quot;format&quot;) != &quot;INT64&quot; or ts_schema.get(&quot;timezone&quot;) != &quot;UTC&quot;:
        raise ContractViolationError(f&quot;E302: Timestamp schema ä¸ç¬¦: {ts_schema}&quot;)

    # 5. è®€å– Parquet
    files = [manifest_path.parent / f for f in manifest.output_files]
    if not files:
        raise DataValidationError(f&quot;Manifest æœªåŒ…å«è¼¸å‡ºæª”æ¡ˆ: {manifest_path}&quot;)

    df = pl.scan_parquet(files)

    # 6. ã€é—œéµã€‘é©—è­‰ DataFrame ä¸å« device_role (E500)
    if &quot;device_role&quot; in df.columns:
        raise ContractViolationError(
            f&quot;E500: DataFrame åŒ…å«ç¦æ­¢æ¬„ä½ 'device_role'ã€‚ &quot;
            f&quot;Cleaner ä¸æ‡‰å‚³é device_roleï¼ŒFeature Engineer æ‡‰ç›´æ¥æŸ¥è©¢ Annotationã€‚&quot;
        )

    # 7. æª¢æŸ¥ feature_metadata (E304)
    metadata = manifest.feature_metadata
    if not metadata:
        if self.config.input_contract.enforce_manifest_metadata:
            raise ContractViolationError(&quot;E304: Manifest ç¼ºå°‘ feature_metadata&quot;)
        else:
            self.logger.warning(&quot;E304: ä½¿ç”¨ä¿å®ˆé è¨­&quot;)
            metadata = self._infer_metadata_conservative(df)

    return df, metadata, audit_trail
</code></pre>
<hr />
<h3 id="phase-2-ssot-flags-day-2">Phase 2: SSOT åˆè¦çš„ Flags è™•ç† (Day 2)</h3>
<h4 id="step-21-quality-flags-ssot">Step 2.1: Quality Flags è™•ç†ï¼ˆSSOT å¼•ç”¨ï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_handle_quality_flags(df: pl.DataFrame) -&gt; pl.DataFrame</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<pre><code class="language-python">def _handle_quality_flags(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    è™•ç† Quality Flags (SSOT åˆè¦ç‰ˆæœ¬)

    ã€é—œéµã€‘å¼•ç”¨ VALID_QUALITY_FLAGSï¼Œç„¡ç¡¬ç·¨ç¢¼
    &quot;&quot;&quot;
    strategy = self.config.input_contract.quality_flags_handling

    if strategy == &quot;drop&quot;:
        has_flags = pl.col(&quot;quality_flags&quot;).list.len() &gt; 0
        return df.filter(~has_flags)

    elif strategy == &quot;onehot&quot;:
        # ã€SSOT å¼•ç”¨ã€‘å‹•æ…‹ç²å–æ‰€æœ‰åˆæ³• flags
        all_flags = VALID_QUALITY_FLAGS  # âœ… æ­£ç¢º: å¼•ç”¨ SSOT

        generated_flags = []
        for flag in all_flags:
            col_name = f&quot;is_{flag.lower()}_flag&quot;
            df = df.with_columns(
                pl.col(&quot;quality_flags&quot;)
                .list.contains(flag)
                .alias(col_name)
            )
            generated_flags.append(col_name)

        self.quality_flag_features = generated_flags
        return df

    return df
</code></pre>
<hr />
<h3 id="phase-3-group-policy-day-3-4">Phase 3: èªæ„æ„ŸçŸ¥ Group Policy (Day 3-4, æ ¸å¿ƒæ›´æ–°)</h3>
<h4 id="step-31-group-policy-annotation-ssot">Step 3.1: Group Policy è§£æï¼ˆä½¿ç”¨ Annotation SSOTï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_resolve_group_policies(metadata: Dict) -&gt; Dict[str, StatsRule]</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<pre><code class="language-python">def _resolve_group_policies(
    self, 
    manifest_metadata: Dict[str, FeatureMetadata]
) -&gt; Dict[str, StatsRule]:
    &quot;&quot;&quot;
    è§£æ Group Policiesï¼Œä½¿ç”¨ Annotation SSOT (physical_type + device_role)

    ã€é—œéµä¿®æ­£ã€‘v1.2 åƒ…ä½¿ç”¨ physical_typeï¼›v1.3-FA å¢åŠ  device_role æ„ŸçŸ¥
    &quot;&quot;&quot;
    resolved = {}

    for policy in self.config.stats_features.group_policies:
        target_cols = []

        for col, meta in manifest_metadata.items():
            # 1. åŒ¹é… physical_type (ä¾†è‡ª Manifest)
            if meta.physical_type not in policy.apply_to_types:
                continue

            # 2. ã€æ–°å¢ã€‘æŸ¥è©¢ device_role (ä¾†è‡ª AnnotationManager)
            col_config = self.annotation_manager.get_column_config(col)
            if not col_config:
                self.logger.warning(f&quot;æ¬„ä½ {col} åœ¨ Annotation ä¸­æœªå®šç¾©ï¼Œè·³é Group Policy&quot;)
                continue

            device_role = col_config.device_role

            # 3. ã€æ–°å¢ã€‘æ ¹æ“š device_role èª¿æ•´ç­–ç•¥
            if device_role == &quot;backup&quot; and policy.name == &quot;High_Freq&quot;:
                # å‚™ç”¨è¨­å‚™ä¸ä½¿ç”¨é«˜é »æ¡æ¨£ç­–ç•¥ï¼ˆå¯èƒ½é•·æœŸåœæ©Ÿï¼‰
                self.logger.debug(f&quot;æ¬„ä½ {col} (backup) è·³é High_Freq ç­–ç•¥&quot;)
                continue

            if device_role == &quot;seasonal&quot; and policy.name == &quot;Strict_Balance&quot;:
                # å­£ç¯€æ€§è¨­å‚™æ”¾å¯¬å¹³è¡¡æª¢æŸ¥
                self.logger.debug(f&quot;æ¬„ä½ {col} (seasonal) æ”¾å¯¬ Strict_Balance&quot;)

            # 4. æ’é™¤ç›®æ¨™è®Šæ•¸ (Data Leakage é˜²è­·)
            if meta.is_target:
                continue

            target_cols.append(col)

        # 5. æ‡‰ç”¨è¦å‰‡ (å«ç¹¼æ‰¿è™•ç†)
        for col in target_cols:
            if (self.config.stats_features.column_overrides and 
                col in self.config.stats_features.column_overrides):
                resolved[col] = self.config.stats_features.column_overrides[col]
            else:
                # ã€æ–°å¢ã€‘æ ¹æ“š device_role èª¿æ•´çª—å£å¤§å°
                col_config = self.annotation_manager.get_column_config(col)
                base_rule = policy.rules

                if col_config and col_config.device_role == &quot;backup&quot;:
                    # å‚™ç”¨è¨­å‚™ä½¿ç”¨è¼ƒå¤§çª—å£ï¼ˆå¹³æ»‘é•·æœŸåœæ©Ÿå½±éŸ¿ï¼‰
                    adjusted_rule = self._adjust_rule_for_backup(base_rule)
                    resolved[col] = adjusted_rule
                else:
                    resolved[col] = base_rule

    return resolved

def _adjust_rule_for_backup(self, base_rule: StatsRule) -&gt; StatsRule:
    &quot;&quot;&quot;
    ç‚ºå‚™ç”¨è¨­å‚™èª¿æ•´çµ±è¨ˆè¦å‰‡ (è¨­å‚™è§’è‰²æ„ŸçŸ¥)
    &quot;&quot;&quot;
    # å‚™ç”¨è¨­å‚™ï¼šå¢å¤§ rolling windowï¼Œæ¸›å°‘ lag æ•¸é‡
    adjusted = base_rule.copy()

    if adjusted.rolling_windows:
        # çª—å£å¢å¤§ 2 å€ï¼ˆä½†ä¸è¶…è¿‡ 96ï¼‰
        adjusted.rolling_windows = [
            min(w * 2, 96) for w in adjusted.rolling_windows
        ]

    if adjusted.lag_intervals:
        # åªä¿ç•™å‰ 2 å€‹ lag
        adjusted.lag_intervals = adjusted.lag_intervals[:2]

    return adjusted
</code></pre>
<h4 id="step-32-data-leakage">Step 3.2: çµ±è¨ˆç‰¹å¾µç”Ÿæˆï¼ˆData Leakage é˜²è­· + è­¦å‘ŠæŠ‘åˆ¶ï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_generate_stats_features(df: pl.DataFrame, column_rules: Dict) -&gt; pl.DataFrame</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<pre><code class="language-python">def _generate_stats_features(
    self, 
    df: pl.DataFrame, 
    column_rules: Dict[str, StatsRule]
) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    ç”Ÿæˆçµ±è¨ˆç‰¹å¾µï¼Œæ”¯æ´ device_role æ„ŸçŸ¥èˆ‡ ignore_warnings
    &quot;&quot;&quot;
    expressions = []

    for col, rules in column_rules.items():
        if col not in df.columns:
            continue

        # ã€æ–°å¢ã€‘æŸ¥è©¢ ignore_warnings (ä¾†è‡ª Annotation)
        col_config = self.annotation_manager.get_column_config(col)
        ignore_warnings = col_config.ignore_warnings if col_config else []

        # Lag ç‰¹å¾µ (Data Leakage é˜²è­·ï¼šshift)
        for lag in rules.lag_intervals:
            if lag &gt; len(df) * 0.5:
                # ã€æ–°å¢ã€‘æª¢æŸ¥æ˜¯å¦æ‡‰å¿½ç•¥ W402 (çª—å£éå¤§è­¦å‘Š)
                if &quot;W402&quot; not in ignore_warnings:
                    self.logger.warning(f&quot;W402: æ¬„ä½ {col} lag {lag} è¶…éè³‡æ–™é•·åº¦ 50%&quot;)
                continue

            expressions.append(
                pl.col(col).shift(lag).alias(f&quot;{col}_lag_{lag}&quot;)
            )

        # Rolling ç‰¹å¾µ (åš´æ ¼ shift(1) é˜²è­·)
        for window in rules.rolling_windows:
            if window &gt; len(df) * 0.5:
                if &quot;W402&quot; not in ignore_warnings:
                    self.logger.warning(f&quot;W402: æ¬„ä½ {col} window {window} è¶…é 50%&quot;)
                continue

            # é€™è£¡çœç•¥å…·é«” rolling è¨ˆç®—ï¼Œèˆ‡åŸé‚è¼¯ç›¸åŒ
            # ...

    return df.with_columns(expressions) if expressions else df
</code></pre>
<hr />
<h3 id="phase-4-model-training-day-4-5">Phase 4: è¼¸å‡ºæº–å‚™èˆ‡ Model Training éŠœæ¥ (Day 4-5)</h3>
<h4 id="step-41">Step 4.1: è¼¸å‡ºå¥‘ç´„å»ºæ§‹ï¼ˆæ›´æ–°ç‰ˆï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_build_output_contract(...) -&gt; FeatureEngineerOutputContract</code></p>
<pre><code class="language-python">def _build_output_contract(
    self, 
    df: pl.DataFrame, 
    manifest: Manifest,
    audit_trail: Dict,
    target_col: Optional[str] = None
) -&gt; FeatureEngineerOutputContract:
    &quot;&quot;&quot;
    å»ºæ§‹è¼¸å‡ºå¥‘ç´„ï¼ŒåŒ…å« Annotation ä¸Šä¸‹æ–‡
    &quot;&quot;&quot;
    # ç›®æ¨™è®Šæ•¸è™•ç†
    target_metadata = None
    if target_col and target_col in manifest.feature_metadata:
        target_metadata = manifest.feature_metadata[target_col]

    # ç‰¹å¾µå…ƒè³‡æ–™ (æ¨™è¨˜ derived)
    feature_metadata = {}
    for col in df.columns:
        if col in [&quot;timestamp&quot;, target_col]:
            continue

        if col in manifest.feature_metadata:
            feature_metadata[col] = manifest.feature_metadata[col]
        else:
            feature_metadata[col] = FeatureMetadata(
                column_name=col,
                physical_type=&quot;derived&quot;,
                is_target=False
            )

    # ã€æ–°å¢ã€‘Annotation ä¸Šä¸‹æ–‡ (ä¾› Training Pipeline è¨˜éŒ„)
    annotation_context = {
        &quot;schema_version&quot;: audit_trail.get('schema_version', 'unknown'),
        &quot;inheritance_chain&quot;: audit_trail.get('inheritance_chain', 'none'),
        &quot;yaml_checksum&quot;: audit_trail.get('yaml_checksum', ''),
        &quot;group_policies_applied&quot;: [
            p.name for p in self.config.stats_features.group_policies
        ],
        &quot;device_role_aware&quot;: True  # æ¨™è¨˜å·²æ‡‰ç”¨è¨­å‚™è§’è‰²æ„ŸçŸ¥
    }

    return FeatureEngineerOutputContract(
        feature_matrix=df,
        target_variable=target_col,
        target_metadata=target_metadata,
        quality_flag_features=getattr(self, 'quality_flag_features', []),
        annotation_context=annotation_context,  # ã€æ–°å¢ã€‘
        train_test_split_info={
            &quot;temporal_cutoff&quot;: self.config.cutoff_timestamp.isoformat() if self.config.cutoff_timestamp else None,
            &quot;strict_past_only&quot;: True
        },
        feature_metadata=feature_metadata,
        upstream_manifest_id=manifest.batch_id,
        feature_engineer_version=&quot;1.3-FA&quot;
    )
</code></pre>
<hr />
<h2 id="4-error-codes">4. éŒ¯èª¤ä»£ç¢¼å°ç…§è¡¨ (Error Codes)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤ä»£ç¢¼</th>
<th style="text-align: left;">åç¨±</th>
<th style="text-align: center;">ç™¼ç”Ÿéšæ®µ</th>
<th style="text-align: left;">èªªæ˜</th>
<th style="text-align: left;">è™•ç†å»ºè­°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>E301</strong></td>
<td style="text-align: left;"><code>MANIFEST_INTEGRITY_FAILED</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">Manifest checksum é©—è­‰å¤±æ•—</td>
<td style="text-align: left;">é‡æ–°åŸ·è¡Œ BatchProcessor</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E302</strong></td>
<td style="text-align: left;"><code>SCHEMA_MISMATCH</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">Parquet Schema é INT64/UTC</td>
<td style="text-align: left;">é‡æ–°åŸ·è¡Œ BatchProcessor</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E303</strong></td>
<td style="text-align: left;"><code>UNKNOWN_QUALITY_FLAG</code></td>
<td style="text-align: center;">Step 2.1</td>
<td style="text-align: left;">è¼¸å…¥å«æœªå®šç¾© flags</td>
<td style="text-align: left;">ç¢ºèª SSOT ç‰ˆæœ¬ä¸€è‡´æ€§</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E304</strong></td>
<td style="text-align: left;"><code>METADATA_MISSING</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">Manifest ç„¡ feature_metadata</td>
<td style="text-align: left;">å‡ç´š BatchProcessor</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E305</strong></td>
<td style="text-align: left;"><code>DATA_LEAKAGE_DETECTED</code></td>
<td style="text-align: center;">Step 3.2</td>
<td style="text-align: left;">åŒ…å«æœªä¾†è³‡æ–™</td>
<td style="text-align: left;">æª¢æŸ¥ cutoff_timestamp</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E400</strong></td>
<td style="text-align: left;"><code>ANNOTATION_VERSION_MISMATCH</code></td>
<td style="text-align: center;">Step 0.2/1.1</td>
<td style="text-align: left;">Manifest çš„ Annotation ç‰ˆæœ¬éèˆŠ</td>
<td style="text-align: left;">åŸ·è¡Œ migrate-excel</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E402</strong></td>
<td style="text-align: left;"><code>ANNOTATION_NOT_FOUND</code></td>
<td style="text-align: center;">Step 3.1</td>
<td style="text-align: left;">æ¬„ä½æœªå®šç¾©æ–¼ Annotation</td>
<td style="text-align: left;">åŸ·è¡Œ features wizard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E500</strong></td>
<td style="text-align: left;"><code>DEVICE_ROLE_LEAKAGE</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">DataFrame å« device_role æ¬„ä½</td>
<td style="text-align: left;">æª¢æŸ¥ Cleaner è·è²¬åˆ†é›¢</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-test-plan">5. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Test Plan)</h2>
<h3 id="51-unit-tests">5.1 å–®å…ƒæ¸¬è©¦ (Unit Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸçµæœ</th>
<th style="text-align: center;">å°æ‡‰ Step</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>FE13-FA-01</strong></td>
<td style="text-align: left;">E400 ç‰ˆæœ¬æª¢æŸ¥</td>
<td style="text-align: left;">Manifest schema_version=1.1</td>
<td style="text-align: left;">æ‹‹å‡º E400</td>
<td style="text-align: center;">0.2</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FE13-FA-02</strong></td>
<td style="text-align: left;">device_role æŸ¥è©¢</td>
<td style="text-align: left;">å‘¼å« annotation_manager</td>
<td style="text-align: left;">æ­£ç¢ºå–å¾— primary/backup/seasonal</td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FE13-FA-03</strong></td>
<td style="text-align: left;">Group Policy è¨­å‚™æ„ŸçŸ¥</td>
<td style="text-align: left;">backup è¨­å‚™å¥—ç”¨ High_Freq</td>
<td style="text-align: left;">ç­–ç•¥è¢«è·³é</td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FE13-FA-04</strong></td>
<td style="text-align: left;">ignore_warnings ç”Ÿæ•ˆ</td>
<td style="text-align: left;">æ¨™è¨˜ W403 å¿½ç•¥</td>
<td style="text-align: left;">ä¸è§¸ç™¼é«˜é›¶å€¼è­¦å‘Š</td>
<td style="text-align: center;">3.2</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FE13-FA-05</strong></td>
<td style="text-align: left;">ç¹¼æ‰¿éˆé©—è­‰</td>
<td style="text-align: left;">cgmh_ty ç¹¼æ‰¿ base</td>
<td style="text-align: left;">æ­£ç¢ºè§£æç¹¼æ‰¿çš„ physical_types</td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;">FE13-001</td>
<td style="text-align: left;">SSOT Flags å¼•ç”¨</td>
<td style="text-align: left;">VALID_QUALITY_FLAGS æ›´æ–°</td>
<td style="text-align: left;">One-hot è‡ªå‹•åŒ…å«æ–° flag</td>
<td style="text-align: center;">2.1</td>
</tr>
<tr>
<td style="text-align: left;">FE13-002</td>
<td style="text-align: left;">Metadata æ¥æ”¶</td>
<td style="text-align: left;">Manifest å« physical_type</td>
<td style="text-align: left;">Group Policy æ­£ç¢ºå¥—ç”¨</td>
<td style="text-align: center;">3.1</td>
</tr>
</tbody>
</table>
<h3 id="52-integration-tests">5.2 æ•´åˆæ¸¬è©¦ (Integration Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: center;">ä¸Šæ¸¸</th>
<th style="text-align: center;">ä¸‹æ¸¸</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>INT-FE-FA-01</strong></td>
<td style="text-align: left;">å®Œæ•´ Metadata æ¶ˆè²»</td>
<td style="text-align: center;">BP v1.3-FA (audit_trail) + Annotation YAML</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: left;">æ­£ç¢ºè®€å– device_roleï¼Œæ‡‰ç”¨èªæ„ç­–ç•¥</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-FE-FA-02</strong></td>
<td style="text-align: left;">Backup è¨­å‚™ç‰¹å¾µ</td>
<td style="text-align: center;">Backup è¨­å‚™è³‡æ–™</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: left;">ä½¿ç”¨æ”¾å¤§çª—å£ï¼Œä¸è§¸ç™¼ W403</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-FE-FA-03</strong></td>
<td style="text-align: left;">ç¹¼æ‰¿éˆä¸€è‡´æ€§</td>
<td style="text-align: center;">base.yaml + site.yaml</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: left;">æ­£ç¢ºåˆä½µ Group Policies</td>
</tr>
<tr>
<td style="text-align: left;">INT-F01</td>
<td style="text-align: left;">BP v1.3 â†’ FE v1.3</td>
<td style="text-align: center;">BP v1.3</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: left;">æ­£ç¢ºæ¥æ”¶ metadata</td>
</tr>
<tr>
<td style="text-align: left;">INT-F02</td>
<td style="text-align: left;">FE â†’ Model Training</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: center;">Training Pipeline</td>
<td style="text-align: left;">å‚³é annotation_context</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-risk-assessment">6. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£ (Risk Assessment)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢¨éšª</th>
<th style="text-align: center;">åš´é‡åº¦</th>
<th style="text-align: center;">å¯èƒ½æ€§</th>
<th style="text-align: left;">ç·©è§£æªæ–½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Annotation ç‰ˆæœ¬æ¼‚ç§»</strong> (E400)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">å•Ÿå‹•æ™‚åš´æ ¼æª¢æŸ¥ schema_version</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role æŸ¥è©¢å¤±æ•—</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;">æ¬„ä½æœªå®šç¾©æ™‚æ‹‹å‡º E402ï¼Œä¸å…è¨±é è¨­å€¼</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSOT ä¸åŒæ­¥</strong> (flags)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">æ¯”å° manifest.quality_flags_schema èˆ‡ VALID_QUALITY_FLAGS</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Leakage</strong> (shift éŒ¯èª¤)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;">å–®å…ƒæ¸¬è©¦é©—è­‰ T æ™‚åˆ»ç‰¹å¾µä¸åŒ…å« T æ™‚åˆ»å€¼</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç¹¼æ‰¿éˆè¤‡é›œåº¦</strong></td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">è¨˜éŒ„ inheritance_chain ä¾›é™¤éŒ¯ï¼Œé©—è­‰åˆä½µçµæœ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-version-compatibility">7. ç‰ˆæœ¬ç›¸å®¹æ€§çŸ©é™£ (Version Compatibility)</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;">Feature Annotation</th>
<th style="text-align: center;">ç›¸å®¹æ€§</th>
<th style="text-align: left;">èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v1.3-FA (audit_trail)</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âœ… <strong>å®Œå…¨ç›¸å®¹</strong></td>
<td style="text-align: left;">æ¨è–¦é…ç½®ï¼Œæ”¯æ´ device_role æ„ŸçŸ¥</td>
</tr>
<tr>
<td style="text-align: center;">v1.3-FA</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">âš ï¸ <strong>é™ç´šç›¸å®¹</strong></td>
<td style="text-align: left;">ç¼ºå°‘ device_roleï¼Œä½¿ç”¨é è¨­ primary</td>
</tr>
<tr>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âš ï¸ <strong>éƒ¨åˆ†ç›¸å®¹</strong></td>
<td style="text-align: left;">ç¼ºå°‘ audit_trailï¼Œè·³éç‰ˆæœ¬æª¢æŸ¥</td>
</tr>
<tr>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">ç„¡æ³•è®€å– feature_metadataï¼Œæ‹‹å‡º E304</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-deliverables">8. äº¤ä»˜ç‰©æ¸…å–® (Deliverables)</h2>
<h3 id="81">8.1 ç¨‹å¼ç¢¼æª”æ¡ˆ</h3>
<ol>
<li><code>src/etl/feature_engineer.py</code> - ä¸»è¦å¯¦ä½œ (v1.3-FAï¼Œå« AnnotationManager æ•´åˆ)</li>
<li><code>src/etl/config_models.py</code> - æ›´æ–° FeatureEngineeringConfig (æ”¯æ´ device_role æ„ŸçŸ¥)</li>
<li><code>src/etl/manifest.py</code> - æ›´æ–° Manifest æ¨¡å‹ (æ¥æ”¶ annotation_audit_trail)</li>
</ol>
<h3 id="82">8.2 æ¸¬è©¦æª”æ¡ˆ</h3>
<ol start="4">
<li><code>tests/test_feature_engineer_v13_fa.py</code> - v1.3-FA å°ˆå±¬æ¸¬è©¦ (device_role æ„ŸçŸ¥)</li>
<li><code>tests/test_group_policy_device_role.py</code> - Group Policy è¨­å‚™è§’è‰²æ¸¬è©¦</li>
<li><code>tests/test_annotation_integration_fe.py</code> - èˆ‡ AnnotationManager æ•´åˆæ¸¬è©¦</li>
</ol>
<h3 id="83">8.3 æ–‡ä»¶æª”æ¡ˆ</h3>
<ol start="7">
<li><code>docs/feature_engineering/PRD_FEATURE_ENGINEER_v1.3-FA.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/feature_engineering/DEVICE_ROLE_GUIDE.md</code> - device_role èˆ‡ Group Policy ä½¿ç”¨èªªæ˜</li>
</ol>
<hr />
<h2 id="9-sign-off-checklist">9. é©—æ”¶ç°½æ ¸ (Sign-off Checklist)</h2>
<ul>
<li>[ ] <strong>SSOT å¼•ç”¨</strong>: ç„¡ç¡¬ç·¨ç¢¼ flagsï¼Œå…¨éƒ¨å¼•ç”¨ <code>VALID_QUALITY_FLAGS</code></li>
<li>[ ] <strong>Metadata åˆ†å±¤æ¶ˆè²»</strong>: </li>
<li>[ ] physical_type/unit å¾ Manifest è®€å–</li>
<li>[ ] device_role/ignore_warnings å¾ AnnotationManager æŸ¥è©¢</li>
<li>[ ] <strong>è·è²¬åˆ†é›¢å°Šé‡</strong>: ä¸æœŸå¾…è¼¸å…¥ DataFrame åŒ…å« device_roleï¼Œç›´æ¥æŸ¥è©¢ YAML SSOT</li>
<li>[ ] <strong>Group Policy èªæ„æ„ŸçŸ¥</strong>: </li>
<li>[ ] backup è¨­å‚™æ­£ç¢ºè·³é High_Freq ç­–ç•¥</li>
<li>[ ] seasonal è¨­å‚™æ­£ç¢ºæ”¾å¯¬ Strict_Balance</li>
<li>[ ] <strong>è­¦å‘ŠæŠ‘åˆ¶</strong>: æ¨™è¨˜ ignore_warnings çš„æ¬„ä½æ­£ç¢ºæŠ‘åˆ¶ W402/W403</li>
<li>[ ] <strong>ç‰ˆæœ¬æª¢æŸ¥</strong>: Manifest çš„ schema_version ä¸ç¬¦æ™‚æ­£ç¢ºæ‹‹å‡º E400</li>
<li>[ ] <strong>ç¹¼æ‰¿éˆè™•ç†</strong>: æ­£ç¢ºæ¶ˆè²»ç¹¼æ‰¿è‡ª base.yaml çš„ Group Policies</li>
<li>[ ] <strong>Data Leakage</strong>: <code>shift(1)</code> æ­£ç¢ºå¯¦ä½œï¼Œé©—è­‰é€šé</li>
<li>[ ] <strong>è¼¸å‡ºå¥‘ç´„</strong>: æ­£ç¢ºç”¢ç”Ÿ <code>annotation_context</code> ä¾› Training Pipeline è¨˜éŒ„</li>
<li>[ ] <strong>ä¸‹æ¸¸éŠœæ¥</strong>: Model Training å¯æ­£ç¢ºè®€å–è¼¸å‡ºï¼ŒåŒ…å«è¨­å‚™è§’è‰²è³‡è¨Š</li>
</ul>
<hr />
<p><strong>é—œéµè¨­è¨ˆç¢ºèª</strong>ï¼š<br />
1. Feature Engineer <strong>ä¸»å‹•æŸ¥è©¢</strong> device_role (å›  Cleaner ä¸å‚³é)<br />
2. Group Policy åŒæ™‚ä½¿ç”¨ <strong>physical_type</strong> (Manifest) èˆ‡ <strong>device_role</strong> (Annotation)<br />
3. <strong>ignore_warnings</strong> ç›´æ¥æŸ¥è©¢ Annotationï¼Œä¸ç¶“ç”± Manifest å‚³é<br />
4. <strong>ç¹¼æ‰¿éˆ</strong> é€é AnnotationManager è™•ç†ï¼Œèˆ‡ Manifest çš„ audit_trail äº¤å‰é©—è­‰</p>
</body>
</html>