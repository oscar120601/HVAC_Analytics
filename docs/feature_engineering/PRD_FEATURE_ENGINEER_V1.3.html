
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PRD_FEATURE_ENGINEER_V1.3</title>
    
<style>
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
        line-height: 1.6; 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        color: #24292e; 
        background-color: #ffffff;
    }
    h1, h2, h3, h4, h5, h6 { 
        margin-top: 24px; 
        margin-bottom: 16px; 
        font-weight: 600; 
        color: #24292e;
    }
    h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h3 { font-size: 1.25em; }
    p { margin-top: 0; margin-bottom: 16px; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { 
        display: block; 
        width: 100%; 
        overflow: auto; 
        border-spacing: 0; 
        border-collapse: collapse; 
        margin-bottom: 16px; 
    }
    table th, table td { 
        padding: 6px 13px; 
        border: 1px solid #dfe2e5; 
    }
    table th { 
        font-weight: 600; 
        background-color: #f6f8fa; 
    }
    table tr:nth-child(2n) { 
        background-color: #f6f8fa; 
    }
    code { 
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace; 
        background-color: #f6f8fa; 
        padding: 0.2em 0.4em; 
        border-radius: 3px; 
        font-size: 85%; 
    }
    pre { 
        background-color: #f6f8fa; 
        padding: 16px; 
        overflow: auto; 
        border-radius: 3px; 
        line-height: 1.45; 
    }
    pre code { 
        background-color: transparent; 
        padding: 0; 
        border-radius: 0; 
    }
    blockquote { 
        border-left: 0.25em solid #dfe2e5; 
        color: #6a737d; 
        padding: 0 1em; 
        margin: 0 0 16px 0; 
    }
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
    }
    .mermaid {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
</style>

</head>
<body>
    <h1 id="prd-v13-feature-engineering-implementation-guide">PRD v1.3: ç‰¹å¾µå·¥ç¨‹å¼·å¥æ€§å¯¦ä½œæŒ‡å— (Feature Engineering Implementation Guide)</h1>
<h1 id="feature-annotation-v12metadata-group-policy">æ•´åˆ Feature Annotation v1.2ï¼šMetadata æ¶ˆè²»èˆ‡ Group Policy é‡æ§‹</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.3-FA (Feature Annotation Consumption &amp; Device Role Awareness)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/etl/feature_engineer.py</code> (v1.3+)<br />
<strong>ä¸Šæ¸¸å¥‘ç´„:</strong> <code>src/etl/batch_processor.py</code> (v1.3-FA+, æª¢æŸ¥é» #3)<br />
<strong>ä¸‹æ¸¸å¥‘ç´„:</strong> <code>src/modeling/training_pipeline.py</code> (v1.0+, è¼¸å‡ºæª¢æŸ¥é»)<br />
<strong>é—œéµç›¸ä¾:</strong> <code>src/features/annotation_manager.py</code> (v1.2+, æä¾› device_role èˆ‡ ignore_warnings æŸ¥è©¢)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 5 ~ 6 å€‹å·¥ç¨‹å¤©ï¼ˆå« Annotation æ•´åˆèˆ‡ Group Policy é‡æ§‹ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆå“²å­¸</h2>
<h3 id="11-v12-v13-fa">1.1 ç‰ˆæœ¬è®Šæ›´ç¸½è¦½ (v1.2 â†’ v1.3-FA)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">è®Šæ›´é¡åˆ¥</th>
<th style="text-align: left;">v1.2 ç‹€æ…‹</th>
<th style="text-align: left;">v1.3-FA ä¿®æ­£</th>
<th style="text-align: center;">å½±éŸ¿å±¤ç´š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Metadata ä¾†æº</strong></td>
<td style="text-align: left;">ä¾è³´ <code>get_feature_meta()</code> (é‡æ–°æ¢æ¸¬)</td>
<td style="text-align: left;"><strong>å¾ Manifest æ¥æ”¶</strong> <code>feature_metadata</code> (ç‰©ç†å±¬æ€§) + <strong>ç›´æ¥æŸ¥è©¢</strong> Annotation (device_role)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role æ¶ˆè²»</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><strong>ç›´æ¥è®€å–</strong> FeatureAnnotationManager (Cleaner ä¸å‚³éï¼Œè·è²¬åˆ†é›¢)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Group Policy æ›´æ–°</strong></td>
<td style="text-align: left;">ä½¿ç”¨æ¨æ–·çš„ physical_type</td>
<td style="text-align: left;"><strong>ä½¿ç”¨ Annotation SSOT</strong> çš„ physical_type èˆ‡ device_role</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ignore_warnings</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;"><strong>æŸ¥è©¢ Annotation</strong> æ±ºå®šæ˜¯å¦æŠ‘åˆ¶ç‰¹å®šè­¦å‘Š (W403)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Flags ç¡¬ç·¨ç¢¼</strong></td>
<td style="text-align: left;">Step 3.2 ç¡¬ç·¨ç¢¼ flags</td>
<td style="text-align: left;"><strong>å¼·åˆ¶å¼•ç”¨</strong> <code>VALID_QUALITY_FLAGS</code> (SSOT)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç¨½æ ¸è»Œè·¡</strong></td>
<td style="text-align: left;">ç„¡ç‰ˆæœ¬è¨˜éŒ„</td>
<td style="text-align: left;"><strong>é©—è­‰</strong> <code>annotation_audit_trail</code> (schema_version, inheritance_chain)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Leakage</strong></td>
<td style="text-align: left;"><code>shift(1)</code> é˜²è­·</td>
<td style="text-align: left;"><strong>ä¿ç•™</strong> <code>shift(1)</code> + <code>cutoff_timestamp</code> åš´æ ¼æª¢æŸ¥</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 æ ¸å¿ƒè¨­è¨ˆåŸå‰‡</h3>
<ol>
<li><strong>SSOT åš´æ ¼éµå®ˆ</strong>: æ‰€æœ‰ quality flags æ“ä½œå¼•ç”¨ <code>VALID_QUALITY_FLAGS</code>ï¼›æ‰€æœ‰ physical_type èˆ‡ device_role æ±ºç­–å¼•ç”¨ FeatureAnnotationManager</li>
<li><strong>Metadata åˆ†å±¤æ¶ˆè²»</strong>:</li>
<li><strong>ç‰©ç†å±¬æ€§</strong> (physical_type, unit)ï¼šå¾ BatchProcessor Manifest çš„ <code>feature_metadata</code> è®€å–</li>
<li><strong>è¨­å‚™è§’è‰²</strong> (device_role, ignore_warnings)ï¼šç›´æ¥æŸ¥è©¢ FeatureAnnotationManager (YAML SSOT)</li>
<li><strong>è·è²¬åˆ†é›¢å°Šé‡</strong>: ä¸æœŸå¾… Cleaner/BatchProcessor å‚³é device_roleï¼Œä¸»å‹•å¾ Annotation å±¤æŸ¥è©¢</li>
<li><strong>Group Policy èªæ„æ„ŸçŸ¥</strong>: æ ¹æ“š device_role (primary/backup/seasonal) èª¿æ•´çµ±è¨ˆç‰¹å¾µç”Ÿæˆç­–ç•¥ï¼ˆå¦‚å‚™ç”¨è¨­å‚™ä½¿ç”¨ä¸åŒçª—å£ï¼‰</li>
<li><strong>ç¹¼æ‰¿éˆç›¸å®¹</strong>: æ­£ç¢ºè™•ç† <code>inheritance_chain</code>ï¼Œæ”¯æ´ base â†’ site çš„è¨­å®šè¦†è“‹</li>
</ol>
<hr />
<h2 id="2-interface-contracts">2. ä»‹é¢å¥‘ç´„è¦ç¯„ (Interface Contracts)</h2>
<h3 id="21-input-contract-from-batchprocessor-v13-fa">2.1 è¼¸å…¥å¥‘ç´„ (Input Contract from BatchProcessor v1.3-FA)</h3>
<p><strong>æª¢æŸ¥é» #3: BatchProcessor â†’ Feature Engineer</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¨™æº–è®€å–ç¯„ä¾‹ (å¿…é ˆå¯¦ä½œ)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_from_batch_processor</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">        df: LazyFrame (Parquet è³‡æ–™ï¼ŒINT64/UTC é©—è­‰é€šéï¼Œä¸å« device_role)</span>
<span class="sd">        feature_metadata: Dict (column_name -&gt; physical_type/unitï¼Œä¸å« device_role)</span>
<span class="sd">        annotation_audit_trail: Dict (schema_version, inheritance_chain, yaml_checksum)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">)</span>

    <span class="c1"># 1. é©—è­‰ Manifest å®Œæ•´æ€§ (E301)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">manifest</span><span class="o">.</span><span class="n">validate_checksum</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span><span class="s2">&quot;E301: Manifest ææ¯€&quot;</span><span class="p">)</span>

    <span class="c1"># 2. ã€æ–°å¢ã€‘é©—è­‰ Annotation ç¨½æ ¸è»Œè·¡ (E400)</span>
    <span class="n">audit</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">annotation_audit_trail</span>
    <span class="k">if</span> <span class="n">audit</span><span class="p">:</span>
        <span class="n">expected_ver</span> <span class="o">=</span> <span class="n">FEATURE_ANNOTATION_CONSTANTS</span><span class="p">[</span><span class="s1">&#39;expected_schema_version&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">audit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_ver</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;E400: Manifest çš„ Annotation ç‰ˆæœ¬éèˆŠ &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">audit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">expected_ver</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

    <span class="c1"># 3. è®€å–è³‡æ–™èˆ‡ Metadata</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">manifest_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">output_files</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> 
        <span class="n">manifest</span><span class="o">.</span><span class="n">feature_metadata</span><span class="p">,</span>  <span class="c1"># åƒ…å«ç‰©ç†å±¬æ€§</span>
        <span class="n">audit</span>  <span class="c1"># ç¨½æ ¸è³‡è¨Š</span>
    <span class="p">)</span>
</code></pre></div>

<table>
<thead>
<tr>
<th style="text-align: left;">æª¢æŸ¥é …</th>
<th style="text-align: left;">è¦ç¯„</th>
<th style="text-align: center;">éŒ¯èª¤ä»£ç¢¼</th>
<th style="text-align: left;">è™•ç†</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Manifest å®Œæ•´æ€§</td>
<td style="text-align: left;"><code>checksum</code> é©—è­‰é€šé</td>
<td style="text-align: center;">E301</td>
<td style="text-align: left;">æ‹’çµ•è®€å–</td>
</tr>
<tr>
<td style="text-align: left;">Annotation ç‰ˆæœ¬</td>
<td style="text-align: left;"><code>schema_version</code> ç¬¦åˆ SSOT</td>
<td style="text-align: center;">E400</td>
<td style="text-align: left;">çµ‚æ­¢æµç¨‹</td>
</tr>
<tr>
<td style="text-align: left;">timestamp æ ¼å¼</td>
<td style="text-align: left;"><code>INT64</code>, <code>nanoseconds</code>, <code>UTC</code></td>
<td style="text-align: center;">E302</td>
<td style="text-align: left;">æ‹’çµ•è®€å–</td>
</tr>
<tr>
<td style="text-align: left;">quality_flags å€¼</td>
<td style="text-align: left;">âŠ† <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: center;">E303</td>
<td style="text-align: left;">æ‹’çµ•è®€å–</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role æ¬„ä½</strong></td>
<td style="text-align: left;"><strong>ç¦æ­¢å­˜åœ¨æ–¼ DataFrame</strong></td>
<td style="text-align: center;">E500</td>
<td style="text-align: left;">çµ‚æ­¢æµç¨‹</td>
</tr>
<tr>
<td style="text-align: left;">feature_metadata</td>
<td style="text-align: left;">éç©º (å»ºè­°)</td>
<td style="text-align: center;">E304 (Warning)</td>
<td style="text-align: left;">ä½¿ç”¨ä¿å®ˆé è¨­</td>
</tr>
</tbody>
</table>
<h3 id="22-annotation">2.2 Annotation ç›´æ¥æŸ¥è©¢å¥‘ç´„</h3>
<p><strong>Feature Engineer ç›´æ¥å¯¦ä¾‹åŒ– FeatureAnnotationManager</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åœ¨ FeatureEngineer.__init__ æˆ– transform ä¸­</span>
<span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span> <span class="o">=</span> <span class="n">FeatureAnnotationManager</span><span class="p">(</span>
    <span class="n">site_id</span><span class="o">=</span><span class="n">site_id</span><span class="p">,</span>
    <span class="n">yaml_base_dir</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">feature_annotation</span><span class="o">.</span><span class="n">yaml_base_dir</span>
<span class="p">)</span>

<span class="c1"># æŸ¥è©¢ device_role (å›  Cleaner æœªå‚³é)</span>
<span class="n">device_role</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span><span class="o">.</span><span class="n">get_column_config</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">device_role</span>

<span class="c1"># æŸ¥è©¢æ˜¯å¦æŠ‘åˆ¶è­¦å‘Š</span>
<span class="n">should_ignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span><span class="o">.</span><span class="n">should_ignore_warning</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;W403&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="23-output-contract-to-model-training">2.3 è¼¸å‡ºå¥‘ç´„ (Output Contract to Model Training)</h3>
<p><strong>å¡«è£œ GAP #5: Feature Engineer â†’ Model Training</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FeatureEngineerOutputContract</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Feature Engineer v1.3-FA è¼¸å‡ºè¦ç¯„&quot;&quot;&quot;</span>

    <span class="c1"># 1. ç‰¹å¾µçŸ©é™£ (Parquet æ ¼å¼)</span>
    <span class="n">feature_matrix</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span>

    <span class="c1"># 2. ç›®æ¨™è®Šæ•¸è³‡è¨Š</span>
    <span class="n">target_variable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">target_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FeatureMetadata</span><span class="p">]</span>

    <span class="c1"># 3. Quality Flag ç‰¹å¾µ (SSOT åŒæ­¥)</span>
    <span class="n">quality_flag_features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="c1"># 4. ã€æ–°å¢ã€‘Annotation ç¨½æ ¸è³‡è¨Š (ä¾› Training Pipeline è¨˜éŒ„)</span>
    <span class="n">annotation_context</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inheritance_chain&quot;</span><span class="p">:</span> <span class="s2">&quot;base -&gt; cgmh_ty&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yaml_checksum&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:...&quot;</span><span class="p">,</span>
        <span class="s2">&quot;group_policies_applied&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;chillers&quot;</span><span class="p">,</span> <span class="s2">&quot;towers&quot;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># 5. é˜² Data Leakage è³‡è¨Š</span>
    <span class="n">train_test_split_info</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;temporal_cutoff&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="s2">&quot;strict_past_only&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;excluded_future_rows&quot;</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">}</span>

    <span class="c1"># 6. ç‰¹å¾µå…ƒè³‡æ–™ (ä¾› Model è§£é‡‹æ€§ä½¿ç”¨)</span>
    <span class="n">feature_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureMetadata</span><span class="p">]</span>

    <span class="c1"># 7. ç‰ˆæœ¬è¿½è¹¤</span>
    <span class="n">feature_engineer_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.3-FA&quot;</span>
    <span class="n">upstream_manifest_id</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>

<hr />
<h2 id="3-phase-based-implementation">3. åˆ†éšæ®µå¯¦ä½œè¨ˆç•« (Phase-Based Implementation)</h2>
<h3 id="phase-0-annotation-manager-day-1">Phase 0: Annotation Manager æ•´åˆåŸºç¤å»ºè¨­ (Day 1, æ–°å¢)</h3>
<h4 id="step-01-ssot-manager">Step 0.1: SSOT åš´æ ¼å¼•ç”¨èˆ‡ Manager æ³¨å…¥</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/feature_engineer.py</code> (é ‚éƒ¨)</p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Final</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1"># ã€é—œéµã€‘SSOT åš´æ ¼å¼•ç”¨</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.config_models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">VALID_QUALITY_FLAGS</span><span class="p">,</span>      <span class="c1"># SSOT: 6å€‹æ¨™æº–å“è³ªæ¨™è¨˜</span>
    <span class="n">TIMESTAMP_CONFIG</span><span class="p">,</span>         <span class="c1"># SSOT: UTC, ns</span>
    <span class="n">FeatureMetadata</span><span class="p">,</span>          <span class="c1"># SSOT: æ¬„ä½å…ƒè³‡æ–™ (ç‰©ç†å±¬æ€§)</span>
    <span class="n">FeatureEngineeringConfig</span><span class="p">,</span>
    <span class="n">FEATURE_ANNOTATION_CONSTANTS</span>
<span class="p">)</span>

<span class="c1"># ã€æ–°å¢ã€‘ç›´æ¥æŸ¥è©¢ Annotation SSOT</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.features.annotation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureAnnotationManager</span><span class="p">,</span> <span class="n">ColumnAnnotation</span>

<span class="c1"># éŒ¯èª¤ä»£ç¢¼ (Interface Contract v1.0)</span>
<span class="n">ERROR_CODES</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;E301&quot;</span><span class="p">:</span> <span class="s2">&quot;MANIFEST_INTEGRITY_FAILED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E302&quot;</span><span class="p">:</span> <span class="s2">&quot;SCHEMA_MISMATCH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E303&quot;</span><span class="p">:</span> <span class="s2">&quot;UNKNOWN_QUALITY_FLAG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E304&quot;</span><span class="p">:</span> <span class="s2">&quot;METADATA_MISSING&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E305&quot;</span><span class="p">:</span> <span class="s2">&quot;DATA_LEAKAGE_DETECTED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;E400&quot;</span><span class="p">:</span> <span class="s2">&quot;ANNOTATION_VERSION_MISMATCH&quot;</span><span class="p">,</span>  <span class="c1"># ã€æ–°å¢ã€‘</span>
    <span class="s2">&quot;E402&quot;</span><span class="p">:</span> <span class="s2">&quot;ANNOTATION_NOT_FOUND&quot;</span><span class="p">,</span>         <span class="c1"># ã€æ–°å¢ã€‘</span>
    <span class="s2">&quot;E500&quot;</span><span class="p">:</span> <span class="s2">&quot;DEVICE_ROLE_LEAKAGE&quot;</span>           <span class="c1"># ã€æ–°å¢ã€‘</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="step-02-annotationmanager">Step 0.2: å»ºæ§‹å­èˆ‡ AnnotationManager åˆå§‹åŒ–</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/feature_engineer.py</code> (<code>FeatureEngineer.__init__</code>)</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FeatureEngineer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Feature Engineer v1.3-FA - æ•´åˆ Feature Annotation æ¶ˆè²»</span>

<span class="sd">    æ ¸å¿ƒè·è²¬ï¼š</span>
<span class="sd">    1. å¾ Manifest è®€å–ç‰©ç†å±¬æ€§ (physical_type, unit)</span>
<span class="sd">    2. ã€æ–°å¢ã€‘ç›´æ¥æŸ¥è©¢ Annotation SSOT å–å¾— device_role èˆ‡ ignore_warnings</span>
<span class="sd">    3. æ‡‰ç”¨èªæ„æ„ŸçŸ¥çš„ Group Policy (æ ¹æ“š device_role èª¿æ•´ç­–ç•¥)</span>
<span class="sd">    4. ç¢ºä¿ä¸ç”¢ç”Ÿ Data Leakage</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">config</span><span class="p">:</span> <span class="n">FeatureEngineeringConfig</span><span class="p">,</span>
        <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">yaml_base_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config/features/sites&quot;</span>  <span class="c1"># ã€æ–°å¢ã€‘Annotation è·¯å¾‘</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="n">site_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;FeatureEngineer&quot;</span><span class="p">)</span>

        <span class="c1"># ã€é—œéµã€‘ç›´æ¥åˆå§‹åŒ– AnnotationManager (è·è²¬åˆ†é›¢ï¼šä¸ä¾èµ– Cleaner å‚³é)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span> <span class="o">=</span> <span class="n">FeatureAnnotationManager</span><span class="p">(</span>
            <span class="n">site_id</span><span class="o">=</span><span class="n">site_id</span><span class="p">,</span>
            <span class="n">yaml_base_dir</span><span class="o">=</span><span class="n">yaml_base_dir</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;åˆå§‹åŒ– FeatureEngineer (Schema: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span><span class="o">.</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ç¹¼æ‰¿éˆ: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_annotation_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audit_trail</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        é©—è­‰ Annotation ç‰ˆæœ¬ç›¸å®¹æ€§ (E400)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">audit_trail</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Manifest ç¼ºå°‘ annotation_audit_trail&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">schema_ver</span> <span class="o">=</span> <span class="n">audit_trail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">FEATURE_ANNOTATION_CONSTANTS</span><span class="p">[</span><span class="s1">&#39;expected_schema_version&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">schema_ver</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;E400: Annotation Schema ç‰ˆæœ¬ä¸ç¬¦ã€‚æœŸæœ›: </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">, å¯¦éš›: </span><span class="si">{</span><span class="n">schema_ver</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># é©—è­‰ç¹¼æ‰¿éˆä¸€è‡´æ€§ (å¯é¸ï¼Œç”¨æ–¼é™¤éŒ¯)</span>
        <span class="n">manifest_chain</span> <span class="o">=</span> <span class="n">audit_trail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inheritance_chain&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">manager_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span><span class="o">.</span><span class="n">inheritance_chain</span>
        <span class="k">if</span> <span class="n">manifest_chain</span> <span class="o">!=</span> <span class="n">manager_chain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ç¹¼æ‰¿éˆä¸ä¸€è‡´: Manifest=</span><span class="si">{</span><span class="n">manifest_chain</span><span class="si">}</span><span class="s2">, Manager=</span><span class="si">{</span><span class="n">manager_chain</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
</code></pre></div>

<hr />
<h3 id="phase-1-manifest-day-1-2">Phase 1: è¼¸å…¥é©—è­‰èˆ‡ Manifest è®€å– (Day 1-2)</h3>
<h4 id="step-11">Step 1.1: è®€å–èˆ‡é©—è­‰ï¼ˆæ›´æ–°ç‰ˆï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>load_from_manifest(manifest_path: Path) -&gt; Tuple[...]</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_from_manifest</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">manifest_path</span><span class="p">:</span> <span class="n">Path</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureMetadata</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å¾ BatchProcessor v1.3-FA Manifest è®€å–è³‡æ–™èˆ‡ Metadata</span>

<span class="sd">    ã€é—œéµã€‘å›å‚³ annotation_audit_trail ä¾›å¾ŒçºŒé©—è­‰</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.manifest</span><span class="w"> </span><span class="kn">import</span> <span class="n">Manifest</span>

    <span class="n">manifest</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">)</span>

    <span class="c1"># 1. é©—è­‰ Manifest å®Œæ•´æ€§ (E301)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">manifest</span><span class="o">.</span><span class="n">validate_checksum</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E301: Manifest å®Œæ•´æ€§é©—è­‰å¤±æ•—: </span><span class="si">{</span><span class="n">manifest_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 2. é©—è­‰ Annotation ç¨½æ ¸è»Œè·¡ (E400)</span>
    <span class="n">audit_trail</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="s1">&#39;annotation_audit_trail&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">audit_trail</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_annotation_compatibility</span><span class="p">(</span><span class="n">audit_trail</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Manifest ç¼ºå°‘ annotation_audit_trailï¼Œè·³éç‰ˆæœ¬æª¢æŸ¥&quot;</span><span class="p">)</span>

    <span class="c1"># 3. é©—è­‰ SSOT ç‰ˆæœ¬ç›¸å®¹æ€§ (quality_flags)</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">quality_flags_schema</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">VALID_QUALITY_FLAGS</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Manifest flags ç‰ˆæœ¬èˆ‡ SSOT ä¸åŒ: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Manifest=</span><span class="si">{</span><span class="n">manifest</span><span class="o">.</span><span class="n">quality_flags_schema</span><span class="si">}</span><span class="s2">, SSOT=</span><span class="si">{</span><span class="n">VALID_QUALITY_FLAGS</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># 4. é©—è­‰ timestamp Schema (E302)</span>
    <span class="n">ts_schema</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">timestamp_schema</span>
    <span class="k">if</span> <span class="n">ts_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;INT64&quot;</span> <span class="ow">or</span> <span class="n">ts_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timezone&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;UTC&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E302: Timestamp schema ä¸ç¬¦: </span><span class="si">{</span><span class="n">ts_schema</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 5. è®€å– Parquet</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">manifest_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">output_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manifest æœªåŒ…å«è¼¸å‡ºæª”æ¡ˆ: </span><span class="si">{</span><span class="n">manifest_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="c1"># 6. ã€é—œéµã€‘é©—è­‰ DataFrame ä¸å« device_role (E500)</span>
    <span class="k">if</span> <span class="s2">&quot;device_role&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;E500: DataFrame åŒ…å«ç¦æ­¢æ¬„ä½ &#39;device_role&#39;ã€‚ &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Cleaner ä¸æ‡‰å‚³é device_roleï¼ŒFeature Engineer æ‡‰ç›´æ¥æŸ¥è©¢ Annotationã€‚&quot;</span>
        <span class="p">)</span>

    <span class="c1"># 7. æª¢æŸ¥ feature_metadata (E304)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">feature_metadata</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">input_contract</span><span class="o">.</span><span class="n">enforce_manifest_metadata</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ContractViolationError</span><span class="p">(</span><span class="s2">&quot;E304: Manifest ç¼ºå°‘ feature_metadata&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;E304: ä½¿ç”¨ä¿å®ˆé è¨­&quot;</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_metadata_conservative</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">audit_trail</span>
</code></pre></div>

<hr />
<h3 id="phase-2-ssot-flags-day-2">Phase 2: SSOT åˆè¦çš„ Flags è™•ç† (Day 2)</h3>
<h4 id="step-21-quality-flags-ssot">Step 2.1: Quality Flags è™•ç†ï¼ˆSSOT å¼•ç”¨ï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_handle_quality_flags(df: pl.DataFrame) -&gt; pl.DataFrame</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_handle_quality_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è™•ç† Quality Flags (SSOT åˆè¦ç‰ˆæœ¬)</span>

<span class="sd">    ã€é—œéµã€‘å¼•ç”¨ VALID_QUALITY_FLAGSï¼Œç„¡ç¡¬ç·¨ç¢¼</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">input_contract</span><span class="o">.</span><span class="n">quality_flags_handling</span>

    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;drop&quot;</span><span class="p">:</span>
        <span class="n">has_flags</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">has_flags</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;onehot&quot;</span><span class="p">:</span>
        <span class="c1"># ã€SSOT å¼•ç”¨ã€‘å‹•æ…‹ç²å–æ‰€æœ‰åˆæ³• flags</span>
        <span class="n">all_flags</span> <span class="o">=</span> <span class="n">VALID_QUALITY_FLAGS</span>  <span class="c1"># âœ… æ­£ç¢º: å¼•ç”¨ SSOT</span>

        <span class="n">generated_flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">all_flags</span><span class="p">:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;is_</span><span class="si">{</span><span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_flag&quot;</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">generated_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">quality_flag_features</span> <span class="o">=</span> <span class="n">generated_flags</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

<hr />
<h3 id="phase-3-group-policy-day-3-4">Phase 3: èªæ„æ„ŸçŸ¥ Group Policy (Day 3-4, æ ¸å¿ƒæ›´æ–°)</h3>
<h4 id="step-31-group-policy-annotation-ssot">Step 3.1: Group Policy è§£æï¼ˆä½¿ç”¨ Annotation SSOTï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_resolve_group_policies(metadata: Dict) -&gt; Dict[str, StatsRule]</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_resolve_group_policies</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">manifest_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureMetadata</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StatsRule</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è§£æ Group Policiesï¼Œä½¿ç”¨ Annotation SSOT (physical_type + device_role)</span>

<span class="sd">    ã€é—œéµä¿®æ­£ã€‘v1.2 åƒ…ä½¿ç”¨ physical_typeï¼›v1.3-FA å¢åŠ  device_role æ„ŸçŸ¥</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolved</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats_features</span><span class="o">.</span><span class="n">group_policies</span><span class="p">:</span>
        <span class="n">target_cols</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">manifest_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># 1. åŒ¹é… physical_type (ä¾†è‡ª Manifest)</span>
            <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">physical_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">apply_to_types</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># 2. ã€æ–°å¢ã€‘æŸ¥è©¢ device_role (ä¾†è‡ª AnnotationManager)</span>
            <span class="n">col_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span><span class="o">.</span><span class="n">get_column_config</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">col_config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> åœ¨ Annotation ä¸­æœªå®šç¾©ï¼Œè·³é Group Policy&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">device_role</span> <span class="o">=</span> <span class="n">col_config</span><span class="o">.</span><span class="n">device_role</span>

            <span class="c1"># 3. ã€æ–°å¢ã€‘æ ¹æ“š device_role èª¿æ•´ç­–ç•¥</span>
            <span class="k">if</span> <span class="n">device_role</span> <span class="o">==</span> <span class="s2">&quot;backup&quot;</span> <span class="ow">and</span> <span class="n">policy</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;High_Freq&quot;</span><span class="p">:</span>
                <span class="c1"># å‚™ç”¨è¨­å‚™ä¸ä½¿ç”¨é«˜é »æ¡æ¨£ç­–ç•¥ï¼ˆå¯èƒ½é•·æœŸåœæ©Ÿï¼‰</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> (backup) è·³é High_Freq ç­–ç•¥&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">device_role</span> <span class="o">==</span> <span class="s2">&quot;seasonal&quot;</span> <span class="ow">and</span> <span class="n">policy</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Strict_Balance&quot;</span><span class="p">:</span>
                <span class="c1"># å­£ç¯€æ€§è¨­å‚™æ”¾å¯¬å¹³è¡¡æª¢æŸ¥</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> (seasonal) æ”¾å¯¬ Strict_Balance&quot;</span><span class="p">)</span>

            <span class="c1"># 4. æ’é™¤ç›®æ¨™è®Šæ•¸ (Data Leakage é˜²è­·)</span>
            <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">is_target</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">target_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1"># 5. æ‡‰ç”¨è¦å‰‡ (å«ç¹¼æ‰¿è™•ç†)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">target_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats_features</span><span class="o">.</span><span class="n">column_overrides</span> <span class="ow">and</span> 
                <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats_features</span><span class="o">.</span><span class="n">column_overrides</span><span class="p">):</span>
                <span class="n">resolved</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats_features</span><span class="o">.</span><span class="n">column_overrides</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ã€æ–°å¢ã€‘æ ¹æ“š device_role èª¿æ•´çª—å£å¤§å°</span>
                <span class="n">col_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span><span class="o">.</span><span class="n">get_column_config</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">base_rule</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">rules</span>

                <span class="k">if</span> <span class="n">col_config</span> <span class="ow">and</span> <span class="n">col_config</span><span class="o">.</span><span class="n">device_role</span> <span class="o">==</span> <span class="s2">&quot;backup&quot;</span><span class="p">:</span>
                    <span class="c1"># å‚™ç”¨è¨­å‚™ä½¿ç”¨è¼ƒå¤§çª—å£ï¼ˆå¹³æ»‘é•·æœŸåœæ©Ÿå½±éŸ¿ï¼‰</span>
                    <span class="n">adjusted_rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_rule_for_backup</span><span class="p">(</span><span class="n">base_rule</span><span class="p">)</span>
                    <span class="n">resolved</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjusted_rule</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resolved</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_rule</span>

    <span class="k">return</span> <span class="n">resolved</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_adjust_rule_for_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_rule</span><span class="p">:</span> <span class="n">StatsRule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StatsRule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ç‚ºå‚™ç”¨è¨­å‚™èª¿æ•´çµ±è¨ˆè¦å‰‡ (è¨­å‚™è§’è‰²æ„ŸçŸ¥)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># å‚™ç”¨è¨­å‚™ï¼šå¢å¤§ rolling windowï¼Œæ¸›å°‘ lag æ•¸é‡</span>
    <span class="n">adjusted</span> <span class="o">=</span> <span class="n">base_rule</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">rolling_windows</span><span class="p">:</span>
        <span class="c1"># çª—å£å¢å¤§ 2 å€ï¼ˆä½†ä¸è¶…è¿‡ 96ï¼‰</span>
        <span class="n">adjusted</span><span class="o">.</span><span class="n">rolling_windows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">rolling_windows</span>
        <span class="p">]</span>

    <span class="k">if</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">lag_intervals</span><span class="p">:</span>
        <span class="c1"># åªä¿ç•™å‰ 2 å€‹ lag</span>
        <span class="n">adjusted</span><span class="o">.</span><span class="n">lag_intervals</span> <span class="o">=</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">lag_intervals</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">adjusted</span>
</code></pre></div>

<h4 id="step-32-data-leakage">Step 3.2: çµ±è¨ˆç‰¹å¾µç”Ÿæˆï¼ˆData Leakage é˜²è­· + è­¦å‘ŠæŠ‘åˆ¶ï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_generate_stats_features(df: pl.DataFrame, column_rules: Dict) -&gt; pl.DataFrame</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_generate_stats_features</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
    <span class="n">column_rules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StatsRule</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ç”Ÿæˆçµ±è¨ˆç‰¹å¾µï¼Œæ”¯æ´ device_role æ„ŸçŸ¥èˆ‡ ignore_warnings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expressions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="n">column_rules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># ã€æ–°å¢ã€‘æŸ¥è©¢ ignore_warnings (ä¾†è‡ª Annotation)</span>
        <span class="n">col_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span><span class="o">.</span><span class="n">get_column_config</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">ignore_warnings</span> <span class="o">=</span> <span class="n">col_config</span><span class="o">.</span><span class="n">ignore_warnings</span> <span class="k">if</span> <span class="n">col_config</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="c1"># Lag ç‰¹å¾µ (Data Leakage é˜²è­·ï¼šshift)</span>
        <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">rules</span><span class="o">.</span><span class="n">lag_intervals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lag</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="c1"># ã€æ–°å¢ã€‘æª¢æŸ¥æ˜¯å¦æ‡‰å¿½ç•¥ W402 (çª—å£éå¤§è­¦å‘Š)</span>
                <span class="k">if</span> <span class="s2">&quot;W402&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_warnings</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;W402: æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> lag </span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2"> è¶…éè³‡æ–™é•·åº¦ 50%&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Rolling ç‰¹å¾µ (åš´æ ¼ shift(1) é˜²è­·)</span>
        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">rules</span><span class="o">.</span><span class="n">rolling_windows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;W402&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_warnings</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;W402: æ¬„ä½ </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> window </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2"> è¶…é 50%&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># é€™è£¡çœç•¥å…·é«” rolling è¨ˆç®—ï¼Œèˆ‡åŸé‚è¼¯ç›¸åŒ</span>
            <span class="c1"># ...</span>

    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">expressions</span><span class="p">)</span> <span class="k">if</span> <span class="n">expressions</span> <span class="k">else</span> <span class="n">df</span>
</code></pre></div>

<hr />
<h3 id="phase-4-model-training-day-4-5">Phase 4: è¼¸å‡ºæº–å‚™èˆ‡ Model Training éŠœæ¥ (Day 4-5)</h3>
<h4 id="step-41">Step 4.1: è¼¸å‡ºå¥‘ç´„å»ºæ§‹ï¼ˆæ›´æ–°ç‰ˆï¼‰</h4>
<p><strong>æ–¹æ³•</strong>: <code>_build_output_contract(...) -&gt; FeatureEngineerOutputContract</code></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_build_output_contract</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
    <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">,</span>
    <span class="n">audit_trail</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">target_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeatureEngineerOutputContract</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å»ºæ§‹è¼¸å‡ºå¥‘ç´„ï¼ŒåŒ…å« Annotation ä¸Šä¸‹æ–‡</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ç›®æ¨™è®Šæ•¸è™•ç†</span>
    <span class="n">target_metadata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">target_col</span> <span class="ow">and</span> <span class="n">target_col</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">feature_metadata</span><span class="p">:</span>
        <span class="n">target_metadata</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">feature_metadata</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>

    <span class="c1"># ç‰¹å¾µå…ƒè³‡æ–™ (æ¨™è¨˜ derived)</span>
    <span class="n">feature_metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">target_col</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">feature_metadata</span><span class="p">:</span>
            <span class="n">feature_metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">feature_metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">FeatureMetadata</span><span class="p">(</span>
                <span class="n">column_name</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                <span class="n">physical_type</span><span class="o">=</span><span class="s2">&quot;derived&quot;</span><span class="p">,</span>
                <span class="n">is_target</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

    <span class="c1"># ã€æ–°å¢ã€‘Annotation ä¸Šä¸‹æ–‡ (ä¾› Training Pipeline è¨˜éŒ„)</span>
    <span class="n">annotation_context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="n">audit_trail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_version&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
        <span class="s2">&quot;inheritance_chain&quot;</span><span class="p">:</span> <span class="n">audit_trail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inheritance_chain&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">),</span>
        <span class="s2">&quot;yaml_checksum&quot;</span><span class="p">:</span> <span class="n">audit_trail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;yaml_checksum&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s2">&quot;group_policies_applied&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats_features</span><span class="o">.</span><span class="n">group_policies</span>
        <span class="p">],</span>
        <span class="s2">&quot;device_role_aware&quot;</span><span class="p">:</span> <span class="kc">True</span>  <span class="c1"># æ¨™è¨˜å·²æ‡‰ç”¨è¨­å‚™è§’è‰²æ„ŸçŸ¥</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FeatureEngineerOutputContract</span><span class="p">(</span>
        <span class="n">feature_matrix</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">target_variable</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span><span class="p">,</span>
        <span class="n">quality_flag_features</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;quality_flag_features&#39;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="n">annotation_context</span><span class="o">=</span><span class="n">annotation_context</span><span class="p">,</span>  <span class="c1"># ã€æ–°å¢ã€‘</span>
        <span class="n">train_test_split_info</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;temporal_cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cutoff_timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cutoff_timestamp</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;strict_past_only&quot;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">},</span>
        <span class="n">feature_metadata</span><span class="o">=</span><span class="n">feature_metadata</span><span class="p">,</span>
        <span class="n">upstream_manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">batch_id</span><span class="p">,</span>
        <span class="n">feature_engineer_version</span><span class="o">=</span><span class="s2">&quot;1.3-FA&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-error-codes">4. éŒ¯èª¤ä»£ç¢¼å°ç…§è¡¨ (Error Codes)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤ä»£ç¢¼</th>
<th style="text-align: left;">åç¨±</th>
<th style="text-align: center;">ç™¼ç”Ÿéšæ®µ</th>
<th style="text-align: left;">èªªæ˜</th>
<th style="text-align: left;">è™•ç†å»ºè­°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>E301</strong></td>
<td style="text-align: left;"><code>MANIFEST_INTEGRITY_FAILED</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">Manifest checksum é©—è­‰å¤±æ•—</td>
<td style="text-align: left;">é‡æ–°åŸ·è¡Œ BatchProcessor</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E302</strong></td>
<td style="text-align: left;"><code>SCHEMA_MISMATCH</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">Parquet Schema é INT64/UTC</td>
<td style="text-align: left;">é‡æ–°åŸ·è¡Œ BatchProcessor</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E303</strong></td>
<td style="text-align: left;"><code>UNKNOWN_QUALITY_FLAG</code></td>
<td style="text-align: center;">Step 2.1</td>
<td style="text-align: left;">è¼¸å…¥å«æœªå®šç¾© flags</td>
<td style="text-align: left;">ç¢ºèª SSOT ç‰ˆæœ¬ä¸€è‡´æ€§</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E304</strong></td>
<td style="text-align: left;"><code>METADATA_MISSING</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">Manifest ç„¡ feature_metadata</td>
<td style="text-align: left;">å‡ç´š BatchProcessor</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E305</strong></td>
<td style="text-align: left;"><code>DATA_LEAKAGE_DETECTED</code></td>
<td style="text-align: center;">Step 3.2</td>
<td style="text-align: left;">åŒ…å«æœªä¾†è³‡æ–™</td>
<td style="text-align: left;">æª¢æŸ¥ cutoff_timestamp</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E400</strong></td>
<td style="text-align: left;"><code>ANNOTATION_VERSION_MISMATCH</code></td>
<td style="text-align: center;">Step 0.2/1.1</td>
<td style="text-align: left;">Manifest çš„ Annotation ç‰ˆæœ¬éèˆŠ</td>
<td style="text-align: left;">åŸ·è¡Œ migrate-excel</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E402</strong></td>
<td style="text-align: left;"><code>ANNOTATION_NOT_FOUND</code></td>
<td style="text-align: center;">Step 3.1</td>
<td style="text-align: left;">æ¬„ä½æœªå®šç¾©æ–¼ Annotation</td>
<td style="text-align: left;">åŸ·è¡Œ features wizard</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E500</strong></td>
<td style="text-align: left;"><code>DEVICE_ROLE_LEAKAGE</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">DataFrame å« device_role æ¬„ä½</td>
<td style="text-align: left;">æª¢æŸ¥ Cleaner è·è²¬åˆ†é›¢</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-test-plan">5. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Test Plan)</h2>
<h3 id="51-unit-tests">5.1 å–®å…ƒæ¸¬è©¦ (Unit Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸçµæœ</th>
<th style="text-align: center;">å°æ‡‰ Step</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>FE13-FA-01</strong></td>
<td style="text-align: left;">E400 ç‰ˆæœ¬æª¢æŸ¥</td>
<td style="text-align: left;">Manifest schema_version=1.1</td>
<td style="text-align: left;">æ‹‹å‡º E400</td>
<td style="text-align: center;">0.2</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FE13-FA-02</strong></td>
<td style="text-align: left;">device_role æŸ¥è©¢</td>
<td style="text-align: left;">å‘¼å« annotation_manager</td>
<td style="text-align: left;">æ­£ç¢ºå–å¾— primary/backup/seasonal</td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FE13-FA-03</strong></td>
<td style="text-align: left;">Group Policy è¨­å‚™æ„ŸçŸ¥</td>
<td style="text-align: left;">backup è¨­å‚™å¥—ç”¨ High_Freq</td>
<td style="text-align: left;">ç­–ç•¥è¢«è·³é</td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FE13-FA-04</strong></td>
<td style="text-align: left;">ignore_warnings ç”Ÿæ•ˆ</td>
<td style="text-align: left;">æ¨™è¨˜ W403 å¿½ç•¥</td>
<td style="text-align: left;">ä¸è§¸ç™¼é«˜é›¶å€¼è­¦å‘Š</td>
<td style="text-align: center;">3.2</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FE13-FA-05</strong></td>
<td style="text-align: left;">ç¹¼æ‰¿éˆé©—è­‰</td>
<td style="text-align: left;">cgmh_ty ç¹¼æ‰¿ base</td>
<td style="text-align: left;">æ­£ç¢ºè§£æç¹¼æ‰¿çš„ physical_types</td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;">FE13-001</td>
<td style="text-align: left;">SSOT Flags å¼•ç”¨</td>
<td style="text-align: left;">VALID_QUALITY_FLAGS æ›´æ–°</td>
<td style="text-align: left;">One-hot è‡ªå‹•åŒ…å«æ–° flag</td>
<td style="text-align: center;">2.1</td>
</tr>
<tr>
<td style="text-align: left;">FE13-002</td>
<td style="text-align: left;">Metadata æ¥æ”¶</td>
<td style="text-align: left;">Manifest å« physical_type</td>
<td style="text-align: left;">Group Policy æ­£ç¢ºå¥—ç”¨</td>
<td style="text-align: center;">3.1</td>
</tr>
</tbody>
</table>
<h3 id="52-integration-tests">5.2 æ•´åˆæ¸¬è©¦ (Integration Tests)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: center;">ä¸Šæ¸¸</th>
<th style="text-align: center;">ä¸‹æ¸¸</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>INT-FE-FA-01</strong></td>
<td style="text-align: left;">å®Œæ•´ Metadata æ¶ˆè²»</td>
<td style="text-align: center;">BP v1.3-FA (audit_trail) + Annotation YAML</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: left;">æ­£ç¢ºè®€å– device_roleï¼Œæ‡‰ç”¨èªæ„ç­–ç•¥</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-FE-FA-02</strong></td>
<td style="text-align: left;">Backup è¨­å‚™ç‰¹å¾µ</td>
<td style="text-align: center;">Backup è¨­å‚™è³‡æ–™</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: left;">ä½¿ç”¨æ”¾å¤§çª—å£ï¼Œä¸è§¸ç™¼ W403</td>
</tr>
<tr>
<td style="text-align: left;"><strong>INT-FE-FA-03</strong></td>
<td style="text-align: left;">ç¹¼æ‰¿éˆä¸€è‡´æ€§</td>
<td style="text-align: center;">base.yaml + site.yaml</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: left;">æ­£ç¢ºåˆä½µ Group Policies</td>
</tr>
<tr>
<td style="text-align: left;">INT-F01</td>
<td style="text-align: left;">BP v1.3 â†’ FE v1.3</td>
<td style="text-align: center;">BP v1.3</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: left;">æ­£ç¢ºæ¥æ”¶ metadata</td>
</tr>
<tr>
<td style="text-align: left;">INT-F02</td>
<td style="text-align: left;">FE â†’ Model Training</td>
<td style="text-align: center;">FE v1.3-FA</td>
<td style="text-align: center;">Training Pipeline</td>
<td style="text-align: left;">å‚³é annotation_context</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-risk-assessment">6. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£ (Risk Assessment)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢¨éšª</th>
<th style="text-align: center;">åš´é‡åº¦</th>
<th style="text-align: center;">å¯èƒ½æ€§</th>
<th style="text-align: left;">ç·©è§£æªæ–½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Annotation ç‰ˆæœ¬æ¼‚ç§»</strong> (E400)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">å•Ÿå‹•æ™‚åš´æ ¼æª¢æŸ¥ schema_version</td>
</tr>
<tr>
<td style="text-align: left;"><strong>device_role æŸ¥è©¢å¤±æ•—</strong></td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;">æ¬„ä½æœªå®šç¾©æ™‚æ‹‹å‡º E402ï¼Œä¸å…è¨±é è¨­å€¼</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSOT ä¸åŒæ­¥</strong> (flags)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">æ¯”å° manifest.quality_flags_schema èˆ‡ VALID_QUALITY_FLAGS</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Leakage</strong> (shift éŒ¯èª¤)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;">å–®å…ƒæ¸¬è©¦é©—è­‰ T æ™‚åˆ»ç‰¹å¾µä¸åŒ…å« T æ™‚åˆ»å€¼</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç¹¼æ‰¿éˆè¤‡é›œåº¦</strong></td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">è¨˜éŒ„ inheritance_chain ä¾›é™¤éŒ¯ï¼Œé©—è­‰åˆä½µçµæœ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-version-compatibility">7. ç‰ˆæœ¬ç›¸å®¹æ€§çŸ©é™£ (Version Compatibility)</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">Feature Engineer</th>
<th style="text-align: center;">Feature Annotation</th>
<th style="text-align: center;">ç›¸å®¹æ€§</th>
<th style="text-align: left;">èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v1.3-FA (audit_trail)</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âœ… <strong>å®Œå…¨ç›¸å®¹</strong></td>
<td style="text-align: left;">æ¨è–¦é…ç½®ï¼Œæ”¯æ´ device_role æ„ŸçŸ¥</td>
</tr>
<tr>
<td style="text-align: center;">v1.3-FA</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">âš ï¸ <strong>é™ç´šç›¸å®¹</strong></td>
<td style="text-align: left;">ç¼ºå°‘ device_roleï¼Œä½¿ç”¨é è¨­ primary</td>
</tr>
<tr>
<td style="text-align: center;">v1.3</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âš ï¸ <strong>éƒ¨åˆ†ç›¸å®¹</strong></td>
<td style="text-align: left;">ç¼ºå°‘ audit_trailï¼Œè·³éç‰ˆæœ¬æª¢æŸ¥</td>
</tr>
<tr>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;"><strong>v1.3-FA</strong></td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">âŒ <strong>ä¸ç›¸å®¹</strong></td>
<td style="text-align: left;">ç„¡æ³•è®€å– feature_metadataï¼Œæ‹‹å‡º E304</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-deliverables">8. äº¤ä»˜ç‰©æ¸…å–® (Deliverables)</h2>
<h3 id="81">8.1 ç¨‹å¼ç¢¼æª”æ¡ˆ</h3>
<ol>
<li><code>src/etl/feature_engineer.py</code> - ä¸»è¦å¯¦ä½œ (v1.3-FAï¼Œå« AnnotationManager æ•´åˆ)</li>
<li><code>src/etl/config_models.py</code> - æ›´æ–° FeatureEngineeringConfig (æ”¯æ´ device_role æ„ŸçŸ¥)</li>
<li><code>src/etl/manifest.py</code> - æ›´æ–° Manifest æ¨¡å‹ (æ¥æ”¶ annotation_audit_trail)</li>
</ol>
<h3 id="82">8.2 æ¸¬è©¦æª”æ¡ˆ</h3>
<ol>
<li><code>tests/test_feature_engineer_v13_fa.py</code> - v1.3-FA å°ˆå±¬æ¸¬è©¦ (device_role æ„ŸçŸ¥)</li>
<li><code>tests/test_group_policy_device_role.py</code> - Group Policy è¨­å‚™è§’è‰²æ¸¬è©¦</li>
<li><code>tests/test_annotation_integration_fe.py</code> - èˆ‡ AnnotationManager æ•´åˆæ¸¬è©¦</li>
</ol>
<h3 id="83">8.3 æ–‡ä»¶æª”æ¡ˆ</h3>
<ol>
<li><code>docs/feature_engineering/PRD_FEATURE_ENGINEER_v1.3-FA.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/feature_engineering/DEVICE_ROLE_GUIDE.md</code> - device_role èˆ‡ Group Policy ä½¿ç”¨èªªæ˜</li>
</ol>
<hr />
<h2 id="9-sign-off-checklist">9. é©—æ”¶ç°½æ ¸ (Sign-off Checklist)</h2>
<ul>
<li>[ ] <strong>SSOT å¼•ç”¨</strong>: ç„¡ç¡¬ç·¨ç¢¼ flagsï¼Œå…¨éƒ¨å¼•ç”¨ <code>VALID_QUALITY_FLAGS</code></li>
<li>[ ] <strong>Metadata åˆ†å±¤æ¶ˆè²»</strong>: </li>
<li>[ ] physical_type/unit å¾ Manifest è®€å–</li>
<li>[ ] device_role/ignore_warnings å¾ AnnotationManager æŸ¥è©¢</li>
<li>[ ] <strong>è·è²¬åˆ†é›¢å°Šé‡</strong>: ä¸æœŸå¾…è¼¸å…¥ DataFrame åŒ…å« device_roleï¼Œç›´æ¥æŸ¥è©¢ YAML SSOT</li>
<li>[ ] <strong>Group Policy èªæ„æ„ŸçŸ¥</strong>: </li>
<li>[ ] backup è¨­å‚™æ­£ç¢ºè·³é High_Freq ç­–ç•¥</li>
<li>[ ] seasonal è¨­å‚™æ­£ç¢ºæ”¾å¯¬ Strict_Balance</li>
<li>[ ] <strong>è­¦å‘ŠæŠ‘åˆ¶</strong>: æ¨™è¨˜ ignore_warnings çš„æ¬„ä½æ­£ç¢ºæŠ‘åˆ¶ W402/W403</li>
<li>[ ] <strong>ç‰ˆæœ¬æª¢æŸ¥</strong>: Manifest çš„ schema_version ä¸ç¬¦æ™‚æ­£ç¢ºæ‹‹å‡º E400</li>
<li>[ ] <strong>ç¹¼æ‰¿éˆè™•ç†</strong>: æ­£ç¢ºæ¶ˆè²»ç¹¼æ‰¿è‡ª base.yaml çš„ Group Policies</li>
<li>[ ] <strong>Data Leakage</strong>: <code>shift(1)</code> æ­£ç¢ºå¯¦ä½œï¼Œé©—è­‰é€šé</li>
<li>[ ] <strong>è¼¸å‡ºå¥‘ç´„</strong>: æ­£ç¢ºç”¢ç”Ÿ <code>annotation_context</code> ä¾› Training Pipeline è¨˜éŒ„</li>
<li>[ ] <strong>ä¸‹æ¸¸éŠœæ¥</strong>: Model Training å¯æ­£ç¢ºè®€å–è¼¸å‡ºï¼ŒåŒ…å«è¨­å‚™è§’è‰²è³‡è¨Š</li>
</ul>
<hr />
<p><strong>é—œéµè¨­è¨ˆç¢ºèª</strong>ï¼š
1. Feature Engineer <strong>ä¸»å‹•æŸ¥è©¢</strong> device_role (å›  Cleaner ä¸å‚³é)
2. Group Policy åŒæ™‚ä½¿ç”¨ <strong>physical_type</strong> (Manifest) èˆ‡ <strong>device_role</strong> (Annotation)
3. <strong>ignore_warnings</strong> ç›´æ¥æŸ¥è©¢ Annotationï¼Œä¸ç¶“ç”± Manifest å‚³é
4. <strong>ç¹¼æ‰¿éˆ</strong> é€é AnnotationManager è™•ç†ï¼Œèˆ‡ Manifest çš„ audit_trail äº¤å‰é©—è­‰</p>
    
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>

</body>
</html>
