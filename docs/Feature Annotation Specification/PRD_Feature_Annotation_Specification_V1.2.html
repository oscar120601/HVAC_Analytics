
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PRD_Feature_Annotation_Specification_V1.2</title>
    
<style>
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
        line-height: 1.6; 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        color: #24292e; 
        background-color: #ffffff;
    }
    h1, h2, h3, h4, h5, h6 { 
        margin-top: 24px; 
        margin-bottom: 16px; 
        font-weight: 600; 
        color: #24292e;
    }
    h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h3 { font-size: 1.25em; }
    p { margin-top: 0; margin-bottom: 16px; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { 
        display: block; 
        width: 100%; 
        overflow: auto; 
        border-spacing: 0; 
        border-collapse: collapse; 
        margin-bottom: 16px; 
    }
    table th, table td { 
        padding: 6px 13px; 
        border: 1px solid #dfe2e5; 
    }
    table th { 
        font-weight: 600; 
        background-color: #f6f8fa; 
    }
    table tr:nth-child(2n) { 
        background-color: #f6f8fa; 
    }
    code { 
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace; 
        background-color: #f6f8fa; 
        padding: 0.2em 0.4em; 
        border-radius: 3px; 
        font-size: 85%; 
    }
    pre { 
        background-color: #f6f8fa; 
        padding: 16px; 
        overflow: auto; 
        border-radius: 3px; 
        line-height: 1.45; 
    }
    pre code { 
        background-color: transparent; 
        padding: 0; 
        border-radius: 0; 
    }
    blockquote { 
        border-left: 0.25em solid #dfe2e5; 
        color: #6a737d; 
        padding: 0 1em; 
        margin: 0 0 16px 0; 
    }
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
    }
    .mermaid {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
</style>

</head>
<body>
    <h1 id="prd-v12-feature-annotation-specification">PRD v1.2: ç‰¹å¾µæ¨™è¨»ç³»çµ±è¦ç¯„ (Feature Annotation Specification)</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v1.2 (Excel-Centric Editor with Synchronized SSOT)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™:</strong> å»ºç«‹ä»¥ Excel ç‚ºå”¯ä¸€ç·¨è¼¯å…¥å£çš„ç‰¹å¾µå®šç¾©ç³»çµ±ï¼Œé€éåš´æ ¼çš„å–®å‘æµç¨‹é¿å…ç«¶æ…‹æ¢ä»¶ï¼Œä¸¦æä¾›å®Œæ•´çš„ç‰ˆæœ¬æ§åˆ¶èˆ‡é·ç§»æ©Ÿåˆ¶<br />
<strong>ç›¸ä¾æ¨¡çµ„:</strong> Cleaner v2.2+, BatchProcessor v1.3+, Feature Engineer v1.3+<br />
<strong>é ä¼°å·¥æ™‚:</strong> 6 ~ 7 å€‹å·¥ç¨‹å¤©ï¼ˆå« Wizard é‡æ§‹ã€ç‰ˆæœ¬æ§åˆ¶ã€é·ç§»å·¥å…·ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è¨­è¨ˆå“²å­¸</h2>
<h3 id="11">1.1 æ ¸å¿ƒç›®æ¨™èˆ‡æ¶æ§‹åŸå‰‡</h3>
<ol>
<li><strong>Excel å”¯ä¸€ç·¨è¼¯åŸå‰‡</strong>: Excel æª”æ¡ˆ (<code>.xlsx</code>) æ˜¯<strong>å”¯ä¸€</strong>å…è¨±äººå·¥ç·¨è¼¯çš„ä»‹é¢ï¼ŒYAML åƒ…ç‚ºæ©Ÿå™¨è®€å–çš„ SSOTï¼Œç¦æ­¢ç›´æ¥ä¿®æ”¹</li>
<li><strong>å–®å‘åŒæ­¥æµç¨‹</strong>: æ‰€æœ‰è®Šæ›´å¿…é ˆéµå¾ª <code>Excel â†’ YAML â†’ Git</code> çš„å–®å‘è·¯å¾‘ï¼Œç¦æ­¢ä»»ä½•å·¥å…·ï¼ˆåŒ…æ‹¬ Wizardï¼‰ç›´æ¥å¯«å…¥ YAML</li>
<li><strong>éœæ…‹é©—è­‰ç­–ç•¥</strong>: Excel åƒ…æä¾›åŸºç¤æ ¼å¼èˆ‡éœæ…‹é¸å–®ï¼Œæ‰€æœ‰æ¥­å‹™é‚è¼¯é©—è­‰ï¼ˆå¦‚å–®ä½ç›¸å®¹æ€§ï¼‰ç§»è‡³ Python è½‰æ›å±¤åŸ·è¡Œ</li>
<li><strong>ç«¶æ…‹æ¢ä»¶é˜²è­·</strong>: é€éæ™‚é–“æˆ³æª¢æŸ¥èˆ‡ç‰ˆæœ¬é–å®šï¼Œé˜²æ­¢ Excel èˆ‡ YAML ä¸åŒæ­¥å°è‡´çš„è¨­å®šè¦†è“‹</li>
<li><strong>è¨­å‚™è§’è‰²æ„ŸçŸ¥</strong>: é€é <code>device_role</code> æ¨™è¨˜å€åˆ†ä¸»è¨­å‚™èˆ‡å‚™ç”¨è¨­å‚™ï¼ŒæŠ‘åˆ¶å‚™ç”¨è¨­å‚™çš„çµ±è¨ˆèª¤å ±</li>
<li><strong>ç½é›£æ¢å¾©å°±ç·’</strong>: å»ºç«‹ Git çœŸç›¸æºèˆ‡æœ¬åœ°å‚™ä»½é›™é‡é˜²è­·ï¼Œç¢ºä¿èª¤åˆªæ“ä½œå¯å›é€€</li>
</ol>
<h3 id="12">1.2 åš´æ ¼æµç¨‹æ¶æ§‹ï¼ˆé—œéµä¿®æ­£ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="w"> </span><span class="n">TD</span>
<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;ç·¨è¼¯å±¤ (å”¯ä¸€å…¥å£)&quot;</span>
<span class="w">        </span><span class="n">A</span><span class="p">[</span><span class="n">Excel</span><span class="w"> </span><span class="n">Template</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="p">.</span><span class="n">xlsx</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">ç·¨è¼¯</span><span class="o">|</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">è¨­å‚™å·¥ç¨‹å¸«</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">ç©ºèª¿æŠ€å¸«</span><span class="p">]</span>
<span class="w">        </span><span class="n">C</span><span class="p">[</span><span class="n">Wizard</span><span class="w"> </span><span class="n">CLI</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">ç”Ÿæˆ</span><span class="o">/</span><span class="n">æ›´æ–°</span><span class="o">|</span><span class="w"> </span><span class="n">A</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;é©—è­‰èˆ‡è½‰æ›å±¤&quot;</span>
<span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">æ‰‹å‹•è§¸ç™¼</span><span class="o">|</span><span class="w"> </span><span class="n">D</span><span class="p">[</span><span class="n">excel_to_yaml</span><span class="p">.</span><span class="n">py</span><span class="p">]</span>
<span class="w">        </span><span class="n">D</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">èªæ„é©—è­‰</span><span class="o">|</span><span class="w"> </span><span class="n">E</span><span class="p">{</span><span class="n">é©—è­‰é€šé</span><span class="o">?</span><span class="p">}</span>
<span class="w">        </span><span class="n">E</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">å¦</span><span class="o">|</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="n">è¿”å›</span><span class="w"> </span><span class="n">Excel</span><span class="w"> </span><span class="n">ä¿®æ­£</span><span class="p">]</span>
<span class="w">        </span><span class="n">E</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">æ˜¯</span><span class="o">|</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">ç”Ÿæˆ</span><span class="w"> </span><span class="n">YAML</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">config</span><span class="o">/</span><span class="n">features</span><span class="o">/</span><span class="p">]</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;çœŸç›¸æºå±¤ (SSOT)&quot;</span>
<span class="w">        </span><span class="n">G</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Git</span><span class="w"> </span><span class="n">PR</span><span class="o">|</span><span class="w"> </span><span class="n">H</span><span class="p">[</span><span class="n">Git</span><span class="w"> </span><span class="n">Repository</span><span class="p">]</span>
<span class="w">        </span><span class="n">H</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">CI</span><span class="o">/</span><span class="n">CD</span><span class="o">|</span><span class="w"> </span><span class="n">I</span><span class="p">[</span><span class="n">Config</span><span class="w"> </span><span class="n">Server</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">å”¯è®€éƒ¨ç½²</span><span class="p">]</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;ç½é›£æ¢å¾©å±¤&quot;</span>
<span class="w">        </span><span class="n">J</span><span class="p">[</span><span class="n">yaml_to_excel</span><span class="p">.</span><span class="n">py</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;--</span><span class="n">mode</span><span class="w"> </span><span class="n">recovery</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Git</span><span class="w"> </span><span class="n">å›é€€å¾Œé‡å»º</span><span class="o">|</span><span class="w"> </span><span class="n">A</span>
<span class="w">        </span><span class="n">K</span><span class="p">[.</span><span class="n">backups</span><span class="o">/</span><span class="w"> </span><span class="n">ç›®éŒ„</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">æœ¬åœ°å‚™ä»½é‚„åŸ</span><span class="o">|</span><span class="w"> </span><span class="n">A</span>
<span class="w">        </span><span class="n">L</span><span class="p">[</span><span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">é‚„åŸæ­·å²ç‰ˆæœ¬</span><span class="o">|</span><span class="w"> </span><span class="n">H</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">f9f</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mi">333</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">4</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">bbf</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mi">333</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">ff9</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="n">f00</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">J</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">bfb</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mi">333</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
</code></pre></div>

<p><strong>é—œéµç´„æŸ</strong>ï¼š
- ğŸ”´ <strong>Wizard ç¦æ­¢ç›´æ¥å¯«å…¥ YAML</strong>ï¼ˆè§£æ±º v1.1 ç«¶æ…‹æ¢ä»¶ï¼‰
- ğŸ”´ <strong>ç¦æ­¢ç›´æ¥ä¿®æ”¹ YAML æª”æ¡ˆ</strong>ï¼ˆæ‰€æœ‰è®Šæ›´å¿…é ˆé€é Excelï¼‰
- ğŸŸ¢ <strong>Git ä½œç‚ºæœ€çµ‚çœŸç›¸æº</strong>ï¼ˆYAML é€² Gitï¼ŒExcel ä¸é€² Gitï¼‰
- ğŸŸ¡ <strong>é€†å‘åŒæ­¥ (yaml_to_excel) åƒ…ç”¨æ–¼åˆå§‹åŒ–èˆ‡ç½é›£æ¢å¾©</strong>ï¼Œä¸å¯ä½œç‚ºå¸¸æ…‹ç·¨è¼¯æµç¨‹
- ğŸŸ¡ <strong>æœ¬åœ°å‚™ä»½ä¿ç•™æœ€è¿‘ 10 å€‹ç‰ˆæœ¬</strong>ï¼ˆWizard è‡ªå‹•ç®¡ç†ï¼‰</p>
<hr />
<h2 id="2">2. æ–‡ä»¶æ¶æ§‹èˆ‡ç‰ˆæœ¬æ§åˆ¶</h2>
<h3 id="21">2.1 ç›®éŒ„çµæ§‹ï¼ˆæ›´æ–°ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="o">/</span><span class="n">features</span><span class="o">/</span><span class="w">                    </span><span class="c1"># SSOT ç›®éŒ„ï¼ˆå”¯è®€éƒ¨ç½²ï¼ŒGit ç®¡æ§ï¼‰</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">schema</span><span class="o">.</span><span class="n">json</span><span class="w">                     </span><span class="c1"># JSON Schema é©—è­‰</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">base</span><span class="o">.</span><span class="n">yaml</span><span class="w">                       </span><span class="c1"># åŸºç¤å®šç¾©</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">physical_types</span><span class="o">.</span><span class="n">yaml</span><span class="w">             </span><span class="c1"># ç‰©ç†é¡å‹è¦ç¯„</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">sites</span><span class="o">/</span><span class="w">                          </span><span class="c1"># æ¡ˆå ´å®šç¾©ï¼ˆåƒ…ç”± Excel ç”Ÿæˆï¼Œå¿…é ˆé€² Gitï¼‰</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">cgmh_ty</span><span class="o">.</span><span class="n">yaml</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">kmuh</span><span class="o">.</span><span class="n">yaml</span>

<span class="n">tools</span><span class="o">/</span><span class="n">features</span><span class="o">/</span><span class="w">                     </span><span class="c1"># ç·¨è¼¯å·¥å…·</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">templates</span><span class="o">/</span><span class="w">                      </span><span class="c1"># Excel ç¯„æœ¬ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Feature_Template_v1</span><span class="o">.</span><span class="mf">2.</span><span class="n">xlsx</span><span class="w">  </span><span class="c1"># ç•¶å‰ç‰ˆæœ¬</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Feature_Template_v1</span><span class="o">.</span><span class="mf">1.</span><span class="n">xlsx</span><span class="w">  </span><span class="c1"># èˆŠç‰ˆï¼ˆä¾›é·ç§»ï¼‰</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">wizard</span><span class="o">.</span><span class="n">py</span><span class="w">                       </span><span class="c1"># Wizard CLIï¼ˆåƒ…æ›´æ–° Excelï¼Œå«è‡ªå‹•å‚™ä»½ï¼‰</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">excel_to_yaml</span><span class="o">.</span><span class="n">py</span><span class="w">                </span><span class="c1"># è½‰æ›å™¨ï¼ˆå«é©—è­‰ï¼‰</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">yaml_to_excel</span><span class="o">.</span><span class="n">py</span><span class="w">                </span><span class="c1"># é€†å‘è½‰æ›ï¼ˆåƒ…åˆå§‹åŒ–/ç½é›£æ¢å¾©ï¼‰</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">migrate_excel</span><span class="o">.</span><span class="n">py</span><span class="w">                </span><span class="c1"># ç¯„æœ¬å‡ç´šå·¥å…·</span>

<span class="n">data</span><span class="o">/</span><span class="n">features</span><span class="o">/</span><span class="w">                      </span><span class="c1"># ä½¿ç”¨è€…ç·¨è¼¯å€ï¼ˆGitignoredï¼‰</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">cgmh_ty</span><span class="o">/</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">cgmh_ty</span><span class="o">.</span><span class="n">xlsx</span><span class="w">               </span><span class="c1"># å·¥ä½œæª”æ¡ˆï¼ˆå”¯ä¸€ç·¨è¼¯å…¥å£ï¼Œä¸é€² Gitï¼‰</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="o">.</span><span class="n">backups</span><span class="o">/</span><span class="w">                  </span><span class="c1"># è‡ªå‹•å‚™ä»½ç›®éŒ„ï¼ˆä¿ç•™æœ€è¿‘ 10 å€‹ç‰ˆæœ¬ï¼‰</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">cgmh_ty</span><span class="o">.</span><span class="n">backup</span><span class="o">.</span><span class="mi">20260213</span><span class="n">_143022</span><span class="o">.</span><span class="n">xlsx</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">cgmh_ty</span><span class="o">.</span><span class="n">backup</span><span class="o">.</span><span class="mi">20260213</span><span class="n">_120015</span><span class="o">.</span><span class="n">xlsx</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="o">...</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">cgmh_ty</span><span class="o">.</span><span class="n">yaml</span><span class="w">               </span><span class="c1"># ç”Ÿæˆæª”ï¼ˆç¦æ­¢æ‰‹å‹•ç·¨è¼¯ï¼Œä¸é€² Gitï¼‰</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">kmuh</span><span class="o">/</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">kmuh</span><span class="o">.</span><span class="n">xlsx</span>
</code></pre></div>

<h3 id="22-git-git-as-ssot-policy">2.2 Git çœŸç›¸æºç®¡ç†ç­–ç•¥ï¼ˆGit as SSOT Policyï¼‰</h3>
<p><strong>æ ¸å¿ƒåŸå‰‡</strong>ï¼šYAML ç‚ºå”¯ä¸€çœŸç›¸æºï¼ŒExcel ç‚ºæœ¬åœ°å·¥ä½œæª”æ¡ˆã€‚</p>
<table>
<thead>
<tr>
<th>æª”æ¡ˆé¡å‹</th>
<th>Git ç®¡ç†</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.yaml</code> (sites/)</td>
<td><strong>ç´å…¥ç‰ˆæœ¬æ§åˆ¶</strong></td>
<td>æ‰€æœ‰ç”Ÿæˆçš„ YAML å¿…é ˆé€²å…¥ Gitï¼Œä½œç‚ºéƒ¨ç½²èˆ‡å›é€€çš„å”¯ä¸€ä¾æ“š</td>
</tr>
<tr>
<td><code>.xlsx</code></td>
<td><strong>Gitignored</strong></td>
<td>Excel ç‚ºäºŒé€²ä½æ ¼å¼ï¼Œä¸ç´å…¥ Gitã€‚å·¥ç¨‹å¸«é–“é€éã€ŒYAML â†’ yaml_to_excelã€é‡å»º</td>
</tr>
<tr>
<td><code>.xlsx.backup.*</code></td>
<td><strong>æœ¬åœ°ä¿ç•™</strong></td>
<td>Wizard è‡ªå‹•ç”Ÿæˆçš„å‚™ä»½ï¼Œä¿ç•™æœ€è¿‘ 10 å€‹ç‰ˆæœ¬ï¼Œä¸é€² Git</td>
</tr>
<tr>
<td><code>Feature_Template_*.xlsx</code></td>
<td><strong>ç´å…¥ç‰ˆæœ¬æ§åˆ¶</strong></td>
<td>ç¯„æœ¬æª”æ¡ˆéœ€ç‰ˆæœ¬åŒ–ï¼Œç¢ºä¿ä¸åŒå·¥ç¨‹å¸«ä½¿ç”¨ç›¸åŒçµæ§‹</td>
</tr>
</tbody>
</table>
<p><strong><code>.gitignore</code> ç¯„ä¾‹</strong>ï¼ˆæ”¾ç½®æ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> Excel å·¥ä½œæª”æ¡ˆï¼ˆç”± YAML ç”Ÿæˆæˆ– Wizard å»ºç«‹ï¼‰
data/features/**/*.xlsx
data/features/**/*.xlsx.backup.*
data/features/**/.backups/

<span class="gh">#</span> è‡¨æ™‚æª”æ¡ˆ
*.tmp
<span class="gs">*.xlsx~</span>
<span class="gs">*</span>.yaml.tmp
__pycache__/
</code></pre></div>

<p><strong>åˆ†æ”¯ç­–ç•¥å»ºè­°</strong>ï¼š
- <code>main</code>: åƒ…åŒ…å«é€šéé©—è­‰çš„ YAMLï¼Œä»£è¡¨ç”Ÿç”¢ç’°å¢ƒé…ç½®
- <code>feature/annotation-{site_id}</code>: æ–°å¢æ¡ˆå ´æˆ–ä¿®æ”¹ç‰¹å¾µæ™‚çš„å·¥ä½œåˆ†æ”¯
- ç¦æ­¢ç›´æ¥æ¨é€ <code>.xlsx</code> æª”æ¡ˆï¼ŒCI/CD æœƒæª¢æŸ¥æ˜¯å¦èª¤å°‡äºŒé€²ä½æª”æ¡ˆç´å…¥ç‰ˆæœ¬æ§åˆ¶</p>
<h3 id="23-excel">2.3 Excel ç¯„æœ¬ç‰ˆæœ¬æ§åˆ¶æ©Ÿåˆ¶ï¼ˆæ–°å¢ï¼‰</h3>
<p><strong>å•é¡Œ</strong>: ç•¶ PRD æ›´æ–°ï¼ˆå¦‚æ–°å¢æ¬„ä½ï¼‰ï¼ŒèˆŠç‰ˆ Excel ç¯„æœ¬å¯èƒ½ç”¢ç”Ÿçµæ§‹éŒ¯èª¤çš„ YAMLã€‚</p>
<p><strong>è§£æ±ºæ–¹æ¡ˆ</strong>:
1. <strong>Hidden Sheet <code>System</code></strong> å„²å­˜ç‰ˆæœ¬è³‡è¨Šï¼š
   - <code>A1</code> (template_version): "1.2"
   - <code>A2</code> (schema_hash): "sha256:abc123..."
   - <code>A3</code> (last_generated_by): "wizard_v1.2"
   - <code>A4</code> (yaml_last_sync_timestamp): "2026-02-13T10:00:00"</p>
<ol>
<li><strong>è½‰æ›æ™‚å¼·åˆ¶æª¢æŸ¥</strong>:
   ```python
   # excel_to_yaml.py
   EXPECTED_TEMPLATE_VERSION = "1.2"</li>
</ol>
<p>def validate_template_version(wb: Workbook):
       system_sheet = wb['System']
       version = system_sheet['B1'].value
       if version != EXPECTED_TEMPLATE_VERSION:
           raise CompatibilityError(
               f"Excel ç¯„æœ¬ç‰ˆæœ¬éèˆŠ (v{version})ï¼Œè«‹åŸ·è¡Œ:\n"
               f"  python migrate_excel.py --from {version} --to {EXPECTED_TEMPLATE_VERSION} "
               f"  --input your_file.xlsx"
           )
   ```</p>
<ol>
<li><strong>é·ç§»å·¥å…· (migrate_excel.py)</strong>:</li>
<li>è‡ªå‹•å°‡ v1.1 ç¯„æœ¬å‡ç´šè‡³ v1.2ï¼ˆæ–°å¢æ¬„ä½ã€èª¿æ•´å…¬å¼ï¼‰</li>
<li>ä¿ç•™æ—¢æœ‰è³‡æ–™ï¼Œåƒ…æ›´æ–°çµæ§‹</li>
</ol>
<hr />
<h2 id="3-excel">3. Excel ç¯„æœ¬çµæ§‹ï¼ˆéœæ…‹é©—è­‰ç‰ˆï¼‰</h2>
<h3 id="31-sheet-1-columns">3.1 Sheet 1: Columnsï¼ˆä¸»è¦ç·¨è¼¯å€ï¼‰</h3>
<p><strong>è¨­è¨ˆè®Šæ›´</strong>: æ”¾æ£„å‹•æ…‹ä¸‹æ‹‰ (<code>INDIRECT</code>)ï¼Œæ”¹ç”¨<strong>éœæ…‹åˆ†ç¾¤é¸å–®</strong> + <strong>Python å±¤é©—è­‰</strong>ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align: center;">æ¬„ä½åç¨± (A)</th>
<th style="text-align: center;">ç‰©ç†é¡å‹ (B)</th>
<th style="text-align: center;">å–®ä½ (C)</th>
<th style="text-align: center;">è¨­å‚™è§’è‰² (D)</th>
<th style="text-align: center;">æ˜¯å¦ç›®æ¨™ (E)</th>
<th style="text-align: center;">å•Ÿç”¨ Lag (F)</th>
<th style="text-align: center;">Lag é–“éš” (G)</th>
<th style="text-align: center;">å¿½ç•¥è­¦å‘Š (H)</th>
<th style="text-align: center;">æè¿° (I)</th>
<th style="text-align: center;">ç‹€æ…‹ (J)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">chiller_1_temp</td>
<td style="text-align: center;">temperature</td>
<td style="text-align: center;">Â°C</td>
<td style="text-align: center;">primary</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">1,4,96</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">ä¸€è™Ÿæ©Ÿæº«åº¦</td>
<td style="text-align: center;">confirmed</td>
</tr>
<tr>
<td style="text-align: center;">chiller_2_temp</td>
<td style="text-align: center;">temperature</td>
<td style="text-align: center;">Â°C</td>
<td style="text-align: center;">backup</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">1,4</td>
<td style="text-align: center;">W403</td>
<td style="text-align: center;">äºŒè™Ÿæ©Ÿæº«åº¦(å‚™ç”¨)</td>
<td style="text-align: center;">confirmed</td>
</tr>
<tr>
<td style="text-align: center;">total_power_kw</td>
<td style="text-align: center;">power</td>
<td style="text-align: center;">kW</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">ç¸½è€—é›»</td>
<td style="text-align: center;">confirmed</td>
</tr>
</tbody>
</table>
<p><strong>æ¬„ä½è¦æ ¼èˆ‡é˜²å‘†</strong>:</p>
<p><strong>A. æ¬„ä½åç¨± (Column Name)</strong>
- <strong>é©—è­‰</strong>: å¿…å¡«ï¼Œå¿…é ˆèˆ‡ CSV æ¬„ä½åç¨±<strong>å®Œå…¨åŒ¹é…</strong>ï¼ˆå«å¤§å°å¯«ï¼‰
- <strong>æ ¼å¼</strong>: æ–‡å­—ï¼Œç„¡ç‰¹æ®Šå­—å…ƒé™åˆ¶ï¼Œä½†å»ºè­°ä½¿ç”¨è‹±æ–‡åº•ç·šå‘½å</p>
<p><strong>B. ç‰©ç†é¡å‹ (Physical Type)</strong>
- <strong>è¼¸å…¥</strong>: éœæ…‹ä¸‹æ‹‰é¸å–®ï¼ˆå€¼ä¾†è‡ª <code>physical_types.yaml</code> çš„ keysï¼‰
- <strong>é¸é …</strong>: <code>temperature</code>, <code>pressure</code>, <code>flow_rate</code>, <code>power</code>, <code>chiller_load</code>, <code>status</code>, <code>gauge</code>
- <strong>è®Šæ›´</strong>: ç•¶æ­¤æ¬„è®Šæ›´æ™‚ï¼Œ<strong>ä¸</strong>è‡ªå‹•é€£å‹• C æ¬„ï¼ˆé¿å… INDIRECT è„†å¼±æ€§ï¼‰</p>
<p><strong>C. å–®ä½ (Unit)</strong>
- <strong>è¼¸å…¥</strong>: éœæ…‹é•·é¸å–®ï¼ˆåŒ…å«æ‰€æœ‰ç‰©ç†é¡å‹çš„æ‰€æœ‰å–®ä½ï¼Œåˆ†ç¾¤é¡¯ç¤ºï¼‰
- <strong>é¸é …ç¯„ä¾‹</strong>:
  <code>[æº«åº¦é¡] Â°C, Â°F, K
  [å£“åŠ›é¡] bar, psi, kPa, MPa
  [æµé‡é¡] LPM, GPM, mÂ³/h
  [åŠŸç‡é¡] kW, W, RT, HP</code>
- <strong>é©—è­‰</strong>: ç”± <code>excel_to_yaml.py</code> æª¢æŸ¥èˆ‡ B æ¬„çš„ç›¸å®¹æ€§ï¼ˆé Excel å±¤ï¼‰</p>
<p><strong>D. è¨­å‚™è§’è‰² (Device Role)</strong>ï¼ˆæ–°å¢ï¼‰
- <strong>è¼¸å…¥</strong>: ä¸‹æ‹‰é¸å–® (<code>primary</code>, <code>backup</code>, <code>seasonal</code>)
- <strong>é è¨­</strong>: <code>primary</code>
- <strong>å½±éŸ¿</strong>: 
  - <code>backup</code>: æŠ‘åˆ¶ W403 (é«˜é›¶å€¼æ¯”ä¾‹) è­¦å‘Š
  - <code>seasonal</code>: æŠ‘åˆ¶ W401 (å‡å€¼ç•°å¸¸) è­¦å‘Šï¼ˆå­£ç¯€æ€§è¨­å‚™å¯èƒ½é•·æœŸåœæ©Ÿï¼‰</p>
<p><strong>E. æ˜¯å¦ç›®æ¨™ (Is Target)</strong>
- <strong>è¼¸å…¥</strong>: å‹¾é¸æ¡† (TRUE/FALSE)
- <strong>é€£å‹•</strong>: ç•¶è¨­ç‚º TRUE æ™‚ï¼ŒF æ¬„ (<code>å•Ÿç”¨ Lag</code>) è‡ªå‹•è¨­ç‚º FALSE ä¸¦<strong>é–å®šç·¨è¼¯</strong>ï¼ˆExcel æ¢ä»¶æ ¼å¼ç°åŒ–ï¼‰</p>
<p><strong>F. å•Ÿç”¨ Lag (Enable Lag)</strong>
- <strong>è¼¸å…¥</strong>: å‹¾é¸æ¡†
- <strong>é©—è­‰</strong>: è‹¥ E æ¬„ç‚º TRUEï¼Œæ­¤æ¬„å¼·åˆ¶ç‚º FALSE</p>
<p><strong>G. Lag é–“éš” (Lag Intervals)</strong>
- <strong>è¼¸å…¥</strong>: æ–‡å­—æ ¼å¼ï¼Œé€—è™Ÿåˆ†éš”æ•¸å­—ï¼ˆå¦‚ <code>1,4,96</code>ï¼‰
- <strong>é©—è­‰</strong>: Python å±¤æª¢æŸ¥ç‚ºæ­£æ•´æ•¸ä¸”éå¢</p>
<p><strong>H. å¿½ç•¥è­¦å‘Š (Ignore Warnings)</strong>ï¼ˆæ–°å¢ï¼‰
- <strong>è¼¸å…¥</strong>: å¤šé¸ä¸‹æ‹‰ï¼ˆ<code>W401</code>, <code>W402</code>, <code>W403</code>, <code>-</code>ï¼‰
- <strong>æ ¼å¼</strong>: é€—è™Ÿåˆ†éš”ï¼ˆå¦‚ <code>W401,W403</code>ï¼‰
- <strong>ç”¨é€”</strong>: å…è¨±é ˜åŸŸå°ˆå®¶é¡¯å¼æ¨™è¨˜ã€Œæ­¤æ¬„ä½å…è¨±ç‰¹å®šçµ±è¨ˆç•°å¸¸ã€</p>
<p><strong>I. æè¿° (Description)</strong>
- <strong>è¼¸å…¥</strong>: è‡ªç”±æ–‡å­—ï¼Œå»ºè­°å¡«å¯«è¨­å‚™ä½ç½®æˆ–ç”¨é€”</p>
<p><strong>J. ç‹€æ…‹ (Status)</strong>
- <strong>è¼¸å…¥</strong>: ä¸‹æ‹‰é¸å–® (<code>pending_review</code>, <code>confirmed</code>, <code>deprecated</code>)
- <strong>Wizard ç”Ÿæˆ</strong>: æ–°æ¬„ä½é è¨­ç‚º <code>pending_review</code></p>
<h3 id="32-sheet-2-group-policies">3.2 Sheet 2: Group Policiesï¼ˆç¾¤çµ„ç­–ç•¥ï¼‰</h3>
<p>ç°¡åŒ–èªæ³•ï¼Œç„¡éœ€ Regexï¼š</p>
<table>
<thead>
<tr>
<th style="text-align: center;">ç­–ç•¥åç¨±</th>
<th style="text-align: center;">åŒ¹é…é¡å‹</th>
<th style="text-align: center;">åŒ¹é…å€¼</th>
<th style="text-align: center;">ç‰©ç†é¡å‹</th>
<th style="text-align: center;">é è¨­æ¨£æ¿</th>
<th style="text-align: center;">è‡ªå®šç¾© Lag</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">chillers</td>
<td style="text-align: center;">prefix</td>
<td style="text-align: center;">chiller_</td>
<td style="text-align: center;">chiller_load</td>
<td style="text-align: center;">Standard_Chiller</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;">towers</td>
<td style="text-align: center;">prefix</td>
<td style="text-align: center;">ct_</td>
<td style="text-align: center;">temperature</td>
<td style="text-align: center;">Standard_Tower</td>
<td style="text-align: center;">1,8</td>
</tr>
<tr>
<td style="text-align: center;">custom_pumps</td>
<td style="text-align: center;">contains</td>
<td style="text-align: center;">pump</td>
<td style="text-align: center;">flow_rate</td>
<td style="text-align: center;">Custom</td>
<td style="text-align: center;">1,4,12</td>
</tr>
</tbody>
</table>
<p><strong>æ¬„ä½è¦æ ¼</strong>:</p>
<ul>
<li><strong>åŒ¹é…é¡å‹</strong>: <code>prefix</code>ï¼ˆå‰ç¶´ï¼‰, <code>suffix</code>ï¼ˆå¾Œç¶´ï¼‰, <code>contains</code>ï¼ˆåŒ…å«ï¼‰, <code>regex</code>ï¼ˆé€²éšï¼‰</li>
<li><strong>é è¨­æ¨£æ¿</strong>: ä¸‹æ‹‰é¸å–® (<code>Standard_Chiller</code>, <code>Standard_Tower</code>, <code>High_Freq</code>, <code>Custom</code>)</li>
<li>é¸æ“‡é è¨­æ¨£æ¿æ™‚ï¼Œã€Œè‡ªå®šç¾© Lagã€æ¬„ä½é–å®š</li>
<li>é¸æ“‡ <code>Custom</code> æ™‚ï¼Œå¯æ‰‹å‹•è¼¸å…¥ Lag é–“éš”</li>
</ul>
<h3 id="33-sheet-3-metadata">3.3 Sheet 3: Metadataï¼ˆæ–‡ä»¶è³‡è¨Šï¼‰</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">å±¬æ€§</th>
<th style="text-align: left;">å€¼</th>
<th style="text-align: left;">èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">schema_version</td>
<td style="text-align: left;">1.2</td>
<td style="text-align: left;">æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬</td>
</tr>
<tr>
<td style="text-align: left;">template_version</td>
<td style="text-align: left;">1.2</td>
<td style="text-align: left;">Excel ç¯„æœ¬ç‰ˆæœ¬ï¼ˆç³»çµ±æª¢æŸ¥ç”¨ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;">site_id</td>
<td style="text-align: left;">cgmh_ty</td>
<td style="text-align: left;">æ¡ˆå ´è­˜åˆ¥</td>
</tr>
<tr>
<td style="text-align: left;">inherit</td>
<td style="text-align: left;">base</td>
<td style="text-align: left;">ç¹¼æ‰¿ä¾†æº</td>
</tr>
<tr>
<td style="text-align: left;">description</td>
<td style="text-align: left;">é•·åºšé†«é™¢...</td>
<td style="text-align: left;">æ–‡ä»¶æè¿°</td>
</tr>
<tr>
<td style="text-align: left;">editor</td>
<td style="text-align: left;">ç‹å·¥ç¨‹å¸«</td>
<td style="text-align: left;">ç·¨è¼¯è€…</td>
</tr>
<tr>
<td style="text-align: left;">last_updated</td>
<td style="text-align: left;">2026-02-13</td>
<td style="text-align: left;">æœ€å¾Œæ›´æ–°ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</td>
</tr>
<tr>
<td style="text-align: left;">yaml_checksum</td>
<td style="text-align: left;">sha256:...</td>
<td style="text-align: left;">å°æ‡‰ YAML çš„é›œæ¹Šï¼ˆåŒæ­¥æª¢æŸ¥ç”¨ï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>ç³»çµ±æ¬„ä½ï¼ˆHidden Sheet <code>System</code>ï¼‰</strong>:
- <code>A1</code>: template_version
- <code>A2</code>: schema_hash
- <code>A3</code>: last_generated_by
- <code>A4</code>: yaml_last_sync_timestamp</p>
<hr />
<h2 id="4-yaml-schema-ssot">4. YAML Schema è©³ç´°è¦ç¯„ï¼ˆSSOT å±¤ï¼‰</h2>
<h3 id="41">4.1 é ‚å±¤çµæ§‹ï¼ˆæ›´æ–°ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">schema_version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2&quot;</span><span class="w">              </span><span class="c1"># æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;é•·åºšé†«é™¢ç‰¹å¾µå®šç¾©&quot;</span>
<span class="nt">inherit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;base&quot;</span>

<span class="nt">meta</span><span class="p">:</span><span class="w">                              </span><span class="c1"># æ–‡ä»¶å…ƒè³‡æ–™</span>
<span class="w">  </span><span class="nt">site_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cgmh_ty&quot;</span>
<span class="w">  </span><span class="nt">editor</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ç‹å·¥ç¨‹å¸«&quot;</span>
<span class="w">  </span><span class="nt">last_updated</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2026-02-13T10:00:00&quot;</span>
<span class="w">  </span><span class="nt">source_excel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cgmh_ty.xlsx&quot;</span><span class="w">     </span><span class="c1"># ä¾†æº Excel æª”å</span>
<span class="w">  </span><span class="nt">excel_checksum</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sha256:def456...&quot;</span><span class="w"> </span><span class="c1"># Excel æª”æ¡ˆé›œæ¹Šï¼ˆåŒæ­¥é©—è­‰ç”¨ï¼‰</span>
<span class="w">  </span><span class="nt">template_version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2&quot;</span><span class="w">          </span><span class="c1"># ç”Ÿæˆæ™‚çš„ç¯„æœ¬ç‰ˆæœ¬</span>

<span class="nt">physical_types</span><span class="p">:</span><span class="w">                    </span><span class="c1"># å¯è¦†è“‹ SSOT</span>
<span class="w">  </span><span class="p p-Indicator">[</span><span class="nv">physical_type_id</span><span class="p p-Indicator">]:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PhysicalTypeDefinition</span>

<span class="nt">columns</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">[</span><span class="nv">column_name</span><span class="p p-Indicator">]:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ColumnAnnotation</span>

<span class="nt">group_policies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">[</span><span class="nv">policy_name</span><span class="p p-Indicator">]:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GroupPolicyRule</span>

<span class="nt">validation</span><span class="p">:</span>
<span class="w">  </span><span class="nt">strict_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">allow_unannotated</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">enable_distribution_check</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>

<h3 id="42-column-annotation">4.2 Column Annotationï¼ˆæ›´æ–°ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">columns</span><span class="p">:</span>
<span class="w">  </span><span class="nt">chiller_1_temp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">column_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;chiller_1_temp&quot;</span>
<span class="w">    </span><span class="nt">physical_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;temperature&quot;</span>
<span class="w">    </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Â°C&quot;</span>
<span class="w">    </span><span class="nt">device_role</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;primary&quot;</span><span class="w">         </span><span class="c1"># æ–°å¢ï¼šè¨­å‚™è§’è‰²</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ä¸€è™Ÿå†°æ©Ÿæº«åº¦&quot;</span>
<span class="w">    </span><span class="nt">is_target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">enable_lag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">enable_rolling</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">lag_intervals</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">96</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">rolling_windows</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">96</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;critical&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">ignore_warnings</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w">            </span><span class="c1"># æ–°å¢ï¼šå¿½ç•¥çš„è­¦å‘Šåˆ—è¡¨</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;confirmed&quot;</span>

<span class="w">  </span><span class="nt">chiller_2_temp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">column_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;chiller_2_temp&quot;</span>
<span class="w">    </span><span class="nt">physical_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;temperature&quot;</span>
<span class="w">    </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Â°C&quot;</span>
<span class="w">    </span><span class="nt">device_role</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;backup&quot;</span><span class="w">          </span><span class="c1"># å‚™ç”¨è¨­å‚™</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;äºŒè™Ÿæ©Ÿæº«åº¦(å‚™ç”¨)&quot;</span>
<span class="w">    </span><span class="nt">is_target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">enable_lag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">lag_intervals</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">ignore_warnings</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;W403&quot;</span><span class="p p-Indicator">]</span><span class="w">      </span><span class="c1"># æŠ‘åˆ¶é«˜é›¶å€¼è­¦å‘Š</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;confirmed&quot;</span>
</code></pre></div>

<h3 id="43-physical-type">4.3 Physical Type å®šç¾©ï¼ˆå«çµ±è¨ˆåƒæ•¸ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">physical_types</span><span class="p">:</span>
<span class="w">  </span><span class="nt">temperature</span><span class="p">:</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;æº«åº¦æ„Ÿæ¸¬å™¨&quot;</span>
<span class="w">    </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Â°C&quot;</span>
<span class="w">    </span><span class="nt">si_unit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;celsius&quot;</span>
<span class="w">    </span><span class="nt">valid_range</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-40.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">100.0</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">agg_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mean&quot;</span>
<span class="w">    </span><span class="nt">distribution_check</span><span class="p">:</span><span class="w">            </span><span class="c1"># çµ±è¨ˆé©—è­‰åƒæ•¸</span>
<span class="w">      </span><span class="nt">expected_mean_range</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">35</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">max_std_threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">      </span><span class="nt">zero_ratio_warning</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w">      </span><span class="c1"># 10% é›¶å€¼è§¸ç™¼è­¦å‘Š</span>
<span class="w">      </span><span class="nt">zero_ratio_critical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span><span class="w">     </span><span class="c1"># 50% é›¶å€¼è§¸ç™¼éŒ¯èª¤ï¼ˆå³ä½¿ backup ä¹Ÿæª¢æŸ¥ï¼‰</span>
</code></pre></div>

<hr />
<h2 id="5">5. ä¸‰å±¤é˜²è­·èˆ‡é©—è­‰æ©Ÿåˆ¶ï¼ˆæ›´æ–°ï¼‰</h2>
<h3 id="51-excel">5.1 ç¬¬ä¸€å±¤ï¼šExcel éœæ…‹é˜²å‘†</h3>
<p><strong>ç§»é™¤</strong>ï¼šå‹•æ…‹ä¸‹æ‹‰ (<code>INDIRECT</code>)<br />
<strong>ä¿ç•™</strong>ï¼š
- éœæ…‹ä¸‹æ‹‰é¸å–®ï¼ˆç‰©ç†é¡å‹ã€å–®ä½åˆ†ç¾¤ã€è¨­å‚™è§’è‰²ï¼‰
- æ¢ä»¶æ ¼å¼ï¼ˆç›®æ¨™è®Šæ•¸è‡ªå‹•ç°åŒ– Lag æ¬„ä½ï¼‰
- å¿…å¡«æ¬„ä½æª¢æŸ¥ï¼ˆç´…è‰²æ¨™è¨˜ç©ºç™½æ¬„ä½ï¼‰</p>
<h3 id="52-python">5.2 ç¬¬äºŒå±¤ï¼šPython è½‰æ›é©—è­‰ï¼ˆå¼·åŒ–ï¼‰</h3>
<p><strong>excel_to_yaml.py é©—è­‰æµç¨‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">convert_excel_to_yaml</span><span class="p">(</span><span class="n">excel_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Excel è½‰ YAMLï¼Œå«å®Œæ•´é©—è­‰</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. ç¯„æœ¬ç‰ˆæœ¬æª¢æŸ¥ï¼ˆé˜»æ“‹èˆŠç‰ˆï¼‰</span>
    <span class="n">wb</span> <span class="o">=</span> <span class="n">load_workbook</span><span class="p">(</span><span class="n">excel_path</span><span class="p">)</span>
    <span class="n">validate_template_version</span><span class="p">(</span><span class="n">wb</span><span class="p">)</span>  <span class="c1"># æª¢æŸ¥ System sheet</span>

    <span class="c1"># 2. è®€å–è³‡æ–™</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">read_excel_sheets</span><span class="p">(</span><span class="n">wb</span><span class="p">)</span>

    <span class="c1"># 3. èªæ³•é©—è­‰</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 3.1 å–®ä½ç›¸å®¹æ€§æª¢æŸ¥ï¼ˆé—œéµé©—è­‰ï¼‰</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;physical_type&#39;</span><span class="p">]</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
        <span class="n">valid_units</span> <span class="o">=</span> <span class="n">PHYSICAL_TYPES</span><span class="p">[</span><span class="n">ptype</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_units</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ç‰©ç†é¡å‹ &#39;</span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s2">&#39; ä¸æ”¯æ´å–®ä½ &#39;</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&#39;ï¼Œ&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;æœ‰æ•ˆé¸é …: </span><span class="si">{</span><span class="n">valid_units</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># 3.2 æ•¸å€¼æ ¼å¼æª¢æŸ¥</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">lag_str</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lag_intervals&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">lag_str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lag_str</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">lag_str</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">intervals</span> <span class="o">!=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">intervals</span><span class="p">):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: Lag é–“éš”å¿…é ˆéå¢&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: Lag é–“éš”æ ¼å¼éŒ¯èª¤ï¼Œå¿…é ˆç‚ºé€—è™Ÿåˆ†éš”æ•´æ•¸&quot;</span><span class="p">)</span>

    <span class="c1"># 3.3 çµ±è¨ˆåˆ†ä½ˆé©—è­‰ï¼ˆè‹¥æä¾› sample CSVï¼‰</span>
    <span class="k">if</span> <span class="n">sample_csv_path</span><span class="p">:</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="n">validate_distribution</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sample_csv_path</span><span class="p">)</span>
        <span class="c1"># æª¢æŸ¥ ignore_warnings è¨­å®š</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">column_name</span>
            <span class="n">ignore_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;ignore_warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_list</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš ï¸  </span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 4. è™•ç†çµæœ</span>
    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;é©—è­‰å¤±æ•—ï¼Œè«‹ä¿®æ­£ä»¥ä¸‹éŒ¯èª¤ï¼š&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Excel é©—è­‰å¤±æ•—ï¼Œæœªç”Ÿæˆ YAML&quot;</span><span class="p">)</span>

    <span class="c1"># 5. ç”Ÿæˆ YAML</span>
    <span class="n">yaml_data</span> <span class="o">=</span> <span class="n">build_yaml_structure</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;excel_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_file_hash</span><span class="p">(</span><span class="n">excel_path</span><span class="p">)</span>
    <span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;last_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="c1"># 6. å¯«å…¥ï¼ˆåŸå­æ“ä½œï¼‰</span>
    <span class="n">temp_path</span> <span class="o">=</span> <span class="n">output_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.tmp&#39;</span><span class="p">)</span>
    <span class="n">temp_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">yaml_data</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">temp_path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>  <span class="c1"># åŸå­ç§»å‹•</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… æˆåŠŸç”Ÿæˆ: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</code></pre></div>

<h3 id="53-cicd">5.3 ç¬¬ä¸‰å±¤ï¼šCI/CD å¥‘ç´„é©—è­‰</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/feature-annotation.yml</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Excel-to-YAML Consistency Check</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no"># ç¢ºä¿æäº¤çš„æ˜¯ Excelï¼Œè€Œéç›´æ¥ä¿®æ”¹çš„ YAML</span>
<span class="w">    </span><span class="no">for excel in config/features/sites/*.xlsx; do</span>
<span class="w">      </span><span class="no">yaml=&quot;${excel%.xlsx}.yaml&quot;</span>

<span class="w">      </span><span class="no"># æª¢æŸ¥ YAML æ˜¯å¦ç”± Excel ç”Ÿæˆï¼ˆæ¯”å° checksumï¼‰</span>
<span class="w">      </span><span class="no">python -m src.features.validate_sync --excel $excel --yaml $yaml</span>

<span class="w">      </span><span class="no"># é‡æ–°ç”Ÿæˆä¸¦æ¯”å°ï¼ˆç¢ºä¿ç„¡æ‰‹å‹•ä¿®æ”¹ï¼‰</span>
<span class="w">      </span><span class="no">python tools/features/excel_to_yaml.py --input $excel --output /tmp/generated.yaml</span>
<span class="w">      </span><span class="no">diff /tmp/generated.yaml $yaml || {</span>
<span class="w">        </span><span class="no">echo &quot;éŒ¯èª¤: $yaml èˆ‡ $excel ä¸åŒæ­¥ï¼Œè«‹é‡æ–°åŸ·è¡Œ excel_to_yaml.py&quot;</span>
<span class="w">        </span><span class="no">exit 1</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">done</span>
</code></pre></div>

<hr />
<h2 id="6-wizard-cli">6. Wizard äº¤äº’å¼ CLIï¼ˆé—œéµä¿®æ­£ï¼‰</h2>
<h3 id="61">6.1 æ¶æ§‹ä¿®æ­£ï¼ˆè§£æ±ºç«¶æ…‹æ¢ä»¶ï¼‰</h3>
<p><strong>v1.1 éŒ¯èª¤</strong>: Wizard ç›´æ¥æ›´æ–° YAML<br />
<strong>v1.2 ä¿®æ­£</strong>: Wizard <strong>åƒ…</strong>æ›´æ–° Excelï¼ŒYAML ç”±ä½¿ç”¨è€…æ‰‹å‹•è§¸ç™¼ç”Ÿæˆ</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ­£ç¢ºæµç¨‹ï¼ˆv1.2ï¼‰</span>
python<span class="w"> </span>main.py<span class="w"> </span>features<span class="w"> </span>wizard<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--site<span class="w"> </span>cgmh_ty<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--from-csv<span class="w"> </span>data/cgmh_ty_latest.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--excel<span class="w"> </span>data/features/cgmh_ty/cgmh_ty.xlsx<span class="w">  </span><span class="c1"># è¼¸å‡ºç›®æ¨™ï¼šExcel</span>

<span class="c1"># Wizard åŸ·è¡Œå¾Œï¼Œä½¿ç”¨è€…å¿…é ˆæ‰‹å‹•åŸ·è¡Œï¼š</span>
python<span class="w"> </span>tools/features/excel_to_yaml.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--input<span class="w"> </span>data/features/cgmh_ty/cgmh_ty.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>config/features/sites/cgmh_ty.yaml
</code></pre></div>

<h3 id="62-wizard">6.2 Wizard è©³ç´°æµç¨‹ï¼ˆå«è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">wizard_update_excel</span><span class="p">(</span>
    <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">csv_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">excel_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">template_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.2&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wizardï¼šåµæ¸¬æ–°æ¬„ä½ä¸¦è¿½åŠ è‡³ Excelï¼ˆä¸ç›´æ¥å¯« YAMLï¼‰</span>
<span class="sd">    åŒ…å«è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶ï¼ˆUndo é˜²è­·ï¼‰</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 0. è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶ï¼ˆç½é›£æ¢å¾©é˜²è­·ï¼‰</span>
    <span class="k">if</span> <span class="n">excel_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">backup_dir</span> <span class="o">=</span> <span class="n">excel_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;.backups&quot;</span>
        <span class="n">backup_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># ç”Ÿæˆæ™‚é–“æˆ³å‚™ä»½æª”åï¼ˆç²¾ç¢ºåˆ°ç§’ï¼Œé¿å…è¦†è“‹ï¼‰</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">backup_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">excel_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.backup.</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}{</span><span class="n">excel_path</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">backup_path</span> <span class="o">=</span> <span class="n">backup_dir</span> <span class="o">/</span> <span class="n">backup_filename</span>

        <span class="c1"># è¤‡è£½ç¾æœ‰ Excel åˆ°å‚™ä»½ç›®éŒ„ï¼ˆä¿ç•™å…ƒè³‡æ–™ï¼‰</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">excel_path</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>

        <span class="c1"># æ¸…ç†èˆŠå‚™ä»½ï¼ˆä¿ç•™æœ€è¿‘ 10 å€‹ç‰ˆæœ¬ï¼Œä¾ä¿®æ”¹æ™‚é–“æ’åºï¼‰</span>
        <span class="n">backup_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">excel_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.backup.*&quot;</span>
        <span class="n">all_backups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">backup_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">backup_pattern</span><span class="p">),</span> 
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># åˆªé™¤è¶…é 10 å€‹ç‰ˆæœ¬çš„èˆŠå‚™ä»½</span>
        <span class="k">for</span> <span class="n">old_backup</span> <span class="ow">in</span> <span class="n">all_backups</span><span class="p">[</span><span class="mi">10</span><span class="p">:]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_backup</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ—‘ï¸  æ¸…ç†èˆŠå‚™ä»½: </span><span class="si">{</span><span class="n">old_backup</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš ï¸  ç„¡æ³•æ¸…ç†èˆŠå‚™ä»½ </span><span class="si">{</span><span class="n">old_backup</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ’¾ å·²è‡ªå‹•å‚™ä»½: </span><span class="si">{</span><span class="n">backup_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">ï¼ˆä¿ç•™æœ€è¿‘ 10 å€‹ç‰ˆæœ¬ï¼‰&quot;</span><span class="p">)</span>

    <span class="c1"># 1. æª¢æŸ¥ Excel ç‰ˆæœ¬ç›¸å®¹æ€§</span>
    <span class="k">if</span> <span class="n">excel_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">load_workbook</span><span class="p">(</span><span class="n">excel_path</span><span class="p">)</span>
        <span class="n">current_ver</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="s1">&#39;System&#39;</span><span class="p">][</span><span class="s1">&#39;B1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">current_ver</span> <span class="o">!=</span> <span class="n">template_version</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CompatibilityError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Excel ç¯„æœ¬éèˆŠ (v</span><span class="si">{</span><span class="n">current_ver</span><span class="si">}</span><span class="s2">)ï¼Œè«‹å…ˆåŸ·è¡Œï¼š</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;python migrate_excel.py --from </span><span class="si">{</span><span class="n">current_ver</span><span class="si">}</span><span class="s2"> --to </span><span class="si">{</span><span class="n">template_version</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># åˆå§‹åŒ–æ–° Excel å¾ç¯„æœ¬</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">load_workbook</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tools/features/templates/Feature_Template_v</span><span class="si">{</span><span class="n">template_version</span><span class="si">}</span><span class="s2">.xlsx&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ†• åˆå§‹åŒ–æ–° Excel æª”æ¡ˆ: </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 2. è®€å– CSV æ¬„ä½</span>
    <span class="n">df_csv</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">existing_cols</span> <span class="o">=</span> <span class="n">get_existing_columns</span><span class="p">(</span><span class="n">wb</span><span class="p">)</span>
    <span class="n">new_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_csv</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="n">existing_cols</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_cols</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;âœ… ç„¡æ–°æ¬„ä½éœ€è¦æ¨™è¨»&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ” ç™¼ç¾ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> å€‹æ–°æ¬„ä½å¾…æ¨™è¨»&quot;</span><span class="p">)</span>

    <span class="c1"># 3. äº¤äº’å¼ç¢ºèªï¼ˆé€æ¬„ï¼‰</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="s1">&#39;Columns&#39;</span><span class="p">]</span>
    <span class="n">start_row</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">max_row</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">new_cols</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">calculate_stats</span><span class="p">(</span><span class="n">df_csv</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ” æ–°æ¬„ä½: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   çµ±è¨ˆæ‘˜è¦: å‡å€¼=</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, æ¨™æº–å·®=</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, é›¶å€¼æ¯”ä¾‹=</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;zero_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   æ¨£æœ¬å€¼: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="c1"># æ¨æ¸¬å»ºè­°</span>
        <span class="n">suggestion</span> <span class="o">=</span> <span class="n">guess_physical_type</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ç³»çµ±æ¨æ¸¬: </span><span class="si">{</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;physical_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ä½¿ç”¨è€…ç¢ºèªï¼ˆé˜²å‘†è¨­è¨ˆï¼‰</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;[Y] ç¢ºèªå»ºè­°  [N] ä¿®æ”¹  [S] è·³é  [D] æŸ¥çœ‹åˆ†ä½ˆåœ–  [Q] é€€å‡º</span><span class="se">\n</span><span class="s2">&gt; &quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ğŸ›‘ ä½¿ç”¨è€…ä¸­æ–·ï¼Œå·²è™•ç†çš„æ¬„ä½å·²å„²å­˜è‡³ Excel&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;â­ï¸  è·³éæ­¤æ¬„ä½&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
                <span class="n">plot_distribution</span><span class="p">(</span><span class="n">df_csv</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;âŒ ç„¡æ•ˆé¸é …ï¼Œè«‹é‡æ–°è¼¸å…¥&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># æ”¶é›†ä½¿ç”¨è€…è¼¸å…¥</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
            <span class="n">physical_type</span> <span class="o">=</span> <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;physical_type&#39;</span><span class="p">]</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">physical_type</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;è«‹è¼¸å…¥ç‰©ç†é¡å‹: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;è«‹è¼¸å…¥å–®ä½: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">description</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è«‹è¼¸å…¥æè¿°ï¼ˆé è¨­: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">ï¼‰: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> (Wizard ç”Ÿæˆ)&quot;</span>

        <span class="c1"># å¯«å…¥ Excelï¼ˆè€Œé YAMLï¼‰</span>
        <span class="n">row_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;column_name&#39;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span>
            <span class="s1">&#39;physical_type&#39;</span><span class="p">:</span> <span class="n">physical_type</span><span class="p">,</span>
            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
            <span class="s1">&#39;device_role&#39;</span><span class="p">:</span> <span class="s1">&#39;primary&#39;</span><span class="p">,</span>  <span class="c1"># é è¨­ç‚ºä¸»è¨­å‚™</span>
            <span class="s1">&#39;is_target&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;enable_lag&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;lag_intervals&#39;</span><span class="p">:</span> <span class="s1">&#39;1,4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ignore_warnings&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;pending_review&#39;</span>  <span class="c1"># æ¨™è¨˜å¾…ç¢ºèª</span>
        <span class="p">}</span>

        <span class="n">write_to_excel_row</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">row_data</span><span class="p">)</span>
        <span class="n">start_row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… å·²å¯«å…¥ Excel ç¬¬ </span><span class="si">{</span><span class="n">start_row</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> è¡Œ&quot;</span><span class="p">)</span>

    <span class="c1"># 4. æ›´æ–° Metadata èˆ‡ System Sheet</span>
    <span class="n">ws_meta</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="s1">&#39;Metadata&#39;</span><span class="p">]</span>
    <span class="n">ws_meta</span><span class="p">[</span><span class="s1">&#39;B7&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="n">ws_meta</span><span class="p">[</span><span class="s1">&#39;B8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pending_sync&#39;</span>  <span class="c1"># yaml_checksum æ¨™è¨˜ç‚ºå¾…åŒæ­¥</span>

    <span class="n">ws_system</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="s1">&#39;System&#39;</span><span class="p">]</span>
    <span class="n">ws_system</span><span class="p">[</span><span class="s1">&#39;B3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;wizard_v1.2&#39;</span>
    <span class="n">ws_system</span><span class="p">[</span><span class="s1">&#39;B4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="c1"># 5. å„²å­˜ Excelï¼ˆåŸå­å¯«å…¥ï¼‰</span>
    <span class="n">excel_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">temp_excel</span> <span class="o">=</span> <span class="n">excel_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.tmp.xlsx&#39;</span><span class="p">)</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">temp_excel</span><span class="p">)</span>
    <span class="n">temp_excel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">excel_path</span><span class="p">)</span>  <span class="c1"># åŸå­æ›¿æ›</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… å·²æ›´æ–° Excel: </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ’¾ å‚™ä»½ä½ç½®: </span><span class="si">{</span><span class="n">excel_path</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;.backups&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">âš ï¸  é‡è¦æé†’ï¼š&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   1. è«‹é–‹å•Ÿ Excel æª¢è¦–ä¸¦ç¢ºèªæ¨™è¨»å…§å®¹&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   2. ç¢ºèªå¾Œè«‹åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ç”Ÿæˆ YAMLï¼š&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      python tools/features/excel_to_yaml.py </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        --input </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2"> </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        --output config/features/sites/</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   3. è‹¥ç™¼ç¾éŒ¯èª¤ï¼Œå¯å¾ .backups/ ç›®éŒ„é‚„åŸä¸Šä¸€ç‰ˆæœ¬&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>é—œæ–¼å‚™ä»½é‚„åŸ</strong>ï¼š
è‹¥ Wizard æ›´æ–°å¾Œç™¼ç¾èª¤åˆªæ¬„ä½ï¼Œå¯æ‰‹å‹•é‚„åŸè‡³ä¸Šä¸€å€‹å‚™ä»½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ—å‡ºå¯ç”¨å‚™ä»½ï¼ˆä¾æ™‚é–“æ’åºï¼‰</span>
ls<span class="w"> </span>-lt<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/.backups/*.backup.*

<span class="c1"># æ‰‹å‹•é‚„åŸï¼ˆè¦†è“‹ç¾æœ‰å·¥ä½œæª”ï¼‰</span>
cp<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/.backups/cgmh_ty.backup.20260213_143022.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/cgmh_ty.xlsx

<span class="c1"># é‚„åŸå¾Œå¿…é ˆé‡æ–°åŸ·è¡Œ excel_to_yaml ä»¥æ›´æ–° YAML</span>
python<span class="w"> </span>tools/features/excel_to_yaml.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--input<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/cgmh_ty.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml
</code></pre></div>

<p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šæ‰‹å‹•é‚„åŸ Excel å¾Œï¼Œå¿…é ˆé‡æ–°åŸ·è¡Œ <code>excel_to_yaml.py</code> ä»¥æ›´æ–° YAMLï¼Œå¦å‰‡æœƒè§¸ç™¼ <strong>E406ï¼ˆEXCEL_YAML_OUT_OF_SYNCï¼‰</strong> éŒ¯èª¤ã€‚</p>
<h3 id="63">6.3 åŒæ­¥ç‹€æ…‹æª¢æŸ¥</h3>
<p>é˜²æ­¢ã€ŒWizard æ›´æ–° Excel å¾Œï¼Œä½¿ç”¨è€…å¿˜è¨˜ç”Ÿæˆ YAMLã€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_sync_status</span><span class="p">(</span><span class="n">excel_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">yaml_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    æª¢æŸ¥ Excel èˆ‡ YAML æ˜¯å¦åŒæ­¥</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wb</span> <span class="o">=</span> <span class="n">load_workbook</span><span class="p">(</span><span class="n">excel_path</span><span class="p">)</span>
    <span class="n">excel_sync_time</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="s1">&#39;Metadata&#39;</span><span class="p">][</span><span class="s1">&#39;B7&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># last_updated</span>
    <span class="n">excel_status</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="s1">&#39;Metadata&#39;</span><span class="p">][</span><span class="s1">&#39;B8&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>     <span class="c1"># yaml_checksum or &#39;pending_sync&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">yaml_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;synced&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;YAML ä¸å­˜åœ¨ï¼Œè«‹åŸ·è¡Œ excel_to_yaml.py&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;python tools/features/excel_to_yaml.py --input </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2"> --output </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span>

    <span class="n">yaml_mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">yaml_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
    <span class="n">excel_mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">excel_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">excel_mtime</span> <span class="o">&gt;</span> <span class="n">yaml_mtime</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;synced&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Excel è¼ƒæ–° (</span><span class="si">{</span><span class="n">excel_mtime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">)ï¼ŒYAML è¼ƒèˆŠ (</span><span class="si">{</span><span class="n">yaml_mtime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time_diff_minutes&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">excel_mtime</span> <span class="o">-</span> <span class="n">yaml_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;è«‹é‡æ–°åŸ·è¡Œ excel_to_yaml.py&quot;</span>
        <span class="p">}</span>

    <span class="c1"># é¡å¤–æª¢æŸ¥ checksumï¼ˆå¦‚æœ Excel å„²å­˜äº†ä¸Šæ¬¡çš„ checksumï¼‰</span>
    <span class="k">if</span> <span class="n">excel_status</span> <span class="o">!=</span> <span class="s1">&#39;pending_sync&#39;</span><span class="p">:</span>
        <span class="n">current_yaml_checksum</span> <span class="o">=</span> <span class="n">compute_file_hash</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">excel_status</span> <span class="o">!=</span> <span class="n">current_yaml_checksum</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;synced&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;YAML å…§å®¹èˆ‡ Excel ç”Ÿæˆæ™‚ä¸ä¸€è‡´ï¼ˆå¯èƒ½è¢«æ‰‹å‹•ä¿®æ”¹ï¼‰&quot;</span><span class="p">,</span>
                <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="s2">&quot;è«‹å‹¿æ‰‹å‹•ä¿®æ”¹ YAMLï¼Œå»ºè­°å¾ Git é‚„åŸæˆ–é‡æ–°ç”Ÿæˆ&quot;</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;synced&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;last_sync&quot;</span><span class="p">:</span> <span class="n">yaml_mtime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()}</span>
</code></pre></div>

<hr />
<h2 id="7-undo-recovery">7. ç‰ˆæœ¬å›é€€èˆ‡ç½é›£æ¢å¾©æ©Ÿåˆ¶ï¼ˆUndo &amp; Recoveryï¼‰</h2>
<p>æœ¬ç¯€å®šç¾©ä¸‰ç¨®ç•°å¸¸æƒ…å¢ƒçš„æ¢å¾©æµç¨‹ï¼š<strong>Wizard èª¤æ›´æ–°</strong>ã€<strong>Excel æ‰‹å‹•èª¤åˆª</strong>ã€<strong>YAML æ‰‹å‹•èª¤æ”¹</strong>ã€‚</p>
<h3 id="71-git">7.1 æ ¸å¿ƒåŸå‰‡ï¼šGit ä½œç‚ºæœ€çµ‚çœŸç›¸æº</h3>
<p><strong>å›é€€æ©Ÿåˆ¶ï¼ˆRollback SOPï¼‰</strong>ï¼š
ç•¶ç™¼ç”Ÿã€Œèª¤åˆª Excel æ¬„ä½ä¸¦å·²ç”Ÿæˆ YAMLã€æ™‚ï¼Œä¾ä»¥ä¸‹æ­¥é©Ÿå›é€€ï¼š</p>
<ol>
<li><strong>é‚„åŸ YAML</strong>ï¼šé€é Git å›é€€åˆ°ä¸Šä¸€å€‹æ­£ç¢ºç‰ˆæœ¬
   ```bash
   # é‚„åŸåˆ°ä¸Šä¸€ç‰ˆæœ¬
   git checkout HEAD~1 config/features/sites/{site_id}.yaml</li>
</ol>
<p># æˆ–é‚„åŸåˆ°ç‰¹å®š commitï¼ˆæ¨è–¦ï¼Œéœ€å…ˆæŸ¥è©¢ logï¼‰
   git log --oneline config/features/sites/{site_id}.yaml
   git checkout <commit_hash> config/features/sites/{site_id}.yaml
   ```</p>
<ol>
<li>
<p><strong>é‡å»º Excel</strong>ï¼šåŸ·è¡Œé€†å‘è½‰æ›ï¼ˆrecovery æ¨¡å¼ï¼‰
   <code>bash
   python tools/features/yaml_to_excel.py \
     --yaml config/features/sites/{site_id}.yaml \
     --output data/features/{site_id}/{site_id}.xlsx \
     --mode recovery \
     --force  # è¦†è“‹ç¾æœ‰ Excel</code></p>
</li>
<li>
<p><strong>é©—è­‰åŒæ­¥</strong>ï¼šç¢ºèª Excel å·²é‚„åŸå¾Œï¼Œé‡æ–°åŸ·è¡Œæ­£å‘æµç¨‹
   ```bash
   python tools/features/excel_to_yaml.py \
     --input data/features/{site_id}/{site_id}.xlsx \
     --output config/features/sites/{site_id}.yaml</p>
</li>
</ol>
<p># ç¢ºèªç„¡èª¤å¾Œæäº¤
   git add config/features/sites/{site_id}.yaml
   git commit -m "fix: å›å¾©èª¤åˆªçš„æ¬„ä½å®šç¾©è‡³ <commit_hash>"
   ```</p>
<p>âš ï¸ <strong>è­¦å‘Š</strong>ï¼š<code>--mode recovery</code> æœƒè¦†è“‹ç¾æœ‰ Excelï¼Œè«‹ç¢ºä¿å·²å‚™ä»½æˆ–å·²å˜—è©¦å…¶ä»–å¾©åŸæ–¹å¼ã€‚</p>
<h3 id="72-awizard-excel">7.2 æƒ…å¢ƒ Aï¼šWizard èª¤åˆªæ¬„ä½ï¼ˆExcel å±¤éŒ¯èª¤ï¼‰</h3>
<p><strong>è§¸ç™¼æ¢ä»¶</strong>ï¼šWizard æ›´æ–°æ™‚èª¤åˆ¤æ¬„ä½ç‚ºéæœŸä¸¦ç§»é™¤ï¼Œæˆ–ä½¿ç”¨è€…èª¤æ“ä½œå°è‡´è³‡æ–™éºå¤±ã€‚</p>
<p><strong>æ¢å¾©æµç¨‹</strong>ï¼ˆå„ªå…ˆä½¿ç”¨æœ¬åœ°å‚™ä»½ï¼Œé€Ÿåº¦å¿«ä¸”ä¿ç•™å·¥ä½œç‹€æ…‹ï¼‰ï¼š</p>
<ol>
<li><strong>æª¢æŸ¥æœ¬åœ°å‚™ä»½</strong>ï¼ˆæ¨è–¦é¦–é¸ï¼‰ï¼š
   ```bash
   # æŸ¥çœ‹ Wizard è‡ªå‹•å‚™ä»½ï¼ˆä¾æ™‚é–“æ’åºï¼Œæœ€æ–°åœ¨å‰ï¼‰
   ls -lt data/features/{site_id}/.backups/<em>.backup.</em></li>
</ol>
<p># ç¢ºèªå‚™ä»½æ™‚é–“é»ï¼ˆWizard åŸ·è¡Œå‰ï¼‰
   ls -l data/features/{site_id}/.backups/ | grep "backup"</p>
<p># é‚„åŸåˆ° Wizard åŸ·è¡Œå‰çš„ç‰ˆæœ¬ï¼ˆæ›¿æ› {timestamp}ï¼‰
   cp data/features/{site_id}/.backups/{site_id}.backup.{timestamp}.xlsx \
      data/features/{site_id}/{site_id}.xlsx</p>
<p>echo "âœ… å·²é‚„åŸè‡³ Wizard åŸ·è¡Œå‰çš„ç‰ˆæœ¬"
   ```</p>
<ol>
<li><strong>è‹¥ç„¡æœ¬åœ°å‚™ä»½ï¼Œä½¿ç”¨ Git å›é€€</strong>ï¼š</li>
<li>éµå¾ªã€Œ7.1 æ ¸å¿ƒåŸå‰‡ã€çš„ä¸‰æ­¥é©Ÿæµç¨‹</li>
<li>æ³¨æ„ï¼šGit å›é€€æœƒéºå¤± Wizard åŸ·è¡Œå¾Œçš„æ‰€æœ‰ Excel æ‰‹å‹•ä¿®æ”¹</li>
</ol>
<h3 id="73-bexcel-yaml">7.3 æƒ…å¢ƒ Bï¼šExcel æ‰‹å‹•èª¤åˆªæ¬„ä½ï¼ˆå·²ç”Ÿæˆ YAMLï¼‰</h3>
<p><strong>è§¸ç™¼æ¢ä»¶</strong>ï¼šå·¥ç¨‹å¸«æ‰‹å‹•åˆªé™¤ Excel æ¬„ä½å¾ŒåŸ·è¡Œäº† <code>excel_to_yaml.py</code>ï¼Œç”šè‡³å·² Git commitï¼Œç™¼ç¾èª¤åˆªã€‚</p>
<p><strong>æ¢å¾©æµç¨‹</strong>ï¼ˆGit ä¸»å°ï¼‰ï¼š</p>
<p>ç”±æ–¼ YAML å·²ç”Ÿæˆï¼ˆä¸”å¯èƒ½å·² Git commitï¼‰ï¼Œå¿…é ˆé€é Git å›é€€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ­¥é©Ÿ 1ï¼šç¢ºèªæœ€å¾Œæ­£ç¢ºçš„ commitï¼ˆæŸ¥çœ‹ YAML æ­·å²ï¼‰</span>
git<span class="w"> </span>log<span class="w"> </span>--oneline<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml
<span class="c1"># è¼¸å‡ºç¯„ä¾‹ï¼š</span>
<span class="c1"># a1b2c3d  feat: æ–°å¢å†·å»æ°´å¡”æ¬„ä½</span>
<span class="c1"># e4f5g6h  fix: ä¿®æ­£å–®ä½éŒ¯èª¤  &lt;-- å‡è¨­é€™æ˜¯æœ€å¾Œæ­£ç¢ºç‰ˆæœ¬</span>
<span class="c1"># i7j8k9l  feat: èª¤åˆªé‡è¦æ¬„ä½ï¼ˆéŒ¯èª¤æäº¤ï¼‰</span>

<span class="c1"># æ­¥é©Ÿ 2ï¼šé‚„åŸ YAMLï¼ˆè»Ÿé‚„åŸï¼Œä¿ç•™å·¥ä½œå€å…¶ä»–ä¿®æ”¹ï¼‰</span>
git<span class="w"> </span>checkout<span class="w"> </span>e4f5g6h<span class="w"> </span>--<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml

<span class="c1"># æ­¥é©Ÿ 3ï¼šé‡å»º Excelï¼ˆrecovery æ¨¡å¼ï¼Œå¼·åˆ¶è¦†è“‹ï¼‰</span>
python<span class="w"> </span>tools/features/yaml_to_excel.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--yaml<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/<span class="o">{</span>site_id<span class="o">}</span>.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--mode<span class="w"> </span>recovery<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--force

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;âœ… Excel å·²å¾ Git æ­·å²ç‰ˆæœ¬é‡å»º&quot;</span>

<span class="c1"># æ­¥é©Ÿ 4ï¼šé‡æ–°ç”Ÿæˆ YAMLï¼ˆç¢ºä¿æ ¼å¼æ­£ç¢ºï¼Œchecksum æ›´æ–°ï¼‰</span>
python<span class="w"> </span>tools/features/excel_to_yaml.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--input<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/<span class="o">{</span>site_id<span class="o">}</span>.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml

<span class="c1"># æ­¥é©Ÿ 5ï¼šæäº¤ä¿®æ­£ï¼ˆå¦‚æœéŒ¯èª¤å·²æ¨é€è‡³é ç«¯ï¼Œä½¿ç”¨ revert è€Œé resetï¼‰</span>
git<span class="w"> </span>add<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;fix: å›å¾©èª¤åˆªçš„æ¬„ä½å®šç¾©è‡³ e4f5g6h&quot;</span>

<span class="c1"># è‹¥å·²æ¨é€éŒ¯èª¤ç‰ˆæœ¬ï¼Œå»ºè­°ä½¿ç”¨ revert å»ºç«‹åå‘æäº¤è€Œé force push</span>
<span class="c1"># git revert i7j8k9l --no-commit</span>
<span class="c1"># git commit -m &quot;revert: æ’¤éŠ·èª¤åˆªæ¬„ä½çš„æäº¤&quot;</span>
</code></pre></div>

<h3 id="74-cexcel">7.4 æƒ…å¢ƒ Cï¼šExcel æª”æ¡ˆææ¯€ï¼ˆç¡¬é«”/è»Ÿé«”éŒ¯èª¤ï¼‰</h3>
<p><strong>è§¸ç™¼æ¢ä»¶</strong>ï¼šExcel æª”æ¡ˆææ¯€ç„¡æ³•é–‹å•Ÿï¼ˆå¦‚ç£ç¢ŸéŒ¯èª¤ã€è»Ÿé«”å´©æ½°å°è‡´æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼‰ã€‚</p>
<p><strong>æ¢å¾©æµç¨‹</strong>ï¼š</p>
<p>ç›´æ¥å¾ YAML é‡å»ºï¼ˆç„¡éœ€ Git æ“ä½œï¼Œå›  YAML æœªææ¯€ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æª¢æŸ¥ YAML æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ</span>
ls<span class="w"> </span>-lh<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml

<span class="c1"># ä½¿ç”¨ recovery æ¨¡å¼é‡å»ºï¼ˆç„¡éœ€ Git æ­·å²ï¼‰</span>
python<span class="w"> </span>tools/features/yaml_to_excel.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--yaml<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/<span class="o">{</span>site_id<span class="o">}</span>_recovered.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--mode<span class="w"> </span>recovery

<span class="c1"># é©—è­‰é‡å»ºçš„ Excel</span>
python<span class="w"> </span>tools/features/excel_to_yaml.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--input<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/<span class="o">{</span>site_id<span class="o">}</span>_recovered.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>/tmp/validation.yaml

diff<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml<span class="w"> </span>/tmp/validation.yaml<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;âœ… é‡å»ºé©—è­‰é€šé&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;âš ï¸ é‡å»ºå¾Œå…§å®¹æœ‰å·®ç•°ï¼Œè«‹æª¢æŸ¥&quot;</span>

<span class="c1"># ç¢ºèªç„¡èª¤å¾Œï¼Œå°‡ recovered æª”æ¡ˆæ”¹ç‚ºæ­£å¼åç¨±</span>
mv<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/<span class="o">{</span>site_id<span class="o">}</span>_recovered.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/<span class="o">{</span>site_id<span class="o">}</span>.xlsx
</code></pre></div>

<h3 id="75-dyaml">7.5 æƒ…å¢ƒ Dï¼šYAML è¢«æ‰‹å‹•ä¿®æ”¹ï¼ˆé•åè¦ç¯„ï¼‰</h3>
<p><strong>è§¸ç™¼æ¢ä»¶</strong>ï¼šæœ‰äººç›´æ¥ç·¨è¼¯ YAML æª”æ¡ˆï¼Œå°è‡´èˆ‡ Excel ä¸åŒæ­¥ã€‚</p>
<p><strong>æª¢æ¸¬æ–¹å¼</strong>ï¼š
- CI/CD æ¯”å° checksum å¤±æ•—
- æ‰‹å‹•åŸ·è¡Œ <code>check_sync_status()</code> ç™¼ç¾ä¸ä¸€è‡´</p>
<p><strong>æ¢å¾©æµç¨‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¦‚æœ YAML è¢«æ‰‹å‹•ä¿®æ”¹ä¸”æœªæäº¤ Gitï¼ˆå»ºè­°ç›´æ¥æ¨æ£„ï¼‰</span>
git<span class="w"> </span>checkout<span class="w"> </span>HEAD<span class="w"> </span>--<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml

<span class="c1"># å¦‚æœå·²æäº¤ï¼ŒæŸ¥çœ‹å·®ç•°æ±ºå®šä¿ç•™å“ªå€‹ç‰ˆæœ¬</span>
git<span class="w"> </span>diff<span class="w"> </span>HEAD~1<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml

<span class="c1"># æ±ºå®šæ¨æ£„æ‰‹å‹•ä¿®æ”¹ï¼Œå›å¾©è‡³ Excel ç”Ÿæˆçš„ç‰ˆæœ¬ï¼ˆéµå¾ª SSOTï¼‰</span>
git<span class="w"> </span>revert<span class="w"> </span>&lt;éŒ¯èª¤çš„_commit_hash&gt;

<span class="c1"># ç„¶å¾Œé‡æ–°å¾ Excel ç”Ÿæˆï¼ˆç¢ºä¿ Excel ç‚ºæœ€æ–°æ­£ç¢ºç‹€æ…‹ï¼‰</span>
python<span class="w"> </span>tools/features/excel_to_yaml.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--input<span class="w"> </span>data/features/<span class="o">{</span>site_id<span class="o">}</span>/<span class="o">{</span>site_id<span class="o">}</span>.xlsx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>config/features/sites/<span class="o">{</span>site_id<span class="o">}</span>.yaml
</code></pre></div>

<h3 id="76-yaml_to_excel">7.6 æ¨¡å¼èªªæ˜ï¼š<code>yaml_to_excel</code> çš„å…©ç¨®æ¨¡å¼</h3>
<table>
<thead>
<tr>
<th>æ¨¡å¼</th>
<th>ä½¿ç”¨æ™‚æ©Ÿ</th>
<th>è¡Œç‚ºå·®ç•°</th>
<th>é¢¨éšªç­‰ç´š</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>init</code></td>
<td>æ–°æ¡ˆå ´å°å…¥ã€åˆå§‹åŒ–</td>
<td>æª¢æŸ¥ç›®æ¨™ Excel <strong>ä¸å­˜åœ¨</strong>ï¼Œè‹¥å­˜åœ¨å‰‡å ±éŒ¯ï¼ˆé˜²èª¤è¦†è“‹ï¼‰</td>
<td>ä½</td>
</tr>
<tr>
<td><code>recovery</code></td>
<td>ç½é›£æ¢å¾©ã€ç‰ˆæœ¬å›é€€</td>
<td>å…è¨±è¦†è“‹ç¾æœ‰ Excelï¼Œä¸æª¢æŸ¥ç‰ˆæœ¬åŒæ­¥ç‹€æ…‹ï¼Œå¼·åˆ¶é‡å»º</td>
<td><strong>é«˜</strong></td>
</tr>
</tbody>
</table>
<p><strong>å¼·åˆ¶è¦†è“‹åƒæ•¸</strong>ï¼š<code>--force</code>ï¼ˆåœ¨ <code>recovery</code> æ¨¡å¼ä¸‹å¿…é ˆä½¿ç”¨ï¼Œæœƒè¦†è“‹ç¾æœ‰ <code>.xlsx</code> ä¸”ä¸æç¤ºï¼‰</p>
<p><strong>Recovery æ¨¡å¼ä½¿ç”¨è­¦å‘Š</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;recovery&#39;</span> <span class="ow">and</span> <span class="n">excel_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span>
        <span class="s2">&quot;Recovery æ¨¡å¼å°‡è¦†è“‹ç¾æœ‰ Excelï¼Œè«‹ç¢ºèªå·²å‚™ä»½æˆ–é€™æ˜¯é æœŸè¡Œç‚ºã€‚</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;è‹¥ç¢ºèªï¼Œè«‹åŠ ä¸Š --force åƒæ•¸åŸ·è¡Œã€‚&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8">8. éŒ¯èª¤èˆ‡è­¦å‘Šä»£ç¢¼å°ç…§è¡¨ï¼ˆæ›´æ–°ï¼‰</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">ä»£ç¢¼</th>
<th style="text-align: left;">åç¨±</th>
<th style="text-align: center;">å±¤ç´š</th>
<th style="text-align: left;">è§¸ç™¼æ¢ä»¶</th>
<th style="text-align: left;">è™•ç†æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>E400</strong></td>
<td style="text-align: left;">TEMPLATE_VERSION_MISMATCH</td>
<td style="text-align: center;">Error</td>
<td style="text-align: left;">Excel ç¯„æœ¬ç‰ˆæœ¬ä¸ç¬¦</td>
<td style="text-align: left;">åŸ·è¡Œ migrate_excel.py å‡ç´š</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E401</strong></td>
<td style="text-align: left;">ORPHAN_COLUMN</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">æ¨™è¨»æ¬„ä½ä¸å­˜åœ¨æ–¼è³‡æ–™</td>
<td style="text-align: left;">è¨˜éŒ„æ—¥èªŒï¼Œç¹¼çºŒåŸ·è¡Œ</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E402</strong></td>
<td style="text-align: left;">UNANNOTATED_COLUMN</td>
<td style="text-align: center;">Error/Warning</td>
<td style="text-align: left;">è³‡æ–™æ¬„ä½æœªå®šç¾©ï¼ˆåš´æ ¼æ¨¡å¼ï¼‰</td>
<td style="text-align: left;">Error: é˜»æ“‹ï¼›Warning: è‡ªå‹•æ¨æ–·</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E403</strong></td>
<td style="text-align: left;">UNIT_INCOMPATIBLE</td>
<td style="text-align: center;">Error</td>
<td style="text-align: left;">å–®ä½èˆ‡ç‰©ç†é¡å‹ä¸åŒ¹é…ï¼ˆå¦‚æº«åº¦é¸ Barï¼‰</td>
<td style="text-align: left;">é˜»æ“‹ç”Ÿæˆï¼Œè¿”å› Excel ä¿®æ­£</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E404</strong></td>
<td style="text-align: left;">LAG_FORMAT_INVALID</td>
<td style="text-align: center;">Error</td>
<td style="text-align: left;">Lag é–“éš”æ ¼å¼éŒ¯èª¤</td>
<td style="text-align: left;">é˜»æ“‹ç”Ÿæˆ</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E405</strong></td>
<td style="text-align: left;">TARGET_LEAKAGE_RISK</td>
<td style="text-align: center;">Error</td>
<td style="text-align: left;">is_target=True ä½† enable_lag=True</td>
<td style="text-align: left;">Pydantic è‡ªå‹•æ””æˆª</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E406</strong></td>
<td style="text-align: left;">EXCEL_YAML_OUT_OF_SYNC</td>
<td style="text-align: center;">Error</td>
<td style="text-align: left;">Excel ä¿®æ”¹æ™‚é–“æ™šæ–¼ YAML</td>
<td style="text-align: left;">æç¤ºé‡æ–°åŸ·è¡Œ excel_to_yaml.py</td>
</tr>
<tr>
<td style="text-align: center;"><strong>E407</strong></td>
<td style="text-align: left;">BACKUP_RESTORE_REQUIRED</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">Excel ææ¯€æˆ–èª¤åˆªï¼Œæª¢æ¸¬åˆ°å¯ç”¨å‚™ä»½</td>
<td style="text-align: left;">æç¤ºä½¿ç”¨è€…å¾ <code>.backups/</code> ç›®éŒ„æ‰‹å‹•é‚„åŸ</td>
</tr>
<tr>
<td style="text-align: center;"><strong>W401</strong></td>
<td style="text-align: left;">MEAN_OUT_OF_RANGE</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">å¹³å‡å€¼è¶…å‡ºé æœŸç¯„åœ</td>
<td style="text-align: left;">æ¨™è¨˜ pending_reviewï¼Œå¯å¿½ç•¥</td>
</tr>
<tr>
<td style="text-align: center;"><strong>W402</strong></td>
<td style="text-align: left;">LOW_VARIANCE</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">æ¨™æº–å·®æ¥è¿‘é›¶</td>
<td style="text-align: left;">æª¢æŸ¥å‡çµè³‡æ–™</td>
</tr>
<tr>
<td style="text-align: center;"><strong>W403</strong></td>
<td style="text-align: left;">HIGH_ZERO_RATIO</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">é›¶å€¼æ¯”ä¾‹éé«˜ï¼ˆä¸»è¨­å‚™ï¼‰</td>
<td style="text-align: left;">å‚™ç”¨è¨­å‚™è‡ªå‹•æŠ‘åˆ¶</td>
</tr>
<tr>
<td style="text-align: center;"><strong>W404</strong></td>
<td style="text-align: left;">BACKUP_CLEANUP_FAILED</td>
<td style="text-align: center;">Warning</td>
<td style="text-align: left;">æ¸…ç†èˆŠå‚™ä»½æ™‚æ¬Šé™ä¸è¶³</td>
<td style="text-align: left;">é€šçŸ¥ç³»çµ±ç®¡ç†å“¡ï¼Œä¸é˜»æ“‹æµç¨‹</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9-v12">9. äº¤ä»˜ç‰©æ¸…å–®ï¼ˆv1.2ï¼‰</h2>
<h3 id="91">9.1 é…ç½®æ–‡ä»¶</h3>
<ol>
<li><code>config/features/schema.json</code> - JSON Schemaï¼ˆæ›´æ–°è‡³ v1.2ï¼‰</li>
<li><code>config/features/physical_types.yaml</code> - ç‰©ç†é¡å‹å®šç¾©ï¼ˆå«çµ±è¨ˆåƒæ•¸ï¼‰</li>
<li><code>.gitignore</code> - æ›´æ–°æ’é™¤ Excel å·¥ä½œæª”æ¡ˆ</li>
</ol>
<h3 id="92-excel">9.2 Excel å·¥å…·éˆï¼ˆæ›´æ–°ï¼‰</h3>
<ol>
<li><code>tools/features/templates/Feature_Template_v1.2.xlsx</code> - éœæ…‹é©—è­‰ç¯„æœ¬ï¼ˆå« System Sheetï¼‰</li>
<li><code>tools/features/wizard.py</code> - <strong>åƒ…æ›´æ–° Excel</strong>ï¼Œå«è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶ï¼ˆä¿ç•™ 10 ç‰ˆæœ¬ï¼‰</li>
<li><code>tools/features/excel_to_yaml.py</code> - å¼·åŒ–å–®ä½ç›¸å®¹æ€§é©—è­‰èˆ‡åŒæ­¥æª¢æŸ¥</li>
<li><code>tools/features/yaml_to_excel.py</code> - é€†å‘è½‰æ›ï¼ˆæ”¯æ´ init èˆ‡ recovery æ¨¡å¼ï¼‰</li>
<li><code>tools/features/migrate_excel.py</code> - ç¯„æœ¬å‡ç´šå·¥å…·ï¼ˆv1.1â†’v1.2ï¼‰</li>
</ol>
<h3 id="93">9.3 é©—è­‰èˆ‡æª¢æŸ¥</h3>
<ol>
<li><code>src/features/sync_checker.py</code> - Excel/YAML åŒæ­¥ç‹€æ…‹æª¢æŸ¥ï¼ˆå« checksum æ¯”å°ï¼‰</li>
<li><code>src/features/annotation_validator.py</code> - Pydantic æ¨¡å‹ï¼ˆæ›´æ–° device_role, ignore_warningsï¼‰</li>
<li><code>src/features/backup_manager.py</code> - å‚™ä»½æ¸…ç†èˆ‡ç®¡ç†ï¼ˆä¿ç•™ç­–ç•¥å¯¦ä½œï¼‰</li>
</ol>
<h3 id="94">9.4 æ–‡ä»¶</h3>
<ol>
<li><code>docs/features/FEATURE_ANNOTATION_v1.2.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/features/MIGRATION_GUIDE_v1.1_to_v1.2.md</code> - å‡ç´šæŒ‡å¼•</li>
<li><code>docs/features/EXCEL_TUTORIAL.md</code> - ç©ºèª¿æŠ€å¸«æ“ä½œæ‰‹å†Šï¼ˆå« Wizard æµç¨‹èˆ‡ç½é›£æ¢å¾© SOPï¼‰</li>
<li><code>docs/features/DISASTER_RECOVERY_RUNBOOK.md</code> - ç½é›£æ¢å¾©æ“ä½œæ‰‹å†Šï¼ˆå¿«é€ŸæŸ¥é–±ç‰ˆï¼‰</li>
</ol>
<hr />
<h2 id="10-v12">10. é©—æ”¶ç°½æ ¸ï¼ˆv1.2 é‡é»ï¼‰</h2>
<ul>
<li>[ ] <strong>Wizard åƒ…æ›´æ–° Excel</strong>: ç¢ºèª Wizard ç„¡æ³•ç›´æ¥å¯«å…¥ YAMLï¼ˆæŠ€è¡“é˜»æ“‹ï¼‰</li>
<li>[ ] <strong>ç«¶æ…‹æ¢ä»¶æ¸¬è©¦</strong>: </li>
<li>Wizard æ›´æ–° Excel â†’ 2. æ‰‹å‹•ä¿®æ”¹ Excel â†’ 3. åŸ·è¡Œ excel_to_yaml â†’ 4. ç¢ºèª YAML æ­£ç¢ºåæ˜ æ­¥é©Ÿ 2 çš„ä¿®æ”¹ï¼ˆè€Œéæ­¥é©Ÿ 1 çš„èˆŠå€¼ï¼‰</li>
<li>[ ] <strong>ç‰ˆæœ¬é˜»æ“‹</strong>: ä½¿ç”¨ v1.1 Excel ç¯„æœ¬åŸ·è¡Œ excel_to_yaml æ™‚ï¼Œæ­£ç¢ºå ±éŒ¯ E400 ä¸¦æç¤ºå‡ç´š</li>
<li>[ ] <strong>å–®ä½é©—è­‰</strong>: åœ¨ Excel é¸æ“‡ <code>temperature</code> + <code>bar</code>ï¼ŒåŸ·è¡Œè½‰æ›æ™‚æ­£ç¢ºå ±éŒ¯ E403</li>
<li>[ ] <strong>è¨­å‚™è§’è‰²</strong>: æ¨™è¨˜ <code>device_role=backup</code> çš„æ¬„ä½ï¼Œçµ±è¨ˆé›¶å€¼æ¯”ä¾‹ 80% æ™‚ä¸è§¸ç™¼ W403</li>
<li>[ ] <strong>åŒæ­¥æª¢æŸ¥</strong>: Excel ä¿®æ”¹å¾Œæœªé‡æ–°ç”Ÿæˆ YAMLï¼ŒåŸ·è¡Œ Pipeline æ™‚æ­£ç¢ºå ±éŒ¯ E406</li>
<li>[ ] <strong>è‡ªå‹•å‚™ä»½</strong>: Wizard åŸ·è¡Œæ™‚æ­£ç¢ºç”Ÿæˆ <code>.backup.{timestamp}</code> æª”æ¡ˆï¼Œä¸¦ä¿ç•™æœ€è¿‘ 10 å€‹ç‰ˆæœ¬</li>
<li>[ ] <strong>å‚™ä»½é‚„åŸ</strong>: æ‰‹å‹•åˆªé™¤ Excel æ¬„ä½å¾Œï¼Œèƒ½å¾ <code>.backups/</code> æˆåŠŸé‚„åŸä¸¦é‡æ–°ç”Ÿæˆ YAML</li>
<li>[ ] <strong>Git å›é€€</strong>: æ¨¡æ“¬ã€Œèª¤åˆªæ¬„ä½ä¸¦å·² commitã€ï¼Œèƒ½é€é <code>git checkout</code> + <code>yaml_to_excel --mode recovery</code> å®Œæ•´æ¢å¾©</li>
<li>[ ] <strong>Recovery æ¨¡å¼ä¿è­·</strong>: æœªåŠ  <code>--force</code> åŸ·è¡Œ recovery æ¨¡å¼æ™‚ï¼Œæ­£ç¢ºé˜»æ­¢è¦†è“‹ç¾æœ‰ Excelï¼ˆé˜²èª¤æ“ä½œï¼‰</li>
</ul>
<hr />
    
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>

</body>
</html>
