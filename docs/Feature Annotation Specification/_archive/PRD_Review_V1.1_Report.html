<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_Review_V1.1_Report</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v11">特徵標註 PRD (v1.1) 審查與優化報告</h1>
<p><strong>審查對象</strong>: <code>PRD_Feature_Annotation_Specification_V1.1.md</code><br />
<strong>審查重點</strong>: Excel 雙軌制的可行性、Wizard 流程與 SSOT 的衝突風險<br />
<strong>文件版本</strong>: Review v1.1<br />
<strong>日期</strong>: 2026-02-13</p>
<hr />
<h2 id="1-general-assessment">1. 總體評價 (General Assessment)</h2>
<p>V1.1 版本已顯著改善了 V1.0 的易用性問題，成功引入了 <strong>Excel 介面</strong> 與 <strong>Wizard CLI</strong>，並加入了 <strong>統計驗證 (Distribution Check)</strong>，這對於降低領域專家的操作門檻至關重要。</p>
<p>該文件在架構設計上（Excel → YAML → SSOT）清晰合理。然而，在實作細節上仍有幾個潛在的<strong>技術陷阱</strong>與<strong>流程衝突</strong>需要解決，特別是 Excel 的進階功能限制與雙向同步問題。</p>
<hr />
<h2 id="2-critical-risks-findings">2. 關鍵風險與檢討 (Critical Risks &amp; Findings)</h2>
<h3 id="21-excel-excel-technical-constraints">2.1 Excel 技術實作風險 (Excel Technical Constraints)</h3>
<ul>
<li>
<p><strong>動態下拉選單的脆弱性 (Dynamic Dropdown Fragility)</strong><br />
    PRD 提到利用 Excel Data Validation 實現「單位 (C欄)」依賴「物理類型 (B欄)」的動態選單。</p>
<ul>
<li><strong>風險</strong>: 在不使用 VBA (巨集) 的情況下，Excel 需依賴 <code>INDIRECT()</code> 函數與 Named Ranges。這在使用者進行 <strong>剪貼 (Copy-Paste)</strong> 或 <strong>拖曳 (Drag-Fill)</strong> 操作時非常容易損壞引用，導致驗證失效。</li>
<li><strong>建議</strong>: 放棄 Excel端的「嚴格動態驗證」，改為：<ol>
<li>Excel 端僅提供「所有單位」的靜態下拉選單（或按類別分群的長選單）。</li>
<li><strong>依賴 Python 轉換腳本 (<code>excel_to_yaml.py</code>) 進行邏輯檢查</strong> (即 PRD 4.2 節已有的設計)。這能降低 Excel 範本的維護難度。</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>Excel 版本相容性</strong>  </p>
<ul>
<li><code>schema_version</code> 目前存在於 Metadata Sheet。建議在 Excel 範本中增加一個隱藏的 <code>CheckSum</code> 或 <code>TemplateVersion</code> 欄位，確保 Python 腳本能識別並拒絕「舊版 Excel 範本」（例如欄位定義已變更的舊範本）。</li>
</ul>
</li>
</ul>
<h3 id="22-wizard-excel-wizard-excel-race-condition">2.2 流程衝突：Wizard 與 Excel 的競態 (Wizard-Excel Race Condition)</h3>
<p>PRD 5.2 描述的 Wizard 流程是：<code>Wizard -&gt; 更新 YAML</code>。<br />
同時 PRD 1.2 定義的核心流程是：<code>Excel -&gt; Python -&gt; YAML</code>。</p>
<ul>
<li><strong>風險 (CRITICAL)</strong>: 若使用者先用 Wizard 產生了新的 YAML 設定（例如新增了一台冰機），此時 <strong>Excel 檔案並未同步更新</strong>。<ul>
<li>當使用者下次打開舊的 Excel 編輯並匯出時，<strong>Wizard 產生的變更將被覆蓋 (Overwritten)</strong>，導致資料遺失。</li>
</ul>
</li>
<li><strong>建議</strong>: <ol>
<li><strong>Wizard 必須操作 Excel</strong>: Wizard 的輸出目標應為更新 <code>.xlsx</code> 檔案，而非直接寫入 <code>.yaml</code>。</li>
<li>或者，提供 <code>yaml_to_excel</code> 的同步機制（PRD 6.2 已提及），但必須強制規定：「使用 Wizard 後，必須執行 <code>yaml_to_excel</code> 更新 Excel，否則禁止下次 Excel 匯入」。</li>
<li><strong>最佳解</strong>: 統一流程，Wizard 的作用改為「生成/更新 Excel 草稿」，由使用者打開 Excel 確認後，再執行轉 YAML。這樣確保 Excel 永遠是編輯的源頭。</li>
</ol>
</li>
</ul>
<h3 id="23-false-positive">2.3 統計驗證的 False Positive 風險</h3>
<ul>
<li><strong>風險</strong>: <code>zero_ratio_warning</code> (零值比例) 對於某些設備（如備用冰機）是常態。若頻繁發出 W403 警告，使用者會習慣性忽略。</li>
<li><strong>建議</strong>: 在 Excel (Sheet 1) 增加一個 <code>ignore_warnings</code> 或 <code>is_backup_device</code> 欄位，允許使用者顯式聲明「這台設備常態為停機」，從而抑制特定的統計警告。</li>
</ul>
<hr />
<h2 id="3-optimization-recommendations">3. 優化建議 (Optimization Recommendations)</h2>
<h3 id="31-wizard">3.1 修正 Wizard 輸出目標</h3>
<p>建議將 Wizard 的行為修改為更新 Excel 檔案，保持「Excel = Editor」的原則。</p>
<p><strong>修正前</strong>:</p>
<pre><code class="language-bash">python main.py features wizard --site cgmh_ty ...
&gt; ✅ 完成！已更新 config/features/sites/cgmh_ty.yaml
</code></pre>
<p><strong>修正後</strong>:</p>
<pre><code class="language-bash">python main.py features wizard --site cgmh_ty --excel tools/features/cgmh_ty.xlsx
&gt; ✅ 完成！已將新欄位追加至 cgmh_ty.xlsx (Sheet: Columns)
&gt; 請打開 Excel 確認標註，確認後執行 excel_to_yaml.py
</code></pre>
<h3 id="32-excel">3.2 增強 Excel 範本版本控制</h3>
<p>在 <code>excel_to_yaml.py</code> 加入範本版本檢查：</p>
<pre><code class="language-python">EXPECTED_TEMPLATE_VERSION = &quot;1.1&quot;

def validate_excel_template(df_meta):
    ver = df_meta.loc[&quot;template_version&quot;, 1]
    if ver != EXPECTED_TEMPLATE_VERSION:
        raise ValueError(f&quot;Excel 範本版本過舊 ({ver})，請下載最新版 v{EXPECTED_TEMPLATE_VERSION}&quot;)
</code></pre>
<h3 id="33-group-policy">3.3 簡化 Group Policy 欄位</h3>
<p>在 Excel 的 Group Policies Sheet 中，<code>Lag 間隔</code> 與 <code>Rolling 窗口</code> 建議改為下拉選單選擇「預設樣板」(如 <code>Standard_Chiller</code>, <code>High_Freq_Sensor</code>)，而非讓使用者手動輸入數字 <code>1,4,96</code>。這樣可以更進一步降低錯誤率，並統一全案場的特徵工程標準。</p>
<hr />
<h2 id="4">4. 結論</h2>
<p>V1.1 PRD 方向正確，但在「Excel 與 Wizard 的同步」上存在邏輯漏洞。請務必修正 <strong>Wizard 的輸出目標</strong>，確保 Excel 檔案始終是編輯的唯一入口，避免「雙頭馬車」導致的設定覆蓋問題。</p>
<p>除上述點外，該文件已具備高度的可執行性。</p>
</body>
</html>