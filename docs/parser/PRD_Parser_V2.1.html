<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRD_Parser_V2.1</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    color: #24292e;
    background-color: #fff;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }
code {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: #f6f8fa;
    border-radius: 6px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
}
pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
}
pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: initial;
    border: 0;
}
blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0;
}
table {
    display: block;
    width: 100%;
    margin-top: 0;
    margin-bottom: 16px;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}
table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}
</style>

</head>
<body>
<h1 id="prd-v21-reportparser-robustness-refactoring">PRD v2.1: å ±è¡¨è§£æå™¨å¼ºå¥æ€§é‡æ§‹ (ReportParser Robustness Refactoring)</h1>
<p><strong>æ–‡ä»¶ç‰ˆæœ¬:</strong> v2.1 (Interface Contract Alignment &amp; Zero-Gap Integration)<br />
<strong>æ—¥æœŸ:</strong> 2026-02-13<br />
<strong>è² è²¬äºº:</strong> Oscar Chang<br />
<strong>ç›®æ¨™æ¨¡çµ„:</strong> <code>src/etl/parser.py</code> (v2.1+)<br />
<strong>ç›¸ä¾æ¨¡çµ„:</strong> <code>src/etl/cleaner.py</code> (v2.2+), <code>src/etl/config_models.py</code> (SSOT)<br />
<strong>ä¸Šæ¸¸è¦ç¯„:</strong> <code>INTERFACE_CONTRACT_v1.0</code> (æª¢æŸ¥é» #1)<br />
<strong>é ä¼°å·¥æ™‚:</strong> 3 ~ 3.5 å€‹å·¥ç¨‹å¤©ï¼ˆå«æ•´åˆæ¸¬è©¦ï¼‰</p>
<hr />
<h2 id="1">1. åŸ·è¡Œç¸½ç¶±èˆ‡è®Šæ›´æ‘˜è¦</h2>
<h3 id="11-v20-v21">1.1 ç‰ˆæœ¬è®Šæ›´ç¸½è¦½ (v2.0 â†’ v2.1)</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">è®Šæ›´é¡åˆ¥</th>
<th style="text-align: left;">v2.0 ç‹€æ…‹</th>
<th style="text-align: left;">v2.1 ä¿®æ­£</th>
<th style="text-align: center;">å½±éŸ¿å±¤ç´š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>æ™‚å€è¼¸å‡º</strong></td>
<td style="text-align: left;">è¼¸å‡º <code>Asia/Taipei</code></td>
<td style="text-align: left;"><strong>å¼·åˆ¶è¼¸å‡º <code>UTC</code></strong> (Breaking Change)</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç·¨ç¢¼é©—è­‰</strong></td>
<td style="text-align: left;">ç„¡è¼¸å‡ºé©—è­‰</td>
<td style="text-align: left;">å¢åŠ  UTF-8 BOM æ®˜ç•™æª¢æŸ¥</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>å¥‘ç´„é©—è­‰</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;">æ–°å¢ <code>_validate_output_contract()</code></td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSOT å¼•ç”¨</strong></td>
<td style="text-align: left;">ç„¡</td>
<td style="text-align: left;">æ˜ç¢ºå¼•ç”¨ <code>VALID_QUALITY_FLAGS</code> é€²è¡Œæ¬„ä½é©—è­‰</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ä¸‹æ¸¸éŠœæ¥</strong></td>
<td style="text-align: left;">éš±å¼å¥‘ç´„</td>
<td style="text-align: left;">æ˜ç¢ºå°é½Š <code>Cleaner v2.2</code> Input Contract</td>
<td style="text-align: center;">ğŸ”´ Critical</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 æ ¸å¿ƒè¨­è¨ˆåŸå‰‡</h3>
<ol>
<li><strong>å¥‘ç´„å„ªå…ˆ (Contract-First)</strong>: æ‰€æœ‰è¼¸å‡ºå¿…é ˆé€šé Interface Contract v1.0 æª¢æŸ¥é» #1</li>
<li><strong>Single Source of Truth (SSOT)</strong>: ç·¨ç¢¼è¦ç¯„ã€æ™‚å€è¦ç¯„ã€æ¬„ä½å‘½åè¦ç¯„çµ±ä¸€å¼•ç”¨ <code>config_models.py</code></li>
<li><strong>é˜²ç¦¦æ€§è¼¸å‡º</strong>: å¯§å¯æ‹‹å‡ºä¾‹å¤–çµ‚æ­¢æµç¨‹ï¼Œä¹Ÿä¸è¼¸å‡ºä¸ç¬¦åˆå¥‘ç´„çš„è³‡æ–™</li>
<li><strong>é›¶é–“éš™å°æ¥</strong>: ç¢ºä¿èˆ‡ Cleaner v2.2 çš„è¨˜æ†¶é«”éŠœæ¥ç„¡éœ€é¡å¤–è½‰æ›ï¼ˆæ™‚å€ã€ç·¨ç¢¼ã€æ ¼å¼ï¼‰</li>
</ol>
<hr />
<h2 id="2-cleaner-input-contract">2. ä¸‹æ¸¸å¥‘ç´„èˆ‡æ¥å£è¦ç¯„ (Cleaner Input Contract)</h2>
<p>Parser v2.1 çš„è¼¸å‡ºå¿…é ˆåš´æ ¼ç¬¦åˆä»¥ä¸‹è¦ç¯„ï¼Œé€™æ˜¯èˆ‡ Cleaner v2.2 çš„<strong>ç¡¬æ€§å¥‘ç´„</strong>ï¼š</p>
<h3 id="21">2.1 æ¬„ä½èˆ‡å‹åˆ¥è¦ç¯„</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¬„ä½åç¨±</th>
<th style="text-align: left;">Polars å‹åˆ¥</th>
<th style="text-align: left;">è¦ç¯„é™åˆ¶</th>
<th style="text-align: left;">é©—è­‰é‚è¼¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>timestamp</code></td>
<td style="text-align: left;"><code>Datetime(time_unit='ns', time_zone='UTC')</code></td>
<td style="text-align: left;"><strong>å¼·åˆ¶ UTC</strong>ï¼Œä¸å¯ç‚º None</td>
<td style="text-align: left;"><code>dtype.time_zone == "UTC"</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>quality_flags</code></td>
<td style="text-align: left;"><code>List(Utf8)</code> (å¯é¸)</td>
<td style="text-align: left;">è‹¥å­˜åœ¨ï¼Œå€¼å¿…é ˆ âŠ† <code>VALID_QUALITY_FLAGS</code></td>
<td style="text-align: left;">æ¬„ä½å­˜åœ¨æ€§æª¢æŸ¥</td>
</tr>
<tr>
<td style="text-align: left;">æ•¸å€¼æ¬„ä½</td>
<td style="text-align: left;"><code>Float64</code></td>
<td style="text-align: left;">ç„¡å–®ä½å­—å…ƒã€ç„¡ç§‘å­¸è¨˜è™Ÿæ®˜ç•™</td>
<td style="text-align: left;">æ­£è¦è¡¨é”å¼é©—è­‰</td>
</tr>
<tr>
<td style="text-align: left;">å­—ä¸²æ¬„ä½</td>
<td style="text-align: left;"><code>Utf8</code></td>
<td style="text-align: left;">ç·¨ç¢¼å¿…é ˆç‚º UTF-8ï¼Œç„¡ BOM</td>
<td style="text-align: left;"><code>"\ufeff" not in col</code></td>
</tr>
</tbody>
</table>
<h3 id="22">2.2 ç·¨ç¢¼èˆ‡å­—å…ƒè¦ç¯„</h3>
<ul>
<li><strong>è¼¸å‡ºç·¨ç¢¼</strong>: å¼·åˆ¶ UTF-8 (ç„¡ BOM)</li>
<li><strong>ç¦æ­¢å­—å…ƒ</strong>: ä¸å¯åŒ…å« <code>\ufeff</code> (UTF-8 BOM), <code>\x00</code> (Null byte)</li>
<li><strong>æ›è¡Œç¬¦è™Ÿ</strong>: çµ±ä¸€ç‚º <code>\n</code> (LF)ï¼Œç§»é™¤ <code>\r</code> (CR)</li>
</ul>
<h3 id="23">2.3 æ™‚å€å¼·åˆ¶è¦ç¯„ (é—œéµä¿®æ­£)</h3>
<p><strong>ç„¡è«–è¼¸å…¥è³‡æ–™ç‚ºä½•ç¨®æ™‚å€ï¼Œè¼¸å‡ºå¿…é ˆç‚º UTC</strong>ï¼š</p>
<pre><code class="language-python"># è¼¸å…¥å¯èƒ½æ€§ï¼š
# 1. Naive datetime (ç„¡æ™‚å€) â†’ å‡è¨­ç‚º Asia/Taipei â†’ è½‰æ›ç‚º UTC
# 2. Asia/Taipei (UTC+8) â†’ è½‰æ›ç‚º UTC  
# 3. å…¶ä»–æ™‚å€ (å¦‚ America/New_York) â†’ è½‰æ›ç‚º UTC
# 4. å·²ç‚º UTC â†’ ç›´æ¥é€šé

# è¼¸å‡ºçµ±ä¸€ç‚ºï¼š
# Datetime(time_unit='ns', time_zone='UTC')
</code></pre>
<hr />
<h2 id="3-phase-based-implementation">3. åˆ†éšæ®µå¯¦ä½œè¨ˆç•« (Phase-Based Implementation)</h2>
<h3 id="phase-1-ssot-day-1">Phase 1: åŸºç¤å»ºè¨­èˆ‡ SSOT å¼•ç”¨ (Day 1)</h3>
<h4 id="step-11">Step 1.1: å»ºç«‹è‡ªè¨‚ä¾‹å¤–é¡åˆ¥ (ä¾‹å¤–åˆ†ç´š)</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/exceptions.py</code> (è‹¥å·²å­˜åœ¨å‰‡æ“´å……)</p>
<p><strong>æ–°å¢ä¾‹å¤–é¡åˆ¥</strong>:</p>
<pre><code class="language-python">class ContractViolationError(Exception):
    &quot;&quot;&quot;é•åæ¨¡çµ„é–“ä»‹é¢å¥‘ç´„ (Interface Contract)&quot;&quot;&quot;
    pass

class EncodingError(ContractViolationError):
    &quot;&quot;&quot;ç·¨ç¢¼ç›¸é—œéŒ¯èª¤ (ç„¡æ³•åµæ¸¬ã€BOMæ®˜ç•™ã€éUTF-8è¼¸å‡º)&quot;&quot;&quot;
    pass

class TimezoneError(ContractViolationError):
    &quot;&quot;&quot;æ™‚å€è½‰æ›éŒ¯èª¤æˆ–éé æœŸæ™‚å€ (E102/E111)&quot;&quot;&quot;
    pass

class DataValidationError(Exception):
    &quot;&quot;&quot;è³‡æ–™å…§å®¹é©—è­‰å¤±æ•— (Schemaã€Nullsã€å‹åˆ¥)&quot;&quot;&quot;
    pass
</code></pre>
<p><strong>é©—æ”¶æ¨™æº–</strong>:<br />
- [ ] æ‰€æœ‰ä¾‹å¤–å¯è¢« <code>parser.py</code> æ­£ç¢º import<br />
- [ ] ä¾‹å¤–è¨Šæ¯å¿…é ˆåŒ…å«é•åçš„å¥‘ç´„æ¢æ¬¾ç·¨è™Ÿ (å¦‚ <code>E101_ENCODING_MISMATCH</code>)</p>
<h4 id="step-12-ssot">Step 1.2: SSOT é…ç½®å¼•ç”¨</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>src/etl/parser.py</code> (æª”æ¡ˆé ‚éƒ¨)</p>
<p><strong>å¯¦ä½œå…§å®¹</strong>:</p>
<pre><code class="language-python">from src.etl.config_models import (
    VALID_QUALITY_FLAGS,  # SSOT: å“è³ªæ¨™è¨˜å”¯ä¸€çœŸç›¸æº
    TIMESTAMP_CONFIG,     # SSOT: æ™‚é–“æˆ³è¦ç¯„
    ParserConfig          # é…ç½®æ¨¡å‹
)
</code></pre>
<p><strong>é©—æ”¶æ¨™æº–</strong>:<br />
- [ ] ç„¡ç¡¬ç·¨ç¢¼çš„ flags åˆ—è¡¨ (å¦‚ <code>["FROZEN", "OUTLIER"]</code>)<br />
- [ ] æ™‚å€è½‰æ›é‚è¼¯å¼•ç”¨ <code>TIMESTAMP_CONFIG["time_zone"]</code> (æ‡‰ç‚º "UTC")</p>
<hr />
<h3 id="phase-2-day-1-2">Phase 2: ç·¨ç¢¼è‡ªé©æ‡‰èˆ‡æ¨™é ­æœå°‹ (Day 1-2)</h3>
<h4 id="step-21-bom">Step 2.1: ç·¨ç¢¼è‡ªå‹•åµæ¸¬ (å« BOM è™•ç†)</h4>
<p><strong>æ–¹æ³•</strong>: <code>_detect_encoding(file_path: Path) -&gt; str</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:<br />
1. <strong>BOM å„ªå…ˆåµæ¸¬</strong>:<br />
<code>python
   with open(file_path, 'rb') as f:
       raw = f.read(4)
       if raw.startswith(b'\xef\xbb\xbf'):
           return 'utf-8-sig'  # Python æœƒè‡ªå‹•è™•ç† BOM
       elif raw.startswith(b'\xff\xfe') or raw.startswith(b'\xfe\xff'):
           return 'utf-16'</code></p>
<ol start="2">
<li><strong>ç·¨ç¢¼å˜—è©¦é †åº</strong> (åš´æ ¼é †åºï¼Œä¸å¯èª¿æ›):<br />
   - å˜—è©¦ <code>utf-8</code>: ä½¿ç”¨ <code>raw.decode('utf-8')</code>ï¼ŒæˆåŠŸå‰‡å›å‚³ <code>'utf-8'</code><br />
   - å˜—è©¦ <code>cp950</code> (Big5): ä½¿ç”¨ <code>raw.decode('cp950')</code>ï¼ŒæˆåŠŸå‰‡å›å‚³ <code>'cp950'</code><br />
   - å˜—è©¦ <code>utf-16</code>: ä½¿ç”¨ <code>raw.decode('utf-16')</code>ï¼ŒæˆåŠŸå‰‡å›å‚³ <code>'utf-16'</code><br />
   - å…¨éƒ¨å¤±æ•—: æ‹‹å‡º <code>EncodingError(f"E101: ç„¡æ³•åµæ¸¬ç·¨ç¢¼ï¼Œå·²å˜—è©¦ UTF-8/Big5/UTF-16")</code></li>
</ol>
<p><strong>é©—æ”¶æ¨™æº–</strong>:<br />
- [ ] UTF-8 BOM æª”æ¡ˆ (<code>\ufeff</code>) ä¸æœƒåœ¨æ¬„ä½åç¨±æˆ–è³‡æ–™ä¸­æ®˜ç•™<br />
- [ ] Big5 ç·¨ç¢¼æª”æ¡ˆ (å¦‚å°ç£ BAS ç³»çµ±åŒ¯å‡º) æ­£ç¢ºè®€å–<br />
- [ ] ç·¨ç¢¼éŒ¯èª¤æª”æ¡ˆæ‹‹å‡º <code>E101_ENCODING_MISMATCH</code></p>
<h4 id="step-22">Step 2.2: æ™ºæ…§æ¨™é ­æœå°‹ (å¤šèªç³»èˆ‡ä¸€è‡´æ€§é©—è­‰)</h4>
<p><strong>æ–¹æ³•</strong>: <code>_find_header_line(file_path: Path, encoding: str) -&gt; int</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<ol>
<li>
<p><strong>é—œéµå­—å®šç¾©</strong> (å¼•ç”¨ SSOT):<br />
<code>python
   HEADER_KEYWORDS = {
       'timestamp': ['Date', 'Time', 'æ—¥æœŸ', 'æ™‚é–“', 'DateTime', 'Timestamp', 'æ—¶é—´'],
       'required': ['Date', 'æ—¥æœŸ']  # å¿…é ˆè‡³å°‘å­˜åœ¨ä¸€å€‹
   }</code></p>
</li>
<li>
<p><strong>æœå°‹ç¯„åœ</strong>: å‰ 500 è¡Œ (å¯é…ç½® <code>max_header_scan_lines</code>)</p>
</li>
<li>
<p><strong>å€™é¸è¡Œè©•åˆ†</strong>:<br />
   - æ‰¾åˆ°åŒæ™‚åŒ…å« <code>Date/æ—¥æœŸ</code> èˆ‡ <code>Time/æ™‚é–“</code> çš„è¡Œ â†’ åˆ†æ•¸ +2<br />
   - æ‰¾åˆ°åŒ…å« <code>DateTime/Timestamp</code> çš„è¡Œ â†’ åˆ†æ•¸ +2<br />
   - è©²è¡Œæ¬„ä½æ•¸é‡ &gt; 3 â†’ åˆ†æ•¸ +1</p>
</li>
<li>
<p><strong>åˆ†éš”ç¬¦ä¸€è‡´æ€§é©—è­‰</strong> (é˜²èª¤è§¸):<br />
   ```python<br />
   candidate_line = lines[header_line]<br />
   next_line = lines[header_line + 1]</p>
</li>
</ol>
<p># è¨ˆç®—åˆ†éš”ç¬¦æ•¸é‡ (é€—è™Ÿã€Tabã€åˆ†è™Ÿ)<br />
   candidate_delims = count_delimiters(candidate_line)<br />
   next_delims = count_delimiters(next_line)</p>
<p># å¿…é ˆä¸€è‡´ (å®¹å·® Â±1ï¼Œè€ƒæ…®æœ€å¾Œä¸€æ¬„å¯èƒ½ç‚ºç©º)<br />
   if abs(candidate_delims - next_delims) &gt; 1:<br />
       continue  # è·³éæ­¤å€™é¸è¡Œï¼Œç¹¼çºŒæœå°‹<br />
   ```</p>
<ol start="5">
<li><strong>å¤±æ•—è™•ç†</strong>:<br />
   - è‹¥æ‰¾ä¸åˆ°æ¨™é ­è¡Œï¼Œæ‹‹å‡º <code>ContractViolationError("E104: ç„¡æ³•å®šä½æ¨™é ­è¡Œï¼Œå·²æƒæ 500 è¡Œ")</code><br />
   - ç¦æ­¢ fallback åˆ°ç¡¬ç·¨ç¢¼è¡Œè™Ÿ (å¦‚ 211)</li>
</ol>
<p><strong>é©—æ”¶æ¨™æº–</strong>:<br />
- [ ] ä¸­æ–‡æ¨™é ­ (<code>æ—¥æœŸ</code>, <code>æ™‚é–“</code>) æ­£ç¢ºè­˜åˆ¥<br />
- [ ] åŒ…å«ç‰¹æ®Šå‰ç¶´çš„æ¨™é ­ (<code>&lt;&gt;Date</code>, <code>"Time"</code>) æ­£è¦åŒ–å¾Œè­˜åˆ¥<br />
- [ ] ä¸­ç¹¼è³‡æ–™è¡Œ (åˆ†éš”ç¬¦æ•¸é‡èˆ‡è³‡æ–™è¡Œä¸ç¬¦) ä¸æœƒè¢«èª¤åˆ¤ç‚ºæ¨™é ­<br />
- [ ] ç„¡æ¨™é ­æª”æ¡ˆæ‹‹å‡ºæ˜ç¢ºä¾‹å¤– (ééœé»˜ fallback)</p>
<h4 id="step-23">Step 2.3: æ¨™é ­æ­£è¦åŒ–</h4>
<p><strong>æ–¹æ³•</strong>: <code>_normalize_header(headers: List[str]) -&gt; List[str]</code></p>
<p><strong>è™•ç†è¦å‰‡</strong>:<br />
1. ç§»é™¤å‰å¾Œç©ºç™½: <code>strip()</code><br />
2. ç§»é™¤å¼•è™Ÿ: <code>replace('"', '').replace("'", '')</code><br />
3. ç§»é™¤ç‰¹æ®Šå‰ç¶´: <code>replace('&lt;&gt;', '')</code><br />
4. çµ±ä¸€å‘½å: å°‡ <code>æ—¥æœŸ</code> æ˜ å°„ç‚º <code>Date</code>ï¼Œ<code>æ™‚é–“</code> æ˜ å°„ç‚º <code>Time</code> (ç‚ºå¾ŒçºŒ timestamp åˆä½µåšæº–å‚™)<br />
5. é©—è­‰å”¯ä¸€æ€§: è‹¥æ­£è¦åŒ–å¾Œä»æœ‰é‡è¤‡æ¬„ä½åç¨±ï¼Œæ‹‹å‡º <code>DataValidationError</code></p>
<p><strong>é©—æ”¶æ¨™æº–</strong>:<br />
- [ ] <code>"&lt;&gt;Date"</code> â†’ <code>Date</code><br />
- [ ] <code>"  Time  "</code> â†’ <code>Time</code><br />
- [ ] <code>"æº«åº¦_1"</code> â†’ <code>æº«åº¦_1</code> (ä¿ç•™ä¸­æ–‡ï¼Œä½†ç¢ºä¿ç„¡ç©ºç™½)</p>
<hr />
<h3 id="phase-3-day-2">Phase 3: è³‡æ–™è§£æèˆ‡æ¸…æ´— (Day 2)</h3>
<h4 id="step-31">Step 3.1: é«’è³‡æ–™è™•ç†èˆ‡å¼·åˆ¶è½‰å‹</h4>
<p><strong>æ–¹æ³•</strong>: <code>_clean_and_cast(df: pl.DataFrame) -&gt; pl.DataFrame</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<ol>
<li>
<p><strong>Null å€¼å®šç¾©</strong> (æ“´å……):<br />
<code>python
   NULL_VALUES = [
       "", "NA", "null", "NULL", 
       "---", "Error", "N/A", "OFF", "OFFLINE", 
       "#VALUE!", "#N/A", "None", "--"
   ]</code></p>
</li>
<li>
<p><strong>æ•¸å€¼æ¬„ä½æ¸…æ´—</strong> (é‡å° BAS å¸¸è¦‹é«’è³‡æ–™):<br />
   ```python<br />
   for col in numeric_columns:<br />
       # æ­¥é©Ÿ 1: ç§»é™¤å–®ä½èˆ‡éæ•¸å­—å­—å…ƒ (ä¿ç•™æ•¸å­—ã€å°æ•¸é»ã€è² è™Ÿã€ç§‘å­¸è¨˜è™Ÿ)<br />
       df = df.with_columns(<br />
           pl.col(col).str.replace_all(r"[^0-9.-eE]", "").alias(col)<br />
       )</p>
<p># æ­¥é©Ÿ 2: ç©ºå­—ä¸²è½‰ç‚º Null<br />
   df = df.with_columns(<br />
       pl.when(pl.col(col) == "").then(None).otherwise(pl.col(col)).alias(col)<br />
   )</p>
<p># æ­¥é©Ÿ 3: å¼·åˆ¶è½‰å‹ Float64 (ç„¡æ³•è½‰å‹å‰‡è¨­ç‚º Nullï¼Œéæ‹‹å‡ºä¾‹å¤–)<br />
   df = df.with_columns(<br />
       pl.col(col).cast(pl.Float64, strict=False)<br />
   )<br />
   ```</p>
</li>
<li>
<p><strong>æ™‚é–“æ¬„ä½åˆä½µ</strong>:<br />
   - è‹¥å­˜åœ¨åˆ†é–‹çš„ <code>Date</code> èˆ‡ <code>Time</code> æ¬„ä½ï¼Œåˆä½µç‚º <code>timestamp</code><br />
   - æ ¼å¼: <code>yyyy-MM-dd HH:mm:ss</code> (å‡è¨­ç‚º Asia/Taipei è¼¸å…¥ï¼Œå¾ŒçºŒè½‰ UTC)</p>
</li>
</ol>
<p><strong>é©—æ”¶æ¨™æº–</strong>:<br />
- [ ] <code>"25.3 C"</code> â†’ <code>25.3</code> (Float64)<br />
- [ ] <code>"100%"</code> â†’ <code>100.0</code> (Float64)<br />
- [ ] <code>"---"</code> â†’ <code>null</code><br />
- [ ] <code>"Error"</code> â†’ <code>null</code><br />
- [ ] è½‰å‹å¤±æ•—ä¸æ‹‹å‡ºä¾‹å¤–ï¼Œè¨­ç‚º Null ä¸¦è¨˜éŒ„ Warning</p>
<hr />
<h3 id="phase-4-day-2-3">Phase 4: æ™‚å€æ¨™æº–åŒ– (é—œéµä¿®æ­£) (Day 2-3)</h3>
<h4 id="step-34-v21">Step 3.4: æ™‚å€å¼·åˆ¶è½‰æ› (v2.1 æ ¸å¿ƒä¿®æ­£)</h4>
<p><strong>æ–¹æ³•</strong>: <code>_standardize_timezone(df: pl.DataFrame) -&gt; pl.DataFrame</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<pre><code class="language-python">def _standardize_timezone(self, df: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;
    å¼·åˆ¶å°‡æ™‚é–“æˆ³è½‰æ›ç‚º UTC (Interface Contract v1.0 å¼·åˆ¶è¦ç¯„)

    è™•ç†æµç¨‹:
    1. æª¢æŸ¥è¼¸å…¥æ™‚å€
    2. è‹¥ç„¡æ™‚å€ (Naive)ï¼Œå‡è¨­ç‚º Asia/Taipei (å°ç£ BAS ç³»çµ±æ…£ä¾‹)
    3. è½‰æ›ç‚º UTC
    4. é©—è­‰è¼¸å‡ºæ™‚å€
    &quot;&quot;&quot;
    if &quot;timestamp&quot; not in df.columns:
        raise ContractViolationError(&quot;E103: ç¼ºå°‘å¿…è¦æ¬„ä½ 'timestamp'&quot;)

    ts_col = df[&quot;timestamp&quot;]

    # æƒ…æ³ 1: å·²ç‚º UTC â†’ ç›´æ¥é€šé (ä½†éœ€ç¢ºä¿ time_unit='ns')
    if str(ts_col.dtype.time_zone) == &quot;UTC&quot;:
        self.logger.debug(&quot;è¼¸å…¥å·²ç‚º UTCï¼Œåƒ…ç¢ºèª time_unit&quot;)
        return df.with_columns(
            pl.col(&quot;timestamp&quot;).dt.cast_time_unit(&quot;ns&quot;)
        )

    # æƒ…æ³ 2: ç‚ºå…¶ä»–æ™‚å€ (å¦‚ Asia/Taipei) â†’ è½‰æ›ç‚º UTC
    if ts_col.dtype.time_zone is not None:
        self.logger.info(f&quot;å°‡æ™‚å€ {ts_col.dtype.time_zone} è½‰æ›ç‚º UTC&quot;)
        return df.with_columns(
            pl.col(&quot;timestamp&quot;)
            .dt.convert_time_zone(&quot;UTC&quot;)
            .dt.cast_time_unit(&quot;ns&quot;)  # ç¢ºä¿ nanoseconds
        )

    # æƒ…æ³ 3: ç„¡æ™‚å€ (Naive) â†’ å‡è¨­ç‚º Asia/Taipei å¾Œè½‰ UTC
    # ã€æ³¨æ„ã€‘é€™æ˜¯é‡å°å°ç£ BAS ç³»çµ±çš„æ¥­å‹™é‚è¼¯ï¼Œè‹¥æ“´å±•è‡³å…¶ä»–åœ°å€éœ€æ”¹ç‚ºé…ç½®
    self.logger.warning(&quot;æ™‚é–“æˆ³ç„¡æ™‚å€è³‡è¨Šï¼Œå‡è¨­ç‚º Asia/Taipei ä¸¦è½‰æ›ç‚º UTC&quot;)
    return df.with_columns(
        pl.col(&quot;timestamp&quot;)
        .dt.replace_time_zone(&quot;Asia/Taipei&quot;)  # å…ˆè³¦äºˆæ™‚å€
        .dt.convert_time_zone(&quot;UTC&quot;)           # å†è½‰æ›
        .dt.cast_time_unit(&quot;ns&quot;)
    )
</code></pre>
<p><strong>é—œéµé©—è­‰é»</strong>:<br />
- [ ] è¼¸å‡º <code>df.schema["timestamp"]</code> å¿…é ˆé¡¯ç¤º <code>Datetime(time_unit='ns', time_zone='UTC')</code><br />
- [ ] è¼¸å…¥ <code>Asia/Taipei</code> (å¦‚ <code>2026-02-13 08:00:00+08:00</code>) â†’ è¼¸å‡º <code>2026-02-13 00:00:00+00:00</code><br />
- [ ] è¼¸å…¥ç„¡æ™‚å€ (å¦‚ <code>2026-02-13 08:00:00</code>) â†’ è¦–ç‚º <code>Asia/Taipei</code> â†’ è¼¸å‡º <code>2026-02-13 00:00:00+00:00</code></p>
<hr />
<h3 id="phase-5-day-3">Phase 5: è¼¸å‡ºå¥‘ç´„é©—è­‰ (Day 3)</h3>
<h4 id="step-35-output-contract-validation">Step 3.5: è¼¸å‡ºå¥‘ç´„é©—è­‰ (Output Contract Validation)</h4>
<p><strong>æ–¹æ³•</strong>: <code>_validate_output_contract(df: pl.DataFrame) -&gt; None</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<pre><code class="language-python">def _validate_output_contract(self, df: pl.DataFrame) -&gt; None:
    &quot;&quot;&quot;
    æœ€çµ‚è¼¸å‡ºé©—è­‰ (Interface Contract v1.0 æª¢æŸ¥é» #1)

    é©—è­‰é …ç›®:
    1. å¿…è¦æ¬„ä½å­˜åœ¨æ€§
    2. æ™‚é–“æˆ³æ™‚å€èˆ‡ç²¾åº¦
    3. ç·¨ç¢¼æ­£ç¢ºæ€§ (ç„¡ BOM)
    4. Quality flags åˆæ³•æ€§ (è‹¥å­˜åœ¨)
    &quot;&quot;&quot;
    errors = []

    # 1. å¿…è¦æ¬„ä½æª¢æŸ¥ (E103)
    required_cols = [&quot;timestamp&quot;]
    missing = set(required_cols) - set(df.columns)
    if missing:
        errors.append(f&quot;E103: ç¼ºå°‘å¿…è¦æ¬„ä½: {missing}&quot;)

    # 2. æ™‚é–“æˆ³å‹åˆ¥èˆ‡æ™‚å€æª¢æŸ¥ (E102)
    ts_dtype = df[&quot;timestamp&quot;].dtype
    if not isinstance(ts_dtype, pl.Datetime):
        errors.append(f&quot;E102: timestamp å¿…é ˆç‚º Datetimeï¼Œå¾—åˆ° {ts_dtype}&quot;)
    elif str(ts_dtype.time_zone) != &quot;UTC&quot;:
        errors.append(f&quot;E102: timestamp æ™‚å€å¿…é ˆç‚º UTCï¼Œå¾—åˆ° {ts_dtype.time_zone}&quot;)
    elif ts_dtype.time_unit != &quot;ns&quot;:
        errors.append(f&quot;E102: timestamp ç²¾åº¦å¿…é ˆç‚º nanosecondsï¼Œå¾—åˆ° {ts_dtype.time_unit}&quot;)

    # 3. ç·¨ç¢¼æª¢æŸ¥ (E101) - ç¢ºä¿ç„¡ BOM æ®˜ç•™
    for col in df.columns:
        if df[col].dtype == pl.Utf8:
            if df[col].str.contains(&quot;\ufeff&quot;).any():
                errors.append(f&quot;E101: æ¬„ä½ '{col}' åŒ…å« UTF-8 BOM æ®˜ç•™&quot;)
            if df[col].str.contains(&quot;\x00&quot;).any():
                errors.append(f&quot;E101: æ¬„ä½ '{col}' åŒ…å« Null byte&quot;)

    # 4. Quality Flags åˆæ³•æ€§æª¢æŸ¥ (E103)
    if &quot;quality_flags&quot; in df.columns:
        actual_flags = set()
        for flags in df[&quot;quality_flags&quot;]:
            if flags:
                actual_flags.update(flags)

        # æ³¨æ„: Parser é€šå¸¸ä¸ç”¢ç”Ÿ quality_flagsï¼Œä½†è‹¥ç”¢ç”Ÿå¿…é ˆç¬¦åˆ SSOT
        invalid_flags = actual_flags - set(VALID_QUALITY_FLAGS)
        if invalid_flags:
            errors.append(
                f&quot;E103: quality_flags åŒ…å«æœªå®šç¾©çš„æ¨™è¨˜: {invalid_flags}. &quot;
                f&quot;SSOT å…è¨±: {VALID_QUALITY_FLAGS}&quot;
            )

    # 5. æ•¸å€¼æ¬„ä½å‹åˆ¥æª¢æŸ¥
    for col in df.columns:
        if col in [&quot;timestamp&quot;, &quot;quality_flags&quot;]:
            continue
        # æ‰€æœ‰éæ™‚é–“/æ¨™è¨˜æ¬„ä½æ‡‰ç‚º Float64 (æˆ– Int64ï¼Œä½†çµ±ä¸€ç‚º Float64 æ›´å®‰å…¨)
        if df[col].dtype not in [pl.Float64, pl.Int64]:
            errors.append(f&quot;E103: æ¬„ä½ '{col}' å‹åˆ¥ç‚º {df[col].dtype}ï¼Œé æœŸç‚ºæ•¸å€¼å‹åˆ¥&quot;)

    if errors:
        raise ContractViolationError(
            f&quot;Parser è¼¸å‡ºå¥‘ç´„é©—è­‰å¤±æ•— ({len(errors)} é …):\n&quot; + &quot;\n&quot;.join(errors)
        )
</code></pre>
<p><strong>é©—æ”¶æ¨™æº–</strong>:<br />
- [ ] æ™‚å€é UTC æ™‚æ‹‹å‡º <code>ContractViolationError</code> (E102)<br />
- [ ] æ¬„ä½å« BOM æ™‚æ‹‹å‡º <code>ContractViolationError</code> (E101)<br />
- [ ] ç¼ºå°‘ <code>timestamp</code> æ™‚æ‹‹å‡º <code>ContractViolationError</code> (E103)</p>
<hr />
<h3 id="phase-6-day-3">Phase 6: æ¡ˆå ´é…ç½®èˆ‡æ“´å±• (Day 3)</h3>
<h4 id="step-41-site-templates">Step 4.1: æ¡ˆå ´è¨­å®šæª”çµæ§‹ (Site Templates)</h4>
<p><strong>æª”æ¡ˆ</strong>: <code>config/site_templates.yaml</code></p>
<p><strong>çµæ§‹</strong>:</p>
<pre><code class="language-yaml">schema_version: &quot;2.1&quot;

default:
  encoding: auto          # auto | utf-8 | cp950 | utf-16
  delimiter: &quot;,&quot;          # è‡ªå‹•åµæ¸¬æ™‚çš„å„ªå…ˆé †åº: , â†’ \t â†’ ;
  header_keywords:
    date: [&quot;Date&quot;, &quot;æ—¥æœŸ&quot;, &quot;date&quot;, &quot;DATE&quot;]
    time: [&quot;Time&quot;, &quot;æ™‚é–“&quot;, &quot;time&quot;, &quot;TIME&quot;]
    datetime: [&quot;DateTime&quot;, &quot;Timestamp&quot;, &quot;æ—¥æœŸæ™‚é–“&quot;]

  # æ™‚å€è¨­å®š (v2.1 æ–°å¢ï¼Œç”¨æ–¼ naive datetime çš„é è¨­è³¦å€¼)
  assumed_timezone: &quot;Asia/Taipei&quot;  # åƒ…åœ¨è¼¸å…¥ç„¡æ™‚å€æ™‚ä½¿ç”¨

  null_values: [&quot;&quot;, &quot;NA&quot;, &quot;null&quot;, &quot;---&quot;, &quot;Error&quot;, &quot;N/A&quot;, &quot;OFF&quot;, &quot;OFFLINE&quot;, &quot;#VALUE!&quot;]

  # æ¬„ä½åç¨±æ˜ å°„ (æ¨™æº–åŒ–å°ç…§è¡¨)
  column_mapping:
    &quot;å†°æ°´ä¸»æ©Ÿé›»æµ&quot;: &quot;chiller_current&quot;
    &quot;å†·å»æ°´å¡”æº«åº¦&quot;: &quot;ct_temp&quot;
    &quot;å¤–æ°£æº«åº¦&quot;: &quot;oat&quot;

# é•·åºšé†«é™¢æ¡ƒåœ’é™¢å€
cgmh_ty:
  inherit: default
  header_prefix: &quot;&lt;&gt;&quot;           # ç‰¹æ®Šå‰ç¶´è™•ç†
  assumed_timezone: &quot;Asia/Taipei&quot;

# é é›„ O3
farglory_o3:
  inherit: default
  delimiter: &quot;\t&quot;               # Tab åˆ†éš”
  encoding: cp950               # å›ºå®šç·¨ç¢¼ (æ•ˆèƒ½å„ªåŒ–)
</code></pre>
<h4 id="step-42">Step 4.2: é…ç½®è¼‰å…¥èˆ‡ç¹¼æ‰¿è§£æ</h4>
<p><strong>æ–¹æ³•</strong>: <code>__init__(self, site_id: str = "default")</code></p>
<p><strong>è©³ç´°é‚è¼¯</strong>:</p>
<pre><code class="language-python">def __init__(self, site_id: str = &quot;default&quot;):
    self.site_id = site_id
    self.config = self._load_site_config(site_id)
    self.logger = get_logger(f&quot;parser.{site_id}&quot;)

def _load_site_config(self, site_id: str) -&gt; Dict:
    &quot;&quot;&quot;è¼‰å…¥é…ç½®ä¸¦è™•ç†ç¹¼æ‰¿ (inherit)&quot;&quot;&quot;
    with open(&quot;config/site_templates.yaml&quot;, 'r', encoding='utf-8') as f:
        all_configs = yaml.safe_load(f)

    if site_id not in all_configs:
        raise ConfigurationError(f&quot;æœªå®šç¾©çš„æ¡ˆå ´ ID: {site_id}&quot;)

    config = all_configs[site_id]

    # è™•ç†ç¹¼æ‰¿
    if &quot;inherit&quot; in config:
        parent_id = config.pop(&quot;inherit&quot;)
        parent_config = all_configs.get(parent_id, {})
        # æ·±åº¦åˆä½µ (å­é…ç½®è¦†è“‹çˆ¶é…ç½®)
        merged = {**parent_config, **config}
        return merged

    return config
</code></pre>
<hr />
<h2 id="4-call-chain">4. å®Œæ•´æ–¹æ³•å‘¼å«éˆ (Call Chain)</h2>
<pre><code>parse_file(file_path)
  â”œâ”€â”€ _detect_encoding(file_path) â†’ encoding
  â”œâ”€â”€ _find_header_line(file_path, encoding) â†’ header_line
  â”œâ”€â”€ pl.read_csv(
  â”‚     encoding=encoding,
  â”‚     skip_rows=header_line,
  â”‚     null_values=config[&quot;null_values&quot;]
  â”‚   ) â†’ raw_df
  â”œâ”€â”€ _normalize_header(raw_df.columns) â†’ normalized_df
  â”œâ”€â”€ _clean_and_cast(normalized_df) â†’ cleaned_df
  â”œâ”€â”€ _standardize_timezone(cleaned_df) â†’ utc_df (é—œéµ)
  â”œâ”€â”€ _validate_output_contract(utc_df) â†’ void (é—œéµ)
  â””â”€â”€ return utc_df
</code></pre>
<hr />
<h2 id="5-error-codes">5. éŒ¯èª¤ä»£ç¢¼å°ç…§è¡¨ (Error Codes)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">éŒ¯èª¤ä»£ç¢¼</th>
<th style="text-align: left;">åç¨±</th>
<th style="text-align: center;">ç™¼ç”Ÿéšæ®µ</th>
<th style="text-align: left;">ä½¿ç”¨è€…è¨Šæ¯ (User Message)</th>
<th style="text-align: left;">è™•ç†å»ºè­°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>E101</strong></td>
<td style="text-align: left;"><code>ENCODING_MISMATCH</code></td>
<td style="text-align: center;">Step 2.1</td>
<td style="text-align: left;">ç„¡æ³•åµæ¸¬æª”æ¡ˆç·¨ç¢¼ï¼Œæˆ–è¼¸å‡ºåŒ…å«éæ³•å­—å…ƒ (BOM)</td>
<td style="text-align: left;">ç¢ºèªæª”æ¡ˆç‚º UTF-8/Big5/UTF-16 ä¹‹ä¸€ï¼›æª¢æŸ¥æ˜¯å¦å« BOM</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E102</strong></td>
<td style="text-align: left;"><code>TIMEZONE_VIOLATION</code></td>
<td style="text-align: center;">Step 3.5</td>
<td style="text-align: left;">è¼¸å‡ºæ™‚é–“æˆ³æ™‚å€é UTCï¼Œæˆ–ç²¾åº¦é nanoseconds</td>
<td style="text-align: left;">æª¢æŸ¥ <code>_standardize_timezone</code> é‚è¼¯</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E103</strong></td>
<td style="text-align: left;"><code>CONTRACT_VIOLATION</code></td>
<td style="text-align: center;">Step 3.5</td>
<td style="text-align: left;">ç¼ºå°‘å¿…è¦æ¬„ä½ (timestamp)ï¼Œæˆ– quality_flags æœªå®šç¾©</td>
<td style="text-align: left;">ç¢ºèªæ¨™é ­è¡Œæ­£ç¢ºè­˜åˆ¥ï¼›æ›´æ–° SSOT flags å®šç¾©</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E104</strong></td>
<td style="text-align: left;"><code>HEADER_NOT_FOUND</code></td>
<td style="text-align: center;">Step 2.2</td>
<td style="text-align: left;">æƒæ 500 è¡Œä»ç„¡æ³•å®šä½æ¨™é ­</td>
<td style="text-align: left;">æ‰‹å‹•æª¢æŸ¥æª”æ¡ˆæ ¼å¼ï¼›æ›´æ–° header_keywords</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E105</strong></td>
<td style="text-align: left;"><code>COLUMN_VALIDATION</code></td>
<td style="text-align: center;">Step 3.1</td>
<td style="text-align: left;">æ¬„ä½æ­£è¦åŒ–å¾Œé‡è¤‡ï¼Œæˆ–æ•¸å€¼è½‰å‹å¤±æ•—ç‡éé«˜ (&gt;50%)</td>
<td style="text-align: left;">æª¢æŸ¥é«’è³‡æ–™è™•ç†é‚è¼¯ï¼›ç¢ºèª column_mapping</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-test-plan">6. æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•« (Test Plan)</h2>
<h3 id="61-unit-tests">6.1 å–®å…ƒæ¸¬è©¦ (Unit Tests)</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>tests/test_parser_v21.py</code></p>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">è¼¸å…¥</th>
<th style="text-align: left;">é æœŸè¼¸å‡º</th>
<th style="text-align: center;">å°æ‡‰ Step</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">P21-001</td>
<td style="text-align: left;">UTF-8 BOM è™•ç†</td>
<td style="text-align: left;">UTF-8 with BOM CSV</td>
<td style="text-align: left;">ç„¡ BOM æ®˜ç•™ï¼Œæ¬„ä½åç¨±æ­£ç¢º</td>
<td style="text-align: center;">2.1</td>
</tr>
<tr>
<td style="text-align: left;">P21-002</td>
<td style="text-align: left;">Big5 ç·¨ç¢¼åµæ¸¬</td>
<td style="text-align: left;">Big5 ç·¨ç¢¼ CSV (å°ç£ BAS)</td>
<td style="text-align: left;">æ­£ç¢ºè§£æä¸­æ–‡æ¨™é ­</td>
<td style="text-align: center;">2.1</td>
</tr>
<tr>
<td style="text-align: left;">P21-003</td>
<td style="text-align: left;">æ™‚å€è½‰æ› Asia/Taipei â†’ UTC</td>
<td style="text-align: left;"><code>2026-02-13 08:00:00+08:00</code></td>
<td style="text-align: left;"><code>2026-02-13 00:00:00+00:00</code></td>
<td style="text-align: center;">3.4</td>
</tr>
<tr>
<td style="text-align: left;">P21-004</td>
<td style="text-align: left;">Naive datetime å‡è¨­æ™‚å€</td>
<td style="text-align: left;"><code>2026-02-13 08:00:00</code> (ç„¡æ™‚å€)</td>
<td style="text-align: left;">è¦–ç‚º Asia/Taipei â†’ UTC</td>
<td style="text-align: center;">3.4</td>
</tr>
<tr>
<td style="text-align: left;">P21-005</td>
<td style="text-align: left;">æ™‚å€éŒ¯èª¤æ””æˆª</td>
<td style="text-align: left;">è¼¸å‡ºå¼·åˆ¶æª¢æŸ¥æ””æˆªé UTC</td>
<td style="text-align: left;">æ‹‹å‡º <code>E102_TIMEZONE_VIOLATION</code></td>
<td style="text-align: center;">3.5</td>
</tr>
<tr>
<td style="text-align: left;">P21-006</td>
<td style="text-align: left;">é«’è³‡æ–™æ¸…æ´—</td>
<td style="text-align: left;"><code>"25.3 C"</code>, <code>"---"</code>, <code>"Error"</code></td>
<td style="text-align: left;"><code>25.3</code>, <code>null</code>, <code>null</code></td>
<td style="text-align: center;">3.1</td>
</tr>
<tr>
<td style="text-align: left;">P21-007</td>
<td style="text-align: left;">æ¨™é ­åˆ†éš”ç¬¦ä¸€è‡´æ€§</td>
<td style="text-align: left;">ä¸­ç¹¼è³‡æ–™è¡Œå« "Date" ä½†åˆ†éš”ç¬¦ä¸åŒ</td>
<td style="text-align: left;">æ­£ç¢ºè·³éï¼Œæ‰¾åˆ°çœŸå¯¦æ¨™é ­</td>
<td style="text-align: center;">2.2</td>
</tr>
<tr>
<td style="text-align: left;">P21-008</td>
<td style="text-align: left;">è¼¸å‡ºå¥‘ç´„é©—è­‰</td>
<td style="text-align: left;">ç¼ºå°‘ timestamp æ¬„ä½</td>
<td style="text-align: left;">æ‹‹å‡º <code>E103_CONTRACT_VIOLATION</code></td>
<td style="text-align: center;">3.5</td>
</tr>
</tbody>
</table>
<h3 id="62-integration-tests">6.2 æ•´åˆæ¸¬è©¦ (Integration Tests)</h3>
<p><strong>æª”æ¡ˆ</strong>: <code>tests/test_parser_cleaner_integration.py</code></p>
<table>
<thead>
<tr>
<th style="text-align: left;">æ¸¬è©¦æ¡ˆä¾‹ ID</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">é©—è­‰ç›®æ¨™</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">INT-001</td>
<td style="text-align: left;">Parser v2.1 â†’ Cleaner v2.2</td>
<td style="text-align: left;">Cleaner ç„¡éœ€æ™‚å€è½‰æ›å³å¯è™•ç†</td>
</tr>
<tr>
<td style="text-align: left;">INT-002</td>
<td style="text-align: left;">Parser v2.1 â†’ BatchProcessor v1.3</td>
<td style="text-align: left;">Parquet å¯«å…¥é©—è­‰é€šé (INT64/UTC)</td>
</tr>
<tr>
<td style="text-align: left;">INT-003</td>
<td style="text-align: left;">SSOT Flags ä¸€è‡´æ€§</td>
<td style="text-align: left;">Parser ä¸ç”¢ç”Ÿéæ³• flags</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-risk-assessment">7. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£ (Risk Assessment)</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢¨éšª</th>
<th style="text-align: center;">åš´é‡åº¦</th>
<th style="text-align: center;">å¯èƒ½æ€§</th>
<th style="text-align: left;">ç·©è§£æªæ–½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>æ™‚å€è½‰æ›æ•ˆèƒ½</strong> (å¤§æª”æ¡ˆæ™‚å€è½‰æ›è€—æ™‚)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">High</td>
<td style="text-align: left;">ä½¿ç”¨ Polars åŸç”Ÿ <code>convert_time_zone</code> (Rust å¾Œç«¯ï¼Œå·²å„ªåŒ–)ï¼›è‹¥ä»éæ…¢ï¼Œå¯è€ƒæ…®åœ¨ Cleaner å±¤åšæ‰¹æ¬¡è½‰æ›</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Naive æ™‚å€å‡è¨­éŒ¯èª¤</strong> (éå°ç£æ¡ˆå ´ä½¿ç”¨)</td>
<td style="text-align: center;">ğŸ”´ High</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">åœ¨ <code>site_templates.yaml</code> æ˜ç¢ºå®šç¾© <code>assumed_timezone</code>ï¼Œé è¨­ç‚º <code>Asia/Taipei</code> ä½†å¯é…ç½®ï¼›éå°ç£æ¡ˆå ´å¿…é ˆæ˜ç¢ºè¨­å®š</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ç·¨ç¢¼åµæ¸¬èª¤åˆ¤</strong> (UTF-8 ç›¸å®¹çš„ Big5 å­—å…ƒ)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Low</td>
<td style="text-align: left;">å„ªå…ˆåµæ¸¬ BOMï¼›æä¾› <code>encoding=auto</code> è¦†è“‹é¸é …ï¼›è¨˜éŒ„åµæ¸¬çµæœä¾›é™¤éŒ¯</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è¨˜æ†¶é«”å ç”¨</strong> (å¤§æª”æ¡ˆä¸€æ¬¡æ€§è®€å–)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">High</td>
<td style="text-align: left;">ç›®å‰è¨­è¨ˆç‚º In-Memoryï¼›è‹¥æª”æ¡ˆ &gt; 1GBï¼Œå»ºè­°åœ¨ CLI å±¤å…ˆåˆ‡å‰²æª”æ¡ˆ (æœªä¾† v2.2 å¯è€ƒæ…® Streaming)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>å‘ä¸‹ç›¸å®¹æ€§</strong> (èˆŠç‰ˆ Cleaner ç„¡æ³•è™•ç† UTC)</td>
<td style="text-align: center;">ğŸŸ¡ Medium</td>
<td style="text-align: center;">Medium</td>
<td style="text-align: left;">ç‰ˆæœ¬æª¢æŸ¥ï¼šParser v2.1 å¿…é ˆæ­é… Cleaner v2.2+ï¼›è‹¥åµæ¸¬åˆ°èˆŠç‰ˆ Cleanerï¼Œæ‹‹å‡ºç›¸å®¹æ€§è­¦å‘Š</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-version-compatibility">8. ç‰ˆæœ¬ç›¸å®¹æ€§çŸ©é™£ (Version Compatibility)</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">Parser</th>
<th style="text-align: center;">Cleaner</th>
<th style="text-align: center;">BatchProcessor</th>
<th style="text-align: center;">ç›¸å®¹æ€§</th>
<th style="text-align: left;">èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.2+</td>
<td style="text-align: center;">v1.3+</td>
<td style="text-align: center;">âœ… å®Œå…¨ç›¸å®¹</td>
<td style="text-align: left;">æ¨è–¦é…ç½®ï¼Œé›¶é–“éš™å°æ¥</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">âš ï¸ éƒ¨åˆ†ç›¸å®¹</td>
<td style="text-align: left;">Cleaner éœ€å•Ÿå‹•æ™‚å€å®¹éŒ¯ (è‡ªå‹•è½‰æ› UTC)ï¼Œæ•ˆèƒ½ç•¥é™</td>
</tr>
<tr>
<td style="text-align: center;">v2.1</td>
<td style="text-align: center;">v2.0</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">âŒ ä¸ç›¸å®¹</td>
<td style="text-align: left;">Cleaner v2.0 æœŸæœ› Asia/Taipeiï¼Œæœƒç™¼ç”Ÿæ™‚å€éŒ¯èª¤</td>
</tr>
<tr>
<td style="text-align: center;">v2.0</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">ä»»æ„</td>
<td style="text-align: center;">âš ï¸ å·²æ£„ç”¨</td>
<td style="text-align: left;">v2.0 è¼¸å‡º Asia/Taipeiï¼Œä¸å»ºè­°ç¹¼çºŒä½¿ç”¨</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9-deliverables">9. äº¤ä»˜ç‰©æ¸…å–® (Deliverables)</h2>
<h3 id="91">9.1 ç¨‹å¼ç¢¼æª”æ¡ˆ</h3>
<ol>
<li><code>src/etl/parser.py</code> - ä¸»è¦å¯¦ä½œ (å« v2.1 æ‰€æœ‰ä¿®æ­£)</li>
<li><code>src/etl/exceptions.py</code> - ä¾‹å¤–é¡åˆ¥å®šç¾© (è‹¥å°šæœªå­˜åœ¨)</li>
<li><code>config/site_templates.yaml</code> - æ¡ˆå ´é…ç½®ç¯„æœ¬ (å« v2.1 æ™‚å€è¨­å®š)</li>
</ol>
<h3 id="92">9.2 æ¸¬è©¦æª”æ¡ˆ</h3>
<ol start="4">
<li><code>tests/test_parser_v21.py</code> - v2.1 å°ˆå±¬å–®å…ƒæ¸¬è©¦</li>
<li><code>tests/test_parser_cleaner_integration.py</code> - æ•´åˆæ¸¬è©¦</li>
</ol>
<h3 id="93">9.3 æ–‡ä»¶æª”æ¡ˆ</h3>
<ol start="6">
<li><code>docs/parser/PRD_PARSER_v2.1.md</code> - æœ¬æ–‡ä»¶</li>
<li><code>docs/parser/CHANGELOG_v2.0_to_v2.1.md</code> - å‡ç´šæŒ‡å¼• (ä¾›ç¶­é‹åœ˜éšŠ)</li>
</ol>
<hr />
<h2 id="10-interface-contract-v10">10. é™„éŒ„ï¼šèˆ‡ Interface Contract v1.0 å°ç…§</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Interface Contract #1 æª¢æŸ¥é …</th>
<th style="text-align: left;">Parser v2.1 å¯¦ç¾ä½ç½®</th>
<th style="text-align: left;">é©—è­‰æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">timestamp æ™‚å€å¿…é ˆç‚º UTC</td>
<td style="text-align: left;">Step 3.4 (<code>_standardize_timezone</code>)</td>
<td style="text-align: left;">Step 3.5 (<code>_validate_output_contract</code>)</td>
</tr>
<tr>
<td style="text-align: left;">ç·¨ç¢¼å¿…é ˆç‚º UTF-8</td>
<td style="text-align: left;">Step 2.1 (ç·¨ç¢¼åµæ¸¬èˆ‡è½‰æ›)</td>
<td style="text-align: left;">Step 3.5 (BOM æ®˜ç•™æª¢æŸ¥)</td>
</tr>
<tr>
<td style="text-align: left;">å¿…è¦æ¬„ä½å¿…é ˆåŒ…å« timestamp</td>
<td style="text-align: left;">Step 3.4 (å­˜åœ¨æ€§æª¢æŸ¥)</td>
<td style="text-align: left;">Step 3.5 (æ¬„ä½æª¢æŸ¥)</td>
</tr>
<tr>
<td style="text-align: left;">ç„¡æœªä¾†è³‡æ–™ (é¸é…)</td>
<td style="text-align: left;">Step 3.4 (å¯é¸æª¢æŸ¥)</td>
<td style="text-align: left;">-</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="11-sign-off-checklist">11. é©—æ”¶ç°½æ ¸ (Sign-off Checklist)</h2>
<ul>
<li>[ ] <strong>ç·¨ç¢¼è™•ç†</strong>: Big5/UTF-8/UTF-16 è‡ªå‹•åµæ¸¬ï¼Œç„¡ BOM æ®˜ç•™</li>
<li>[ ] <strong>æ™‚å€å¼·åˆ¶</strong>: è¼¸å‡ºçµ•å°ç‚º UTC (ns ç²¾åº¦)ï¼Œé€šé <code>E002</code> é©—è­‰</li>
<li>[ ] <strong>å¥‘ç´„é©—è­‰</strong>: <code>_validate_output_contract</code> å®Œæ•´å¯¦ä½œï¼ŒéŒ¯èª¤ä»£ç¢¼æ­£ç¢º</li>
<li>[ ] <strong>æ¨™é ­æœå°‹</strong>: ä¸­æ–‡æ¨™é ­æ”¯æ´ï¼Œç„¡ç¡¬ç·¨ç¢¼ fallback</li>
<li>[ ] <strong>é«’è³‡æ–™</strong>: <code>---</code>, <code>25.3 C</code> ç­‰ BAS å¸¸è¦‹é«’è³‡æ–™æ­£ç¢ºè™•ç†</li>
<li>[ ] <strong>æ•´åˆæ¸¬è©¦</strong>: èˆ‡ Cleaner v2.2 ç„¡ç¸«éŠœæ¥ (ç„¡éœ€æ™‚å€è½‰æ›)</li>
<li>[ ] <strong>SSOT å¼•ç”¨</strong>: ç„¡ç¡¬ç·¨ç¢¼ flagsï¼Œå¼•ç”¨ <code>config_models.VALID_QUALITY_FLAGS</code></li>
<li>[ ] <strong>å‘ä¸‹ç›¸å®¹</strong>: æ˜ç¢ºæ¨™è¨˜èˆ‡èˆŠç‰ˆ Cleaner ä¸ç›¸å®¹ï¼Œé¿å…èª¤ç”¨</li>
</ul>
<hr />
</body>
</html>