
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PRD_Model_Training_v1.2</title>
    
<style>
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
        line-height: 1.6; 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        color: #24292e; 
        background-color: #ffffff;
    }
    h1, h2, h3, h4, h5, h6 { 
        margin-top: 24px; 
        margin-bottom: 16px; 
        font-weight: 600; 
        color: #24292e;
    }
    h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    h3 { font-size: 1.25em; }
    p { margin-top: 0; margin-bottom: 16px; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { 
        display: block; 
        width: 100%; 
        overflow: auto; 
        border-spacing: 0; 
        border-collapse: collapse; 
        margin-bottom: 16px; 
    }
    table th, table td { 
        padding: 6px 13px; 
        border: 1px solid #dfe2e5; 
    }
    table th { 
        font-weight: 600; 
        background-color: #f6f8fa; 
    }
    table tr:nth-child(2n) { 
        background-color: #f6f8fa; 
    }
    code { 
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace; 
        background-color: #f6f8fa; 
        padding: 0.2em 0.4em; 
        border-radius: 3px; 
        font-size: 85%; 
    }
    pre { 
        background-color: #f6f8fa; 
        padding: 16px; 
        overflow: auto; 
        border-radius: 3px; 
        line-height: 1.45; 
    }
    pre code { 
        background-color: transparent; 
        padding: 0; 
        border-radius: 0; 
    }
    blockquote { 
        border-left: 0.25em solid #dfe2e5; 
        color: #6a737d; 
        padding: 0 1em; 
        margin: 0 0 16px 0; 
    }
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
    }
    .mermaid {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
</style>

</head>
<body>
    <h1 id="prd-v12-model-training-pipeline-implementation-guide">PRD v1.2: 模型訓練管線實作指南 (Model Training Pipeline Implementation Guide)</h1>
<p><strong>文件版本:</strong> v1.2 (Multi-Target Training &amp; Optimization-Ready Architecture)<br />
<strong>日期:</strong> 2026-02-13<br />
<strong>負責人:</strong> Oscar Chang<br />
<strong>目標模組:</strong> <code>src/modeling/training_pipeline.py</code>, <code>src/modeling/trainers/</code>, <code>src/modeling/coordinators/</code>, <code>src/modeling/registry/</code><br />
<strong>上游契約:</strong> <code>src/etl/feature_engineer.py</code> (v1.3-FA+, 檢查點 #4)<br />
<strong>下游契約:</strong> <code>src/optimization/engine.py</code> (v1.0+, 模型註冊表介面)<br />
<strong>關鍵更新:</strong> 
- 支援 System-Level 與 Component-Level 雙模式訓練
- 新增 BatchTrainingCoordinator 處理多目標批次訓練
- 標準化 Model Registry Index 格式供 Optimization Engine 載入
- 明確定義與 Optimization v1.0+ 的介面契約</p>
<p><strong>支援模型:</strong> 
- <strong>XGBoost</strong> (Extreme Gradient Boosting) - 高精度、正則化強
- <strong>LightGBM</strong> (Light Gradient Boosting Machine) - 大規模資料、訓練極速<br />
- <strong>Random Forest</strong> (Bagging Ensemble) - 高鲁棒性、抗過擬合、基準模型<br />
<strong>預估工時:</strong> 10 ~ 12 個工程天（含 v1.1 基礎 + v1.2 多目標協調與註冊表實作）</p>
<hr />
<h2 id="1">1. 執行總綱與設計哲學</h2>
<h3 id="11">1.1 核心目標</h3>
<p>建立<strong>生產就緒 (Production-Ready)</strong>、<strong>資源感知 (Resource-Aware)</strong>、<strong>多模型平行訓練 (Multi-Model Training)</strong> 且<strong>優化引擎就緒 (Optimization-Ready)</strong> 的訓練管線：</p>
<ol>
<li><strong>雙模式訓練架構</strong>: 支援 System-Level（系統總耗電預測）與 Component-Level（設備級耗電預測）兩種模式，明確定義與 Optimization Engine 的銜接介面</li>
<li><strong>動態資源管理</strong>: 自動檢測記憶體容量，防止平行訓練導致 OOM，不穩定環境自動降級為序列訓練</li>
<li><strong>多目標批次協調</strong>: 當 Optimization Engine 需要多設備模型時，透過 BatchTrainingCoordinator 統一管理訓練流程，確保版本一致性</li>
<li><strong>零資料洩漏 (Zero Data Leakage)</strong>: 嚴格遵守 <code>temporal_cutoff</code>，訓練資料絕不包含驗證/測試期的未來資訊</li>
<li><strong>模型註冊表標準化</strong>: 產出統一的 <code>model_registry_index.json</code>，供 Optimization Engine 自動發現與載入模型</li>
<li><strong>分層超參數優化</strong>: 區分「日間快速訓練」與「夜間深度優化」模式，支援斷點續傳與 Trial Pruning</li>
<li><strong>可解釋性預留 (Explainability Ready)</strong>: v1.2 預留 SHAP 整合介面，支援單筆預測歸因與時間序列特徵貢獻追蹤</li>
<li><strong>版本可追溯 (Version Traceability)</strong>: 每個訓練產出的模型必須綁定當時的 <code>schema_version</code>、<code>inheritance_chain</code> 與 <code>yaml_checksum</code></li>
</ol>
<h3 id="12-v12">1.2 訓練模式定義（v1.2 新增）</h3>
<p>為了與 Optimization Engine v1.0+ 無縫銜接，本管線支援兩種訓練模式：</p>
<h4 id="a-system-level-modeling-">模式 A：系統級建模 (System-Level Modeling) - 預設推薦</h4>
<ul>
<li><strong>目標變數</strong>: <code>system_total_kw</code>（冰水主機房總耗電）</li>
<li><strong>特徵包含</strong>: 所有設備狀態（啟停、頻率、轉速）、環境條件、系統級特徵（總流量、溫差）</li>
<li><strong>Optimization 用途</strong>: 作為黑盒預測器，輸入設備組合與參數，輸出總耗電</li>
<li><strong>優勢</strong>: 考慮設備間耦合效應（Copula effect），精度最高，維護簡單（單一模型）</li>
<li><strong>模型檔案</strong>: <code>system_total_kw/{timestamp}_xgboost_model.joblib</code></li>
</ul>
<h4 id="b-component-level-modeling-">模式 B：組件級建模 (Component-Level Modeling) - 可選擴充</h4>
<ul>
<li><strong>目標變數</strong>: 各設備耗電（<code>chiller_1_kw</code>, <code>chiller_2_kw</code>, <code>chw_pump_1_kw</code>, <code>ct_1_kw</code>...）</li>
<li><strong>特徵包含</strong>: 設備自身狀態 + 局部環境特徵（避免特徵洩漏）</li>
<li><strong>Optimization 用途</strong>: 設備級故障診斷、耗電佔比分析、與系統級模型交叉驗證</li>
<li><strong>限制</strong>: 無法捕捉設備間交互作用（如兩台主機同時運轉的系統效率損失）</li>
<li><strong>模型檔案</strong>: <code>{component_id}/{timestamp}_xgboost_model.joblib</code></li>
</ul>
<h4 id="c-hybrid-mode-v12">模式 C：混合模式 (Hybrid Mode) - v1.2 推薦架構</h4>
<ul>
<li><strong>System Model</strong>: 主要用於 Optimization Engine 的預測（精度優先）</li>
<li><strong>Component Models</strong>: 輔助用於解釋性報告（透明度優先），不直接參與優化決策</li>
<li><strong>一致性約束</strong>: Component Models 的加總應與 System Model 預測差距 &lt; 5%，否則觸發警告</li>
</ul>
<h3 id="13">1.3 三模型特性比較與適用場景</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">模型</th>
<th style="text-align: center;">演算法類型</th>
<th style="text-align: left;">優勢</th>
<th style="text-align: left;">最佳適用場景</th>
<th style="text-align: center;">最小樣本數</th>
<th style="text-align: left;">特徵重要性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>XGBoost</strong></td>
<td style="text-align: center;">Gradient Boosting (Level-wise)</td>
<td style="text-align: left;">精度極高、正則化強、不易過擬合</td>
<td style="text-align: left;">中等資料量 (500~100萬筆)、高維度特徵</td>
<td style="text-align: center;">500</td>
<td style="text-align: left;">Gain-based</td>
</tr>
<tr>
<td style="text-align: left;"><strong>LightGBM</strong></td>
<td style="text-align: center;">Gradient Boosting (Leaf-wise)</td>
<td style="text-align: left;">訓練速度極快、記憶體效率高</td>
<td style="text-align: left;">大規模資料 (&gt;10,000筆)、即時訓練需求</td>
<td style="text-align: center;">1,000</td>
<td style="text-align: left;">Split-based</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Random Forest</strong></td>
<td style="text-align: center;">Bagging (Parallel Trees)</td>
<td style="text-align: left;">極高鲁棒性、天然支援平行運算、對異常值不敏感</td>
<td style="text-align: left;">快速基准測試、小樣本 (&lt;500)、含噪音資料</td>
<td style="text-align: center;">100</td>
<td style="text-align: left;">Mean Decrease Impurity</td>
</tr>
</tbody>
</table>
<p><strong>動態選擇策略</strong>: 
- 樣本數 &lt; 500：僅啟用 Random Forest 與 XGBoost（限制深度）
- 樣本數 500~1,000：啟用 XGBoost 與 Random Forest，禁用 LightGBM
- 樣本數 &gt; 1,000：三模型全啟用，依 Val R² 自動選擇最佳模型或保留 Ensemble</p>
<hr />
<h2 id="2-interface-contracts">2. 介面契約規範 (Interface Contracts)</h2>
<h3 id="21-input-contract-from-feature-engineer-v13">2.1 輸入契約 (Input Contract from Feature Engineer v1.3)</h3>
<p><strong>檢查點 #7: Feature Engineer → Model Training</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TrainingInputContract</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;模型訓練輸入資料規範&quot;&quot;&quot;</span>

    <span class="c1"># 1. 特徵矩陣 (來自 Feature Engineer)</span>
    <span class="n">feature_matrix</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span>

    <span class="c1"># 2. 目標變數資訊（v1.2 擴充為多目標支援）</span>
    <span class="n">target_variable</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># 向後相容：單目標時使用</span>
    <span class="n">target_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># v1.2 新增：多目標批次訓練</span>
    <span class="n">target_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureMetadata</span><span class="p">]</span>  <span class="c1"># v1.2 修改：改為 Dict 支援多目標</span>

    <span class="c1"># 3. 時間戳記</span>
    <span class="n">timestamp_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;timestamp&quot;</span>
    <span class="n">time_range</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>

    <span class="c1"># 4. Annotation 上下文（版本綁定）</span>
    <span class="n">annotation_context</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inheritance_chain&quot;</span><span class="p">:</span> <span class="s2">&quot;base -&gt; cgmh_ty&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yaml_checksum&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:abc123...&quot;</span><span class="p">,</span>
        <span class="s2">&quot;group_policies_applied&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;chillers&quot;</span><span class="p">,</span> <span class="s2">&quot;towers&quot;</span><span class="p">],</span>
        <span class="s2">&quot;feature_engineer_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.3-FA&quot;</span>
    <span class="p">}</span>

    <span class="c1"># 5. 特徵元資料（不含 device_role）</span>
    <span class="n">feature_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureMetadata</span><span class="p">]</span>

    <span class="c1"># 6. Quality Flag 特徵列表</span>
    <span class="n">quality_flag_features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="c1"># 7. 防 Data Leakage 資訊</span>
    <span class="n">train_test_split_info</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;temporal_cutoff&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-10-01T00:00:00Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;strict_past_only&quot;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>

    <span class="c1"># 8. 樣本權重建議（可選）</span>
    <span class="n">suggested_sample_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 9. 資料規模標記（用於模型選擇建議）</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1"># 10. 訓練模式控制（v1.2 新增）</span>
    <span class="n">training_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;single_target&quot;</span><span class="p">,</span> <span class="s2">&quot;multi_target&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;single_target&quot;</span>
    <span class="n">model_naming_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># {&quot;chiller_1_kw&quot;: &quot;chiller_1_model&quot;}</span>
    <span class="n">output_structure</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span> <span class="s2">&quot;hierarchical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;hierarchical&quot;</span>  <span class="c1"># v1.2 預設改為 hierarchical</span>
</code></pre></div>

<table>
<thead>
<tr>
<th style="text-align: left;">檢查項</th>
<th style="text-align: left;">規格</th>
<th style="text-align: center;">錯誤代碼</th>
<th style="text-align: left;">處理</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Annotation Context 存在性</strong></td>
<td style="text-align: left;">必須非空且包含 <code>schema_version</code>, <code>inheritance_chain</code>, <code>yaml_checksum</code></td>
<td style="text-align: center;">E601</td>
<td style="text-align: left;">拒絕訓練</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Schema 版本相容</strong></td>
<td style="text-align: left;"><code>schema_version</code> 必須等於當前 <code>FEATURE_ANNOTATION_CONSTANTS['expected_schema_version']</code></td>
<td style="text-align: center;">E602</td>
<td style="text-align: left;">拒絕訓練</td>
</tr>
<tr>
<td style="text-align: left;"><strong>目標變數存在</strong></td>
<td style="text-align: left;"><code>target_variable</code> 必須存在於 <code>feature_matrix</code> 欄位中</td>
<td style="text-align: center;">E603</td>
<td style="text-align: left;">拒絕訓練</td>
</tr>
<tr>
<td style="text-align: left;"><strong>時間戳型別</strong></td>
<td style="text-align: left;"><code>timestamp</code> 必須為 <code>Datetime(ns, UTC)</code></td>
<td style="text-align: center;">E604</td>
<td style="text-align: left;">拒絕訓練</td>
</tr>
<tr>
<td style="text-align: left;"><strong>資料規模檢查</strong></td>
<td style="text-align: left;"><code>n_samples</code> 必須 &gt;= 100（Random Forest 最低需求）</td>
<td style="text-align: center;">E607</td>
<td style="text-align: left;">拒絕訓練</td>
</tr>
<tr>
<td style="text-align: left;"><strong>多目標一致性</strong> (v1.2 新增)</td>
<td style="text-align: left;"><code>multi_target</code> 模式下所有 targets 必須使用相同的 <code>annotation_context</code></td>
<td style="text-align: center;">E901</td>
<td style="text-align: left;">拒絕訓練</td>
</tr>
</tbody>
</table>
<h3 id="22-output-contract-to-optimization-engine-v10">2.2 輸出契約 (Output Contract to Optimization Engine v1.0+)</h3>
<p><strong>檢查點 #9: Model Training → Optimization Engine</strong></p>
<p>為確保 Optimization Engine 能正確載入與使用模型，v1.2 標準化以下輸出結構：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ModelRegistryIndex</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    模型註冊表索引（v1.2 新增）</span>
<span class="sd">    儲存於 models/{site_id}/model_registry_index.json</span>
<span class="sd">    供 Optimization Engine 自動發現模型</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">schema_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.2&quot;</span>
    <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">training_timestamp</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># ISO 8601</span>
    <span class="n">annotation_checksum</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># 與 Feature Annotation 綁定</span>

    <span class="c1"># 訓練模式標記</span>
    <span class="n">training_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system_level&quot;</span><span class="p">,</span> <span class="s2">&quot;component_level&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">]</span>

    <span class="c1"># 可用模型列表</span>
    <span class="n">available_models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;system_total_kw&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;system_level&quot;</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;system_total_kw/20260213_120000_xgboost_model.joblib&quot;</span><span class="p">,</span>
            <span class="s2">&quot;manifest_path&quot;</span><span class="p">:</span> <span class="s2">&quot;system_total_kw/20260213_120000_ensemble_manifest.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;target_variable&quot;</span><span class="p">:</span> <span class="s2">&quot;total_kw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;feature_count&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
            <span class="s2">&quot;best_algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;xgboost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;val_r2&quot;</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span> <span class="s2">&quot;test_r2&quot;</span><span class="p">:</span> <span class="mf">0.89</span><span class="p">},</span>
            <span class="s2">&quot;checksum&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:def456...&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;chiller_1_kw&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;component_level&quot;</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;chiller_1_kw/20260213_120000_xgboost_model.joblib&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># 若為 hybrid 模式，component models 標記為 optional</span>
            <span class="s2">&quot;parent_system_model&quot;</span><span class="p">:</span> <span class="s2">&quot;system_total_kw&quot;</span>  <span class="c1"># 關聯的系統級模型</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># 相容性資訊</span>
    <span class="n">compatibility</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;optimization_engine_min_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;feature_annotation_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="s2">&quot;3.10+&quot;</span><span class="p">,</span>
        <span class="s2">&quot;required_packages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;xgboost&gt;=1.7&quot;</span><span class="p">,</span> <span class="s2">&quot;lightgbm&gt;=4.0&quot;</span><span class="p">,</span> <span class="s2">&quot;scikit-learn&gt;=1.3&quot;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ModelEntry</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;單一模型條目&quot;&quot;&quot;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system_level&quot;</span><span class="p">,</span> <span class="s2">&quot;component_level&quot;</span><span class="p">]</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># 相對於 site_id 根目錄的路徑</span>
    <span class="n">manifest_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Ensemble manifest 路徑（若為 ensemble）</span>
    <span class="n">target_variable</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">feature_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">best_algorithm</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>  <span class="c1"># val_r2, test_r2, rmse, mape</span>
    <span class="n">checksum</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># 模型檔案 SHA256</span>
    <span class="n">optional</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 若為 True，Optimization Engine 可選擇性載入</span>
    <span class="n">parent_system_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 用於 hybrid 模式的關聯</span>
</code></pre></div>

<p><strong>模型儲存結構（v1.2 標準化）</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="n">models</span><span class="o">/</span>
<span class="err">└──</span><span class="w"> </span><span class="p">{</span><span class="n">site_id</span><span class="p">}</span><span class="o">/</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">model_registry_index</span><span class="p">.</span><span class="n">json</span><span class="w">          </span><span class="p">#</span><span class="w"> </span><span class="err">總索引（</span><span class="n">Optimization</span><span class="w"> </span><span class="n">Engine</span><span class="w"> </span><span class="err">入口）</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">system_total_kw</span><span class="o">/</span><span class="w">                   </span><span class="p">#</span><span class="w"> </span><span class="n">System</span><span class="o">-</span><span class="n">Level</span><span class="w"> </span><span class="err">模型目錄</span>
<span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="mh">20260213</span><span class="n">_120000_xgboost_model</span><span class="p">.</span><span class="n">joblib</span>
<span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="mh">20260213</span><span class="n">_120000_lightgbm_model</span><span class="p">.</span><span class="n">joblib</span>
<span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="mh">20260213</span><span class="n">_120000_random_forest_model</span><span class="p">.</span><span class="n">joblib</span>
<span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="mh">20260213</span><span class="n">_120000_ensemble_manifest</span><span class="p">.</span><span class="n">json</span>
<span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="mh">20260213</span><span class="n">_120000_shap_summary</span><span class="p">.</span><span class="n">png</span>
<span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="mh">20260213</span><span class="n">_120000_metadata</span><span class="p">.</span><span class="n">json</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">chiller_1_kw</span><span class="o">/</span><span class="w">                      </span><span class="p">#</span><span class="w"> </span><span class="n">Component</span><span class="o">-</span><span class="n">Level</span><span class="w"> </span><span class="err">模型目錄（可選）</span>
<span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="p">...</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">chiller_2_kw</span><span class="o">/</span>
<span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="p">...</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="n">chw_pump_1_kw</span><span class="o">/</span>
<span class="w">        </span><span class="err">└──</span><span class="w"> </span><span class="p">...</span>
</code></pre></div>

<hr />
<h2 id="3-phase-based-implementation">3. 分階段實作計畫 (Phase-Based Implementation)</h2>
<h3 id="phase-0-day-1-2">Phase 0: 基礎建設與多模型架構 (Day 1-2)</h3>
<h4 id="step-01-v12">Step 0.1: 統一訓練配置模型（v1.2 擴充版）</h4>
<p><strong>檔案</strong>: <code>src/modeling/config_models.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Final</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">root_validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.etl.config_models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">VALID_QUALITY_FLAGS</span><span class="p">,</span>
    <span class="n">TIMESTAMP_CONFIG</span><span class="p">,</span>
    <span class="n">FEATURE_ANNOTATION_CONSTANTS</span>
<span class="p">)</span>

<span class="n">EXPECTED_SCHEMA_VERSION</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">FEATURE_ANNOTATION_CONSTANTS</span><span class="p">[</span><span class="s1">&#39;expected_schema_version&#39;</span><span class="p">]</span>

<span class="c1"># ==========================================</span>
<span class="c1"># 模型特定超參數配置（v1.1 內容保留）</span>
<span class="c1"># ==========================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">XGBoostConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;XGBoost 專屬配置 - Level-wise 生長策略，精度導向&quot;&quot;&quot;</span>
    <span class="n">n_estimators</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">min_child_weight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">subsample</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">colsample_bytree</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">reg_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># L1 正則</span>
    <span class="n">reg_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># L2 正則</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 節點分裂最小損失減少</span>
    <span class="n">early_stopping_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">eval_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rmse&quot;</span>
    <span class="n">tree_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hist&quot;</span>  <span class="c1"># &#39;exact&#39;, &#39;approx&#39;, &#39;hist&#39;</span>

    <span class="c1"># 小樣本適應（當 n_samples &lt; 500 時自動調整）</span>
    <span class="n">small_sample_adjustments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;min_child_weight&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;subsample&quot;</span><span class="p">:</span> <span class="mf">0.9</span>
    <span class="p">}</span>

    <span class="c1"># 進階功能</span>
    <span class="n">enable_monotonic_constraints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">monotone_constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LightGBMConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LightGBM 專屬配置 - Leaf-wise 生長策略，速度導向&quot;&quot;&quot;</span>
    <span class="n">n_estimators</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">num_leaves</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">31</span>  <span class="c1"># 控制模型複雜度，相當於 2^max_depth</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># -1 表示無限制，由 num_leaves 控制</span>
    <span class="n">min_child_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">subsample</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">colsample_bytree</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">reg_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">reg_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">early_stopping_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">eval_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rmse&quot;</span>
    <span class="n">boosting_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gbdt&quot;</span>  <span class="c1"># &#39;gbdt&#39;, &#39;dart&#39;, &#39;goss&#39;</span>

    <span class="c1"># 大規模資料優化</span>
    <span class="n">feature_pre_filter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">histogram_pool_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 記憶體限制時設定</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RandomForestConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Random Forest 專屬配置 - Bagging 策略，鲁棒性導向&quot;&quot;&quot;</span>
    <span class="n">n_estimators</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># None 表示完全生長</span>
    <span class="n">min_samples_split</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">min_samples_leaf</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">max_features</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sqrt&quot;</span>  <span class="c1"># &#39;sqrt&#39;, &#39;log2&#39;, None</span>
    <span class="n">bootstrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">oob_score</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Out-of-Bag 驗證</span>
    <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 使用所有 CPU</span>
    <span class="n">warm_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 可增量訓練（v1.2 使用）</span>

    <span class="c1"># 區間預測（使用樹的葉節點統計）</span>
    <span class="n">quantile_regression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 若啟用，訓練三個模型 (Q10, Q50, Q90)</span>

<span class="c1"># ==========================================</span>
<span class="c1"># 資源管理配置（v1.1 內容保留）</span>
<span class="c1"># ==========================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ResourceConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;硬體資源與記憶體管理配置&quot;&quot;&quot;</span>

    <span class="c1"># 記憶體安全閾值</span>
    <span class="n">memory_safety_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>  <span class="c1"># 保留 30% 系統記憶體作為緩衝</span>
    <span class="n">parallel_training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 是否嘗試並行訓練</span>
    <span class="n">max_parallel_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 最大平行工作進程</span>

    <span class="c1"># 動態降級策略</span>
    <span class="n">auto_fallback_to_sequential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 記憶體不足時自動降級為序列訓練</span>
    <span class="n">memory_check_before_training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 訓練前強制檢查記憶體</span>

    <span class="c1"># 小樣本處理</span>
    <span class="n">small_sample_fallback</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;disable_lightgbm&#39;</span><span class="p">,</span> <span class="s1">&#39;use_rf_only&#39;</span><span class="p">,</span> <span class="s1">&#39;abort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;disable_lightgbm&#39;</span>

    <span class="c1"># v1.2 新增：批次訓練資源控制</span>
    <span class="n">batch_training_memory_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># 批次訓練時單一模型記憶體上限</span>
    <span class="n">max_concurrent_targets</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 同時訓練的最大目標數（防止 OOM）</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;memory_safety_threshold&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_threshold</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;記憶體安全閾值必須在 0.1~0.8 之間&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="c1"># ==========================================</span>
<span class="c1"># 訓練管線主配置（v1.2 擴充）</span>
<span class="c1"># ==========================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ModelTrainingConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;模型訓練統一配置（v1.2 多目標版）&quot;&quot;&quot;</span>

    <span class="c1"># 基本配置</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>  <span class="c1"># v1.2 新增：明確綁定案場</span>

    <span class="c1"># 時序配置</span>
    <span class="n">temporal_split</span><span class="p">:</span> <span class="n">TemporalSplitConfig</span> <span class="o">=</span> <span class="n">TemporalSplitConfig</span><span class="p">()</span>

    <span class="c1"># Device Role 處理</span>
    <span class="n">device_role_handling</span><span class="p">:</span> <span class="n">DeviceRoleHandlingConfig</span> <span class="o">=</span> <span class="n">DeviceRoleHandlingConfig</span><span class="p">()</span>

    <span class="c1"># 特徵工程（訓練期）</span>
    <span class="n">handle_missing_values</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="s2">&quot;impute_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;impute_median&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;impute_median&quot;</span>
    <span class="n">scale_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Quality Flags 處理</span>
    <span class="n">use_quality_flags_as_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">exclude_bad_quality_samples</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># 三模型配置</span>
    <span class="n">xgboost</span><span class="p">:</span> <span class="n">XGBoostConfig</span> <span class="o">=</span> <span class="n">XGBoostConfig</span><span class="p">()</span>
    <span class="n">lightgbm</span><span class="p">:</span> <span class="n">LightGBMConfig</span> <span class="o">=</span> <span class="n">LightGBMConfig</span><span class="p">()</span>
    <span class="n">random_forest</span><span class="p">:</span> <span class="n">RandomForestConfig</span> <span class="o">=</span> <span class="n">RandomForestConfig</span><span class="p">()</span>

    <span class="c1"># 資源管理（v1.1 + v1.2）</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">ResourceConfig</span> <span class="o">=</span> <span class="n">ResourceConfig</span><span class="p">()</span>

    <span class="c1"># 模型特定最小樣本數閾值（依演算法特性區分）</span>
    <span class="n">min_samples_threshold</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;random_forest&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s1">&#39;lightgbm&#39;</span><span class="p">:</span> <span class="mi">1000</span>
    <span class="p">}</span>

    <span class="c1"># 超參數搜尋（夜間模式）</span>
    <span class="n">enable_hyperparameter_search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">hyperparameter_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="s1">&#39;daytime_quick&#39;</span><span class="p">,</span> <span class="s1">&#39;overnight_deep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;disabled&#39;</span>
    <span class="n">hyperparameter_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">hyperparameter_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 秒</span>
    <span class="n">hyperparameter_storage</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;optuna_studies.db&quot;</span>  <span class="c1"># SQLite 儲存路徑</span>

    <span class="c1"># 可解釋性（v1.1 預留）</span>
    <span class="n">enable_explainability</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 是否啟用 SHAP</span>
    <span class="n">shap_background_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>   <span class="c1"># SHAP 背景資料取樣數</span>

    <span class="c1"># v1.2 新增：多目標與輸出控制</span>
    <span class="n">training_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;single_target&quot;</span><span class="p">,</span> <span class="s2">&quot;multi_target&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;single_target&quot;</span>
    <span class="n">output_structure</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span> <span class="s2">&quot;hierarchical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;hierarchical&quot;</span>
    <span class="n">generate_registry_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 自動產生 model_registry_index.json</span>

    <span class="c1"># 輸出</span>
    <span class="n">model_output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;models/trained&quot;</span>
    <span class="n">metadata_output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;models/metadata&quot;</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;device_role_handling&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_no_feature_leakage</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">use_as_feature</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;E701: device_role 禁止作為直接特徵輸入&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_eligible_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        依樣本數動態決定可用模型列表</span>
<span class="sd">        回傳: [&#39;random_forest&#39;, &#39;xgboost&#39;, &#39;lightgbm&#39;] 的子集</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eligible</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples_threshold</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">eligible</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;⚠️ 樣本數 </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> 低於 </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> 門檻 (</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)，已排除&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E607: 樣本數 </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> 低於所有模型最低要求&quot;</span><span class="p">)</span>

        <span class="c1"># 應用小樣本降級策略</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples_threshold</span><span class="p">[</span><span class="s1">&#39;lightgbm&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">small_sample_fallback</span> <span class="o">==</span> <span class="s1">&#39;disable_lightgbm&#39;</span><span class="p">:</span>
                <span class="n">eligible</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">eligible</span> <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="s1">&#39;lightgbm&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">small_sample_fallback</span> <span class="o">==</span> <span class="s1">&#39;use_rf_only&#39;</span><span class="p">:</span>
                <span class="n">eligible</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;random_forest&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">eligible</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_for_small_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得針對小樣本調整後的模型配置&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span> <span class="ow">and</span> <span class="n">n_samples</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="c1"># 應用小樣本調整</span>
            <span class="n">adjusted</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">small_sample_adjustments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">adjusted</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">adjusted</span>

        <span class="k">return</span> <span class="n">config</span>
</code></pre></div>

<h4 id="step-02-v11-v12">Step 0.2: 多模型訓練器基礎類別（v1.1 內容保留，增加 v1.2 註解）</h4>
<p><strong>檔案</strong>: <code>src/modeling/trainers/base_trainer.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">mean_absolute_error</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BaseModelTrainer</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    模型訓練器抽象基礎類別 (v1.2)</span>
<span class="sd">    支援常規訓練、增量學習預留、以及可解釋性介面</span>

<span class="sd">    v1.2 更新:</span>
<span class="sd">    - 增加 target_id 標記，支援多目標追蹤</span>
<span class="sd">    - 增加 model_family 標記（system/component）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">target_id</span>  <span class="c1"># v1.2 新增：標記此 trainer 對應的目標</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_history</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># v1.2 新增：模型元資訊擴充</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;trainer_version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;supports_incremental&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;supports_explainability&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
            <span class="s1">&#39;model_family&#39;</span><span class="p">:</span> <span class="s1">&#39;unknown&#39;</span>  <span class="c1"># &#39;system&#39; 或 &#39;component&#39;，由外部設定</span>
        <span class="p">}</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">sample_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        執行模型訓練</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict 包含:</span>
<span class="sd">            - model: 訓練好的模型物件</span>
<span class="sd">            - best_iteration: 最佳迭代次數（梯度提升類）</span>
<span class="sd">            - training_history: 訓練過程指標</span>
<span class="sd">            - feature_importance: 特徵重要性字典</span>
<span class="sd">            - oob_score: Out-of-Bag 分數（若有）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">partial_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_new</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_new</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        增量學習介面（v1.2 實作，v1.1 預留）</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: 若模型不支援增量學習</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> 不支援增量學習（partial_fit）&quot;</span>
        <span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;執行預測&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得標準化特徵重要性（總和為1）&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;統一評估指標&quot;&quot;&quot;</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># 防止除以零（MAPE）</span>
        <span class="n">mape_mask</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_true</span><span class="p">[</span><span class="n">mape_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mape_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mape_mask</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mape_mask</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)),</span>
            <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;mape&#39;</span><span class="p">:</span> <span class="n">mape</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得模型元資訊（用於日誌與儲存）&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trainer_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;is_fitted&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">,</span>
            <span class="s1">&#39;supports_incremental&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;supports_incremental&#39;</span><span class="p">],</span>
            <span class="s1">&#39;supports_explainability&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;supports_explainability&#39;</span><span class="p">],</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
            <span class="s1">&#39;model_family&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;model_family&#39;</span><span class="p">],</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;dict&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<hr />
<h3 id="phase-1-day-3-4">Phase 1: 三模型具體實作 (Day 3-4)</h3>
<p><strong>（以下為 v1.1 內容，保持不變，僅更新標題與版本標記）</strong></p>
<h4 id="step-11-xgboost">Step 1.1: XGBoost 訓練器實作</h4>
<p><strong>檔案</strong>: <code>src/modeling/trainers/xgboost_trainer.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.base_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModelTrainer</span>

<span class="k">class</span><span class="w"> </span><span class="nc">XGBoostTrainer</span><span class="p">(</span><span class="n">BaseModelTrainer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    XGBoost 訓練器實作 (v1.2)</span>

<span class="sd">    特性:</span>
<span class="sd">    - Level-wise 樹生長（平衡樹深度）</span>
<span class="sd">    - 內建早停機制 (Early Stopping)</span>
<span class="sd">    - 支援樣本權重 (Sample Weight)</span>
<span class="sd">    - 小樣本自動調整（max_depth 限制）</span>
<span class="sd">    - v1.2 支援：多目標追蹤（透過 target_id）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">XGBoostConfig</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;supports_explainability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># TreeSHAP 支援</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">sample_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">xgb_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># v1.2 增量學習預留</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;執行 XGBoost 訓練&quot;&quot;&quot;</span>

        <span class="c1"># 初始化模型</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
            <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_child_weight</span><span class="p">,</span>
            <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">subsample</span><span class="p">,</span>
            <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colsample_bytree</span><span class="p">,</span>
            <span class="n">reg_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reg_alpha</span><span class="p">,</span>
            <span class="n">reg_lambda</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">,</span>
            <span class="n">tree_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">tree_method</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># 應用單調性約束</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_monotonic_constraints</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">monotone_constraints</span> <span class="ow">and</span> <span class="n">feature_names</span><span class="p">:</span>
            <span class="n">mono_constraints</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">monotone_constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_names</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">monotone_constraints</span><span class="o">=</span><span class="n">mono_constraints</span><span class="p">)</span>

        <span class="c1"># 訓練（含早停）</span>
        <span class="n">eval_set</span> <span class="o">=</span> <span class="p">[(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)]</span>

        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;eval_set&#39;</span><span class="p">:</span> <span class="n">eval_set</span><span class="p">,</span>
            <span class="s1">&#39;early_stopping_rounds&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">early_stopping_rounds</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">sample_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;sample_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_weights</span>

        <span class="c1"># v1.2 預留：增量學習</span>
        <span class="k">if</span> <span class="n">xgb_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;xgb_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xgb_model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># 提取訓練歷史</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evals_result</span><span class="p">()</span>
        <span class="n">eval_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_metric</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_history</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;train_rmse&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;validation_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eval_metric</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;val_rmse&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;validation_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eval_metric</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;best_iteration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">,</span>
            <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best_score</span><span class="p">,</span>
            <span class="s1">&#39;n_features&#39;</span><span class="p">:</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="c1"># 提取特徵重要性 (Gain-based)</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
        <span class="k">if</span> <span class="n">feature_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">importance</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;feat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">imp</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">importance</span><span class="p">)}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s1">&#39;best_iteration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">,</span>
            <span class="s1">&#39;training_history&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_history</span><span class="p">,</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">,</span>
            <span class="s1">&#39;oob_score&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E702: 模型尚未訓練&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">iteration_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">partial_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_new</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_new</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        v1.2 功能：增量學習</span>
<span class="sd">        使用現有模型作為基礎，繼續訓練新資料</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;必須先執行初始訓練才能進行增量學習&quot;</span><span class="p">)</span>

        <span class="c1"># XGBoost 支援透過 xgb_model 參數接續訓練</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
            <span class="n">X_train</span><span class="o">=</span><span class="n">X_new</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">y_new</span><span class="p">,</span>
            <span class="n">X_val</span><span class="o">=</span><span class="n">X_new</span><span class="p">,</span> <span class="n">y_val</span><span class="o">=</span><span class="n">y_new</span><span class="p">,</span>  <span class="c1"># 驗證集可為新資料子集或沿用舊驗證集</span>
            <span class="n">sample_weights</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
            <span class="n">xgb_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span>  <span class="c1"># 傳入現有模型</span>
        <span class="p">)</span>
</code></pre></div>

<h4 id="step-12-lightgbm">Step 1.2: LightGBM 訓練器實作</h4>
<p><strong>檔案</strong>: <code>src/modeling/trainers/lightgbm_trainer.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">lightgbm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">lgb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.base_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModelTrainer</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LightGBMTrainer</span><span class="p">(</span><span class="n">BaseModelTrainer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LightGBM 訓練器實作 (v1.2)</span>

<span class="sd">    特性:</span>
<span class="sd">    - Leaf-wise 樹生長（更高效）</span>
<span class="sd">    - 原生 Dataset 結構（記憶體效率高）</span>
<span class="sd">    - 訓練速度極快</span>
<span class="sd">    - v1.2 支援：init_model 接續訓練</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">LightGBMConfig</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;supports_explainability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">sample_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">init_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># v1.2 增量學習預留</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;執行 LightGBM 訓練&quot;&quot;&quot;</span>

        <span class="c1"># 建立 Dataset（記憶體效率高）</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="n">X_train</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> 
            <span class="n">weight</span><span class="o">=</span><span class="n">sample_weights</span><span class="p">,</span>
            <span class="n">feature_name</span><span class="o">=</span><span class="n">feature_names</span> <span class="ow">or</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;feat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
            <span class="n">free_raw_data</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># 保留原始資料以供後續參考</span>
        <span class="p">)</span>
        <span class="n">val_data</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="n">X_val</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="n">y_val</span><span class="p">,</span>
            <span class="n">reference</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
            <span class="n">feature_name</span><span class="o">=</span><span class="n">train_data</span><span class="o">.</span><span class="n">feature_name</span>
        <span class="p">)</span>

        <span class="c1"># 超參數</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">,</span>
            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">,</span>
            <span class="s1">&#39;boosting_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">boosting_type</span><span class="p">,</span>
            <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_leaves</span><span class="p">,</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colsample_bytree</span><span class="p">,</span>
            <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">subsample</span><span class="p">,</span>
            <span class="s1">&#39;bagging_freq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;lambda_l1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reg_alpha</span><span class="p">,</span>
            <span class="s1">&#39;lambda_l2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">,</span>
            <span class="s1">&#39;min_child_samples&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_child_samples</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="s1">&#39;feature_pre_filter&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">feature_pre_filter</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">histogram_pool_size</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;histogram_pool_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">histogram_pool_size</span>

        <span class="c1"># 訓練（含早停）</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">lgb</span><span class="o">.</span><span class="n">early_stopping</span><span class="p">(</span><span class="n">stopping_rounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">early_stopping_rounds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">num_boost_round</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span>
            <span class="n">valid_sets</span><span class="o">=</span><span class="p">[</span><span class="n">train_data</span><span class="p">,</span> <span class="n">val_data</span><span class="p">],</span>
            <span class="n">valid_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">],</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
            <span class="n">init_model</span><span class="o">=</span><span class="n">init_model</span>  <span class="c1"># v1.2 增量學習</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># 提取訓練歷史</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_history</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;best_iteration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">,</span>
            <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best_score</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;n_features&#39;</span><span class="p">:</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="c1"># 特徵重要性 (Gain-based 較穩定)</span>
        <span class="n">importance_gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">importance_gain</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s1">&#39;best_iteration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">,</span>
            <span class="s1">&#39;training_history&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_history</span><span class="p">,</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">,</span>
            <span class="s1">&#39;oob_score&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E702: 模型尚未訓練&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">num_iteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div>

<h4 id="step-13-random-forest">Step 1.3: Random Forest 訓練器實作</h4>
<p><strong>檔案</strong>: <code>src/modeling/trainers/random_forest_trainer.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.base_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModelTrainer</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RandomForestTrainer</span><span class="p">(</span><span class="n">BaseModelTrainer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Random Forest 訓練器實作 (v1.2)</span>

<span class="sd">    特性:</span>
<span class="sd">    - Bagging 策略（平行樹）</span>
<span class="sd">    - 天然支援 OOB (Out-of-Bag) 驗證</span>
<span class="sd">    - 預測區間輸出（使用所有樹的預測分佈）</span>
<span class="sd">    - 對異常值鲁棒</span>
<span class="sd">    - v1.2 實作：warm_start 增量訓練</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RandomForestConfig</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;supports_incremental&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># warm_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;supports_explainability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># RF 可不使用獨立驗證集（使用 OOB）</span>
        <span class="n">y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;執行 Random Forest 訓練&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
            <span class="n">min_samples_split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_samples_split</span><span class="p">,</span>
            <span class="n">min_samples_leaf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_samples_leaf</span><span class="p">,</span>
            <span class="n">max_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_features</span><span class="p">,</span>
            <span class="n">bootstrap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">,</span>
            <span class="n">oob_score</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">oob_score</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">warm_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">warm_start</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># 訓練</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># OOB 分數</span>
        <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">oob_score</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">bootstrap</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;oob_score_&#39;</span><span class="p">):</span>
            <span class="n">oob_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">oob_score_</span>

        <span class="c1"># 訓練歷史</span>
        <span class="n">train_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">val_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span> <span class="k">if</span> <span class="n">X_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_history</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;train_rmse&#39;</span><span class="p">:</span> <span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">],</span>
            <span class="s1">&#39;val_rmse&#39;</span><span class="p">:</span> <span class="n">val_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rmse&#39;</span><span class="p">),</span>
            <span class="s1">&#39;oob_r2&#39;</span><span class="p">:</span> <span class="n">oob_score</span><span class="p">,</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span>
            <span class="s1">&#39;n_features&#39;</span><span class="p">:</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="c1"># 特徵重要性 (MDI)</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
        <span class="k">if</span> <span class="n">feature_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">importance</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;feat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">imp</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">importance</span><span class="p">)}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s1">&#39;best_iteration&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># RF 無迭代概念</span>
            <span class="s1">&#39;training_history&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_history</span><span class="p">,</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">,</span>
            <span class="s1">&#39;oob_score&#39;</span><span class="p">:</span> <span class="n">oob_score</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E702: 模型尚未訓練&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_with_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        輸出預測區間（使用所有樹的預測分佈）</span>

<span class="sd">        Args:</span>
<span class="sd">            X: 特徵矩陣</span>
<span class="sd">            confidence: 信心水準（預設 90%，輸出 Q5 與 Q95）</span>

<span class="sd">        Returns:</span>
<span class="sd">            {</span>
<span class="sd">                &#39;mean&#39;: 平均預測值,</span>
<span class="sd">                &#39;lower&#39;: 下界,</span>
<span class="sd">                &#39;upper&#39;: 上界,</span>
<span class="sd">                &#39;std&#39;: 標準差</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E702: 模型尚未訓練&quot;</span><span class="p">)</span>

        <span class="c1"># 取得所有樹的預測 (n_samples, n_trees)</span>
        <span class="n">all_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">])</span>

        <span class="n">mean_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 計算分位數</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean_pred</span><span class="p">,</span>
            <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
            <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">std_pred</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">partial_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_new</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_new</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        v1.2 功能：增量學習</span>
<span class="sd">        透過增加 n_estimators 實現增量訓練</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;必須先執行初始訓練&quot;</span><span class="p">)</span>

        <span class="c1"># 增加樹的數量</span>
        <span class="n">current_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_estimators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_estimators</span> <span class="o">+=</span> <span class="mi">100</span>  <span class="c1"># 每次增加 100 棵樹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s1">&#39;previous_n_estimators&#39;</span><span class="p">:</span> <span class="n">current_n</span><span class="p">,</span>
            <span class="s1">&#39;new_n_estimators&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span>
            <span class="s1">&#39;oob_score&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;oob_score_&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<hr />
<h3 id="phase-2-day-5">Phase 2: 多模型訓練管線整合 (Day 5)</h3>
<h4 id="step-21-v11">Step 2.1: 資源管理與動態調度（v1.1 內容保留）</h4>
<p><strong>檔案</strong>: <code>src/modeling/resource_manager.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ResourceManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    訓練資源管理器 (v1.2)</span>
<span class="sd">    負責記憶體評估、動態降級決策、以及硬體資源監控</span>

<span class="sd">    v1.2 更新:</span>
<span class="sd">    - 增加批次訓練記憶體估算（多目標情境）</span>
<span class="sd">    - 增加並行目標數限制</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ResourceConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">available</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_memory_requirement</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
        <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">eligible_models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        估算各模型記憶體需求（位元組）</span>

<span class="sd">        估算公式（保守估計）：</span>
<span class="sd">        - XGBoost: ~8 bytes * n_samples * n_features * 1.5 (sparse overhead) * 1.2 (tree storage)</span>
<span class="sd">        - LightGBM: ~4 bytes * n_samples * n_features * 0.8 (dense efficiency) * 1.1</span>
<span class="sd">        - Random Forest: ~8 bytes * n_samples * n_features * n_trees/5 (每棵樹儲存部分樣本索引)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_size</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">*</span> <span class="n">n_features</span>

        <span class="n">estimates</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;xgboost&#39;</span> <span class="ow">in</span> <span class="n">eligible_models</span><span class="p">:</span>
            <span class="n">estimates</span><span class="p">[</span><span class="s1">&#39;xgboost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_size</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="mf">1.2</span>

        <span class="k">if</span> <span class="s1">&#39;lightgbm&#39;</span> <span class="ow">in</span> <span class="n">eligible_models</span><span class="p">:</span>
            <span class="n">estimates</span><span class="p">[</span><span class="s1">&#39;lightgbm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_size</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="mf">1.1</span>

        <span class="k">if</span> <span class="s1">&#39;random_forest&#39;</span> <span class="ow">in</span> <span class="n">eligible_models</span><span class="p">:</span>
            <span class="n">n_trees</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># 預設</span>
            <span class="n">rf_factor</span> <span class="o">=</span> <span class="n">n_trees</span> <span class="o">*</span> <span class="mf">0.632</span> <span class="o">*</span> <span class="mi">4</span>  <span class="c1"># 4 bytes per index (int32)</span>
            <span class="n">estimates</span><span class="p">[</span><span class="s1">&#39;random_forest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_size</span> <span class="o">*</span> <span class="n">rf_factor</span>

        <span class="k">return</span> <span class="n">estimates</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_training_feasibility</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
        <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">eligible_models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">n_concurrent_targets</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># v1.2 新增：並行目標數</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        檢查訓練可行性</span>

<span class="sd">        Returns:</span>
<span class="sd">            (is_feasible, use_parallel, message)</span>
<span class="sd">            - is_feasible: 是否可行</span>
<span class="sd">            - use_parallel: 是否可使用平行訓練</span>
<span class="sd">            - message: 說明訊息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">memory_check_before_training</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_training</span><span class="p">,</span> <span class="s2">&quot;跳過記憶體檢查&quot;</span>

        <span class="n">estimates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_memory_requirement</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">eligible_models</span><span class="p">)</span>
        <span class="n">total_required</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">estimates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">*</span> <span class="n">n_concurrent_targets</span>  <span class="c1"># v1.2：乘以並行目標數</span>

        <span class="n">available_mem</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">available</span>
        <span class="n">total_mem</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span>
        <span class="n">safety_threshold</span> <span class="o">=</span> <span class="n">total_mem</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">memory_safety_threshold</span><span class="p">)</span>

        <span class="c1"># 檢查單一模型是否可行</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">est</span> <span class="o">&gt;</span> <span class="n">available_mem</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">estimates</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">problematic</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">estimates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">est</span> <span class="o">&gt;</span> <span class="n">available_mem</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;E801: 記憶體不足，</span><span class="si">{</span><span class="n">problematic</span><span class="si">}</span><span class="s2"> 需求超過可用記憶體&quot;</span>

        <span class="c1"># 檢查平行訓練可行性</span>
        <span class="k">if</span> <span class="n">total_required</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">available_mem</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">safety_threshold</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;✅ 記憶體充足: 需求 </span><span class="si">{</span><span class="n">total_required</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB, 可用 </span><span class="si">{</span><span class="n">available_mem</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB&quot;</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">auto_fallback_to_sequential</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ E801: 平行訓練記憶體風險 (需求 </span><span class="si">{</span><span class="n">total_required</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB &gt; &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;安全閾值 </span><span class="si">{</span><span class="n">safety_threshold</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB)，自動降級為序列訓練&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;E801: 記憶體不足且未啟用自動降級&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_optimal_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得建議的平行執行緒數（避免過度訂閱）&quot;&quot;&quot;</span>
        <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;random_forest&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cpu_count</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cpu_count</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_resource_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記錄當前資源使用狀況&quot;&quot;&quot;</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
        <span class="n">cpu</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📊 資源狀態: CPU </span><span class="si">{</span><span class="n">cpu</span><span class="si">}</span><span class="s2">%, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;記憶體 </span><span class="si">{</span><span class="n">mem</span><span class="o">.</span><span class="n">used</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mem</span><span class="o">.</span><span class="n">total</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB (</span><span class="si">{</span><span class="n">mem</span><span class="o">.</span><span class="n">percent</span><span class="si">}</span><span class="s2">%)&quot;</span>
        <span class="p">)</span>
</code></pre></div>

<h4 id="step-22">Step 2.2: 平行訓練與模型選擇邏輯</h4>
<p><strong>檔案</strong>: <code>src/modeling/training_pipeline.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.xgboost_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBoostTrainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.lightgbm_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">LightGBMTrainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.random_forest_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestTrainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.resource_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResourceManager</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TrainingPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    多模型訓練管線 v1.2 (Resource-Aware + Multi-Target Ready)</span>

<span class="sd">    同時訓練 XGBoost、LightGBM、Random Forest，</span>
<span class="sd">    並依驗證指標自動選擇最佳模型或保留 Ensemble。</span>
<span class="sd">    具備動態記憶體管理與小樣本適應機制。</span>

<span class="sd">    v1.2 更新:</span>
<span class="sd">    - 支援 target_id 標記，用於多目標追蹤</span>
<span class="sd">    - 與 BatchTrainingCoordinator 整合介面</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ModelTrainingConfig</span><span class="p">,</span> <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="n">site_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">target_id</span>  <span class="c1"># v1.2 新增</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_manager</span> <span class="o">=</span> <span class="n">FeatureAnnotationManager</span><span class="p">(</span><span class="n">site_id</span><span class="o">=</span><span class="n">site_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_manager</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_annotation_compatibility</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;end_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;models_trained&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;resource_events&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_annotation_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;驗證上游 Annotation 相容性&quot;&quot;&quot;</span>
        <span class="k">pass</span>  <span class="c1"># 實作細略</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_select_best_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        選擇最佳模型（v1.2 強化版）</span>

<span class="sd">        策略:</span>
<span class="sd">        1. 優先比較驗證集 R² 分數</span>
<span class="sd">        2. 若 R² 差距 &lt; 0.01，比較訓練穩定性（RF 的 OOB 與 Val 差距）</span>
<span class="sd">        3. 若 RF 的 OOB 與驗證集差距過大（&gt;0.1），可能表示資料洩漏，降低排名</span>
<span class="sd">        4. 選擇訓練時間較短的（在精度相當時）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">res</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span> <span class="ow">and</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">in</span> <span class="n">res</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_results</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModelTrainingError</span><span class="p">(</span><span class="s2">&quot;E703: 所有模型訓練失敗&quot;</span><span class="p">)</span>

        <span class="n">model_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">valid_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">val_r2</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span>
            <span class="n">train_r2</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span>
            <span class="n">overfit_score</span> <span class="o">=</span> <span class="n">train_r2</span> <span class="o">-</span> <span class="n">val_r2</span>

            <span class="n">oob_penalty</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;random_forest&#39;</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oob_score&#39;</span><span class="p">):</span>
                <span class="n">oob_gap</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;oob_score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">val_r2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oob_gap</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">oob_penalty</span> <span class="o">=</span> <span class="mf">0.05</span>

            <span class="n">composite_score</span> <span class="o">=</span> <span class="n">val_r2</span> <span class="o">-</span> <span class="n">overfit_score</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">oob_penalty</span>

            <span class="n">model_scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">composite_score</span><span class="p">,</span> <span class="n">val_r2</span><span class="p">))</span>

        <span class="n">model_scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">best_name</span> <span class="o">=</span> <span class="n">model_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🏆 最佳模型: </span><span class="si">{</span><span class="n">best_name</span><span class="si">}</span><span class="s2"> (target=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_all_models</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">sample_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        訓練所有符合資格的模型（資源感知排程）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">eligible_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_eligible_models</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📋 目標=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="si">}</span><span class="s2">, 樣本數=</span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">, 模型=</span><span class="si">{</span><span class="n">eligible_models</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">is_feasible</span><span class="p">,</span> <span class="n">use_parallel</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_manager</span><span class="o">.</span><span class="n">check_training_feasibility</span><span class="p">(</span>
            <span class="n">n_samples</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">eligible_models</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_feasible</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModelTrainingError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">trainers_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">eligible_models</span><span class="p">:</span>
            <span class="n">TrainerClass</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span> <span class="n">XGBoostTrainer</span><span class="p">,</span>
                <span class="s1">&#39;lightgbm&#39;</span><span class="p">:</span> <span class="n">LightGBMTrainer</span><span class="p">,</span>
                <span class="s1">&#39;random_forest&#39;</span><span class="p">:</span> <span class="n">RandomForestTrainer</span>
            <span class="p">}[</span><span class="n">name</span><span class="p">]</span>

            <span class="n">model_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">adjust_for_small_sample</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
            <span class="n">trainers_config</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TrainerClass</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_parallel</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">trainers_config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_parallel</span><span class="p">(</span><span class="n">trainers_config</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> 
                               <span class="n">sample_weights</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_sequential</span><span class="p">(</span><span class="n">trainers_config</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
                                 <span class="n">sample_weights</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">auto_select_best</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_model</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_train_single_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">TrainerClass</span><span class="p">,</span> <span class="n">model_config</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
                           <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練單一模型&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="si">}</span><span class="s2">] 訓練 </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">trainer</span> <span class="o">=</span> <span class="n">TrainerClass</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span> 
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
                <span class="n">target_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span>  <span class="c1"># v1.2 傳遞 target_id</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>

            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span>
                <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;training_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;models_trained&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> 訓練失敗: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_train_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainers_config</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> 
                       <span class="n">sample_weights</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;平行訓練&quot;&quot;&quot;</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trainers_config</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">max_parallel_workers</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_train_single_model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">TrainerClass</span><span class="p">,</span> <span class="n">model_config</span><span class="p">,</span>
                    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span> <span class="n">feature_names</span>
                <span class="p">):</span> <span class="n">name</span> 
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">TrainerClass</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)</span> <span class="ow">in</span> <span class="n">trainers_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model_name</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> 進程異常: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_train_sequential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainers_config</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
                         <span class="n">sample_weights</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;序列訓練&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">TrainerClass</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)</span> <span class="ow">in</span> <span class="n">trainers_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model_name</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_single_model</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">TrainerClass</span><span class="p">,</span> <span class="n">model_config</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
                <span class="n">sample_weights</span><span class="p">,</span> <span class="n">feature_names</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;random_forest&#39;</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resource_manager</span><span class="o">.</span><span class="n">log_resource_usage</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_best_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseModelTrainer</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得最佳模型&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E706: 尚未執行模型選擇&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensemble 預測（加權平均）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_trainers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">trainer</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trainer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_trainers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E707: 無可用模型進行 Ensemble 預測&quot;</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model_weights</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trainer</span> <span class="ow">in</span> <span class="n">valid_trainers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">weights</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">:</span>
                <span class="n">model_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="s1">&#39;r2&#39;</span><span class="p">])</span>
                <span class="n">model_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

        <span class="n">weights_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_weights</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model_weights</span><span class="p">)</span>
        <span class="n">ensemble_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights_arr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ensemble_pred</span>
</code></pre></div>

<hr />
<h3 id="phase-3-day-6-7">Phase 3: 超參數優化與可解釋性 (Day 6-7)</h3>
<p><strong>（v1.1 內容保留，保持不變）</strong></p>
<h4 id="step-31">Step 3.1: 夜間超參數優化器</h4>
<p><strong>檔案</strong>: <code>src/modeling/hyperparameter/optuna_optimizer.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">optuna</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.xgboost_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBoostTrainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.lightgbm_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">LightGBMTrainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.trainers.random_forest_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestTrainer</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchSpace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;定義各模型的超參數搜尋空間&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">xgboost_space</span><span class="p">(</span><span class="n">trial</span><span class="p">:</span> <span class="n">optuna</span><span class="o">.</span><span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="s1">&#39;min_child_weight&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;min_child_weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;subsample&#39;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;reg_alpha&#39;</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;reg_lambda&#39;</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lightgbm_space</span><span class="p">(</span><span class="n">trial</span><span class="p">:</span> <span class="n">optuna</span><span class="o">.</span><span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;num_leaves&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;feature_fraction&#39;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;bagging_fraction&#39;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;bagging_freq&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;bagging_freq&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="s1">&#39;min_child_samples&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;min_child_samples&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;reg_alpha&#39;</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;reg_lambda&#39;</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">random_forest_space</span><span class="p">(</span><span class="n">trial</span><span class="p">:</span> <span class="n">optuna</span><span class="o">.</span><span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">max_depth_choice</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s1">&#39;max_depth_choice&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_depth_choice</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;min_samples_split&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s1">&#39;max_features&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
        <span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OvernightOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    夜間超參數優化器 (v1.2)</span>

<span class="sd">    特性：</span>
<span class="sd">    1. 依序優化（非並行），避免資源爆炸</span>
<span class="sd">    2. 支援斷點續傳（SQLite 儲存 study）</span>
<span class="sd">    3. 與 Early Stopping 整合，加速每個 trial</span>
<span class="sd">    4. Pruning 機制：自動終止無望的 trial</span>

<span class="sd">    v1.2 更新:</span>
<span class="sd">    - 支援多目標批次優化（透過 BatchTrainingCoordinator 呼叫）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ModelTrainingConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sqlite:///</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">hyperparameter_storage</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="n">n_startup_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>  <span class="c1"># v1.2 新增</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        單一模型優化（建議夜間執行）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">study_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span>
            <span class="n">study_name</span><span class="o">=</span><span class="n">study_name</span><span class="p">,</span>
            <span class="n">storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span>
            <span class="n">load_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span>
            <span class="n">sampler</span><span class="o">=</span><span class="n">optuna</span><span class="o">.</span><span class="n">samplers</span><span class="o">.</span><span class="n">TPESampler</span><span class="p">(</span><span class="n">n_startup_trials</span><span class="o">=</span><span class="n">n_startup_trials</span><span class="p">),</span>
            <span class="n">pruner</span><span class="o">=</span><span class="n">optuna</span><span class="o">.</span><span class="n">pruners</span><span class="o">.</span><span class="n">MedianPruner</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
            <span class="n">space_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">SearchSpace</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_space&quot;</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">space_method</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>

            <span class="n">trainer_class</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span> <span class="n">XGBoostTrainer</span><span class="p">,</span>
                <span class="s1">&#39;lightgbm&#39;</span><span class="p">:</span> <span class="n">LightGBMTrainer</span><span class="p">,</span>
                <span class="s1">&#39;random_forest&#39;</span><span class="p">:</span> <span class="n">RandomForestTrainer</span>
            <span class="p">}[</span><span class="n">model_name</span><span class="p">]</span>

            <span class="n">base_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">temp_config</span> <span class="o">=</span> <span class="n">base_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">temp_config</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

            <span class="n">trainer</span> <span class="o">=</span> <span class="n">trainer_class</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">temp_config</span><span class="p">,</span> 
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
                <span class="n">target_id</span><span class="o">=</span><span class="n">target_id</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
                <span class="n">val_metrics</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
                <span class="n">val_r2</span> <span class="o">=</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span>

                <span class="n">trial</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">val_r2</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">optuna</span><span class="o">.</span><span class="n">TrialPruned</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">val_r2</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trial </span><span class="si">{</span><span class="n">trial</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> 失敗: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
            <span class="s1">&#39;study_name&#39;</span><span class="p">:</span> <span class="n">study_name</span><span class="p">,</span>
            <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">study</span><span class="o">.</span><span class="n">best_params</span><span class="p">,</span>
            <span class="s1">&#39;best_value&#39;</span><span class="p">:</span> <span class="n">study</span><span class="o">.</span><span class="n">best_value</span><span class="p">,</span>
            <span class="s1">&#39;n_trials_completed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">study</span><span class="o">.</span><span class="n">trials</span><span class="p">),</span>
            <span class="s1">&#39;n_trials_pruned&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">study</span><span class="o">.</span><span class="n">trials</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">optuna</span><span class="o">.</span><span class="n">trial</span><span class="o">.</span><span class="n">TrialState</span><span class="o">.</span><span class="n">PRUNED</span><span class="p">]),</span>
            <span class="s1">&#39;optimization_time&#39;</span><span class="p">:</span> <span class="n">elapsed</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_all_models_sequentially</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">TrainingInputContract</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        依序優化三模型（資源安全模式）</span>
<span class="sd">        建議執行時段：夜間 00:00 - 06:00</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 資料準備（略）</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;random_forest&#39;</span><span class="p">,</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgbm&#39;</span><span class="p">]</span>
        <span class="n">eligible_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_eligible_models</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">eligible_models</span><span class="p">]</span>

        <span class="n">total_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🌙 開始夜間優化: </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">timeout_per_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hyperparameter_timeout</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_model</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
                <span class="n">X_val</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="o">=</span><span class="n">y_val</span><span class="p">,</span>
                <span class="n">n_trials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hyperparameter_trials</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_per_model</span><span class="p">,</span>
                <span class="n">target_id</span><span class="o">=</span><span class="n">target_id</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> 優化完成: Best R²=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;best_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">total_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_best_params_recommendation</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_best_params_recommendation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;儲存最佳參數供明日日間訓練使用&quot;&quot;&quot;</span>
        <span class="n">recommendation</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
            <span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;best_params&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;best_params&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;expected_performance&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;best_value&#39;</span><span class="p">]</span>
                <span class="p">}</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;config/hyperparameter_recommendations_</span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">recommendation</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<h4 id="step-32-shap-integration">Step 3.2: 可解釋性封裝（SHAP Integration）</h4>
<p><strong>檔案</strong>: <code>src/modeling/explainability/shap_explainer.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ModelExplainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    模型可解釋性封裝層 (v1.2)</span>
<span class="sd">    支援 TreeSHAP (適用 XGB/LGB/RF) 與 HVAC 專用時間序列解釋</span>

<span class="sd">    注意：需安裝 shap: pip install shap</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">target_id</span>  <span class="c1"># v1.2 新增</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">shap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shap</span> <span class="o">=</span> <span class="n">shap</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;E805: 使用可解釋性功能需安裝 shap: pip install shap&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_background</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        建立 SHAP 背景分佈（用於對比基準）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_background</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sample_size</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_background</span><span class="p">),</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">background_data</span> <span class="o">=</span> <span class="n">X_background</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">background_data</span> <span class="o">=</span> <span class="n">X_background</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;xgboost&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgbm&#39;</span><span class="p">,</span> <span class="s1">&#39;random_forest&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shap</span><span class="o">.</span><span class="n">KernelExplainer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">shap</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">background_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">explain_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_instance</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        單筆預測解釋（局部解釋）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;E804: 需先執行 fit_background()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">X_instance</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">X_instance</span> <span class="o">=</span> <span class="n">X_instance</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">shap_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X_instance</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">shap_values</span> <span class="o">=</span> <span class="n">shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">feature_contrib</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="n">sorted_contrib</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">feature_contrib</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
            <span class="s1">&#39;base_value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">),</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shap_values</span><span class="p">)),</span>
            <span class="s1">&#39;feature_contributions&#39;</span><span class="p">:</span> <span class="n">feature_contrib</span><span class="p">,</span>
            <span class="s1">&#39;top_positive&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">feature_contrib</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> 
                                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;top_negative&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">feature_contrib</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">],</span> 
                                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;shap_values&#39;</span><span class="p">:</span> <span class="n">shap_values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">explain_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;批次解釋（記憶體效率版）&quot;&quot;&quot;</span>
        <span class="n">explanations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)):</span>
                <span class="n">explanations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explain_local</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">explanations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">explain_temporal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_series</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        HVAC 專用：時間序列特徵貢獻追蹤</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">explanations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explain_batch</span><span class="p">(</span><span class="n">X_series</span><span class="p">)</span>

        <span class="n">df_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamps</span><span class="p">,</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
            <span class="s1">&#39;base_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;base_value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">explanations</span><span class="p">],</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">explanations</span><span class="p">],</span>
            <span class="s1">&#39;primary_driver&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;top_positive&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;top_positive&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span> 
                              <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">explanations</span><span class="p">],</span>
            <span class="s1">&#39;primary_contribution&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;top_positive&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;top_positive&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> 
                                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">explanations</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">:</span>
            <span class="n">df_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;shap_</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">e</span><span class="p">[</span><span class="s1">&#39;feature_contributions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">explanations</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_summary_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;產生特徵重要性摘要圖（供工程師審閱）&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">shap_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">shap_values</span> <span class="o">=</span> <span class="n">shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span>
            <span class="n">shap_values</span><span class="p">,</span> 
            <span class="n">X_test</span><span class="p">,</span> 
            <span class="n">feature_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP 摘要圖已儲存: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h3 id="phase-4-day-8">Phase 4: 完整訓練流程與產出 (Day 8)</h3>
<h4 id="step-41">Step 4.1: 完整訓練流程</h4>
<p><strong>檔案</strong>: <code>src/modeling/training_pipeline.py</code>（方法更新）</p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">TrainingInputContract</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MultiModelArtifact&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    執行完整多模型訓練流程 (v1.2)</span>

<span class="sd">    流程：</span>
<span class="sd">    1. 輸入驗證與契約檢查</span>
<span class="sd">    2. 時序資料分割（零洩漏）</span>
<span class="sd">    3. Device Role 權重計算</span>
<span class="sd">    4. 特徵前處理（縮放、缺失值）</span>
<span class="sd">    5. 資格檢查（樣本數、記憶體）</span>
<span class="sd">    6. 模型訓練（平行或序列）</span>
<span class="sd">    7. 測試集最終評估</span>
<span class="sd">    8. 可解釋性初始化（若啟用）</span>
<span class="sd">    9. 產出 MultiModelArtifact（含 target_id 標記）</span>

<span class="sd">    Returns:</span>
<span class="sd">        MultiModelArtifact: 包含三模型結果、最佳模型選擇、以及可解釋性介面</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="c1"># Step 1: 輸入驗證</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input_contract</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature_matrix&#39;</span><span class="p">]</span>
    <span class="n">target_col</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target_variable&#39;</span><span class="p">]</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 開始訓練流程: site=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="si">}</span><span class="s2">, target=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="si">}</span><span class="s2">, samples=</span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Step 2: 時序分割</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temporal_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target_col</span><span class="p">)</span>

    <span class="c1"># Step 3: Device Role 處理</span>
    <span class="n">sample_weights</span><span class="p">,</span> <span class="n">seasonal_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_sample_weights_and_masks</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">seasonal_mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">seasonal_mask</span><span class="p">))</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">seasonal_mask</span><span class="p">))</span>
        <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">sample_weights</span><span class="p">[</span><span class="n">seasonal_mask</span><span class="p">]</span>

    <span class="c1"># Step 4: 特徵前處理</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">feature_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_features</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">)</span>

    <span class="c1"># Step 5: 多模型訓練</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_all_models</span><span class="p">(</span>
        <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">X_val</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="o">=</span><span class="n">y_val</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">sample_weights</span><span class="o">=</span><span class="n">sample_weights</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_cols</span>
    <span class="p">)</span>

    <span class="c1"># Step 6: 測試集最終評估</span>
    <span class="n">best_name</span><span class="p">,</span> <span class="n">best_trainer</span><span class="p">,</span> <span class="n">best_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_model</span><span class="p">()</span>
    <span class="n">test_metrics</span> <span class="o">=</span> <span class="n">best_trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;🧪 [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="si">}</span><span class="s2">] 最佳模型 [</span><span class="si">{</span><span class="n">best_name</span><span class="si">}</span><span class="s2">] 測試集: R²=</span><span class="si">{</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Step 7: 可解釋性初始化</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_explainability</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.explainability.shap_explainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelExplainer</span>

            <span class="n">explainer</span> <span class="o">=</span> <span class="n">ModelExplainer</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">best_trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_cols</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">best_name</span><span class="p">,</span>
                <span class="n">target_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span>
            <span class="p">)</span>
            <span class="n">explainer</span><span class="o">.</span><span class="n">fit_background</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shap_background_samples</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ 可解釋性初始化失敗: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Step 8: 建立產出物</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">MultiModelArtifact</span><span class="p">(</span>
        <span class="n">target_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
        <span class="n">site_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
        <span class="n">trainers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainers</span><span class="p">,</span>
        <span class="n">results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
        <span class="n">best_model_name</span><span class="o">=</span><span class="n">best_name</span><span class="p">,</span>
        <span class="n">test_metrics</span><span class="o">=</span><span class="n">test_metrics</span><span class="p">,</span>
        <span class="n">training_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_training_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_metrics</span><span class="p">),</span>
        <span class="n">annotation_context</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;annotation_context&#39;</span><span class="p">],</span>
        <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_cols</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="n">explainer</span><span class="o">=</span><span class="n">explainer</span><span class="p">,</span>
        <span class="n">training_stats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">artifact</span>
</code></pre></div>

<h4 id="step-42-v12">Step 4.2: 多模型產出物定義（v1.2 擴充）</h4>
<p><strong>檔案</strong>: <code>src/modeling/artifacts.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiModelArtifact</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    多模型訓練產出物 (v1.2)</span>

<span class="sd">    儲存結構:</span>
<span class="sd">    models/</span>
<span class="sd">    └── {site_id}/</span>
<span class="sd">        ├── model_registry_index.json           # 總索引（Optimization Engine 入口）</span>
<span class="sd">        ├── {target_id}/                        # 目標專屬目錄（v1.2 標準化）</span>
<span class="sd">        │   ├── {timestamp}_ensemble_manifest.json</span>
<span class="sd">        │   ├── {timestamp}_xgboost_model.joblib</span>
<span class="sd">        │   ├── {timestamp}_lightgbm_model.joblib</span>
<span class="sd">        │   ├── {timestamp}_random_forest_model.joblib</span>
<span class="sd">        │   ├── {timestamp}_shap_summary.png</span>
<span class="sd">        │   └── {timestamp}_explainability_metadata.json</span>
<span class="sd">        └── ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># v1.2 新增</span>
    <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># v1.2 新增</span>
    <span class="n">trainers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseModelTrainer</span><span class="p">]</span>
    <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">best_model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">test_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">training_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">annotation_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">ModelTrainingConfig</span>
    <span class="n">explainer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">training_stats</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;計算檔案 SHA256 checksum&quot;&quot;&quot;</span>
        <span class="n">sha256_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">byte_block</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">sha256_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byte_block</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;sha256:</span><span class="si">{</span><span class="n">sha256_hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        儲存所有模型、元資料與可解釋性物件</span>
<span class="sd">        回傳儲存的檔案路徑字典</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">saved_files</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 儲存每個模型</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trainer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">or</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">model_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_model.joblib&quot;</span>
            <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_metadata.json&quot;</span>

            <span class="c1"># 儲存模型</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="s1">&#39;scaler&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s1">&#39;feature_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
                <span class="s1">&#39;model_metadata&#39;</span><span class="p">:</span> <span class="n">trainer</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">(),</span>
                <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
                <span class="s1">&#39;site_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span>
            <span class="p">},</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># 計算 checksum</span>
            <span class="n">model_checksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_checksum</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

            <span class="c1"># 儲存該模型元資料</span>
            <span class="n">model_meta</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
                <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">],</span>
                <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="n">trainer</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">(),</span>
                <span class="s1">&#39;training_history&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;training_history&#39;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="s1">&#39;best_iteration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;best_iteration&#39;</span><span class="p">),</span>
                <span class="s1">&#39;oob_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oob_score&#39;</span><span class="p">),</span>
                <span class="s1">&#39;training_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;training_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;file_checksum&#39;</span><span class="p">:</span> <span class="n">model_checksum</span>
            <span class="p">}</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_meta</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

            <span class="n">saved_files</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_path</span>
            <span class="n">saved_files</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_path</span>

        <span class="c1"># 儲存 Ensemble Manifest（該 target 的總覽）</span>
        <span class="n">manifest_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
            <span class="s1">&#39;site_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
            <span class="s1">&#39;best_model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">,</span>
            <span class="s1">&#39;test_metrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">,</span>
            <span class="s1">&#39;training_stats&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">,</span>
            <span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">manifest_data</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;model_file&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_model.joblib&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;metadata_file&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_metadata.json&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;val_r2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="s1">&#39;r2&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;test_r2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;is_best&#39;</span><span class="p">:</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span>
                <span class="p">}</span>

        <span class="n">manifest_data</span><span class="p">[</span><span class="s1">&#39;training_metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_metadata</span>
        <span class="n">manifest_data</span><span class="p">[</span><span class="s1">&#39;annotation_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_context</span>

        <span class="n">manifest_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_ensemble_manifest.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">saved_files</span><span class="p">[</span><span class="s1">&#39;ensemble_manifest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manifest_path</span>

        <span class="c1"># 儲存可解釋性物件</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_explainability</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">explainer_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_explainer.joblib&quot;</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span>
                    <span class="s1">&#39;explainer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">explainer</span><span class="p">,</span>
                    <span class="s1">&#39;feature_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
                    <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
                    <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
                    <span class="s1">&#39;background_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">background_data</span>
                <span class="p">},</span> <span class="n">explainer_path</span><span class="p">)</span>
                <span class="n">saved_files</span><span class="p">[</span><span class="s1">&#39;explainer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">explainer_path</span>

                <span class="c1"># 產生摘要圖</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="p">,</span> <span class="s1">&#39;background_data&#39;</span><span class="p">):</span>
                    <span class="n">summary_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_shap_summary.png&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">generate_summary_plot</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">background_data</span><span class="p">,</span> 
                        <span class="nb">str</span><span class="p">(</span><span class="n">summary_path</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">saved_files</span><span class="p">[</span><span class="s1">&#39;shap_summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_path</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">manifest_data</span><span class="p">[</span><span class="s1">&#39;explainability_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">saved_files</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">manifest_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        載入指定模型或最佳模型</span>
<span class="sd">        支援 target_id 標記</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">manifest_path</span><span class="o">.</span><span class="n">parent</span>

        <span class="n">target_model</span> <span class="o">=</span> <span class="n">model_name</span> <span class="ow">or</span> <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;best_model&#39;</span><span class="p">]</span>
        <span class="n">model_info</span> <span class="o">=</span> <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="n">target_model</span><span class="p">]</span>

        <span class="n">model_data</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_dir</span> <span class="o">/</span> <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;model_file&#39;</span><span class="p">])</span>

        <span class="n">explainer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">explainer_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_explainer.joblib&quot;</span>
        <span class="k">if</span> <span class="n">explainer_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">explainer_data</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">explainer_path</span><span class="p">)</span>
                <span class="n">explainer</span> <span class="o">=</span> <span class="n">explainer_data</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: 無法載入 explainer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;target_id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;model_data&#39;</span><span class="p">:</span> <span class="n">model_data</span><span class="p">,</span>
            <span class="s1">&#39;manifest&#39;</span><span class="p">:</span> <span class="n">manifest</span><span class="p">,</span>
            <span class="s1">&#39;explainer&#39;</span><span class="p">:</span> <span class="n">explainer</span><span class="p">,</span>
            <span class="s1">&#39;loaded_model&#39;</span><span class="p">:</span> <span class="n">target_model</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_with_explanation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        預測並提供解釋（v1.2 便利方法）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;最佳模型未訓練&quot;</span><span class="p">)</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;target_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="s1">&#39;model_used&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">,</span>
            <span class="s1">&#39;explanation&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">.</span><span class="n">explain_local</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">explanation</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;top_drivers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">explanation</span><span class="p">[</span><span class="s1">&#39;top_positive&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;explanation_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<hr />
<h3 id="phase-5-day-9-10-v12">Phase 5: 多目標批次訓練協調器 (Day 9-10) - v1.2 新增</h3>
<h4 id="step-51-batchtrainingcoordinator">Step 5.1: BatchTrainingCoordinator 實作</h4>
<p><strong>檔案</strong>: <code>src/modeling/coordinators/batch_coordinator.py</code></p>
<p><strong>實作內容</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.training_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrainingPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.config_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelTrainingConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.modeling.artifacts</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiModelArtifact</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BatchTrainingCoordinator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    多目標批次訓練協調器 (v1.2 新增)</span>

<span class="sd">    負責協調多個目標變數（如 system_total_kw, chiller_1_kw, chiller_2_kw...）的批次訓練，</span>
<span class="sd">    確保：</span>
<span class="sd">    1. 所有目標使用相同的 Annotation Context（版本一致性）</span>
<span class="sd">    2. 記憶體管理：限制同時訓練的目標數，防止 OOM</span>
<span class="sd">    3. 產出統一的 Model Registry Index（供 Optimization Engine 使用）</span>
<span class="sd">    4. 支援 Hybrid 模式的一致性檢查（Component Models 加總 ≈ System Model）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ModelTrainingConfig</span><span class="p">,</span> <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="n">site_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MultiModelArtifact</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_logs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_multiple_targets</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">TrainingInputContract</span><span class="p">,</span>
        <span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="s2">&quot;parallel_safe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sequential&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MultiModelArtifact</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        批次訓練多個目標變數</span>

<span class="sd">        Args:</span>
<span class="sd">            data: TrainingInputContract（包含 feature_matrix）</span>
<span class="sd">            targets: 目標變數名稱列表，如 [&quot;system_total_kw&quot;, &quot;chiller_1_kw&quot;, &quot;chiller_2_kw&quot;]</span>
<span class="sd">            strategy: </span>
<span class="sd">                - &quot;sequential&quot;: 依序訓練，最安全（預設）</span>
<span class="sd">                - &quot;parallel_safe&quot;: 有限度平行（受限於 ResourceConfig.max_concurrent_targets）</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[target_name, MultiModelArtifact]: 各目標的訓練產出物</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎯 開始批次訓練: site=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="si">}</span><span class="s2">, targets=</span><span class="si">{</span><span class="n">targets</span><span class="si">}</span><span class="s2">, strategy=</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 驗證所有 targets 存在於資料中</span>
        <span class="n">available_cols</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature_matrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">missing_targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_cols</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_targets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E902: 以下目標變數不存在於資料中: </span><span class="si">{</span><span class="n">missing_targets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 驗證 Annotation Context 一致性（所有 target 必須相同）</span>
        <span class="n">base_annotation</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;annotation_context&#39;</span><span class="p">]</span>

        <span class="c1"># 依序訓練</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 訓練目標: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># 更新 Input Contract 為單一目標</span>
                <span class="n">single_target_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">single_target_data</span><span class="p">[</span><span class="s1">&#39;target_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
                <span class="n">single_target_data</span><span class="p">[</span><span class="s1">&#39;training_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;single_target&#39;</span>

                <span class="c1"># 建立 Pipeline 並訓練</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TrainingPipeline</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">site_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
                    <span class="n">target_id</span><span class="o">=</span><span class="n">target</span>
                <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">artifact</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">single_target_data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">artifact</span>

                    <span class="c1"># 儲存</span>
                    <span class="n">saved_files</span> <span class="o">=</span> <span class="n">artifact</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_output_dir</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">training_logs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;best_model&#39;</span><span class="p">:</span> <span class="n">artifact</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">,</span>
                        <span class="s1">&#39;test_r2&#39;</span><span class="p">:</span> <span class="n">artifact</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">saved_files</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                    <span class="p">})</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 目標 </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> 訓練失敗: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">training_logs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="c1"># 依據設定決定是否繼續</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;continue_on_error&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                        <span class="k">raise</span>

        <span class="c1"># 產出 Model Registry Index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_registry_index</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

        <span class="c1"># Hybrid 模式一致性檢查</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">training_mode</span> <span class="o">==</span> <span class="s1">&#39;hybrid&#39;</span> <span class="ow">and</span> <span class="s1">&#39;system_total_kw&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_hybrid_consistency</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_registry_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        產生 Model Registry Index（Optimization Engine 的入口檔案）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;schema_version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;site_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
            <span class="s1">&#39;training_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;annotation_checksum&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">annotation_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;yaml_checksum&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s1">&#39;training_mode&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">training_mode</span><span class="p">,</span>
            <span class="s1">&#39;available_models&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;compatibility&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;optimization_engine_min_version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;feature_annotation_version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;python_version&#39;</span><span class="p">:</span> <span class="s1">&#39;3.10+&#39;</span><span class="p">,</span>
                <span class="s1">&#39;required_packages&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;xgboost&gt;=1.7&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgbm&gt;=4.0&#39;</span><span class="p">,</span> <span class="s1">&#39;scikit-learn&gt;=1.3&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">artifact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
            <span class="n">model_entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;system_level&#39;</span> <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;system_total_kw&#39;</span> <span class="k">else</span> <span class="s1">&#39;component_level&#39;</span><span class="p">,</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">artifact</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_ensemble_manifest.json&quot;</span><span class="p">,</span>
                <span class="s1">&#39;target_variable&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                <span class="s1">&#39;feature_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">feature_names</span><span class="p">),</span>
                <span class="s1">&#39;best_algorithm&#39;</span><span class="p">:</span> <span class="n">artifact</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">,</span>
                <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;val_r2&#39;</span><span class="p">:</span> <span class="n">artifact</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">artifact</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="s1">&#39;r2&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;test_r2&#39;</span><span class="p">:</span> <span class="n">artifact</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">artifact</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;mape&#39;</span><span class="p">:</span> <span class="n">artifact</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;mape&#39;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span>  <span class="c1"># 實際儲存時計算</span>
                <span class="s1">&#39;optional&#39;</span><span class="p">:</span> <span class="n">target</span> <span class="o">!=</span> <span class="s1">&#39;system_total_kw&#39;</span>  <span class="c1"># System Model 為必須，Component 為可選</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">training_mode</span> <span class="o">==</span> <span class="s1">&#39;hybrid&#39;</span><span class="p">:</span>
                <span class="n">model_entry</span><span class="p">[</span><span class="s1">&#39;parent_system_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;system_total_kw&#39;</span> <span class="k">if</span> <span class="n">target</span> <span class="o">!=</span> <span class="s1">&#39;system_total_kw&#39;</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">index_data</span><span class="p">[</span><span class="s1">&#39;available_models&#39;</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_entry</span>

        <span class="c1"># 儲存 Index</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">/</span> <span class="s1">&#39;model_registry_index.json&#39;</span>
        <span class="n">index_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📋 Model Registry Index 已產生: </span><span class="si">{</span><span class="n">index_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_hybrid_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        驗證 Hybrid 模式一致性：</span>
<span class="sd">        Component Models 的加總應與 System Model 預測相近</span>
<span class="sd">        （容差預設 5%）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;system_total_kw&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">system_artifact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">[</span><span class="s1">&#39;system_total_kw&#39;</span><span class="p">]</span>
        <span class="c1"># 取得 System Model 的驗證集預測（假設已儲存）</span>

        <span class="n">component_sum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">component_targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="s1">&#39;system_total_kw&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">component_targets</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># 簡化驗證：比較特徵重要性分佈（進階版可比較實際預測值）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;🔍 執行 Hybrid 模式一致性檢查...&quot;</span><span class="p">)</span>

        <span class="c1"># 這裡應載入驗證集資料進行實際預測比較</span>
        <span class="c1"># 簡化示例：</span>
        <span class="n">system_importance</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">system_artifact</span><span class="o">.</span><span class="n">trainers</span><span class="p">[</span><span class="n">system_artifact</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">comp_target</span> <span class="ow">in</span> <span class="n">component_targets</span><span class="p">:</span>
            <span class="n">comp_artifact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">[</span><span class="n">comp_target</span><span class="p">]</span>
            <span class="n">comp_importance</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">comp_artifact</span><span class="o">.</span><span class="n">trainers</span><span class="p">[</span><span class="n">comp_artifact</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># 檢查特徵重疊度</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_importance</span> <span class="o">&amp;</span> <span class="n">comp_importance</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_importance</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">overlap</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;⚠️ </span><span class="si">{</span><span class="n">comp_target</span><span class="si">}</span><span class="s2"> 與 System Model 特徵重疊度僅 </span><span class="si">{</span><span class="n">overlap</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">，&quot;</span>
                    <span class="s2">&quot;可能導致一致性問題&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ Hybrid 一致性檢查完成&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_registry_index_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;取得 Model Registry Index 路徑（供 Optimization Engine 使用）&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">/</span> <span class="s1">&#39;model_registry_index.json&#39;</span>
</code></pre></div>

<hr />
<h2 id="4-error-codes-v12">4. 錯誤代碼對照表 (Error Codes) - v1.2 更新</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">錯誤代碼</th>
<th style="text-align: left;">名稱</th>
<th style="text-align: center;">發生階段</th>
<th style="text-align: left;">說明</th>
<th style="text-align: left;">處理建議</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>E601</strong></td>
<td style="text-align: left;"><code>ANNOTATION_CONTEXT_MISSING</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">缺少 annotation_context</td>
<td style="text-align: left;">確認 Feature Engineer v1.3+</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E602</strong></td>
<td style="text-align: left;"><code>SCHEMA_VERSION_MISMATCH</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">Annotation 版本不符</td>
<td style="text-align: left;">重新訓練或降級 Annotation</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E603</strong></td>
<td style="text-align: left;"><code>TARGET_VARIABLE_MISSING</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">目標變數不存在</td>
<td style="text-align: left;">檢查特徵工程輸出</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E604</strong></td>
<td style="text-align: left;"><code>TIMESTAMP_INVALID</code></td>
<td style="text-align: center;">Step 1.1</td>
<td style="text-align: left;">時間戳格式錯誤</td>
<td style="text-align: left;">檢查 Feature Engineer</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E607</strong></td>
<td style="text-align: left;"><code>INSUFFICIENT_SAMPLES</code></td>
<td style="text-align: center;">Step 3</td>
<td style="text-align: left;">樣本不足（&lt;100）</td>
<td style="text-align: left;">檢查資料遮罩邏輯</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E701</strong></td>
<td style="text-align: left;"><code>DEVICE_ROLE_AS_FEATURE</code></td>
<td style="text-align: center;">Step 0.1</td>
<td style="text-align: left;">設定錯誤嘗試將 device_role 作為特徵</td>
<td style="text-align: left;">修改設定</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E702</strong></td>
<td style="text-align: left;"><code>MODEL_NOT_FITTED</code></td>
<td style="text-align: center;">Prediction</td>
<td style="text-align: left;">預測前未訓練</td>
<td style="text-align: left;">確保已執行 train()</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E703</strong></td>
<td style="text-align: left;"><code>ALL_MODELS_FAILED</code></td>
<td style="text-align: center;">Step 5</td>
<td style="text-align: left;">三模型全部訓練失敗</td>
<td style="text-align: left;">檢查資料品質或特徵工程</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E704</strong></td>
<td style="text-align: left;"><code>XGBOOST_IMPORT_ERROR</code></td>
<td style="text-align: center;">Import</td>
<td style="text-align: left;">XGBoost 未安裝</td>
<td style="text-align: left;"><code>pip install xgboost</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>E705</strong></td>
<td style="text-align: left;"><code>LIGHTGBM_IMPORT_ERROR</code></td>
<td style="text-align: center;">Import</td>
<td style="text-align: left;">LightGBM 未安裝</td>
<td style="text-align: left;"><code>pip install lightgbm</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>E706</strong></td>
<td style="text-align: left;"><code>SELECTION_NOT_EXECUTED</code></td>
<td style="text-align: center;">Step 6</td>
<td style="text-align: left;">尚未執行模型選擇</td>
<td style="text-align: left;">先執行 train_all_models()</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E707</strong></td>
<td style="text-align: left;"><code>ENSEMBLE_NO_VALID_MODEL</code></td>
<td style="text-align: center;">Ensemble</td>
<td style="text-align: left;">無可用模型進行 Ensemble</td>
<td style="text-align: left;">檢查訓練結果</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E801</strong></td>
<td style="text-align: left;"><code>MEMORY_SAFETY_TRIGGERED</code></td>
<td style="text-align: center;">Step 5</td>
<td style="text-align: left;">記憶體不足自動降級為序列訓練</td>
<td style="text-align: left;">正常行為，或增加記憶體</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E802</strong></td>
<td style="text-align: left;"><code>OPTUNA_PRUNING_EXCESSIVE</code></td>
<td style="text-align: center;">Hyperparam</td>
<td style="text-align: left;">過多 trials 被剪枝</td>
<td style="text-align: left;">提示搜尋空間可能過大</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E803</strong></td>
<td style="text-align: left;"><code>SHAP_BACKGROUND_TOO_LARGE</code></td>
<td style="text-align: center;">Explain</td>
<td style="text-align: left;">SHAP 背景資料過大</td>
<td style="text-align: left;">已自動取樣，可忽略</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E804</strong></td>
<td style="text-align: left;"><code>EXPLAINER_NOT_FITTED</code></td>
<td style="text-align: center;">Explain</td>
<td style="text-align: left;">未先執行 fit_background</td>
<td style="text-align: left;">先呼叫 fit_background()</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E805</strong></td>
<td style="text-align: left;"><code>SHAP_NOT_INSTALLED</code></td>
<td style="text-align: center;">Import</td>
<td style="text-align: left;">未安裝 shap 套件</td>
<td style="text-align: left;"><code>pip install shap</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>E901</strong></td>
<td style="text-align: left;"><code>MULTI_TARGET_ANNOTATION_MISMATCH</code></td>
<td style="text-align: center;">Phase 5</td>
<td style="text-align: left;">多目標訓練時 Annotation Context 不一致</td>
<td style="text-align: left;">確保所有 targets 使用相同 Feature Annotation</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E902</strong></td>
<td style="text-align: left;"><code>TARGET_VARIABLE_NOT_FOUND</code></td>
<td style="text-align: center;">Phase 5</td>
<td style="text-align: left;">指定的 target 不存在於資料集中</td>
<td style="text-align: left;">檢查 target 名稱是否正確</td>
</tr>
<tr>
<td style="text-align: left;"><strong>E903</strong></td>
<td style="text-align: left;"><code>HYBRID_CONSISTENCY_VIOLATION</code></td>
<td style="text-align: center;">Phase 5</td>
<td style="text-align: left;">Hybrid 模式下 Component 加總與 System 預測差異過大</td>
<td style="text-align: left;">檢查特徵工程或改用純 System-Level</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-optimization-engine-v12">5. 與 Optimization Engine 的介面契約 (v1.2 新增章節)</h2>
<h3 id="51">5.1 模型載入規範</h3>
<p>Optimization Engine v1.0+ 應透過以下方式載入模型：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Optimization Engine 載入範例（供參考）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OptimizationModelLoader</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        從 Model Registry Index 載入模型</span>
<span class="sd">        若 target 為 None，預設載入 &#39;system_total_kw&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;models/</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">/model_registry_index.json&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># 驗證相容性</span>
        <span class="k">if</span> <span class="n">index</span><span class="p">[</span><span class="s1">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;1.2&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model Registry 版本 </span><span class="si">{</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;schema_version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 與預期 1.2 不同&quot;</span><span class="p">)</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span> <span class="ow">or</span> <span class="s1">&#39;system_total_kw&#39;</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index</span><span class="p">[</span><span class="s1">&#39;available_models&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;目標 </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> 不可用，可用目標: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;available_models&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">model_entry</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="s1">&#39;available_models&#39;</span><span class="p">][</span><span class="n">target</span><span class="p">]</span>

        <span class="c1"># 驗證 Annotation Checksum（確保與當前 Feature Annotation 相容）</span>
        <span class="n">current_checksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_annotation_checksum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;annotation_checksum&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">current_checksum</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;E802: 模型訓練時的 Annotation 版本與當前不同&quot;</span><span class="p">)</span>

        <span class="c1"># 載入模型</span>
        <span class="n">manifest_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;models/</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_entry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">MultiModelArtifact</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">)</span>
</code></pre></div>

<h3 id="52">5.2 版本相容性矩陣</h3>
<table>
<thead>
<tr>
<th style="text-align: center;">Training PRD</th>
<th style="text-align: center;">Optimization PRD</th>
<th style="text-align: center;">相容性</th>
<th style="text-align: left;">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">v1.2</td>
<td style="text-align: center;">v1.0+</td>
<td style="text-align: center;">✅ <strong>完全相容</strong></td>
<td style="text-align: left;">推薦配置，支援多目標與 Model Registry Index</td>
</tr>
<tr>
<td style="text-align: center;">v1.1</td>
<td style="text-align: center;">v1.0+</td>
<td style="text-align: center;">⚠️ <strong>部分相容</strong></td>
<td style="text-align: left;">需手動指定模型路徑，無 Registry Index</td>
</tr>
<tr>
<td style="text-align: center;">v1.0</td>
<td style="text-align: center;">v1.0+</td>
<td style="text-align: center;">❌ <strong>不相容</strong></td>
<td style="text-align: left;">輸出格式不同</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-test-plan-v12">6. 測試與驗證計畫 (Test Plan) - v1.2 更新</h2>
<h3 id="61-v11">6.1 單元測試（v1.1 內容保留）</h3>
<h3 id="62-v12">6.2 整合測試（v1.2 新增多目標測試）</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">測試案例 ID</th>
<th style="text-align: left;">描述</th>
<th style="text-align: left;">驗證目標</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">INT-MT-008</td>
<td style="text-align: left;">批次訓練協調器</td>
<td style="text-align: left;">BatchTrainingCoordinator 正確依序訓練 3 個 targets</td>
</tr>
<tr>
<td style="text-align: left;">INT-MT-009</td>
<td style="text-align: left;">Model Registry Index 產出</td>
<td style="text-align: left;">驗證 index.json 格式正確，Optimization Engine 可解析</td>
</tr>
<tr>
<td style="text-align: left;">INT-MT-010</td>
<td style="text-align: left;">Hybrid 一致性檢查</td>
<td style="text-align: left;">Component Models 加總與 System Model 差異 &lt; 5%</td>
</tr>
<tr>
<td style="text-align: left;">INT-MT-011</td>
<td style="text-align: left;">記憶體限制批次訓練</td>
<td style="text-align: left;">限制記憶體下，協調器自動降為單目標序列訓練</td>
</tr>
<tr>
<td style="text-align: left;">INT-MT-012</td>
<td style="text-align: left;">與 Optimization Engine E2E</td>
<td style="text-align: left;">Training 產出 → Optimization 載入 → 預測驗證</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-sign-off-checklist-v12">7. 驗收簽核 (Sign-off Checklist) - v1.2 更新</h2>
<ul>
<li>[ ] <strong>三模型實作</strong>: XGBoost、LightGBM、Random Forest 皆可獨立訓練</li>
<li>[ ] <strong>動態資格檢查</strong>: 樣本數 300 時僅啟用 RF 與 XGB（限制深度）</li>
<li>[ ] <strong>記憶體保護</strong>: 在 4GB 限制下自動降級為序列訓練，無 OOM</li>
<li>[ ] <strong>樣本權重</strong>: 三模型皆正確處理 Device Role 權重（Backup=0.3）</li>
<li>[ ] <strong>特徵重要性</strong>: 每個模型輸出標準化重要性（總和為1）</li>
<li>[ ] <strong>RF 區間預測</strong>: Random Forest 支援 <code>predict_with_interval()</code> 輸出 Q10/Q90</li>
<li>[ ] <strong>自動模型選擇</strong>: 依 Val R² 與 OOB 差距綜合評分選擇最佳模型</li>
<li>[ ] <strong>錯誤隔離</strong>: 單一模型失敗不影響其他模型訓練與最終產出</li>
<li>[ ] <strong>版本綁定</strong>: 儲存的 Manifest 包含 Annotation yaml_checksum</li>
<li>[ ] <strong>夜間優化器</strong>: OvernightOptimizer 支援斷點續傳與 Trial Pruning</li>
<li>[ ] <strong>可解釋性預留</strong>: MultiModelArtifact 支援 <code>predict_with_explanation()</code>（若啟用 SHAP）</li>
<li>[ ] <strong>增量學習預留</strong>: BaseModelTrainer 包含 <code>partial_fit()</code> 介面（RF 已實作）</li>
<li>[ ] <strong>v1.2 新增</strong>: BatchTrainingCoordinator 支援多目標批次訓練</li>
<li>[ ] <strong>v1.2 新增</strong>: Model Registry Index 自動產生，格式符合 Optimization Engine 規範</li>
<li>[ ] <strong>v1.2 新增</strong>: System/Component/Hybrid 三種模式皆可正常運作</li>
</ul>
<hr />
<h2 id="8">8. 附錄</h2>
<h3 id="appendix-a-v11">Appendix A: 資源管理決策流程圖（v1.1 內容保留）</h3>
<h3 id="appendix-b-v11">Appendix B: 超參數搜尋使用指南（v1.1 內容保留）</h3>
<h3 id="appendix-c-model-registry-index-v12">Appendix C: Model Registry Index 範例（v1.2 新增）</h3>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;schema_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;site_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cgmh_ty&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;training_timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-02-13T10:00:00Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;annotation_checksum&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256:abc123...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;training_mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;hybrid&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;available_models&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;system_total_kw&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system_level&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system_total_kw/20260213_100000_ensemble_manifest.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;target_variable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system_total_kw&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;feature_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;best_algorithm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xgboost&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;metrics&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;val_r2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.92</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;test_r2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.89</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;rmse&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">15.3</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;mape&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3.2</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;checksum&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256:def456...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;optional&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;chiller_1_kw&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;component_level&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;chiller_1_kw/20260213_100500_ensemble_manifest.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;target_variable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;chiller_1_kw&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;feature_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;best_algorithm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lightgbm&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;metrics&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;val_r2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.88</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;test_r2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.85</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;rmse&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">8.5</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;mape&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">4.1</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;checksum&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256:ghi789...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;optional&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;parent_system_model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system_total_kw&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;compatibility&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;optimization_engine_min_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;feature_annotation_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;python_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3.10+&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;required_packages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;xgboost&gt;=1.7&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lightgbm&gt;=4.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;scikit-learn&gt;=1.3&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<p><strong>關鍵設計確認 (v1.2)</strong>:
1. <strong>雙模式架構</strong>: 明確區分 System-Level（優化用）與 Component-Level（診斷用），Hybrid 模式提供一致性檢查
2. <strong>批次協調</strong>: BatchTrainingCoordinator 統一管理多目標訓練，確保版本一致性與記憶體安全
3. <strong>標準化介面</strong>: Model Registry Index 作為 Training 與 Optimization 的單一真相來源（Single Source of Truth）
4. <strong>向下相容</strong>: 保留所有 v1.1 功能（ResourceManager、SHAP、OvernightOptimizer），僅增加銜接層
5. <strong>容錯設計</strong>: Component Models 標記為 optional，即使訓練失敗也不影響 System Model 使用</p>
    
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>

</body>
</html>
