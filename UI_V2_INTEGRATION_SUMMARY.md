# Feature Mapping V2/V3 UI 整合說明

## 整合內容

已將 Feature Mapping 完整整合至 `etl_ui.py`，採用全新的模式化結構。

---

## 新 UI 結構

### 三大處理模式

```
┌─────────────────────────────────────────────────────────────┐
│  側邊欄：處理模式選擇                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ○ 單一檔案                                                  │
│    └── 解析、清洗、統計單一 CSV 檔案                          │
│                                                             │
│  ○ 批次處理（整個資料夾）                                      │
│    └── 處理多個檔案、資料合併、基礎清洗                        │
│                                                             │
│  ⚡ 最佳化模擬  ← 特徵映射所在位置                            │
│    ├── 🗺️ 特徵映射  (第一分頁)                               │
│    ├── 🎯 即時最佳化                                         │
│    ├── 📊 特徵重要性                                         │
│    ├── 📈 歷史追蹤                                           │
│    └── 🔧 模型訓練                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 特徵映射頁面詳情

### 🗺️ 特徵映射配置分頁

位於「⚡ 最佳化模擬」模式的第一個分頁：

```
┌─────────────────────────────────────────────────────────────┐
│ 🗺️ 特徵映射配置                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 📊 可用資料: 12,345 筆，42 個欄位                             │
│                                                             │
│ #### 🤖 自動識別模式                                         │
│ [🤖 執行自動識別] ← 點擊自動分析欄位                          │
│                                                             │
│ ---                                                         │
│ #### 📋 當前映射配置                                         │
│                                                             │
│ ┌───────────┐ ┌───────────┐ ┌───────────┐                  │
│ │ 總特徵數   │ │  類別數    │ │ 目標變數   │                  │
│ │    26     │ │     8     │ │ TOTAL_KW  │                  │
│ └───────────┘ └───────────┘ └───────────┘                  │
│                                                             │
│ ▶ ❄️ 冰水側系統 (4 類別)       ← 展開查看詳情                │
│ ▶ 🔥 冷卻水側系統 (4 類別)                                   │
│ ▶ 🏭 冷卻水塔系統 (1 類別)                                   │
│ ▶ 🌍 環境參數 (1 類別)                                       │
│ ▶ ⚡ 系統層級 (1 類別)                                       │
│                                                             │
│ ✅ 所有映射欄位都存在於資料中                                  │
│                                                             │
│ [📥 匯出 JSON]                                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 三種配置方式

#### 1. 🤖 自動識別 (Auto-detect)

點擊後系統自動分析欄位名稱，識別 10+ 種類別：

| 類別 | 圖示 | 說明 | 識別模式 |
|-----|------|------|---------|
| 負載 | 🏭 | 冷凍機負載 (RT) | RT |
| 冷凍泵 | 💧 | 冷凍水幫浦頻率 (Hz) | CHP + VFD |
| 冷卻泵 | 🌊 | 冷卻水幫浦頻率 (Hz) | CWP + VFD |
| 冷卻塔 | 🌀 | 冷卻塔風扇頻率 (Hz) | CT_ + VFD |
| 溫度 | 🌡️ | 水系統溫度 (°C) | SWT/RWT/TEMP |
| 壓力 | 📊 | 水系統壓力 (kPa) | PRESSURE/PSI/KPA |
| 流量 | 🌊 | 水流量 (LPM/GPM) | FLOW/LPM/GPM |
| 環境 | 🌍 | 外氣參數 (°C/%) | OAT/OAH/WBT |
| 耗電 | ⚡ | 設備耗電 (kW) | POWER/KW |
| 狀態 | 🔘 | 運轉狀態 | STATUS/RUN/ON/OFF |

#### 2. ✏️ 手動對應 (Manual Mapping)

展開各系統分類，手動選擇欄位對應：
- ❄️ 冰水側系統：冰水機、冰水泵、區域泵、溫度、壓力、流量
- 🔥 冷卻水側系統：冷卻水泵、溫度、壓力、流量
- 🏭 冷卻水塔系統
- 🌍 環境參數
- ⚡ 系統層級

#### 3. 🌟 萬用字元模式 (Wildcard Mode)

使用 `*` 和 `?` 進行批量欄位匹配：

| 符號 | 說明 | 範例 |
|-----|------|------|
| `*` | 匹配任意字元序列 | `CH_*_RT` 匹配 `CH_0_RT`, `CH_1_RT` |
| `?` | 匹配單一任意字元 | `CH?_RT` 匹配 `CH0_RT`, `CH1_RT` |
| `,` | 分隔多個模式 | `CH_*_RT, CH_*_KW` |

**預設規則範例：**
- `CH_*_RT, CH_*_KW` - 匹配所有冰水機
- `CHP_*_VFD_OUT` - 匹配所有冰水泵
- `CT_*_VFD_OUT` - 匹配所有冷卻水塔

---

## 使用流程

### 標準工作流程

```
Step 1: 載入資料
   ├── 選擇「批次處理」或「單一檔案」模式
   ├── 選擇或上傳 CSV 檔案
   └── 執行資料處理

Step 2: 配置特徵映射
   ├── 切換到「⚡ 最佳化模擬」模式
   ├── 進入「🗺️ 特徵映射」分頁
   ├── 點擊「🤖 執行自動識別」
   └── 確認映射結果正確

Step 3: 訓練模型
   ├── 進入「🔧 模型訓練」分頁
   ├── 輸入模型名稱
   └── 點擊「開始訓練」

Step 4: 執行最佳化
   ├── 進入「🎯 即時最佳化」分頁
   ├── 設定運轉條件
   └── 點擊「執行最佳化」
```

### 工作流程圖

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  載入資料     │ ──► │  特徵映射     │ ──► │  訓練模型     │
│  (批次處理)   │     │  (最佳化模式) │     │  (最佳化模式) │
└──────────────┘     └──────────────┘     └──────────────┘
                                                  │
                                                  ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  套用設定     │ ◄── │  即時最佳化   │ ◄── │  選擇模型     │
│  (現場使用)   │     │  (最佳化模式) │     │               │
└──────────────┘     └──────────────┘     └──────────────┘
```

---

## 檔案變更

| 檔案 | 變更內容 |
|------|---------|
| `src/config/feature_mapping.py` | V3 版本，支援物理系統分組 |
| `src/config/feature_mapping_v2.py` | V2 版本保留（向後兼容） |
| `etl_ui.py` | 大幅更新，整合特徵映射至最佳化模式 |

---

## 向後兼容性

✅ **舊的映射檔案仍然可以使用**：
- V1 格式的 JSON 配置檔案仍可載入
- `PREDEFINED_MAPPINGS["default"]` 仍然可用
- 所有舊的欄位類別（load_cols, chw_pump_hz_cols 等）仍受支援

---

## 測試驗證

啟動 UI 測試：
```bash
streamlit run etl_ui.py
```

測試步驟：
1. 選擇「批次處理（整個資料夾）」載入資料
2. 切換到「⚡ 最佳化模擬」模式
3. 查看「🗺️ 特徵映射配置」分頁
4. 點擊「自動識別」測試新功能
5. 確認可以看到按物理系統分組的類別
6. 進入「🔧 模型訓練」測試訓練流程

---

## 故障排除

### 問題：特徵映射分頁顯示「尚無可用資料」

**解決**：
1. 確認已先執行「批次處理」或「單一檔案」載入資料
2. 檢查資料是否成功載入（應顯示筆數和欄位數）

### 問題：自動識別沒有抓到某些欄位

**解決**：
1. 檢查欄位名稱是否包含標準關鍵字
2. 檢查 CSV 檔案確實包含這些欄位
3. 考慮手動建立 JSON 配置

---

## 下一步建議

1. **測試完整流程**
   - 從資料載入到最佳化的完整流程
   - 驗證每個分頁的功能正常

2. **驗證特徵重要性**
   - 訓練後查看「📊 特徵重要性」分頁
   - 確認環境參數出現在排名中

3. **收集回饋**
   - 根據實際使用調整界面文案
   - 優化自動識別的欄位模式

---

**文件版本**: V2.1  
**更新日期**: 2026-02-10  
**更新說明**: 更新 UI 結構，特徵映射已整合至「⚡ 最佳化模擬」模式
