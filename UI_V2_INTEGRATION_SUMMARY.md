# Feature Mapping V2 UI 整合完成說明

## 整合內容

已將 Feature Mapping V2 完整整合至 `etl_ui.py`，現在 UI 支援 **10+ 種標準類別** 和 **無限自定義類別**。

---

## 新功能總覽

### 1. 自動識別增強

點擊「🤖 執行自動識別」後，系統會自動識別：

| 類別 | 圖示 | 說明 | 識別模式 |
|-----|------|------|---------|
| 負載 | 🏭 | 冷凍機負載 (RT) | RT |
| 冷凍泵 | 💧 | 冷凍水幫浦頻率 (Hz) | CHP + VFD |
| 冷卻泵 | 🌊 | 冷卻水幫浦頻率 (Hz) | CWP + VFD |
| 冷卻塔 | 🌀 | 冷卻塔風扇頻率 (Hz) | CT_ + VFD |
| 溫度 | 🌡️ | 水系統溫度 (°C) | SWT/RWT/TEMP |
| 環境 | 🌍 | 外氣參數 (°C/%) | OAT/OAH/WBT |
| **壓力** | 📊 | **水系統壓力 (kPa)** | **PRESSURE/PSI/KPA** |
| **流量** | 🌊 | **水流量 (LPM/GPM)** | **FLOW/LPM/GPM** |
| **耗電** | ⚡ | **設備耗電 (kW)** | **POWER/KW** |
| **狀態** | 🔘 | **運轉狀態** | **STATUS/RUN/ON/OFF** |

### 2. 手動對應界面 (3欄布局)

```
🏭 負載 (Load)        🌀 冷卻塔 (CT)        🌡️ 溫度 (Temp)
[多選下拉框 ▼]        [多選下拉框 ▼]        [多選下拉框 ▼]

💧 冷凍泵 (CHW)       🌍 環境 (Env)         📊 壓力 (Pressure)
[多選下拉框 ▼]        [多選下拉框 ▼]        [多選下拉框 ▼]

🌊 冷卻泵 (CW)        🌊 流量 (Flow)        ⚡ 耗電 (Power)
[多選下拉框 ▼]        [多選下拉框 ▼]        [多選下拉框 ▼]

🔘 狀態 (Status)
[多選下拉框 ▼]
```

### 3. 自定義類別功能

點擊「➕ 新增自定義類別」可展開：

```
類別代碼 (英文): [valve]
類別名稱: [閥門開度]
圖示: [📦 ▼]
單位: [%]
選擇欄位: [多選下拉框 ▼]

[新增自定義類別]
```

---

## 使用流程

### 自動識別模式 (推薦)

1. 批次處理完成後，展開「🗺️ 特徵映射配置」
2. 選擇「自動識別 (Auto-detect)」
3. 點擊「🤖 執行自動識別」
4. 系統自動識別所有 10+ 類別
5. 展開「📋 查看/編輯當前映射」確認結果
6. 點擊「📥 匯出 JSON」儲存配置

### 手動對應模式

1. 選擇「手動對應 (Manual Mapping)」
2. 在每個類別的下拉框中選擇欄位
3. (選項) 點擊「➕ 新增自定義類別」添加特殊類別
4. 選擇「🎯 目標變數」
5. 點擊「💾 儲存手動配置」

---

## 檔案變更

| 檔案 | 變更內容 |
|------|---------|
| `src/config/feature_mapping.py` | 升級為 V2 (備份: feature_mapping_v1_backup.py) |
| `etl_ui.py` | 更新批次處理後的特徵映射界面 |

---

## 向後兼容性

✅ **V1 的程式碼仍然可以使用**：
- `FeatureMapping(load_cols=[...], ...)` 仍然有效
- `PREDEFINED_MAPPINGS["default"]` 仍然可用
- 所有舊的 JSON 配置檔案仍可載入

---

## 測試驗證

啟動 UI 測試：
```bash
streamlit run etl_ui.py
```

1. 選擇「批次處理（整個資料夾）」
2. 執行批次處理
3. 查看「🗺️ 特徵映射配置」區塊
4. 確認可以看到 10 個類別的選項
5. 點擊「自動識別」測試新功能

---

## 常見自定義類別範例

| 類別 ID | 名稱 | 圖示 | 單位 | 適用情境 |
|---------|------|------|------|---------|
| valve | 閥門開度 | 🔧 | % | 有控制閥門 |
| damper | 風門開度 | 🌬️ | % | 空調箱系統 |
| level | 水位 | 💧 | % | 冷卻水塔水槽 |
| vibration | 振動 | 📳 | mm/s | 設備監測 |

---

## 故障排除

### 問題：舊的映射檔案無法載入？
**解決**：V2 完全向後兼容，舊檔案應該可以正常載入。

### 問題：新類別沒有出現在手動對應中？
**解決**：確認 `src/config/feature_mapping.py` 已更新為 V2 版本。

### 問題：自動識別沒有抓到壓力/流量欄位？
**解決**：檢查欄位名稱是否包含 PRESSURE/FLOW 等關鍵字。

---

## 下一步建議

1. **測試自動識別**：使用真實資料測試新的自動識別功能
2. **驗證自定義類別**：嘗試新增一個自定義類別
3. **更新文件**：根據實際使用回饋更新操作手冊
