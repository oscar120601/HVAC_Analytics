# Feature Mapping V3 使用說明

## 啟動方式

```powershell
streamlit run etl_ui.py
```

---

## UI 介面位置

### ⚡ 最佳化模擬模式 > 🗺️ 特徵映射

特徵映射配置已整合至「⚡ 最佳化模擬」模式下，作為第一個分頁：

```
┌─────────────────────────────────────────────────────────────┐
│  ⚡ 最佳化模擬                                                │
│                                                             │
│  [🗺️ 特徵映射] [🎯 即時最佳化] [📊 特徵重要性] [📈 歷史追蹤] [🔧 模型訓練] │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 🗺️ 特徵映射配置                                        │  │
│  │                                                       │  │
│  │  🤖 執行自動識別                                       │  │
│  │                                                       │  │
│  │  📋 當前映射配置 (展開查看詳情)                         │  │
│  │   ❄️ 冰水側系統 (N 類別)                                │  │
│  │   🔥 冷卻水側系統 (N 類別)                              │  │
│  │   🏭 冷卻水塔系統                                       │  │
│  │   🌍 環境參數                                          │  │
│  │   ⚡🎯 系統層級 (Target)                                │  │
│  │                                                       │  │
│  │  📥 匯出 JSON                                          │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 使用流程

### 第一步：載入資料

在使用特徵映射前，請先確保資料已載入：

**方式 A：批次處理模式（推薦）**
1. 切換到「📦 批次處理（整個資料夾）」模式
2. 選擇檔案並執行批次處理
3. 處理完成後，切換到「⚡ 最佳化模擬」模式

**方式 B：單一檔案**
1. 切換到「📄 單一檔案」模式
2. 上傳或選擇 CSV 檔案
3. 切換到「⚡ 最佳化模擬」模式

### 第二步：選擇配置方式

1. 進入「⚡ 最佳化模擬」模式
2. 點擊第一個分頁「🗺️ 特徵映射」
3. 選擇以下三種方式之一：
   - **🤖 自動識別**：自動分析欄位名稱並分類
   - **✏️ 手動對應**：手動選擇每個類別的欄位
   - **🌟 萬用字元模式**：使用 `*` 和 `?` 進行批量匹配

### 第三步：確認映射結果

展開「📋 當前映射配置」查看識別結果：

```
📋 當前映射配置
═══════════════════════════════════════════════════════════════
總特徵數: 26 | 類別數: 8 | 目標變數: CH_SYS_TOTAL_KW

❄️ 冰水側系統:
• chiller (冰水機): 4 欄位
• chw_pump (冰水泵): 5 欄位
• chw_temp (冰水溫度): 4 欄位
...

🔥 冷卻水側系統:
• cw_pump (冷卻水泵): 5 欄位
...

🌍 環境參數:
• environment: 3 欄位
  CT_SYS_OAT, CT_SYS_OAH, CT_SYS_WBT
```

### 第四步：匯出配置（可選）

如需儲存映射配置：
1. 點擊「📥 匯出 JSON」
2. 下載 `feature_mapping.json` 檔案
3. 可用於後續重複使用

---

## 特徵映射配置頁面詳情

### 🗺️ 特徵映射配置分頁結構

```
┌─────────────────────────────────────────────────────────────┐
│ 🗺️ 特徵映射配置                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 📊 可用資料: X,XXX 筆，XX 個欄位                              │
│                                                             │
│ #### 🎛️ 選擇配置方式                                         │
│ [🤖 自動識別] [✏️ 手動對應] [🌟 萬用字元模式]                   │
│                                                             │
│ ---                                                         │
│ #### 📋 當前映射配置 (識別後展開查看)                          │
│                                                             │
│ ┌───────────┐ ┌───────────┐ ┌───────────┐                  │
│ │ 總特徵數   │ │  類別數    │ │ 目標變數   │                  │
│ │    26     │ │     8     │ │ TOTAL_KW  │                  │
│ └───────────┘ └───────────┘ └───────────┘                  │
│                                                             │
│ ▶ ❄️ 冰水側系統 (N 類別)                                     │
│ ▶ 🔥 冷卻水側系統 (N 類別)                                   │
│ ▶ 🏭 冷卻水塔系統                                            │
│ ▶ 🌍 環境參數                                               │
│ ▶ ⚡ 系統層級                                                │
│                                                             │
│ ✅ 所有映射欄位都存在於資料中                                  │
│                                                             │
│ [📥 匯出 JSON]                                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 按物理系統分組的顯示

V3 的 UI 會按照 HVAC 物理系統分組顯示：

```
❄️ 冰水側系統 (Chilled Water Side)
═══════════════════════════════════════════════════════════════
• chiller (冰水機): 4 欄位
  CH_0_RT, CH_1_RT, CH_2_RT, CH_3_RT
• chw_pump (冰水泵): 4 欄位
  CHP_01_VFD_OUT, CHP_02_VFD_OUT, ...
• scp_pump (區域泵): 2 欄位
  SCP_01_VFD_OUT, SCP_02_VFD_OUT
• chw_temp (冰水溫度): 4 欄位
  CH_0_SWT, CH_0_RWT, CH_1_SWT, CH_1_RWT
• chw_pressure (冰水壓力): 2 欄位
  CHW_SUPPLY_PRESSURE, CHW_RETURN_PRESSURE
• chw_flow (冰水流量): 1 欄位
  CHW_FLOW

🔥 冷卻水側系統 (Condenser Water Side)
═══════════════════════════════════════════════════════════════
• cw_pump (冷卻水泵): 4 欄位
  CWP_01_VFD_OUT, CWP_02_VFD_OUT, ...
• cw_temp (冷卻水溫度): 2 欄位
  CW_SYS_SWT, CW_SYS_RWT
• cw_pressure (冷卻水壓力): 2 欄位
  CW_SUPPLY_PRESSURE, CW_RETURN_PRESSURE
• cw_flow (冷卻水流量): 1 欄位
  CW_FLOW

🏭 冷卻水塔系統 (Cooling Tower)
═══════════════════════════════════════════════════════════════
• cooling_tower: 4 欄位
  CT_01_VFD_OUT, CT_02_VFD_OUT, CT_01_KW, CT_02_KW

🌍 環境參數 (Environment)
═══════════════════════════════════════════════════════════════
• environment: 3 欄位
  CT_SYS_OAT, CT_SYS_OAH, CT_SYS_WBT

⚡🎯 系統層級 (System Level)
═══════════════════════════════════════════════════════════════
• system_level (Target): 1 欄位
  CH_SYS_TOTAL_KW
```

---

## 與模型訓練的整合

設定好 Feature Mapping 後，在同一個模式的「🔧 模型訓練」分頁中：

```
🔧 模型訓練與管理
━━━━━━━━━━━━━━━━━━━━
📋 訓練前診斷:
- 資料形狀: (XXXX, XX)
- 目標欄位 (CH_SYS_TOTAL_KW): XXXX/XXXX 有效
✅ 所有 XX 個必要欄位都存在

🎓 開始訓練
[模型名稱輸入框] [開始訓練]
```

系統會自動使用特徵映射配置進行訓練！

---

## 完整工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                    標準工作流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1️⃣  載入資料                                               │
│       └── 選擇「批次處理」或「單一檔案」模式                   │
│       └── 執行資料處理                                       │
│                                                             │
│  2️⃣  特徵映射配置                                           │
│       └── 切換到「⚡ 最佳化模擬」模式                         │
│       └── 進入「🗺️ 特徵映射」分頁                            │
│       └── 點擊「🤖 執行自動識別」                            │
│       └── 確認映射結果                                       │
│                                                             │
│  3️⃣  訓練模型                                               │
│       └── 進入「🔧 模型訓練」分頁                            │
│       └── 輸入模型名稱並開始訓練                              │
│                                                             │
│  4️⃣  最佳化模擬                                             │
│       └── 進入「🎯 即時最佳化」分頁                          │
│       └── 調整參數並執行最佳化                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## JSON 配置格式（進階）

如需手動編輯映射配置，JSON 格式如下：

```json
{
  "version": "3.0",
  "chilled_water_side": {
    "chiller": ["CH_0_RT", "CH_1_RT"],
    "chw_pump": ["CHP_01_VFD_OUT", "CHP_02_VFD_OUT"],
    "scp_pump": ["SCP_01_VFD_OUT"],
    "chw_temp": ["CH_0_SWT", "CH_0_RWT"],
    "chw_pressure": ["CHW_S_PRESSURE", "CHW_R_PRESSURE"],
    "chw_flow": ["CHW_FLOW"]
  },
  "condenser_water_side": {
    "cw_pump": ["CWP_01_VFD_OUT", "CWP_02_VFD_OUT"],
    "cw_temp": ["CW_SYS_SWT", "CW_SYS_RWT"],
    "cw_pressure": ["CW_S_PRESSURE", "CW_R_PRESSURE"],
    "cw_flow": ["CW_FLOW"]
  },
  "cooling_tower": {
    "cooling_tower": ["CT_01_VFD_OUT", "CT_02_VFD_OUT"]
  },
  "environment": {
    "environment": ["CT_SYS_OAT", "CT_SYS_OAH", "CT_SYS_WBT"]
  },
  "system_level": {
    "system_level": ["CH_SYS_TOTAL_KW"]
  }
}
```

---

## 故障排除

### 問題：「🗺️ 特徵映射」分頁顯示「尚無可用資料」

**解決方法：**
1. 確認已先執行「批次處理」或「單一檔案」載入資料
2. 檢查資料是否成功載入（應顯示筆數和欄位數）
3. 重新整理頁面後再試

### 問題：自動識別後缺少某些類別

**解決方法：**
1. 檢查欄位名稱是否符合識別模式
2. 確認 CSV 檔案確實包含這些欄位
3. 考慮手動建立 JSON 配置並匯入

### 問題：訓練時出現「缺少必要欄位」錯誤

**解決方法：**
1. 回到「🗺️ 特徵映射」分頁重新執行自動識別
2. 確認「📋 當前映射配置」中的欄位都存在於 CSV
3. 調整映射配置以符合實際資料欄位

### 問題：環境參數沒有出現在特徵重要性中

**解決方法：**
1. 在「🗺️ 特徵映射」分頁確認環境參數類別已識別
2. 檢查 CSV 是否包含 CT_SYS_OAT/OAH/WBT 欄位
3. 如果欄位名稱不同，需要自定義映射配置

---

**文件版本**: V3.1  
**更新日期**: 2026-02-10  
**更新說明**: 更新為新的 UI 結構，特徵映射已移至「⚡ 最佳化模擬」模式
